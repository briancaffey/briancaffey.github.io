__NUXT_JSONP__("/fr/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq,ar,as,at,au,av,aw,ax,ay,az,aA,aB,aC,aD,aE,aF,aG,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR,aS,aT,aU,aV,aW,aX,aY,aZ,a_,a$,ba,bb,bc,bd,be,bf,bg,bh,bi,bj,bk,bl,bm,bn,bo,bp,bq,br,bs,bt,bu,bv,bw,bx,by,bz,bA,bB,bC,bD,bE,bF,bG,bH,bI,bJ,bK,bL,bM,bN,bO,bP,bQ,bR,bS,bT,bU,bV,bW,bX,bY,bZ,b_,b$,ca,cb,cc,cd,ce,cf,cg,ch,ci,cj,ck,cl,cm,cn,co,cp,cq,cr,cs,ct,cu,cv,cw,cx,cy,cz,cA,cB,cC,cD,cE,cF,cG,cH,cI,cJ,cK,cL,cM,cN,cO,cP,cQ,cR,cS,cT,cU,cV,cW,cX,cY,cZ,c_,c$,da,db,dc,dd,de,df,dg,dh,di,dj,dk,dl,dm,dn,do0,dp,dq,dr,ds,dt,du,dv,dw,dx,dy,dz,dA,dB,dC,dD,dE,dF,dG,dH,dI,dJ,dK,dL,dM,dN,dO,dP,dQ,dR,dS,dT,dU,dV,dW,dX,dY,dZ,d_,d$,ea,eb,ec,ed,ee,ef){return {data:[{article:{slug:"i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi",description:"I wrote three reusable infrastructure as code libraries to develop high-level abstractions for deploying containerized web apps on AWS ECS. This article will provide an overview of my experience working with CDK, Terraform and Pulumi and will cover how I use these libraries in automated infrastructure deployment pipelines using GitHub Actions",title:"My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi",date:"2023-01-07",image:"\u002Fstatic\u002Fiac_rosetta_stone_og_image.png",tags:["django","cdk","terraform",aQ,"cloudformation","github-actions","aws","ecs","fargate","containers","docker"],draft:false,external:[{link:"https:\u002F\u002Fnews.ycombinator.com\u002Fitem?id=34291336",site:"hn"},{link:"https:\u002F\u002Fwww.reddit.com\u002Fr\u002Faws\u002Fcomments\u002F105vo53\u002Fmy_infrastructure_as_code_rosetta_stone_deploying\u002F",site:"reddit"},{link:"https:\u002F\u002Fdev.to\u002Fbriancaffey\u002Fmy-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4",site:az},{link:"https:\u002F\u002Fmedium.com\u002F@briancaffey\u002Fmy-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a",site:"medium"},{link:"https:\u002F\u002Fbriancaffey.hashnode.dev\u002Fsetting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions",site:"hashnode"},{link:"https:\u002F\u002Fbriancaffey.substack.com\u002Fp\u002Fmy-infrastructure-as-code-rosetta",site:"substack"}],comments:E,toc:[{id:bh,depth:Q,text:bi},{id:aI,depth:Q,text:aI},{id:bj,depth:Q,text:bk},{id:bl,depth:Q,text:bm},{id:bn,depth:M,text:bo},{id:bp,depth:M,text:bq},{id:aJ,depth:M,text:aJ},{id:br,depth:Q,text:bs},{id:bt,depth:M,text:bu},{id:bv,depth:M,text:bw},{id:bx,depth:M,text:by},{id:bz,depth:M,text:bA},{id:bB,depth:M,text:bC},{id:bD,depth:M,text:bE},{id:bF,depth:Q,text:bG},{id:aK,depth:Q,text:aK},{id:bH,depth:M,text:bI},{id:bJ,depth:Q,text:bK},{id:bL,depth:Q,text:bM},{id:bN,depth:M,text:bO},{id:bP,depth:M,text:aR},{id:aL,depth:M,text:bQ},{id:bR,depth:M,text:aS},{id:bS,depth:M,text:bT},{id:bU,depth:M,text:bV},{id:bW,depth:M,text:aT},{id:bX,depth:M,text:aU},{id:bY,depth:Q,text:bZ},{id:b_,depth:M,text:b$},{id:ca,depth:M,text:cb},{id:cc,depth:M,text:cd},{id:ce,depth:M,text:cf},{id:cg,depth:M,text:ch},{id:aV,depth:M,text:ci},{id:cj,depth:M,text:ck},{id:cl,depth:M,text:aW},{id:cm,depth:Q,text:cn},{id:co,depth:Q,text:cp},{id:cq,depth:Q,text:cr},{id:cs,depth:Q,text:ct},{id:cu,depth:Q,text:cv},{id:cw,depth:Q,text:cx},{id:cy,depth:Q,text:cz},{id:cA,depth:Q,text:cB},{id:cC,depth:Q,text:cD},{id:cE,depth:Q,text:cF},{id:cG,depth:Q,text:cH},{id:cI,depth:Q,text:cJ}],body:{type:"root",children:[{type:b,tag:R,props:{id:bh},children:[{type:b,tag:j,props:{href:"#tldr",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bi}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"CDK Construct Library"}]},{type:a,value:aX},{type:b,tag:j,props:{href:cK,rel:[x,y,z],target:A},children:[{type:a,value:"github.com\u002Fbriancaffey\u002Fcdk-django"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Terraform Modules"}]},{type:a,value:aX},{type:b,tag:j,props:{href:cL,rel:[x,y,z],target:A},children:[{type:a,value:"github.com\u002Fbriancaffey\u002Fterraform-aws-django"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Pulumi Component Library"}]},{type:a,value:aX},{type:b,tag:j,props:{href:cM,rel:[x,y,z],target:A},children:[{type:a,value:"github.com\u002Fbriancaffey\u002Fpulumi-aws-django"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Mono repo with a sample Django micro blogging app (μblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that "},{type:b,tag:aA,props:{},children:[{type:a,value:"consumes"}]},{type:a,value:" each of the libraries listed above, "},{type:b,tag:j,props:{href:aY,rel:[x,y,z],target:A},children:[{type:a,value:"VuePress documentation site"}]},{type:a,value:" and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): "},{type:b,tag:j,props:{href:"https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fdjango-step-by-step",rel:[x,y,z],target:A},children:[{type:a,value:"github.com\u002Fbriancaffey\u002Fdjango-step-by-step"}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:aI},children:[{type:b,tag:j,props:{href:"#eli5",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aI}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos "},{type:b,tag:aA,props:{},children:[{type:a,value:"to YouTube"}]},{type:a,value:", but the code I'm writing allows you to upload any type of website (even site YouTube) "},{type:b,tag:aA,props:{},children:[{type:a,value:"to the internet"}]},{type:a,value:". When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach."}]},{type:a,value:e},{type:b,tag:R,props:{id:bj},children:[{type:b,tag:j,props:{href:"#why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bk}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"To push me to learn more about AWS, IaC, CI\u002FCD, automation, and Platform Engineering"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate)."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"To fail as many times as possible"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Every time I fail when I think I have things right, I learn something new"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"To take an application-first approach to DevOps"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Application developers are increasingly being tasked with operational duties"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"While learning about IaC, I had a hard time finding in-depth materials covering application development, CI\u002FCD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"To develop a project I can reference when helping myself and others"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"companies and projects that do IaC and CI\u002FCD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Hopefully, the sample application, IaC, and CI\u002FCD pipelines "},{type:b,tag:aA,props:{},children:[{type:a,value:"aren't overly complex"}]},{type:a,value:". There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to "},{type:b,tag:H,props:{},children:[{type:a,value:"show"}]},{type:a,value:" people how it can be done"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"To encourage others (specifically Developer Advocates \u002F Developer Relations \u002F Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software "},{type:b,tag:H,props:{},children:[{type:a,value:"in use"}]},{type:a,value:" with an actual application."}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"There are many ways one could create an \"IaC Rosetta Stone\" ("},{type:b,tag:g,props:{},children:[{type:a,value:"public cloud providers x CI\u002FCD providers x IaC tools"}]},{type:a,value:" is a big number)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"This takes a lot of effort and time"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"I have nothing to sell you"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"So many articles about Cloud\u002FDevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"I'm also not trying to sell anyone on using my IaC packages"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Hopefully, my IaC packages can serve as a helpful reference or starting point"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Walk before running"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"I want to build up confidence with vanilla use cases before getting too fancy"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"12 Factor App, DevOps, and Platform Engineering"}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:"https:\u002F\u002F12factor.net\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"12 Factor App"}]},{type:a,value:" is great and has guided how I approach both Django application development and IaC library development"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"The "},{type:b,tag:j,props:{href:"https:\u002F\u002Fplatformengineering.org\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"platformengineering.org"}]},{type:a,value:" community has some good guiding principles"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:bl},children:[{type:b,tag:j,props:{href:"#cdkterraformpulumi-terminology",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bm}]},{type:a,value:e},{type:b,tag:N,props:{id:bn},children:[{type:b,tag:j,props:{href:"#constructs-modules-and-components",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bo}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In this article I will refer to "},{type:b,tag:H,props:{},children:[{type:a,value:"constructs\u002Fmodules\u002Fcomponents"}]},{type:a,value:" as "},{type:b,tag:H,props:{},children:[{type:a,value:$}]},{type:a,value:" for short, and the term "},{type:b,tag:H,props:{},children:[{type:a,value:"stack"}]},{type:a,value:" can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had "},{type:b,tag:g,props:{},children:[{type:a,value:cN}]},{type:a,value:" ran against it."}]},{type:a,value:e},{type:b,tag:N,props:{id:bp},children:[{type:b,tag:j,props:{href:"#what-is-a-stack",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bq}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the "},{type:b,tag:g,props:{},children:[{type:a,value:cO}]},{type:a,value:" package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses)."}]},{type:a,value:e},{type:b,tag:N,props:{id:aJ},children:[{type:b,tag:j,props:{href:"#verbs",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aJ}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In CDK you "},{type:b,tag:g,props:{},children:[{type:a,value:"synth"}]},{type:a,value:" CDK code to generate CloudFormation templates. You can also run "},{type:b,tag:g,props:{},children:[{type:a,value:"diff"}]},{type:a,value:" to see what changes would be applied during a stack update."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In Terraform you "},{type:b,tag:g,props:{},children:[{type:a,value:"init"}]},{type:a,value:" to download all providers and modules. This is sort of like running "},{type:b,tag:g,props:{},children:[{type:a,value:"npm install"}]},{type:a,value:" in CDK and Pulumi. You then run "},{type:b,tag:g,props:{},children:[{type:a,value:cP}]},{type:a,value:" to see the changes that would result. "},{type:b,tag:g,props:{},children:[{type:a,value:cQ}]},{type:a,value:" does CRUD operations on your cloud resources."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In Pulumi you run "},{type:b,tag:g,props:{},children:[{type:a,value:cR}]},{type:a,value:" to see what changes would be made to a stack. You can use the "},{type:b,tag:g,props:{},children:[{type:a,value:"--diff"}]},{type:a,value:" flag to see the specifics of what would change."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"To summarize:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"In Terraform you plan a configuration made up of modules, and then run "},{type:b,tag:g,props:{},children:[{type:a,value:cQ}]},{type:a,value:" to build the configuration\u002Fstack ("},{type:b,tag:j,props:{href:"https:\u002F\u002Fdiscuss.hashicorp.com\u002Ft\u002Fwhat-is-a-terraform-stack\u002F31985",rel:[x,y,z],target:A},children:[{type:a,value:"discuss.hashicorp.com\u002Ft\u002Fwhat-is-a-terraform-stack\u002F31985"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi: You preview a Pulumi stack made up of components, and then run "},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi up"}]},{type:a,value:" to build the resources"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"To tear down a stack in all three tools, you run "},{type:b,tag:g,props:{},children:[{type:a,value:"destroy"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:br},children:[{type:b,tag:j,props:{href:"#infrastructure-as-code-library-repos",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bs}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK: "},{type:b,tag:j,props:{href:cK,rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:at}]}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform: "},{type:b,tag:j,props:{href:cL,rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:au}]}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi: "},{type:b,tag:j,props:{href:cM,rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:ao}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{id:bt},children:[{type:b,tag:j,props:{href:"#language",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bu}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:at}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:ao}]},{type:a,value:" are both written in TypeScript. "},{type:b,tag:g,props:{},children:[{type:a,value:au}]},{type:a,value:" is written in HCL, a domain specific language created by HashiCorp. The "},{type:b,tag:g,props:{},children:[{type:a,value:at}]},{type:a,value:" is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using "},{type:b,tag:j,props:{href:"https:\u002F\u002Fgithub.com\u002Faws\u002Fjsii",rel:[x,y,z],target:A},children:[{type:a,value:"jsii"}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See "},{type:b,tag:j,props:{href:"https:\u002F\u002Fgithub.com\u002Fpulumi\u002Fpulumi-component-provider-ts-boilerplate",rel:[x,y,z],target:A},children:[{type:a,value:"this GitHub repo"}]},{type:a,value:" for more information on this."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called "},{type:b,tag:j,props:{href:"https:\u002F\u002Fdeveloper.hashicorp.com\u002Fterraform\u002Fcdktf",rel:[x,y,z],target:A},children:[{type:a,value:"CDKTF"}]},{type:a,value:" which allows you to write HCL Terraform in TypeScript, but I haven't used it yet."}]},{type:a,value:e},{type:b,tag:N,props:{id:bv},children:[{type:b,tag:j,props:{href:"#release-management-versioning-and-publishing",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bw}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:ao}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:au}]},{type:a,value:" both use "},{type:b,tag:g,props:{},children:[{type:a,value:cS}]},{type:a,value:" for automatically generating a changelog file and bumping versions. "},{type:b,tag:g,props:{},children:[{type:a,value:cS}]},{type:a,value:" is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to "},{type:b,tag:g,props:{},children:[{type:a,value:"main"}]},{type:a,value:", a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in "},{type:b,tag:g,props:{},children:[{type:a,value:aZ}]},{type:a,value:" and adds a new git tag (e.g. "},{type:b,tag:g,props:{},children:[{type:a,value:"v1.2.3"}]},{type:a,value:") based on commit messages."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:at}]},{type:a,value:" uses "},{type:b,tag:j,props:{href:"https:\u002F\u002Fgithub.com\u002Fprojen\u002Fprojen",rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:cT}]}]},{type:a,value:" for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file ("},{type:b,tag:g,props:{},children:[{type:a,value:".projenrc.ts"}]},{type:a,value:") to configure your entire repo, including files like "},{type:b,tag:g,props:{},children:[{type:a,value:cU}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:aZ}]},{type:a,value:", and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"These tools are both based on "},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.conventionalcommits.org\u002Fen\u002Fv1.0.0\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"conventional commits"}]},{type:a,value:" to automatically update the Changelog file."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I'm still manually publishing my "},{type:b,tag:g,props:{},children:[{type:a,value:ao}]},{type:a,value:" package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!"}]},{type:a,value:e},{type:b,tag:N,props:{id:bx},children:[{type:b,tag:j,props:{href:"#makefile-examples-and-local-development",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:by}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"synthesizing CDK to CloudFormation \u002F running "},{type:b,tag:g,props:{},children:[{type:a,value:cP}]},{type:a,value:" \u002F previewing pulumi up for both the base and app stacks"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"creating\u002Fupdating an ad hoc base stack called "},{type:b,tag:g,props:{},children:[{type:a,value:az}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"destroying resources in the ad-hoc base stack called "},{type:b,tag:g,props:{},children:[{type:a,value:az}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"creating an ad hoc app stack called "},{type:b,tag:g,props:{},children:[{type:a,value:cV}]},{type:a,value:cW},{type:b,tag:g,props:{},children:[{type:a,value:az}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"destroying an ad hoc app stack called "},{type:b,tag:g,props:{},children:[{type:a,value:cV}]},{type:a,value:cW},{type:b,tag:g,props:{},children:[{type:a,value:az}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"creating\u002Fupdating a prod base stack called "},{type:b,tag:g,props:{},children:[{type:a,value:aB}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"destroying resources in the prod base stack called "},{type:b,tag:g,props:{},children:[{type:a,value:aB}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"creating a prod app stack using called "},{type:b,tag:g,props:{},children:[{type:a,value:aB}]},{type:a,value:" that uses resources from the "},{type:b,tag:g,props:{},children:[{type:a,value:aB}]},{type:a,value:" base stack"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"destroying resources in the prod app stack called "},{type:b,tag:g,props:{},children:[{type:a,value:aB}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's an example of what these commands look like in "},{type:b,tag:g,props:{},children:[{type:a,value:ao}]},{type:a,value:" for prod infrastructure base and app stacks:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"prod-base-preview:  build\n    pulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive preview\n\nprod-base-up:   build\n    pulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive up --yes\n\nprod-base-destroy:  build\n    pulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive destroy --yes\n\nprod-app-preview:   build\n    pulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive preview\n\nprod-app-preview-diff:  build\n    pulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive preview --diff\n\nprod-app-up:    build\n    pulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive up --yes\n\nprod-app-destroy:   build\n    pulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive destroy --yes\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s to create environments and smoke check the environments to make sure everything works correctly."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Adding unit tests is another item for the backlog."}]},{type:a,value:e},{type:b,tag:N,props:{id:bz},children:[{type:b,tag:j,props:{href:"#ad-hoc-vs-prod",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bA}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:"https:\u002F\u002Fbriancaffey.github.io\u002F2022\u002F03\u002F27\u002Fad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",rel:[x,y,z],target:A},children:[{type:a,value:"the last article I wrote was about ad hoc environments"}]},{type:a,value:". Also known as \"on-demand\" environments or \"preview\" environments."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"prod can be used for a production environment and any number of pre-production environments"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{id:bB},children:[{type:b,tag:j,props:{href:"#directory-structure",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bC}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The directory structures for each repo are all similar with some minor differences."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There are two types of environments: "},{type:b,tag:g,props:{},children:[{type:a,value:"ad-hoc"}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:"prod"}]},{type:a,value:". Within ad-hoc and production, there are two directories "},{type:b,tag:g,props:{},children:[{type:a,value:aC}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:an}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Each repo has a directory called "},{type:b,tag:g,props:{},children:[{type:a,value:cX}]},{type:a,value:" which contain building blocks used by the "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s that are exposed. The contents of the "},{type:b,tag:g,props:{},children:[{type:a,value:cX}]},{type:a,value:" directories are not intended to be used by anyone who is using the libraries."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"CDK construct library repo structure"}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fcdk-django$ tree -L 4 -d src\u002F\nsrc\u002F\n├── constructs\n│   ├── ad-hoc\n│   │   ├── app\n│   │   └── base\n│   ├── internal\n│   │   ├── alb\n│   │   ├── bastion\n│   │   ├── customResources\n│   │   │   └── highestPriorityRule\n│   │   ├── ecs\n│   │   │   ├── iam\n│   │   │   ├── management-command\n│   │   │   ├── redis\n│   │   │   ├── scheduler\n│   │   │   ├── web\n│   │   │   └── worker\n│   │   ├── rds\n│   │   ├── sg\n│   │   └── vpc\n│   └── prod\n│       ├── app\n│       └── base\n└── examples\n    └── ad-hoc\n        ├── app\n        │   └── config\n        └── base\n            └── config\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Terraform module library repo structure"}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fterraform-aws-django$ tree -L 4 -d modules\nmodules\n├── ad-hoc\n│   ├── app\n│   └── base\n├── internal\n│   ├── alb\n│   ├── autoscaling\n│   ├── bastion\n│   ├── ecs\n│   │   ├── ad-hoc\n│   │   │   ├── celery_beat\n│   │   │   ├── celery_worker\n│   │   │   ├── cluster\n│   │   │   ├── management_command\n│   │   │   ├── redis\n│   │   │   └── web\n│   │   └── prod\n│   │       ├── celery_beat\n│   │       ├── celery_worker\n│   │       ├── cluster\n│   │       ├── management_command\n│   │       └── web\n│   ├── elasticache\n│   ├── iam\n│   ├── rds\n│   ├── route53\n│   ├── s3\n│   ├── sd\n│   └── sg\n└── prod\n    ├── app\n    └── base\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Pulumi component library repo structure"}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ tree -L 3 src\u002F\nsrc\u002F\n├── components\n│   ├── ad-hoc\n│   │   ├── README.md\n│   │   ├── app\n│   │   └── base\n│   └── internal\n│       ├── README.md\n│       ├── alb\n│       ├── bastion\n│       ├── cw\n│       ├── ecs\n│       ├── iam\n│       ├── rds\n│       └── sg\n└── util\n    ├── index.ts\n    └── taggable.ts\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:a,value:"Pulumi examples directory"}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ tree -L 3 examples\u002F\nexamples\u002F\n└── ad-hoc\n    ├── app\n    │   ├── Pulumi.alpha.yaml\n    │   ├── Pulumi.yaml\n    │   ├── index.ts\n    │   ├── node_modules\n    │   ├── package-lock.json\n    │   ├── package.json\n    │   └── tsconfig.json\n    └── base\n        ├── Pulumi.yaml\n        ├── bin\n        ├── index.ts\n        ├── package-lock.json\n        ├── package.json\n        └── tsconfig.json\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{id:bD},children:[{type:b,tag:j,props:{href:"#cloc",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bE}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Let's use CLOC (count lines of code) to compare the lines of code used in the "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:" of CDK\u002FCloudFormation\u002FTerraform\u002FPulumi."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:at}]}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fcdk-django$ cloc src\u002Fconstructs\u002F\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.04 s (356.1 files\u002Fs, 30040.9 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:au}]}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fterraform-aws-django$ cloc modules\u002F\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.15 s (385.9 files\u002Fs, 20585.1 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:H,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:ao}]}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ cloc src\u002Fcomponents\u002F\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.11 s (134.5 files\u002Fs, 12924.2 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n"}]}]}]},{type:a,value:e},{type:b,tag:R,props:{id:bF},children:[{type:b,tag:j,props:{href:"#communities",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bG}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:"https:\u002F\u002Fcdk.dev\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"cdk.dev"}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:"https:\u002F\u002Fdiscuss.hashicorp.com\u002Fc\u002Fterraform-core\u002F27",rel:[x,y,z],target:A},children:[{type:a,value:"Terraform Section of HashiCorp Discuss Forum"}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:"https:\u002F\u002Fslack.pulumi.com\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"Pulumi Slack"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:aK},children:[{type:b,tag:j,props:{href:"#%CE%BCblog",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aK}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"μblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:"}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:a_,props:{alt:"ublog",src:"\u002Fstatic\u002Fublog_screenshot.png"},children:[]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts."}]},{type:a,value:e},{type:b,tag:N,props:{id:bH},children:[{type:b,tag:j,props:{href:"#mono-repo-structure",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bI}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"It lives in a GitHub mono repo called "},{type:b,tag:g,props:{},children:[{type:a,value:a$}]},{type:a,value:". This mono repo contains a few different things:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"backend Django application"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"frontend Vue.js application"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"IaC code that uses c\u002Fm\u002Fc from "},{type:b,tag:g,props:{},children:[{type:a,value:at}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:au}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:ao}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"GitHub Actions workflows for both Infrastructure deployments and application deployments"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"μblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. μblog is meant to represent a generic 12 Factor application that uses:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"gunicorn for a backend API"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Vue.js for a client that consumes the backend API"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"celery for async task processing"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"celery beat for scheduling tasks"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Postgres for relational data"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Redis for caching and message brokering"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"S3 for object storage"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Django admin for a simple admin interface"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There is a lot more I could add on μblog. For now I'll just mention that it:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"has a great local development environment (supports both docker-compose and virtual environments)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"GitHub Actions for running unit tests"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"k6 for load testing"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: "},{type:b,tag:j,props:{href:aY,rel:[x,y,z],target:A},children:[{type:a,value:aY}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:"h1",props:{id:"infrastructure-deep-dive"},children:[{type:b,tag:j,props:{href:"#infrastructure-deep-dive",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:"Infrastructure Deep Dive"}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Let's go through each of the "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I'll first talk about the two stacks used in ad hoc environments: "},{type:b,tag:g,props:{},children:[{type:a,value:aC}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:an}]},{type:a,value:". Then I'll talk about the prod environments which are also composed of "},{type:b,tag:g,props:{},children:[{type:a,value:aC}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:an}]},{type:a,value:" stacks."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, "},{type:b,tag:H,props:{},children:[{type:a,value:"especially with Terraform"}]},{type:a,value:". In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried)."}]},{type:a,value:e},{type:b,tag:R,props:{id:bJ},children:[{type:b,tag:j,props:{href:"#splitting-up-the-stacks",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bK}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform enables this with outputs and "},{type:b,tag:g,props:{},children:[{type:a,value:"terraform_remote_state"}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi encourages the use of "},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fguides\u002Forganizing-projects-stacks\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"micro stacks"}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK has an article on how to "},{type:b,tag:j,props:{href:"https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fstack_how_to_create_multiple_stacks.html",rel:[x,y,z],target:A},children:[{type:a,value:"create an app with multiple stacks"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Also, on-demand environments really lends itself to stacks that are split up."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In the section "},{type:b,tag:j,props:{href:"https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fresources.html",rel:[x,y,z],target:A},children:[{type:a,value:"\"Passing unique identifiers\""}]},{type:a,value:", the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There is a balance to be found between single stacks vs micro stacks. Both the base and app "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s could be split out further. For example, the "},{type:b,tag:g,props:{},children:[{type:a,value:aC}]},{type:a,value:k},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s could be split into "},{type:b,tag:g,props:{},children:[{type:a,value:"networking"}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:"rds"}]},{type:a,value:". The "},{type:b,tag:g,props:{},children:[{type:a,value:an}]},{type:a,value:" stack could be split into different ECS services so that their infrastructure can be deployed independently, like "},{type:b,tag:g,props:{},children:[{type:a,value:"cluster"}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:cY}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:cZ}]},{type:a,value:". The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"My rules of thumbs are:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Lots of small stacks can cause overhead and make things more complex than they need to be"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:bL},children:[{type:b,tag:j,props:{href:"#ad-hoc-base-overview",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bM}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's an overview of the resources used in an ad hoc base environment."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"(Inputs)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"(Optional environment configs)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"VPC and Service Discovery"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"S3"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:aS}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Load Balancer"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"RDS"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:aT}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{id:bN},children:[{type:b,tag:j,props:{href:"#visualization",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bO}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the "},{type:b,tag:g,props:{},children:[{type:a,value:"Resources"}]},{type:a,value:" tab of the ad hoc base stack in the Pulumi console."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:a_,props:{alt:"Graph view of ad hoc base infrastructure",src:"\u002Fstatic\u002Fpulumi_ad_hoc_base_dep_graph.png"},children:[]}]},{type:a,value:e},{type:b,tag:N,props:{id:bP},children:[{type:b,tag:j,props:{href:"#inputs",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aR}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There are only two required inputs for the ad hoc base stack"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"ACM certificate ARN"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Domain Name"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy\u002Fapply\u002Fup or synth\u002Fplan\u002Fpreview."}]},{type:a,value:e},{type:b,tag:N,props:{id:aL},children:[{type:b,tag:j,props:{href:"#vpc",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bQ}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The VPC is the first resource that is created as part of the "},{type:b,tag:g,props:{},children:[{type:a,value:aC}]},{type:a,value:" stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"awsx"}]},{type:a,value:" has a VPC module"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"terraform-aws-vpc"}]},{type:a,value:" module"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"L2 VPC Construct in CDK"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The setting in the Terraform VPC module "},{type:b,tag:g,props:{},children:[{type:a,value:"one_nat_gateway_per_az = false"}]},{type:a,value:" doesn't seem to exist on the "},{type:b,tag:g,props:{},children:[{type:a,value:"awsx.ec2.Vpc"}]},{type:a,value:" module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3."}]},{type:a,value:e},{type:b,tag:N,props:{id:bR},children:[{type:b,tag:j,props:{href:"#security-groups",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aS}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups."}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" albSecurityGroup "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:"SecurityGroup"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:c_},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'AlbSecurityGroup'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n      vpc"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:c$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aL},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:"\n\n    albSecurityGroup"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:da}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:db},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dc}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dd},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:de}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,ba]},children:[{type:a,value:"443"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'HTTPS'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:"\n    albSecurityGroup"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:da}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:db},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dc}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dd},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:de}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,ba]},children:[{type:a,value:"80"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'HTTP'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:N,props:{id:bS},children:[{type:b,tag:j,props:{href:"#load-balancer-resources",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bT}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There's not much to comment on here. In each library I have resource group that defines the following:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Application Load Balancer"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"A default target group"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"An HTTP listener that redirects to HTTPS"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"An HTTPS listener with a default \"fixed-response\" action"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Properties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Ad hoc app environments all share a common load balancer from the base stack that they use."}]},{type:a,value:e},{type:b,tag:N,props:{id:bU},children:[{type:b,tag:j,props:{href:"#rds-resources",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bV}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"All three libraries have the RDS security group and Subnet Group in the same "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:" as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Currently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential."}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" secret "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:"Secret"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:c_},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'dbSecret'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n      secretName"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:c$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"dbSecretName"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n      description"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'secret for rds'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n      generateSecretString"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n        secretStringTemplate"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,bb]},children:[{type:a,value:bc}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"stringify"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:" username"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'postgres'"}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n        generateStringKey"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'password'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n        excludePunctuation"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,df]},children:[{type:a,value:r}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n        includeSpace"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,df]},children:[{type:a,value:"false"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n      "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:dg},{type:b,tag:g,props:{},children:[{type:a,value:"DatabaseInstance"}]},{type:a,value:" props we can then use this secret like so:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"    credentials: Credentials.fromSecret(secret),\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In the application deployed with CDK, I use a Django settings module package that uses a package called "},{type:b,tag:g,props:{},children:[{type:a,value:"aws_secretsmanager_caching"}]},{type:a,value:" to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The Terraform and Pulumi database instance arguments simply accept a "},{type:b,tag:g,props:{},children:[{type:a,value:"password"}]},{type:a,value:" field. This will be another item for the backlog for Terraform and Pulumi. The "},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Frandom\u002Fapi-docs\u002Frandompassword\u002F",rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:"randompassword"}]}]},{type:a,value:S},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Faws\u002Fapi-docs\u002Fsecretsmanager\u002Fsecretversion\u002F",rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:"secretversion"}]}]},{type:a,value:" components can be used to do this."}]},{type:a,value:e},{type:b,tag:N,props:{id:bW},children:[{type:b,tag:j,props:{href:"#bastion-host",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aT}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There are two main use cases for the bastion host in ad-hoc environments."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"When creating a new ad hoc app environment, the bastion host is used to create a new database called "},{type:b,tag:g,props:{},children:[{type:a,value:"{ad-hoc-env-name}-db"}]},{type:a,value:" that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now)."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to "},{type:b,tag:g,props:{},children:[{type:a,value:"localhost:5432"}]},{type:a,value:" on your local machine."}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,dh]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"aws ssm start-session --target "},{type:b,tag:c,props:{className:[d,"variable"]},children:[{type:a,value:"$INSTANCE_ID"}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:N,props:{id:bX},children:[{type:b,tag:j,props:{href:"#outputs",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aU}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"vpc_id"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"assets_bucket_name"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"private_subnet_ids"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"app_sg_id"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"alb_sg_id"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"listener_arn"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"alb_dns_name"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"task_role_arn"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"execution_role_arn"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"rds_address"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like "},{type:b,tag:g,props:{},children:[{type:a,value:"Vpc"}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:"RdsInstance"}]},{type:a,value:". More on this later in the following section "},{type:b,tag:H,props:{},children:[{type:a,value:aW}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:R,props:{id:bY},children:[{type:b,tag:j,props:{href:"#ad-hoc-app-overview",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:bZ}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:a_,props:{alt:"Graph view of ad hoc app infrastructure",src:"\u002Fstatic\u002Fpulumi_ad_hoc_app_dep_graph.png"},children:[]}]},{type:a,value:e},{type:b,tag:N,props:{id:b_},children:[{type:b,tag:j,props:{href:"#ecs-cluster",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:b$}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"This is a small component that defines both ECS Cluster and the default capacity providers"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"It defaults to not using "},{type:b,tag:g,props:{},children:[{type:a,value:di}]},{type:a,value:"; ad hoc environments do use "},{type:b,tag:g,props:{},children:[{type:a,value:di}]},{type:a,value:" for cost savings"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:dj,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"NOTE: defaultCapacityProviderStrategy on cluster not currently supported. ("},{type:b,tag:j,props:{href:"https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fapi\u002Fv1\u002Fdocs\u002F@aws-cdk_aws-ecs.CapacityProviderStrategy.html",rel:[x,y,z],target:A},children:[{type:a,value:"link"}]},{type:a,value:q}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{id:ca},children:[{type:b,tag:j,props:{href:"#shared-environment-variables",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cb}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"I struggled to get this right in pulumi. A lot of Pulumi examples used "},{type:b,tag:g,props:{},children:[{type:a,value:"JSON.stringify"}]},{type:a,value:" for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use "},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi.jsonStringify"}]},{type:a,value:" which was added in a relatively recent version of "},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi\u002Fpulumi"}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK allows you to declare environment variables for a containerDefinition like "},{type:b,tag:g,props:{},children:[{type:a,value:dk}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi and Terraform require that values are passed like "},{type:b,tag:g,props:{},children:[{type:a,value:"{ name: \"FOO\", value: \"bar\"}"}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"You could transform "},{type:b,tag:g,props:{},children:[{type:a,value:dk}]},{type:a,value:" into the name\u002Fvalue format, but I didn't bother to do this"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the "},{type:b,tag:g,props:{},children:[{type:a,value:"concat"}]},{type:a,value:" function to add these to the list of default environment variables."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's what the code looks like for joining extra environment variables to the default environment variables:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,dl]},children:[{type:a,value:"\u002F\u002F CDK"}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:"if"}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:aD},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n      environmentVariables "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:dm}]},{type:a,value:aD},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:dm}]},{type:a,value:"environmentVariables "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n"}]}]}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"    \u002F\u002F Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x =\u003E x.concat(extraEnvVars!))\n    }\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{id:cc},children:[{type:b,tag:j,props:{href:"#route53-record",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cd}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching "},{type:b,tag:g,props:{},children:[{type:a,value:"example.com\u002Fapi\u002F*"}]},{type:a,value:" are routed to the backend API and all other requests matching "},{type:b,tag:g,props:{},children:[{type:a,value:"example.com\u002F*"}]},{type:a,value:" are routed to the frontend service."}]},{type:a,value:e},{type:b,tag:N,props:{id:ce},children:[{type:b,tag:j,props:{href:"#redis",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cf}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable."}]},{type:a,value:e},{type:b,tag:N,props:{id:cg},children:[{type:b,tag:j,props:{href:"#web-service",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:ch}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:" has an input parameter called "},{type:b,tag:g,props:{},children:[{type:a,value:"pathPatterns"}]},{type:a,value:" which determines which paths it serves. For example, the API container may serve traffic for "},{type:b,tag:g,props:{},children:[{type:a,value:dn}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:do0}]},{type:a,value:" only, or it may want to serve all traffic ("},{type:b,tag:g,props:{},children:[{type:a,value:dp}]},{type:a,value:")."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The way I use these components in ad hoc and prod environments is heavily opinionated in that:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"it assumes that the frontend SPA\u002FSSR site should have a lower priority rule than the backend service and should route request paths matching "},{type:b,tag:g,props:{},children:[{type:a,value:dp}]},{type:a,value:", while the backend service routes requests for a specific list of path patterns ("},{type:b,tag:g,props:{},children:[{type:a,value:dn}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:do0}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:"\u002Fgraphql\u002F*"}]},{type:a,value:", etc.)."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring."}]},{type:a,value:e},{type:b,tag:N,props:{id:aV},children:[{type:b,tag:j,props:{href:"#celery",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:ci}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"The reason for having a celery service is to be able to have potentially multiple workers that scale independently"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"I use the same Pulumi component for both works and schedulers"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like "},{type:b,tag:g,props:{},children:[{type:a,value:"AsyncWorker"}]},{type:a,value:" across the board rather than using the term "},{type:b,tag:g,props:{},children:[{type:a,value:aV}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:N,props:{id:cj},children:[{type:b,tag:j,props:{href:"#management-command",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:ck}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Defines a task that can be used to run commands like "},{type:b,tag:g,props:{},children:[{type:a,value:bd}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:dq}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"These tasks are ran both after the initial "},{type:b,tag:g,props:{},children:[{type:a,value:an}]},{type:a,value:" stack deployment and before rolling application upgrades"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In my Django app I have a single management command that calls "},{type:b,tag:g,props:{},children:[{type:a,value:dq}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:bd}]},{type:a,value:" and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"One other thing to note about this "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:" is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:dr},{type:b,tag:g,props:{},children:[{type:a,value:ds}]},{type:a,value:dt}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"runs the task with the required settings"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"waits for the task to complete"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:dr},{type:b,tag:g,props:{},children:[{type:a,value:du}]},{type:a,value:dt}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"collects the logs for the task between "},{type:b,tag:g,props:{},children:[{type:a,value:ds}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:du}]},{type:a,value:" and prints them to "},{type:b,tag:g,props:{},children:[{type:a,value:"stdout"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's an example of what the script looks like in Pulumi:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" executionScript "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"interpolate"},{type:b,tag:c,props:{className:[d,aM]},children:[{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"#!\u002Fbin\u002Fbash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster "}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:dv},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:" --task-definition "}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:"taskDefinition"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"arn"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:" --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=["}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"privateSubnetIds"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:cN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:"x "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:"=\u003E"}]},{type:a,value:" x"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"join"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\",\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"],securityGroups=["}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"appSgId"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster "}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:dv},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name "}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:"cwLoggingResources"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"cwLogGroupName"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:" --log-stream-name "}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aE},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\u002F"}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:aw},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aE},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\u002F\\${TASK_ID##*\u002F} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n"}]},{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:be}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"executionScript "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:" executionScript"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,dw]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"      "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:aE}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"Run backend update command\""}]},{type:a,value:"\n        "},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:"id"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" run_backend_update\n        "},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:"run"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:"|"}]},{type:b,tag:c,props:{className:[d,"scalar",n]},children:[{type:a,value:"\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )"}]},{type:a,value:"\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:Z}]},{type:a,value:" backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          .\u002Fbackend_update_command.sh\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{id:cl},children:[{type:b,tag:j,props:{href:"#passing-data-between-stacks",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:aW}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's what this looks like in Terraform"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"data \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"..\u002Fbase\u002Fterraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"..\u002F..\u002F..\u002Fmodules\u002Fad-hoc\u002Fapp\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In CDK:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dx},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:an},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dy}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:aO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:aP},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:dz},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:dA},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ax}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:aH}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dB},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dC},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:an},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dD}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:aO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:aP},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:dE},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:dF},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ax}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:aH}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" adHocBase "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:"AdHocBase"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:"baseStack"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'AdHocBase'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:" certificateArn"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dH},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" addHocApp "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:"AdHocApp"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:"appStack"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"'AdHocApp'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n  baseStackName"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:" adHocBaseEnvName"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  vpc"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aL},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  alb"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"alb"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  appSecurityGroup"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"appSecurityGroup"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  serviceDiscoveryNamespace"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"serviceDiscoveryNamespace"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  rdsInstance"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"databaseInstance"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  assetsBucket"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"assetsBucket"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dI},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"domainName"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  listener"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:as},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:"listener"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"and in Pulumi:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" stackReference "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aQ}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"StackReference"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,aM]},children:[{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:"org"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\u002Fad-hoc-base\u002F"}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:dJ},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" vpcId "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"vpcId\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" assetsBucketName "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"assetsBucketName\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" privateSubnets "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"privateSubnetIds\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:dK}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:dL}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" appSgId "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"appSgId\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" albSgId "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"albSgId\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" listenerArn "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"listenerArn\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" albDnsName "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"albDnsName\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" serviceDiscoveryNamespaceId "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"serviceDiscoveryNamespaceId\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" rdsAddress "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"rdsAddress\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dH},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"domainName\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" baseStackName "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"baseStackName\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ah}]},{type:a,value:aa},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,dl]},children:[{type:a,value:"\u002F\u002F ad hoc app env"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:" adHocAppComponent "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:"AdHocAppComponent"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"AdHocAppComponent\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n  vpcId"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  assetsBucketName"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  privateSubnets"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  appSgId"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  albSgId"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  listenerArn"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  albDnsName"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  serviceDiscoveryNamespaceId"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  rdsAddress"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dI},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:"\n  baseStackName\n"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:R,props:{id:cm},children:[{type:b,tag:j,props:{href:"#cli-scaffolding",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cn}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"CDK and Pulumi have some good options for how to scaffold a project."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:dM},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi new aws-typescript"}]},{type:a,value:" among lots of other options (run "},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi new -l"}]},{type:a,value:" to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in "},{type:b,tag:g,props:{},children:[{type:a,value:a$}]},{type:a,value:" that consume the library."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK has "},{type:b,tag:g,props:{},children:[{type:a,value:cT}]},{type:a,value:" CLI commands which can help set up either library code or project code"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"The major benefits of these tools is setting up "},{type:b,tag:g,props:{},children:[{type:a,value:cU}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:aZ}]},{type:a,value:" correctly"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform is so simple that it doesn't really need tooling for scaffolding"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:co},children:[{type:b,tag:j,props:{href:"#best-practices",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cp}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"For "},{type:b,tag:g,props:{},children:[{type:a,value:au}]},{type:a,value:", I tried to follow the recommendations from "},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.terraform-best-practices.com\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"terraform-best-practices.com"}]},{type:a,value:" which helped me a lot with things like consistent naming patterns and directory structures. For example:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"use the name "},{type:b,tag:g,props:{},children:[{type:a,value:be}]},{type:a,value:" for resources in a module where that resource is the only resource of its type"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of "},{type:b,tag:g,props:{},children:[{type:a,value:aR}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:aU}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:"pulumi.interpolate"}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:"apply()"}]},{type:a,value:am},{type:b,tag:g,props:{},children:[{type:a,value:"all()"}]},{type:a,value:" and the differences between "},{type:b,tag:g,props:{},children:[{type:a,value:"getX"}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:"getXOutput"}]},{type:a,value:". There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way."}]},{type:a,value:e},{type:b,tag:R,props:{id:cq},children:[{type:b,tag:j,props:{href:"#environment-configuration",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cr}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Environment configuration allows for either a base or app stack to be configured with non-default values. For example:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values."}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi defines environment-specific config in files called "},{type:b,tag:g,props:{},children:[{type:a,value:"Pulumi.{env}.yaml"}]},{type:a,value:dN},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fintro\u002Fconcepts\u002Fconfig\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"Pulumi article on configuration"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform uses "},{type:b,tag:g,props:{},children:[{type:a,value:"{env}.tfvars"}]},{type:a,value:" for this type of configuration"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK has several options for this type of configuration ("},{type:b,tag:g,props:{},children:[{type:a,value:"cdk.context.json"}]},{type:a,value:", extending stack props, etc.)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"For CDK I have been using "},{type:b,tag:g,props:{},children:[{type:a,value:ax}]},{type:a,value:dO},{type:b,tag:g,props:{},children:[{type:a,value:dP}]},{type:a,value:" method:"}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:ax}]},{type:a,value:" needs to be set on the node before any child nodes are added:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dx},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:an},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dy}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:aO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:aP},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:dz},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:dA},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ax}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:aH}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dB},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ay},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dC},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:an},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dD}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:aO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:aP},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:dE},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:dF},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:ax}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:aH}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:dG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"And the config objects are read from JSON files like this:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:dQ}]},{type:a,value:" adHocBaseEnvConfig "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,bb]},children:[{type:a,value:bc}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dR}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:dS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dT}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,aM]},children:[{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"src\u002Fexamples\u002Fad-hoc\u002Fbase\u002Fconfig\u002F"}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:"adHocBaseEnvName"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dU}]},{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dV}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:dQ}]},{type:a,value:" adHocAppEnvConfig "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,bb]},children:[{type:a,value:bc}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dR}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:a,value:dS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dT}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,aM]},children:[{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"src\u002Fexamples\u002Fad-hoc\u002Fapp\u002Fconfig\u002F"}]},{type:b,tag:c,props:{className:[d,ab]},children:[{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:ac}]},{type:a,value:"adHocAppEnvName"},{type:b,tag:c,props:{className:[d,O,f]},children:[{type:a,value:F}]}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dU}]},{type:b,tag:c,props:{className:[d,aq,n]},children:[{type:a,value:ar}]}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:o}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:dV}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The context can be used in constructs like this:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:P}]},{type:a,value:dW},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:be}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aG},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:dP}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:aH}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:a,value:aD},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,aj]},children:[{type:b,tag:g,props:{},children:[{type:a,value:av},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:"interface"}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:dX}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"\n      name"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:"\n      value"},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:C}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:"\n\n    "},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:dY}]},{type:a,value:" config "},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:ae}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,Y]},children:[{type:a,value:aQ}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"Config"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:dY}]},{type:a,value:dW},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:G}]},{type:a,value:" config"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,"generic-function"]},children:[{type:b,tag:c,props:{className:[d,D]},children:[{type:a,value:"getObject"}]},{type:b,tag:c,props:{className:[d,"generic",Y]},children:[{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:ad}]},{type:a,value:dX},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:dK}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:dL}]},{type:b,tag:c,props:{className:[d,l]},children:[{type:a,value:Z}]}]}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:w}]},{type:b,tag:c,props:{className:[d,n]},children:[{type:a,value:"\"extraEnvVars\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:q}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:B}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"In my "},{type:b,tag:g,props:{},children:[{type:a,value:"Pulumi.alpha.yaml"}]},{type:a,value:" file I have the "},{type:b,tag:g,props:{},children:[{type:a,value:aD}]},{type:a,value:" set like this:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,dw]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:"config"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:dZ},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:"aws:region"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" us"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:"east"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:b,tag:c,props:{className:[d,ba]},children:[{type:a,value:"1"}]},{type:a,value:dZ},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:aD}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:ap},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:aE}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" FOO\n      "},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:d_}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" BAR\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:aE}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" BIZ\n      "},{type:b,tag:c,props:{className:[d,ak,al]},children:[{type:a,value:d_}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:C}]},{type:a,value:" BUZ\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)"}]},{type:a,value:e},{type:b,tag:R,props:{id:cs},children:[{type:b,tag:j,props:{href:"#local-development",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:ct}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Using the Makefile targets in each library repo, my process for developing "},{type:b,tag:g,props:{},children:[{type:a,value:$}]},{type:a,value:"s involves making code changes followed by Makefile targets that preview\u002Fplan\u002Fdiff against my AWS account, then running deploy\u002Fapply\u002Fup and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here are some sample times for deploying ad hoc stacks with CDK."}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"# CDK ad hoc base deployment time\n\n ✅  ExampleAdHocBaseStack (dev)\n\n✨  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ✅  ExampleAdHocAppStack (alpha)\n\n✨  Deployment time: 126.62s\n"}]}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here is an example of what the "},{type:b,tag:g,props:{},children:[{type:a,value:cR}]},{type:a,value:" commands shows for the ad-hoc base stack:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,X]},children:[{type:b,tag:g,props:{},children:[{type:a,value:"# Pulumi preview\n~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ pulumi -C examples\u002Fad-hoc\u002Fbase --stack dev preview\nPreviewing update (dev)\n\nView Live: https:\u002F\u002Fapp.pulumi.com\u002Fbriancaffey\u002Fad-hoc-base\u002Fdev\u002Fpreviews\u002F718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   └─ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ├─ pulumi-contrib:components:AlbResources            AlbResources                create\n +      │  ├─ aws:alb:TargetGroup                            DefaultTg                   create\n +      │  ├─ aws:alb:LoadBalancer                           LoadBalancer                create\n +      │  ├─ aws:alb:Listener                               HttpListener                create\n +      │  └─ aws:alb:Listener                               HttpsListener               create\n +      ├─ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      │  ├─ aws:iam:Role                                   BastionHostRole             create\n +      │  ├─ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      │  ├─ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      │  └─ aws:ec2:Instance                               BastionHostInstance         create\n +      ├─ pulumi-contrib:components:RdsResources            RdsResources                create\n +      │  ├─ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      │  ├─ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      │  └─ aws:rds:Instance                               DbInstance                  create\n +      ├─ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      │  ├─ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      │  └─ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ├─ aws:s3:Bucket                                     assetsBucket                create\n +      ├─ awsx:ec2:Vpc                                      dev                         create\n +      │  └─ aws:ec2:Vpc                                    dev                         create\n +      │     ├─ aws:ec2:InternetGateway                     dev                         create\n +      │     ├─ aws:ec2:Subnet                              dev-private-1               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-1               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      │     │     └─ aws:ec2:Route                         dev-private-1               create\n +      │     ├─ aws:ec2:Subnet                              dev-private-2               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-2               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      │     │     └─ aws:ec2:Route                         dev-private-2               create\n +      │     ├─ aws:ec2:Subnet                              dev-public-1                create\n +      │     │  ├─ aws:ec2:RouteTable                       dev-public-1                create\n +      │     │  │  ├─ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      │     │  │  └─ aws:ec2:Route                         dev-public-1                create\n +      │     │  ├─ aws:ec2:Eip                              dev-1                       create\n +      │     │  └─ aws:ec2:NatGateway                       dev-1                       create\n +      │     └─ aws:ec2:Subnet                              dev-public-2                create\n +      │        ├─ aws:ec2:RouteTable                       dev-public-2                create\n +      │        │  ├─ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      │        │  └─ aws:ec2:Route                         dev-public-2                create\n +      │        ├─ aws:ec2:Eip                              dev-2                       create\n +      │        └─ aws:ec2:NatGateway                       dev-2                       create\n +      └─ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output\u003Cstring\u003E\n    albSgId                    : output\u003Cstring\u003E\n    appSgId                    : output\u003Cstring\u003E\n    assetsBucketName           : output\u003Cstring\u003E\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output\u003Cstring\u003E\n    domainName                 : \"example.com\"\n    listenerArn                : output\u003Cstring\u003E\n    privateSubnetIds           : output\u003Cstring\u003E\n    rdsAddress                 : output\u003Cstring\u003E\n    serviceDiscoveryNamespaceId: output\u003Cstring\u003E\n    vpcId                      : output\u003Cstring\u003E\n\nResources:\n    + 44 to create\n"}]}]}]},{type:a,value:e},{type:b,tag:R,props:{id:cu},children:[{type:b,tag:j,props:{href:"#running-infrastructure-pipelines-in-github-actions",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cv}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:aA,props:{},children:[{type:a,value:"I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!"}]}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:dg},{type:b,tag:g,props:{},children:[{type:a,value:".github\u002Fworkflows"}]},{type:a,value:" directory of the "},{type:b,tag:g,props:{},children:[{type:a,value:a$}]},{type:a,value:" repo, I will have the following "},{type:b,tag:g,props:{},children:[{type:a,value:"2 * 2 * 2 * 3 = 24"}]},{type:a,value:" pipelines for running infrastructure as code pipelines:"}]},{type:a,value:e},{type:b,tag:I,props:{className:[J]},children:[{type:b,tag:K,props:{className:[L,dh]},children:[{type:b,tag:g,props:{},children:[{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"ad_hoc,prod"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:bf},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"base,app"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:bf},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"create_update,destroy"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:bf},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:T}]},{type:a,value:"cdk,terraform,pulumi"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:".yml\n"}]}]}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"For CDK I'm using CDK CLI commands"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"For Terraform I'm also using terraform CLI commands"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"For Pulumi I'm using the official Pulumi GitHub Action"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:dM},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fguides\u002Fcontinuous-delivery\u002Fgithub-actions\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"a great article"}]},{type:a,value:" about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The general pattern that all of these pipelines use is:"}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Do a synth\u002Fplan\u002Fpreview, and upload the synth\u002Fplan\u002Fpreview file to an artifact"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pause and wait on manual review of the planned changes"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"download the artifact and run deploy\u002Fapply\u002Fup against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I do this by having two jobs in each GitHub Action: one for synth\u002Fplan\u002Fpreview and one for deploy\u002Fapply\u002Fup."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The job for deploy\u002Fapply\u002Fup includes an "},{type:b,tag:g,props:{},children:[{type:a,value:dJ}]},{type:a,value:" that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job."}]},{type:a,value:e},{type:b,tag:R,props:{id:cw},children:[{type:b,tag:j,props:{href:"#application-deployments",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cx}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"The backend deployment script runs database migrations, the "},{type:b,tag:g,props:{},children:[{type:a,value:bd}]},{type:a,value:" command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks."}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:cy},children:[{type:b,tag:j,props:{href:"#interacting-with-aws-via-iac",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cz}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides "},{type:b,tag:j,props:{href:"https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fconstructs.html",rel:[x,y,z],target:A},children:[{type:a,value:"L1, L2 and L3 constructs"}]},{type:a,value:" which offer different levels of abstraction over CloudFormation."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform has the "},{type:b,tag:j,props:{href:"https:\u002F\u002Fregistry.terraform.io\u002Fproviders\u002Fhashicorp\u002Faws\u002Flatest\u002Fdocs",rel:[x,y,z],target:A},children:[{type:a,value:"AWS Provider"}]},{type:a,value:dO},{type:b,tag:j,props:{href:"https:\u002F\u002Fregistry.terraform.io\u002Fnamespaces\u002Fterraform-aws-modules",rel:[x,y,z],target:A},children:[{type:b,tag:g,props:{},children:[{type:a,value:d$}]}]},{type:a,value:m}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Pulumi has AWS Classic ("},{type:b,tag:g,props:{},children:[{type:a,value:cO}]},{type:a,value:ea},{type:b,tag:H,props:{},children:[{type:a,value:eb}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:"AWSx"}]},{type:a,value:dN},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Fawsx\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"Crosswalk for Pulumi"}]},{type:a,value:ea},{type:b,tag:H,props:{},children:[{type:a,value:"library"}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:bg}]},{type:a,value:k},{type:b,tag:H,props:{},children:[{type:a,value:eb}]},{type:a,value:m}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:dj,props:{},children:[{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:bg}]},{type:a,value:" \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\""}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:bg}]},{type:a,value:" looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"For CDK I use mostly L2 constructs and some L1 constructs."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Fot Terraform I use the VPC from the "},{type:b,tag:g,props:{},children:[{type:a,value:d$}]},{type:a,value:", and everything else uses the AWS Terraform Provider."}]},{type:a,value:e},{type:b,tag:R,props:{id:cA},children:[{type:b,tag:j,props:{href:"#what-i-did-not-put-in-iac",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cB}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"ECR (Elastic Container Registry)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"ACM (Amazon Certificate Manager)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"(Roles used for deployments)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I created the Elastic Container Registry "},{type:b,tag:g,props:{},children:[{type:a,value:cY}]},{type:a,value:S},{type:b,tag:g,props:{},children:[{type:a,value:cZ}]},{type:a,value:" repos manually in the AWS Console. I also manually requested an ACM certificate for "},{type:b,tag:g,props:{},children:[{type:a,value:"*.mydomain.com"}]},{type:a,value:" for the domain that I use for testing that I purchased through Route53 domains."}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog."}]},{type:a,value:e},{type:b,tag:R,props:{id:cC},children:[{type:b,tag:j,props:{href:"#tagging",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cD}]},{type:a,value:e},{type:b,tag:v,props:{},children:[{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Terraform and CDK both make it easy to automatically tag all resources in a stack"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"It is possible to do this in Pulumi, but you need to write a little bit of code."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:ec,rel:[x,y,z],target:A},children:[{type:a,value:ec}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:b,tag:j,props:{href:ed,rel:[x,y,z],target:A},children:[{type:a,value:ed}]}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Automatically tagging resources works through "},{type:b,tag:j,props:{href:"https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fintro\u002Fvs\u002Fterraform\u002F",rel:[x,y,z],target:A},children:[{type:a,value:"stack transformations"}]},{type:a,value:" are unique to Pulumi"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:cE},children:[{type:b,tag:j,props:{href:"#smoke-checking-application-environments",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cF}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here's the list of things I check when standing up an application environment:"}]},{type:a,value:e},{type:b,tag:v,props:{className:[ee]},children:[{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Run the init\u002Ftsc, synth\u002Fplan\u002Fpreview and deploy\u002Fapply\u002Fup commands successfully"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Access the bastion host ("},{type:b,tag:g,props:{},children:[{type:a,value:"make aws-ssm-start-session"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Run ECSExec to access a shell in a backend container ("},{type:b,tag:g,props:{},children:[{type:a,value:"make aws-ecs-exec"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Test database connectivity ("},{type:b,tag:g,props:{},children:[{type:a,value:"python manage.py showmigrations"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Run the migrations ("},{type:b,tag:g,props:{},children:[{type:a,value:"python manage.py migrate"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Run collectstatic ("},{type:b,tag:g,props:{},children:[{type:a,value:"python manage.py collectstatic"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Visit the site ("},{type:b,tag:g,props:{},children:[{type:a,value:"alpha.example.com"}]},{type:a,value:q}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Publish a blog post"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Publish a blog post with an image"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Check celery worker logs for successfully complete scheduled tasks"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Trigger an autoscaling event by running k6 load tests against an environment"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Destroy the app stack"}]},{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Destroy the base stack"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:R,props:{id:cG},children:[{type:b,tag:j,props:{href:"#backlog-and-next-steps",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cH}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"Here are some of the next things I'll be working on in these project, roughly in order of importance:"}]},{type:a,value:e},{type:b,tag:v,props:{className:[ee]},children:[{type:a,value:e},{type:b,tag:h,props:{className:[U]},children:[{type:b,tag:V,props:{checked:E,disabled:E,type:W},children:[]},{type:a,value:" Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Show how to do account isolation (different accounts for prod vs pre-prod environments)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"GitHub Actions deployment pipeline for publishing "},{type:b,tag:g,props:{},children:[{type:a,value:ao}]},{type:a,value:" package"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the "},{type:b,tag:g,props:{},children:[{type:a,value:"random"}]},{type:a,value:" functions to do this"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Refactor GitHub Actions and make them reusable across different projects"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Use graviton instances and have the option to select between different architectures"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Standardize all resources names across CDK, Terraform and Pulumi"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"The Pulumi components that define the resources associated with each ECS service are not very dry"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is."}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional"}]},{type:a,value:e},{type:b,tag:h,props:{},children:[{type:a,value:"experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"If you want to get involved or help with any of the above, please let me know!"}]},{type:a,value:e},{type:b,tag:R,props:{id:cI},children:[{type:b,tag:j,props:{href:"#conclusion",ariaHidden:r,tabIndex:s},children:[{type:b,tag:c,props:{className:[t,u]},children:[]}]},{type:a,value:cJ}]},{type:a,value:e},{type:b,tag:i,props:{},children:[{type:a,value:"I first started out with IaC following this project "},{type:b,tag:j,props:{href:"https:\u002F\u002Fgithub.com\u002Faws-samples\u002Fecs-refarch-cloudformation",rel:[x,y,z],target:A},children:[{type:a,value:"aws-samples\u002Fecs-refarch-cloudformation"}]},{type:a,value:" (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform."}]}]},dir:"\u002F2023\u002F01\u002F07",path:"\u002F2023\u002F01\u002F07\u002Fi-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi",extension:".md",createdAt:ef,updatedAt:ef,raw:"\n## tl;dr\n\nI wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions.\n\n- **CDK Construct Library**: [github.com\u002Fbriancaffey\u002Fcdk-django](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fcdk-django)\n- **Terraform Modules**: [github.com\u002Fbriancaffey\u002Fterraform-aws-django](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fterraform-aws-django)\n- **Pulumi Component Library**: [github.com\u002Fbriancaffey\u002Fpulumi-aws-django](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fpulumi-aws-django)\n\n- Mono repo with a sample Django micro blogging app (μblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that *consumes* each of the libraries listed above, [VuePress documentation site](https:\u002F\u002Fbriancaffey.github.io\u002Fdjango-step-by-step\u002F) and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): [github.com\u002Fbriancaffey\u002Fdjango-step-by-step](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fdjango-step-by-step)\n\n## eli5\n\nPretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use.\n\nInstead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers.\n\nThe tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos *to YouTube*, but the code I'm writing allows you to upload any type of website (even site YouTube) *to the internet*. When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach.\n\n## Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi\n\n**To push me to learn more about AWS, IaC, CI\u002FCD, automation, and Platform Engineering**\n\n- Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate).\n- Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward\n\n**To fail as many times as possible**\n\n- Every time I fail when I think I have things right, I learn something new\n- Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production\n- You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important\n\n**To take an application-first approach to DevOps**\n\n- Application developers are increasingly being tasked with operational duties\n- While learning about IaC, I had a hard time finding in-depth materials covering application development, CI\u002FCD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image\n- You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind\n\n**To develop a project I can reference when helping myself and others**\n\n- companies and projects that do IaC and CI\u002FCD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor\n- Hopefully, the sample application, IaC, and CI\u002FCD pipelines *aren't overly complex*. There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on\n- People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to **show** people how it can be done\n\n**To encourage others (specifically Developer Advocates \u002F Developer Relations \u002F Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software **in use** with an actual application.**\n\n- There are many ways one could create an \"IaC Rosetta Stone\" (`public cloud providers x CI\u002FCD providers x IaC tools` is a big number)\n- This takes a lot of effort and time\n\n**I have nothing to sell you**\n\n- So many articles about Cloud\u002FDevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here\n- I'm also not trying to sell anyone on using my IaC packages\n- Hopefully, my IaC packages can serve as a helpful reference or starting point\n\n**Walk before running**\n\n- I want to build up confidence with vanilla use cases before getting too fancy\n- With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)\n\n**12 Factor App, DevOps, and Platform Engineering**\n\n- [12 Factor App](https:\u002F\u002F12factor.net\u002F) is great and has guided how I approach both Django application development and IaC library development\n- The [platformengineering.org](https:\u002F\u002Fplatformengineering.org\u002F) community has some good guiding principles\n\n## CDK\u002FTerraform\u002FPulumi terminology\n\n### constructs, modules and components\n\nA CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources.\n\nIn this article I will refer to **constructs\u002Fmodules\u002Fcomponents** as **c\u002Fm\u002Fc** for short, and the term **stack** can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had `apply` ran against it.\n\n### what is a stack?\n\nAWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module.\n\nCDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the `@pulumi\u002Faws` package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses).\n\n### verbs\n\nIn CDK you `synth` CDK code to generate CloudFormation templates. You can also run `diff` to see what changes would be applied during a stack update.\n\nIn Terraform you `init` to download all providers and modules. This is sort of like running `npm install` in CDK and Pulumi. You then run `terraform plan` to see the changes that would result. `terraform apply` does CRUD operations on your cloud resources.\n\nIn Pulumi you run `pulumi preview` to see what changes would be made to a stack. You can use the `--diff` flag to see the specifics of what would change.\n\nTo summarize:\n\n- In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time\n- In Terraform you plan a configuration made up of modules, and then run `terraform apply` to build the configuration\u002Fstack ([discuss.hashicorp.com\u002Ft\u002Fwhat-is-a-terraform-stack\u002F31985](https:\u002F\u002Fdiscuss.hashicorp.com\u002Ft\u002Fwhat-is-a-terraform-stack\u002F31985))\n- Pulumi: You preview a Pulumi stack made up of components, and then run `pulumi up` to build the resources\n- To tear down a stack in all three tools, you run `destroy`\n\n## Infrastructure as Code library repos\n\nLet's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate.\n\n- CDK: [`cdk-django`](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fcdk-django)\n- Terraform: [`terraform-aws-django`](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fterraform-aws-django)\n- Pulumi: [`pulumi-aws-django`](https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fpulumi-aws-django)\n\n### Language\n\n`cdk-django` and `pulumi-aws-django` are both written in TypeScript. `terraform-aws-django` is written in HCL, a domain specific language created by HashiCorp. The `cdk-django` is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using [jsii](https:\u002F\u002Fgithub.com\u002Faws\u002Fjsii).\n\nMy Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See [this GitHub repo](https:\u002F\u002Fgithub.com\u002Fpulumi\u002Fpulumi-component-provider-ts-boilerplate) for more information on this.\n\nThe HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called [CDKTF](https:\u002F\u002Fdeveloper.hashicorp.com\u002Fterraform\u002Fcdktf) which allows you to write HCL Terraform in TypeScript, but I haven't used it yet.\n\n### Release management, versioning and publishing\n\n`pulumi-aws-django` and `terraform-aws-django` both use `release-please` for automatically generating a changelog file and bumping versions. `release-please` is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to `main`, a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in `package.json` and adds a new git tag (e.g. `v1.2.3`) based on commit messages.\n\n`cdk-django` uses [`projen`](https:\u002F\u002Fgithub.com\u002Fprojen\u002Fprojen) for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file (`.projenrc.ts`) to configure your entire repo, including files like `tsconfig.json`, `package.json`, and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action.\n\nThese tools are both based on [conventional commits](https:\u002F\u002Fwww.conventionalcommits.org\u002Fen\u002Fv1.0.0\u002F) to automatically update the Changelog file.\n\nI'm still manually publishing my `pulumi-aws-django` package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!\n\n### Makefile, examples and local development\n\nEach repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:\n\n- synthesizing CDK to CloudFormation \u002F running `terraform plan` \u002F previewing pulumi up for both the base and app stacks\n- creating\u002Fupdating an ad hoc base stack called `dev`\n- destroying resources in the ad-hoc base stack called `dev`\n- creating an ad hoc app stack called `alpha` that uses resources from `dev`\n- destroying an ad hoc app stack called `alpha` that uses resources from `dev`\n- creating\u002Fupdating a prod base stack called `stage`\n- destroying resources in the prod base stack called `stage`\n- creating a prod app stack using called `stage` that uses resources from the `stage` base stack\n- destroying resources in the prod app stack called `stage`\n\nHere's an example of what these commands look like in `pulumi-aws-django` for prod infrastructure base and app stacks:\n\n```Makefile\nprod-base-preview:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive preview\n\nprod-base-up:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive up --yes\n\nprod-base-destroy:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fbase --stack stage --non-interactive destroy --yes\n\nprod-app-preview:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive preview\n\nprod-app-preview-diff:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive preview --diff\n\nprod-app-up:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive up --yes\n\nprod-app-destroy:\tbuild\n\tpulumi -C examples\u002Fprod\u002Fapp --stack stage --non-interactive destroy --yes\n```\n\nI currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the `c\u002Fm\u002Fc`s to create environments and smoke check the environments to make sure everything works correctly.\n\nAdding unit tests is another item for the backlog.\n\n### ad-hoc vs prod\n\n- [the last article I wrote was about ad hoc environments](https:\u002F\u002Fbriancaffey.github.io\u002F2022\u002F03\u002F27\u002Fad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions). Also known as \"on-demand\" environments or \"preview\" environments.\n- the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)\n- you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)\n- prod can be used for a production environment and any number of pre-production environments\n- multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)\n- the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment\n\n### Directory structure\n\nThe directory structures for each repo are all similar with some minor differences.\n\nThere are two types of environments: `ad-hoc` and `prod`. Within ad-hoc and production, there are two directories `base` and `app`.\n\nEach repo has a directory called `internal` which contain building blocks used by the `c\u002Fm\u002Fc`s that are exposed. The contents of the `internal` directories are not intended to be used by anyone who is using the libraries.\n\n**CDK construct library repo structure**\n\n```\n~\u002Fgit\u002Fgithub\u002Fcdk-django$ tree -L 4 -d src\u002F\nsrc\u002F\n├── constructs\n│   ├── ad-hoc\n│   │   ├── app\n│   │   └── base\n│   ├── internal\n│   │   ├── alb\n│   │   ├── bastion\n│   │   ├── customResources\n│   │   │   └── highestPriorityRule\n│   │   ├── ecs\n│   │   │   ├── iam\n│   │   │   ├── management-command\n│   │   │   ├── redis\n│   │   │   ├── scheduler\n│   │   │   ├── web\n│   │   │   └── worker\n│   │   ├── rds\n│   │   ├── sg\n│   │   └── vpc\n│   └── prod\n│       ├── app\n│       └── base\n└── examples\n    └── ad-hoc\n        ├── app\n        │   └── config\n        └── base\n            └── config\n```\n\n**Terraform module library repo structure**\n\n```\n~\u002Fgit\u002Fgithub\u002Fterraform-aws-django$ tree -L 4 -d modules\nmodules\n├── ad-hoc\n│   ├── app\n│   └── base\n├── internal\n│   ├── alb\n│   ├── autoscaling\n│   ├── bastion\n│   ├── ecs\n│   │   ├── ad-hoc\n│   │   │   ├── celery_beat\n│   │   │   ├── celery_worker\n│   │   │   ├── cluster\n│   │   │   ├── management_command\n│   │   │   ├── redis\n│   │   │   └── web\n│   │   └── prod\n│   │       ├── celery_beat\n│   │       ├── celery_worker\n│   │       ├── cluster\n│   │       ├── management_command\n│   │       └── web\n│   ├── elasticache\n│   ├── iam\n│   ├── rds\n│   ├── route53\n│   ├── s3\n│   ├── sd\n│   └── sg\n└── prod\n    ├── app\n    └── base\n```\n\n**Pulumi component library repo structure**\n\n```\n~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ tree -L 3 src\u002F\nsrc\u002F\n├── components\n│   ├── ad-hoc\n│   │   ├── README.md\n│   │   ├── app\n│   │   └── base\n│   └── internal\n│       ├── README.md\n│       ├── alb\n│       ├── bastion\n│       ├── cw\n│       ├── ecs\n│       ├── iam\n│       ├── rds\n│       └── sg\n└── util\n    ├── index.ts\n    └── taggable.ts\n```\n\n**Pulumi examples directory**\n\n```\n~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ tree -L 3 examples\u002F\nexamples\u002F\n└── ad-hoc\n    ├── app\n    │   ├── Pulumi.alpha.yaml\n    │   ├── Pulumi.yaml\n    │   ├── index.ts\n    │   ├── node_modules\n    │   ├── package-lock.json\n    │   ├── package.json\n    │   └── tsconfig.json\n    └── base\n        ├── Pulumi.yaml\n        ├── bin\n        ├── index.ts\n        ├── package-lock.json\n        ├── package.json\n        └── tsconfig.json\n```\n\n### CLOC\n\nLet's use CLOC (count lines of code) to compare the lines of code used in the `c\u002Fm\u002Fc` of CDK\u002FCloudFormation\u002FTerraform\u002FPulumi.\n\n**`cdk-django`**\n\n```\n~\u002Fgit\u002Fgithub\u002Fcdk-django$ cloc src\u002Fconstructs\u002F\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.04 s (356.1 files\u002Fs, 30040.9 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n```\n\n**`terraform-aws-django`**\n\n```\n~\u002Fgit\u002Fgithub\u002Fterraform-aws-django$ cloc modules\u002F\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.15 s (385.9 files\u002Fs, 20585.1 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n```\n\n**`pulumi-aws-django`**\n\n```\n~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ cloc src\u002Fcomponents\u002F\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com\u002FAlDanial\u002Fcloc v 1.94  T=0.11 s (134.5 files\u002Fs, 12924.2 lines\u002Fs)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n```\n\n## Communities\n\nThe CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!\n\n- [cdk.dev](https:\u002F\u002Fcdk.dev\u002F)\n- [Terraform Section of HashiCorp Discuss Forum](https:\u002F\u002Fdiscuss.hashicorp.com\u002Fc\u002Fterraform-core\u002F27)\n- [Pulumi Slack](https:\u002F\u002Fslack.pulumi.com\u002F)\n\n## μblog\n\nμblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:\n\n![ublog](\u002Fstatic\u002Fublog_screenshot.png)\n\nIt is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts.\n\n### Mono-repo structure\n\nIt lives in a GitHub mono repo called `django-step-by-step`. This mono repo contains a few different things:\n\n- backend Django application\n- frontend Vue.js application\n- IaC code that uses c\u002Fm\u002Fc from `cdk-django`, `terraform-aws-django` and `pulumi-aws-django`\n- GitHub Actions workflows for both Infrastructure deployments and application deployments\n\nμblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. μblog is meant to represent a generic 12 Factor application that uses:\n\n- gunicorn for a backend API\n- Vue.js for a client that consumes the backend API\n- celery for async task processing\n- celery beat for scheduling tasks\n- Postgres for relational data\n- Redis for caching and message brokering\n- S3 for object storage\n- Django admin for a simple admin interface\n\nThere is a lot more I could add on μblog. For now I'll just mention that it:\n\n- has a great local development environment (supports both docker-compose and virtual environments)\n- demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL.\n- GitHub Actions for running unit tests\n- k6 for load testing\n- contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: [https:\u002F\u002Fbriancaffey.github.io\u002Fdjango-step-by-step\u002F](https:\u002F\u002Fbriancaffey.github.io\u002Fdjango-step-by-step\u002F)\n\n# Infrastructure Deep Dive\n\nLet's go through each of the `c\u002Fm\u002Fc`s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi.\n\nI'll first talk about the two stacks used in ad hoc environments: `base` and `app`. Then I'll talk about the prod environments which are also composed of `base` and `app` stacks.\n\nKeep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, **especially with Terraform**. In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried).\n\n## Splitting up the stacks\n\nWhile it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so.\n\n- Terraform enables this with outputs and `terraform_remote_state`\n- Pulumi encourages the use of [micro stacks](https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fguides\u002Forganizing-projects-stacks\u002F)\n- CDK has an article on how to [create an app with multiple stacks](https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fstack_how_to_create_multiple_stacks.html)\n\nMy design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack.\n\nAlso, on-demand environments really lends itself to stacks that are split up.\n\nIn the section [\"Passing unique identifiers\"](https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fresources.html), the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app.\n\nThere is a balance to be found between single stacks vs micro stacks. Both the base and app `c\u002Fm\u002Fc`s could be split out further. For example, the `base` `c\u002Fm\u002Fc`s could be split into `networking` and `rds`. The `app` stack could be split into different ECS services so that their infrastructure can be deployed independently, like `cluster`, `backend` and `frontend`. The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article.\n\nMy rules of thumbs are:\n\n- single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change\n- Lots of small stacks can cause overhead and make things more complex than they need to be\n\n## Ad hoc base overview\n\nHere's an overview of the resources used in an ad hoc base environment.\n\n- (Inputs)\n- (Optional environment configs)\n- VPC and Service Discovery\n- S3\n- Security Groups\n- Load Balancer\n- RDS\n- Bastion Host\n\n### Visualization\n\nHere's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the `Resources` tab of the ad hoc base stack in the Pulumi console.\n\n![Graph view of ad hoc base infrastructure](\u002Fstatic\u002Fpulumi_ad_hoc_base_dep_graph.png)\n\n### Inputs\n\nThere are only two required inputs for the ad hoc base stack\n\n- ACM certificate ARN\n- Domain Name\n\nI store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy\u002Fapply\u002Fup or synth\u002Fplan\u002Fpreview.\n\n### VPC\n\nThe VPC is the first resource that is created as part of the `base` stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources.\n\n- `awsx` has a VPC module\n- `terraform-aws-vpc` module\n- L2 VPC Construct in CDK\n\nThe setting in the Terraform VPC module `one_nat_gateway_per_az = false` doesn't seem to exist on the `awsx.ec2.Vpc` module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3.\n\n### Security Groups\n\nPulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups.\n\n```ts\n    const albSecurityGroup = new SecurityGroup(scope, 'AlbSecurityGroup', {\n      vpc: props.vpc,\n    });\n\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(443), 'HTTPS');\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(80), 'HTTP');\n```\n\n### Load Balancer Resources\n\nThere's not much to comment on here. In each library I have resource group that defines the following:\n\n- Application Load Balancer\n- A default target group\n- An HTTP listener that redirects to HTTPS\n- An HTTPS listener with a default \"fixed-response\" action\n\nProperties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services.\n\nAd hoc app environments all share a common load balancer from the base stack that they use.\n\n### RDS Resources\n\nAll three libraries have the RDS security group and Subnet Group in the same `c\u002Fm\u002Fc` as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources.\n\nCurrently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment.\n\nThe way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential.\n\n```ts\n    const secret = new Secret(scope, 'dbSecret', {\n      secretName: props.dbSecretName,\n      description: 'secret for rds',\n      generateSecretString: {\n        secretStringTemplate: JSON.stringify({ username: 'postgres' }),\n        generateStringKey: 'password',\n        excludePunctuation: true,\n        includeSpace: false,\n      },\n    });\n```\n\nIn the `DatabaseInstance` props we can then use this secret like so:\n\n```\n    credentials: Credentials.fromSecret(secret),\n```\n\nIn the application deployed with CDK, I use a Django settings module package that uses a package called `aws_secretsmanager_caching` to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable.\n\nThe Terraform and Pulumi database instance arguments simply accept a `password` field. This will be another item for the backlog for Terraform and Pulumi. The [`randompassword`](https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Frandom\u002Fapi-docs\u002Frandompassword\u002F) and [`secretversion`](https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Faws\u002Fapi-docs\u002Fsecretsmanager\u002Fsecretversion\u002F) components can be used to do this.\n\n### Bastion Host\n\nThere are two main use cases for the bastion host in ad-hoc environments.\n\n- When creating a new ad hoc app environment, the bastion host is used to create a new database called `{ad-hoc-env-name}-db` that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now).\n\n- If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to `localhost:5432` on your local machine.\n\nYou don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:\n\n```bash\naws ssm start-session --target $INSTANCE_ID\n```\n\n### Outputs\n\nHere are the outputs for the ad hoc base stack used in Terraform and Pulumi:\n\n- vpc_id\n- assets_bucket_name\n- private_subnet_ids\n- app_sg_id\n- alb_sg_id\n- listener_arn\n- alb_dns_name\n- task_role_arn\n- execution_role_arn\n- rds_address\n\nIn CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like `Vpc` and `RdsInstance`. More on this later in the following section **Passing data between stacks**.\n\n## Ad hoc app overview\n\nThe ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc.\n\nThis visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console.\n\n![Graph view of ad hoc app infrastructure](\u002Fstatic\u002Fpulumi_ad_hoc_app_dep_graph.png)\n\n### ECS Cluster\n\n- This is a small component that defines both ECS Cluster and the default capacity providers\n- It defaults to not using `FARGATE_SPOT`; ad hoc environments do use `FARGATE_SPOT` for cost savings\n\n\u003E NOTE: defaultCapacityProviderStrategy on cluster not currently supported. ([link](https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fapi\u002Fv1\u002Fdocs\u002F@aws-cdk_aws-ecs.CapacityProviderStrategy.html))\n\n### Shared environment variables\n\nThe backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource `c\u002Fm\u002Fc`s.\n\n- I struggled to get this right in pulumi. A lot of Pulumi examples used `JSON.stringify` for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use `pulumi.jsonStringify` which was added in a relatively recent version of `pulumi\u002Fpulumi`.\n- CDK allows you to declare environment variables for a containerDefinition like `{ FOO: \"bar\" }`\n- Pulumi and Terraform require that values are passed like `{ name: \"FOO\", value: \"bar\"}`\n- You could transform `{ FOO: \"bar\" }` into the name\u002Fvalue format, but I didn't bother to do this\n- extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the `concat` function to add these to the list of default environment variables.\n\nHere's what the code looks like for joining extra environment variables to the default environment variables:\n\n```ts\n    \u002F\u002F CDK\n    if (extraEnvVars) {\n      environmentVariables = { ...extraEnvVars, ...environmentVariables };\n    }\n```\n\n```\n    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n```\n\n```\n    \u002F\u002F Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x =\u003E x.concat(extraEnvVars!))\n    }\n```\n\n### Route53 Record\n\nThis is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns.\n\nThis part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching `example.com\u002Fapi\u002F*` are routed to the backend API and all other requests matching `example.com\u002F*` are routed to the frontend service.\n\n### Redis\n\nI go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis.\n\nI decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable.\n\n### Web Service\n\nThe web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This `c\u002Fm\u002Fc` has an input parameter called `pathPatterns` which determines which paths it serves. For example, the API container may serve traffic for `\u002Fapi\u002F*` and `\u002Fadmin\u002F*` only, or it may want to serve all traffic (`\u002F*`).\n\nThe way I use these components in ad hoc and prod environments is heavily opinionated in that:\n\n- it assumes that the frontend SPA\u002FSSR site should have a lower priority rule than the backend service and should route request paths matching `\u002F*`, while the backend service routes requests for a specific list of path patterns (`\u002Fapi\u002F*`, `\u002Fadmin\u002F*`, `\u002Fgraphql\u002F*`, etc.).\n\nYou may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring.\n\n### Celery\n\n- The reason for having a celery service is to be able to have potentially multiple workers that scale independently\n- I use the same Pulumi component for both works and schedulers\n\nThe terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like `AsyncWorker` across the board rather than using the term `celery`.\n\n### Management Command\n\n- Defines a task that can be used to run commands like `collectstatic` and `migrate`\n- These tasks are ran both after the initial `app` stack deployment and before rolling application upgrades\n\nIn my Django app I have a single management command that calls `migrate` and `collectstatic` and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc.\n\nOne other thing to note about this `c\u002Fm\u002Fc` is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:\n\n- saves the `START` timestamp\n- runs the task with the required settings\n- waits for the task to complete\n- saves the `END` timestamp\n- collects the logs for the task between `START` and `END` and prints them to `stdout`\n\nHere's an example of what the script looks like in Pulumi:\n\n```ts\n    const executionScript = pulumi.interpolate`#!\u002Fbin\u002Fbash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster ${props.ecsClusterId} --task-definition ${taskDefinition.arn} --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[${props.privateSubnetIds.apply(x =\u003E x.join(\",\"))}],securityGroups=[${props.appSgId}],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster ${props.ecsClusterId}\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name ${cwLoggingResources.cwLogGroupName} --log-stream-name ${props.name}\u002F${props.name}\u002F\\${TASK_ID##*\u002F} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n`;\n    this.executionScript = executionScript;\n```\n\nIn GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:\n\n```yaml\n      - name: \"Run backend update command\"\n        id: run_backend_update\n        run: |\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" \u003E backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          .\u002Fbackend_update_command.sh\n```\n\n### Passing data between stacks\n\nPulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References.\n\nHere's what this looks like in Terraform\n\n```h\ndata \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"..\u002Fbase\u002Fterraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"..\u002F..\u002F..\u002Fmodules\u002Fad-hoc\u002Fapp\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n```\n\nIn CDK:\n\n```ts\nconst baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n\nconst adHocBase = new AdHocBase(baseStack, 'AdHocBase', { certificateArn, domainName });\n\nconst addHocApp = new AdHocApp(appStack, 'AdHocApp', {\n  baseStackName: adHocBaseEnvName,\n  vpc: adHocBase.vpc,\n  alb: adHocBase.alb,\n  appSecurityGroup: adHocBase.appSecurityGroup,\n  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n  rdsInstance: adHocBase.databaseInstance,\n  assetsBucket: adHocBase.assetsBucket,\n  domainName: adHocBase.domainName,\n  listener: adHocBase.listener,\n});\n```\n\nand in Pulumi:\n\n```ts\nconst stackReference = new pulumi.StackReference(`${org}\u002Fad-hoc-base\u002F${environment}`)\n\nconst vpcId = stackReference.getOutput(\"vpcId\") as pulumi.Output\u003Cstring\u003E;\nconst assetsBucketName = stackReference.getOutput(\"assetsBucketName\") as pulumi.Output\u003Cstring\u003E;\nconst privateSubnets = stackReference.getOutput(\"privateSubnetIds\") as pulumi.Output\u003Cstring[]\u003E;\nconst appSgId = stackReference.getOutput(\"appSgId\") as pulumi.Output\u003Cstring\u003E;\nconst albSgId = stackReference.getOutput(\"albSgId\") as pulumi.Output\u003Cstring\u003E;\nconst listenerArn = stackReference.getOutput(\"listenerArn\") as pulumi.Output\u003Cstring\u003E;\nconst albDnsName = stackReference.getOutput(\"albDnsName\") as pulumi.Output\u003Cstring\u003E;\nconst serviceDiscoveryNamespaceId = stackReference.getOutput(\"serviceDiscoveryNamespaceId\") as pulumi.Output\u003Cstring\u003E;\nconst rdsAddress = stackReference.getOutput(\"rdsAddress\") as pulumi.Output\u003Cstring\u003E;\nconst domainName = stackReference.getOutput(\"domainName\") as pulumi.Output\u003Cstring\u003E;\nconst baseStackName = stackReference.getOutput(\"baseStackName\") as pulumi.Output\u003Cstring\u003E;\n\n\u002F\u002F ad hoc app env\nconst adHocAppComponent = new AdHocAppComponent(\"AdHocAppComponent\", {\n  vpcId,\n  assetsBucketName,\n  privateSubnets,\n  appSgId,\n  albSgId,\n  listenerArn,\n  albDnsName,\n  serviceDiscoveryNamespaceId,\n  rdsAddress,\n  domainName,\n  baseStackName\n});\n```\n\n## CLI scaffolding\n\nCDK and Pulumi have some good options for how to scaffold a project.\n\n- Pulumi has `pulumi new aws-typescript` among lots of other options (run `pulumi new -l` to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in `django-step-by-step` that consume the library.\n- CDK has `projen` CLI commands which can help set up either library code or project code\n- The major benefits of these tools is setting up `tsconfig.json` and `package.json` correctly\n- Terraform is so simple that it doesn't really need tooling for scaffolding\n\n## Best practices\n\nFor `terraform-aws-django`, I tried to follow the recommendations from [terraform-best-practices.com](https:\u002F\u002Fwww.terraform-best-practices.com\u002F) which helped me a lot with things like consistent naming patterns and directory structures. For example:\n\n- use the name `this` for resources in a module where that resource is the only resource of its type\n\nCDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi.\n\nFor Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of `Inputs`, `Outputs`, `pulumi.interpolate`, `apply()`, `all()` and the differences between `getX` and `getXOutput`. There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way.\n\n## Environment configuration\n\nEnvironment configuration allows for either a base or app stack to be configured with non-default values. For example:\n\n- you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration\n- You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config.\n\nIn the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values.\n\n- Pulumi defines environment-specific config in files called `Pulumi.{env}.yaml` ([Pulumi article on configuration](https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fintro\u002Fconcepts\u002Fconfig\u002F))\n- Terraform uses `{env}.tfvars` for this type of configuration\n- CDK has several options for this type of configuration (`cdk.context.json`, extending stack props, etc.)\n\nFor CDK I have been using `setContext` and the `tryGetContext` method:\n\n`setContext` needs to be set on the node before any child nodes are added:\n\n```ts\nconst baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n```\n\nAnd the config objects are read from JSON files like this:\n\n```ts\nvar adHocBaseEnvConfig = JSON.parse(fs.readFileSync(`src\u002Fexamples\u002Fad-hoc\u002Fbase\u002Fconfig\u002F${adHocBaseEnvName}.json`, 'utf8'));\nvar adHocAppEnvConfig = JSON.parse(fs.readFileSync(`src\u002Fexamples\u002Fad-hoc\u002Fapp\u002Fconfig\u002F${adHocAppEnvName}.json`, 'utf8'));\n```\n\nThe context can be used in constructs like this:\n\n```ts\n    const extraEnvVars = this.node.tryGetContext('config').extraEnvVars;\n```\n\nPulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:\n\n```ts\n    interface EnvVar {\n      name: string;\n      value: string;\n    }\n\n    let config = new pulumi.Config();\n    let extraEnvVars = config.getObject\u003CEnvVar[]\u003E(\"extraEnvVars\");\n```\n\nIn my `Pulumi.alpha.yaml` file I have the `extraEnvVars` set like this:\n\n```yaml\nconfig:\n  aws:region: us-east-1\n  extraEnvVars:\n    - name: FOO\n      value: BAR\n    - name: BIZ\n      value: BUZ\n```\n\nI haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)\n\n## Local development\n\nUsing the Makefile targets in each library repo, my process for developing `c\u002Fm\u002Fc`s involves making code changes followed by Makefile targets that preview\u002Fplan\u002Fdiff against my AWS account, then running deploy\u002Fapply\u002Fup and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services.\n\nHere are some sample times for deploying ad hoc stacks with CDK.\n\n```\n# CDK ad hoc base deployment time\n\n ✅  ExampleAdHocBaseStack (dev)\n\n✨  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ✅  ExampleAdHocAppStack (alpha)\n\n✨  Deployment time: 126.62s\n```\n\nHere is an example of what the `pulumi preview` commands shows for the ad-hoc base stack:\n\n```\n# Pulumi preview\n~\u002Fgit\u002Fgithub\u002Fpulumi-aws-django$ pulumi -C examples\u002Fad-hoc\u002Fbase --stack dev preview\nPreviewing update (dev)\n\nView Live: https:\u002F\u002Fapp.pulumi.com\u002Fbriancaffey\u002Fad-hoc-base\u002Fdev\u002Fpreviews\u002F718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   └─ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ├─ pulumi-contrib:components:AlbResources            AlbResources                create\n +      │  ├─ aws:alb:TargetGroup                            DefaultTg                   create\n +      │  ├─ aws:alb:LoadBalancer                           LoadBalancer                create\n +      │  ├─ aws:alb:Listener                               HttpListener                create\n +      │  └─ aws:alb:Listener                               HttpsListener               create\n +      ├─ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      │  ├─ aws:iam:Role                                   BastionHostRole             create\n +      │  ├─ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      │  ├─ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      │  └─ aws:ec2:Instance                               BastionHostInstance         create\n +      ├─ pulumi-contrib:components:RdsResources            RdsResources                create\n +      │  ├─ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      │  ├─ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      │  └─ aws:rds:Instance                               DbInstance                  create\n +      ├─ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      │  ├─ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      │  └─ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ├─ aws:s3:Bucket                                     assetsBucket                create\n +      ├─ awsx:ec2:Vpc                                      dev                         create\n +      │  └─ aws:ec2:Vpc                                    dev                         create\n +      │     ├─ aws:ec2:InternetGateway                     dev                         create\n +      │     ├─ aws:ec2:Subnet                              dev-private-1               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-1               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      │     │     └─ aws:ec2:Route                         dev-private-1               create\n +      │     ├─ aws:ec2:Subnet                              dev-private-2               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-2               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      │     │     └─ aws:ec2:Route                         dev-private-2               create\n +      │     ├─ aws:ec2:Subnet                              dev-public-1                create\n +      │     │  ├─ aws:ec2:RouteTable                       dev-public-1                create\n +      │     │  │  ├─ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      │     │  │  └─ aws:ec2:Route                         dev-public-1                create\n +      │     │  ├─ aws:ec2:Eip                              dev-1                       create\n +      │     │  └─ aws:ec2:NatGateway                       dev-1                       create\n +      │     └─ aws:ec2:Subnet                              dev-public-2                create\n +      │        ├─ aws:ec2:RouteTable                       dev-public-2                create\n +      │        │  ├─ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      │        │  └─ aws:ec2:Route                         dev-public-2                create\n +      │        ├─ aws:ec2:Eip                              dev-2                       create\n +      │        └─ aws:ec2:NatGateway                       dev-2                       create\n +      └─ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output\u003Cstring\u003E\n    albSgId                    : output\u003Cstring\u003E\n    appSgId                    : output\u003Cstring\u003E\n    assetsBucketName           : output\u003Cstring\u003E\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output\u003Cstring\u003E\n    domainName                 : \"example.com\"\n    listenerArn                : output\u003Cstring\u003E\n    privateSubnetIds           : output\u003Cstring\u003E\n    rdsAddress                 : output\u003Cstring\u003E\n    serviceDiscoveryNamespaceId: output\u003Cstring\u003E\n    vpcId                      : output\u003Cstring\u003E\n\nResources:\n    + 44 to create\n```\n\n## Running infrastructure pipelines in GitHub Actions\n\n*I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!*\n\nIn the `.github\u002Fworkflows` directory of the `django-step-by-step` repo, I will have the following `2 * 2 * 2 * 3 = 24` pipelines for running infrastructure as code pipelines:\n\n```bash\n{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n```\n\n- For CDK I'm using CDK CLI commands\n- For Terraform I'm also using terraform CLI commands\n- For Pulumi I'm using the official Pulumi GitHub Action\n\nPulumi has [a great article](https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fguides\u002Fcontinuous-delivery\u002Fgithub-actions\u002F) about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags.\n\nThe general pattern that all of these pipelines use is:\n\n- Do a synth\u002Fplan\u002Fpreview, and upload the synth\u002Fplan\u002Fpreview file to an artifact\n- Pause and wait on manual review of the planned changes\n- download the artifact and run deploy\u002Fapply\u002Fup against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected.\n\nI do this by having two jobs in each GitHub Action: one for synth\u002Fplan\u002Fpreview and one for deploy\u002Fapply\u002Fup.\n\nThe job for deploy\u002Fapply\u002Fup includes an `environment` that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job.\n\n## Application deployments\n\n- There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)\n\n- The backend deployment script runs database migrations, the `collectstatic` command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)\n\n- What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks.\n\n## Interacting with AWS via IaC\n\n- CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides [L1, L2 and L3 constructs](https:\u002F\u002Fdocs.aws.amazon.com\u002Fcdk\u002Fv2\u002Fguide\u002Fconstructs.html) which offer different levels of abstraction over CloudFormation.\n- Terraform has the [AWS Provider](https:\u002F\u002Fregistry.terraform.io\u002Fproviders\u002Fhashicorp\u002Faws\u002Flatest\u002Fdocs) and the [`terraform-aws-modules`](https:\u002F\u002Fregistry.terraform.io\u002Fnamespaces\u002Fterraform-aws-modules).\n- Pulumi has AWS Classic (`@pulumi\u002Faws`) **provider** and `AWSx` ([Crosswalk for Pulumi](https:\u002F\u002Fwww.pulumi.com\u002Fregistry\u002Fpackages\u002Fawsx\u002F)) **library** and `aws_native` **provider**.\n\n\u003E `aws_native` \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\"\n\n`aws_native` looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider.\n\nFor CDK I use mostly L2 constructs and some L1 constructs.\n\nFot Terraform I use the VPC from the `terraform-aws-modules`, and everything else uses the AWS Terraform Provider.\n\n## What I did not put in IaC\n\n- ECR (Elastic Container Registry)\n- ACM (Amazon Certificate Manager)\n- (Roles used for deployments)\n\nI created the Elastic Container Registry `backend` and `frontend` repos manually in the AWS Console. I also manually requested an ACM certificate for `*.mydomain.com` for the domain that I use for testing that I purchased through Route53 domains.\n\nI currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog.\n\n## Tagging\n\n- Terraform and CDK both make it easy to automatically tag all resources in a stack\n- It is possible to do this in Pulumi, but you need to write a little bit of code.\n- [https:\u002F\u002Fwww.pulumi.com\u002Fblog\u002Fautomatically-enforcing-aws-resource-tagging-policies\u002F](https:\u002F\u002Fwww.pulumi.com\u002Fblog\u002Fautomatically-enforcing-aws-resource-tagging-policies\u002F)\n- [https:\u002F\u002Fgithub.com\u002Fjoeduffy\u002Faws-tags-example\u002Ftree\u002Fmaster\u002Fautotag-ts](https:\u002F\u002Fgithub.com\u002Fjoeduffy\u002Faws-tags-example\u002Ftree\u002Fmaster\u002Fautotag-ts)\n- Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)\n- Automatically tagging resources works through [stack transformations](https:\u002F\u002Fwww.pulumi.com\u002Fdocs\u002Fintro\u002Fvs\u002Fterraform\u002F) are unique to Pulumi\n\n## Smoke checking application environments\n\nHere's the list of things I check when standing up an application environment:\n\n- [x] Run the init\u002Ftsc, synth\u002Fplan\u002Fpreview and deploy\u002Fapply\u002Fup commands successfully\n- [x] Access the bastion host (`make aws-ssm-start-session`)\n- [x] Run ECSExec to access a shell in a backend container (`make aws-ecs-exec`)\n- [x] Test database connectivity (`python manage.py showmigrations`)\n- [x] Run the migrations (`python manage.py migrate`)\n- [x] Run collectstatic (`python manage.py collectstatic`)\n- [x] Visit the site (`alpha.example.com`)\n- [x] Publish a blog post\n- [x] Publish a blog post with an image\n- [x] Check celery worker logs for successfully complete scheduled tasks\n- [x] Trigger an autoscaling event by running k6 load tests against an environment\n- [x] Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates\n- [x] Destroy the app stack\n- [x] Destroy the base stack\n\n## Backlog and next steps\n\nHere are some of the next things I'll be working on in these project, roughly in order of importance:\n\n- [x] Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines\n- Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub\n- Show how to do account isolation (different accounts for prod vs pre-prod environments)\n- GitHub Actions deployment pipeline for publishing `pulumi-aws-django` package\n- Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)\n- For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the `random` functions to do this\n- Refactor GitHub Actions and make them reusable across different projects\n- Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules\n- Use graviton instances and have the option to select between different architectures\n- Standardize all resources names across CDK, Terraform and Pulumi\n- The Pulumi components that define the resources associated with each ECS service are not very dry\n- Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)\n- Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is.\n- Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional\n- experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site\n\nIf you want to get involved or help with any of the above, please let me know!\n\n## Conclusion\n\nI first started out with IaC following this project [aws-samples\u002Fecs-refarch-cloudformation](https:\u002F\u002Fgithub.com\u002Faws-samples\u002Fecs-refarch-cloudformation) (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform.\n"}}],fetch:{},mutations:[]}}("text","element","span","token","\n","punctuation","code","li","p","a"," ","operator",".","string",",","keyword",")","true",-1,"icon","icon-link","ul","(","nofollow","noopener","noreferrer","_blank",";",":","function",true,"}","=","strong","div","nuxt-content-highlight","pre","line-numbers",3,"h3","interpolation-punctuation","const",2,"h2"," and ","{","task-list-item","input","checkbox","language-text","class-name","\u003E","builtin","c\u002Fm\u002Fc"," pulumi","interpolation","${","\u003C","new"," stackReference","getOutput","as","Output","language-ts","key","atrule",", ","app","pulumi-aws-django","\n    ","template-punctuation","`"," adHocBase","cdk-django","terraform-aws-django","    ","props","setContext","\n\n","dev","em","stage","base","extraEnvVars","name","-","node","'config'","eli5","verbs","μblog","vpc","template-string","Stack"," env"," stackName","pulumi","Inputs","Security Groups","Bastion Host","Outputs","celery","Passing data between stacks",": ","https:\u002F\u002Fbriancaffey.github.io\u002Fdjango-step-by-step\u002F","package.json","img","django-step-by-step","number","constant","JSON","collectstatic","this","_","aws_native","tldr","tl;dr","why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi","Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi","cdkterraformpulumi-terminology","CDK\u002FTerraform\u002FPulumi terminology","constructs-modules-and-components","constructs, modules and components","what-is-a-stack","what is a stack?","infrastructure-as-code-library-repos","Infrastructure as Code library repos","language","Language","release-management-versioning-and-publishing","Release management, versioning and publishing","makefile-examples-and-local-development","Makefile, examples and local development","ad-hoc-vs-prod","ad-hoc vs prod","directory-structure","Directory structure","cloc","CLOC","communities","Communities","mono-repo-structure","Mono-repo structure","splitting-up-the-stacks","Splitting up the stacks","ad-hoc-base-overview","Ad hoc base overview","visualization","Visualization","inputs","VPC","security-groups","load-balancer-resources","Load Balancer Resources","rds-resources","RDS Resources","bastion-host","outputs","ad-hoc-app-overview","Ad hoc app overview","ecs-cluster","ECS Cluster","shared-environment-variables","Shared environment variables","route53-record","Route53 Record","redis","Redis","web-service","Web Service","Celery","management-command","Management Command","passing-data-between-stacks","cli-scaffolding","CLI scaffolding","best-practices","Best practices","environment-configuration","Environment configuration","local-development","Local development","running-infrastructure-pipelines-in-github-actions","Running infrastructure pipelines in GitHub Actions","application-deployments","Application deployments","interacting-with-aws-via-iac","Interacting with AWS via IaC","what-i-did-not-put-in-iac","What I did not put in IaC","tagging","Tagging","smoke-checking-application-environments","Smoke checking application environments","backlog-and-next-steps","Backlog and next steps","conclusion","Conclusion","https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fcdk-django","https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fterraform-aws-django","https:\u002F\u002Fgithub.com\u002Fbriancaffey\u002Fpulumi-aws-django","apply","@pulumi\u002Faws","terraform plan","terraform apply","pulumi preview","release-please","projen","tsconfig.json","alpha"," that uses resources from ","internal","backend","frontend","scope"," props","addIngressRule","Peer","anyIpv4"," Port","tcp","boolean","In the ","language-bash","FARGATE_SPOT","blockquote","{ FOO: \"bar\" }","comment","...","\u002Fapi\u002F*","\u002Fadmin\u002F*","\u002F*","migrate","saves the ","START"," timestamp","END","ecsClusterId","language-yaml"," baseStack ","'ExampleAdHocBaseStack'"," adHocBaseEnvName ","\nbaseStack"," adHocBaseEnvConfig"," appStack ","'ExampleAdHocAppStack'"," adHocAppEnvName ","\nappStack"," adHocAppEnvConfig"," domainName ","\n  domainName","environment","[","]","Pulumi has "," ("," and the ","tryGetContext","var","parse","fs","readFileSync",".json","'utf8'"," extraEnvVars ","EnvVar","let","\n  ","value","terraform-aws-modules",") ","provider","https:\u002F\u002Fwww.pulumi.com\u002Fblog\u002Fautomatically-enforcing-aws-resource-tagging-policies\u002F","https:\u002F\u002Fgithub.com\u002Fjoeduffy\u002Faws-tags-example\u002Ftree\u002Fmaster\u002Fautotag-ts","contains-task-list","2023-11-23T14:41:56.636Z")));