[{"_path":"/2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"How to authenticate Django REST Framework API calls from a (Vue) JS client using Session Authentication and HttpOnly cookies","description":"This article will describe an authentication strategy using Django REST Framework with a Javascript frontend application. I'll be demonstrating this with Vue.js (Qusar Framework, using Vue 2), but the concepts should transfer to any other Javascript framework.","layout":"post","date":"2020-11-27T00:00:00.000Z","comments":true,"image":"/static/padlocks.jpg","tags":["django","vue","authentication","api"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will describe an authentication strategy using Django REST Framework with a Javascript frontend application. I'll be demonstrating this with Vue.js (Qusar Framework, using Vue 2), but the concepts should transfer to any other Javascript framework."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a GitLab repository for a project that I will be referencing throughout this article: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/verbose-equals-true/django-postgres-vue-gitlab-ecs","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/verbose-equals-true/django-postgres-vue-gitlab-ecs"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I first started learning about how to do authentication from a Vue client, I found "},{"type":"element","tag":"a","props":{"href":"https://blog.sqreen.com/authentication-best-practices-vue/","rel":["nofollow"]},"children":[{"type":"text","value":"this article from Sqreen"}]},{"type":"text","value":" which describes how to use JWT to authenticate a Vue application. The example uses a mocked backend, but it is a good proxy for what you would have if you were to use a library like "},{"type":"element","tag":"a","props":{"href":"https://github.com/SimpleJWT/django-rest-framework-simplejwt","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-rest-framework-simplejwt"}]}]},{"type":"text","value":", which I have previously used with success in Django projects."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"JWT is an option for doing authentication with DRF "},{"type":"element","tag":"a","props":{"href":"https://www.django-rest-framework.org/api-guide/authentication/#json-web-token-authentication","rel":["nofollow"]},"children":[{"type":"text","value":"listed in the authentication documentation"}]},{"type":"text","value":", but the documentation doesn't recommend when or how to use JWT authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Session authentication is mentioned as well:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This authentication scheme uses Django's default session backend for authentication. Session authentication is appropriate for AJAX clients that are running in the same session context as your website."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my project, both in local development and in production environments, I serve the API and the Javascript clients on the same domain. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/*"}]},{"type":"text","value":" requests go to the API, and all other request paths route to the frontend client. In other scenarios such as using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://api.mysite.com"}]},{"type":"text","value":" for hosting a frontend and API an different subdomains, there would need to be additional considerations for CORS, but since I have the frontend and the backend being served on the same domain (and same subdomain), this isn't a concern. You might need to watch out for this if your requirements are different."}]},{"type":"element","tag":"h2","props":{"id":"the-authentication-flow"},"children":[{"type":"text","value":"The authentication flow"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's describe the login process at a high level."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A user navigates to your site. There is currently nothing in the browser's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localStorage"}]},{"type":"text","value":" or cookies related to authentication."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user navigates to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Login"}]},{"type":"text","value":" page at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/login"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Loading this Vue component makes a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"GET"}]},{"type":"text","value":" request to a special endpoint in our Django backend "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login-set-cookie/"}]},{"type":"text","value":". This request returns a simple JSON message: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"CSRF cookie set\""}]},{"type":"text","value":", and as the message says, the response sets a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrf"}]},{"type":"text","value":" cookie on our browser."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Once the CSRF cookie is set by the response from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login-set-cookie/"}]},{"type":"text","value":", the user is presented with a login form and enters account credentials (email and password in my example, where email is the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"USERNAME_FIELD"}]},{"type":"text","value":" on my custom user model). Clicking \"Login\" dispatches a Vuex action that uses Axios to send a send a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrf"}]},{"type":"text","value":" cookie set in a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"X-CSRFToken"}]},{"type":"text","value":" header."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" is handled by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login_view"}]},{"type":"text","value":" view which uses two important functions from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django.contrib.auth"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" gets the user from the provided credentials, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":" sets a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" HttpOnly cookie on the response."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the response from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" comes back, two things happen: first the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" HttpOnly cookie is set on our browser. Second, we set a value in both Vuex and localStorage named "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"success"}]},{"type":"text","value":". We are not storing any sensitive information in this value. Instead, we are using this value to signal to the rest of our Vue application that the user has authenticated. Storing this in Vuex allows us to use global Vuex "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"getters"}]},{"type":"text","value":" so that we can change component state and other logic where authentication is concerned, such as route guards (for Vue router). We store it in localStorage so that when a new browser tab is opened, we can set the value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" in Vuex based on the value in localStorage. ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated: localStorage.getItem(\"authenticated\") || \"\","}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Since the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie is HttpOnly, we can't use Javascript to interact with it, so when we want to logout the user we can't just delete the cookie. To logout the user, we make a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/logout/"}]},{"type":"text","value":" when the user clicks on the logout button. The view for this endpoint does "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"logout(request)"}]},{"type":"text","value":". This returns a response with a new value for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Set-Cookie: sessionid=\"\"; expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; Path=/; SameSite=Lax"}]},{"type":"text","value":". Since the cookie's expiration is in the past, it is removed entirely. We also remove the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" localStorage item and set the Vuex store value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"''"}]},{"type":"text","value":" (which is falsey). This lets the Vue application know that user has been logged out. One consideration for this is that your user can't logout while offline."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This repo also implements social authentication with the fantastic Python Social Auth library. I used Facebook, Google and GitHub, but there are lots of other providers you can choose from depending on what you need. This is a lengthy topic, and I recommend that you read "},{"type":"element","tag":"a","props":{"href":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end","rel":["nofollow"]},"children":[{"type":"text","value":"How to Integrate OAuth 2 Into Your Django/DRF Back-end Without Going Insane"}]},{"type":"text","value":" on which I have based my implementation. Here's the short story of how this works. First, a user clicks on one of the social sign-in links. These links are the same for sign-in and sign-up."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The link has a few parts, here's an example: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://github.com/login/oauth/authorize?client_id=r66bdfgsfsbferfef4&redirect_uri=http:%2F%2Flocalhost%2Fauth%2Fgithub%2Fcallback&login=&scope=user:email&state=ewori4t95k3vdzem"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"client_id"}]},{"type":"text","value":" is the app we created to allow our users to sign in. When you create this app, you specify the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redirect_uri"}]},{"type":"text","value":" in the configuration, and you reference that here as well. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"scope"}]},{"type":"text","value":" specifies scope of access we are requesting from the user's social account. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"state"}]},{"type":"text","value":" is used for security."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When you click on the link above, you are redirected to GitHub and asked if you want to grant my GitHub application access to your account's associated email address. Clicking on \"Authorize\" then redirects you back to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redirect_uri"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/auth/github/callback?code=veroi3409e203ej&state=ewori4t95k3vdzem"}]},{"type":"text","value":". Notice the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"code"}]},{"type":"text","value":" parameter."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When you navigate to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/auth/github/callback"}]},{"type":"text","value":" on the Vue application, you see a message: \"Logging in with GitHub...\". On this page's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"mounted"}]},{"type":"text","value":" method we call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handleOauthCallback"}]},{"type":"text","value":" which makes a request to our Django application: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/social/github/?code=veroi3409e203ej"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This API endpoint uses the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"exchange_token"}]},{"type":"text","value":" view which is where Python Social Auth starts to do the heavy lifting. First, we need to make an API request to GitHub ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://github.com/login/oauth/access_token"}]},{"type":"text","value":") with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"code"}]},{"type":"text","value":" as a URL parameter, then we pass the access code that this API call returns into Python Social Auth's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"do_auth"}]},{"type":"text","value":" function to get our Django user. Finally, similar to the email/password login approach described above, we call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login(request, user)"}]},{"type":"text","value":" and return a simple JSON response: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{\"detail\": \"success\"}"}]},{"type":"text","value":". This will set the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" automatically when the response returns, and we can dispatch the same Vuex action "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AUTH_SUCCESS"}]},{"type":"text","value":" to tell Vuex that a user has been logged in."}]}]},{"type":"element","tag":"h2","props":{"id":"discussion"},"children":[{"type":"text","value":"Discussion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the default Django session authentication mechanism has some nice advantages. It allows us to easily navigate between our Javascript SPA which uses Django REST Framework, regular Django admin views that you may also be using, as well as the Django admin."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using DRF's token authentication is still possible if you choose to use Session authentication for your JS frontend. For example, you may wish to allow users to make authenticated API requests to your public API using DRF Token Authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"JWT is a really interesting concept and important to know about, but it doesn't seem like a practical solution for any of my use cases with Django APIs or frontends. You also can't really \"logout\" a user if you are using this solution for authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"What I have described here is pretty simple scenario. It assumes that there is only one type of user and that there are no additional steps needed to make your account \"active\". Doing this would require additional logic on the Vue/Vuex side as well as the backend logic, including the User model. I also don't make use of any data from the social providers except for the user's email address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another thing to be aware of with this scenario is that a user can register with social authentication first, and then reset their password and login with email (I haven't implemented this client-side on this project yet). Or, you can login with an email account that was created through the Django admin and then login with a social account tied to that email. There are a lot of options for each backend in Python social auth, making it a very flexible library for handling social authentication."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a lot more work to do on this example project regarding authentication, but I hope it can help point some people in the right direction. Here are some areas that I would like to work on next:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Error handling for a bad authentication attempt"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A signup form with email confirmation, handling cases where the user trying to signup may already have signed in with social authentication"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Password reset with email"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Making use of Python Social Auth settings and options, including pipelines."}]}]},{"type":"element","tag":"h2","props":{"id":"resources"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://yoongkang.com/blog/cookie-based-authentication-spa-django/","rel":["nofollow"]},"children":[{"type":"text","value":"https://yoongkang.com/blog/cookie-based-authentication-spa-django/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/encode/django-rest-framework/issues/7273","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/encode/django-rest-framework/issues/7273"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/SimpleJWT/django-rest-framework-simplejwt/issues/71","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/SimpleJWT/django-rest-framework-simplejwt/issues/71"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/","rel":["nofollow"]},"children":[{"type":"text","value":"http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/"}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"the-authentication-flow","depth":2,"text":"The authentication flow"},{"id":"discussion","depth":2,"text":"Discussion"},{"id":"next-steps","depth":2,"text":"Next Steps"},{"id":"resources","depth":2,"text":"Resources"}]}},"_type":"markdown","_id":"content:2020:11:27:how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","_source":"content","_file":"2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","_stem":"2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies","_extension":"md"},{"_path":"/2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp","_dir":"10","_draft":false,"_partial":false,"_locale":"","title":"How to add an email signup form to a Nuxt site with MailChimp","description":"This is a guide for setting up a MailChimp-powered newsletter signup form on a static Nuxt site hosted on GitHub Pages. I wanted to implement this on my personal blog to grow a mailing list so I can update readers when I puslish a new blog article. I haven't done too much work with MailChimp before, but I've definitely subscribed to plenty of MailChimp mailing lists.","layout":"post","date":"2020-10-11T00:00:00.000Z","comments":true,"image":"/static/chimps.webp","tags":["nuxt","mailchimp","vue"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a guide for setting up a MailChimp-powered newsletter signup form on a static Nuxt site hosted on GitHub Pages. I wanted to implement this on my personal blog to grow a mailing list so I can update readers when I puslish a new blog article. I haven't done too much work with MailChimp before, but I've definitely subscribed to plenty of MailChimp mailing lists."}]},{"type":"element","tag":"h2","props":{"id":"goals"},"children":[{"type":"text","value":"Goals"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm hoping to acheive some of the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Build a list of emails from people who visit my site and want get"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Include a simple newletter signup form (Vue) component in the Footer of my site"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Send customized emails (campaigns) to a mailing list that I can track"}]}]},{"type":"element","tag":"h2","props":{"id":"questions"},"children":[{"type":"text","value":"Questions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the questions (and answers) that I had going into this:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Do I need to use the MailChimp API or MailChimp API keys? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"No"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Is "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Double Opt-In"}]},{"type":"text","value":" possible with a static GitHub pages site hosted on a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<usernme>.github.io"}]},{"type":"text","value":" subdomain? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What is the signup flow? Will a new subscriber be sent to a MailChimp page first, and then back to my site? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How do I setup a \"Thank you\" page to show users after they subscribe?"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How much will this cost? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Free up to 2,000 subscribers"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Should I create a new campaign for each new blog post email update I send out? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll touch on these questions as I describe how to set things up."}]},{"type":"element","tag":"h2","props":{"id":"creating-the-form"},"children":[{"type":"text","value":"Creating the form"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms"}]},{"type":"text","value":" menu, I selected the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Embedded Forms"}]},{"type":"text","value":" option:"}]},{"type":"element","tag":"pre","props":{"code":"Embedded forms\nGenerate HTML code to embed in your site or blog to collect signups.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Embedded forms\nGenerate HTML code to embed in your site or blog to collect signups.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of the MailChimp Admin that I have been using seems to have 4 different menus: 2 vertical menus and 2 horizontal."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Embedded forms"}]},{"type":"text","value":" menu, I selected "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Unstyled"}]},{"type":"text","value":" since I want to add my own Tailwind CSS classes to keep the style of my signup form consistent with the different color schemes available on my site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll start with an Unstyled Embedded form. Let's go through the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form options"}]},{"type":"text","value":":"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Include form title"}]},{"type":"text","value":" (no, I'll add this myself)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Show only required fields"}]},{"type":"text","value":" (For now, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"email"}]},{"type":"text","value":" is the only field I will be capturing. It can be helpful to include a First and/or Last name to avoid having your emails go to users' spam folders.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Unselect everything else"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the HTML that we can use in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscribe.vue"}]},{"type":"text","value":" component:"}]},{"type":"element","tag":"pre","props":{"code":"    <!-- Begin Mailchimp Signup Form -->\n    <div id=\"mc_embed_signup\">\n      <form\n        action=\"https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&amp;id=9937fe4fc5\"\n        method=\"post\"\n        id=\"mc-embedded-subscribe-form\"\n        name=\"mc-embedded-subscribe-form\"\n        class=\"validate\"\n        target=\"_blank\"\n        novalidate\n      >\n        <div id=\"mc_embed_signup_scroll\">\n          <div class=\"mc-field-group\">\n            <!-- <label for=\"mce-EMAIL\">Email Address </label> -->\n            <!-- Added placeholder -->\n            <input\n              type=\"email\"\n              value=\"\"\n              name=\"EMAIL\"\n              class=\"required email\"\n              id=\"mce-EMAIL\"\n              placeholder=\"Enter your email address\"\n            />\n          </div>\n          <div id=\"mce-responses\" class=\"clear\">\n            <div\n              class=\"response\"\n              id=\"mce-error-response\"\n              style=\"display: none\"\n            ></div>\n            <div\n              class=\"response\"\n              id=\"mce-success-response\"\n              style=\"display: none\"\n            ></div>\n          </div>\n          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->\n          <div style=\"position: absolute; left: -5000px\" aria-hidden=\"true\">\n            <input\n              type=\"text\"\n              name=\"b_43a795784ca963e25903a0da6_9937fe4fc5\"\n              tabindex=\"-1\"\n              value=\"\"\n            />\n          </div>\n          <div class=\"clear\">\n            <input\n              type=\"submit\"\n              value=\"Subscribe\"\n              name=\"subscribe\"\n              id=\"mc-embedded-subscribe\"\n              class=\"button\"\n            />\n          </div>\n        </div>\n      </form>\n    </div>\n\n    <!--End mc_embed_signup-->\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    <!-- Begin Mailchimp Signup Form -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc_embed_signup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"&amp;"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"id=9937fe4fc5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"post\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe-form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe-form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"validate\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        target"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"_blank\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        novalidate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      >\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc_embed_signup_scroll\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-field-group\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            <!-- <label for=\"mce-EMAIL\">Email Address </label> -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            <!-- Added placeholder -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"email\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"EMAIL\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"required email\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-EMAIL\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              placeholder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Enter your email address\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-responses\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"clear\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-error-response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"display: none\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ></"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-success-response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"display: none\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ></"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"position: absolute; left: -5000px\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" aria-hidden"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"true\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"text\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"b_43a795784ca963e25903a0da6_9937fe4fc5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              tabindex"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-1\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"clear\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"button\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    <!--End mc_embed_signup-->\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we can create a Vue component that contains the HTML form generated by the MailChimp admin. For now, just put the embed HTML in the template of a Vue component."}]},{"type":"element","tag":"h2","props":{"id":"styling-the-form"},"children":[{"type":"text","value":"Styling the form"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next you can add styles to the form. You can reference the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscribe.vue"}]},{"type":"text","value":" file in the repo for this site to see how I have added styles using TailwindCSS."}]},{"type":"element","tag":"h2","props":{"id":"settings"},"children":[{"type":"text","value":"Settings"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next let's look at some settings around Double Opt-in."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To navigate to the page where these settings can be set, go to:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms > Settings > Audience name and defaults"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form Settings"}]},{"type":"text","value":" of this menu, you can select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Enable double opt-in"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, let's configure the redirect to a custom \"Thank you for subscribing page\" on our static site. Go to"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms > Signup forms"}]},{"type":"text","value":" and select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form builder"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Select "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Signup thank you page"}]},{"type":"text","value":" from the dropdown menu and add a custom URL that you will show users when they first submit their email to the form."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, also on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form Builder"}]},{"type":"text","value":" menu, select "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Confirmation thank you page"}]},{"type":"text","value":" from the dropdown menu and enter the URL of the page that you want to redirect to after a user confirms their subscription where it says: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Instead of showing this thank you page, send subscribers to another URL"}]}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Form validation"}]},{"type":"text","value":": we can validate that the user has entered a valid email address"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GDPR considerations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Captcha"}]}]},{"type":"element","tag":"h2","props":{"id":"resources"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Single vs Double Opt-in"}]},{"type":"text","value":": "},{"type":"element","tag":"a","props":{"href":"https://www.sendinblue.com/blog/double-opt-in/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.sendinblue.com/blog/double-opt-in/"}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"goals","depth":2,"text":"Goals"},{"id":"questions","depth":2,"text":"Questions"},{"id":"creating-the-form","depth":2,"text":"Creating the form"},{"id":"styling-the-form","depth":2,"text":"Styling the form"},{"id":"settings","depth":2,"text":"Settings"},{"id":"next-steps","depth":2,"text":"Next Steps"},{"id":"resources","depth":2,"text":"Resources"}]}},"_type":"markdown","_id":"content:2020:10:10:how-to-add-email-signup-form-to-nuxt-site-with-mailchimp.md","_source":"content","_file":"2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp.md","_stem":"2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp","_extension":"md"},{"_path":"/2020/09/17/migrating-from-jekyll-to-nuxt-static-site","_dir":"17","_draft":false,"_partial":false,"_locale":"","title":"Migrating my personal GitHub pages blog from Jekyll to Nuxt","description":"Jekyll has served me well for a long time, but I've decided to switch the static site generator I use for my personal blog from Jekyll to Nuxt. This article will hopefully be the first new article in my Nuxt blog.","layout":"post","date":"2020-09-17T00:00:00.000Z","comments":true,"image":"/static/nuxt-app.png","tags":["nuxt","vue","content","static-site","web"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Jekyll has served me well for a long time, but I've decided to switch the static site generator I use for my personal blog from Jekyll to Nuxt. This article will hopefully be the first new article in my Nuxt blog."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some goals for what I want to do with this new site:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Learn more about Nuxt and Nuxt Content, JAM Stack and static site generation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Master TailwindCSS for building responsive layouts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Better understand and measure SEO for my site and the content I publish on it"}]}]},{"type":"element","tag":"h2","props":{"id":"creating-a-nuxt-project"},"children":[{"type":"text","value":"Creating a nuxt project"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm going to start off with a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-nuxt"}]},{"type":"text","value":" feature branch. Since I can't create the nuxt project in a non-empty directory, I'll create a new nuxt project in a folder called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"brian@x1:~/github/briancaffey.github.io/nuxt$ npx create-nuxt-app .\n\ncreate-nuxt-app v3.2.0\n  Generating Nuxt.js project in .\n(node:8073) ExperimentalWarning: Conditional exports is an experimental feature. This feature could change at any time\n? Project name: brian-caffey\n? Programming language: JavaScript\n? Package manager: Yarn\n? UI framework: Tailwind CSS\n? Nuxt.js modules: Axios, Content\n? Linting tools: ESLint, Prettier\n? Testing framework: None\n? Rendering mode: Universal (SSR / SSG)\n? Deployment target: Static (Static/JAMStack hosting)\n? Development tools: jsconfig.json (Recommended for VS Code if you're not using typescript)\nyarn run v1.22.5\n$ eslint --ext .js,.vue --ignore-path .gitignore . --fix\nDone in 1.57s.\n\n  Successfully created project brian-caffey\n\n  To get started:\n\n        yarn dev\n\n  To build & start for production:\n\n        yarn build\n        yarn start\n","language":"txt","meta":"","className":"language-txt shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"brian@x1:~/github/briancaffey.github.io/nuxt$ npx create-nuxt-app .\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"create-nuxt-app v3.2.0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  Generating Nuxt.js project in .\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"(node:8073) ExperimentalWarning: Conditional exports is an experimental feature. This feature could change at any time\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Project name: brian-caffey\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Programming language: JavaScript\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Package manager: Yarn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? UI framework: Tailwind CSS\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Nuxt.js modules: Axios, Content\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Linting tools: ESLint, Prettier\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Testing framework: None\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Rendering mode: Universal (SSR / SSG)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Deployment target: Static (Static/JAMStack hosting)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Development tools: jsconfig.json (Recommended for VS Code if you're not using typescript)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"yarn run v1.22.5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"$ eslint --ext .js,.vue --ignore-path .gitignore . --fix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"Done in 1.57s.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  Successfully created project brian-caffey\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  To get started:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn dev\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  To build & start for production:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn start\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Running the following:"}]},{"type":"element","tag":"pre","props":{"code":"yarn generate\nyarn start\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"yarn generate\nyarn start\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Starts my project on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localhost:3000"}]},{"type":"text","value":":"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Nuxt app","src":"/static/nuxt-app.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"tricky-parts"},"children":[{"type":"text","value":"Tricky parts"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the parts of migrating that I need to think about:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Disqus comments"}]},{"type":"text","value":": I previously based the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"disqus_identifier"}]},{"type":"text","value":" used to link Disqus threads to specific pages on Jekyll's page URLs (of the form "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/YYYY/MM/DD/name-of-article.html"}]},{"type":"text","value":"). I could transform the slug value with a hook in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":", or manually add a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"disqus_identifier"}]},{"type":"text","value":" value to the frontmatter of markdown files."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Static Content"}]},{"type":"text","value":": In Jekyll I had static content in a few different places. With Nuxt, all static content will live under the top level folder "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":" that is mapped to the root URL where my site is hosted. Since I had lots of content under "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":" in my Jekyll site, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static/my-image.png"}]},{"type":"text","value":", I ended up putting conent in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static/static"}]},{"type":"text","value":", hopefully this won't be too confusing."}]}]},{"type":"element","tag":"h2","props":{"id":"nuxt-community"},"children":[{"type":"text","value":"Nuxt Community"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a lot of great packages from the "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt-community"}]}]},{"type":"text","value":" GitHub organization that are widely used in many Nuxt projects. Here are a few of the Nuxt community plugins and other Nuxt extensions that I have used so far:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://content.nuxtjs.org/","rel":["nofollow"]},"children":[{"type":"text","value":"nuxt/content"}]},{"type":"text","value":": an official Nuxt project that provides a Git-based Headless CMS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/tailwindcss"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/color-mode"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/google-analytics"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/sitemap"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/feed"}]}]}]},{"type":"element","tag":"h2","props":{"id":"issues"},"children":[{"type":"text","value":"Issues"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Tailwind removes markdown styles in blog articles from nuxt/content (solved by adding some extra css with "},{"type":"element","tag":"a","props":{"href":"https://github.com/iandinwoodie/github-markdown-tailwindcss/blob/master/markdown.css","rel":["nofollow"]},"children":[{"type":"text","value":"this"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"No support for automatically adding markdown anchors (GitHub Flavored Markdown supports this)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Not able to do true server-side redirects, but you can do something like this: "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community/redirect-module/issues/1#issuecomment-615070920","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/nuxt-community/redirect-module/issues/1#issuecomment-615070920"}]}]}]},{"type":"element","tag":"h2","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add tags, categories, search to blog"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"creating-a-nuxt-project","depth":2,"text":"Creating a nuxt project"},{"id":"tricky-parts","depth":2,"text":"Tricky parts"},{"id":"nuxt-community","depth":2,"text":"Nuxt Community"},{"id":"issues","depth":2,"text":"Issues"},{"id":"todo","depth":2,"text":"TODO"}]}},"_type":"markdown","_id":"content:2020:09:17:migrating-from-jekyll-to-nuxt-static-site.md","_source":"content","_file":"2020/09/17/migrating-from-jekyll-to-nuxt-static-site.md","_stem":"2020/09/17/migrating-from-jekyll-to-nuxt-static-site","_extension":"md"},{"_path":"/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","_dir":"09","_draft":false,"_partial":false,"_locale":"","title":"Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray","description":"A guide to deploying Django applications with docker using popular open-source tools","layout":"post","date":"2020-08-09T00:00:00.000Z","comments":true,"image":"/static/shark.jpg","tags":["django","docker","digital-ocean","vue","gitlab","rex-ray","traefik","nginx","swarm"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently wrote two articles about deploying Django applications to AWS serverless environments: one on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Fargate"}]},{"type":"text","value":" (CloudFront, ALB and ECS Fargate containers) and one on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Lambda"}]},{"type":"text","value":" (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of "},{"type":"element","tag":"a","props":{"href":"https://aws.amazon.com/cdk/","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK)"}]},{"type":"text","value":", an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to \"just use a VPS\" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets)."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a link to my project that I'll be referencing: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article."}]},{"type":"element","tag":"h2","props":{"id":"overview"},"children":[{"type":"text","value":"Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the key parts of the project that I'll go over:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DigitalOcean and GitLab setup"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Creating an A Record that points to our Droplet IP"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using a prebuilt VM image that ships with docker and docker-compose"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a docker swarm cluster"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" file to build images and push them to a private GitLab CI project registry"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Writing a docker-compose file to configure the services (containers) that will support the application"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django project settings and management commands for our Postgres database and static files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Monitoring, logging and debugging"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Destroying the environment + cleanup"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before I dig into all of this, I recommend that you check out "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev/django-prod-architectures.html","rel":["nofollow"]},"children":[{"type":"text","value":"this article about Django production architectures by Matt Segal"}]},{"type":"text","value":". This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev","rel":["nofollow"]},"children":[{"type":"text","value":"mattsegal.dev"}]},{"type":"text","value":" has lots of good content related to Django, I also recommend checking out "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev/nginx-django-reverse-proxy-config.html","rel":["nofollow"]},"children":[{"type":"text","value":"this article about how NGINX is used with Django"}]},{"type":"text","value":". Thanks for the great resources, Matt!"}]},{"type":"element","tag":"h2","props":{"id":"digitalocean-setup"},"children":[{"type":"text","value":"DigitalOcean setup"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sign up for a new DigitalOcean account if you don't already have one"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a DigitalOcean project "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/projects/new","rel":["nofollow"]},"children":[{"type":"text","value":"https://cloud.digitalocean.com/projects/new"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/account/api/tokens","rel":["nofollow"]},"children":[{"type":"text","value":"https://cloud.digitalocean.com/account/api/tokens"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/","rel":["nofollow"]},"children":[{"type":"text","value":"this article"}]},{"type":"text","value":" for more information)"}]}]},{"type":"element","tag":"h2","props":{"id":"prebuilt-docker-vm-image"},"children":[{"type":"text","value":"Prebuilt Docker VM image"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"From the "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/droplets/new","rel":["nofollow"]},"children":[{"type":"text","value":"Create Droplets"}]},{"type":"text","value":" page, select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Marketplace"}]},{"type":"text","value":" and search for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":". Select the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Docker 5:19.03.1~3 18.04"}]},{"type":"text","value":" image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For Authentication, select the SSH key that you created earlier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Take note of the Droplet's IP address; we will use this in the next step."}]},{"type":"element","tag":"h2","props":{"id":"gitlab-setup"},"children":[{"type":"text","value":"GitLab setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Settings > CI/CD > Variables"}]},{"type":"text","value":" in your GitLab project and add the following environment variables:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SSH_PRIVATE_KEY"}]},{"type":"text","value":": the value should start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-----BEGIN RSA PRIVATE KEY-----"}]},{"type":"text","value":" and end with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-----END RSA PRIVATE KEY-----"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DROPLET_IP"}]},{"type":"text","value":": the IP address of the droplet you just created"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POSTGRES_PASSWORD"}]},{"type":"text","value":": a secure password that we will use for our Postgres database (we will share this with our Django application later on)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SECRET_KEY"}]},{"type":"text","value":": a random secret key to use for our Django application."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DEBUG"}]},{"type":"text","value":": the number "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"0"}]}]}]},{"type":"element","tag":"h2","props":{"id":"a-record"},"children":[{"type":"text","value":"A Record"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".tk"}]},{"type":"text","value":" domain from "},{"type":"element","tag":"a","props":{"href":"https://www.freenom.com/en/freeandpaiddomains.html","rel":["nofollow"]},"children":[{"type":"text","value":"freenom"}]},{"type":"text","value":". I have used this before and it is a great option for testing things out."}]},{"type":"element","tag":"h2","props":{"id":"ssh-into-your-digitalocean-droplet"},"children":[{"type":"text","value":"SSH into your DigitalOcean Droplet"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can do this with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1_rsa"}]},{"type":"text","value":" is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly."}]},{"type":"element","tag":"h2","props":{"id":"add-the-rex-ray-docker-plugin"},"children":[{"type":"text","value":"Add the REX-Ray docker plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This step is very simple, you can follow along with this short guide: "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is basically one command to run:"}]},{"type":"element","tag":"pre","props":{"code":"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You will need to make sure that you replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"YOUR_DIGITALOCEAN_TOKEN"}]},{"type":"text","value":" with the personal access token you added earlier. Also, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOBS_REGION"}]},{"type":"text","value":" should be the region you selected for your Droplet earlier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check that the plugin was installed correctly with:"}]},{"type":"element","tag":"pre","props":{"code":"docker plugin ls\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker plugin ls\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick intro to REX-Ray from "},{"type":"element","tag":"a","props":{"href":"https://rexray.readthedocs.io/en/stable/","rel":["nofollow"]},"children":[{"type":"text","value":"rexray.readthedocs.io"}]},{"type":"text","value":":"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article."}]},{"type":"element","tag":"h2","props":{"id":"gitlab-ciyml"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over "},{"type":"element","tag":"a","props":{"href":"https://docs.gitlab.com/ee/ci/yaml/","rel":["nofollow"]},"children":[{"type":"text","value":"this page from the GitLab documentation"}]},{"type":"text","value":" which goes over all of the configuration options with many examples. Also, "},{"type":"element","tag":"a","props":{"href":"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html","rel":["nofollow"]},"children":[{"type":"text","value":"this documentation page"}]},{"type":"text","value":" covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CI/CD pipelines that I define with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" typically contain three stages: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"test"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":". We will focus on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-backend"}]},{"type":"text","value":" is the name of a GitLab CI job that builds and tags a docker image from the source code in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the YAML code for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-backend"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"build-backend:\n  stage: build\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  before_script:\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - |\n      docker build \\\n        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n        -f backend/docker/Dockerfile.prod \\\n        ./backend/\n    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"build-backend"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      docker build \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        -f backend/docker/Dockerfile.prod \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        ./backend/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-nginx"}]},{"type":"text","value":" is almost identical, but the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" arguments are slightly different. There are three arguments for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command that I'm using here:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":": the tag to tag the built image with"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":": the Dockerfile to be used for building the image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"context"}]},{"type":"text","value":" that is sent to the docker daemon when we build the image"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" makes use of two predefined GitLab CI variables: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_REGISTRY_IMAGE"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_COMMIT_SHORT_SHA"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$CI_REGISTRY_IMAGE"}]},{"type":"text","value":" is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"registry.gitlab.com/<gitlab_username>/<project_name>"}]},{"type":"text","value":", and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_COMMIT_SHORT_SHA"}]},{"type":"text","value":" is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tag"}]},{"type":"text","value":", even though we pass in more than just this value. We combine these two values with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":" and the name of the image we are building, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", so the full value being passed to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" is:"}]},{"type":"element","tag":"pre","props":{"code":"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":" is the path to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Dockerfile"}]},{"type":"text","value":" we are using relative to the directory where we are running the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command, which is the root directory of the project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":", we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ADD"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" -- we will get to these soon). There's a key difference between the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" commands: the context for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", but the context for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command to hang. The first line of output from a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command should be something like this:"}]},{"type":"element","tag":"pre","props":{"code":"Sending build context to Docker daemon  24.58kB\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Sending build context to Docker daemon  24.58kB\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If this number is too high, you should use a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".dockerignore"}]},{"type":"text","value":" file that ignores any files or directories you don't want to send to the docker daemon (similar to how "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":" works with git)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker login"}]},{"type":"text","value":" command in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":" as well two other predefined GitLab CI variables: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_JOB_TOKEN"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_REGISTRY"}]},{"type":"text","value":". This all happens using a special service called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-in-docker"}]},{"type":"text","value":" which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" -- and can define additional containers -- the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"services"}]},{"type":"text","value":" key -- to help with the CI job). Once the two images for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" have been built and pushed, our GitLab CI pipeline moves on to the next stage: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":". In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"initialize a single-node docker swarm cluster on our Droplet and"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"create a docker network that our cluster's services (containers) will use"}]}]},{"type":"element","tag":"h2","props":{"id":"setup-a-docker-swarm-cluster"},"children":[{"type":"text","value":"Setup a docker swarm cluster"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91"}]},{"type":"text","value":" where "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1_rsa"}]},{"type":"text","value":" is the name of the private key file -- you can ignore the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-i ~/.ssh/a1_rsa"}]},{"type":"text","value":" part if you are using an SSH key called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"id_rsa"}]},{"type":"text","value":"), and run the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker swarm init --advertise-addr DROPLET_IP\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker swarm init --advertise-addr DROPLET_IP\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DROPLET_IP"}]},{"type":"text","value":" with your Droplet's IP address (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"123.45.578.91"}]},{"type":"text","value":"). Check out "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04","rel":["nofollow"]},"children":[{"type":"text","value":"this article"}]},{"type":"text","value":" for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Docker swarm uses docker-compose files, but using docker swarm is very different from running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":", a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" (the command) in production. Many people do this, and several official tutorials will often end with \"now just run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":" and you are done\". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":". It is pretty easy and it works very similarly in both local and production environments, but this guide will be using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use."}]},{"type":"element","tag":"h2","props":{"id":"defining-an-overlay-network"},"children":[{"type":"text","value":"Defining an overlay network"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"SSH into your droplet and run the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker network create --driver=overlay traefik-public\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker network create --driver=overlay traefik-public\n"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's go over one more docker concept that will helpful in the next few steps. When you run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" on your local machine, the docker CLI first looks to see if the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable is set. If it is not, then docker defaults to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"unix:///var/run/docker.sock"}]},{"type":"text","value":", a UNIX socket. Check out "},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock","rel":["nofollow"]},"children":[{"type":"text","value":"this SO post"}]},{"type":"text","value":" titled \"Can anyone explain docker.sock?\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:"}]},{"type":"element","tag":"pre","props":{"code":"DOCKER_HOST=ssh://root@$DOCKER_IP\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"DOCKER_HOST=ssh://root@$DOCKER_IP\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See this article for a more in-depth discussion: "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can try this out locally. Run a container locally, check it with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":", then export the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"export DOCKER_HOST=ssh://root@123.45.678.91\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"export DOCKER_HOST=ssh://root@123.45.678.91\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Replacing "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"123.45.678.91"}]},{"type":"text","value":" with your Droplet IP. Run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:"}]},{"type":"element","tag":"pre","props":{"code":"unset DOCKER_HOST\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"unset DOCKER_HOST\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" again you should see the containers on your machine. We will be using this idea in the next step when we look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack deploy"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"h2","props":{"id":"docker-stack-deploy"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack deploy"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have done our one-time-setup steps, let's look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stage of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":", the GitLab CI job that will get our containers running on our Droplet. First, let's break down the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"text","value":" command:"}]},{"type":"element","tag":"pre","props":{"code":"deploy-digital-ocean:\n  stage: deploy\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  variables:\n    DOCKER_HOST: 'ssh://root@$DROPLET_IP'\n  before_script:\n    - apk update && apk add openssh-client bash\n    - mkdir -p ~/.ssh\n    - echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n    - chmod 600 ~/.ssh/id_rsa\n    - eval \"$(ssh-agent -s)\"\n    - ssh-add ~/.ssh/id_rsa\n    - ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - docker stack deploy -c stack.yml my-stack --with-registry-auth\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  variables"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    DOCKER_HOST"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ssh://root@$DROPLET_IP'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk update && apk add openssh-client bash\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mkdir -p ~/.ssh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"chmod 600 ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"eval \"$(ssh-agent -s)\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ssh-add ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This job uses the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"services"}]},{"type":"text","value":" that our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" stage jobs used. Notice that we set "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"ssh://root@$DROPLET_IP\""}]},{"type":"text","value":", this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":" has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker:19.03.1"}]},{"type":"text","value":" is based on Alpine Linus. This version of Linux is super light weight and doesn't come with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"openssh-client"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bash"}]},{"type":"text","value":", so our first step is to install these with the Alpine package manager, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apk"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"apk update && apk add openssh-client bash\n","language":"sh","meta":"","className":"language-sh shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"apk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" update"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" && "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"apk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" add"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" openssh-client"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" bash\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SSH_PRIVATE_KEY"}]},{"type":"text","value":" environment variable into the body of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"id_rsa"}]},{"type":"text","value":" private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"man ssh-agent"}]},{"type":"text","value":" that provides a little bit more context into why we need to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"eval \"$(ssh-agent -s)\""}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh-add ~/.ssh/id_rsa"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts"}]},{"type":"text","value":" tells our SSH agent about our Droplet so that it doesn't prompt us with a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Do you want to add this server to known hosts? (yes/no)"}]},{"type":"text","value":", or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:"}]},{"type":"element","tag":"pre","props":{"code":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This essentially gives our DigitalOcean Droplet access to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The last command in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"text","value":" job is:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check out this link from the docker docs on docker stacks "},{"type":"element","tag":"a","props":{"href":"https://docs.docker.com/engine/swarm/stack-deploy/","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.docker.com/engine/swarm/stack-deploy/"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--with-registry-auth"}]},{"type":"text","value":" is important, our command will complete if this is not included, but our application won't start."}]},{"type":"element","tag":"h2","props":{"id":"stackyml"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we are ready to tackle the last big file in our repo: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":". This is a the docker-compose file that we use to deploy our project. The only reason we needed to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker login"}]},{"type":"text","value":" above is because "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" service:"}]},{"type":"element","tag":"h3","props":{"id":"backend"},"children":[{"type":"text","value":"backend"}]},{"type":"element","tag":"pre","props":{"code":"version: '3.4'\nservices:\n  backend:\n  image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n  networks:\n    - main\n  environment:\n    - POSTGRES_PASSWORD\n    - SECRET_KEY\n    - DEBUG\n  volumes:\n    - backendassets:/code/assets\n  depends_on:\n    - postgres\n    - redis\n    - web\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'3.4'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  backend"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"main\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"POSTGRES_PASSWORD\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"SECRET_KEY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"DEBUG\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"backendassets:/code/assets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  depends_on"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"postgres\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"web\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" is essentially what we defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":", but the syntax is slightly different:"}]},{"type":"element","tag":"pre","props":{"code":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We pass environment variables that we defined in GitLab CI via the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment"}]},{"type":"text","value":" key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The volume "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/code/assets"}]},{"type":"text","value":" and then define our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"STATIC_ROOT"}]},{"type":"text","value":" in Django's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":" to be:"}]},{"type":"element","tag":"pre","props":{"code":"os.path.join(BASE_DIR, \"assets\", \"static\")\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.path.join("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"BASE_DIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"assets\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"static\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Later, when we run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":", files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"network"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"depends_on"}]},{"type":"text","value":" related to to the other services that this application will communicate with. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" is a network defined in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"networks"}]},{"type":"text","value":" part of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":", notice that we reference the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik-public"}]},{"type":"text","value":" network here that we created earlier, as well."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Depends on helps with service startup order, but it is a better practice to use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./wait-for-it.sh"}]},{"type":"text","value":". However, I have never had any issues related to startup order. I'll try adding this later to make things more robust."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":" will start before "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":". Our Django application will communicate to these services by their hostnames: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":". The fact that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":" are all on the same network ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":") means that they can resolve each other by these names. For example, the connection string to redis will look like: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis://redis:6379"}]},{"type":"text","value":". Let's look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DATABASES"}]},{"type":"text","value":" configuration in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":" to see how we connect to Postgres:"}]},{"type":"element","tag":"pre","props":{"code":"DATABASES = {\n    \"default\": {\n        \"ENGINE\": \"django.db.backends.postgresql_psycopg2\",\n        \"NAME\": os.environ.get(\"POSTGRES_NAME\", \"postgres\"),\n        \"USER\": os.environ.get(\"POSTGRES_USERNAME\", \"postgres\"),\n        \"PASSWORD\": os.environ.get(\"POSTGRES_PASSWORD\", \"postgres\"),\n        \"HOST\": os.environ.get(\"POSTGRES_SERVICE_HOST\", \"postgres\"),\n        \"PORT\": os.environ.get(\"POSTGRES_SERVICE_PORT\", 5432),\n    }\n}\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DATABASES"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"default\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"ENGINE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"django.db.backends.postgresql_psycopg2\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"USER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_SERVICE_HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"PORT\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_SERVICE_PORT\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have defined the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOST"}]},{"type":"text","value":" to be based on the environment variable "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POSTGRES_HOST"}]},{"type":"text","value":", but I have not defined this environment variable, so why didn't I just say "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"HOST\": \"postgres\""}]},{"type":"text","value":"? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself."}]},{"type":"element","tag":"h3","props":{"id":"nginx"},"children":[{"type":"text","value":"NGINX"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next service we should go over is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":", the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Reverse proxy"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serve static files for Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serve a frontend Javascript application"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the definition of this service in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"services:\n  web:\n    image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n    networks:\n      - traefik-public\n      - main\n    volumes:\n      - backendassets:/usr/src/app/assets\n    deploy:\n      labels:\n        - 'traefik.enable=true'\n        - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n        - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n        - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n        - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  web"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik-public\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"main\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"backendassets:/usr/src/app/assets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      labels"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.enable=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.entrypoints=websecure'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For now, ignore the contents under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" key; we will cover this next when we go over the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NGINX acts as a reverse proxy when it sends request starting with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" container. Two blocks in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":" enable this behavior:"}]},{"type":"element","tag":"pre","props":{"code":"  upstream backend {\n    server backend:8000;\n  }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"  upstream backend {\n    server backend:8000;\n  }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This hostname "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is defined as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":" can be resolved by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service because it is on the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" network that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is on. If either of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" wasn't on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" network, NGINX would not be able to make sense of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This block does that actual request forwarding. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend"}]},{"type":"text","value":" references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"upstream backend {}"}]},{"type":"text","value":" block defined above."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The volume "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is referenced here and mounts to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets"}]},{"type":"text","value":". This path is then referenced in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":", the NGINX configuration file that is used in our custom NGINX-based image:"}]},{"type":"element","tag":"pre","props":{"code":"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this block of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":", we tell NGINX to serve files from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets/static"}]},{"type":"text","value":" for requests that start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":". A request made to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/static/base.css"}]},{"type":"text","value":" would return a file located at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets/static"}]},{"type":"text","value":" if that file existed. Remember, when we run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collecstatic"}]},{"type":"text","value":" management command in our Django container, it will collect our static files to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":". Since "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is mounted to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets"}]},{"type":"text","value":", NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" container:"}]},{"type":"element","tag":"pre","props":{"code":"# # build stage\n# FROM node:10-alpine as build-stage\n# WORKDIR /app/\n# COPY frontend/package.json /app/\n# RUN npm cache verify\n# RUN npm install\n# COPY frontend /app/\n# RUN npm run build\n\n# production stage\n# FROM nginx:1.19.1-alpine as production-stage\nFROM nginx:1.19.1-alpine\nCOPY nginx/prod/prod.conf /etc/nginx/nginx.conf\nCOPY nginx/prod/index.html /dist/\n# COPY --from=build-stage /app/dist /dist/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n","language":"Dockerfile","meta":"","className":"language-Dockerfile shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# # build stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# FROM node:10-alpine as build-stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# WORKDIR /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY frontend/package.json /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm cache verify\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm install\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY frontend /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm run build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# production stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# FROM nginx:1.19.1-alpine as production-stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"FROM nginx:1.19.1-alpine\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY nginx/prod/prod.conf /etc/nginx/nginx.conf\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY nginx/prod/index.html /dist/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY --from=build-stage /app/dist /dist/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"EXPOSE 80\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"CMD [\"nginx\", \"-g\", \"daemon off;\"]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:"}]},{"type":"element","tag":"pre","props":{"code":"COPY --from=build-stage /app/dist /dist/\n","language":"Dockerfile","meta":"","className":"language-Dockerfile shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY --from=build-stage /app/dist /dist/\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This would copy the build files for our Javascript application into the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/dist/"}]},{"type":"text","value":" folder of our NGINX container. Another few declarations and blocks in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":" allow all other requests to be served by the contents of this folder:"}]},{"type":"element","tag":"pre","props":{"code":"    root /dist/;\n    index index.html;\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    root /dist/;\n    index index.html;\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This sets the root and the index document for our NGINX webserver."}]},{"type":"element","tag":"pre","props":{"code":"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These two blocks route all other requests to the frontend Javascript app's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" file location in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/dist/"}]},{"type":"text","value":" (any request that doesn't start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":"). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lastly, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deployment"}]},{"type":"text","value":" key has some "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"labels"}]},{"type":"text","value":" defined for Traefik. Let's come back to these after having a look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service."}]},{"type":"element","tag":"h3","props":{"id":"traefik"},"children":[{"type":"text","value":"Traefik"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"https://docs.traefik.io/assets/img/traefik-architecture.png"},"children":[]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- "},{"type":"element","tag":"a","props":{"href":"https://docs.traefik.io/","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.traefik.io/"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Traefik has three main functions in my application:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Do TLS termination"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Route all requests to NGINX"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed \"fun and easy\", especially when it comes to requesting certificates."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two main ways to set up Traefik:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"write a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik.toml"}]},{"type":"text","value":" file and build this into your own custom image (similar to what we do with NGINX and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"use a base image and specify all configure options through command line arguments."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" (for now all the values I'm using in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service are hard-coded, this is one more item for my ToDo list on this project)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":". There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled "},{"type":"element","tag":"a","props":{"href":"https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/","rel":["nofollow"]},"children":[{"type":"text","value":"How to install Traefik 2.x on a Docker Swarm"}]},{"type":"text","value":" helped me a lot in figuring out how to get everything working. Thank you for the great article, "},{"type":"element","tag":"a","props":{"href":"https://github.com/creekorful","rel":["nofollow"]},"children":[{"type":"text","value":"Alos"}]},{"type":"text","value":"!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code that sets up the traefik service:"}]},{"type":"element","tag":"pre","props":{"code":"services:\n  traefik:\n    image: traefik:v2.0.2\n    ports:\n      - '80:80'\n      - '443:443'\n    command:\n      - '--providers.docker.endpoint=unix:///var/run/docker.sock'\n      - '--providers.docker.swarmMode=true'\n      - '--providers.docker.exposedbydefault=false'\n      - '--providers.docker.network=traefik-public'\n      - '--entrypoints.web.address=:80'\n      - '--entrypoints.websecure.address=:443'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n      - '--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n      - '--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n    volumes:\n      - letsencrypt:/letsencrypt\n      - /var/run/docker.sock:/var/run/docker.sock\n    networks:\n      - traefik-public\n    deploy:\n      placement:\n        constraints:\n          - node.role == manager\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  traefik"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik:v2.0.2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    ports"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'80:80'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'443:443'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    command"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.endpoint=unix:///var/run/docker.sock'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.swarmMode=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.exposedbydefault=false'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.network=traefik-public'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--entrypoints.web.address=:80'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--entrypoints.websecure.address=:443'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"letsencrypt:/letsencrypt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/var/run/docker.sock:/var/run/docker.sock\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik-public\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      placement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        constraints"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"node.role == manager\n"}]}]}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"websecure"}]},{"type":"text","value":" refer to values declared on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service. Let's take a look at those values:"}]},{"type":"element","tag":"pre","props":{"code":"deploy:\n  labels:\n    - 'traefik.enable=true'\n    - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n    - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n    - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n    - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  labels"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.enable=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.entrypoints=websecure'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I still need to setup HTTP -> HTTPS redirecting, so for now only "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"websecure"}]},{"type":"text","value":" is defined, but Alos explains this clearly in his article."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That wraps up our overview of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":", we left off with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable that I showed you earlier and run these commands from your local terminal:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack ps my-stack --no-trunc\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack ps my-stack --no-trunc\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--no-trunc"}]},{"type":"text","value":" is important because important error messages tend to be cut off. This option will show the full version of each column returned by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack ps"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"docker service ls\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker service ls\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This command shows some the active services on our Droplet."}]},{"type":"element","tag":"pre","props":{"code":"docker ps\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker ps\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This command is useful for shelling into a container to run commands and poke around for debugging."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can get the Container ID of a running container and access it with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker exec -it 0da8370ab283 bash\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker exec -it 0da8370ab283 bash\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This assumes that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bash"}]},{"type":"text","value":" is installed on the container with ID "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"0da8370ab283"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"management-commands"},"children":[{"type":"text","value":"Management commands"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once the site is deployed we stil need to run a few commands to set up our Djnago application:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"collectstatic"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"migrate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"createsuperuser"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other ToDo is to figure out how to run these commands through manual GitLab CI jobs."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some ideas about the next steps I could take on this project."}]},{"type":"element","tag":"h3","props":{"id":"local-environment"},"children":[{"type":"text","value":"Local environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings."}]},{"type":"element","tag":"h3","props":{"id":"infrastructure-as-code-setup"},"children":[{"type":"text","value":"Infrastructure as Code setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK."}]},{"type":"element","tag":"h3","props":{"id":"scaling-out-docker-swarm-services-across-multiple-machines"},"children":[{"type":"text","value":"Scaling out docker swarm services across multiple machines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads."}]},{"type":"element","tag":"h3","props":{"id":"kubernetes-on-digitalocean"},"children":[{"type":"text","value":"Kubernetes on DigitalOcean"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP."}]},{"type":"element","tag":"h3","props":{"id":"deploying-locally-without-using-gitlab-ci"},"children":[{"type":"text","value":"Deploying locally, without using GitLab CI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"overview","depth":2,"text":"Overview"},{"id":"digitalocean-setup","depth":2,"text":"DigitalOcean setup"},{"id":"prebuilt-docker-vm-image","depth":2,"text":"Prebuilt Docker VM image"},{"id":"gitlab-setup","depth":2,"text":"GitLab setup"},{"id":"a-record","depth":2,"text":"A Record"},{"id":"ssh-into-your-digitalocean-droplet","depth":2,"text":"SSH into your DigitalOcean Droplet"},{"id":"add-the-rex-ray-docker-plugin","depth":2,"text":"Add the REX-Ray docker plugin"},{"id":"gitlab-ciyml","depth":2,"text":".gitlab-ci.yml"},{"id":"setup-a-docker-swarm-cluster","depth":2,"text":"Setup a docker swarm cluster"},{"id":"defining-an-overlay-network","depth":2,"text":"Defining an overlay network"},{"id":"docker-stack-deploy","depth":2,"text":"docker stack deploy"},{"id":"stackyml","depth":2,"text":"stack.yml","children":[{"id":"backend","depth":3,"text":"backend"},{"id":"nginx","depth":3,"text":"NGINX"},{"id":"traefik","depth":3,"text":"Traefik"}]},{"id":"management-commands","depth":2,"text":"Management commands"},{"id":"next-steps","depth":2,"text":"Next steps","children":[{"id":"local-environment","depth":3,"text":"Local environment"},{"id":"infrastructure-as-code-setup","depth":3,"text":"Infrastructure as Code setup"},{"id":"scaling-out-docker-swarm-services-across-multiple-machines","depth":3,"text":"Scaling out docker swarm services across multiple machines"},{"id":"kubernetes-on-digitalocean","depth":3,"text":"Kubernetes on DigitalOcean"},{"id":"deploying-locally-without-using-gitlab-ci","depth":3,"text":"Deploying locally, without using GitLab CI"}]}]}},"_type":"markdown","_id":"content:2020:08:09:digital-ocean-docker-swarm-django-traefik-nginx.md","_source":"content","_file":"2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.md","_stem":"2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","_extension":"md"},{"_path":"/2020/08/01/django-and-lambda-with-cdk-and-api-gateway","_dir":"01","_draft":false,"_partial":false,"_locale":"","title":"Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern","description":"","layout":"post","date":"2020-08-01T00:00:00.000Z","comments":true,"image":"/static/djambda.png","tags":["serverless","django","aws","lambda","cdk"],"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One way to deploy Django apps to AWS on a budget is to use the Lambda proxy pattern. The main idea is this: web requests are made to API Gateway that calls a Lambda outside of our VPC (proxy Lambda), which then invokes a second lambda (Django Lambda) inside of our VPC so that it can access VPC resources, namely RDS. The handler for the Django Lambda translates the API Gateway event into a WSGI-compatible request, processes the request and returns the response to the user back through the proxy Lambda. The big caveat is that you can't easily access the internet in Django's request/response cycle without network address translation (NAT) services which add additional costs. One other caveat is that there is high latency associated with the initial request. There are three cold starts to wait for: the cold start for the proxy Lambda, the cold start for the Django Lambda and the cold start for the Aurora Postgres Serverless database. Here's an architecture diagram:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/djambda.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Route53 and CloudFront (1 and 2), discuessed later on, are optional. Starting with 5, API Gateway requests are passed to a proxy lambda (6) which calls a Lambda in a VPC that contains our Django code and special Django handler (7). This function can access RDS (8) and S3 (4) via a VPC Gateway Endpoint (9), but it cannot access the internet."}]},{"type":"element","tag":"h2","props":{"id":"why"},"children":[{"type":"text","value":"Why?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a few different reasons for why I put this project together. Before I get into these reasons, here is a little bit of background on how I typically deploy web apps and the motivations for this project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Django is my web framework of choice, and I'm most comfortable working with Django in docker containers. I previously wrote an article about "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html","rel":["nofollow"]},"children":[{"type":"text","value":"deploying Django applications with AWS Fargate"}]},{"type":"text","value":". This approach technically is \"serverless\", but it requires the use of \"always on\" services: an Application Load Balancer, NAT Gateways and long-running Fargate tasks to run gunicorn processes for our Django application. Even if you choose to run workloads in public subnets and don't use NAT Gateways or NAT instances, the costs are prohbitively high for many types of Django projects: personal projects, proof-of-concept projects, internal projects, toy projects, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The other serverless compute platform on AWS is Lambda. There is a popular framework for deploying serverless Django applications on Lambda called Zappa. I have been meaning to try out Zappa for a while now, and I still haven't used it, but it provided a good reference for how to do \"serverless Django\". I'll come back to Zappa in more detail later, but the main reason I didn't want to use it for my serverless Django project is because I already have a great deployment and Infrastructure as Code tool: CDK."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK, or Cloud Development Kit, is a tool that allows you define and deploy AWS infrastructure using any popular programming language, Python in my case. It uses CloudFormation in the background, and it has great support for lots of AWS services. If you are looking for an introuction to CDK, check out "},{"type":"element","tag":"a","props":{"href":"https://cdkworkshop.com/","rel":["nofollow"]},"children":[{"type":"text","value":"https://cdkworkshop.com/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Zappa makes it really easy to deploy serveless Django applications with Django, but it requires that you "},{"type":"element","tag":"a","props":{"href":"https://github.com/Miserlou/Zappa#running-tasks-in-a-vpc","rel":["nofollow"]},"children":[{"type":"text","value":"setup NAT and other VPC resources before using it with RDS"}]},{"type":"text","value":". Since CDK is really good at setting up these kinds of resources, as well as the resources that Zappa creates (including Lambda functions and API Gateway), I wanted to know how far I could get in setting up a servless Django application only using CDK. I also didn't want everything abstracted away by a high level framework; I'm interested in a lower level view to get more familiar with how serverless technologies work. It's important to note that the biggest motivation of all is to learn try something out of my comfort zone, make mistakes and get feedback."}]},{"type":"element","tag":"h2","props":{"id":"django-lambda-djambda"},"children":[{"type":"text","value":"Django + Lambda = djambda"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The name for this project came pretty easily. I created "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/djambda","rel":["nofollow"]},"children":[{"type":"text","value":"a repo on GitLab called djambda"}]},{"type":"text","value":" and then discovered "},{"type":"element","tag":"a","props":{"href":"https://github.com/netsome/djambda","rel":["nofollow"]},"children":[{"type":"text","value":"a similar project by the same name on GitHub: netsome/djambda"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":" project uses Terraform, and I encourage you to check it out and leave it a GitHub star. Before I came across this project, I hacked together a very basic djambda protoype using some code from Zappa's handler. A "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]},{"type":"text","value":" is the name for the function that is called in your Lambda function's code when the Lambda function is invoked. Here's some pseudo code that shows how Zappa's handler works:"}]},{"type":"element","tag":"pre","props":{"code":"from werkzeug.wrappers import Response\n\ndef handler(event, context):\n    with Response.from_app(wsgi_app, wsgi_request(event)) as response:\n        zappa_returndict = dict()\n        zappa_returndict['body'] = response.data\n        zappa_returndict['statusCode'] = response.status_code\n        return zappa_returndict\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" werkzeug.wrappers "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Response\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Response.from_app(wsgi_app, wsgi_request(event)) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" dict"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'body'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.data\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'statusCode'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.status_code\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" zappa_returndict\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For reference, "},{"type":"element","tag":"a","props":{"href":"https://github.com/Miserlou/Zappa/blob/master/zappa/handler.py#L540","rel":["nofollow"]},"children":[{"type":"text","value":"here is the link to the line in Zappa's source code that starts processing API Gateway requests"}]},{"type":"text","value":" on which the above psuedo code is loosly based."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":" project makes use of a package called "},{"type":"element","tag":"a","props":{"href":"https://github.com/slank/awsgi","rel":["nofollow"]},"children":[{"type":"text","value":"awsgi"}]},{"type":"text","value":" that has active contributions from people at AWS. Similar to djambda, it is a mashup of words (acronyms): ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS"}]},{"type":"text","value":" + "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"wsgi"}]},{"type":"text","value":" = "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsgi"}]},{"type":"text","value":"). It does most of the work that Zappa's handler does, so I replaced the adapted Zappa handler code with a very elagant handler (borrowed from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":"):"}]},{"type":"element","tag":"pre","props":{"code":"# djambda/src/djambda/awsgi.py\nimport io\n\nimport awsgi\nfrom django.core import management\n\nfrom .wsgi import application\n\n\ndef lambda_handler(event, context):\n    if \"manage\" in event:\n        output = io.StringIO()\n        management.call_command(*event[\"manage\"].split(\" \"), stdout=output)\n        return {\"output\": output.getvalue()}\n    else:\n        return awsgi.response(application, event, context)\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# djambda/src/djambda/awsgi.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" io\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awsgi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" django.core "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" management\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" .wsgi "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" application\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" lambda_handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"manage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" event:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        output "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" io.StringIO()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        management.call_command("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"event["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"manage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].split("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"stdout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"output)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"output\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": output.getvalue()}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    else"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awsgi.response(application, event, context)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This handler can takes care of translating API Gateway requests to WSGI requests as well as management commands such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and other custom management commands. Let's talk about the management commands first as they relate to the two main AWS services that our Django application uses: RDS and S3. Then we will talk about API Gateway, the proxy Lambda and how the Lambda proxy pattern works."}]},{"type":"element","tag":"h2","props":{"id":"rds"},"children":[{"type":"text","value":"RDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To run the management commands for our application, we can use the AWS CLI to invoke the Lambda function with a payload that will trigger the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"if \"manage\" in event:"}]},{"type":"text","value":" code block from the above handler:"}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name my-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"migrate --no-input\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" my-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"migrate --no-input\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" command by connecting to RDS from our Django application with a special version of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws-psycopg2"}]},{"type":"text","value":" (check "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django/requirements.txt"}]},{"type":"text","value":" for this dependency). "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2-binary"}]},{"type":"text","value":" both gave error messages when trying to access the database, but the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws-psycopg2"}]},{"type":"text","value":" package had no issues."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RDS can sometimes be the most expensive part of a project on AWS. To reduce costs, we are using Aurora Postgres Serverless. This AWS service is ideal for small, infrequently-used projects that are in development. The database \"goes to sleep\" after a period of inactivity (5 minutes, I think). When new requests to the database are made, it can take up to 30 seconds for the database to wake up. For this reason, we need the timeout of the Django Lambda to be able to clear the wakeup period of the Aurora Postgres Serverless database."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since our Lambda function is in public subnet of our VPC and our RDS Aurora database cluster is in an isolated VPC, we need to make sure that the Lambda function can talk to the RDS cluster. CDK makes this really easy. I'll highlight a few important permission related parts of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/vpc.py"}]},{"type":"text","value":", the code that defines the nested CloudFormation stack where we define our VPC and resources related to our application (including API Gateway, which is technically not located in our VPC)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, we define a new security group for our Django Lambda:"}]},{"type":"element","tag":"pre","props":{"code":"        self.lambda_security_group = ec2.SecurityGroup(\n            self, \"LambdaSecurityGroup\", vpc=self.vpc\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.SecurityGroup(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"LambdaSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"vpc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Then, we reference this security group in the list of security group ingresses for our database cluster's security group:"}]},{"type":"element","tag":"pre","props":{"code":"        self.db_security_group = ec2.CfnSecurityGroup(\n            self,\n            \"DBSecurityGroup\",\n            vpc_id=self.vpc.vpc_id,\n            group_description=\"DBSecurityGroup\",\n            security_group_ingress=[\n                ec2.CfnSecurityGroup.IngressProperty(\n                    ip_protocol=\"tcp\",\n                    to_port=5432,\n                    from_port=5432,\n                    source_security_group_id=self.lambda_security_group.security_group_id,\n                )\n            ],\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".db_security_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.CfnSecurityGroup(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DBSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.vpc_id,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            group_description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DBSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            security_group_ingress"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.CfnSecurityGroup.IngressProperty(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    ip_protocol"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"tcp\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    to_port"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    from_port"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    source_security_group_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group.security_group_id,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's take a look at the code for the Django lambda itself:"}]},{"type":"element","tag":"pre","props":{"code":"        self.djambda_lambda = _lambda.Function(\n            self,\n            \"DjambdaLambda\",\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            code=_lambda.AssetCode('./django'),\n            function_name=f\"{scope.full_app_name}-djambda-lambda\",\n            handler=\"djambda.awsgi.lambda_handler\",\n            layers=[self.djambda_layer],\n            timeout=core.Duration.seconds(60),\n            vpc=self.vpc,\n            vpc_subnets=ec2.SubnetSelection(subnets=self.vpc.isolated_subnets),\n            environment={**self.env_vars},\n            security_groups=[self.lambda_security_group],\n        )\n\n        # Use raw override because Lambda's can't be placed in\n        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n        self.djambda_lambda.node.default_child.add_override(\n            \"Properties.VpcConfig.SubnetIds\",\n            [subnet.subnet_id for subnet in self.vpc.public_subnets],\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DjambdaLambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'./django'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            function_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-djambda-lambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"djambda.awsgi.lambda_handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            layers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_layer],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"core.Duration.seconds("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc_subnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetSelection("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"subnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.isolated_subnets),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".env_vars},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            security_groups"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # Use raw override because Lambda's can't be placed in\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.node.default_child.add_override(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"Properties.VpcConfig.SubnetIds\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            [subnet.subnet_id "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" subnet "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.public_subnets],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lambda"}]},{"type":"text","value":" is a reserved word in Python, so we import "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lambda"}]},{"type":"text","value":" as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda"}]},{"type":"text","value":" from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_cdk"}]},{"type":"text","value":". Note that we have a reference to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsgi.py"}]},{"type":"text","value":" handler function in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]},{"type":"text","value":" parameter of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.djambda_lambda"}]},{"type":"text","value":". I initially put the lambda in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"isolated_subnets"}]},{"type":"text","value":" because CDK won't let you define a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda.Function"}]},{"type":"text","value":" with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"public_subnets"}]},{"type":"text","value":" for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_subnets"}]},{"type":"text","value":". We can override this using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_override"}]},{"type":"text","value":" below the Lambda definition to place it in a public subnet instead."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not sure if this is necessary, or if this is recommended. Things get a little bit confusing for me here so I would love some insight if anyone knows what would be best to do here. The VPC construct for CDK doesn't allow you to have private subnets when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nat_gateways=0"}]},{"type":"text","value":". Would I be better off placing the lambda in the isolated subnet with the RDS cluster? Would I still be able to access S3 via the VPC Gateway Endpoint from an isolated subnet?"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Putting aside my uncertainties about the correct way to configure our Lambdas functions in a VPC, let's continue! Here's the Lambda invocation for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":" that we can run once we have successfully invoked the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" dev-mysite-com-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This assumes that there is an environment variable defined in our Lambda's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment"}]},{"type":"text","value":" variables that we passed in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{**self.env_vars}"}]},{"type":"text","value":" for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DJANGO_SUPERUSER_USERNAME"}]},{"type":"text","value":". Here's what we have in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"env_vars"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"        self.env_vars = {\n            \"POSTGRES_SERVICE_HOST\": self.rds_cluster.get_att(\n                \"Endpoint.Address\"\n            ).to_string(),\n            \"POSTGRES_PASSWORD\": os.environ.get(\"DB_PASSWORD\", \"db-password\"),\n            \"AWS_STORAGE_BUCKET_NAME\": f\"{scope.full_app_name}-assets\",\n            \"DEBUG\": \"\",\n            \"DJANGO_SUPERUSER_PASSWORD\": os.environ.get(\n                \"DJANGO_SUPERUSER_PASSWORD\", \"Mypassword1!\"\n            ),\n            \"DJANGO_SUPERUSER_USERNAME\": os.environ.get(\n                \"DJANGO_SUPERUSER_USERNAME\", \"admin\"\n            ),\n        }\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".env_vars "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"POSTGRES_SERVICE_HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".rds_cluster.get_att(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"Endpoint.Address\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ).to_string(),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"POSTGRES_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DB_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"db-password\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"AWS_STORAGE_BUCKET_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-assets\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DEBUG\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DJANGO_SUPERUSER_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"DJANGO_SUPERUSER_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Mypassword1!\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DJANGO_SUPERUSER_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"DJANGO_SUPERUSER_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"admin\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can use environment variables to set an initial password for our superuser. We also define additionl environment variables that we will use for our datbase connection, and the S3 bucket that we will use for Django's static and media assets."}]},{"type":"element","tag":"h2","props":{"id":"s3"},"children":[{"type":"text","value":"S3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To access S3 from our Lambda function in a VPC, we need to use a VPC Gateway Endpoint for S3. This is a free service that enables us to access S3 directly from our VPC without going through the internet, and instead using a private connection . This again has to do with the fact that our Django Lambda can't access the internet because the network interfaces created by Lambda only have private IP addresses and would require NAT in order to connect to resources on the internet. Here's how we define the VPC as well as the VPC Gateway Endpoint using CDK:"}]},{"type":"element","tag":"pre","props":{"code":"        self.vpc = ec2.Vpc(\n            self,\n            \"Vpc\",\n            max_azs=2,\n            cidr=\"10.0.0.0/16\",\n            nat_gateways=0,\n            subnet_configuration=[\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.PUBLIC,\n                    name=\"Public\",\n                    cidr_mask=24,\n                ),\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.ISOLATED,\n                    name=\"Isolated\",\n                    cidr_mask=24,\n                ),\n            ],\n        )\n\n        self.vpc.add_gateway_endpoint(\n            \"S3Gateway\", service=ec2.GatewayVpcEndpointAwsService('s3')\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.Vpc(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"Vpc\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            max_azs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            cidr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"10.0.0.0/16\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            nat_gateways"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            subnet_configuration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.SubnetConfiguration(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    subnet_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PUBLIC"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Public\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    cidr_mask"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"24"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.SubnetConfiguration(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    subnet_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"ISOLATED"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Isolated\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    cidr_mask"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"24"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.add_gateway_endpoint(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"S3Gateway\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.GatewayVpcEndpointAwsService("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'s3'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this VPC endpoint in place, we are almost ready to run our collectstatic command, but it won't work yet. This is because we haven't given our Lambda function access to write files to the S3 assets bucket for our Django application's static and media files. We can grant this permission with the following snippet from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app_stack.py"}]},{"type":"text","value":", the file that defines the root CloudFormation stack for our application:"}]},{"type":"element","tag":"pre","props":{"code":"        self.backend_assets_bucket.grant_read_write(\n            self.vpc_stack.djambda_lambda\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".backend_assets_bucket.grant_read_write(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc_stack.djambda_lambda\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we need to add the following settings to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"STATIC_URL = '/static/'\nSTATIC_ROOT = os.path.join(BASE_DIR, 'static')\nSTATICFILES_STORAGE = \"djambda.storage_backends.StaticStorage\"\n\nAWS_DEFAULT_ACL = None\nAWS_STORAGE_BUCKET_NAME = os.environ.get(\n    \"AWS_STORAGE_BUCKET_NAME\", \"bucketname\"\n)\nAWS_S3_OBJECT_PARAMETERS = {\n    \"CacheControl\": \"max-age=86400\",\n}\nAWS_PRIVATE_MEDIA_LOCATION = \"media/private\"\nAWS_STATIC_LOCATION = \"static\"\nPRIVATE_FILE_STORAGE = \"backend.storage_backends.PrivateMediaStorage\"\nAWS_S3_CUSTOM_DOMAIN = f\"{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com\"\n\nif not DEBUG:\n    MEDIA_ROOT = \"media\"\n    MEDIA_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{MEDIA_ROOT}/\"\n    STATIC_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{AWS_STATIC_LOCATION}/\"\n    FORCE_SCRIPT_NAME = \"/prod\"\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATIC_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '/static/'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATIC_ROOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.path.join("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"BASE_DIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'static'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATICFILES_STORAGE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"djambda.storage_backends.StaticStorage\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_DEFAULT_ACL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" None\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_STORAGE_BUCKET_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"AWS_STORAGE_BUCKET_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"bucketname\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_S3_OBJECT_PARAMETERS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"CacheControl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"max-age=86400\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_PRIVATE_MEDIA_LOCATION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"media/private\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_STATIC_LOCATION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"static\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PRIVATE_FILE_STORAGE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"backend.storage_backends.PrivateMediaStorage\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_S3_CUSTOM_DOMAIN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_STORAGE_BUCKET_NAME}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".s3.amazonaws.com\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" not"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DEBUG"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    MEDIA_ROOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"media\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    MEDIA_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_S3_CUSTOM_DOMAIN}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{MEDIA_ROOT}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    STATIC_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_S3_CUSTOM_DOMAIN}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_STATIC_LOCATION}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    FORCE_SCRIPT_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/prod\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can run the collectstatic command with the following Lambda invocation:"}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"collectstatic --no-input\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" dev-mysite-com-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"collectstatic --no-input\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"api-gateway-and-the-lambda-proxy-pattern"},"children":[{"type":"text","value":"API Gateway and the Lambda proxy pattern"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I first read about the Lambda proxy pattern in an article titled "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/lambda-vpc-internet-access-no-nat-gateway/","rel":["nofollow"]},"children":[{"type":"text","value":"How to access VPC and internet resources from Lambda without paying for a NAT Gateway"}]},{"type":"text","value":" on Paul Swail's website "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/","rel":["nofollow"]},"children":[{"type":"text","value":"https://serverlessfirst.com/"}]},{"type":"text","value":". This site has tons of great serverless content, check out the "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/articles/","rel":["nofollow"]},"children":[{"type":"text","value":"list of articles"}]},{"type":"text","value":". Thank you Paul for putting out great serverless resources!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take a look at the Proxy Lambda function next. The function itself is pretty straightforward:"}]},{"type":"element","tag":"pre","props":{"code":"import json\nimport os\nimport boto3\n\nlambda_client = boto3.client('lambda', region_name='us-east-1')\n\n\ndef handler(event, context):\n    invoke_response = lambda_client.invoke(\n        FunctionName=os.environ.get(\"FUNCTION_NAME\", None),\n        InvocationType='RequestResponse',\n        Payload=json.dumps(event),\n    )\n\n    data = invoke_response['Payload'].read()\n\n    return data\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" boto3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"lambda_client "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" boto3.client("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lambda'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"region_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'us-east-1'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    invoke_response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lambda_client.invoke(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        FunctionName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FUNCTION_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        InvocationType"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'RequestResponse'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        Payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"json.dumps(event),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    data "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" invoke_response["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Payload'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].read()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are just a few things to setup in our CDK code to make the proxy pattern work:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Lambda function"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Give the proxy Lambda permission to invoke the Django Lambda"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LambdaRestApi"}]},{"type":"text","value":" construct with the Proxy Lambda as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's what that code looks like:"}]},{"type":"element","tag":"pre","props":{"code":"        self.proxy_lambda = _lambda.Function(\n            self,\n            \"ProxyLambda\",\n            code=_lambda.AssetCode(\"./awslambda\"),\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            layers=[self.djambda_layer],\n            handler=\"proxy_lambda.handler\",\n            timeout=core.Duration.seconds(60),\n            environment={\"FUNCTION_NAME\": self.djambda_lambda.function_name},\n        )\n\n        self.djambda_lambda.grant_invoke(self.proxy_lambda)\n\n        self.apigw = apigw.LambdaRestApi(\n            self, 'DjambdaEndpoint', handler=self.proxy_lambda,\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"ProxyLambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./awslambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            layers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_layer],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"proxy_lambda.handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"core.Duration.seconds("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FUNCTION_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.function_name},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.grant_invoke("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".apigw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" apigw.LambdaRestApi(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'DjambdaEndpoint'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's it! We can now access our Django project at the API Gateway "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"execute-api"}]},{"type":"text","value":" endpoint. This is a special URL that has the format:"}]},{"type":"element","tag":"pre","props":{"code":"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"abc123"}]},{"type":"text","value":" is the id of the API Gateway that we created (you can find the value of this id in the API Gateway section of the AWS management console)]"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The region "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"us-east-1"}]},{"type":"text","value":" is the region where you deployed the API Gateway"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" is the stage name"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The stage name part is a little confusing for me. It is meant to be a URL suffix that indicates production, staging, etc., but I typically separate environments at the level of the CloudFormation stack, so all of my environments use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" suffix. In order for Django to work properly, we need to tell it that our site will be served at this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" path (for example "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" will now be served at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod/admin"}]},{"type":"text","value":") by setting a special value in our settings module:"}]},{"type":"element","tag":"pre","props":{"code":"FORCE_SCRIPT_NAME = \"/prod\"\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"FORCE_SCRIPT_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/prod\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will make dealing with URLs easier, mostly because we don't actually have to change anything in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urls.py"}]},{"type":"text","value":". I tried adding "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" to my URL paths in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urls.py"}]},{"type":"text","value":", but the Django admin doesn't work properly because going to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod/admin"}]},{"type":"text","value":" will redirect you to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/login"}]},{"type":"text","value":" which will thrown an error with API Gateway since our application must be on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" subpath."}]},{"type":"element","tag":"h2","props":{"id":"setting-a-custom-url-for-api-gateway"},"children":[{"type":"text","value":"Setting a custom URL for API Gateway"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you don't mind having a URL in the form of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://abc123.execute-api.us-east-1.amazonaws.com/prod"}]},{"type":"text","value":", then everything should be good to go. If you do want a custom URL for API Gateway, there are only two things you need to do:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Get a domain and hosted zone set up in Route53 (this typically costs about $12/year)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":" to environment variables (see below for how to do this)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define an ACM certificate in our CDK code and"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LambdaRestApi"}]},{"type":"text","value":"'s "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_domain_name"}]},{"type":"text","value":" method to add the domain name and certificate to the API Gateway endpoint."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_apigateway/LambdaRestApi.html#aws_cdk.aws_apigateway.LambdaRestApi.add_domain_name","rel":["nofollow"]},"children":[{"type":"text","value":"link to the CDK Python documentation"}]},{"type":"text","value":" on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_domain_name"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you configure a custom domain name, you don't need to set the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FORCE_SCRIPT_NAME"}]},{"type":"text","value":" setting in Django settings."}]},{"type":"element","tag":"h2","props":{"id":"project-directory-structure"},"children":[{"type":"text","value":"Project directory structure"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take a quick look at the structure of the project using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tree"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"tree -L 3 .\n.\n awscdk\n    app.py\n    awscdk\n       app_stack.py  <----------------- CDK application overview\n       backend_assets.py\n       cert.py\n       cloudfront.py\n       hosted_zone.py\n       __init__.py\n       static_site_bucket.py\n       vpc.py <------------------------ VPC, Lambdas, API Gateway and more\n    cdk.json                             defined here\n    README.md\n    requirements.txt\n    setup.py\n    source.bat\n awslambda\n    proxy_lambda.py <------------------- Proxy Lambda\n django\n    core <------------------------------ A sample Django app\n       admin.py\n       apps.py\n       __init__.py\n       migrations\n       models.py\n       tests.py\n       urls.py\n       views.py\n    djambda\n       asgi.py\n       awsgi.py <---------------------- Django Lambda handler\n       __init__.py\n       settings.py <------------------- Django settings (RDS connections, S3 static/media)\n       storage_backends.py\n       urls.py\n       wsgi.py\n    manage.py\n    requirements.txt\n layers <-------------------------------- Lambda Layers (python dependencies)\n    django                               Note: This folder is not committed to git\n        python\n ARTICLE.md <---------------------------- This article\n gitlab-ci.yml\n .variables <---------------------------- Environment variables needed for deployment\n README.md\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"tree -L 3 .\n.\n awscdk\n    app.py\n    awscdk\n       app_stack.py  <----------------- CDK application overview\n       backend_assets.py\n       cert.py\n       cloudfront.py\n       hosted_zone.py\n       __init__.py\n       static_site_bucket.py\n       vpc.py <------------------------ VPC, Lambdas, API Gateway and more\n    cdk.json                             defined here\n    README.md\n    requirements.txt\n    setup.py\n    source.bat\n awslambda\n    proxy_lambda.py <------------------- Proxy Lambda\n django\n    core <------------------------------ A sample Django app\n       admin.py\n       apps.py\n       __init__.py\n       migrations\n       models.py\n       tests.py\n       urls.py\n       views.py\n    djambda\n       asgi.py\n       awsgi.py <---------------------- Django Lambda handler\n       __init__.py\n       settings.py <------------------- Django settings (RDS connections, S3 static/media)\n       storage_backends.py\n       urls.py\n       wsgi.py\n    manage.py\n    requirements.txt\n layers <-------------------------------- Lambda Layers (python dependencies)\n    django                               Note: This folder is not committed to git\n        python\n ARTICLE.md <---------------------------- This article\n gitlab-ci.yml\n .variables <---------------------------- Environment variables needed for deployment\n README.md\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The three top level folders are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awslambda"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django"}]},{"type":"text","value":". To deploy our CDK code, we run the following command from the root of the project:"}]},{"type":"element","tag":"pre","props":{"code":"cdk deploy --app awscdk/app.py\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"cdk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" --app"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" awscdk/app.py\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can also run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py"}]},{"type":"text","value":" to preview changes to our CDK code by reviewing the CloudFormation templates generated by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":". Running the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" commands at root of the project means that we need to specificy lambda code assets from the root of the project as well. This is why the Django application's Lambda function references the code with:"}]},{"type":"element","tag":"pre","props":{"code":"code=_lambda.AssetCode('./django'),\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'./django'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"deploying"},"children":[{"type":"text","value":"Deploying"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK is easy to use both locally and in a CI/CD tool such as GitLab CI, my CI/CD tool of choice. There are a few things to coordinate when deploying in both of these environments:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Environment variables"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Dependencies"}]}]},{"type":"element","tag":"h3","props":{"id":"deploying-from-a-terminal"},"children":[{"type":"text","value":"Deploying from a terminal"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you are new to CDK, you will need to make sure that you have ran the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" command at least once on your account. This command sets up a CloudFormation stack that CDK uses internally to manage deployments."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The environment variables needed for deployment are defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".variables.template"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"APP_NAME"}]},{"type":"text","value":" should be a URL compatible name, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"my-app"}]},{"type":"text","value":" (don't put "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" in this variable)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":" are needed for adding a custom domain name to API Gateway"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Copy this template into a file in the root of the project called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".variables"}]},{"type":"text","value":" and set these environment variables with the following command:"}]},{"type":"element","tag":"pre","props":{"code":". .variables\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":". .variables\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we need to install our Python dependencies locally with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" target flag so that the Lambda layers we define in CDK can find the files needed to be packaged into our Lambda layer and made available to our Lambda function at runtime. Install dependencies to the target directory by running the following command from the root of the project:"}]},{"type":"element","tag":"pre","props":{"code":"pip install -r django/requirements.txt -t layers/django/python\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install -r django/requirements.txt -t layers/django/python\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we can deploy our serverless application to AWS using CDK. First, activate the CDK Python virtual environment with:"}]},{"type":"element","tag":"pre","props":{"code":"source awscdk/.env/bin/activate\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"source awscdk/.env/bin/activate\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Also make sure that you are using a version of Node.js greater or equal to 10. I do this with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nvm use 13"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Make sure that all of the dependencies defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/setup.py"}]},{"type":"text","value":" are up-to-date. Make sure that there are no issues witht the CDK code by running:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Inspect the contents of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":"; these are the CloudFormation templates generated by CDK that will be used to deploy all of our resources. If everything looks good to go, deploy with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Follow the output of this command and ensure that it completes successfully. You can also follow along in the CloudFormation section of the AWS management console to make sure that things are deploying properly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once everything has finished deploying, you will need to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collecstatic"}]},{"type":"text","value":" after the first deployment."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"TODO: consolidate these steps with a Makefile or bash script"}]}]},{"type":"element","tag":"h3","props":{"id":"deploying-with-gitlab-ci"},"children":[{"type":"text","value":"Deploying with GitLab CI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Deploying locally is fine, but it is better to run CDK commands from a CI/CD process so we can keep track of the commits, pipeline results, commit messages, etc. The process is very similar to everything we do locally, but you will need to add environment variables to the GitLab project's Settings > CI/CD > Variables. I have broken out dependency installation into a separate stage. This is not entirely necessary, but it helps keep things easy to follow:"}]},{"type":"element","tag":"pre","props":{"code":"pip_install:\n  stage: build\n  artifacts:\n    paths:\n      - layers/django/python\n  script:\n    - pip install -r django/requirements.txt -t layers/django/python\n\ncdk_deploy:\n  stage: deploy\n  before_script:\n    - apt-get -qq update && apt-get -y install nodejs npm\n    - npm i -g aws-cdk\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"pip_install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  artifacts"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    paths"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"layers/django/python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip install -r django/requirements.txt -t layers/django/python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"cdk_deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apt-get -qq update && apt-get -y install nodejs npm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"npm i -g aws-cdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip3 install -e awscdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk deploy --app awscdk/app.py --require-approval never\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For management commands, we use a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".base_task"}]},{"type":"text","value":" template and reuse this for each command:"}]},{"type":"element","tag":"pre","props":{"code":".base_task: &task\n  image: python:3.8\n  stage: deploy\n  rules:\n    - when: manual\n  before_script:\n    - pip install awscli\n  after_script:\n    - cat invoke_response.json\n\nmigrate:\n  <<: *task\n  script:\n    - |\n      aws lambda invoke \\\n        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n        --payload '{\"manage\": \"migrate --no-input\"}' \\\n        invoke_response.json\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":".base_task"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"python:3.8\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  rules"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"when"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"manual\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip install awscli\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  after_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cat invoke_response.json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"migrate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  <<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      aws lambda invoke \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        --payload '{\"manage\": \"migrate --no-input\"}' \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        invoke_response.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"manual"}]},{"type":"text","value":" commands, and can be started through the GitLab CI interface by pressing the \"Play\" button on the pipeline."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I still have lots of ideas and things to try out with this Django/Lambda architecture. Here are a few things that would be good to try:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using another Lambda function that proxies web requests to a Lambda outside of the VPC for basic network requests using either "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urllib.request"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"requests"}]},{"type":"text","value":". This would be the easiest way to add simple internet access without needing a NAT Gateway"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use a NAT provider to add a cheap NAT instance using a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"t3a.nano"}]},{"type":"text","value":" instance ( about $5.00/month) to allow for internet access in the Django request/response cycle"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Figure out a good solution for async processing. Zappa has a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@task"}]},{"type":"text","value":" wrapper that allows you to run tasks asynchronously in separate Lambda functions. It would be interesting to experiment with direct invocation of async tasks as well as task queueing with SQS. Using SQS would involve a VPC Endpoint which does cost extra, or we could setup a dedicated SQS proxy function to do this in a way similar to how we would handle requests."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Lambda tuning. I'm pretty new to using Lambda and I would like to better understand how to fine-tune Lambda settings. There are lots of options in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda.Function"}]},{"type":"text","value":" construct, which would be a good place to start. This would be especially important for async tasks that require high memeory. From the "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"Lambda Developer Guide"}]},{"type":"text","value":" it looks like memory can be configured from 128 MB to 3,008 MB in 64 MB increments."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I typically setup Vue.js frontends with S3/CloudFront and use Django only for the admin and API with Django REST Framework. From what I understand, API Gateway uses CloudFront in the backround to do custom domains, but you don't have access to this CloudFront distribution. You can add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"execute-api"}]},{"type":"text","value":" URL as a Custom Origin for a single CloudFront distribution, or keep a CloudFront distribution separate from the API Gateway custom domain and serve these on different subdomains, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"api.mysite.com"}]},{"type":"text","value":" for the API Gateway domain name and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"mysite.com"}]},{"type":"text","value":" for the CloudFront distribution serving Vue.js files."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pricing. I'm still unsure about exactly how much this setup costs. The only major costs should be Aurora Postgres Serverless if it is used heavily, but I'm still not sure about how the pricing for this service works. Here's an in-depth article from Jeremy Daly that has more information on Aurora Serverless: "},{"type":"element","tag":"a","props":{"href":"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks for reading!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"why","depth":2,"text":"Why?"},{"id":"django-lambda-djambda","depth":2,"text":"Django + Lambda = djambda"},{"id":"rds","depth":2,"text":"RDS"},{"id":"s3","depth":2,"text":"S3"},{"id":"api-gateway-and-the-lambda-proxy-pattern","depth":2,"text":"API Gateway and the Lambda proxy pattern"},{"id":"setting-a-custom-url-for-api-gateway","depth":2,"text":"Setting a custom URL for API Gateway"},{"id":"project-directory-structure","depth":2,"text":"Project directory structure"},{"id":"deploying","depth":2,"text":"Deploying","children":[{"id":"deploying-from-a-terminal","depth":3,"text":"Deploying from a terminal"},{"id":"deploying-with-gitlab-ci","depth":3,"text":"Deploying with GitLab CI"}]},{"id":"next-steps","depth":2,"text":"Next Steps"}]}},"_type":"markdown","_id":"content:2020:08:01:django-and-lambda-with-cdk-and-api-gateway.md","_source":"content","_file":"2020/08/01/django-and-lambda-with-cdk-and-api-gateway.md","_stem":"2020/08/01/django-and-lambda-with-cdk-and-api-gateway","_extension":"md"},{"_path":"/2020/06/02/django-postgres-vue-gitlab-ecs","_dir":"02","_draft":false,"_partial":false,"_locale":"","title":"Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications","description":"","layout":"post","date":"2020-06-02T00:00:00.000Z","comments":true,"image":"/static/architecture_verbose_equals_true.png","tags":["fargate","django","gitlab","vue","cdk"],"body":{"type":"root","children":[{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article was originally posted on "},{"type":"element","tag":"a","props":{"href":"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i","rel":["nofollow"]},"children":[{"type":"text","value":"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i"}]},{"type":"text","value":". It is also available on the documentation site for the project: "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/"}]}]}]},{"type":"element","tag":"h1","props":{"id":"project-overview"},"children":[{"type":"text","value":"Project Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is an overview of a Proof-of-Concept web application I'm working on called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-postgres-vue-gitlab-ecs"}]},{"type":"text","value":". This project aims to demonstrate the development and deployment of a web application using some of my favorite tools, languages and frameworks including:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Python"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"JavaScript"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue.js/Quasar Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AWS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"and last but not least, "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK)"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This README will start by describing some features of the application I'm building and how the different technologies are used together. I also share my experience in adopting CDK for managing cloud infrastructure on AWS. Finally, I discuss my solution to a specific question I have been trying to answer: what's the best way to scale Celery workers to zero to reduce Total Cost of Ownership?"}]},{"type":"element","tag":"h2","props":{"id":"development-philosophies-and-best-practices"},"children":[{"type":"text","value":"Development Philosophies and Best Practices"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the best practices that this project aims to use:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Open-source, MIT-Licensed"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"12 Factor App"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Infrastructure as Code"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Containerization with Docker"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitOps"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serverless* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Project documentation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Cost containment and tracking"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"KISS & DRY"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Initial AWS console interaction is strictly limited to what can "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"only"}]},{"type":"text","value":" be done through the AWS console, otherwise AWS CDK and AWS CLI (preferably in CI/CD pipelines) are the primary means of interacting with AWS resources and the AWS Console is treated as a \"read-only\" convenience."}]}]},{"type":"element","tag":"h2","props":{"id":"topics"},"children":[{"type":"text","value":"Topics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/architecture_verbose_equals_true.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"legend"},"children":[{"type":"text","value":"Legend"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This diagram was created with draw.io. Here's the link to the a read-only version of the diagram on draw.io: "},{"type":"element","tag":"a","props":{"href":"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing","rel":["nofollow"]},"children":[{"type":"text","value":"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"1 - GitLab is used to host the source code, test the source code and deploy the application to AWS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2 - Unit testing (see .gitlab-ci.yml)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2a - Pytest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2b - Jest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2c - Cypress"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3 - Deployment phase (see /gitlab-ci/aws/cdk.yml)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3a - Quasar PWA assets are built if there are changes in the quasar directory"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3b - AWS Cloud Development Kit (CDK) defines all infrastructure in AWS (4a - 12)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3c - AWS CLI is used to run Fargate tasks through manual GitLab CI jobs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4 - CDK Assets (ECR and S3 buckets that CDK uses internally to manage build assets and artifacts)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4a - Elastic Container Repository is used to manage the Django docker image used in various parts of the application"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4b - S3 bucket used to store files associated with CDK and CloudFormation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"5 - Route53 is used to route traffic to the CloudFront distribution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"6 - CloudFront distribution that serves as the \"front desk\" of the application. It routes requests to to the correct CloudFront Origin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7 - CloudFront Origin Configurations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7a - S3 bucket for Quasar PWA assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7b - Application Load Balancer for Django application (/api/, /admin/, /flower/, /ws/, /graphql/)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7c - S3 bucket for Django assets (static files, public media and private media)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8 - Web server and websocket servers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8a - Fargate service running uvicorn process (REST, GraphQL, Django Channels)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8b - Autoscaling Group for Fargate Service that serves Django API"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9 - Celery and celery worker autoscaling"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9a - Fargate service that is autoscaled between 0 and N Fargate tasks for a given celery queue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9b - Scheduled Event that triggers a Lambda to make a request to Django backend which collects celery queue metrics and published\nmetrics to CloudWatch using boto3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9c - Lambda event the makes a request to /api/celery-metrics/"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9d - CloudWatch alarm that is used to scale the Fargate service for a celery queue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9e - Autoscaling group for celery Fargate service"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"10 - Fargate tasks that run Django management commands such as migrate and collectstatic. These are triggered from manual GitLab CI\njobs using the AWS CLI (3c)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"11 - ElastiCache for Redis, used for Caching, Celery Broker, Channels Layer, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"12 - Aurora Postgres Serverless"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a list of some of the major topics covered:"}]},{"type":"element","tag":"h3","props":{"id":"local-development"},"children":[{"type":"text","value":"Local development"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a local development environment using docker with one easy command: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hot-reloading for all parts of the application in local development"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Structuring a Django application (apps, settings modules, environment variables)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automatic code formatting with black and prettier"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Monitoring services (flower, pgadmin4, redis-commander)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VSCode settings and extensions"}]}]},{"type":"element","tag":"h3","props":{"id":"gitlab-ci"},"children":[{"type":"text","value":"GitLab CI"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI for running unit and integration tests"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI configuration for deployment to multiple environments (dev, prod) using AWS CDK"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI scheduled jobs for updating all project dependencies through automated merge requests with Renovate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI manual jobs for running admin and management commands (database migrations, collectstatic, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How to deploy to multiple environments (master -> staging, tags -> prod pattern as well as optional ephemeral environments per commit) using the new GitLab CI "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rules"}]},{"type":"text","value":" syntax"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Recording Cypress test videos with GitLab CI artifacts for manual review"}]}]},{"type":"element","tag":"h3","props":{"id":"aws"},"children":[{"type":"text","value":"AWS"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Initial account setup"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Generating keys used in GitLab CI for deployment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Opting in to new ARN format for ECS services and tasks (used for resource tagging) and container insights"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK) for Infrastructure as Code to manage all AWS resources with CloudFormation Stacks - Nested stacks for grouping related resources under parent tasks (one parent task represent on environment for the application, such as production)"}]}]},{"type":"element","tag":"h4","props":{"id":"aws-resources"},"children":[{"type":"text","value":"AWS Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automated provisioning of Amazon Certificate Manager certificates for TLS (HTTPS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Multi-AZ VPC with security groups and NACLs (no NAT Gateways/NAT instances used* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"2"}]}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 buckets for static site hosting and Django static and media assets"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CloudFront for serving Vue.js SPA (PWA) static assets, Django static/media files and proxy to Application Load Balancer which forwards to ECS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fargate for multiple Django processes: gunicorn for backend API, daphne for Django Channels, celery for asynchronous tasks and celery beat for scheduled tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Autoscaling (between 0 and N Fargate tasks) for infrequent, compute/memory intensive and long-running celery tasks with custom CloudWatch metrics"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hosted Redis with ElastiCache for celery broker, application caching, django-constance, etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Aurora Postgres and Aurora Postgres Serverless for cost savings in staging environments"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK Assets for automating S3 asset deployment and automated container building during deployment with AWS CDK"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Thorough resource tagging by both application and environment (dev, prod, etc.) for comprehensive cost tracking"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Optional bastion host for SSH access to bring up a Django shell in a container running on a container instance (this requires an EC2 instance)"}]}]},{"type":"element","tag":"h3","props":{"id":"django-application"},"children":[{"type":"text","value":"Django Application"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"JWT-based authentication with django-rest-framework-simplejwt"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Custom user model with email as username"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Social authentication with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python-social-auth"}]},{"type":"text","value":" (Google, Facebook, GitHub)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pytest for unit testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Settings broken into separate modules (development, ci, production)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django apps organized in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apps"}]},{"type":"text","value":" directory"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 for static assets, public media and private media files in production, local file system for assets in local development"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Multiple Celery queues for asynchronous tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django Channels for websocket support with daphne"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Graphene for GraphQL"}]}]},{"type":"element","tag":"h3","props":{"id":"vuejs-application"},"children":[{"type":"text","value":"Vue.js application"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Quasar Framework for creating a Vue.js app with multiple build targets (SPA, PWA, Electron, SSR and Cordova)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Internationalization"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Dark/Light mode"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vuex for state management"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"vue-router"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"axios"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue Apollo"}]}]},{"type":"element","tag":"h3","props":{"id":"aws-django-vuejs"},"children":[{"type":"text","value":"AWS  Django  Vue.js"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CloudFront is used as a CDN and proxy in order to serve the frontend Vue.js PWA* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"3"}]}]},{"type":"text","value":", static and media assets, Django API and other monitoring services all on the same URL with environments namespaced by subdomain (or a combination of domain and subdomains by production and non-production environments, respectively). The PWA uses Workbox to route certain URL paths to network only (not served by the local cache)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some examples:"}]},{"type":"element","tag":"h4","props":{"id":"staging-environment-urls"},"children":[{"type":"text","value":"Staging environment URLs"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/api/*"}]},{"type":"text","value":" - Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/admin/*"}]},{"type":"text","value":" - Django Admin"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/graphql/"}]},{"type":"text","value":" - Graphene/GraphQL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/flower/*"}]},{"type":"text","value":" - Flower (Celery monitoring utility)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/media/private/private-file.csv"}]},{"type":"text","value":" - private media files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/*"}]},{"type":"text","value":" - Vue.js PWA (all other routes load "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"h4","props":{"id":"production-environment-urls"},"children":[{"type":"text","value":"Production environment URLs"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/api/*"}]},{"type":"text","value":" - Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/admin/*"}]},{"type":"text","value":" - Django Admin"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/graphql/"}]},{"type":"text","value":" - Graphene/GraphQL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/flower/*"}]},{"type":"text","value":" - Flower (Celery monitoring utility)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/media/private/private-file.csv"}]},{"type":"text","value":" - private media files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com"}]},{"type":"text","value":" - Vue.js PWA (all other routes load "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alternatively, the production domain name could be configured to use a dedicated subdomain such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://app.mysite.com"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"sample-application-logic"},"children":[{"type":"text","value":"Sample application logic"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While this is mostly a Proof-of-Concept project that focuses on architecture, I have included some light-weight examples of what you can do with this application. These examples are all WIP."}]},{"type":"element","tag":"h4","props":{"id":"social-authentication"},"children":[{"type":"text","value":"Social Authentication"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python-social-auth"}]},{"type":"text","value":" to allow users to Sign Up/Login with Google, Facebook and GitHub accounts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Makes use of the custom user model"}]}]},{"type":"element","tag":"h4","props":{"id":"credit-card-statement-app"},"children":[{"type":"text","value":"Credit Card Statement App"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a simple application for users to upload credit card statements in CSV format."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Credit card transactions in CSV files are created using bulk inserts via the Django ORM in a celery task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CSV files are saved in private S3 storage"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Basic visualization of spend over time"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Download consolidated CSV file"}]}]},{"type":"element","tag":"h4","props":{"id":"hacker-news-clone"},"children":[{"type":"text","value":"Hacker News Clone"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An implementation of the application from this tutorial: "},{"type":"element","tag":"a","props":{"href":"https://www.howtographql.com/graphql-python/0-introduction/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.howtographql.com/graphql-python/0-introduction/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Uses Vue Apollo GraphQL client"}]}]},{"type":"element","tag":"h3","props":{"id":"testing"},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Unit testing with pytest and Jest"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Test coverage reports"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Integration testing with Cypress"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Capture integration test run recordings as GitLab CI job artifacts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing GitLab CI jobs locally with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gitlab-runner"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Tests for CDK?* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"4"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"caveats-questions-confusion-and-footnotes"},"children":[{"type":"text","value":"Caveats, Questions, Confusion and Footnotes"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In the context of this project, it is serverless in the sense that AWS Fargate is serverless: there are no EC2 instances to manage. It is not serverless in the way that Zappa can deploy a Django application as an AWS Lambda function with one invocation per request. There are \"always on\" processes that listen for incoming requests. I'm interested in trying Zappa, but I'm confused about how CDK, zappa-cli, SAM and Serverless Framework would all play together. Aurora Postgres Serverless is another nice \"serverless\" aspect of this project and contributes significantly to cost savings."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This project currently uses no NAT Gateways. The Fargate services and tasks running Django processes (gunicorn, celery, daphne as well as migration, collectstatic and other management commands) are launched in public subnets and the databases (RDS and ElastiCache) are placed in private subnets. This is primarily done to avoid the cost of running a NAT Gateway."}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I think it would fairly easy to switch to using a NAT Gatway to add an additional layer of security that is recommended in this article: "},{"type":"element","tag":"a","props":{"href":"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/","rel":["nofollow"]},"children":[{"type":"text","value":"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I asked a question about this on the Stack Exchange Information Security forum: "},{"type":"element","tag":"a","props":{"href":"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job","rel":["nofollow"]},"children":[{"type":"text","value":"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job"}]},{"type":"text","value":"\nI'm curious to know if this is a reasonable tradeoff to make, as well as how secure the proposed solution is (using security groups and network ACLs)."}]}]},{"type":"element","tag":"ol","props":{"start":3},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I'm not focusing on SEO in this project. I'm using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" as the error document for the S3 website that CloudFront uses as the default behavior. This means that nested routes for the PWA have 404 response codes. I have heard about using lambda@edge to rewrite the the response code, I'm also curious about using this project in SSR mode (and also \"serverless-side rendering\"), but for now that is outside of the scope of what I want to do with this project."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CDK is an awesome tool!"}]},{"type":"text","value":" Here is a great introduction by Nathan Peck, Senior Developer Advocate at Amazon Web Services: "},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=184S7ki6fJA","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.youtube.com/watch?v=184S7ki6fJA"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"h2","props":{"id":"my-experience-with-aws-cdk"},"children":[{"type":"text","value":"My experience with AWS CDK"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Having worked with CloudFormation for almost a year, I was not looking forward to learning a another Infrastructure as Code (IaC) tool. I struggled with CloudFormation and the whole concept of using an extended version of YAML to define infrastructure for multiple environments. I have limited experience with Terraform, but learning another DSL seemed like a lateral move that didn't seem worth it. I'm glad I did spend time learning and using CloudFormation, because CDK is an abstraction layer over CloudFormation. Here are some of my thoughts on adopting CDK."}]},{"type":"element","tag":"h3","props":{"id":"start-here-httpscdkworkshopcom"},"children":[{"type":"text","value":"Start here: "},{"type":"element","tag":"a","props":{"href":"https://cdkworkshop.com","rel":["nofollow"]},"children":[{"type":"text","value":"https://cdkworkshop.com"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a great resource that was my first exposure to CDK. It focuses on using Lambda, DynamoDB and API Gateway, three technologies that I haven't used in production environments. In my mind this stack is the antithesis of the stack paradigm I am most experienced with: EC2, RDS and ELB. Regardless, I went ahead with it and was pretty much instantly hooked on CDK."}]},{"type":"element","tag":"h3","props":{"id":"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing"},"children":[{"type":"text","value":"The stack is defined by a small number of inputs used for namespacing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app.py"}]},{"type":"text","value":" is the entrypoint for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk"}]},{"type":"text","value":" commands. Here's what it contains:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the main parameters for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", which represents all of the resources for a specific environment environment. Each value is composed of environment variables set in GitLab CI when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" is called:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment_name"}]},{"type":"text","value":" - Possible examples could be "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"qa"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"some-feature-branch"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod"}]},{"type":"text","value":", etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"text","value":" - The domain name of the Hosted Zone that needs to be setup manually in Route53"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":" - "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"f\"{environment_name}.{base_domain_name}\""}]},{"type":"text","value":" or optionally just "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_app_name"}]},{"type":"text","value":" - Based on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"text","value":", but "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" is replaced with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" in order to be used for naming certain AWS resources, used for resources tagging so we can easily look at the costs of all environments for our application with one tag."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_app_name"}]},{"type":"text","value":" - Base on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" replaced with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" as well."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_region"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Expand to the following to view "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app.py"}]},{"type":"text","value":":"}]},{"type":"element","tag":"details","props":{},"children":[{"type":"element","tag":"pre","props":{"code":"#!/usr/bin/env python3\nimport os\n\nfrom aws_cdk import core\n\nfrom awscdk.cdk_app_root import ApplicationStack\n\n# naming conventions, also used for ACM certs, DNS Records, resource naming\n# Dynamically generated resource names created in CDK are used in GitLab CI\n# such as cluster name, task definitions, etc.\nenvironment_name = f\"{os.environ.get('ENVIRONMENT', 'dev')}\"\nbase_domain_name = os.environ.get(\"DOMAIN_NAME\", \"mysite.com\")\n# if the the production environent subdomain should nott be included in the URL\n# redefine `full_domain_name` to `base_domain_name` for that environment\nfull_domain_name = f\"{environment_name}.{base_domain_name}\"  # dev.mysite.com\n# if environment_name == \"prod\":\n#     full_domain_name = base_domain_name\nbase_app_name = os.environ.get(\"APP_NAME\", \"mysite-com\")\nfull_app_name = f\"{environment_name}-{base_app_name}\"  # dev-mysite-com\naws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n\n\napp = core.App()\nstack = ApplicationStack(\n    app,\n    f\"{full_app_name}-stack\",\n    environment_name=environment_name,\n    base_domain_name=base_domain_name,\n    full_domain_name=full_domain_name,\n    base_app_name=base_app_name,\n    full_app_name=full_app_name,\n    env={\"region\": aws_region},\n)\n\n# in order to be able to tag ECS resources, you need to go to\n# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n# and enable at least Service and Task. Optionally enable\n# CloudWatch Container Insights\nstack.node.apply_aspect(core.Tag(\"StackName\", full_app_name))\nstack.node.apply_aspect(core.Tag(\"StackName\", base_app_name))\n\napp.synth()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/usr/bin/env python3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" aws_cdk "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" core\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awscdk.cdk_app_root "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ApplicationStack\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# naming conventions, also used for ACM certs, DNS Records, resource naming\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Dynamically generated resource names created in CDK are used in GitLab CI\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# such as cluster name, task definitions, etc.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ENVIRONMENT'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'dev'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DOMAIN_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mysite.com\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# if the the production environent subdomain should nott be included in the URL\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# redefine `full_domain_name` to `base_domain_name` for that environment\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_domain_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # dev.mysite.com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# if environment_name == \"prod\":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#     full_domain_name = base_domain_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"APP_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mysite-com\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # dev-mysite-com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_region "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"AWS_DEFAULT_REGION\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"us-east-1\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" core.App()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ApplicationStack(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    app,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-stack\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    base_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    full_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_domain_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    base_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    env"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"region\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": aws_region},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# in order to be able to tag ECS resources, you need to go to\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# and enable at least Service and Task. Optionally enable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# CloudWatch Container Insights\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack.node.apply_aspect(core.Tag("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"StackName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", full_app_name))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack.node.apply_aspect(core.Tag("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"StackName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", base_app_name))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app.synth()\n"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"using-cdk-synth-in-development"},"children":[{"type":"text","value":"Using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" in development"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I first started using CDK, I defined a root stack containing multiple CDK constructs that each included groups of related CDK resources. For example, I had an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RDSConstruct"}]},{"type":"text","value":" that contained a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Secret"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StringParameter"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnSecurityGroup"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBSubnetGroup"}]},{"type":"text","value":" and a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBCluster"}]},{"type":"text","value":". Whenever I added a new section of CDK code, I would run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth > stack.yml"}]},{"type":"text","value":" to generate a \"snapshot\" of my infrastructure in one file. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" was committed in my repo, and I could easily see how changes in CDK code changed the resulting CloudFormation YAML by repeating this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"h3","props":{"id":"nestedstacks"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" grew larger and larger as I added more resources in my main \"master stack\" or \"skeleton stack\", and I realized that I was going to reach the hard limit of 200 resources per CloudFormation stack. Refactoring to use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s was pretty straightforward, all I had to do was replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"core.Construct"}]},{"type":"text","value":" with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cloudformation.NestedStack"}]},{"type":"text","value":". With nested stacks, running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth > stack.yml"}]},{"type":"text","value":" references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS::CloudFormation::Stack"}]},{"type":"text","value":"s that are created, with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TemplateURL"}]},{"type":"text","value":" and parameters from other stacks. It is more useful to look into contents of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":" when working with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s. The following command (executed from the root of the project) update the contents of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/cdk.out"}]},{"type":"text","value":" directory with templates for each of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The result is JSON, not YAML, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":"d, but it can still be helpful in verifying that your CDK code is generating the correct CloudFormation templates. ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk diff"}]},{"type":"text","value":" may be the best option for seeing how CDK code changes will change your infrastructure)."}]},{"type":"element","tag":"h3","props":{"id":"cdk-deploy-and-cdk-in-gitlab-ci-pipelines"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" and CDK in GitLab CI pipelines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like how "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tail"}]},{"type":"text","value":"s the output of CloudFormation events until the stack update finishes or fails. I previously had been using the AWS CLI to call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws cloudformation update-stack"}]},{"type":"text","value":". This command kicks off a stack update and the GitLab pipeline will succeed regardless of the success of failure of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"update-stack"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With CDK, the CI pipeline that calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" fails if "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" results in a stack rollback."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I couldn't find any examples of how to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" in a GitLab CI pipeline (using the Python version of CDK, or any version of CDK). It would be nice if there was an official image maintained for the different languages that are ready to run CDK deploy. Here's how I got "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" working correctly in my CI/CD pipline:"}]},{"type":"element","tag":"pre","props":{"code":"cdk deploy:\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  stage: deploy\n  only:\n    - master\n  variables:\n    ENVIRONMENT: dev\n    DOCKER_TLS_CERTDIR: ''\n  before_script:\n    - apk add nodejs-current npm\n    - npm i -g aws-cdk\n    - apk add --no-cache python3\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  only"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"master\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  variables"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    ENVIRONMENT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"dev\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    DOCKER_TLS_CERTDIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk add nodejs-current npm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"npm i -g aws-cdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk add --no-cache python3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip3 install -e awscdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk deploy --app awscdk/app.py --require-approval never\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have all of my CDK code in a top level directory called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk"}]},{"type":"text","value":", my Django code is in the top level "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory and my frontend code is in the top level "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"quasar"}]},{"type":"text","value":" directory. This directory structure is important, I'll come back to it shortly. Here are some things to note about this GitLab CI job definition:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It uses the base "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" image with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker:dind"}]},{"type":"text","value":" as a dependent service. This is necessary only if you hare using CDK constructs that build docker images and make use of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":", such as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_ecs.AssetImage"}]},{"type":"text","value":" that I use to define "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.image"}]},{"type":"text","value":" in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":" class that defines that main stack of my application."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It requires node, npm python and pip, so these all need to be installed via "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apk"}]},{"type":"text","value":", the package manager for Alpine Linux. These are done in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":", the setup for the main \"script\" where "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" is called."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The main "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"script"}]},{"type":"text","value":" section calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":". You only need to call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" once to initialize resources that CDK will use, so placing it here in my CI script is more of a reminder that we are using CDK assets (S3 buckets and ECR images); calling it again once it has been called initially on your AWS account does nothing, and you will see a message that communicates this:"}]}]},{"type":"element","tag":"pre","props":{"code":" $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n    Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n    Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n"}]}]},{"type":"element","tag":"h3","props":{"id":"cdk-bootstap"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstap"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" is one of my favorite features of CDK. As I mentioned earlier, it is used with S3 and ECR."}]},{"type":"element","tag":"h4","props":{"id":"s3-assets"},"children":[{"type":"text","value":"S3 Assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With S3, it allows you to populate the contents of an S3 bucket. Here's an example from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"        if os.path.isdir(\"./quasar/dist/pwa\"):\n            s3_deployment.BucketDeployment(\n                self,\n                \"BucketDeployment\",\n                destination_bucket=self.static_site_bucket,\n                sources=[s3_deployment.Source.asset(\"./quasar/dist/pwa\")],\n                distribution=self.cloudfront.distribution,\n            )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.path.isdir("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./quasar/dist/pwa\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            s3_deployment.BucketDeployment(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"                self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"BucketDeployment\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                destination_bucket"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".static_site_bucket,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                sources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[s3_deployment.Source.asset("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./quasar/dist/pwa\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                distribution"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".cloudfront.distribution,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the directory "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./quasar/dist/pwa"}]},{"type":"text","value":" exists, CDK will upload the contents of that directory to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_bucket"}]},{"type":"text","value":" and then invalidate the cache for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.cloudfront.distribution"}]},{"type":"text","value":", all in one shot. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./quasar/dist/pwa"}]},{"type":"text","value":" is the directory where assets from my frontend PWA are placed when compiled. GitLab CI passes these files between the jobs using artifacts:"}]},{"type":"element","tag":"pre","props":{"code":"artifacts:\n  paths:\n    - quasar/dist/pwa\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"artifacts"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  paths"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"quasar/dist/pwa\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The job to build PWA assets can be set to only run when there are changes in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"quasar"}]},{"type":"text","value":" directory, so the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".quasar/dist/pwa"}]},{"type":"text","value":" directory will only exist if the job is executed. This helps speed up our CI/CD pipeline."}]},{"type":"element","tag":"h4","props":{"id":"ecr-assets"},"children":[{"type":"text","value":"ECR Assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk boostrap"}]},{"type":"text","value":" and CDK assets in a similar way for building and pushing my application container. In "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", I define the following:"}]},{"type":"element","tag":"pre","props":{"code":"        self.image = ecs.AssetImage(\n            \"./backend\", file=\"scripts/prod/Dockerfile\", target=\"production\",\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".image "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ecs.AssetImage(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"./backend\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"scripts/prod/Dockerfile\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"target"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"production\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This image is then referenced by multiple "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s that define Fargate services and tasks ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gunicorn"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"daphne"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery"}]},{"type":"text","value":" workers, etc.) This keeps our CDK code DRY.. Don't Repeat Yourself! Similarly, we aren't rebuilding, pushing and pulling the backend container when there are no changes to the code in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not setting up an ECR image repository for my application, but I believe there is a way to do this. One question that I have about using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs.AssetImage"}]},{"type":"text","value":" is about image lifecycle management. I know that you can implement rules about how many images you want to keep in an ECR image repository, but "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"I'm not sure how this works with CDK Image Assets"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"quick-tour-of-applicationstack"},"children":[{"type":"text","value":"Quick tour of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a very quick look at the structure of my CDK code, focusing on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", the \"master stack\" or \"skeleton stack\" that contains."}]},{"type":"element","tag":"h4","props":{"id":"hosted_zone"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"hosted_zone"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We get the hosted zone using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":". This is not a nested stack."}]},{"type":"element","tag":"h4","props":{"id":"site_certificate"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"site_certificate"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The ACM Certificate that will be used for the given environment. This references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":" (environment + application)."}]},{"type":"element","tag":"h4","props":{"id":"vpc_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":" for defining VPC resources. This construct generates lots of CloudFormation resources. I currently have "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nat_gateways"}]},{"type":"text","value":" set to zero, and I'm "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PUBLIC"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PRIVATE"}]},{"type":"text","value":" subnets spread over 2 AZs. As I mentioned earlier, this is primarily for cost considerations and it is a best practice to use the tiered security model and run our Fargate tasks in private subnets instead of public subnets. I think I need to add NACL resources in this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"alb_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alb_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This defines the load balancer, configures that will send traffic to our Fargate services (such as our Django API). I was a little bit unclear about needing a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listener"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":". I might be able to get away with removing the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listener"}]},{"type":"text","value":" and only using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"static_site_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the S3 bucket and policies that will be used for hosting our static site (Quasar PWA)."}]},{"type":"element","tag":"h4","props":{"id":"backend_assets"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_assets"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the bucket and policies for managing the bucket that holds static and media assets for Django."}]},{"type":"element","tag":"h4","props":{"id":"cloudfront"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cloudfront"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This defines the CloudFront distribution that ties together several different parts of the application. It is the \"front desk\" of the application, and acts as a CDN and proxy. There is a separate CloudFront distribution for each environment (dev, staging, production). This stack also defines the Route53 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ARecord"}]},{"type":"text","value":" that will be used to send traffic to a specific subdomain to the correct CloudFront distribution."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are three "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"origin_configs"}]},{"type":"text","value":" for each distribution:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomOriginConfig"}]},{"type":"text","value":" for the ALB"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomOriginConfig"}]},{"type":"text","value":" for the S3 bucket website"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"S3OriginConfig"}]},{"type":"text","value":" for the Django static assets"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note that these "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"origin_configs"}]},{"type":"text","value":" each have different "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"behaviors"}]},{"type":"text","value":", and that list comprehension is used to keep this code DRY."}]},{"type":"element","tag":"h4","props":{"id":"bucketdeployment"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"BucketDeployment"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will deploy our static site assets to the S3 bucket defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_stack"}]},{"type":"text","value":" if the static site assets are present at the time of deployment. If they are not present, this means that there were no changes made to the frontend site."}]},{"type":"element","tag":"h4","props":{"id":"ecs"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Defines the ECS Cluster."}]},{"type":"element","tag":"h4","props":{"id":"rds"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rds"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is no L2 construct for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DBCluster"}]},{"type":"text","value":", so I used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBCluster"}]},{"type":"text","value":" in order to use the Aurora Postgres "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"engine"}]},{"type":"text","value":" and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"serverless"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"engine_mode"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"elasticache"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"elasticache"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also had to use L1 constructs for ElastiCache, but this one is pretty straightforward."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For both RDS and ElastiCache I used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_default_security_group"}]},{"type":"text","value":" as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"source_security_group"}]},{"type":"text","value":". It might be a better idea to define another security group altogether, but this approach works."}]},{"type":"element","tag":"h4","props":{"id":"assetimage"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AssetImage"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The docker image that references Django application code in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory. This image is referenced in Fargate services and tasks."}]},{"type":"element","tag":"h4","props":{"id":"variables"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"variables"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section defines and organizes all of the environment variables and secrets for my application."}]},{"type":"element","tag":"h4","props":{"id":"backend_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It might be a better idea to replace this with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NetworkLoadBalancedFargateService"}]},{"type":"text","value":", but instead I implemented this with lower-level constructs just to be clear about what I'm doing. To add a load balanced service, here is what I did:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the container to this task with other information (secrets, logging, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"command"}]},{"type":"text","value":", etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Give the task role permissions it needs such as access to Secrets, S3 permissions. (It might be a good idea to refactor this into a function that can be called on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"task_role"}]},{"type":"text","value":", but for now I am explicitly granting all permissions)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create and add a port mapping"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define an ECS Fargate Service that reference the previously defined Fargate task, configure security group"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the service as a target to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":" defined previously in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alb_stack"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Optionally configure autoscaling for the Fargate service"}]}]},{"type":"element","tag":"h4","props":{"id":"flower_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"flower_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Flower is a monitoring utility for Celery. I had trouble getting this to work correctly, but I managed to make it work by adding a simple nginx container that passes traffic to the flower container running in the same task. "},{"type":"element","tag":"a","props":{"href":"https://flower.readthedocs.io/en/latest/reverse-proxy.html","rel":["nofollow"]},"children":[{"type":"text","value":"https://flower.readthedocs.io/en/latest/reverse-proxy.html"}]}]},{"type":"element","tag":"h4","props":{"id":"celery_default_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery_default_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the default celery queue. This is discussed later in more detail, but the basic idea is to:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the container"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate service"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Grant permissions"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Configure autoscaling"}]}]},{"type":"element","tag":"h4","props":{"id":"celery_autoscaling"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery_autoscaling"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the Lambda function and schedule on which this Lambda is called. This stack is discussed in more detail later on."}]},{"type":"element","tag":"h4","props":{"id":"backend_tasks"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_tasks"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are administrative tasks that are executed by running manual GitLab CI jobs such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"why-x-why-not-y"},"children":[{"type":"text","value":"Why "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"X"}]},{"type":"text","value":"? Why not "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Y"}]},{"type":"text","value":"?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section will compare some of the technology choices I have made in this project to other popular alternatives."}]},{"type":"element","tag":"h3","props":{"id":"why-ecs-why-not-kubernetes"},"children":[{"type":"text","value":"Why ECS? Why not Kubernetes?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like Kubernetes. I have never used it to support production workloads, but I have explored it in a limited capacity. I have set up this project in Kubernetes locally using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"minikube"}]},{"type":"text","value":", there is an article on this in the documentation. There are also lots of options for how you do Kubernetes, here are a few off of the top of my head:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"KOPS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"EKS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"k3s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"cdk8s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Kubernetes on Fargate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"\"Kuberetes the Hard Way\""}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With any of these options you are probably going to want to use Helm to do deployments, which adds another layer of abstraction that also has several different ways to be managed. On the other hand, ECS is \"just ECS\"; there are not a lot of other considerations to make when running workloads in ECS. You have to choose between the two available launch types: EC2 and Fargate. Comparisons of ECS and Kubernetes often mention that ECS integrates nicely with other AWS Services, something I have generally found to be true in setting up this project. Granting permissions to S3 buckets or CloudWatch, or using security groups to give ECS tasks access to certain resources in your VPC are some examples of what this \"tight integration\" has meant for me so far."}]},{"type":"element","tag":"h3","props":{"id":"why-django-why-not-flask"},"children":[{"type":"text","value":"Why Django? Why not Flask?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like Django for lots of reasons. I get why people say it can be \"overkill\", and there are definitely lots of parts of Django that don't use. I use Django primarily for the ORM, migrations system and the Django Admin. I also use the Django REST Framework, which gives me another big productivity boost when building APIs. I dislike Django Forms and Django templates, but that wasn't always the case. Before that, I disliked JavaScript frameworks and single page applications. That changes when I started working with Vue.js and Quasar."}]},{"type":"element","tag":"h3","props":{"id":"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react"},"children":[{"type":"text","value":"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Quasar Framework is a few different things, and just like Vue.js itself, Quasar can be incrementally adopted. Primarily, Quasar is a CLI for creating Vue.js projects. It offers some opinions on how to organize files and folders. It handles SPA, PWA, SSR, Electron, Cordova and other build targets. It implements the MaterialUI spec and it has an awesome and active community (but Django, GitLab and AWS do, too!)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Quasar does things a little bit differently than vanilla Vue.js. There is no "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main.js"}]},{"type":"text","value":" file in a typical Quasar application. Instead, bootfiles are used to initialize things that would typically go into "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main.js"}]},{"type":"text","value":". I believe this helps Quasar manage multiple build targets easily."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I really haven't worked a lot with Nuxt.js, but I would probably be drawn to it if Quasar was not an option. I like how it helps structure your application. In the same way that Django is \"batteries included\", Quasar is also very much \"batteries included\"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think React is neat, but I have similar feelings between React and Vue that I have between Django and Flask. One requires you make more decisions and therefore has a heavy mental load. The biggest example of this is the tight integration of an official router and state management system for Vue ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vue-router"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vuex"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h3","props":{"id":"why-celery-why-not-heuy-or-django-rq"},"children":[{"type":"text","value":"Why Celery? Why not Heuy or django-rq?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think celery is probably the most heavy-weight option for managing asynchronous tasks in Django. It is very flexible and \"pluggable\" which makes it slightly more challenging to get setup. I would be interested in trying another option, but celery is a mature option that has a large community of users."}]},{"type":"element","tag":"h2","props":{"id":"scaling-celery-workers-to-zero"},"children":[{"type":"text","value":"Scaling Celery workers to zero"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Django is used in a few different ways in this application:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a backend API supported by Django REST Framework, Postgres and static files stored in AWS S3, served over CloudFront"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a websocket server supported by Django Channels"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"an administrative backend that is automatically generated by Django (Django Admin)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"asynchronous task workers supported by Celery"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The API server, websocket server and Django admin can technically be served by the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"daphne"}]},{"type":"text","value":" process. In terms of our application and AWS architecture, this means that requests for URLs starting with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/ws/"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/"}]},{"type":"text","value":" can all be sent to the same Fargate service target group."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alternatively, we could split these up into two or three different process that can then be scaled individually."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Celery processes should be run as separate processes. If you have multiple queues, you may have workers that are dedicated to processing tasks from certain queues which run as individual Fargate tasks, each with certain CPU and memory allocations and other celery settings, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max_concurrency"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To manage the total cost of ownership, I wanted to know how to scale Celery workers between 0 and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"N"}]},{"type":"text","value":". A celery worker is typically an \"always on\" process that watches for new messages that arrive in the queue and then processes message specified (the messages delivered to the queue contain information on which function to call, and what arguments that function should be called with."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's image that we have a celery task to process with the following properties:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It takes a long time to process (between 15 minutes and 1 or 2 hours)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It has lots of dependencies (such as pandas, scikit-learn, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It requires a high amount of CPU and memory"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It cannot easily be broken down into smaller sub-tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The time and frequency at which this task will be called is not predictable"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A 2 - 3 minute delay between calling the task and starting work on the task is acceptable"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This task might not be very easy to process with AWS Lambda without lots of additional logic, if not impossible."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To manage our project's TCO, we want scale down the number of Fargate tasks that process the queue this task is sent to. If there are no messages queued for this worker and no messages currently being processed by any of the workers for the queue, the number of Fargate tasks (celery workers) should be scaled down."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I haven't done much with autoscaling on AWS before, but I found that CDK provides some very nice abstractions that make scaling with Fargate task very straightforward."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ECS allows you to scale based on some built in metrics, such as CPU Utilization. Scaling between 0 and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"N"}]},{"type":"text","value":" workers based on CPU utilization metrics wouldn't work because there would be no CPU utilization after the Fargate tasks are scaled to zero; messages in the queue would remain unprocessed and no new workers would be brought online."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the number of tasks in the queue would be a better option. I tried a few different options to get this to work."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, I tried using one of the high-level constructs (L3 construct) from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs_patterns"}]},{"type":"text","value":" called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"QueueProcessingFargateService"}]},{"type":"text","value":", but this would require that I replace Redis with SQS as the broker to be used with Celery. Some people prefer to use SQS, but I like having the ability to inspect and control, which requires a broker like Redis and is not possible with SQS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My current solution involves:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Creating a CloudWatch metric (the namespace is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FULL_APP_NAME"}]},{"type":"text","value":" and the metric name is the name of the queue, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"default"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"auto_scale_task_count"}]},{"type":"text","value":" on the Fargate service to create a an \"autoscaling Fargate task\""}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"scale_on_metric"}]},{"type":"text","value":" on the \"autoscaling Fargate task\" with the CloudWatch metric created in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"1"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery-metrics"}]},{"type":"text","value":" API endpoint on my Django API server that, when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POST"}]},{"type":"text","value":"ed to, collects celery metrics per queue and publishes these metrics to CloudWatch."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Scheduling a Lambda function to post to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery-metrics"}]},{"type":"text","value":" endpoint every 5 minutes."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code that takes care of steps 1, 2 and 3:"}]},{"type":"element","tag":"pre","props":{"code":"        self.default_celery_queue_cw_metric = cw.Metric(\n            namespace=scope.full_app_name, metric_name=\"default\"\n        )\n\n        self.celery_default_queue_asg = self.celery_default_worker_service.auto_scale_task_count(\n            min_capacity=0, max_capacity=2\n        )\n\n        self.celery_default_queue_asg.scale_on_metric(\n            \"CeleryDefaultQueueAutoscaling\",\n            metric=self.default_celery_queue_cw_metric,\n            scaling_steps=[\n                aas.ScalingInterval(change=-1, lower=0),\n                aas.ScalingInterval(change=1, lower=1),\n            ],\n            adjustment_type=aas.AdjustmentType.CHANGE_IN_CAPACITY,\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".default_celery_queue_cw_metric "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cw.Metric(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            namespace"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"metric_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"default\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_queue_asg "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_worker_service.auto_scale_task_count(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            min_capacity"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_capacity"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_queue_asg.scale_on_metric(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryDefaultQueueAutoscaling\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            metric"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".default_celery_queue_cw_metric,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            scaling_steps"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                aas.ScalingInterval("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"change"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lower"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                aas.ScalingInterval("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"change"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lower"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            adjustment_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aas.AdjustmentType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CHANGE_IN_CAPACITY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Step 4 inspects active and reserved tasks, filters the tasks by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"routing_key"}]},{"type":"text","value":" (which is the same as the queue name) and the combines this with any queued tasks by calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"llen(queue_name)"}]},{"type":"text","value":". Finally, the queue names and combined active, reserved and queued task totals are sent to CloudWatch via boto3. The code for this is in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend/apps/core/utils/celery_utils.py"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code for the Lambda function in step 5:"}]},{"type":"element","tag":"pre","props":{"code":"import json\nimport os\nimport urllib.request\n\nFULL_DOMAIN_NAME = os.environ.get(\"FULL_DOMAIN_NAME\")\nCELERY_METRICS_PATH = \"api/celery-metrics/\"\n\nCELERY_METRICS_URL = f\"https://{FULL_DOMAIN_NAME}/{CELERY_METRICS_PATH}\"\nCELERY_METRICS_TOKEN = os.environ.get(\"CELERY_METRICS_TOKEN\")\n\n\ndef lambda_handler(event, context):\n    data = {\"celery_metrics_token\": CELERY_METRICS_TOKEN}\n    params = json.dumps(data).encode('utf8')\n    req = urllib.request.Request(\n        CELERY_METRICS_URL,\n        data=params,\n        headers={'content-type': 'application/json'},\n    )\n    response = urllib.request.urlopen(req)\n    return response.read()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"FULL_DOMAIN_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FULL_DOMAIN_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_PATH"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"api/celery-metrics/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{FULL_DOMAIN_NAME}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{CELERY_METRICS_PATH}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_TOKEN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"CELERY_METRICS_TOKEN\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" lambda_handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    data "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"celery_metrics_token\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_TOKEN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    params "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json.dumps(data).encode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'utf8'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    req "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request.Request(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"        CELERY_METRICS_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        headers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'content-type'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'application/json'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request.urlopen(req)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.read()\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, here is the code for defining the lambda function and scheduled invocation of the lambda function:"}]},{"type":"element","tag":"pre","props":{"code":"class CeleryAutoscalingStack(cloudformation.NestedStack):\n    def __init__(self, scope: core.Construct, id: str, **kwargs) -> None:\n        super().__init__(\n            scope, id, **kwargs,\n        )\n\n        self.lambda_function = aws_lambda.Function(\n            self,\n            \"CeleryMetricsLambdaFunction\",\n            code=aws_lambda.Code.asset(\"awslambda\"),\n            handler=\"publish_celery_metrics.lambda_handler\",\n            runtime=aws_lambda.Runtime.PYTHON_3_7,\n            environment=scope.variables.regular_variables,\n        )\n\n        self.celery_default_cw_metric_schedule = events.Rule(\n            self,\n            \"CeleryDefaultCWMetricSchedule\",\n            schedule=events.Schedule.rate(core.Duration.minutes(5)),\n            targets=[\n                events_targets.LambdaFunction(handler=self.lambda_function)\n            ],\n        )\n\n        # TODO: refactor this to loop through CloudWatch metrics multiple celery queues\n        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n            scope.backend_service.backend_task.task_role\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" CeleryAutoscalingStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"cloudformation"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"NestedStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" __init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"scope"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": core.Construct, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"kwargs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") -> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        super"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"__init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            scope, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kwargs,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_function "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" aws_lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryMetricsLambdaFunction\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_lambda.Code.asset("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"awslambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"publish_celery_metrics.lambda_handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.variables.regular_variables,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_cw_metric_schedule "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" events.Rule(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryDefaultCWMetricSchedule\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            schedule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"events.Schedule.rate(core.Duration.minutes("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            targets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                events_targets.LambdaFunction("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_function)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":": refactor this to loop through CloudWatch metrics multiple celery queues\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            scope.backend_service.backend_task.task_role\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"miscellaneous-grievances"},"children":[{"type":"text","value":"Miscellaneous Grievances"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fargate tasks cannot access Secrets that use JSON template"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You cannot select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FARGATE_SPOT"}]},{"type":"text","value":" on a CDK-created ECS cluster. This option seems to only be available from the ECS Wizard in the AWS Console"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It's not super clear how to package dependencies in Lambda with CDK. Here's an interesting approach that I would like to try: "},{"type":"element","tag":"a","props":{"href":"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487"}]},{"type":"text","value":". The Lambda functions I'm using don't require anything outside of the standard library, but if they did it would require some additional work to make sure dependencies can be added as Lambda Layers."}]}]},{"type":"element","tag":"h2","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create an IAM role template that can be used to create an IAM role that has access to setup infrastructure through CDK. Currently I'm using an admin account which is not a best practice."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Move this Wiki Article to the project documentation site and main README"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Expand on each topic, replace existing documentation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add a summary of each "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":" from CDK code"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"development-philosophies-and-best-practices","depth":2,"text":"Development Philosophies and Best Practices"},{"id":"topics","depth":2,"text":"Topics","children":[{"id":"legend","depth":3,"text":"Legend"},{"id":"local-development","depth":3,"text":"Local development"},{"id":"gitlab-ci","depth":3,"text":"GitLab CI"},{"id":"aws","depth":3,"text":"AWS"},{"id":"django-application","depth":3,"text":"Django Application"},{"id":"vuejs-application","depth":3,"text":"Vue.js application"},{"id":"aws-django-vuejs","depth":3,"text":"AWS  Django  Vue.js"},{"id":"sample-application-logic","depth":3,"text":"Sample application logic"},{"id":"testing","depth":3,"text":"Testing"},{"id":"caveats-questions-confusion-and-footnotes","depth":3,"text":"Caveats, Questions, Confusion and Footnotes"}]},{"id":"my-experience-with-aws-cdk","depth":2,"text":"My experience with AWS CDK","children":[{"id":"start-here-httpscdkworkshopcom","depth":3,"text":"Start here: https://cdkworkshop.com"},{"id":"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing","depth":3,"text":"The stack is defined by a small number of inputs used for namespacing"},{"id":"using-cdk-synth-in-development","depth":3,"text":"Using cdk synth in development"},{"id":"nestedstacks","depth":3,"text":"NestedStacks"},{"id":"cdk-deploy-and-cdk-in-gitlab-ci-pipelines","depth":3,"text":"cdk deploy and CDK in GitLab CI pipelines"},{"id":"cdk-bootstap","depth":3,"text":"cdk bootstap"},{"id":"quick-tour-of-applicationstack","depth":3,"text":"Quick tour of ApplicationStack"}]},{"id":"why-x-why-not-y","depth":2,"text":"Why X? Why not Y?","children":[{"id":"why-ecs-why-not-kubernetes","depth":3,"text":"Why ECS? Why not Kubernetes?"},{"id":"why-django-why-not-flask","depth":3,"text":"Why Django? Why not Flask?"},{"id":"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react","depth":3,"text":"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?"},{"id":"why-celery-why-not-heuy-or-django-rq","depth":3,"text":"Why Celery? Why not Heuy or django-rq?"}]},{"id":"scaling-celery-workers-to-zero","depth":2,"text":"Scaling Celery workers to zero"},{"id":"miscellaneous-grievances","depth":2,"text":"Miscellaneous Grievances"},{"id":"todo","depth":2,"text":"TODO"}]}},"_type":"markdown","_id":"content:2020:06:02:django-postgres-vue-gitlab-ecs.md","_source":"content","_file":"2020/06/02/django-postgres-vue-gitlab-ecs.md","_stem":"2020/06/02/django-postgres-vue-gitlab-ecs","_extension":"md"},{"_path":"/2019/01/09/django-docker-vue-nginx-drf-traefik-celery","_dir":"09","_draft":false,"_partial":false,"_locale":"","title":"Setup, Development and Deployment of a web app using Django, VueJS, VuePress, Docker, nginx, traefik and GitLab","description":"This project is currently deployed on https://verbose-equals-true.tk. The source code is available at https://gitlab.com/briancaffey/verbose-equals-true.","layout":"post","date":"2019-01-09T00:00:00.000Z","comments":true,"image":"/static/technologies.png","tags":["django","vue","docker","gitlab"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This project is currently deployed on "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.tk","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.tk"}]},{"type":"text","value":". The source code is available at "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/verbose-equals-true","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/verbose-equals-true"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The goal of this project is to explain how to setup a project starting with a fresh installation of 16.04. Setup includes local development environment, GitLab CI/CD, VSCode settings and configuration of the different containers that make up the application:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Node (for local development with VueJS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"nginx"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Traefik"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Postgres"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Celery"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"flower"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"portainer"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an overview of the architecture used in the application:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/architecture.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Extensive documentation for this project can be found at "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.tk/docs","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.tk/docs"}]},{"type":"text","value":"."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:2019:01:09:django-docker-vue-nginx-drf-traefik-celery.md","_source":"content","_file":"2019/01/09/django-docker-vue-nginx-drf-traefik-celery.md","_stem":"2019/01/09/django-docker-vue-nginx-drf-traefik-celery","_extension":"md"},{"_path":"/2018/04/26/generating-music-from-guitar-tabs-with-python","_dir":"26","_draft":false,"_partial":false,"_locale":"","title":"Generating MIDI files from guitar tablatures with Python and regular expressions","description":"Recently I have been playing lots of classical guitar. I use classtab.org, a website with hundreds of classical guitar pieces in tab form. Here's an example of a guitar tab:","layout":"post","date":"2018-04-26T00:00:00.000Z","comments":true,"image":"/static/guitar.jpg","tags":["midi","python","regex","guitar","music"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Recently I have been playing lots of classical guitar. I use "},{"type":"element","tag":"a","props":{"href":"classtab.org"},"children":[{"type":"text","value":"classtab.org"}]},{"type":"text","value":", a website with hundreds of classical guitar pieces in tab form. Here's an example of a guitar tab:"}]},{"type":"element","tag":"pre","props":{"code":"|---------------0---|---3-2-3-----------|-----0-------------|\n|-------0-3-1-1---3-|-3-------3-0-----0-|-1-3---3-1-0---0---|\n|---0-2-0-----------|-------------0-2---|-------------2---0-|\n|-------------2-----|-------2-----------|-------------------|\n|-------------------|-2-----------------|-0-----2-----3-----|\n|-3-----------------|-------------0-----|-------------------|\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"|---------------0---|---3-2-3-----------|-----0-------------|\n|-------0-3-1-1---3-|-3-------3-0-----0-|-1-3---3-1-0---0---|\n|---0-2-0-----------|-------------0-2---|-------------2---0-|\n|-------------2-----|-------2-----------|-------------------|\n|-------------------|-2-----------------|-0-----2-----3-----|\n|-3-----------------|-------------0-----|-------------------|\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is a representation of where and when strings are played. The six lines here represent the six strings of the guitar e, A, D, G, B and E and the numbers indicate where on the fretboard to press for each note. The vertical bars represent one bar of music."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My goal is to write an application that can read in guitar tabs and then produce a corresponding MIDI file for the song."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To start, I will use regular expressions to parse the bars of music in a guitar tab text file."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, I will use a Python package called MIDIUtil to generate "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".mid"}]},{"type":"text","value":" files from the guitar tabs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, I'll put this into a simple web app that lets users copy paste guitar tab text or enter a URL from a site like classtab.org that will similarly generate a MIDI file."}]},{"type":"element","tag":"h2","props":{"id":"regex"},"children":[{"type":"text","value":"Regex"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, let's look at a few different examples of guitar tabs to get a better sense of what our goal should be in using regular expressions to parse notes."}]},{"type":"element","tag":"h3","props":{"id":"tab-examples"},"children":[{"type":"text","value":"Tab examples"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.classtab.org/barrios_la_catedral_3_allegro.txt","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.classtab.org/barrios_la_catedral_3_allegro.txt"}]}]},{"type":"element","tag":"pre","props":{"code":"La Catedral\nAuthor: Agustin Barrios\nTablature by: Gianpiero Ciammaricone\n              giancian@yahoo.com\n              http://www.geocities.com/vienna/6619\n\nTablature Explanation at the end.\n\n[key corrected from \"D Major\" Jan 99]\n\nThis is Revision 3 (5/2/98), I have added a modification made by\nBarrios in line 5 of the TAB, both ways of playing it are included,\nso you can choose the best one for you.\nRevision 2: Made a few corrections.\nRevision 1: The first release of the tab.\n\n3rd Movement (Allegro):\nKey: B Minor\nTime signature: 6/8\n\nE-|-------------------------|-----------------------------|\nB-|-----------------3-------|-----------------3-----------|\nG-|---------0---4-------4---|---------0---4-------4-------|\nD-|---4-3h4---4---4---4---4-|---4-3h4---4---4---4---4-----|\nA-|-2-----------------------|-2---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n\nE-|-------------------------|-----------------------------|\nB-|-----------------3-------|-----------------3-----------|\nG-|---------2---4-------4---|---------2---4-------4-------|\nD-|---5-4h5---5---5---5---5-|---5-4h5---5---5---5---5-----|\nA-|-2-----------------------|-2---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n\nE-|-------------------------|-----------------------------|\nB-|-----------------5-------|-----------------5-----------|\nG-|---------4---6-------6---|---------4---6-------6-------|\nD-|---7-6h7---7---7---7---7-|---7-6h7---7---7---7---7-----|\nA-|-4-----------------------|-4---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"La Catedral\nAuthor: Agustin Barrios\nTablature by: Gianpiero Ciammaricone\n              giancian@yahoo.com\n              http://www.geocities.com/vienna/6619\n\nTablature Explanation at the end.\n\n[key corrected from \"D Major\" Jan 99]\n\nThis is Revision 3 (5/2/98), I have added a modification made by\nBarrios in line 5 of the TAB, both ways of playing it are included,\nso you can choose the best one for you.\nRevision 2: Made a few corrections.\nRevision 1: The first release of the tab.\n\n3rd Movement (Allegro):\nKey: B Minor\nTime signature: 6/8\n\nE-|-------------------------|-----------------------------|\nB-|-----------------3-------|-----------------3-----------|\nG-|---------0---4-------4---|---------0---4-------4-------|\nD-|---4-3h4---4---4---4---4-|---4-3h4---4---4---4---4-----|\nA-|-2-----------------------|-2---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n\nE-|-------------------------|-----------------------------|\nB-|-----------------3-------|-----------------3-----------|\nG-|---------2---4-------4---|---------2---4-------4-------|\nD-|---5-4h5---5---5---5---5-|---5-4h5---5---5---5---5-----|\nA-|-2-----------------------|-2---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n\nE-|-------------------------|-----------------------------|\nB-|-----------------5-------|-----------------5-----------|\nG-|---------4---6-------6---|---------4---6-------6-------|\nD-|---7-6h7---7---7---7---7-|---7-6h7---7---7---7---7-----|\nA-|-4-----------------------|-4---------------------------|\nE-|-------------------------|-----------------------------|\n    p m i   m i m i a i m i\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.classtab.org/moreno_torroba_siete_piezas_de_album_6_chisperada.txt","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.classtab.org/moreno_torroba_siete_piezas_de_album_6_chisperada.txt"}]}]},{"type":"element","tag":"pre","props":{"code":"SIETE PIEZAS DE ALBUM: VI. CHISPERADA\nAs recorded by Federico Moreno Torroba\n\nMusic by Federico Moreno Torroba\n\n|-----0-----0-|-----------0-|-----0-----0-|\n|---1-----0---|-----3-----0-|---1-----0---|\n|---2-----0---|---2-------1-|---2-----0---|\n|---2---------|---3---------|---2---------|\n|-0-----------|---------2---|-0-----------|\n|-------3-----|-1-----0-----|-------3-----|\n\n|-----------0-|-----0-----0-|-----------0-|-----------0--|\n|-----3-----0-|---1-----0---|-----3-----0-|-----3-----0--|\n|---2-------1-|---2-----0---|---2-------1-|---2-------1--|\n|---3---------|---2---------|---3---------|---3----------|\n|---------2---|-0-----------|-0-------2---|-0-------2----|\n|-1-----0-----|-------3-----|-------0-----|-------0------|\n\n|---------------0--|-0-----0-----|-1-----1-3p1-0---|\n|---1-0---------0--|-1-----------|---------------3-|\n|-2-----2-0-----1--|-2-----1-----|-2-----2---------|\n|-----------3------|-------------|-------0---------|\n|-3----------------|---0-0---2-2-|---3-3-----------|\n|-------------0----|-------------|-----------------|\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"SIETE PIEZAS DE ALBUM: VI. CHISPERADA\nAs recorded by Federico Moreno Torroba\n\nMusic by Federico Moreno Torroba\n\n|-----0-----0-|-----------0-|-----0-----0-|\n|---1-----0---|-----3-----0-|---1-----0---|\n|---2-----0---|---2-------1-|---2-----0---|\n|---2---------|---3---------|---2---------|\n|-0-----------|---------2---|-0-----------|\n|-------3-----|-1-----0-----|-------3-----|\n\n|-----------0-|-----0-----0-|-----------0-|-----------0--|\n|-----3-----0-|---1-----0---|-----3-----0-|-----3-----0--|\n|---2-------1-|---2-----0---|---2-------1-|---2-------1--|\n|---3---------|---2---------|---3---------|---3----------|\n|---------2---|-0-----------|-0-------2---|-0-------2----|\n|-1-----0-----|-------3-----|-------0-----|-------0------|\n\n|---------------0--|-0-----0-----|-1-----1-3p1-0---|\n|---1-0---------0--|-1-----------|---------------3-|\n|-2-----2-0-----1--|-2-----1-----|-2-----2---------|\n|-----------3------|-------------|-------0---------|\n|-3----------------|---0-0---2-2-|---3-3-----------|\n|-------------0----|-------------|-----------------|\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.classtab.org/moreno_torroba_sonatina_in_a_2_andante.txt","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.classtab.org/moreno_torroba_sonatina_in_a_2_andante.txt"}]}]},{"type":"element","tag":"pre","props":{"code":"Sonatina in A - II - Andante\n\nF. Moreno Torroba (1891-1982)\n\ntuning DADGBE\n\nE|-----2--3---5----------10--8--7-------|-----8----7^8^7-----------------------|\nB|-----3--5---7----------7--------------|-----8-----------10---------8---------|\nG|-----2---------------------9--7-------|-----9--------------------------11----|\nD|-----0--------------4-----------------|--------------------------10----------|\nA|-----0----------0---------------------|----------------------7---------------|\nD|-----0--------------------------------|-----0--------------------------------|\n\nE|--------------------------------------|--------------------------------------|\nB|------------------7--8^10-8---7^5-----|---5---------7-8-7-5-----5------------|\nG|--9^11^9----7--9------------------7---|---6-----------------7---6------------|\nD|-------8------------------------------|---5---------------------5--7----19--|\nA|-------10-----------------------------|------0--12--------------------------|\nD|-------0------------------------------|---0---------------------0------------|\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Sonatina in A - II - Andante\n\nF. Moreno Torroba (1891-1982)\n\ntuning DADGBE\n\nE|-----2--3---5----------10--8--7-------|-----8----7^8^7-----------------------|\nB|-----3--5---7----------7--------------|-----8-----------10---------8---------|\nG|-----2---------------------9--7-------|-----9--------------------------11----|\nD|-----0--------------4-----------------|--------------------------10----------|\nA|-----0----------0---------------------|----------------------7---------------|\nD|-----0--------------------------------|-----0--------------------------------|\n\nE|--------------------------------------|--------------------------------------|\nB|------------------7--8^10-8---7^5-----|---5---------7-8-7-5-----5------------|\nG|--9^11^9----7--9------------------7---|---6-----------------7---6------------|\nD|-------8------------------------------|---5---------------------5--7----19--|\nA|-------10-----------------------------|------0--12--------------------------|\nD|-------0------------------------------|---0---------------------0------------|\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are a few things that we need to consider:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The start of each line sometimes starts with a the note of the string ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"E"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"e"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"A"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"D"}]},{"type":"text","value":", etc.) followed by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" or just simply start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":". Some lines may start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"E-|"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"There is generally a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" character between each note. When this is not the case, we may have a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"p"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"h"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"^"}]},{"type":"text","value":" which indicates \"pull off\" or \"hammer on\". This means that you are playing the string with the hand on the fretboard, not the hand over the sound hole. We should replace these with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A tab may have an inconsistant number of characters in each bar. I'm not too concerned about this. I'm not going for perfection just yet, but it could make this task very difficult if you want to get the timing of your sounds just right."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Notes played on the 10th fret and higher must be read together. For example, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"---12---"}]},{"type":"text","value":" should be played on the 12 fret; it does not mean play "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" and then play "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"2"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"There are some other special characters such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":""}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"/"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":">"}]},{"type":"text","value":". I think these both denote harmonics. This is when you place your finger on the string at a position along the fretboard, but do not press down. We probably want to replace these characters with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" as well."}]}]},{"type":"element","tag":"h3","props":{"id":"tab-text-file-processing"},"children":[{"type":"text","value":"Tab text file processing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some things that may be helpful to do as soon as we read a text file:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"convert everything to upper or lower case"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"replace non-numeric characters with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I work with regex, I usually go straight to "},{"type":"element","tag":"a","props":{"href":"regex101.com"},"children":[{"type":"text","value":"regex101.com"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"midiutil"},"children":[{"type":"text","value":"MIDIUtil"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At this point, I think it will be helpful to examine MIDIUtil and create and play a basic MIDI file."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before you do that, you might want to read over the "},{"type":"element","tag":"a","props":{"href":"https://wiki.archlinux.org/index.php/MIDI","rel":["nofollow"]},"children":[{"type":"text","value":"MIDI Arch Wiki article"}]},{"type":"text","value":"."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"MIDIUtil is a pure Python library that allows one to write multi-track Musical Instrument Digital Interface (MIDI) files from within Python programs (both format 1 and format 2 files are now supported). It is object-oriented and allows one to create and write these files with a minimum of fuss."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a basic example of MIDIUtil. This script generates a MIDI file that contains a major scale."}]},{"type":"element","tag":"pre","props":{"code":"#!/usr/bin/env python\n\nfrom midiutil import MIDIFile\n\ndegrees  = [60, 62, 64, 65, 67, 69, 71, 72]  # MIDI note number\ntrack    = 0\nchannel  = 0\ntime     = 0    # In beats\nduration = 1    # In beats\ntempo    = 60   # In BPM\nvolume   = 100  # 0-127, as per the MIDI standard\n\nMyMIDI = MIDIFile(1)  # One track, defaults to format 1 (tempo track is created\n                      # automatically)\nMyMIDI.addTempo(track, time, tempo)\n\nfor i, pitch in enumerate(degrees):\n    MyMIDI.addNote(track, channel, pitch, time + i, duration, volume)\n\nwith open(\"major-scale.mid\", \"wb\") as output_file:\n    MyMIDI.writeFile(output_file)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/usr/bin/env python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" midiutil "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"degrees  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"62"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"64"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"65"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"67"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"69"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"71"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"72"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# MIDI note number\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"track    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"channel  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"time     "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"duration "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tempo    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"   # In BPM\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"volume   "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 100"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # 0-127, as per the MIDI standard\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# One track, defaults to format 1 (tempo track is created\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"                      # automatically)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI.addTempo(track, time, tempo)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" enumerate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(degrees):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    MyMIDI.addNote(track, channel, pitch, time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, duration, volume)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"major-scale.mid\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"wb\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" output_file:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    MyMIDI.writeFile(output_file)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's try to play this file. Well, if you read the MIDI article, you would know that this isn't really what we are doing. We want to see what our major scale sounds like. In order to do that, we need to install and configure both a MIDI synthesizer as well as a soundfont."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can use timidity++ for our MIDI synth. There are very simple instructions on how to do this "},{"type":"element","tag":"a","props":{"href":"https://wiki.archlinux.org/index.php/timidity","rel":["nofollow"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the steps I followed:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"From the AUR, install "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"timidity++"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"timidity-freepats"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add yourself to the audio group:"}]},{"type":"element","tag":"pre","props":{"code":"# gpasswd -a brian audio\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# gpasswd -a brian audio\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add the following line to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/etc/timidity++/timidity.cfg"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"soundfont /usr/share/soundfonts/timidity-freepats.sf2\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"soundfont /usr/share/soundfonts/timidity-freepats.sf2\n"}]}]},{"type":"element","tag":"pre","props":{"code":"sudo systemctl start timidity.service\nsudo systemctl enable timidity.service\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sudo systemctl start timidity.service\nsudo systemctl enable timidity.service\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aplaymidi -l"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":" $ aplaymidi -l\n Port    Client name                      Port name\n 14:0    Midi Through                     Midi Through Port-0\n130:0    TiMidity                         TiMidity port 0\n130:1    TiMidity                         TiMidity port 1\n130:2    TiMidity                         TiMidity port 2\n130:3    TiMidity                         TiMidity port 3\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" $ aplaymidi -l\n Port    Client name                      Port name\n 14:0    Midi Through                     Midi Through Port-0\n130:0    TiMidity                         TiMidity port 0\n130:1    TiMidity                         TiMidity port 1\n130:2    TiMidity                         TiMidity port 2\n130:3    TiMidity                         TiMidity port 3\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we can play our MIDI file that we generated by running the python script above:"}]},{"type":"element","tag":"pre","props":{"code":" $ aplaymidi major-scale.mid --port 130:0\n<music plays...>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" $ aplaymidi major-scale.mid --port 130:0\n<music plays...>\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For this project, playing files using a synthesizer is useful to verify that the MIDI was successfully created. If/when we get to the point of making a web app to convert midi files to music files, we will generate the midifile in-memory, convert it to a WAV file and then return that to the user."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's try to process a very simple tab file with just one string and a few notes, and then generate a simple MIDI file based on the tab."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Our sample tab can be:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"simple-tab.txt"}]}]},{"type":"element","tag":"pre","props":{"code":"--0--2--4--\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"--0--2--4--\n"}]}]},{"type":"element","tag":"pre","props":{"code":"#!/usr/bin/env python\n\nfrom midiutil import MIDIFile\n\ndegrees  = [60, 62, 64, 65, 67, 69, 71, 72]  # MIDI note number\ntrack    = 0\nchannel  = 0\ntime     = 0    # In beats\nduration = 1    # In beats\ntempo    = 60   # In BPM\nvolume   = 100  # 0-127, as per the MIDI standard\n\nMyMIDI = MIDIFile(1)  # One track, defaults to format 1 (tempo track is created\n                      # automatically)\nMyMIDI.addTempo(track, time, tempo)\n\nfor i, pitch in enumerate(degrees):\n    MyMIDI.addNote(track, channel, pitch, time + i, duration, volume)\n\nwith open(\"major-scale.mid\", \"wb\") as output_file:\n    MyMIDI.writeFile(output_file)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/usr/bin/env python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" midiutil "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"degrees  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"62"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"64"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"65"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"67"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"69"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"71"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"72"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# MIDI note number\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"track    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"channel  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"time     "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"duration "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tempo    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"   # In BPM\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"volume   "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 100"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # 0-127, as per the MIDI standard\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# One track, defaults to format 1 (tempo track is created\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"                      # automatically)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI.addTempo(track, time, tempo)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" enumerate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(degrees):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    MyMIDI.addNote(track, channel, pitch, time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, duration, volume)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"major-scale.mid\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"wb\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" output_file:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    MyMIDI.writeFile(output_file)\n"}]}]}]}]},{"type":"element","tag":"pre","props":{"code":" $ echo \"--0--2--4--\" > simple-tab.txt\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" $ echo \"--0--2--4--\" > simple-tab.txt\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the script I used to generate some fairly accurate MIDI files. There are still some bugs in the script that generates the MIDI file, but this meets the goal I had last weekend of writing a simple script to generate music from guitar tabs."}]},{"type":"element","tag":"pre","props":{"code":"#!/usr/bin/env python\n\nfrom midiutil import MIDIFile\nimport sys\nimport re\n\nstring_notes = [\"high_e\", \"B\", \"G\", \"D\", \"A\", \"E\"]\n\nguitar_strings = {\n    'E':{'note_val':52, 'track_num':0},\n    'A':{'note_val':57, 'track_num':1},\n    'D':{'note_val':62, 'track_num':2},\n    'G':{'note_val':67, 'track_num':3},\n    'B':{'note_val':71, 'track_num':4},\n    'high_e':{'note_val':76, 'track_num':5},\n}\n\n# read the tab file\nfile_name = sys.argv[1]\nif file_name.split(\".\")[-1] != 'txt':\n    print(\"Please select a text file\")\n\nwith open(file_name) as f:\n    contents = f.read()\n\ncontents = contents.replace(\"h\", \"-\")\ncontents = contents.replace(\"p\", \"-\")\ncontents = contents.replace(\"/\", \"-\")\ncontents = contents.replace(\"*\", \"-\")\ncontents = contents.upper()\nbar_group = re.findall(r\"(?:[E,B,G,D,A,-]+\\|[0-9-h|]+\\n){6}\",contents)\n\n#bar_group = re.findall(r\"(?:\\|[0-9-\\*h\\|]+\\n){6}\",contents)\n\n\ntrack    = 0\nchannel  = 0\ntime     = 0    # In beats\nduration = 1    # In beats\ntempo    = 1000   # In BPM\nvolume   = 100  # 0-127, as per the MIDI standard\n\nMyMIDI = MIDIFile(6)  # One track, defaults to format 1 (tempo track is created\n                      # automatically)\nMyMIDI.addTempo(track, time, tempo)\n\ninterval = len(bar_group[0].split(\"\\n\")) - 1\n\nfor b in bar_group:\n\n    strings = b.split(\"\\n\")\n    strings = [x for x in strings if x != '']\n    e_count = 0\n    for i,s in enumerate(strings):\n\n        current_string = strings[i][0]\n        if current_string not in guitar_strings.keys():\n            current_string = string_notes[i]\n        if current_string == \"E\":\n            e_count += 1\n        if e_count == 2:\n            current_string == \"high_e\"\n\n        track = guitar_strings[current_string]['track_num']\n\n        s = s[1:]\n        s = s.replace('|', '')\n        s = list(s)\n\n        for i, pitch in enumerate(s):\n            volume = 100\n\n            if pitch == \"\\n\":\n                break\n            if pitch == \"-\":\n                volume = 0\n                pitch = 50\n            print(\"adding note\")\n            pitch = int(pitch) + guitar_strings[current_string]['note_val']\n            MyMIDI.addNote(track, channel, pitch, time + i, duration, volume)\n\n    time += interval*8\n\nwith open(\"major-scale.mid\", \"wb\") as output_file:\n    MyMIDI.writeFile(output_file)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/usr/bin/env python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" midiutil "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" sys\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" re\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"string_notes "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"high_e\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"B\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"G\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"D\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"A\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"E\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"guitar_strings "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'E'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"52"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'A'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"57"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'D'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"62"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'G'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"67"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'B'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"71"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'high_e'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"76"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# read the tab file\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"file_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" sys.argv["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file_name.split("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\".\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'txt'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"    print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Please select a text file\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(file_name) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" f:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" f.read()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" contents.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"h\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" contents.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"p\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" contents.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"/\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" contents.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"*\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"contents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" contents.upper()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"bar_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" re.findall("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"[E,B,G,D,A,-]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#AE81FF;--shiki-default-font-weight:bold;--shiki-dark-font-weight:bold;--shiki-sepia-font-weight:inherit"},"children":[{"type":"text","value":"\\|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"[0-9-h|]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#AE81FF;--shiki-default-font-weight:bold;--shiki-dark-font-weight:bold;--shiki-sepia-font-weight:inherit"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"{6}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",contents)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#bar_group = re.findall(r\"(?:\\|[0-9-\\*h\\|]+\\n){6}\",contents)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"track    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"channel  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"time     "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"duration "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # In beats\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tempo    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1000"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"   # In BPM\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"volume   "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 100"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # 0-127, as per the MIDI standard\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MIDIFile("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# One track, defaults to format 1 (tempo track is created\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"                      # automatically)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"MyMIDI.addTempo(track, time, tempo)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"interval "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" len"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(bar_group["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].split("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" b "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" bar_group:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    strings "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" b.split("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    strings "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" strings "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    e_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i,s "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" enumerate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(strings):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        current_string "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" strings[i]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" current_string "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"not"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" guitar_strings.keys():\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            current_string "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" string_notes[i]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" current_string "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"E\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            e_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" e_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            current_string "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"high_e\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        track "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" guitar_strings[current_string]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'track_num'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        s "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" s["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        s "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" s.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'|'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        s "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" list"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(s)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" enumerate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(s):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            volume "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 100\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":74},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                break\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":75},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"-\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":76},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                volume "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":77},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 50\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":78},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"            print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"adding note\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":79},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            pitch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(pitch) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" guitar_strings[current_string]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'note_val'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":80},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            MyMIDI.addNote(track, channel, pitch, time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, duration, volume)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":81},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":82},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" interval"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"8\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":83},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":84},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"major-scale.mid\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"wb\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" output_file:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":85},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    MyMIDI.writeFile(output_file)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's me playing one of my favorite songs, you might recognize it!"}]},{"type":"element","tag":"blockquote","props":{"className":["instagram-media"],"dataInstgrmCaptioned":"","dataInstgrmPermalink":"https://www.instagram.com/p/rg2gmyyFdC/","dataInstgrmVersion":"8","style":" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"},"children":[{"type":"element","tag":"div","props":{"style":"padding:8px;"},"children":[{"type":"text","value":" "},{"type":"element","tag":"div","props":{"style":" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"},"children":[{"type":"text","value":" "},{"type":"element","tag":"div","props":{"style":" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"},"children":[]}]},{"type":"text","value":" "},{"type":"element","tag":"p","props":{"style":" margin:8px 0 0 0; padding:0 4px;"},"children":[{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"https://www.instagram.com/p/rg2gmyyFdC/","style":" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;","target":"_blank"},"children":[{"type":"text","value":"Written in 1902, this catchy tune from Fransico Trrega's 'Gran Vals' is now heard by an estimated 22,000 per second worldwide.. it is also a registered sound trademark of a billion dollar Finnish company  #franciscotrrega #tarrega #trrega #classicalguitar #spanishguitarist #spain #instamusic #granvals #grandevalse #grandwaltz #crownmolding"}]}]},{"type":"text","value":" "},{"type":"element","tag":"p","props":{"style":" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"},"children":[{"type":"text","value":"A post shared by "},{"type":"element","tag":"a","props":{"href":"https://www.instagram.com/briancaffey/","style":" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px;","target":"_blank"},"children":[{"type":"text","value":" Brian"}]},{"type":"text","value":" (@briancaffey) on "},{"type":"element","tag":"time","props":{"style":" font-family:Arial,sans-serif; font-size:14px; line-height:17px;","dateTime":"2014-08-10T09:48:59+00:00"},"children":[{"type":"text","value":"Aug 10, 2014 at 2:48am PDT"}]}]}]}]},{"type":"element","tag":"script","props":{"async":true,"defer":true,"src":"//www.instagram.com/embed.js"},"children":[]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"regex","depth":2,"text":"Regex","children":[{"id":"tab-examples","depth":3,"text":"Tab examples"},{"id":"tab-text-file-processing","depth":3,"text":"Tab text file processing"}]},{"id":"midiutil","depth":2,"text":"MIDIUtil"}]}},"_type":"markdown","_id":"content:2018:04:26:generating-music-from-guitar-tabs-with-python.md","_source":"content","_file":"2018/04/26/generating-music-from-guitar-tabs-with-python.md","_stem":"2018/04/26/generating-music-from-guitar-tabs-with-python","_extension":"md"},{"_path":"/2018/02/19/leaflet-maps-with-django","_dir":"19","_draft":false,"_partial":false,"_locale":"","title":"Display, filter and export geographical data in a Django app with Leaflet, Mapbox, DataTables, Bootstrap 4 and Travis-CI","description":"","layout":"post","date":"2018-02-19T00:00:00.000Z","comments":true,"image":"/static/map_homepage.png","disqus_id":"/2018/02/19/leaflet-maps-with-django.html","tags":["leaflet","django","mapbox","data-tables","bootstrap","travis-ci"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/map_entire.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"live-demo-on-digitalocean"},"children":[{"type":"element","tag":"a","props":{"href":"http://159.89.235.193/books/","rel":["nofollow"]},"children":[{"type":"text","value":"Live Demo on DigitalOcean"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This post is a review of my first attempt at using geographical data in a Django project. I have been interested in working with map APIs, and I once looked into the Google Maps API. For this project I chose to use "},{"type":"element","tag":"a","props":{"href":"http://leafletjs.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Leaflet"}]},{"type":"text","value":":"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"an open-source JavaScript library for mobile-friendly interactive maps"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Getting started with Leaflet is easy. All you need to do is request a public Mapbox API key which is free (with no credit card required). You can get a key from "},{"type":"element","tag":"a","props":{"href":"https://www.mapbox.com/account/access-tokens/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.mapbox.com/account/access-tokens/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Then you will follow steps on the "},{"type":"element","tag":"a","props":{"href":"http://leafletjs.com/examples/quick-start/","rel":["nofollow"]},"children":[{"type":"text","value":"quickstart guide"}]},{"type":"text","value":" and replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"your.mapbox.access.token"}]},{"type":"text","value":" with your Mapbox API key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% raw %}"}]},{"type":"element","tag":"pre","props":{"code":"L.tileLayer(\n  'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',\n  {\n    attribution:\n      'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, Imagery  <a href=\"http://mapbox.com\">Mapbox</a>',\n    maxZoom: 18,\n    id: 'mapbox.streets',\n    accessToken: 'your.mapbox.access.token',\n  }\n).addTo(mymap)\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"tileLayer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    attribution:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, Imagery  <a href=\"http://mapbox.com\">Mapbox</a>'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    maxZoom: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"18"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    id: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'mapbox.streets'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    accessToken: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'your.mapbox.access.token'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addTo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(mymap)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% endraw %}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll come back to using Leaflet later on, and also show how to use Leaflet plugins that can be used to add functionality such as aggregating markers on a map."}]},{"type":"element","tag":"h2","props":{"id":"django-model"},"children":[{"type":"text","value":"Django model"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, let's look at the Django setup. For now I'm simply working with a local project and SQLite3 backend."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To store latitude and longitude data, we can use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DecimalField"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"class Book(models.Model):\n    title = models.CharField(max_length=300)\n    lat = models.DecimalField(max_digits=9, decimal_places=6)\n    lon = models.DecimalField(max_digits=9, decimal_places=6)\n    [...]\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" Book"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"models"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Model"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    title "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" models.CharField("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_length"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"300"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    lat "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" models.DecimalField("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_digits"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"decimal_places"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    lon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" models.DecimalField("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_digits"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"decimal_places"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This allows us to store numbers to six decimal places. The difference between 0 and 0.00001 is about 3 feet, so this gives us plenty of accuracy for our geographical coordinate data."}]},{"type":"element","tag":"h2","props":{"id":"plotting-books-on-a-map"},"children":[{"type":"text","value":"Plotting books on a map"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plotting our books on a map is fairly straightforward, but there were a few obstacles to work around. Initially I setup an additional endpoint that returned an AJAX response with the longitude, latitude, title and link for each book. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"success"}]},{"type":"text","value":" function in the AJAX call then passed the returned JSON into a function that populated the book data in the map."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The main "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"books"}]},{"type":"text","value":" page displays book data in two places: on the map and on the DataTable below the map. Since I was already making one database query for DataTables, I decided to reuse this data for the map and not use a separate request and database query. There are a few helpful idioms in Python and JavaScript to accomplish this."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, let's look at the request with some added comments:"}]},{"type":"element","tag":"pre","props":{"code":"def all_books(request):\n    \"\"\"\n    Main view for books. request.GET parameters are used to filter books\n    \"\"\"\n    books = Book.objects.all()\n    form = QueryForm(request.GET or None)\n    paramDict = request.GET\n\n    books = filter_books(books, paramDict)\n\n    page_count = books.aggregate(Sum('pages'))\n\n    # This takes the first book query an reformats the data so it can be read\n    # by the map script on the frontend.\n    map_books = [{'loc':[float(book.lon), float(book.lat)],\n                  'title':book.title,\n                  'url':book.get_absolute_url()} for book in books]\n    context = {\n        'books':books,\n        # Here, we apply `json.dumps`, `escapejs` and `marksafe` for security\n        # and proper formatting\n        'map_books': mark_safe(escapejs(json.dumps(map_books))),\n        'page_count':page_count['pages__sum'],\n        'form':form}\n    return render(request, 'books/books.html', context)\n\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" all_books"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    Main view for books. request.GET parameters are used to filter books\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book.objects.all()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    form "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" QueryForm(request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" or"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    paramDict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" filter_books(books, paramDict)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    page_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.aggregate(Sum("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'pages'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # This takes the first book query an reformats the data so it can be read\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # by the map script on the frontend.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    map_books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'loc'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"float"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(book.lon), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"float"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(book.lat)],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                  'title'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":book.title,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                  'url'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":book.get_absolute_url()} "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" book "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    context "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'books'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":books,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # Here, we apply `json.dumps`, `escapejs` and `marksafe` for security\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # and proper formatting\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'map_books'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": mark_safe(escapejs(json.dumps(map_books))),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'page_count'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":page_count["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'pages__sum'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'form'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":form}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" render(request, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'books/books.html'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", context)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On the frontend, I passed the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"map_books"}]},{"type":"text","value":" variable to the template like this:"}]},{"type":"element","tag":"pre","props":{"code":"var map_books = JSON.parse('{{ map_books }}')\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" map_books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'{{ map_books }}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that I have "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"map_books"}]},{"type":"text","value":" as a JavaScript object, I can simply pass it into the map function that populates data in the Leaflet map. Here's the function that does that:"}]},{"type":"element","tag":"pre","props":{"code":"function populateMap(data) {\n  for (i in data) {\n    var title = data[i].title, //value searched\n      loc = data[i].loc, //position found\n      url = data[i].url,\n      marker = new L.Marker(new L.latLng(loc), { title: title, icon: bookIcon }) //se property searched\n    marker.bindPopup('<p><a href=\"' + url + '\">' + title + '</a></p>')\n    markersLayer.addLayer(marker)\n  }\n}\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" populateMap"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (i "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" title "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].title, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//value searched\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      loc "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].loc, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//position found\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].url,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      marker "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Marker"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"latLng"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(loc), { title: title, icon: bookIcon }) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//se property searched\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    marker."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"bindPopup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'<p><a href=\"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '\">'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" title "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '</a></p>'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    markersLayer."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addLayer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(marker)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This adds our markers to the map, and also passes link and title data to the popup box when a marker is clicked."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the entire script that is used to populate map data:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% raw %}"}]},{"type":"element","tag":"pre","props":{"code":"<script>\n  var mymap = new L.Map('mapid', { zoom: 9, center: new L.latLng([40, 13]) }) //set center from first location\n\n  L.tileLayer(\n    'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',\n    {\n      attribution:\n        'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, Imagery  <a href=\"http://mapbox.com\">Mapbox</a>',\n      maxZoom: 18,\n      id: 'mapbox.streets',\n      accessToken:\n        'pk.eyJ1IjoiYnJpYW5jYWZmZXkiLCJhIjoiY2pkczJycjl5MmhqbTMzbzQ3bHJuaHA3aiJ9.cvRYYPNjQJVpFjdUcmIHzA',\n    }\n  ).addTo(mymap)\n\n  var bookIcon = L.icon({\n    iconUrl: '/static/images/marker-icon.png',\n    iconSize: [35, 35], // size of the icon\n    iconAnchor: [17, 35], // point of the icon which will correspond to marker's location\n    popupAnchor: [0, -30], // point from which the popup should open relative to the iconAnchor\n  })\n\n  var markersLayer = L.markerClusterGroup()\n\n  mymap.addLayer(markersLayer)\n\n  var controlSearch = new L.Control.Search({\n    position: 'topright',\n    layer: markersLayer,\n    initial: false,\n    zoom: 12,\n    marker: false,\n  })\n\n  mymap.addControl(controlSearch)\n\n  function populateMap(data) {\n    for (i in data) {\n      var title = data[i].title, //value searched\n        loc = data[i].loc, //position found\n        url = data[i].url,\n        marker = new L.Marker(new L.latLng(loc), {\n          title: title,\n          icon: bookIcon,\n        }) //se property searched\n      marker.bindPopup('<p><a href=\"' + url + '\">' + title + '</a></p>')\n      markersLayer.addLayer(marker)\n    }\n  }\n\n  // use context variable instead of making AJAX call\n  var map_books = JSON.parse('{{ map_books }}')\n  var new_lat = map_books[0].loc[0]\n  var new_lon = map_books[0].loc[1]\n  mymap.setView([0, 0], 2)\n  populateMap(map_books)\n</script>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" mymap "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Map"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'mapid'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { zoom: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", center: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"latLng"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"40"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"13"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]) }) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//set center from first location\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"tileLayer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      attribution:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, Imagery  <a href=\"http://mapbox.com\">Mapbox</a>'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      maxZoom: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"18"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      id: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'mapbox.streets'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      accessToken:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'pk.eyJ1IjoiYnJpYW5jYWZmZXkiLCJhIjoiY2pkczJycjl5MmhqbTMzbzQ3bHJuaHA3aiJ9.cvRYYPNjQJVpFjdUcmIHzA'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addTo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(mymap)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" bookIcon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"icon"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    iconUrl: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'/static/images/marker-icon.png'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    iconSize: ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"35"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"35"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// size of the icon\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    iconAnchor: ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"17"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"35"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// point of the icon which will correspond to marker's location\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    popupAnchor: ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"30"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// point from which the popup should open relative to the iconAnchor\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" markersLayer "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"markerClusterGroup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  mymap."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addLayer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(markersLayer)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" controlSearch "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".Control."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Search"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    position: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'topright'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    layer: markersLayer,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    initial: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    zoom: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"12"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    marker: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  mymap."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addControl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(controlSearch)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" populateMap"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (i "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"      var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" title "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].title, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//value searched\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        loc "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].loc, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//position found\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data[i].url,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        marker "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Marker"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" L"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"latLng"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(loc), {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          title: title,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          icon: bookIcon,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"//se property searched\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      marker."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"bindPopup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'<p><a href=\"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '\">'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" title "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '</a></p>'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      markersLayer."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addLayer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(marker)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  // use context variable instead of making AJAX call\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" map_books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'{{ map_books }}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" new_lat "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" map_books["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].loc["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" new_lon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" map_books["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].loc["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  mymap."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setView"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  populateMap"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(map_books)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% endraw %}"}]},{"type":"element","tag":"h2","props":{"id":"login-redirect"},"children":[{"type":"text","value":"Login Redirect"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I wanted to include a small note on a simple issue that I previously had trouble with, which is using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"next"}]},{"type":"text","value":" parameter to do a redirect to a page that an unauthenticated user will be redirected to after they successfully login."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the login view:"}]},{"type":"element","tag":"pre","props":{"code":"def login_view(request):\n    next_redirect = request.GET.get('next')\n    form = UserLoginForm(request.POST or None)\n    if form.is_valid():\n        next_redirect = request.POST.get('next')\n        username = form.cleaned_data.get('username')\n        password = form.cleaned_data.get('password')\n        user = authenticate(username=username, password=password)\n        login(request, user)\n        print(next_redirect)\n        if next_redirect != 'None':\n            return redirect(next_redirect)\n        return redirect('books:all')\n    context = { 'form':form, 'next':next_redirect }\n    return render(request, 'accounts/login_form.html', context)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" login_view"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    next_redirect "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'next'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    form "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" UserLoginForm(request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"POST"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" or"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" form.is_valid():\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        next_redirect "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"POST"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'next'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        username "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" form.cleaned_data.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'username'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        password "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" form.cleaned_data.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'password'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        user "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" authenticate("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"username"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"username, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"password"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"password)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        login(request, user)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"        print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(next_redirect)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" next_redirect "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'None'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" redirect(next_redirect)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" redirect("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'books:all'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    context "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'form'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":form, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'next'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":next_redirect }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" render(request, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'accounts/login_form.html'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", context)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Notice that I pass "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"next"}]},{"type":"text","value":" as a context variable. I use this in the login form here:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% raw %}"}]},{"type":"element","tag":"pre","props":{"code":"<form method=\"POST\" action=\".\">\n  {% csrf_token %} {{ form | crispy }}\n  <input type=\"hidden\" value=\"{{ next }}\" name=\"next\" />\n  <div class=\"login-center\">\n    <input class=\"btn btn-success login-center\" type=\"submit\" value=\"Login\" />\n  </div>\n  <br />\n  or <a href=\"{% url 'accounts:register' %}\">create an account</a>\n</form>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\".\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  {% csrf_token %} {{ form | crispy }}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"hidden\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{{ next }}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"next\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"login-center\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-success login-center\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Login\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"br"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  or <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" href"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{% url 'accounts:register' %}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">create an account</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% endraw %}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By passing this as a hidden value to the form, when a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POST"}]},{"type":"text","value":" request is made, we are redirected to the value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"next"}]},{"type":"text","value":" if it is not "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"None"}]},{"type":"text","value":", or if there is no redirect."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@login_required"}]},{"type":"text","value":" decorator is used, and we want to access a url such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/books/add"}]},{"type":"text","value":", we are redirected to a url that looks like this:"}]},{"type":"element","tag":"pre","props":{"code":"http://localhost:8000/accounts/login/?next=/books/new/\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"http://localhost:8000/accounts/login/?next=/books/new/\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this way we can pass the next parameter from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"GET"}]},{"type":"text","value":" request to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POST"}]},{"type":"text","value":" request that is made when the login view is hit."}]},{"type":"element","tag":"h2","props":{"id":"authors"},"children":[{"type":"text","value":"Authors"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For illustration purposes, I included an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Author"}]},{"type":"text","value":" model. Since a book can have zero, one or many Authors, I used a many-to-many relationship to link authors to books. Here is how we do this in our Book model:"}]},{"type":"element","tag":"pre","props":{"code":"class Book(models.Model):\n    [...other fields...]\n    authors = models.ManyToManyField('authors.Author')\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" Book"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"models"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Model"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"other fields"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    authors "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" models.ManyToManyField("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'authors.Author'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This dot notation with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"'authors.Author'"}]},{"type":"text","value":" is important. Previously I would have just imported the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Author"}]},{"type":"text","value":"model and then referenced that in the ManyToManyField. However, this can lead to circular import errors which are hard to debug unless you know what a circular import is."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's look at how to find all "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Books"}]},{"type":"text","value":" by a certain author, as well as all "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Authors"}]},{"type":"text","value":" of a given book. Uing the Django shell, we can do the following:"}]},{"type":"element","tag":"pre","props":{"code":"from authors.models import Author\nfrom books.models import Book\na = Author.objects.all().first()\na.book_set.values()\n<QuerySet [{'id': 583, 'title': 'None Or Other', 'lat': Decimal('-118.035345'), 'lon': Decimal('34.139729'), 'pages': 1881, 'publish_date': datetime.date(2018, 3, 18), 'website': 'https://www.fleming-mitchell.com/', 'synopsis': 'Option ever large throw dinner worker ahead realize clearly congress as smile size spend expert chair well. Brother item win follow hope coach garden later arrive who if ago voice analysis simply reflect. Amount under data drug kind book fish still information president minute stage dog. Focus full green society parent door according my management sell arrive only send international tonight. Player character financial detail oil check bring pressure possible former. Learn politics compare position large loss exactly probably approach physical international machine as model. ', 'slug': 'none-or-other', 'status': True}, {'id': 601, 'title': 'Teacher Them Step', 'lat': Decimal('-80.268357'), 'lon': Decimal('26.661763'), 'pages': 206, 'publish_date': datetime.date(2018, 2, 27), 'website': 'http://www.rodriguez.net/', 'synopsis': 'Drug fact behavior environment green try account where training brother building particular window even reach. Pressure lawyer dog world thought near institution we get force market can guy receive matter structure research foot of small. Professor production very this practice car wind wish relationship after follow professor news card concern media property have. According majority owner go mention reach store computer project kitchen group quality present several another time school and will. Before during central artist page only health region happen share traditional section well out human. Mention quite short race only education heavy book up recent official here spring oil buy which language information practice. Time mother better peace girl defense rock mr never feeling tax city stock bar tv others right conference skin. ', 'slug': 'teacher-them-step', 'status': True}]>\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" authors.models "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Author\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.models "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"a "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Author.objects.all().first()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"a.book_set.values()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"QuerySet [{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'id'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"583"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'title'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'None Or Other'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lat'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Decimal("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'-118.035345'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lon'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Decimal("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'34.139729'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'pages'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1881"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": datetime.date("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2018"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"18"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'website'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'https://www.fleming-mitchell.com/'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'synopsis'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Option ever large throw dinner worker ahead realize clearly congress as smile size spend expert chair well. Brother item win follow hope coach garden later arrive who if ago voice analysis simply reflect. Amount under data drug kind book fish still information president minute stage dog. Focus full green society parent door according my management sell arrive only send international tonight. Player character financial detail oil check bring pressure possible former. Learn politics compare position large loss exactly probably approach physical international machine as model. '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'slug'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'none-or-other'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'status'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"True"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}, {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'id'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"601"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'title'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Teacher Them Step'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lat'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Decimal("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'-80.268357'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lon'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Decimal("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'26.661763'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'pages'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"206"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": datetime.date("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2018"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"27"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'website'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'http://www.rodriguez.net/'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'synopsis'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Drug fact behavior environment green try account where training brother building particular window even reach. Pressure lawyer dog world thought near institution we get force market can guy receive matter structure research foot of small. Professor production very this practice car wind wish relationship after follow professor news card concern media property have. According majority owner go mention reach store computer project kitchen group quality present several another time school and will. Before during central artist page only health region happen share traditional section well out human. Mention quite short race only education heavy book up recent official here spring oil buy which language information practice. Time mother better peace girl defense rock mr never feeling tax city stock bar tv others right conference skin. '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'slug'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'teacher-them-step'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'status'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"True"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This gave us two books by an author."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now, let's look at how to find all authors of a given book. For this example, we can get authors directly in the template from a book object. This example come from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"book_detail"}]},{"type":"text","value":" template:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% raw %}"}]},{"type":"element","tag":"pre","props":{"code":"<h3>\n  Authors: {% for author in book.authors.all %}\n  <a href=\"{% url 'authors:author_detail' id=author.id %}\"\n    >{{ author.full_name }}</a\n  >\n  {% endfor %}\n</h3>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"h3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  Authors: {% for author in book.authors.all %}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" href"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{% url 'authors:author_detail' id=author.id %}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    >{{ author.full_name }}</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  >\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  {% endfor %}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"h3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% endraw %}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We could just as well access "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"books.authors.all"}]},{"type":"text","value":" in the view and pass authors in a variable that we can iterate over in the template, but this keeps things simpler without much more code to write."}]},{"type":"element","tag":"h2","props":{"id":"filtering-data"},"children":[{"type":"text","value":"Filtering Data"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other question I wanted to answer with this project is how to do relatively complex data filtering. To do this, I used Django forms to create a form that calls a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"GET"}]},{"type":"text","value":" request to the same view it came from, which is to say, a filter form on the template for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"all"}]},{"type":"text","value":" books view has a form action with an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"action"}]},{"type":"text","value":" value of the url that returns the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"all"}]},{"type":"text","value":" view."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a look at the form I put together for filtering data:"}]},{"type":"element","tag":"pre","props":{"code":"class QueryForm(forms.Form):\n\n    publish_date_before = forms.DateField(\n        label='',\n        required=False,\n        # initial = datetime.datetime.now(),\n        widget = forms.TextInput(\n            attrs={\n                'class': 'form-control',\n                'id':'datepicker1',\n                'placeholder':'published before'\n            }))\n\n    publish_date_after = forms.DateField(\n        label='',\n        required=False,\n        # initial = datetime.datetime.now(),\n        widget = forms.TextInput(\n            attrs={\n                'class': 'form-control',\n                'id':'datepicker2',\n                'placeholder':'published after'\n            }))\n\n    keywords = forms.CharField(\n        required=False,\n        label='',\n        widget=forms.TextInput(\n\n            attrs={\n                'class':'form-control',\n                'placeholder':'space-separated words matching title, synopsis, website or tags'\n            }))\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" QueryForm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"forms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    publish_date_before "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" forms.DateField(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        label"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        required"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"False"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # initial = datetime.datetime.now(),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        widget"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" forms.TextInput(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            attrs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'class'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'form-control'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'id'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'datepicker1'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'placeholder'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'published before'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    publish_date_after "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" forms.DateField(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        label"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        required"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"False"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # initial = datetime.datetime.now(),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        widget"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" forms.TextInput(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            attrs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'class'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'form-control'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'id'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'datepicker2'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'placeholder'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'published after'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    keywords "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" forms.CharField(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        required"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"False"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        label"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        widget"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"forms.TextInput(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            attrs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'class'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'form-control'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                'placeholder'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'space-separated words matching title, synopsis, website or tags'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }))\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here we are using three fields to filter data, a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"published_before"}]},{"type":"text","value":" date, a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"published_after"}]},{"type":"text","value":" date and a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"keywords"}]},{"type":"text","value":" field."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Filtering this data can really clog up code in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"views.py"}]},{"type":"text","value":", and I know I was going to need this same code again for filtering data for CSV and XLS file downloads (more on this in a minute), so I decided to wrote a utility function that takes a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Book"}]},{"type":"text","value":" queryset and parameter dictionary ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"request.GET"}]},{"type":"text","value":"), and returns a filtered "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Book"}]},{"type":"text","value":" queryset. Here's what that function looks like:"}]},{"type":"element","tag":"pre","props":{"code":"from django.db.models import Q\nfrom functools import reduce\nfrom ..models import Book\nimport datetime\n\ndef filter_books(books, paramDict):\n    # paramDict = request.GET\n    params = paramDict.keys()\n\n    # data filtering\n    if any(x!='' for x in paramDict.values()):\n        if paramDict['publish_date_after'] != '':\n            after_date = paramDict['publish_date_after']\n            _after_date = datetime.datetime.strptime(after_date, '%m/%d/%Y')\n\n            books = books.filter(publish_date__gte=_after_date)\n\n        if paramDict['publish_date_before'] != '':\n            before_date = paramDict['publish_date_before']\n            _before_date = datetime.datetime.strptime(before_date, '%m/%d/%Y')\n            books = books.filter(publish_date__lte=_before_date)\n\n        # filters records that contain any of the following keywords\n        if paramDict['keywords'] != '':\n            kws = paramDict['keywords'].split()\n            q_lookups = [Q(title__icontains=kw) for kw in kws] + \\\n                        [Q(synopsis__icontains=kw) for kw in kws] + \\\n                        [Q(website__icontains=kw) for kw in kws]\n            filters = Q()\n            filters |= reduce(lambda x, y: x | y, q_lookups)\n            books = books.filter(filters)\n\n    return books\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" django.db.models "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Q\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" functools "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" reduce\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ..models "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" datetime\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" filter_books"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"books"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"paramDict"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # paramDict = request.GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    params "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict.keys()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # data filtering\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" any"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict.values()):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date_after'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            after_date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date_after'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            _after_date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" datetime.datetime.strptime(after_date, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'%m/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"%d"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/%Y'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.filter("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"publish_date__gte"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_after_date)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date_before'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            before_date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'publish_date_before'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            _before_date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" datetime.datetime.strptime(before_date, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'%m/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"%d"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/%Y'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.filter("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"publish_date__lte"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_before_date)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # filters records that contain any of the following keywords\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'keywords'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            kws "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'keywords'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].split()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            q_lookups "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"title__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                        [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"synopsis__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                        [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"website__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            filters "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Q()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            filters "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" reduce"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"y"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" y, q_lookups)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.filter(filters)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This makes things much more simple in our views. Here's the code in the main "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"books"}]},{"type":"text","value":" view that uses this filter function, truncated for simplicity:"}]},{"type":"element","tag":"pre","props":{"code":"def all_books(request):\n    books = Book.objects.all()\n    form = QueryForm(request.GET or None)\n    paramDict = request.GET\n    books = filter_books(books, paramDict)\n    [...]\n    context = {\n        'books':books,\n        'form':form,\n        [...],}\n    return render(request, 'books/books.html', context)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" all_books"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book.objects.all()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    form "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" QueryForm(request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" or"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    paramDict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" filter_books(books, paramDict)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    context "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'books'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":books,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'form'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":form,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" render(request, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'books/books.html'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", context)\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"exporting-data-as-csv-or-xls"},"children":[{"type":"text","value":"Exporting data as CSV or XLS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other requirement I gave myself for this project was giving users the option to export data in CSV or XLS file formats."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With the filter data function, I was able to keep things DRY (Don't Repeart Yourself). This task taught me about a few aspects of HTML5 and forms that I wasn't aware of. First, let's take a look at the CSV export function that I learned about throught "},{"type":"element","tag":"a","props":{"href":"https://simpleisbetterthancomplex.com/tutorial/2016/07/29/how-to-export-to-excel.html","rel":["nofollow"]},"children":[{"type":"text","value":"this blog post"}]},{"type":"text","value":", from a great Django blog called "},{"type":"element","tag":"a","props":{"href":"https://simpleisbetterthancomplex.com/tutorial/2016/07/29/how-to-export-to-excel.html","rel":["nofollow"]},"children":[{"type":"text","value":"Simple is Better than Complex"}]},{"type":"text","value":" by "},{"type":"element","tag":"a","props":{"href":"https://github.com/vitorfs","rel":["nofollow"]},"children":[{"type":"text","value":"Vitor Freitas"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"def export_filtered_books_csv(request):\n    response = HttpResponse(content_type='text/csv')\n    response['Content-Disposition'] = 'attachment; filename=\"books.csv\"'\n\n    writer = csv.writer(response)\n    writer.writerow(['Title', 'Synopsis', 'Pages'])\n    books = Book.objects.all()\n    paramDict = request.GET\n    books = filter_books(books, paramDict)\n    books = books.values_list(\n        'title',\n        'synopsis',\n        'pages')\n\n    for book in books:\n        writer.writerow(book)\n\n    return response\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" export_filtered_books_csv"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" HttpResponse("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"content_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'text/csv'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    response["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Content-Disposition'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'attachment; filename=\"books.csv\"'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    writer "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" csv.writer(response)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    writer.writerow(["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Title'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Synopsis'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Pages'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"])\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book.objects.all()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    paramDict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" request."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" filter_books(books, paramDict)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.values_list(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'title'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'synopsis'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'pages'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" book "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        writer.writerow(book)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I wanted to put this button in the filter form on the main "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"books"}]},{"type":"text","value":" page, but I need to place the button outside of the form tag. To get around this, here is the HTML I used:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% raw %}"}]},{"type":"element","tag":"pre","props":{"code":"<form action=\"{% url 'books:csv' %}\">\n  <a\n    class=\"btn btn-primary\"\n    data-toggle=\"collapse\"\n    href=\"#collapseExample\"\n    aria-expanded=\"false\"\n    aria-controls=\"collapseExample\"\n  >\n    Filter Books\n  </a>\n  <input\n    type=\"submit\"\n    class=\"btn btn-info\"\n    form=\"id_query_form\"\n    formaction=\"{% url 'books:csv' %}\"\n    value=\"Export CSV\"\n  />\n  <input\n    type=\"submit\"\n    class=\"btn btn-default\"\n    form=\"id_query_form\"\n    formaction=\"{% url 'books:xls' %}\"\n    value=\"Export XLS\"\n  />\n</form>\n\n<form method=\"get\" action=\".\" id=\"id_query_form\">\n  <p>{{ form.keywords }}</p>\n  <div class=\"row\">\n    <div class=\"col-md-6\">{{ form.publish_date_before }}</div>\n    <div class=\"col-md-6\">{{ form.publish_date_after }}</div>\n  </div>\n\n  <p></p>\n  <p>\n    <input class=\"btn btn-success\" type=\"submit\" />\n    <button type=\"reset\" class=\"btn btn-info\" value=\"Reset filters\">\n      Reset filters\n    </button>\n    <button\n      type=\"reset\"\n      class=\"btn btn-warning\"\n      id=\"id_clear_filters\"\n      onclick=\"return resetForm(this.form);\"\n    >\n      Clear Filters\n    </button>\n  </p>\n</form>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{% url 'books:csv' %}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-primary\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    data-toggle"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"collapse\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    href"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"#collapseExample\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    aria-expanded"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"false\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    aria-controls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"collapseExample\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  >\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    Filter Books\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"a"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-info\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"id_query_form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    formaction"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{% url 'books:csv' %}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Export CSV\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-default\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"id_query_form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    formaction"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"{% url 'books:xls' %}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Export XLS\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"get\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\".\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"id_query_form\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">{{ form.keywords }}</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"row\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"col-md-6\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">{{ form.publish_date_before }}</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"col-md-6\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">{{ form.publish_date_after }}</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"></"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-success\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"button"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"reset\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-info\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Reset filters\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      Reset filters\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"button"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"button\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"      type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"reset\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"      class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"btn btn-warning\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"      id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"id_clear_filters\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"      onclick"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" resetForm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":");\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    >\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      Clear Filters\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"button"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"{% endraw %}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two forms here, but the first form has an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"input"}]},{"type":"text","value":" of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"type=submit"}]},{"type":"text","value":" that references another form with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"form=\"id_query_form\""}]},{"type":"text","value":", and this button's action is the url for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"export_filtered_books_csv"}]},{"type":"text","value":" function shown above."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For the filter function, I make a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"utils"}]},{"type":"text","value":" folder in the app I am working with, so the directory structure looks like this (for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"books"}]},{"type":"text","value":" app):"}]},{"type":"element","tag":"pre","props":{"code":".\n admin.py\n apps.py\n forms.py\n __init__.py\n migrations\n  0001_initial.py\n  0002_book_authors.py\n  __init__.py\n models.py\n templates\n  books\n tests.py\n urls.py\n utils\n  filter.py\n  __init__.py\n  nearby.py\n views.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":".\n admin.py\n apps.py\n forms.py\n __init__.py\n migrations\n  0001_initial.py\n  0002_book_authors.py\n  __init__.py\n models.py\n templates\n  books\n tests.py\n urls.py\n utils\n  filter.py\n  __init__.py\n  nearby.py\n views.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I initially had a litte bit of confusion on how to write a simple search query. I wanted a user to be able to enter terms that would return a query set where the items in the query set contained at least on of the terms in at least on of a few different fields ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"title"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synopsis"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"website"}]},{"type":"text","value":")."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To make this filter, I found a nice idiomatic pattern:"}]},{"type":"element","tag":"pre","props":{"code":"if paramDict['keywords'] != '':\n    kws = paramDict['keywords'].split()\n    q_lookups = [Q(title__icontains=kw) for kw in kws] + \\\n                [Q(synopsis__icontains=kw) for kw in kws] + \\\n                [Q(website__icontains=kw) for kw in kws]\n    filters = Q()\n    filters |= reduce(lambda x, y: x | y, q_lookups)\n    books = books.filter(filters)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'keywords'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    kws "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" paramDict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'keywords'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].split()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    q_lookups "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"title__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"synopsis__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                [Q("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"website__icontains"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kw) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kws]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    filters "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Q()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    filters "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" reduce"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"y"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": x "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" y, q_lookups)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" books.filter(filters)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is good for a small database, but could end up having to do lots of operations, especially if I decided that I want to add more fields to be searched, such as category or tags."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One option that I have considered to simplify the search query is to make one field called something like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"search_string"}]},{"type":"text","value":". This field would be modified on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"save"}]},{"type":"text","value":", and it would simply appends the text from all of the fields I'm interested in searching. Then, instead of doing Q lookups for each word over many different fields, I could search each word in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"keywords"}]},{"type":"text","value":" over one field. I haven't implemented this here, but I would like to test this in the future."}]},{"type":"element","tag":"h2","props":{"id":"finding-books-nearby"},"children":[{"type":"text","value":"Finding \"Books Nearby\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On the pages that show details for each book I wanted to add additional information. I thought it would be interesting to show the 5 books closest to the book we are currently showing. Since we are dealing with coordinate points on a globe, the best way to calculate distance between two points is to use the Halversine formula:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The haversine formula determines the great-circle distance between two points on a sphere given their longitudes and latitudes. Important in navigation, it is a special case of a more general formula in spherical trigonometry, the law of haversines, that relates the sides and angles of spherical triangles."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/great_circle.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code I used for calculating distance (using the Halversine formula):"}]},{"type":"element","tag":"pre","props":{"code":"from math import radians, cos, sin, asin, sqrt\n\ndef distance(origin, destination):\n    \"\"\"\n    Calculate the great circle distance between two points\n    on the earth (specified in decimal degrees)\n    \"\"\"\n\n    lon1, lat1 = origin\n    lon2, lat2 = destination\n    # convert decimal degrees to radians\n    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])\n    # haversine formula\n    dlon = lon2 - lon1\n    dlat = lat2 - lat1\n    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2\n    c = 2 * asin(sqrt(a))\n    r = 3956 # miles\n    return c * r\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" math "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" radians, cos, sin, asin, sqrt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" distance"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"origin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"destination"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    Calculate the great circle distance between two points\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    on the earth (specified in decimal degrees)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    lon1, lat1 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" origin\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    lon2, lat2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" destination\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # convert decimal degrees to radians\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    lon1, lat1, lon2, lat2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" map"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(radians, [lon1, lat1, lon2, lat2])\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # haversine formula\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    dlon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lon2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lon1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    dlat "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lat2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lat1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    a "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" sin(dlat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cos(lat1) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cos(lat2) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" sin(dlon"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" asin(sqrt(a))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    r "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 3956"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # miles\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" r\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This formula assumes that the earth is a perfect sphere. Another approach would be to use the the Vincety Formula:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vincenty's formulae are two related iterative methods used in geodesy to calculate the distance between two points on the surface of a spheroid, developed by Thaddeus Vincenty (1975a). They are based on the assumption that the figure of the Earth is an oblate spheroid, and hence are more accurate than methods that assume a spherical Earth, such as great-circle distance."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This distance is packaged in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"geopy"}]},{"type":"text","value":" and can be calculated easily:"}]},{"type":"element","tag":"pre","props":{"code":"import geopy.distance\n\ncoords_1 = (52.2296756, 21.0122287)\ncoords_2 = (52.406374, 16.9251681)\n\nprint geopy.distance.vincenty(coords_1, coords_2).km\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" geopy.distance\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"coords_1 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"52.2296756"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"21.0122287"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"coords_2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"52.406374"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"16.9251681"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" geopy.distance.vincenty(coords_1, coords_2).km\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a look at the function I wrote for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"book_detail"}]},{"type":"text","value":" view. I have commented out parts that aren't related to finding nearby books:"}]},{"type":"element","tag":"pre","props":{"code":"def book_detail(request, id, slug):\n\n    book = Book.objects.get(id=id, slug=slug)\n    b_coords = (book.lat, book.lon)\n    all_books = Book.objects.all()\n    coords = [((b.lat, b.lon),b) for b in all_books]\n\n    distance_dict = {}\n    for c in coords:\n        if c[0] != b_coords:\n            distance_dict[c[0]]=(distance(c[0],b_coords),c)\n\n    sorted_nearby = sorted(distance_dict.items(), key=lambda x: x[1][0])[:5]\n\n    # map_book = [{'loc':[float(book.lon), float(book.lat)],\n    #              'title':book.title,\n    #              'url':book.get_absolute_url()}]\n    context = {\n        'book':book,\n        # 'map_book':mark_safe(escapejs(json.dumps(map_book))),\n        'sorted_nearby':sorted_nearby,\n    }\n    return render(request, 'books/book_detail.html', context)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" book_detail"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    book "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book.objects.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    b_coords "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (book.lat, book.lon)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    all_books "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Book.objects.all()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    coords "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [((b.lat, b.lon),b) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" b "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" all_books]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    distance_dict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" coords:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" c["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" b_coords:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            distance_dict[c["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(distance(c["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],b_coords),c)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    sorted_nearby "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sorted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(distance_dict.items(), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": x["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"])[:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # map_book = [{'loc':[float(book.lon), float(book.lat)],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    #              'title':book.title,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    #              'url':book.get_absolute_url()}]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    context "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'book'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":book,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # 'map_book':mark_safe(escapejs(json.dumps(map_book))),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        'sorted_nearby'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":sorted_nearby,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" render(request, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'books/book_detail.html'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", context)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To find the 5 closest books I arrived at a solution that seems fairly convoluted and should be refactored, but works! I start with a queryset of all books, then use list comprehension to make a list of tuples containing "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"((< longitutde >, < latitude >), < Book Object >)"}]},{"type":"text","value":". Then I loop over this list and create a dictionary where the keys are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"(< longitutde >, < latitude >)"}]},{"type":"text","value":" and the values are tuples of the form: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"(< distance in miles >, < Book Object >)"}]},{"type":"text","value":". Finally, I use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sorted"}]},{"type":"text","value":" on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dictionary_dict.items()"}]},{"type":"text","value":" where the key is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lambda x: x[1][0]"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"[1]"}]},{"type":"text","value":" accesses the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"value"}]},{"type":"text","value":" of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"(< key >, < value>)"}]},{"type":"text","value":" tuple returned by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"items()"}]},{"type":"text","value":", and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"[0]"}]},{"type":"text","value":" access the first item, which is the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"distance"}]},{"type":"text","value":" value we calculated. Finally, I take the first "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"[:5]"}]},{"type":"text","value":" items of this sorted list."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this approach I think I avoided the possible issue of ambiguity if we have two books with the same coordinates. I'll need to add this scenario to my test suite later."}]},{"type":"element","tag":"h2","props":{"id":"testing-travis-ci"},"children":[{"type":"text","value":"Testing & Travis CI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Speaking of testing, this applcation includes a simple testing suite (that I am currently working on expanding). I have also managed to setup Travis CI for this project. When I push code from my local repo to GitHub, Travis CI automatically runs test, and the commit message contains additional information about whether or not all of the tests were successful."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Setting up Travis CI is very simple. We need to grant Travis CI (.org) access to our GitHub account, enable Travis CI on the repository we are working with, and then add a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".travis.yml"}]},{"type":"text","value":" file to the top level of the project directory. Here's the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".travis.yml"}]},{"type":"text","value":" file I have for this project:"}]},{"type":"element","tag":"pre","props":{"code":"language: python\n\npython:\n  - '3.5'\n\nservices:\n  - postgresql\n\nenv: -DJANGO=2.0 DB=postgresql\n\ninstall:\n  - pip install -r requirements.txt\n\nbefore_script:\n  - psql -c \"CREATE USER u_brian WITH PASSWORD 'password'; ALTER USER u_brian CREATEDB;\" -U postgres\n\nscript:\n  - python manage.py test books/\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"language"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"python"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'3.5'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"postgresql\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"env"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-DJANGO=2.0 DB=postgresql\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip install -r requirements.txt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"psql -c \"CREATE USER u_brian WITH PASSWORD 'password'; ALTER USER u_brian CREATEDB;\" -U postgres\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"python manage.py test books/\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can generate a Travis CI badge that shows the status of the current Github deploy with the following code:"}]},{"type":"element","tag":"pre","props":{"code":"[![Build\nStatus](https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master)](https://travis-ci.org/briancaffey/django-leaflet-demo)\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[![Build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"Status](https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master)](https://travis-ci.org/briancaffey/django-leaflet-demo)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://travis-ci.org/briancaffey/django-leaflet-demo","rel":["nofollow"]},"children":[{"type":"element","tag":"img","props":{"alt":"Build Status","src":"https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master"},"children":[]}]}]},{"type":"element","tag":"h2","props":{"id":"deploying-to-digitalocean"},"children":[{"type":"text","value":"Deploying to DigitalOcean"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, I used DigitalOcean to deploy this app. I have used Heroku for most of my previous projects, but I decided to use DigitalOcean for this one to learn something new and get more experience with using Ubuntu and related tools for running a website: nginx and gunicorn."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Again, for I turned to Vitor's blog for a very straightforward introduction to deploying on DigitalOcean with a simple Droplet. You can read more about the instructions for deployment "},{"type":"element","tag":"a","props":{"href":"https://simpleisbetterthancomplex.com/tutorial/2016/10/14/how-to-deploy-to-digital-ocean.html","rel":["nofollow"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":", and I can say that I had no problems following the instructions step by step. Here are the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gunicorn"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" scripts I have used to successfully deploy my project:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"/home/brian/bin/gunicorn_start"}]}]},{"type":"element","tag":"pre","props":{"code":"#!/bin/bash\n\nNAME=\"django-leaflet-demo\"\nDIR=/home/brian/django-leaflet-demo\nUSER=brian\nGROUP=brian\nWORKERS=3\nBIND=unix:/home/brian/run/gunicorn.sock\nDJANGO_SETTINGS_MODULE=djangoapp.settings\nDJANGO_WSGI_MODULE=djangoapp.wsgi\nLOG_LEVEL=error\ncd $DIR\nsource ../bin/activate\n\nexport DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE\nexport PYTHONPATH=$DIR:$PYTHONPATH\n\nexec ../bin/gunicorn ${DJANGO_WSGI_MODULE}:application \\\n  --name=$NAME \\\n  --workers=$WORKERS \\\n  --user=$USER \\\n  --group=$GROUP \\\n  --bind=$BIND \\\n  --log-level=$LOG_LEVEL \\\n  --log-file=-\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/bin/bash\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"django-leaflet-demo\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"DIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/home/brian/django-leaflet-demo\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"USER"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"brian\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"GROUP"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"brian\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"WORKERS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"BIND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"unix:/home/brian/run/gunicorn.sock\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"DJANGO_SETTINGS_MODULE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"djangoapp.settings\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"DJANGO_WSGI_MODULE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"djangoapp.wsgi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"LOG_LEVEL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"error\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"cd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $DIR\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"source"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ../bin/activate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" DJANGO_SETTINGS_MODULE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$DJANGO_SETTINGS_MODULE\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PYTHONPATH"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$DIR:$PYTHONPATH\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"exec"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ../bin/gunicorn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ${DJANGO_WSGI_MODULE}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":":application"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --name="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --workers="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$WORKERS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --user="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$USER"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --group="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$GROUP"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --bind="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$BIND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --log-level="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$LOG_LEVEL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --log-file=-\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"/etc/nginx/sites-available"}]}]},{"type":"element","tag":"pre","props":{"code":"upstream app_server {\nserver unix:/home/brian/run/gunicorn.sock fail_timeout=0;\n}\n\nserver {\nlisten 80;\nserver_name 159.89.235.193\nkeepalive_timeout 5;\nclient_max_body_size 4G;\naccess_log /home/brian/logs/nginx-access.log;\nerror_log /home/brian/logs/nginx-error.log;\n\nlocation /static/ {\nalias /home/brian/static/;\n}\n\nlocation / {\ntry_files $uri @proxy_to_app;\n}\n\nlocation @proxy_to_app {\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header Host $http_host;\nproxy_redirect off;\nproxy_pass http://app_server;\n}\n}\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"upstream app_server {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"server unix:/home/brian/run/gunicorn.sock fail_timeout=0;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"server {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"listen 80;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"server_name 159.89.235.193\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"keepalive_timeout 5;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"client_max_body_size 4G;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"access_log /home/brian/logs/nginx-access.log;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"error_log /home/brian/logs/nginx-error.log;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"location /static/ {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"alias /home/brian/static/;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"location / {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"try_files $uri @proxy_to_app;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"location @proxy_to_app {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"proxy_set_header Host $http_host;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"proxy_redirect off;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"proxy_pass http://app_server;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, here is the Supervisor configuration file that runs the gunicorn server:"}]},{"type":"element","tag":"pre","props":{"code":"[program:django-leaflet-demo]\ncommand=/home/brian/bin/gunicorn_start\nuser=brian\nautostart=true\nautorestart=true\nredirect_stderr=true\nstdout_logfile=/home/brian/logs/gunicorn-error.log\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[program:django-leaflet-demo]\ncommand=/home/brian/bin/gunicorn_start\nuser=brian\nautostart=true\nautorestart=true\nredirect_stderr=true\nstdout_logfile=/home/brian/logs/gunicorn-error.log\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I would definitely like to dive into DigitalOcean deployment in more depth in my next post."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For now, you can view the live project on DigitalOcean here: "},{"type":"element","tag":"a","props":{"href":"http://159.89.235.193/books/","rel":["nofollow"]},"children":[{"type":"text","value":"http://159.89.235.193/books/"}]},{"type":"text","value":". In the future I would like to use this Droplet to do more demo apps like this one as I continue to learn the ins and outs of using Django and more frontend tools. Thanks for reading to the end and let me know if you have any comments or critiques on how I went about this project, I would be happy to hear from you!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"live-demo-on-digitalocean","depth":3,"text":"Live Demo on DigitalOcean"},{"id":"django-model","depth":2,"text":"Django model"},{"id":"plotting-books-on-a-map","depth":2,"text":"Plotting books on a map"},{"id":"login-redirect","depth":2,"text":"Login Redirect"},{"id":"authors","depth":2,"text":"Authors"},{"id":"filtering-data","depth":2,"text":"Filtering Data"},{"id":"exporting-data-as-csv-or-xls","depth":2,"text":"Exporting data as CSV or XLS"},{"id":"finding-books-nearby","depth":2,"text":"Finding \"Books Nearby\""},{"id":"testing-travis-ci","depth":2,"text":"Testing & Travis CI"},{"id":"deploying-to-digitalocean","depth":2,"text":"Deploying to DigitalOcean"}]}},"_type":"markdown","_id":"content:2018:02:19:leaflet-maps-with-django.md","_source":"content","_file":"2018/02/19/leaflet-maps-with-django.md","_stem":"2018/02/19/leaflet-maps-with-django","_extension":"md"},{"_path":"/2018/01/30/reading-13f-sec-filings-with-python","_dir":"30","_draft":false,"_partial":false,"_locale":"","title":"Reading 13F SEC filings with python","description":"How to read SEC filing data with Python","layout":"post","date":"2018-01-30T00:00:00.000Z","comments":true,"image":"/static/sec/sec.jpg","tags":["sec","python","data","scraping"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Update"}]},{"type":"text","value":": This project has been updated, please see "},{"type":"element","tag":"a","props":{"href":"/2020/11/29/weekend-project-update-open-sec-data"},"children":[{"type":"text","value":"this article"}]},{"type":"text","value":" to read about the most recent updates."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://opensecdata.ga","rel":["nofollow"]},"children":[{"type":"text","value":"https://opensecdata.ga"}]},{"type":"text","value":" (project staging website, deployed to docker swarm cluster running on DigitalOcean)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/sec-filings-app","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/sec-filings-app"}]},{"type":"text","value":" (main repository, requires GitLab account)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/sec-filings-app","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/briancaffey/sec-filings-app"}]},{"type":"text","value":" (mirror, no account required to view)"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The SEC Form 13F is a filing with the Securities and Exchange Commission (SEC) also known as the Information Required of Institutional Investment Managers Form. It is a quarterly filing required of institutional investment managers with over $100 million in qualifying assets. -"},{"type":"element","tag":"a","props":{"href":"https://www.investopedia.com/terms/f/form-13f.asp","rel":["nofollow"]},"children":[{"type":"text","value":"Investopedia"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article I will show how to collect and parse 13F filing data from the SEC."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, use "},{"type":"element","tag":"a","props":{"href":"https://www.sec.gov/edgar/searchedgar/companysearch.html","rel":["nofollow"]},"children":[{"type":"text","value":"EDGAR"}]},{"type":"text","value":" to search the company of interest."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"EDGAR, the Electronic Data Gathering, Analysis, and Retrieval system, performs automated collection, validation, indexing, acceptance, and forwarding of submissions by companies and others who are required by law to file forms with the U.S. Securities and Exchange Commission (the \"SEC\"). -"},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/EDGAR","rel":["nofollow"]},"children":[{"type":"text","value":"Wikipedia"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Click on the Central Index Key (CIK) of the company you are search for, and then click on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Documents"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You'll want to grab the HTML version of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Information Table"}]},{"type":"text","value":". I have saved them in a folder with their file names cooresponding to their dates ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"YYYY-MM-DD"}]},{"type":"text","value":" format)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For this example, I have manually collected the files for a few years of data filed by a hedge fund. Here are the files I'll be working with:"}]},{"type":"element","tag":"pre","props":{"code":"files = os.listdir(\"13f/\")\nprint(*sorted(files), sep=\"\\n\")\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"files "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.listdir("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"13f/\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"sorted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(files), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"sep"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"pre","props":{"code":"2014-02-14.html\n2014-05-15.html\n2014-08-14.html\n2014-11-14.html\n2015-02-17.html\n2015-05-14.html\n2015-08-14.html\n2015-11-12.html\n2016-02-16.html\n2016-05-16.html\n2016-08-12.html\n2016-11-14.html\n2017-02-14.html\n2017-05-15.html\n2017-08-10.html\n2017-10-30.html\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"2014-02-14.html\n2014-05-15.html\n2014-08-14.html\n2014-11-14.html\n2015-02-17.html\n2015-05-14.html\n2015-08-14.html\n2015-11-12.html\n2016-02-16.html\n2016-05-16.html\n2016-08-12.html\n2016-11-14.html\n2017-02-14.html\n2017-05-15.html\n2017-08-10.html\n2017-10-30.html\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick script we can use to parse information from each filing document:"}]},{"type":"element","tag":"pre","props":{"code":"def scrape_13f(file):\n    date = file\n    html = open(\"13f/\"+file).read()\n    soup = BeautifulSoup(html, 'lxml')\n    rows = soup.find_all('tr')[11:]\n    positions = []\n    for row in rows:\n        dic = {}\n        position = row.find_all('td')\n        dic[\"NAME_OF_ISSUER\"] = position[0].text\n        dic[\"TITLE_OF_CLASS\"] = position[1].text\n        dic[\"CUSIP\"] = position[2].text\n        dic[\"VALUE\"] = int(position[3].text.replace(',', ''))*1000\n        dic[\"SHARES\"] = int(position[4].text.replace(',', ''))\n        dic[\"DATE\"] = date.strip(\".html\")\n        positions.append(dic)\n\n    df = pd.DataFrame(positions)\n    return df\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" scrape_13f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    html "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"13f/\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").read()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    soup "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" BeautifulSoup(html, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lxml'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    rows "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" soup.find_all("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'tr'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"11"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" row "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" rows:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        position "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" row.find_all("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'td'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"NAME_OF_ISSUER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"TITLE_OF_CLASS\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"CUSIP\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"VALUE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"','"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"SHARES\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"','"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DATE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" date.strip("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\".html\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        positions.append(dic)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    df "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pd.DataFrame(positions)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" df\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using this function we can get a quick snapshot of this hedge fund by filing total over the last 4 years:"}]},{"type":"element","tag":"pre","props":{"code":"fund_growth = [sum(scrape_13f(file).VALUE) for file in sorted(files)]\ndates = [f.strip('.html') for f in sorted(files)]\nplt.figure(figsize=(10,5))\nplt.title('Total Fund Size')\nplt.xlabel('Filing Date')\nplt.ylabel('USD')\nplt.bar(dates, fund_growth)\nplt.yticks()\nplt.xticks(rotation='vertical')\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"fund_growth "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"sum"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(scrape_13f("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"VALUE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sorted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(files)]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dates "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [f.strip("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'.html'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" f "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sorted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(files)]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.figure("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"figsize"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.title("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Total Fund Size'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.xlabel("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Filing Date'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.ylabel("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'USD'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.bar(dates, fund_growth)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.yticks()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.xticks("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"rotation"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'vertical'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/sec/fund_size.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"fund-positions-with-bubble-chart"},"children":[{"type":"text","value":"Fund Positions with Bubble Chart"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, it would be great to get a snapshot of the stocks owned by this fund in a given year. Let's use a D3 bubble chart. The names for each stock are quite long, so first let's convert them to stock ticker values. Here's a quick script I hacked together using a Fidelity lookup service:"}]},{"type":"element","tag":"pre","props":{"code":"cusip_nums = set()\nfor file in files:\n    cusip_nums = cusip_nums | set(scrape_13f(file).CUSIP)\n\nticker_dic = {c:\"\" for c in cusip_nums}\nfor c in list(ticker_dic.keys()):\n    url = \"http://quotes.fidelity.com/mmnet/SymLookup.phtml?reqforlookup=REQUESTFORLOOKUP&productid=mmnet&isLoggedIn=mmnet&rows=50&for=stock&by=cusip&criteria=\"+c+\"&submit=Search\"\n    html = requests.get(url).text\n    soup = BeautifulSoup(html, 'lxml')\n    ticker_elem = soup.find('tr', attrs={\"bgcolor\":\"#666666\"})\n    ticker = \"\"\n    try:\n        ticker = ticker_elem.next_sibling.next_sibling.find('a').text\n        ticker_dic[c] = ticker\n    except:\n        pass\n\n    time.sleep(1)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cusip_nums "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" files:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cusip_nums "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cusip_nums "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(scrape_13f("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CUSIP"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ticker_dic "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {c:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cusip_nums}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" list"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(ticker_dic.keys()):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"http://quotes.fidelity.com/mmnet/SymLookup.phtml?reqforlookup=REQUESTFORLOOKUP&productid=mmnet&isLoggedIn=mmnet&rows=50&for=stock&by=cusip&criteria=\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"c"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"&submit=Search\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    html "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" requests.get(url).text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    soup "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" BeautifulSoup(html, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lxml'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ticker_elem "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" soup.find("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'tr'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"attrs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"bgcolor\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"#666666\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"})\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ticker "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    try"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ticker "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ticker_elem.next_sibling.next_sibling.find("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'a'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ticker_dic[c] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ticker\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    except"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        pass\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    time.sleep("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I couldn't get all the CUSIP numbers, but I was able to get most of them. Some of the CUSIP numbers have changed for certain stocks and couldn't be looked up with this service. For now I won't fill these in. With the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ticker_dic"}]},{"type":"text","value":" dictionary, we can make a quick edit to our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"scrape_13f"}]},{"type":"text","value":" function to populate ticker data for each holding:"}]},{"type":"element","tag":"pre","props":{"code":"ticker_dict = {'00206R102': 'T', '00507V109': 'ATVI', '00724F101': 'ADBE', ... }\n\ndef scrape_13f(file):\n    date = file\n    html = open(\"13f/\"+file).read()\n    soup = BeautifulSoup(html, 'lxml')\n    rows = soup.find_all('tr')[11:]\n    positions = []\n    for row in rows:\n        dic = {}\n        position = row.find_all('td')\n        dic[\"NAME_OF_ISSUER\"] = position[0].text\n        dic[\"TITLE_OF_CLASS\"] = position[1].text\n        dic[\"CUSIP\"] = position[2].text\n        dic[\"VALUE\"] = int(position[3].text.replace(',', ''))*1000\n        dic[\"SHARES\"] = int(position[4].text.replace(',', ''))\n        dic[\"DATE\"] = date.strip(\".html\")\n        dic[\"TICKER\"] = ticker_dict[position[2].text]\n        positions.append(dic)\n\n    df = pd.DataFrame(positions)\n    return df\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ticker_dict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'00206R102'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'T'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'00507V109'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ATVI'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'00724F101'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ADBE'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" scrape_13f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    date "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    html "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"13f/\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").read()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    soup "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" BeautifulSoup(html, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lxml'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    rows "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" soup.find_all("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'tr'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"11"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" row "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" rows:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        position "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" row.find_all("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'td'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"NAME_OF_ISSUER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"TITLE_OF_CLASS\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"CUSIP\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"VALUE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"','"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"SHARES\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text.replace("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"','"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DATE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" date.strip("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\".html\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        dic["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"TICKER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ticker_dict[position["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].text]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        positions.append(dic)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    df "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pd.DataFrame(positions)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" df\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's check this:"}]},{"type":"element","tag":"pre","props":{"code":"df = scrape_13f(files[2])\nprint(df[[\"CUSIP\", \"NAME_OF_ISSUER\", \"TICKER\"]].head())\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"df = scrape_13f(files[2])\nprint(df[[\"CUSIP\", \"NAME_OF_ISSUER\", \"TICKER\"]].head())\n"}]}]},{"type":"element","tag":"pre","props":{"code":"       CUSIP         NAME_OF_ISSUER TICKER\n0  88579Y101                  3M CO    MMM\n1  G1151C101  ACCENTURE PLC IRELAND    ACN\n2  02209S103       ALTRIA GROUP INC     MO\n3  03076C106    AMERIPRISE FINL INC    AMP\n4  035710409    ANNALY CAP MGMT INC    NLY\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"       CUSIP         NAME_OF_ISSUER TICKER\n0  88579Y101                  3M CO    MMM\n1  G1151C101  ACCENTURE PLC IRELAND    ACN\n2  02209S103       ALTRIA GROUP INC     MO\n3  03076C106    AMERIPRISE FINL INC    AMP\n4  035710409    ANNALY CAP MGMT INC    NLY\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take a look at the last filing, Q4 2017."}]},{"type":"element","tag":"pre","props":{"code":"q4_2017 = sorted(files)[-1]\ndf_q4_2017 = scrape_13f(q4_2017)\n\ntop_20 = df_q4_2017.sort_values(by=\"VALUE\", ascending=False)[[\"TICKER\", \"VALUE\"]][:40]\na = top_20.TICKER\nb = top_20.VALUE\nc = range(len(b))\n\nfig = plt.figure(figsize=(15,5))\nax = fig.add_subplot(111)\nax.bar(c, b)\n\nplt.xticks(c, a, rotation=90)\nplt.title('Top 40 Stock Holdings by Value')\nplt.xlabel('Stock Ticker')\nplt.ylabel('USD (10 MM))')\nplt.show()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"q4_2017 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sorted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(files)["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"df_q4_2017 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" scrape_13f(q4_2017)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"top_20 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" df_q4_2017.sort_values("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"by"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"VALUE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"ascending"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"False"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")[["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"TICKER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"VALUE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]][:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"40"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"a "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" top_20."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"TICKER\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"b "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" top_20."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"VALUE\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" range"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"len"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(b))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"fig "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" plt.figure("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"figsize"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"15"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ax "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" fig.add_subplot("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"111"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ax.bar(c, b)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.xticks(c, a, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"rotation"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"90"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.title("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Top 40 Stock Holdings by Value'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.xlabel("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Stock Ticker'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.ylabel("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'USD (10 MM))'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"plt.show()\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/sec/2017_filing.png"},"children":[]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"fund-positions-with-bubble-chart","depth":2,"text":"Fund Positions with Bubble Chart"}]}},"_type":"markdown","_id":"content:2018:01:30:reading-13f-sec-filings-with-python.md","_source":"content","_file":"2018/01/30/reading-13f-sec-filings-with-python.md","_stem":"2018/01/30/reading-13f-sec-filings-with-python","_extension":"md"}]