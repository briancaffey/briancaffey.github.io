[{"_path":"/2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt","_dir":"01","_draft":false,"_partial":false,"_locale":"","title":"Session Authentication with Django, Django REST Framework and Nuxt","description":"This article shows how to use session authentication with Django + Nuxt.js applications","date":"2021-01-01T00:00:00.000Z","image":"/static/django_nuxt_auth_og.png","tags":["django","vue","nuxt","drf","authentication"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will be a continuation of the discussion about how data flows in Django + Nuxt applications, looking specifically at session authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a GitLab repo that where you can find the source code and other diagrams related to this project:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/django-nuxt-starter","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/django-nuxt-starter"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This diagram focuses on the interactions between:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I. The browser"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"II. The Nuxt server (Node process)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"III. The Django backend API server (gunicorn process)"}]},{"type":"element","tag":"h2","props":{"id":"context"},"children":[{"type":"text","value":"Context"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For illustration purposes, I'm using a simple CRUD application that has two models: Users and (blog) Posts. Users can log in with email and password credentials and create, read, update and delete blog posts (CRUD). Currently I'm only doing the R (read) of CRUD: listing and viewing blog posts. Creating, updating and delete will be added later. For now, users must be logged in to see posts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm still learning a lot about Nuxt and how it can be used with Django and Django REST Framework. This project is an effort at documenting my learning process, learning in public and learning from mistakes, so any feedback or guidance on what I have written here would be highly appreciated!"}]},{"type":"element","tag":"h2","props":{"id":"why-nuxt"},"children":[{"type":"text","value":"Why Nuxt?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using Nuxt (with Server Side Rendering, or SSR) is one of many ways to use Vue.js with Django. Vue is a progressive framework, which means that it can be gradually adopted into a project--you don't have to go all-in on the framework or rewrite the application from scratch to fit with how Vue works."}]},{"type":"element","tag":"h3","props":{"id":"different-ways-to-use-vue-with-django"},"children":[{"type":"text","value":"Different ways to use Vue with Django"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In terms of Django, here are some ways that you can use Vue:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue as a jQuery replacement for adding basic interactivity in views served by Django templates"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Build a static Vue application and serve it as a set of static assets in a Django project alongside routes that are served by other normal Django templates views."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Build a Vue SPA which consumes a Django API (usually built with Django REST Framework or similar), and serve it over a content delivery network (CDN)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use Vue to build an Electron desktop app that uses Django as an API"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In these scenarios, Vue is served as either static assets (such as in the case of serving a SPA over a CDN), or Vue code is included in an HTML response from a server (where the view library, not your application, is served over a CDN), similar to how jQuery is used."}]},{"type":"element","tag":"h3","props":{"id":"different-ways-to-use-nuxt"},"children":[{"type":"text","value":"Different ways to use Nuxt"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Nuxt is a Framework that can be used in a few different ways, I'll briefly discus three ways in which Nuxt can be used. Common to all three of these ways of using Nuxt is the directory structure. No matter how you use Nuxt, it provides a great way to organize Vue code."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Static mode: this mode allows you to write Vue code which is built into a static HTML, and then that HTML is deployed to a CDN or webserver like NGINX. The developer (or CI/CD process) runs a command to generate HTML files for each page in the application, and these pages are served as-is when accessed by a user. I recently migrated my personal blog from Jekyll to Nuxt with full-static mode. Check it out at ("},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io","rel":["nofollow"]},"children":[{"type":"text","value":"briancaffey.github.io"}]},{"type":"text","value":")."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"SPA mode: This is similar to what you might use if you started a Vue project with Vue CLI. The project is also generated as in Static Mode, but what is generated is primarily Javascript code that is executed on the browser."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"SSR mode: Server Side Rendering is the mode that I'll be focusing on here. Unlike the other ways of using Vue that have already been discussed, this mode involves a Node.js server that will handle our requests. For example, a web request for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" is sent to our Nuxt Server (a Node.js server process) and Node.js is responsible for returning HTML that contains all of the blog Posts that we want to show (or a paginated selection of all blog posts, which is how my example blog app is built). So the Nuxt app has to make a request to our Django API server before returning fully rendered HTML page for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" page. The user then gets the page from Nuxt, reads all of the blog posts and then decides to check out the blog posts on the second page of posts. When the user clicks on page 2, we request the second page of data from our Django API directly, not from Nuxt. The user then sees a short loading animation followed by the second page of blog posts that are loaded in using AJAX (usually with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fetch"}]},{"type":"text","value":" or axios)."}]}]},{"type":"element","tag":"h3","props":{"id":"nuxt-benefits"},"children":[{"type":"text","value":"Nuxt Benefits"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The main reason for using Nuxt is to render the first page loads on the server, returning a complete HTML response that can be beneficial for SEO, social sharing, and other scenarios where you need control over how a website's pages are delivered (specifically, the initial request made to the server)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This type of control is not possible for applications that serve Vue over CDN since they can only request backend API data once the JS client has been requested from a CDN."}]},{"type":"element","tag":"h3","props":{"id":"nuxt-downsides-and-tradeoffs"},"children":[{"type":"text","value":"Nuxt Downsides and Tradeoffs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using Nuxt for SSR introduces quite a bit of complexity in both the application deployment and our Vue code. The backend API won't have to change at all when moving to Nuxt from a static Vue SPA."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Django alone is capable of returning fully generated, SEO-optimized HTML for each request, but applications built with Vue and Django templates may be difficult to work on as the project grows larger and larger. The Django/DRF + Nuxt approach may be more appropriate for projects with dedicated backend and frontend teams."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other potential downside is added latency because of the \"double request\". If the Nuxt server and the Django server are on the same machine, then this latency will probably be a non-issue."}]},{"type":"element","tag":"h2","props":{"id":"diagram"},"children":[{"type":"text","value":"Diagram"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Nuxt Django Auth","src":"/static/django_nuxt_auth.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This diagram looks at session authentication with a focus on the browser, the Nuxt server and the Django server. It looks at two simple user stories, ordered from top to bottom in the diagram."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I. An existing application user visits the site in a new browser, navigates to the Login page, logs in with credentials and then visits a protected page: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":".\nII. The user closes the browser and then comes back directly to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" page."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These two user stories sound simple, but they touch on a lot of the features of Nuxt that make it powerful, and complicated at first (for Vue users). These include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vuex on the client and server"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Custom plugin for axios"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Some important parts of Nuxt that this diagram does not (yet) touch on are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Nuxt auth module (I don't know if this is relevant for my use case)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Nuxt fetch property (different from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fetch"}]},{"type":"text","value":" web API)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Nuxt middleware (I'm also not sure if this would be helpful for anything I am doing in this example project)"}]}]},{"type":"element","tag":"h3","props":{"id":"user-story-i-a-user-tries-to-open-posts-is-redirected-to-login-logs-in-then-navigate-to-posts-and-sees-blog-posts"},"children":[{"type":"text","value":"User story I.: A user tries to open "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":", is redirected to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/login"}]},{"type":"text","value":", logs in, then navigate to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" and sees blog posts"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"User navigates to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://domain.com/"}]},{"type":"text","value":". This request is handled by the Nuxt server."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":" action is called ("},{"type":"element","tag":"a","props":{"href":"https://nuxtjs.org/docs/2.x/directory-structure/store#the-nuxtserverinit-action","rel":["nofollow"]},"children":[{"type":"text","value":"read more on nuxtServerInit"}]},{"type":"text","value":"). This is a special Vuex action that, if defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"store/index.js"}]},{"type":"text","value":", will be called once per request to the Nuxt Server (when a page is initially visited or refreshed in the browser)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":" dispatches a Vuex action in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user"}]},{"type":"text","value":" module called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fetchData"}]},{"type":"text","value":". This action makes an GET request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" in the Django application."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An API call to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" is made to the Django backend directly from the Nuxt container over the docker network ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If the request is made by an anonymous user (no user is logged in), a 403 response is returned to the Nuxt server and no account data is set in the Vuex store (on the server)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Since the user is currently not logged in, the request returns a 403 response."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authMiddleware"}]},{"type":"text","value":" (on the Nuxt server) redirects the user to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/login"}]},{"type":"text","value":" based on the value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" in the Vuex store. The Original request for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" returns a fully-rendered "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/login/"}]},{"type":"text","value":" page instead."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"User is now on the Login page"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"created"}]},{"type":"text","value":" hook for the Login page makes a GET request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login-set-cookie/"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"10, 11. This endpoint calls a simple view that is decorated with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@ensure_csrf_token"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ol","props":{"start":12},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the response returns to the browser, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrftoken"}]},{"type":"text","value":" is set in the browser."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The $apiCall function is defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"plugins/axios.js"}]},{"type":"text","value":", and it adds the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrftoken"}]},{"type":"text","value":" cookie to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"X-CSRFToken"}]},{"type":"text","value":" header of API requests. This is important for POST request where the CSRF token is required. When the user fills out their email and password in the login form, the $apiCall function is called with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" and the email/password as credentials."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The email and password are sent as data in the POST request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"15, 16. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" URL calls the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login_view"}]},{"type":"text","value":" which makes use of two functions from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django.contrib.auth"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" gets a user from the provided email/password, and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":" function sets an HttpOnly "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" session cookie on the response."}]},{"type":"element","tag":"ol","props":{"start":17},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The HttpOnly "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie is automatically set on the browser when the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" request returns successfully."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" request returns successfully, a value in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"auth"}]},{"type":"text","value":" Vuex module is set to keep track of the current user's logged in state."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Next, a GET request is made to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"20, 21. Since the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie is set and sent along with the request automatically, this request will succeed."}]},{"type":"element","tag":"ol","props":{"start":22},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" request returns, the user's account information is saved to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user"}]},{"type":"text","value":" Vuex module. At this point, the client may redirect automatically to the home page, or user account page, dashboard, etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Now logged in, the user navigates (again via Vue router) to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":", a page that shows a paginated view of all blog posts."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This page has an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":" method which is called when the page component is created and it dispatches a Vuex action "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"posts/fetchData"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This Vuex action makes a GET request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"26, 27. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":" uses a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ModelViewSet"}]},{"type":"text","value":" and returns a paginated list of blog posts"}]},{"type":"element","tag":"ol","props":{"start":28},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":" request returns successfully, the blog post data is saved to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"blog"}]},{"type":"text","value":" Vuex module."}]}]},{"type":"element","tag":"h3","props":{"id":"user-story-ii-logged-in-user-opens-new-browser-window-and-revisits-posts"},"children":[{"type":"text","value":"User story II.: Logged in user opens new browser window and revisits "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]}]},{"type":"element","tag":"ol","props":{"start":29},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user closes their browser and then opens a new browser window and navigates to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":" is called as usual,"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user/fetchData"}]},{"type":"text","value":" action is called. This action makes a GET request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" request returns successfully. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie is passed along from the browser to the API request that is made from the Nuxt server to the backend API ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":").  User account data is then set on the Vuex "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user"}]},{"type":"text","value":" module."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":" method for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" pages is called."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":" dispatches a Vuex action "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"posts/fetchData"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"posts/fetchData"}]},{"type":"text","value":" makes an API request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":" request is handled by a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ModelViewSet"}]},{"type":"text","value":" for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Post"}]},{"type":"text","value":" model that gets blog posts and then sets them to the Vuex store (on the server) when the request returns a response (to the Nuxt server)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Once the async data fetching is compete ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":" for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts"}]},{"type":"text","value":" page), the page HTML is rendered using the Vuex store data stored on the server. The Vuex data is sent back with the rendered HTML (I think this is how it works)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Finally, the user sees the list of blog posts. The page is loaded \"at once\"; there is no waiting for data to load after loading the page initially."}]}]},{"type":"element","tag":"h2","props":{"id":"discussion"},"children":[{"type":"text","value":"Discussion"}]},{"type":"element","tag":"h3","props":{"id":"complexity"},"children":[{"type":"text","value":"Complexity"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Is this authentication process overly complicated? When I make these diagrams, I try to make simple concept as detailed as possible, but there are a lot of distinct actions being taken in many different parts of the application and getting them all into one diagram was tricky."}]},{"type":"element","tag":"h3","props":{"id":"httponly-session-cookies"},"children":[{"type":"text","value":"HttpOnly Session Cookies"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Session authentication is the officially recommended way to do authentication with Django REST Framework for clients that run in the browser. However, there seem to be lots of people using JWT with DRF and Javascript clients that run in the browser. The main argument against doing this is that the JWT must be stored in a Javascript-accessible store (localStorage or Cookies) so it can be passed with each request. Many people are also interested in trying to store JWT for authentication in HttpOnly cookies to harden client-side security. I'm very curious to know if anyone is actually doing this, and what the implementation looks like. While "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"djangorestframework_simplejwt"}]},{"type":"text","value":" doesn't support HttpOnly, there seems to be lots of interest in doing this. I think it might be possible with a special middleware, so let me know if anyone is interested in proof-of-concept/diagram for that."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Some use cases for JWT and other token authentication methods with DRF might include native mobile apps or Desktop apps. For most cases, I think session authentication with Django's built in session cookies for DRF authentication is the best option. JWTs also have no clear solution for logging out, which may be important for some security considerations. The concept of stateless authentication is interesting, but for most use cases I would argue that it is not worth doing. Let me know if anyone has thoughts on this, I'm curious to see what everyone thinks."}]},{"type":"element","tag":"h3","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My next steps for this project/repo are to deploy this to a production environment as soon as I have time to do so. My local setup has been working well, and I think it should work well for a simple DigitalOcean docker swarm deployment like I have done with other Django + Vue projects."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also want to add the create, update and delete functionality for posts, improve error handling with API calls, add form validation, and maybe write some tests with Jest."}]},{"type":"element","tag":"h2","props":{"id":"questions"},"children":[{"type":"text","value":"Questions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some questions and areas that I still need to investigate."}]},{"type":"element","tag":"h3","props":{"id":"nuxt-composition-api"},"children":[{"type":"text","value":"Nuxt Composition API"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have seen that there is a Composition API module for Nuxt. I have only just now started looking at Composition API examples and documentation for \"vanilla\" Vue, but I have heard that the Nuxt Composition API module has some additional features specifically for use with Nuxt, so I'm curious to learn what these are."}]},{"type":"element","tag":"h3","props":{"id":"nuxt-v3-and-vue-3"},"children":[{"type":"text","value":"Nuxt v3 and Vue 3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Nuxt looks like it has plans to support Vue 3, so I am interested to learn more about Vue 3 as it is adopted by Vue frameworks such as Nuxt and Quasar."}]},{"type":"element","tag":"h3","props":{"id":"nuxts-fetch-method-server-middleware-nuxt-auth-module"},"children":[{"type":"text","value":"Nuxt's fetch method, server middleware, Nuxt auth module"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think I am using server middleware correctly, it can be improved by redirecting to the initial requested route after successful login. I'm not sure if I should use the Nuxt auth module in this application, I have read that it doesn't support HttpOnly cookie use cases, but I could be wrong."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"context","depth":2,"text":"Context"},{"id":"why-nuxt","depth":2,"text":"Why Nuxt?","children":[{"id":"different-ways-to-use-vue-with-django","depth":3,"text":"Different ways to use Vue with Django"},{"id":"different-ways-to-use-nuxt","depth":3,"text":"Different ways to use Nuxt"},{"id":"nuxt-benefits","depth":3,"text":"Nuxt Benefits"},{"id":"nuxt-downsides-and-tradeoffs","depth":3,"text":"Nuxt Downsides and Tradeoffs"}]},{"id":"diagram","depth":2,"text":"Diagram","children":[{"id":"user-story-i-a-user-tries-to-open-posts-is-redirected-to-login-logs-in-then-navigate-to-posts-and-sees-blog-posts","depth":3,"text":"User story I.: A user tries to open /posts, is redirected to /login, logs in, then navigate to /posts and sees blog posts"},{"id":"user-story-ii-logged-in-user-opens-new-browser-window-and-revisits-posts","depth":3,"text":"User story II.: Logged in user opens new browser window and revisits /posts"}]},{"id":"discussion","depth":2,"text":"Discussion","children":[{"id":"complexity","depth":3,"text":"Complexity"},{"id":"httponly-session-cookies","depth":3,"text":"HttpOnly Session Cookies"},{"id":"next-steps","depth":3,"text":"Next Steps"}]},{"id":"questions","depth":2,"text":"Questions","children":[{"id":"nuxt-composition-api","depth":3,"text":"Nuxt Composition API"},{"id":"nuxt-v3-and-vue-3","depth":3,"text":"Nuxt v3 and Vue 3"},{"id":"nuxts-fetch-method-server-middleware-nuxt-auth-module","depth":3,"text":"Nuxt's fetch method, server middleware, Nuxt auth module"}]}]}},"_type":"markdown","_id":"content:2021:01:01:session-authentication-with-django-django-rest-framework-and-nuxt.md","_source":"content","_file":"2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt.md","_stem":"2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt","_extension":"md"},{"_path":"/2020/12/27/building-web-applications-with-django-drf-and-nuxt","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"Building web applications with Django, Django REST Framework, Nuxt.js and docker","description":"This article documents my progress combining the Django web framework with Nuxt JS to build applications that have both great SEO and a smooth SPA user experience.","date":"2020-12-27T00:00:00.000Z","image":"/static/django_nuxt_app_diagram.png","tags":["django","vue","nuxt","drf","docker"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Over the holidays between lots of big meals and many naps, I tried to tackle one more goal of mine before this year come to an end: building an application with Django and Nuxt.js."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This year I rebuilt my personal blog ("},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/","rel":["nofollow"]},"children":[{"type":"text","value":"briancaffey.github.io"}]},{"type":"text","value":") with Nuxt.js, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxt/content"}]},{"type":"text","value":" headless git-based CMS and TailwindCSS. It is statically generated with Nuxt's full-static mode and has been really enjoyable to work with. I have also learned a lot more about SEO and how Nuxt helps improve Vue applications' SEO. I have also been working a lot with Django and Vue.js applications where Django serves as an API to a Vue.js SPA. This combination of technologies works well for a lot of use cases, but it falls short in SEO. Nuxt also provides a great way to organize large Vue.js projects which I have been finding very helpful. For these reasons, combining Django and Nuxt has been something that I have wanted to try for a while, so this article will share some of my experiences in recent efforts to build with these two frameworks. I took "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/django-nuxt-starter/-/blob/develop/STEP_BY_STEP.md","rel":["nofollow"]},"children":[{"type":"text","value":"detailed notes of each step of the project setup"}]},{"type":"text","value":" starting from an empty repository, and I put together a diagram of my understanding of how data flows in the application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the link to the project repository that I'll be referencing: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/django-nuxt-starter","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/django-nuxt-starter"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will focus on explaining the project through the diagram shown below. I added two types of labels: letters and numbers. The letters will introduce each component of the application and its role in the application as a whole. The numbers summarize how data flows through the different components in my sample blog application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Diagram","src":"/static/django_nuxt_app_diagram.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"diagram-components"},"children":[{"type":"text","value":"Diagram components"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A. Your computer - Possibly also your development machine which is running the application in docker containers with docker-compose."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"B. NGINX - This is the \"front desk\" of the application that does a few different things. It is the first component that web requests come to. It serves as a reverse proxy which does path-based routing. It looks at the URL request and determines where to send it. For example: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/1"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/dashboard/"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/"}]},{"type":"text","value":" could all be routed differently depending on the NGINX configuration file. We will look at this again in the next section. This  component, like most of the other things in the diagram, runs in a container. NGINX can also serve static files for our Django app and do TLS termination to make our application available over a secure HTTPS connection."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C. Nuxt.JS server - The first \"S\" in SSR (server side rendering). It is a Node.js process that renders HTML from Vue components that we define in our Nuxt app, as well as data fetched from other servers/APIs before returning HTML back to the client."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"D. Django server - This runs the WSGI application with a gunicorn process in a container."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"E. Django REST Framework is a Django package the facilitates the creation of REST API endpoints. This is part of the Django application, it primarily takes care of data serialization (which can be thought of as translating between JSON and Python objects that represent rows of data in our Postgres database)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"F. This is the Postgres database, also a containerized service. It is on the same docker network as the Django/gunicorn application, so the Django application can connect to the Postgres database using the hostname "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"G. docker-compose is used to orchestrate the docker network, containers and volumes that make up the application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"H. This box represents the docker network that allows for easy networking between services. We will come back to this the significance of this in the next section."}]},{"type":"element","tag":"h2","props":{"id":"data-flow-in-the-application"},"children":[{"type":"text","value":"Data flow in the application"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The simple application I have built for this demonstration is a blog. There is only a list view and a detail view for simple blog post model with three fields: title, body and created date. For the list view, the frontend (Nuxt) route is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts/"}]},{"type":"text","value":" and the backend route is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":" for the detail view the frontend route is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts/_id"}]},{"type":"text","value":" and the API route is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/_id/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The data flow shown here will walk through what happens when a user visits "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/posts/"}]},{"type":"text","value":", and then show what happens when the user clicks on one of the listed posts to see the detail view of the post ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/posts/2"}]},{"type":"text","value":")."}]},{"type":"element","tag":"ol","props":{"start":0},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":" is one command that is used to start the entire application in local development. This exposes the NGINX process on port 80 of the host machine (your laptop)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the application is running on your machine and you navigate to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/posts/"}]},{"type":"text","value":", the request is first handled by NGINX."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"As we mentioned earlier, NGINX's path-based routing sends all requests that do not start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/*"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/*"}]},{"type":"text","value":" to the Nuxt.js server."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the request gets to the Nuxt server, the Nuxt lifecycle methods start. The important one that I'm using so far is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":". This property is used to request data that will be used in the rendering of our HTML response."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Inside of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":", the application uses axios to make a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/posts/"}]},{"type":"text","value":" (for example). In "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":", the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"privateRuntimeConfig"}]},{"type":"text","value":" sets a baseUrl value for axios to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend:8000"}]},{"type":"text","value":". Since the Nuxt server is on the same docker network as the backend Django/gunicorn server, the Nuxt server is able to resolve "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend"}]},{"type":"text","value":" to the address of the backend server."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django processes this endpoint, using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PostViewSet"}]},{"type":"text","value":", the views of which have been added to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urlpatterns"}]},{"type":"text","value":" in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"blog/urls.py"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PostViewSet"}]},{"type":"text","value":" makes a database query on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"posts"}]},{"type":"text","value":" which is used to serialize the data."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Django server returns the response to the original axios call."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The data returned from Django is used to render the HTML response."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The HTML response from the Nuxt server is sent back to the browser that originally navigated to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/posts/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user is presented with page that lists blog posts. Each blog posts lists to a detail view. When a blog post (let's say the post with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"id"}]},{"type":"text","value":" of 2) is clicked on, a request for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/posts/2/"}]},{"type":"text","value":" is made directly to the Django backend. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"browserBaseURL"}]},{"type":"text","value":" value in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"axios"}]},{"type":"text","value":" settings under "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"publicRuntimeConfig"}]},{"type":"text","value":" defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":" is set to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost"}]},{"type":"text","value":", so the request is made to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/api/posts/2/"}]},{"type":"text","value":". To clarify, since we are making this request using axios in the browser, we can't make a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend:8000/api/posts/2/"}]},{"type":"text","value":" like we did in step 4 ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend:8000/api/posts/"}]},{"type":"text","value":") because the browser doesn't know how to resolve the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" hostname."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/api/posts/2/"}]},{"type":"text","value":", like all others, first goes to NGINX which sends it to the backend since the path starts with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/"}]},{"type":"text","value":". At this point the application functions like a regular Vue SPA making axios calls to a backend service. This is because we used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<nuxt-link>"}]},{"type":"text","value":" for the posts listed in the posts list view. If we used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<a>"}]},{"type":"text","value":" tags, we would go through the same process as in step 4 where the HTML is rendered on the Nuxt server and sent back to the browser all at once."}]}]},{"type":"element","tag":"h2","props":{"id":"discussion"},"children":[{"type":"text","value":"Discussion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My main takeaway is that using Nuxt and Django together can give you good SEO and a great SPA experience at the same time. Using Django alone, or Django with traditional non SSR Vue makes this harder to do. Being a progressive framework, there are a lot of ways to use Vue with any other backend. From what I have heard, most people use Vue via CDN similar to how jQuery was and still is delivered for use in the browser."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is additional work in setting up 3 servers for a single application (Nuxt, Django and NGINX), but the tradeoff is that I am (at least I feel) very productive writing frontend logic in Vue and backend logic with DRF. I have never liked working with Django templates and I used to know a lot more about them than I do now."}]},{"type":"element","tag":"h2","props":{"id":"spotlight-for-baserowios-awesome-open-source-django-nuxt-application"},"children":[{"type":"text","value":"Spotlight for baserow.io's awesome open-source Django Nuxt application"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lastly I want to mention that there are some great resources in the "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community/awesome-nuxt","rel":["nofollow"]},"children":[{"type":"text","value":"nuxt-community/awesome-nuxt"}]},{"type":"text","value":" GitHub repo. There's one project that really stood out to me when I searched for \"django\" projects in the README, and that project is called "},{"type":"element","tag":"a","props":{"href":"https://baserow.io/","rel":["nofollow"]},"children":[{"type":"text","value":"baserow.io"}]},{"type":"text","value":" (repo: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/bramw/baserow","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/bramw/baserow"}]},{"type":"text","value":"). Please check this repo our if you are interested in Django and Nuxt. This company is building an open source no-code database, similar to Airtable which I have worked with before."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Their entire product is open source and I have been very impressed with what I have seen. Please go give that project a star or consider becoming a Github sponsor if you are interested. I'm not affiliated with that project in any way, but I'll be referencing how they use Django and Nuxt to build their application."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a still a lot I have to learn about Nuxt. I'm still very new to the Framework and this is my first time using Nuxt's SSR mode. Nuxt seems to have its own way of doing lots of things that I'm used to doing in Vue. There is a very supportive community and well-maintained official packages to help with lots of things, like the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxt/axios"}]},{"type":"text","value":" package that I'm using."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My next step is to keep expanding my blog application. One thing I didn't mention is authentication. I plan on using Django session authentication for authenticating request to Django. It seems that it already works correctly in my application (logging in through Django admin and then navigating to Nuxt routes that make Django requests are working only when I'm logged in.) I think I have an idea about how Vuex, authentication and route guards will work together, but I haven't gotten there yet. If anyone has some good reference projects or recommendations on how to expand on what I already have, please let me know!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I know that Nuxt has an auth module, so I need to see if that is relevant for what I want need in my application. I also need to continue reading the Nuxt documentation. I still don't know what I don't know about Nuxt and the plugins and modules that it makes available. I also noticed that Nuxt has it's own version of the Vue 3 Composition API, something I am just now starting to learn more about, so that it another area I'll need to dig into eventually."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"diagram-components","depth":2,"text":"Diagram components"},{"id":"data-flow-in-the-application","depth":2,"text":"Data flow in the application"},{"id":"discussion","depth":2,"text":"Discussion"},{"id":"spotlight-for-baserowios-awesome-open-source-django-nuxt-application","depth":2,"text":"Spotlight for baserow.io's awesome open-source Django Nuxt application"},{"id":"next-steps","depth":2,"text":"Next steps"}]}},"_type":"markdown","_id":"content:2020:12:27:building-web-applications-with-django-drf-and-nuxt.md","_source":"content","_file":"2020/12/27/building-web-applications-with-django-drf-and-nuxt.md","_stem":"2020/12/27/building-web-applications-with-django-drf-and-nuxt","_extension":"md"},{"_path":"/2020/11/29/weekend-project-update-open-sec-data","_dir":"29","_draft":false,"_partial":false,"_locale":"","title":"Weekend project update: Open SEC Data","description":"This project uses Django, DRF and Celery to read public SEC filings from sec.gov, build it into an API which is consumed through a Vue.js application.","date":"2020-11-29T00:00:00.000Z","image":"/static/sec-update.jpg","tags":["django","vue","data","api","gitlab","docker","celery"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an early look at a project I have been working on to practice some Django and Vue.js concepts: Open SEC Data."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://opensecdata.ga","rel":["nofollow"]},"children":[{"type":"text","value":"https://opensecdata.ga"}]},{"type":"text","value":" (project staging website, deployed to docker swarm cluster running on DigitalOcean)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/sec-filings-app","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/sec-filings-app"}]},{"type":"text","value":" (main repository, requires GitLab account)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/sec-filings-app","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/briancaffey/sec-filings-app"}]},{"type":"text","value":" (mirror, no account required to view)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This project uses Django, DRF and Celery to read public SEC filings from "},{"type":"element","tag":"a","props":{"href":"https://www.sec.gov/Archives/edgar/full-index/","rel":["nofollow"]},"children":[{"type":"text","value":"sec.gov"}]},{"type":"text","value":", build it into an API which is consumed through a Vue.js application. I'm currently focused on 13F filings which are required for large US investment funds managing over $100 million USD. There is data dating back to 1993 and it is published quarterly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the things I'm focusing on in this project in no particular order:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Getting better at Django REST Framework. This project has been helping me apply some of the parts of DRF that I have found difficult. I'm currently using ViewSets which feels function-based views inside of class-based views. They are flexible, but I would like to add more abstraction with filtering"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django admin. While this project primarily uses Django as a REST API with Django REST Framework, I have tried to take advantage of the Django admin to build out helpful views that can be used to spot check the data I'm creating. Most of my API is read-only, this makes things pretty simple."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Moderately complex paginated data tables with Vue. I work with lots of paginated table data, and I think there is a better way to do abstract some of the repeated logic that I use (getting and setting current page, rows per page). I'm using Vuex, and I have heard of module factories, but I'm thinking that there will be a better way to do this when Vue 3 officially comes to Quasar Framework (Quasar is a Vue.js framework)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Session authentication with DRF. There are a lot of guides showing how to use JWT and Token Authentication for DRF with Javascript frontends. The DRF recommends using Session Authentication for such use cases as a web-base Javascript client, so I hope I can promote some best practices around how to use Django's built-in session authentication for use with the Django REST Framework using an HttpOnly session cookie. I also understand that all security decisions have trade-offs, and I'm trying to understand what trade-offs come with handling authentication in this way."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Social authentication. I have previously setup social authentication with Google, Facebook and GitHub using Python Social Auth. I think it is a great package, and it adds a lot of flexibility with it's concept of pipelines, but I haven't done much with these yet, so I'm hoping to dig in further and better understand how I can make better use of social authentication in my app. This app uses Linkedin 0Auth2 with a custom user model. Logging in with Linkedin account gives you the ability to request an API Token (Django REST Framework's Token) to access the public API."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automatic API documentation with OpenAPI. Swagger/OpenAPI seems like nice way to document and API, so I'm hoping to build best practices around how to document a DRF API automatically with OpenAPI and Swagger UI."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CI/CD with GitLab and docker swarm. I will admit that I am huge GitLab fan. I love how flexible their CI/CD pipelines are. Being a docker fan as well, I chose to use docker swarm for this project to keep things simple and straightforward. I think one under-appreciate feature of docker is being able to set "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" to an SSH connection, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh://root@123.456.789.10"}]},{"type":"text","value":". This let's you control the remote docker host without needing to SSH to it first, and it is also how I'm able to deploy and run management commands \"manually\" through the GitLab UI."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Productive development environment. To start the project, you only need to run docker-compose up (after copying "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".env.template"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".env"}]},{"type":"text","value":" in the root directory for storing sensitive data outside of git such as LinkedIn OAuth2 keys). The development environment is very similar to how this project runs in production with some additional utilities for monitoring and debugging such as pgadmin4, flower (for celery), redis commander (a GUI for viewing redis databases), Django debug toolbar (a must have for any Django project, I believe), runserver_plus with Werkzeug, and others. Also, the backend and frontend hot reload automatically with the help of webpack for Vue and watchdog for Django and Celery."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automatic TLS certificate generation with Traefik. For a simple project in docker swarm, I'm really happy with how simple it is to request TLS certificates from Let's Encrypt automatically with Traefik. There are no scripts, cron jobs or one-time setup jobs, it just seems to work out of the box if configured correctly."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing with pytest. I have only been trying to test most of my API views so far. I really like using factory with pytest, so I use that in most of my tests."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's all I have for now. I have a long list of questions, things I want to improve, add and experiment with, here are just a few that come to mind:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Frontend testing. I don't have any component testing or e2d tests, so this would be good to add eventually. Since I'm using a component library and my app uses these components directly, I'm not exactly sure how much testing I should be doing."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Data verification/validation. There are a lot of site that do provide similar data, WhaleWisdom is the biggest one that I know of. Once I get more data built on the site it would be good to spot check some of the values. There are some nuances to the filing data that I haven't addressed, such as Amendment filings and additions."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Calculating period changes. One of the features that I'm not sure how best to implement is the ability to sort holdings for a filer in a given period on the percent increase from the last period. One way would be to add these as additional fields to the Holding model and then calculate these values as I process the data in celery. If I process the data from recent periods to later periods, I will have to update these values once the previous period has been processed, so it would be an additional check to do. I'll probably post this question here in more detail later. Here's "},{"type":"element","tag":"a","props":{"href":"https://whalewisdom.com/filer/ubs-ag#tabholdings_tab_link","rel":["nofollow"]},"children":[{"type":"text","value":"an example of what this means from WhaleWisdom"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Accessing LinkedIn profile data to populate fields on my CustomUser model."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Scaling? I have a lot more experience with deploying projects to AWS which is built around the ability to scale. I don't know a project on DigitalOcean would be scaled automatically. A single node docker swarm cluster while take some time to process all of the data. I would probably be better of scaling vertically with much bigger droplets and higher celery concurrency."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Docker swarm secrets. I'm currently using environment variables to pass secrets stored in GitLab CI when I build images and deploy to docker swarm. I would like to learn how to properly use swarm secrets and work them into my CI/CD pipeline."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"As I mentioned above, I'm also interested in updating this project to Vue3 and to apply some of its new features to this project."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use pipenv, poetry or some other way of pinning secondary python dependencies. Does anyone have a recommendation on how best to do this with docker. I have always thought that docker "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"is"}]},{"type":"text","value":" the virtual environment, but I realize that some versions of indirect dependencies may change when pip installing without using a lockfile similar to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"package-lock.json"}]},{"type":"text","value":"."}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:2020:11:29:weekend-project-update-open-sec-data.md","_source":"content","_file":"2020/11/29/weekend-project-update-open-sec-data.md","_stem":"2020/11/29/weekend-project-update-open-sec-data","_extension":"md"},{"_path":"/2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"How to authenticate Django REST Framework API calls from a (Vue) JS client using Session Authentication and HttpOnly cookies","description":"This article will describe an authentication strategy using Django REST Framework with a Javascript frontend application. I'll be demonstrating this with Vue.js (Qusar Framework, using Vue 2), but the concepts should transfer to any other Javascript framework.","layout":"post","date":"2020-11-27T00:00:00.000Z","comments":true,"image":"/static/padlocks.jpg","tags":["django","vue","authentication","api"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will describe an authentication strategy using Django REST Framework with a Javascript frontend application. I'll be demonstrating this with Vue.js (Qusar Framework, using Vue 2), but the concepts should transfer to any other Javascript framework."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a GitLab repository for a project that I will be referencing throughout this article: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/verbose-equals-true/django-postgres-vue-gitlab-ecs","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/verbose-equals-true/django-postgres-vue-gitlab-ecs"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I first started learning about how to do authentication from a Vue client, I found "},{"type":"element","tag":"a","props":{"href":"https://blog.sqreen.com/authentication-best-practices-vue/","rel":["nofollow"]},"children":[{"type":"text","value":"this article from Sqreen"}]},{"type":"text","value":" which describes how to use JWT to authenticate a Vue application. The example uses a mocked backend, but it is a good proxy for what you would have if you were to use a library like "},{"type":"element","tag":"a","props":{"href":"https://github.com/SimpleJWT/django-rest-framework-simplejwt","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-rest-framework-simplejwt"}]}]},{"type":"text","value":", which I have previously used with success in Django projects."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"JWT is an option for doing authentication with DRF "},{"type":"element","tag":"a","props":{"href":"https://www.django-rest-framework.org/api-guide/authentication/#json-web-token-authentication","rel":["nofollow"]},"children":[{"type":"text","value":"listed in the authentication documentation"}]},{"type":"text","value":", but the documentation doesn't recommend when or how to use JWT authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Session authentication is mentioned as well:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This authentication scheme uses Django's default session backend for authentication. Session authentication is appropriate for AJAX clients that are running in the same session context as your website."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my project, both in local development and in production environments, I serve the API and the Javascript clients on the same domain. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/*"}]},{"type":"text","value":" requests go to the API, and all other request paths route to the frontend client. In other scenarios such as using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://api.mysite.com"}]},{"type":"text","value":" for hosting a frontend and API an different subdomains, there would need to be additional considerations for CORS, but since I have the frontend and the backend being served on the same domain (and same subdomain), this isn't a concern. You might need to watch out for this if your requirements are different."}]},{"type":"element","tag":"h2","props":{"id":"the-authentication-flow"},"children":[{"type":"text","value":"The authentication flow"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's describe the login process at a high level."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A user navigates to your site. There is currently nothing in the browser's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localStorage"}]},{"type":"text","value":" or cookies related to authentication."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user navigates to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Login"}]},{"type":"text","value":" page at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/login"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Loading this Vue component makes a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"GET"}]},{"type":"text","value":" request to a special endpoint in our Django backend "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login-set-cookie/"}]},{"type":"text","value":". This request returns a simple JSON message: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"CSRF cookie set\""}]},{"type":"text","value":", and as the message says, the response sets a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrf"}]},{"type":"text","value":" cookie on our browser."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Once the CSRF cookie is set by the response from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login-set-cookie/"}]},{"type":"text","value":", the user is presented with a login form and enters account credentials (email and password in my example, where email is the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"USERNAME_FIELD"}]},{"type":"text","value":" on my custom user model). Clicking \"Login\" dispatches a Vuex action that uses Axios to send a send a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"csrf"}]},{"type":"text","value":" cookie set in a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"X-CSRFToken"}]},{"type":"text","value":" header."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" is handled by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login_view"}]},{"type":"text","value":" view which uses two important functions from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django.contrib.auth"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticate"}]},{"type":"text","value":" gets the user from the provided credentials, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login"}]},{"type":"text","value":" sets a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" HttpOnly cookie on the response."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the response from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/login/"}]},{"type":"text","value":" comes back, two things happen: first the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" HttpOnly cookie is set on our browser. Second, we set a value in both Vuex and localStorage named "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"success"}]},{"type":"text","value":". We are not storing any sensitive information in this value. Instead, we are using this value to signal to the rest of our Vue application that the user has authenticated. Storing this in Vuex allows us to use global Vuex "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"getters"}]},{"type":"text","value":" so that we can change component state and other logic where authentication is concerned, such as route guards (for Vue router). We store it in localStorage so that when a new browser tab is opened, we can set the value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" in Vuex based on the value in localStorage. ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated: localStorage.getItem(\"authenticated\") || \"\","}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Since the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie is HttpOnly, we can't use Javascript to interact with it, so when we want to logout the user we can't just delete the cookie. To logout the user, we make a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/logout/"}]},{"type":"text","value":" when the user clicks on the logout button. The view for this endpoint does "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"logout(request)"}]},{"type":"text","value":". This returns a response with a new value for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" cookie: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Set-Cookie: sessionid=\"\"; expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; Path=/; SameSite=Lax"}]},{"type":"text","value":". Since the cookie's expiration is in the past, it is removed entirely. We also remove the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" localStorage item and set the Vuex store value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"authenticated"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"''"}]},{"type":"text","value":" (which is falsey). This lets the Vue application know that user has been logged out. One consideration for this is that your user can't logout while offline."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This repo also implements social authentication with the fantastic Python Social Auth library. I used Facebook, Google and GitHub, but there are lots of other providers you can choose from depending on what you need. This is a lengthy topic, and I recommend that you read "},{"type":"element","tag":"a","props":{"href":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end","rel":["nofollow"]},"children":[{"type":"text","value":"How to Integrate OAuth 2 Into Your Django/DRF Back-end Without Going Insane"}]},{"type":"text","value":" on which I have based my implementation. Here's the short story of how this works. First, a user clicks on one of the social sign-in links. These links are the same for sign-in and sign-up."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The link has a few parts, here's an example: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://github.com/login/oauth/authorize?client_id=r66bdfgsfsbferfef4&redirect_uri=http:%2F%2Flocalhost%2Fauth%2Fgithub%2Fcallback&login=&scope=user:email&state=ewori4t95k3vdzem"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"client_id"}]},{"type":"text","value":" is the app we created to allow our users to sign in. When you create this app, you specify the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redirect_uri"}]},{"type":"text","value":" in the configuration, and you reference that here as well. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"scope"}]},{"type":"text","value":" specifies scope of access we are requesting from the user's social account. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"state"}]},{"type":"text","value":" is used for security."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When you click on the link above, you are redirected to GitHub and asked if you want to grant my GitHub application access to your account's associated email address. Clicking on \"Authorize\" then redirects you back to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redirect_uri"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://localhost/auth/github/callback?code=veroi3409e203ej&state=ewori4t95k3vdzem"}]},{"type":"text","value":". Notice the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"code"}]},{"type":"text","value":" parameter."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When you navigate to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/auth/github/callback"}]},{"type":"text","value":" on the Vue application, you see a message: \"Logging in with GitHub...\". On this page's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"mounted"}]},{"type":"text","value":" method we call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handleOauthCallback"}]},{"type":"text","value":" which makes a request to our Django application: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/social/github/?code=veroi3409e203ej"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This API endpoint uses the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"exchange_token"}]},{"type":"text","value":" view which is where Python Social Auth starts to do the heavy lifting. First, we need to make an API request to GitHub ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://github.com/login/oauth/access_token"}]},{"type":"text","value":") with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"code"}]},{"type":"text","value":" as a URL parameter, then we pass the access code that this API call returns into Python Social Auth's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"do_auth"}]},{"type":"text","value":" function to get our Django user. Finally, similar to the email/password login approach described above, we call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"login(request, user)"}]},{"type":"text","value":" and return a simple JSON response: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{\"detail\": \"success\"}"}]},{"type":"text","value":". This will set the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sessionid"}]},{"type":"text","value":" automatically when the response returns, and we can dispatch the same Vuex action "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AUTH_SUCCESS"}]},{"type":"text","value":" to tell Vuex that a user has been logged in."}]}]},{"type":"element","tag":"h2","props":{"id":"discussion"},"children":[{"type":"text","value":"Discussion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the default Django session authentication mechanism has some nice advantages. It allows us to easily navigate between our Javascript SPA which uses Django REST Framework, regular Django admin views that you may also be using, as well as the Django admin."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using DRF's token authentication is still possible if you choose to use Session authentication for your JS frontend. For example, you may wish to allow users to make authenticated API requests to your public API using DRF Token Authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"JWT is a really interesting concept and important to know about, but it doesn't seem like a practical solution for any of my use cases with Django APIs or frontends. You also can't really \"logout\" a user if you are using this solution for authentication."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"What I have described here is pretty simple scenario. It assumes that there is only one type of user and that there are no additional steps needed to make your account \"active\". Doing this would require additional logic on the Vue/Vuex side as well as the backend logic, including the User model. I also don't make use of any data from the social providers except for the user's email address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another thing to be aware of with this scenario is that a user can register with social authentication first, and then reset their password and login with email (I haven't implemented this client-side on this project yet). Or, you can login with an email account that was created through the Django admin and then login with a social account tied to that email. There are a lot of options for each backend in Python social auth, making it a very flexible library for handling social authentication."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a lot more work to do on this example project regarding authentication, but I hope it can help point some people in the right direction. Here are some areas that I would like to work on next:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Error handling for a bad authentication attempt"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A signup form with email confirmation, handling cases where the user trying to signup may already have signed in with social authentication"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Password reset with email"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Making use of Python Social Auth settings and options, including pipelines."}]}]},{"type":"element","tag":"h2","props":{"id":"resources"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://yoongkang.com/blog/cookie-based-authentication-spa-django/","rel":["nofollow"]},"children":[{"type":"text","value":"https://yoongkang.com/blog/cookie-based-authentication-spa-django/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/encode/django-rest-framework/issues/7273","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/encode/django-rest-framework/issues/7273"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/SimpleJWT/django-rest-framework-simplejwt/issues/71","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/SimpleJWT/django-rest-framework-simplejwt/issues/71"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/","rel":["nofollow"]},"children":[{"type":"text","value":"http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/"}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"the-authentication-flow","depth":2,"text":"The authentication flow"},{"id":"discussion","depth":2,"text":"Discussion"},{"id":"next-steps","depth":2,"text":"Next Steps"},{"id":"resources","depth":2,"text":"Resources"}]}},"_type":"markdown","_id":"content:2020:11:27:how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","_source":"content","_file":"2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","_stem":"2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies","_extension":"md"},{"_path":"/2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp","_dir":"10","_draft":false,"_partial":false,"_locale":"","title":"How to add an email signup form to a Nuxt site with MailChimp","description":"This is a guide for setting up a MailChimp-powered newsletter signup form on a static Nuxt site hosted on GitHub Pages. I wanted to implement this on my personal blog to grow a mailing list so I can update readers when I puslish a new blog article. I haven't done too much work with MailChimp before, but I've definitely subscribed to plenty of MailChimp mailing lists.","layout":"post","date":"2020-10-11T00:00:00.000Z","comments":true,"image":"/static/chimps.webp","tags":["nuxt","mailchimp","vue"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a guide for setting up a MailChimp-powered newsletter signup form on a static Nuxt site hosted on GitHub Pages. I wanted to implement this on my personal blog to grow a mailing list so I can update readers when I puslish a new blog article. I haven't done too much work with MailChimp before, but I've definitely subscribed to plenty of MailChimp mailing lists."}]},{"type":"element","tag":"h2","props":{"id":"goals"},"children":[{"type":"text","value":"Goals"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm hoping to acheive some of the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Build a list of emails from people who visit my site and want get"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Include a simple newletter signup form (Vue) component in the Footer of my site"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Send customized emails (campaigns) to a mailing list that I can track"}]}]},{"type":"element","tag":"h2","props":{"id":"questions"},"children":[{"type":"text","value":"Questions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the questions (and answers) that I had going into this:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Do I need to use the MailChimp API or MailChimp API keys? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"No"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Is "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Double Opt-In"}]},{"type":"text","value":" possible with a static GitHub pages site hosted on a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<usernme>.github.io"}]},{"type":"text","value":" subdomain? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What is the signup flow? Will a new subscriber be sent to a MailChimp page first, and then back to my site? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How do I setup a \"Thank you\" page to show users after they subscribe?"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How much will this cost? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Free up to 2,000 subscribers"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Should I create a new campaign for each new blog post email update I send out? ("},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Yes"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll touch on these questions as I describe how to set things up."}]},{"type":"element","tag":"h2","props":{"id":"creating-the-form"},"children":[{"type":"text","value":"Creating the form"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms"}]},{"type":"text","value":" menu, I selected the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Embedded Forms"}]},{"type":"text","value":" option:"}]},{"type":"element","tag":"pre","props":{"code":"Embedded forms\nGenerate HTML code to embed in your site or blog to collect signups.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Embedded forms\nGenerate HTML code to embed in your site or blog to collect signups.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of the MailChimp Admin that I have been using seems to have 4 different menus: 2 vertical menus and 2 horizontal."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Embedded forms"}]},{"type":"text","value":" menu, I selected "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Unstyled"}]},{"type":"text","value":" since I want to add my own Tailwind CSS classes to keep the style of my signup form consistent with the different color schemes available on my site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll start with an Unstyled Embedded form. Let's go through the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form options"}]},{"type":"text","value":":"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Include form title"}]},{"type":"text","value":" (no, I'll add this myself)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Show only required fields"}]},{"type":"text","value":" (For now, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"email"}]},{"type":"text","value":" is the only field I will be capturing. It can be helpful to include a First and/or Last name to avoid having your emails go to users' spam folders.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Unselect everything else"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the HTML that we can use in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscribe.vue"}]},{"type":"text","value":" component:"}]},{"type":"element","tag":"pre","props":{"code":"    <!-- Begin Mailchimp Signup Form -->\n    <div id=\"mc_embed_signup\">\n      <form\n        action=\"https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&amp;id=9937fe4fc5\"\n        method=\"post\"\n        id=\"mc-embedded-subscribe-form\"\n        name=\"mc-embedded-subscribe-form\"\n        class=\"validate\"\n        target=\"_blank\"\n        novalidate\n      >\n        <div id=\"mc_embed_signup_scroll\">\n          <div class=\"mc-field-group\">\n            <!-- <label for=\"mce-EMAIL\">Email Address </label> -->\n            <!-- Added placeholder -->\n            <input\n              type=\"email\"\n              value=\"\"\n              name=\"EMAIL\"\n              class=\"required email\"\n              id=\"mce-EMAIL\"\n              placeholder=\"Enter your email address\"\n            />\n          </div>\n          <div id=\"mce-responses\" class=\"clear\">\n            <div\n              class=\"response\"\n              id=\"mce-error-response\"\n              style=\"display: none\"\n            ></div>\n            <div\n              class=\"response\"\n              id=\"mce-success-response\"\n              style=\"display: none\"\n            ></div>\n          </div>\n          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->\n          <div style=\"position: absolute; left: -5000px\" aria-hidden=\"true\">\n            <input\n              type=\"text\"\n              name=\"b_43a795784ca963e25903a0da6_9937fe4fc5\"\n              tabindex=\"-1\"\n              value=\"\"\n            />\n          </div>\n          <div class=\"clear\">\n            <input\n              type=\"submit\"\n              value=\"Subscribe\"\n              name=\"subscribe\"\n              id=\"mc-embedded-subscribe\"\n              class=\"button\"\n            />\n          </div>\n        </div>\n      </form>\n    </div>\n\n    <!--End mc_embed_signup-->\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    <!-- Begin Mailchimp Signup Form -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc_embed_signup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"&amp;"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"id=9937fe4fc5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"post\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe-form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe-form\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"validate\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        target"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"_blank\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"        novalidate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      >\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc_embed_signup_scroll\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-field-group\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            <!-- <label for=\"mce-EMAIL\">Email Address </label> -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            <!-- Added placeholder -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"email\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"EMAIL\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"required email\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-EMAIL\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              placeholder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Enter your email address\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-responses\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"clear\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-error-response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"display: none\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ></"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mce-success-response\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"display: none\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ></"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" style"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"position: absolute; left: -5000px\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" aria-hidden"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"true\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"text\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"b_43a795784ca963e25903a0da6_9937fe4fc5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              tabindex"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"-1\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"clear\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"input\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"submit\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mc-embedded-subscribe\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"              class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"button\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"form"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    <!--End mc_embed_signup-->\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we can create a Vue component that contains the HTML form generated by the MailChimp admin. For now, just put the embed HTML in the template of a Vue component."}]},{"type":"element","tag":"h2","props":{"id":"styling-the-form"},"children":[{"type":"text","value":"Styling the form"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next you can add styles to the form. You can reference the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscribe.vue"}]},{"type":"text","value":" file in the repo for this site to see how I have added styles using TailwindCSS."}]},{"type":"element","tag":"h2","props":{"id":"settings"},"children":[{"type":"text","value":"Settings"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next let's look at some settings around Double Opt-in."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To navigate to the page where these settings can be set, go to:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms > Settings > Audience name and defaults"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form Settings"}]},{"type":"text","value":" of this menu, you can select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Enable double opt-in"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, let's configure the redirect to a custom \"Thank you for subscribing page\" on our static site. Go to"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Audience > Signup forms > Signup forms"}]},{"type":"text","value":" and select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form builder"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Select "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Signup thank you page"}]},{"type":"text","value":" from the dropdown menu and add a custom URL that you will show users when they first submit their email to the form."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, also on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Form Builder"}]},{"type":"text","value":" menu, select "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Confirmation thank you page"}]},{"type":"text","value":" from the dropdown menu and enter the URL of the page that you want to redirect to after a user confirms their subscription where it says: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Instead of showing this thank you page, send subscribers to another URL"}]}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Form validation"}]},{"type":"text","value":": we can validate that the user has entered a valid email address"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GDPR considerations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Captcha"}]}]},{"type":"element","tag":"h2","props":{"id":"resources"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Single vs Double Opt-in"}]},{"type":"text","value":": "},{"type":"element","tag":"a","props":{"href":"https://www.sendinblue.com/blog/double-opt-in/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.sendinblue.com/blog/double-opt-in/"}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"goals","depth":2,"text":"Goals"},{"id":"questions","depth":2,"text":"Questions"},{"id":"creating-the-form","depth":2,"text":"Creating the form"},{"id":"styling-the-form","depth":2,"text":"Styling the form"},{"id":"settings","depth":2,"text":"Settings"},{"id":"next-steps","depth":2,"text":"Next Steps"},{"id":"resources","depth":2,"text":"Resources"}]}},"_type":"markdown","_id":"content:2020:10:10:how-to-add-email-signup-form-to-nuxt-site-with-mailchimp.md","_source":"content","_file":"2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp.md","_stem":"2020/10/10/how-to-add-email-signup-form-to-nuxt-site-with-mailchimp","_extension":"md"},{"_path":"/2020/09/17/migrating-from-jekyll-to-nuxt-static-site","_dir":"17","_draft":false,"_partial":false,"_locale":"","title":"Migrating my personal GitHub pages blog from Jekyll to Nuxt","description":"Jekyll has served me well for a long time, but I've decided to switch the static site generator I use for my personal blog from Jekyll to Nuxt. This article will hopefully be the first new article in my Nuxt blog.","layout":"post","date":"2020-09-17T00:00:00.000Z","comments":true,"image":"/static/nuxt-app.png","tags":["nuxt","vue","content","static-site","web"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Jekyll has served me well for a long time, but I've decided to switch the static site generator I use for my personal blog from Jekyll to Nuxt. This article will hopefully be the first new article in my Nuxt blog."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some goals for what I want to do with this new site:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Learn more about Nuxt and Nuxt Content, JAM Stack and static site generation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Master TailwindCSS for building responsive layouts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Better understand and measure SEO for my site and the content I publish on it"}]}]},{"type":"element","tag":"h2","props":{"id":"creating-a-nuxt-project"},"children":[{"type":"text","value":"Creating a nuxt project"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm going to start off with a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-nuxt"}]},{"type":"text","value":" feature branch. Since I can't create the nuxt project in a non-empty directory, I'll create a new nuxt project in a folder called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"brian@x1:~/github/briancaffey.github.io/nuxt$ npx create-nuxt-app .\n\ncreate-nuxt-app v3.2.0\n  Generating Nuxt.js project in .\n(node:8073) ExperimentalWarning: Conditional exports is an experimental feature. This feature could change at any time\n? Project name: brian-caffey\n? Programming language: JavaScript\n? Package manager: Yarn\n? UI framework: Tailwind CSS\n? Nuxt.js modules: Axios, Content\n? Linting tools: ESLint, Prettier\n? Testing framework: None\n? Rendering mode: Universal (SSR / SSG)\n? Deployment target: Static (Static/JAMStack hosting)\n? Development tools: jsconfig.json (Recommended for VS Code if you're not using typescript)\nyarn run v1.22.5\n$ eslint --ext .js,.vue --ignore-path .gitignore . --fix\nDone in 1.57s.\n\n  Successfully created project brian-caffey\n\n  To get started:\n\n        yarn dev\n\n  To build & start for production:\n\n        yarn build\n        yarn start\n","language":"txt","meta":"","className":"language-txt shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"brian@x1:~/github/briancaffey.github.io/nuxt$ npx create-nuxt-app .\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"create-nuxt-app v3.2.0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  Generating Nuxt.js project in .\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"(node:8073) ExperimentalWarning: Conditional exports is an experimental feature. This feature could change at any time\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Project name: brian-caffey\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Programming language: JavaScript\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Package manager: Yarn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? UI framework: Tailwind CSS\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Nuxt.js modules: Axios, Content\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Linting tools: ESLint, Prettier\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Testing framework: None\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Rendering mode: Universal (SSR / SSG)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Deployment target: Static (Static/JAMStack hosting)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"? Development tools: jsconfig.json (Recommended for VS Code if you're not using typescript)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"yarn run v1.22.5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"$ eslint --ext .js,.vue --ignore-path .gitignore . --fix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"Done in 1.57s.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  Successfully created project brian-caffey\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  To get started:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn dev\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  To build & start for production:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        yarn start\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Running the following:"}]},{"type":"element","tag":"pre","props":{"code":"yarn generate\nyarn start\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"yarn generate\nyarn start\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Starts my project on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localhost:3000"}]},{"type":"text","value":":"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Nuxt app","src":"/static/nuxt-app.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"tricky-parts"},"children":[{"type":"text","value":"Tricky parts"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the parts of migrating that I need to think about:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Disqus comments"}]},{"type":"text","value":": I previously based the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"disqus_identifier"}]},{"type":"text","value":" used to link Disqus threads to specific pages on Jekyll's page URLs (of the form "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/YYYY/MM/DD/name-of-article.html"}]},{"type":"text","value":"). I could transform the slug value with a hook in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":", or manually add a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"disqus_identifier"}]},{"type":"text","value":" value to the frontmatter of markdown files."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Static Content"}]},{"type":"text","value":": In Jekyll I had static content in a few different places. With Nuxt, all static content will live under the top level folder "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":" that is mapped to the root URL where my site is hosted. Since I had lots of content under "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":" in my Jekyll site, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static/my-image.png"}]},{"type":"text","value":", I ended up putting conent in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static/static"}]},{"type":"text","value":", hopefully this won't be too confusing."}]}]},{"type":"element","tag":"h2","props":{"id":"nuxt-community"},"children":[{"type":"text","value":"Nuxt Community"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a lot of great packages from the "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt-community"}]}]},{"type":"text","value":" GitHub organization that are widely used in many Nuxt projects. Here are a few of the Nuxt community plugins and other Nuxt extensions that I have used so far:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://content.nuxtjs.org/","rel":["nofollow"]},"children":[{"type":"text","value":"nuxt/content"}]},{"type":"text","value":": an official Nuxt project that provides a Git-based Headless CMS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/tailwindcss"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/color-mode"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/google-analytics"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/sitemap"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxtjs/feed"}]}]}]},{"type":"element","tag":"h2","props":{"id":"issues"},"children":[{"type":"text","value":"Issues"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Tailwind removes markdown styles in blog articles from nuxt/content (solved by adding some extra css with "},{"type":"element","tag":"a","props":{"href":"https://github.com/iandinwoodie/github-markdown-tailwindcss/blob/master/markdown.css","rel":["nofollow"]},"children":[{"type":"text","value":"this"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"No support for automatically adding markdown anchors (GitHub Flavored Markdown supports this)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Not able to do true server-side redirects, but you can do something like this: "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community/redirect-module/issues/1#issuecomment-615070920","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/nuxt-community/redirect-module/issues/1#issuecomment-615070920"}]}]}]},{"type":"element","tag":"h2","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add tags, categories, search to blog"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"creating-a-nuxt-project","depth":2,"text":"Creating a nuxt project"},{"id":"tricky-parts","depth":2,"text":"Tricky parts"},{"id":"nuxt-community","depth":2,"text":"Nuxt Community"},{"id":"issues","depth":2,"text":"Issues"},{"id":"todo","depth":2,"text":"TODO"}]}},"_type":"markdown","_id":"content:2020:09:17:migrating-from-jekyll-to-nuxt-static-site.md","_source":"content","_file":"2020/09/17/migrating-from-jekyll-to-nuxt-static-site.md","_stem":"2020/09/17/migrating-from-jekyll-to-nuxt-static-site","_extension":"md"},{"_path":"/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","_dir":"09","_draft":false,"_partial":false,"_locale":"","title":"Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray","description":"A guide to deploying Django applications with docker using popular open-source tools","layout":"post","date":"2020-08-09T00:00:00.000Z","comments":true,"image":"/static/shark.jpg","tags":["django","docker","digital-ocean","vue","gitlab","rex-ray","traefik","nginx","swarm"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently wrote two articles about deploying Django applications to AWS serverless environments: one on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Fargate"}]},{"type":"text","value":" (CloudFront, ALB and ECS Fargate containers) and one on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Lambda"}]},{"type":"text","value":" (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of "},{"type":"element","tag":"a","props":{"href":"https://aws.amazon.com/cdk/","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK)"}]},{"type":"text","value":", an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to \"just use a VPS\" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets)."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a link to my project that I'll be referencing: "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article."}]},{"type":"element","tag":"h2","props":{"id":"overview"},"children":[{"type":"text","value":"Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the key parts of the project that I'll go over:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DigitalOcean and GitLab setup"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Creating an A Record that points to our Droplet IP"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using a prebuilt VM image that ships with docker and docker-compose"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a docker swarm cluster"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" file to build images and push them to a private GitLab CI project registry"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Writing a docker-compose file to configure the services (containers) that will support the application"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django project settings and management commands for our Postgres database and static files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Monitoring, logging and debugging"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Destroying the environment + cleanup"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before I dig into all of this, I recommend that you check out "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev/django-prod-architectures.html","rel":["nofollow"]},"children":[{"type":"text","value":"this article about Django production architectures by Matt Segal"}]},{"type":"text","value":". This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev","rel":["nofollow"]},"children":[{"type":"text","value":"mattsegal.dev"}]},{"type":"text","value":" has lots of good content related to Django, I also recommend checking out "},{"type":"element","tag":"a","props":{"href":"https://mattsegal.dev/nginx-django-reverse-proxy-config.html","rel":["nofollow"]},"children":[{"type":"text","value":"this article about how NGINX is used with Django"}]},{"type":"text","value":". Thanks for the great resources, Matt!"}]},{"type":"element","tag":"h2","props":{"id":"digitalocean-setup"},"children":[{"type":"text","value":"DigitalOcean setup"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sign up for a new DigitalOcean account if you don't already have one"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a DigitalOcean project "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/projects/new","rel":["nofollow"]},"children":[{"type":"text","value":"https://cloud.digitalocean.com/projects/new"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/account/api/tokens","rel":["nofollow"]},"children":[{"type":"text","value":"https://cloud.digitalocean.com/account/api/tokens"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/","rel":["nofollow"]},"children":[{"type":"text","value":"this article"}]},{"type":"text","value":" for more information)"}]}]},{"type":"element","tag":"h2","props":{"id":"prebuilt-docker-vm-image"},"children":[{"type":"text","value":"Prebuilt Docker VM image"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"From the "},{"type":"element","tag":"a","props":{"href":"https://cloud.digitalocean.com/droplets/new","rel":["nofollow"]},"children":[{"type":"text","value":"Create Droplets"}]},{"type":"text","value":" page, select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Marketplace"}]},{"type":"text","value":" and search for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":". Select the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Docker 5:19.03.1~3 18.04"}]},{"type":"text","value":" image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For Authentication, select the SSH key that you created earlier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Take note of the Droplet's IP address; we will use this in the next step."}]},{"type":"element","tag":"h2","props":{"id":"gitlab-setup"},"children":[{"type":"text","value":"GitLab setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Settings > CI/CD > Variables"}]},{"type":"text","value":" in your GitLab project and add the following environment variables:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SSH_PRIVATE_KEY"}]},{"type":"text","value":": the value should start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-----BEGIN RSA PRIVATE KEY-----"}]},{"type":"text","value":" and end with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-----END RSA PRIVATE KEY-----"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DROPLET_IP"}]},{"type":"text","value":": the IP address of the droplet you just created"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POSTGRES_PASSWORD"}]},{"type":"text","value":": a secure password that we will use for our Postgres database (we will share this with our Django application later on)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SECRET_KEY"}]},{"type":"text","value":": a random secret key to use for our Django application."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DEBUG"}]},{"type":"text","value":": the number "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"0"}]}]}]},{"type":"element","tag":"h2","props":{"id":"a-record"},"children":[{"type":"text","value":"A Record"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".tk"}]},{"type":"text","value":" domain from "},{"type":"element","tag":"a","props":{"href":"https://www.freenom.com/en/freeandpaiddomains.html","rel":["nofollow"]},"children":[{"type":"text","value":"freenom"}]},{"type":"text","value":". I have used this before and it is a great option for testing things out."}]},{"type":"element","tag":"h2","props":{"id":"ssh-into-your-digitalocean-droplet"},"children":[{"type":"text","value":"SSH into your DigitalOcean Droplet"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can do this with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1_rsa"}]},{"type":"text","value":" is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly."}]},{"type":"element","tag":"h2","props":{"id":"add-the-rex-ray-docker-plugin"},"children":[{"type":"text","value":"Add the REX-Ray docker plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This step is very simple, you can follow along with this short guide: "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is basically one command to run:"}]},{"type":"element","tag":"pre","props":{"code":"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You will need to make sure that you replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"YOUR_DIGITALOCEAN_TOKEN"}]},{"type":"text","value":" with the personal access token you added earlier. Also, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOBS_REGION"}]},{"type":"text","value":" should be the region you selected for your Droplet earlier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check that the plugin was installed correctly with:"}]},{"type":"element","tag":"pre","props":{"code":"docker plugin ls\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker plugin ls\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick intro to REX-Ray from "},{"type":"element","tag":"a","props":{"href":"https://rexray.readthedocs.io/en/stable/","rel":["nofollow"]},"children":[{"type":"text","value":"rexray.readthedocs.io"}]},{"type":"text","value":":"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article."}]},{"type":"element","tag":"h2","props":{"id":"gitlab-ciyml"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over "},{"type":"element","tag":"a","props":{"href":"https://docs.gitlab.com/ee/ci/yaml/","rel":["nofollow"]},"children":[{"type":"text","value":"this page from the GitLab documentation"}]},{"type":"text","value":" which goes over all of the configuration options with many examples. Also, "},{"type":"element","tag":"a","props":{"href":"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html","rel":["nofollow"]},"children":[{"type":"text","value":"this documentation page"}]},{"type":"text","value":" covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CI/CD pipelines that I define with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":" typically contain three stages: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"test"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":". We will focus on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-backend"}]},{"type":"text","value":" is the name of a GitLab CI job that builds and tags a docker image from the source code in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the YAML code for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-backend"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"build-backend:\n  stage: build\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  before_script:\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - |\n      docker build \\\n        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n        -f backend/docker/Dockerfile.prod \\\n        ./backend/\n    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"build-backend"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      docker build \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        -f backend/docker/Dockerfile.prod \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        ./backend/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build-nginx"}]},{"type":"text","value":" is almost identical, but the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" arguments are slightly different. There are three arguments for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command that I'm using here:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":": the tag to tag the built image with"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":": the Dockerfile to be used for building the image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"context"}]},{"type":"text","value":" that is sent to the docker daemon when we build the image"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" makes use of two predefined GitLab CI variables: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_REGISTRY_IMAGE"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_COMMIT_SHORT_SHA"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$CI_REGISTRY_IMAGE"}]},{"type":"text","value":" is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"registry.gitlab.com/<gitlab_username>/<project_name>"}]},{"type":"text","value":", and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_COMMIT_SHORT_SHA"}]},{"type":"text","value":" is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tag"}]},{"type":"text","value":", even though we pass in more than just this value. We combine these two values with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":" and the name of the image we are building, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", so the full value being passed to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" is:"}]},{"type":"element","tag":"pre","props":{"code":"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":" is the path to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Dockerfile"}]},{"type":"text","value":" we are using relative to the directory where we are running the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command, which is the root directory of the project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":", we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ADD"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" -- we will get to these soon). There's a key difference between the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" commands: the context for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", but the context for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command to hang. The first line of output from a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":" command should be something like this:"}]},{"type":"element","tag":"pre","props":{"code":"Sending build context to Docker daemon  24.58kB\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Sending build context to Docker daemon  24.58kB\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If this number is too high, you should use a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".dockerignore"}]},{"type":"text","value":" file that ignores any files or directories you don't want to send to the docker daemon (similar to how "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":" works with git)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker login"}]},{"type":"text","value":" command in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":" as well two other predefined GitLab CI variables: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_JOB_TOKEN"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CI_REGISTRY"}]},{"type":"text","value":". This all happens using a special service called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-in-docker"}]},{"type":"text","value":" which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" -- and can define additional containers -- the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"services"}]},{"type":"text","value":" key -- to help with the CI job). Once the two images for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" have been built and pushed, our GitLab CI pipeline moves on to the next stage: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":". In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"initialize a single-node docker swarm cluster on our Droplet and"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"create a docker network that our cluster's services (containers) will use"}]}]},{"type":"element","tag":"h2","props":{"id":"setup-a-docker-swarm-cluster"},"children":[{"type":"text","value":"Setup a docker swarm cluster"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh -i ~/.ssh/a1_rsa root@123.45.578.91"}]},{"type":"text","value":" where "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1_rsa"}]},{"type":"text","value":" is the name of the private key file -- you can ignore the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-i ~/.ssh/a1_rsa"}]},{"type":"text","value":" part if you are using an SSH key called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"id_rsa"}]},{"type":"text","value":"), and run the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker swarm init --advertise-addr DROPLET_IP\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker swarm init --advertise-addr DROPLET_IP\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DROPLET_IP"}]},{"type":"text","value":" with your Droplet's IP address (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"123.45.578.91"}]},{"type":"text","value":"). Check out "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04","rel":["nofollow"]},"children":[{"type":"text","value":"this article"}]},{"type":"text","value":" for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Docker swarm uses docker-compose files, but using docker swarm is very different from running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":", a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" (the command) in production. Many people do this, and several official tutorials will often end with \"now just run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":" and you are done\". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":". It is pretty easy and it works very similarly in both local and production environments, but this guide will be using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use."}]},{"type":"element","tag":"h2","props":{"id":"defining-an-overlay-network"},"children":[{"type":"text","value":"Defining an overlay network"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"SSH into your droplet and run the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker network create --driver=overlay traefik-public\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker network create --driver=overlay traefik-public\n"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's go over one more docker concept that will helpful in the next few steps. When you run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" on your local machine, the docker CLI first looks to see if the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable is set. If it is not, then docker defaults to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"unix:///var/run/docker.sock"}]},{"type":"text","value":", a UNIX socket. Check out "},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock","rel":["nofollow"]},"children":[{"type":"text","value":"this SO post"}]},{"type":"text","value":" titled \"Can anyone explain docker.sock?\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:"}]},{"type":"element","tag":"pre","props":{"code":"DOCKER_HOST=ssh://root@$DOCKER_IP\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"DOCKER_HOST=ssh://root@$DOCKER_IP\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See this article for a more in-depth discussion: "},{"type":"element","tag":"a","props":{"href":"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can try this out locally. Run a container locally, check it with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":", then export the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"export DOCKER_HOST=ssh://root@123.45.678.91\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"export DOCKER_HOST=ssh://root@123.45.678.91\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Replacing "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"123.45.678.91"}]},{"type":"text","value":" with your Droplet IP. Run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:"}]},{"type":"element","tag":"pre","props":{"code":"unset DOCKER_HOST\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"unset DOCKER_HOST\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker ps"}]},{"type":"text","value":" again you should see the containers on your machine. We will be using this idea in the next step when we look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack deploy"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"h2","props":{"id":"docker-stack-deploy"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack deploy"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have done our one-time-setup steps, let's look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" stage of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":", the GitLab CI job that will get our containers running on our Droplet. First, let's break down the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"text","value":" command:"}]},{"type":"element","tag":"pre","props":{"code":"deploy-digital-ocean:\n  stage: deploy\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  variables:\n    DOCKER_HOST: 'ssh://root@$DROPLET_IP'\n  before_script:\n    - apk update && apk add openssh-client bash\n    - mkdir -p ~/.ssh\n    - echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n    - chmod 600 ~/.ssh/id_rsa\n    - eval \"$(ssh-agent -s)\"\n    - ssh-add ~/.ssh/id_rsa\n    - ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - docker stack deploy -c stack.yml my-stack --with-registry-auth\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  variables"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    DOCKER_HOST"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ssh://root@$DROPLET_IP'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk update && apk add openssh-client bash\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mkdir -p ~/.ssh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"chmod 600 ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"eval \"$(ssh-agent -s)\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ssh-add ~/.ssh/id_rsa\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This job uses the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"services"}]},{"type":"text","value":" that our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" stage jobs used. Notice that we set "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"ssh://root@$DROPLET_IP\""}]},{"type":"text","value":", this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":" has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker:19.03.1"}]},{"type":"text","value":" is based on Alpine Linus. This version of Linux is super light weight and doesn't come with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"openssh-client"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bash"}]},{"type":"text","value":", so our first step is to install these with the Alpine package manager, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apk"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"apk update && apk add openssh-client bash\n","language":"sh","meta":"","className":"language-sh shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"apk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" update"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" && "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"apk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" add"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" openssh-client"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" bash\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SSH_PRIVATE_KEY"}]},{"type":"text","value":" environment variable into the body of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"id_rsa"}]},{"type":"text","value":" private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"man ssh-agent"}]},{"type":"text","value":" that provides a little bit more context into why we need to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"eval \"$(ssh-agent -s)\""}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh-add ~/.ssh/id_rsa"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts"}]},{"type":"text","value":" tells our SSH agent about our Droplet so that it doesn't prompt us with a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Do you want to add this server to known hosts? (yes/no)"}]},{"type":"text","value":", or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:"}]},{"type":"element","tag":"pre","props":{"code":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This essentially gives our DigitalOcean Droplet access to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The last command in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy-digital-ocean"}]},{"type":"text","value":" job is:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check out this link from the docker docs on docker stacks "},{"type":"element","tag":"a","props":{"href":"https://docs.docker.com/engine/swarm/stack-deploy/","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.docker.com/engine/swarm/stack-deploy/"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--with-registry-auth"}]},{"type":"text","value":" is important, our command will complete if this is not included, but our application won't start."}]},{"type":"element","tag":"h2","props":{"id":"stackyml"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we are ready to tackle the last big file in our repo: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":". This is a the docker-compose file that we use to deploy our project. The only reason we needed to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker login"}]},{"type":"text","value":" above is because "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" service:"}]},{"type":"element","tag":"h3","props":{"id":"backend"},"children":[{"type":"text","value":"backend"}]},{"type":"element","tag":"pre","props":{"code":"version: '3.4'\nservices:\n  backend:\n  image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n  networks:\n    - main\n  environment:\n    - POSTGRES_PASSWORD\n    - SECRET_KEY\n    - DEBUG\n  volumes:\n    - backendassets:/code/assets\n  depends_on:\n    - postgres\n    - redis\n    - web\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'3.4'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  backend"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"main\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"POSTGRES_PASSWORD\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"SECRET_KEY\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"DEBUG\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"backendassets:/code/assets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  depends_on"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"postgres\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"web\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"image"}]},{"type":"text","value":" is essentially what we defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":", but the syntax is slightly different:"}]},{"type":"element","tag":"pre","props":{"code":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We pass environment variables that we defined in GitLab CI via the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment"}]},{"type":"text","value":" key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The volume "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/code/assets"}]},{"type":"text","value":" and then define our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"STATIC_ROOT"}]},{"type":"text","value":" in Django's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":" to be:"}]},{"type":"element","tag":"pre","props":{"code":"os.path.join(BASE_DIR, \"assets\", \"static\")\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.path.join("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"BASE_DIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"assets\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"static\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Later, when we run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":", files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"network"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"depends_on"}]},{"type":"text","value":" related to to the other services that this application will communicate with. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" is a network defined in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"networks"}]},{"type":"text","value":" part of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":", notice that we reference the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik-public"}]},{"type":"text","value":" network here that we created earlier, as well."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Depends on helps with service startup order, but it is a better practice to use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./wait-for-it.sh"}]},{"type":"text","value":". However, I have never had any issues related to startup order. I'll try adding this later to make things more robust."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":" will start before "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":". Our Django application will communicate to these services by their hostnames: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":". The fact that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"postgres"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":" are all on the same network ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":") means that they can resolve each other by these names. For example, the connection string to redis will look like: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis://redis:6379"}]},{"type":"text","value":". Let's look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DATABASES"}]},{"type":"text","value":" configuration in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":" to see how we connect to Postgres:"}]},{"type":"element","tag":"pre","props":{"code":"DATABASES = {\n    \"default\": {\n        \"ENGINE\": \"django.db.backends.postgresql_psycopg2\",\n        \"NAME\": os.environ.get(\"POSTGRES_NAME\", \"postgres\"),\n        \"USER\": os.environ.get(\"POSTGRES_USERNAME\", \"postgres\"),\n        \"PASSWORD\": os.environ.get(\"POSTGRES_PASSWORD\", \"postgres\"),\n        \"HOST\": os.environ.get(\"POSTGRES_SERVICE_HOST\", \"postgres\"),\n        \"PORT\": os.environ.get(\"POSTGRES_SERVICE_PORT\", 5432),\n    }\n}\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DATABASES"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"default\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"ENGINE\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"django.db.backends.postgresql_psycopg2\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"USER\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_SERVICE_HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"postgres\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        \"PORT\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"POSTGRES_SERVICE_PORT\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have defined the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOST"}]},{"type":"text","value":" to be based on the environment variable "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POSTGRES_HOST"}]},{"type":"text","value":", but I have not defined this environment variable, so why didn't I just say "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"HOST\": \"postgres\""}]},{"type":"text","value":"? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself."}]},{"type":"element","tag":"h3","props":{"id":"nginx"},"children":[{"type":"text","value":"NGINX"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next service we should go over is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":", the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Reverse proxy"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serve static files for Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serve a frontend Javascript application"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the definition of this service in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"services:\n  web:\n    image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n    networks:\n      - traefik-public\n      - main\n    volumes:\n      - backendassets:/usr/src/app/assets\n    deploy:\n      labels:\n        - 'traefik.enable=true'\n        - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n        - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n        - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n        - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  web"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik-public\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"main\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"backendassets:/usr/src/app/assets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      labels"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.enable=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.entrypoints=websecure'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For now, ignore the contents under the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deploy"}]},{"type":"text","value":" key; we will cover this next when we go over the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NGINX acts as a reverse proxy when it sends request starting with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" container. Two blocks in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":" enable this behavior:"}]},{"type":"element","tag":"pre","props":{"code":"  upstream backend {\n    server backend:8000;\n  }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"  upstream backend {\n    server backend:8000;\n  }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This hostname "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is defined as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":" can be resolved by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service because it is on the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" network that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" is on. If either of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" wasn't on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":" network, NGINX would not be able to make sense of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend:8000"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This block does that actual request forwarding. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"http://backend"}]},{"type":"text","value":" references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"upstream backend {}"}]},{"type":"text","value":" block defined above."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The volume "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is referenced here and mounts to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets"}]},{"type":"text","value":". This path is then referenced in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":", the NGINX configuration file that is used in our custom NGINX-based image:"}]},{"type":"element","tag":"pre","props":{"code":"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this block of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":", we tell NGINX to serve files from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets/static"}]},{"type":"text","value":" for requests that start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":". A request made to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/static/base.css"}]},{"type":"text","value":" would return a file located at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets/static"}]},{"type":"text","value":" if that file existed. Remember, when we run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collecstatic"}]},{"type":"text","value":" management command in our Django container, it will collect our static files to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":". Since "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backendassets"}]},{"type":"text","value":" is mounted to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/usr/src/app/assets"}]},{"type":"text","value":", NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" container:"}]},{"type":"element","tag":"pre","props":{"code":"# # build stage\n# FROM node:10-alpine as build-stage\n# WORKDIR /app/\n# COPY frontend/package.json /app/\n# RUN npm cache verify\n# RUN npm install\n# COPY frontend /app/\n# RUN npm run build\n\n# production stage\n# FROM nginx:1.19.1-alpine as production-stage\nFROM nginx:1.19.1-alpine\nCOPY nginx/prod/prod.conf /etc/nginx/nginx.conf\nCOPY nginx/prod/index.html /dist/\n# COPY --from=build-stage /app/dist /dist/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n","language":"Dockerfile","meta":"","className":"language-Dockerfile shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# # build stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# FROM node:10-alpine as build-stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# WORKDIR /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY frontend/package.json /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm cache verify\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm install\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY frontend /app/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# RUN npm run build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# production stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# FROM nginx:1.19.1-alpine as production-stage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"FROM nginx:1.19.1-alpine\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY nginx/prod/prod.conf /etc/nginx/nginx.conf\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY nginx/prod/index.html /dist/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# COPY --from=build-stage /app/dist /dist/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"EXPOSE 80\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"CMD [\"nginx\", \"-g\", \"daemon off;\"]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:"}]},{"type":"element","tag":"pre","props":{"code":"COPY --from=build-stage /app/dist /dist/\n","language":"Dockerfile","meta":"","className":"language-Dockerfile shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"COPY --from=build-stage /app/dist /dist/\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This would copy the build files for our Javascript application into the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/dist/"}]},{"type":"text","value":" folder of our NGINX container. Another few declarations and blocks in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":" allow all other requests to be served by the contents of this folder:"}]},{"type":"element","tag":"pre","props":{"code":"    root /dist/;\n    index index.html;\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    root /dist/;\n    index index.html;\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This sets the root and the index document for our NGINX webserver."}]},{"type":"element","tag":"pre","props":{"code":"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These two blocks route all other requests to the frontend Javascript app's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" file location in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/dist/"}]},{"type":"text","value":" (any request that doesn't start with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/static"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":"). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lastly, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deployment"}]},{"type":"text","value":" key has some "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"labels"}]},{"type":"text","value":" defined for Traefik. Let's come back to these after having a look at the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service."}]},{"type":"element","tag":"h3","props":{"id":"traefik"},"children":[{"type":"text","value":"Traefik"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"https://docs.traefik.io/assets/img/traefik-architecture.png"},"children":[]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- "},{"type":"element","tag":"a","props":{"href":"https://docs.traefik.io/","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.traefik.io/"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Traefik has three main functions in my application:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Do TLS termination"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Route all requests to NGINX"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed \"fun and easy\", especially when it comes to requesting certificates."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two main ways to set up Traefik:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"write a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik.toml"}]},{"type":"text","value":" file and build this into your own custom image (similar to what we do with NGINX and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod.conf"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"use a base image and specify all configure options through command line arguments."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" (for now all the values I'm using in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"traefik"}]},{"type":"text","value":" service are hard-coded, this is one more item for my ToDo list on this project)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":". There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled "},{"type":"element","tag":"a","props":{"href":"https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/","rel":["nofollow"]},"children":[{"type":"text","value":"How to install Traefik 2.x on a Docker Swarm"}]},{"type":"text","value":" helped me a lot in figuring out how to get everything working. Thank you for the great article, "},{"type":"element","tag":"a","props":{"href":"https://github.com/creekorful","rel":["nofollow"]},"children":[{"type":"text","value":"Alos"}]},{"type":"text","value":"!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code that sets up the traefik service:"}]},{"type":"element","tag":"pre","props":{"code":"services:\n  traefik:\n    image: traefik:v2.0.2\n    ports:\n      - '80:80'\n      - '443:443'\n    command:\n      - '--providers.docker.endpoint=unix:///var/run/docker.sock'\n      - '--providers.docker.swarmMode=true'\n      - '--providers.docker.exposedbydefault=false'\n      - '--providers.docker.network=traefik-public'\n      - '--entrypoints.web.address=:80'\n      - '--entrypoints.websecure.address=:443'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n      - '--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n      - '--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n    volumes:\n      - letsencrypt:/letsencrypt\n      - /var/run/docker.sock:/var/run/docker.sock\n    networks:\n      - traefik-public\n    deploy:\n      placement:\n        constraints:\n          - node.role == manager\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  traefik"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik:v2.0.2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    ports"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'80:80'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'443:443'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    command"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.endpoint=unix:///var/run/docker.sock'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.swarmMode=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.exposedbydefault=false'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--providers.docker.network=traefik-public'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--entrypoints.web.address=:80'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--entrypoints.websecure.address=:443'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"letsencrypt:/letsencrypt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/var/run/docker.sock:/var/run/docker.sock\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    networks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"traefik-public\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      placement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        constraints"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"node.role == manager\n"}]}]}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"websecure"}]},{"type":"text","value":" refer to values declared on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"web"}]},{"type":"text","value":" service. Let's take a look at those values:"}]},{"type":"element","tag":"pre","props":{"code":"deploy:\n  labels:\n    - 'traefik.enable=true'\n    - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n    - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n    - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n    - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  labels"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.enable=true'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.entrypoints=websecure'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I still need to setup HTTP -> HTTPS redirecting, so for now only "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"websecure"}]},{"type":"text","value":" is defined, but Alos explains this clearly in his article."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That wraps up our overview of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":", we left off with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack deploy -c stack.yml my-stack --with-registry-auth\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOCKER_HOST"}]},{"type":"text","value":" environment variable that I showed you earlier and run these commands from your local terminal:"}]},{"type":"element","tag":"pre","props":{"code":"docker stack ps my-stack --no-trunc\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker stack ps my-stack --no-trunc\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--no-trunc"}]},{"type":"text","value":" is important because important error messages tend to be cut off. This option will show the full version of each column returned by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker stack ps"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"docker service ls\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker service ls\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This command shows some the active services on our Droplet."}]},{"type":"element","tag":"pre","props":{"code":"docker ps\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker ps\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This command is useful for shelling into a container to run commands and poke around for debugging."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can get the Container ID of a running container and access it with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"docker exec -it 0da8370ab283 bash\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"docker exec -it 0da8370ab283 bash\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This assumes that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bash"}]},{"type":"text","value":" is installed on the container with ID "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"0da8370ab283"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"management-commands"},"children":[{"type":"text","value":"Management commands"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once the site is deployed we stil need to run a few commands to set up our Djnago application:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"collectstatic"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"migrate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"createsuperuser"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other ToDo is to figure out how to run these commands through manual GitLab CI jobs."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some ideas about the next steps I could take on this project."}]},{"type":"element","tag":"h3","props":{"id":"local-environment"},"children":[{"type":"text","value":"Local environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings."}]},{"type":"element","tag":"h3","props":{"id":"infrastructure-as-code-setup"},"children":[{"type":"text","value":"Infrastructure as Code setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK."}]},{"type":"element","tag":"h3","props":{"id":"scaling-out-docker-swarm-services-across-multiple-machines"},"children":[{"type":"text","value":"Scaling out docker swarm services across multiple machines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads."}]},{"type":"element","tag":"h3","props":{"id":"kubernetes-on-digitalocean"},"children":[{"type":"text","value":"Kubernetes on DigitalOcean"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP."}]},{"type":"element","tag":"h3","props":{"id":"deploying-locally-without-using-gitlab-ci"},"children":[{"type":"text","value":"Deploying locally, without using GitLab CI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"overview","depth":2,"text":"Overview"},{"id":"digitalocean-setup","depth":2,"text":"DigitalOcean setup"},{"id":"prebuilt-docker-vm-image","depth":2,"text":"Prebuilt Docker VM image"},{"id":"gitlab-setup","depth":2,"text":"GitLab setup"},{"id":"a-record","depth":2,"text":"A Record"},{"id":"ssh-into-your-digitalocean-droplet","depth":2,"text":"SSH into your DigitalOcean Droplet"},{"id":"add-the-rex-ray-docker-plugin","depth":2,"text":"Add the REX-Ray docker plugin"},{"id":"gitlab-ciyml","depth":2,"text":".gitlab-ci.yml"},{"id":"setup-a-docker-swarm-cluster","depth":2,"text":"Setup a docker swarm cluster"},{"id":"defining-an-overlay-network","depth":2,"text":"Defining an overlay network"},{"id":"docker-stack-deploy","depth":2,"text":"docker stack deploy"},{"id":"stackyml","depth":2,"text":"stack.yml","children":[{"id":"backend","depth":3,"text":"backend"},{"id":"nginx","depth":3,"text":"NGINX"},{"id":"traefik","depth":3,"text":"Traefik"}]},{"id":"management-commands","depth":2,"text":"Management commands"},{"id":"next-steps","depth":2,"text":"Next steps","children":[{"id":"local-environment","depth":3,"text":"Local environment"},{"id":"infrastructure-as-code-setup","depth":3,"text":"Infrastructure as Code setup"},{"id":"scaling-out-docker-swarm-services-across-multiple-machines","depth":3,"text":"Scaling out docker swarm services across multiple machines"},{"id":"kubernetes-on-digitalocean","depth":3,"text":"Kubernetes on DigitalOcean"},{"id":"deploying-locally-without-using-gitlab-ci","depth":3,"text":"Deploying locally, without using GitLab CI"}]}]}},"_type":"markdown","_id":"content:2020:08:09:digital-ocean-docker-swarm-django-traefik-nginx.md","_source":"content","_file":"2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.md","_stem":"2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","_extension":"md"},{"_path":"/2020/08/01/django-and-lambda-with-cdk-and-api-gateway","_dir":"01","_draft":false,"_partial":false,"_locale":"","title":"Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern","description":"","layout":"post","date":"2020-08-01T00:00:00.000Z","comments":true,"image":"/static/djambda.png","tags":["serverless","django","aws","lambda","cdk"],"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One way to deploy Django apps to AWS on a budget is to use the Lambda proxy pattern. The main idea is this: web requests are made to API Gateway that calls a Lambda outside of our VPC (proxy Lambda), which then invokes a second lambda (Django Lambda) inside of our VPC so that it can access VPC resources, namely RDS. The handler for the Django Lambda translates the API Gateway event into a WSGI-compatible request, processes the request and returns the response to the user back through the proxy Lambda. The big caveat is that you can't easily access the internet in Django's request/response cycle without network address translation (NAT) services which add additional costs. One other caveat is that there is high latency associated with the initial request. There are three cold starts to wait for: the cold start for the proxy Lambda, the cold start for the Django Lambda and the cold start for the Aurora Postgres Serverless database. Here's an architecture diagram:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/djambda.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Route53 and CloudFront (1 and 2), discuessed later on, are optional. Starting with 5, API Gateway requests are passed to a proxy lambda (6) which calls a Lambda in a VPC that contains our Django code and special Django handler (7). This function can access RDS (8) and S3 (4) via a VPC Gateway Endpoint (9), but it cannot access the internet."}]},{"type":"element","tag":"h2","props":{"id":"why"},"children":[{"type":"text","value":"Why?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a few different reasons for why I put this project together. Before I get into these reasons, here is a little bit of background on how I typically deploy web apps and the motivations for this project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Django is my web framework of choice, and I'm most comfortable working with Django in docker containers. I previously wrote an article about "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html","rel":["nofollow"]},"children":[{"type":"text","value":"deploying Django applications with AWS Fargate"}]},{"type":"text","value":". This approach technically is \"serverless\", but it requires the use of \"always on\" services: an Application Load Balancer, NAT Gateways and long-running Fargate tasks to run gunicorn processes for our Django application. Even if you choose to run workloads in public subnets and don't use NAT Gateways or NAT instances, the costs are prohbitively high for many types of Django projects: personal projects, proof-of-concept projects, internal projects, toy projects, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The other serverless compute platform on AWS is Lambda. There is a popular framework for deploying serverless Django applications on Lambda called Zappa. I have been meaning to try out Zappa for a while now, and I still haven't used it, but it provided a good reference for how to do \"serverless Django\". I'll come back to Zappa in more detail later, but the main reason I didn't want to use it for my serverless Django project is because I already have a great deployment and Infrastructure as Code tool: CDK."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK, or Cloud Development Kit, is a tool that allows you define and deploy AWS infrastructure using any popular programming language, Python in my case. It uses CloudFormation in the background, and it has great support for lots of AWS services. If you are looking for an introuction to CDK, check out "},{"type":"element","tag":"a","props":{"href":"https://cdkworkshop.com/","rel":["nofollow"]},"children":[{"type":"text","value":"https://cdkworkshop.com/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Zappa makes it really easy to deploy serveless Django applications with Django, but it requires that you "},{"type":"element","tag":"a","props":{"href":"https://github.com/Miserlou/Zappa#running-tasks-in-a-vpc","rel":["nofollow"]},"children":[{"type":"text","value":"setup NAT and other VPC resources before using it with RDS"}]},{"type":"text","value":". Since CDK is really good at setting up these kinds of resources, as well as the resources that Zappa creates (including Lambda functions and API Gateway), I wanted to know how far I could get in setting up a servless Django application only using CDK. I also didn't want everything abstracted away by a high level framework; I'm interested in a lower level view to get more familiar with how serverless technologies work. It's important to note that the biggest motivation of all is to learn try something out of my comfort zone, make mistakes and get feedback."}]},{"type":"element","tag":"h2","props":{"id":"django-lambda-djambda"},"children":[{"type":"text","value":"Django + Lambda = djambda"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The name for this project came pretty easily. I created "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/djambda","rel":["nofollow"]},"children":[{"type":"text","value":"a repo on GitLab called djambda"}]},{"type":"text","value":" and then discovered "},{"type":"element","tag":"a","props":{"href":"https://github.com/netsome/djambda","rel":["nofollow"]},"children":[{"type":"text","value":"a similar project by the same name on GitHub: netsome/djambda"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":" project uses Terraform, and I encourage you to check it out and leave it a GitHub star. Before I came across this project, I hacked together a very basic djambda protoype using some code from Zappa's handler. A "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]},{"type":"text","value":" is the name for the function that is called in your Lambda function's code when the Lambda function is invoked. Here's some pseudo code that shows how Zappa's handler works:"}]},{"type":"element","tag":"pre","props":{"code":"from werkzeug.wrappers import Response\n\ndef handler(event, context):\n    with Response.from_app(wsgi_app, wsgi_request(event)) as response:\n        zappa_returndict = dict()\n        zappa_returndict['body'] = response.data\n        zappa_returndict['statusCode'] = response.status_code\n        return zappa_returndict\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" werkzeug.wrappers "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Response\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Response.from_app(wsgi_app, wsgi_request(event)) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" dict"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'body'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.data\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        zappa_returndict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'statusCode'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.status_code\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" zappa_returndict\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For reference, "},{"type":"element","tag":"a","props":{"href":"https://github.com/Miserlou/Zappa/blob/master/zappa/handler.py#L540","rel":["nofollow"]},"children":[{"type":"text","value":"here is the link to the line in Zappa's source code that starts processing API Gateway requests"}]},{"type":"text","value":" on which the above psuedo code is loosly based."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":" project makes use of a package called "},{"type":"element","tag":"a","props":{"href":"https://github.com/slank/awsgi","rel":["nofollow"]},"children":[{"type":"text","value":"awsgi"}]},{"type":"text","value":" that has active contributions from people at AWS. Similar to djambda, it is a mashup of words (acronyms): ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS"}]},{"type":"text","value":" + "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"wsgi"}]},{"type":"text","value":" = "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsgi"}]},{"type":"text","value":"). It does most of the work that Zappa's handler does, so I replaced the adapted Zappa handler code with a very elagant handler (borrowed from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"netsome/djambda"}]},{"type":"text","value":"):"}]},{"type":"element","tag":"pre","props":{"code":"# djambda/src/djambda/awsgi.py\nimport io\n\nimport awsgi\nfrom django.core import management\n\nfrom .wsgi import application\n\n\ndef lambda_handler(event, context):\n    if \"manage\" in event:\n        output = io.StringIO()\n        management.call_command(*event[\"manage\"].split(\" \"), stdout=output)\n        return {\"output\": output.getvalue()}\n    else:\n        return awsgi.response(application, event, context)\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# djambda/src/djambda/awsgi.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" io\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awsgi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" django.core "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" management\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" .wsgi "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" application\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" lambda_handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"manage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" event:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        output "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" io.StringIO()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        management.call_command("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"event["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"manage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].split("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"stdout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"output)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"output\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": output.getvalue()}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    else"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awsgi.response(application, event, context)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This handler can takes care of translating API Gateway requests to WSGI requests as well as management commands such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and other custom management commands. Let's talk about the management commands first as they relate to the two main AWS services that our Django application uses: RDS and S3. Then we will talk about API Gateway, the proxy Lambda and how the Lambda proxy pattern works."}]},{"type":"element","tag":"h2","props":{"id":"rds"},"children":[{"type":"text","value":"RDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To run the management commands for our application, we can use the AWS CLI to invoke the Lambda function with a payload that will trigger the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"if \"manage\" in event:"}]},{"type":"text","value":" code block from the above handler:"}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name my-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"migrate --no-input\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" my-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"migrate --no-input\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" command by connecting to RDS from our Django application with a special version of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws-psycopg2"}]},{"type":"text","value":" (check "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django/requirements.txt"}]},{"type":"text","value":" for this dependency). "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psycopg2-binary"}]},{"type":"text","value":" both gave error messages when trying to access the database, but the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws-psycopg2"}]},{"type":"text","value":" package had no issues."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RDS can sometimes be the most expensive part of a project on AWS. To reduce costs, we are using Aurora Postgres Serverless. This AWS service is ideal for small, infrequently-used projects that are in development. The database \"goes to sleep\" after a period of inactivity (5 minutes, I think). When new requests to the database are made, it can take up to 30 seconds for the database to wake up. For this reason, we need the timeout of the Django Lambda to be able to clear the wakeup period of the Aurora Postgres Serverless database."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since our Lambda function is in public subnet of our VPC and our RDS Aurora database cluster is in an isolated VPC, we need to make sure that the Lambda function can talk to the RDS cluster. CDK makes this really easy. I'll highlight a few important permission related parts of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/vpc.py"}]},{"type":"text","value":", the code that defines the nested CloudFormation stack where we define our VPC and resources related to our application (including API Gateway, which is technically not located in our VPC)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, we define a new security group for our Django Lambda:"}]},{"type":"element","tag":"pre","props":{"code":"        self.lambda_security_group = ec2.SecurityGroup(\n            self, \"LambdaSecurityGroup\", vpc=self.vpc\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.SecurityGroup(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"LambdaSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"vpc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Then, we reference this security group in the list of security group ingresses for our database cluster's security group:"}]},{"type":"element","tag":"pre","props":{"code":"        self.db_security_group = ec2.CfnSecurityGroup(\n            self,\n            \"DBSecurityGroup\",\n            vpc_id=self.vpc.vpc_id,\n            group_description=\"DBSecurityGroup\",\n            security_group_ingress=[\n                ec2.CfnSecurityGroup.IngressProperty(\n                    ip_protocol=\"tcp\",\n                    to_port=5432,\n                    from_port=5432,\n                    source_security_group_id=self.lambda_security_group.security_group_id,\n                )\n            ],\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".db_security_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.CfnSecurityGroup(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DBSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.vpc_id,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            group_description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DBSecurityGroup\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            security_group_ingress"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.CfnSecurityGroup.IngressProperty(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    ip_protocol"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"tcp\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    to_port"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    from_port"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5432"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    source_security_group_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group.security_group_id,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's take a look at the code for the Django lambda itself:"}]},{"type":"element","tag":"pre","props":{"code":"        self.djambda_lambda = _lambda.Function(\n            self,\n            \"DjambdaLambda\",\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            code=_lambda.AssetCode('./django'),\n            function_name=f\"{scope.full_app_name}-djambda-lambda\",\n            handler=\"djambda.awsgi.lambda_handler\",\n            layers=[self.djambda_layer],\n            timeout=core.Duration.seconds(60),\n            vpc=self.vpc,\n            vpc_subnets=ec2.SubnetSelection(subnets=self.vpc.isolated_subnets),\n            environment={**self.env_vars},\n            security_groups=[self.lambda_security_group],\n        )\n\n        # Use raw override because Lambda's can't be placed in\n        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n        self.djambda_lambda.node.default_child.add_override(\n            \"Properties.VpcConfig.SubnetIds\",\n            [subnet.subnet_id for subnet in self.vpc.public_subnets],\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DjambdaLambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'./django'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            function_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-djambda-lambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"djambda.awsgi.lambda_handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            layers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_layer],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"core.Duration.seconds("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            vpc_subnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetSelection("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"subnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.isolated_subnets),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".env_vars},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            security_groups"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_security_group],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # Use raw override because Lambda's can't be placed in\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.node.default_child.add_override(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"Properties.VpcConfig.SubnetIds\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            [subnet.subnet_id "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" subnet "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.public_subnets],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lambda"}]},{"type":"text","value":" is a reserved word in Python, so we import "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lambda"}]},{"type":"text","value":" as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda"}]},{"type":"text","value":" from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_cdk"}]},{"type":"text","value":". Note that we have a reference to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsgi.py"}]},{"type":"text","value":" handler function in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]},{"type":"text","value":" parameter of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.djambda_lambda"}]},{"type":"text","value":". I initially put the lambda in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"isolated_subnets"}]},{"type":"text","value":" because CDK won't let you define a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda.Function"}]},{"type":"text","value":" with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"public_subnets"}]},{"type":"text","value":" for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_subnets"}]},{"type":"text","value":". We can override this using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_override"}]},{"type":"text","value":" below the Lambda definition to place it in a public subnet instead."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not sure if this is necessary, or if this is recommended. Things get a little bit confusing for me here so I would love some insight if anyone knows what would be best to do here. The VPC construct for CDK doesn't allow you to have private subnets when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nat_gateways=0"}]},{"type":"text","value":". Would I be better off placing the lambda in the isolated subnet with the RDS cluster? Would I still be able to access S3 via the VPC Gateway Endpoint from an isolated subnet?"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Putting aside my uncertainties about the correct way to configure our Lambdas functions in a VPC, let's continue! Here's the Lambda invocation for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":" that we can run once we have successfully invoked the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" dev-mysite-com-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This assumes that there is an environment variable defined in our Lambda's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment"}]},{"type":"text","value":" variables that we passed in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{**self.env_vars}"}]},{"type":"text","value":" for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DJANGO_SUPERUSER_USERNAME"}]},{"type":"text","value":". Here's what we have in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"env_vars"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"        self.env_vars = {\n            \"POSTGRES_SERVICE_HOST\": self.rds_cluster.get_att(\n                \"Endpoint.Address\"\n            ).to_string(),\n            \"POSTGRES_PASSWORD\": os.environ.get(\"DB_PASSWORD\", \"db-password\"),\n            \"AWS_STORAGE_BUCKET_NAME\": f\"{scope.full_app_name}-assets\",\n            \"DEBUG\": \"\",\n            \"DJANGO_SUPERUSER_PASSWORD\": os.environ.get(\n                \"DJANGO_SUPERUSER_PASSWORD\", \"Mypassword1!\"\n            ),\n            \"DJANGO_SUPERUSER_USERNAME\": os.environ.get(\n                \"DJANGO_SUPERUSER_USERNAME\", \"admin\"\n            ),\n        }\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".env_vars "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"POSTGRES_SERVICE_HOST\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".rds_cluster.get_att(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"Endpoint.Address\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ).to_string(),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"POSTGRES_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DB_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"db-password\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"AWS_STORAGE_BUCKET_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-assets\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DEBUG\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DJANGO_SUPERUSER_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"DJANGO_SUPERUSER_PASSWORD\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Mypassword1!\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"DJANGO_SUPERUSER_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"DJANGO_SUPERUSER_USERNAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"admin\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can use environment variables to set an initial password for our superuser. We also define additionl environment variables that we will use for our datbase connection, and the S3 bucket that we will use for Django's static and media assets."}]},{"type":"element","tag":"h2","props":{"id":"s3"},"children":[{"type":"text","value":"S3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To access S3 from our Lambda function in a VPC, we need to use a VPC Gateway Endpoint for S3. This is a free service that enables us to access S3 directly from our VPC without going through the internet, and instead using a private connection . This again has to do with the fact that our Django Lambda can't access the internet because the network interfaces created by Lambda only have private IP addresses and would require NAT in order to connect to resources on the internet. Here's how we define the VPC as well as the VPC Gateway Endpoint using CDK:"}]},{"type":"element","tag":"pre","props":{"code":"        self.vpc = ec2.Vpc(\n            self,\n            \"Vpc\",\n            max_azs=2,\n            cidr=\"10.0.0.0/16\",\n            nat_gateways=0,\n            subnet_configuration=[\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.PUBLIC,\n                    name=\"Public\",\n                    cidr_mask=24,\n                ),\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.ISOLATED,\n                    name=\"Isolated\",\n                    cidr_mask=24,\n                ),\n            ],\n        )\n\n        self.vpc.add_gateway_endpoint(\n            \"S3Gateway\", service=ec2.GatewayVpcEndpointAwsService('s3')\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ec2.Vpc(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"Vpc\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            max_azs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            cidr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"10.0.0.0/16\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            nat_gateways"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            subnet_configuration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.SubnetConfiguration(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    subnet_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PUBLIC"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Public\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    cidr_mask"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"24"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ec2.SubnetConfiguration(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    subnet_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.SubnetType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"ISOLATED"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Isolated\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    cidr_mask"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"24"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc.add_gateway_endpoint(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"S3Gateway\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ec2.GatewayVpcEndpointAwsService("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'s3'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this VPC endpoint in place, we are almost ready to run our collectstatic command, but it won't work yet. This is because we haven't given our Lambda function access to write files to the S3 assets bucket for our Django application's static and media files. We can grant this permission with the following snippet from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app_stack.py"}]},{"type":"text","value":", the file that defines the root CloudFormation stack for our application:"}]},{"type":"element","tag":"pre","props":{"code":"        self.backend_assets_bucket.grant_read_write(\n            self.vpc_stack.djambda_lambda\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".backend_assets_bucket.grant_read_write(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".vpc_stack.djambda_lambda\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we need to add the following settings to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"settings.py"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"STATIC_URL = '/static/'\nSTATIC_ROOT = os.path.join(BASE_DIR, 'static')\nSTATICFILES_STORAGE = \"djambda.storage_backends.StaticStorage\"\n\nAWS_DEFAULT_ACL = None\nAWS_STORAGE_BUCKET_NAME = os.environ.get(\n    \"AWS_STORAGE_BUCKET_NAME\", \"bucketname\"\n)\nAWS_S3_OBJECT_PARAMETERS = {\n    \"CacheControl\": \"max-age=86400\",\n}\nAWS_PRIVATE_MEDIA_LOCATION = \"media/private\"\nAWS_STATIC_LOCATION = \"static\"\nPRIVATE_FILE_STORAGE = \"backend.storage_backends.PrivateMediaStorage\"\nAWS_S3_CUSTOM_DOMAIN = f\"{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com\"\n\nif not DEBUG:\n    MEDIA_ROOT = \"media\"\n    MEDIA_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{MEDIA_ROOT}/\"\n    STATIC_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{AWS_STATIC_LOCATION}/\"\n    FORCE_SCRIPT_NAME = \"/prod\"\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATIC_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '/static/'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATIC_ROOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.path.join("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"BASE_DIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'static'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"STATICFILES_STORAGE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"djambda.storage_backends.StaticStorage\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_DEFAULT_ACL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" None\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_STORAGE_BUCKET_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"AWS_STORAGE_BUCKET_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"bucketname\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_S3_OBJECT_PARAMETERS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"CacheControl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"max-age=86400\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_PRIVATE_MEDIA_LOCATION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"media/private\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_STATIC_LOCATION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"static\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PRIVATE_FILE_STORAGE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"backend.storage_backends.PrivateMediaStorage\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"AWS_S3_CUSTOM_DOMAIN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_STORAGE_BUCKET_NAME}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".s3.amazonaws.com\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" not"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DEBUG"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    MEDIA_ROOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"media\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    MEDIA_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_S3_CUSTOM_DOMAIN}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{MEDIA_ROOT}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    STATIC_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_S3_CUSTOM_DOMAIN}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{AWS_STATIC_LOCATION}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    FORCE_SCRIPT_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/prod\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can run the collectstatic command with the following Lambda invocation:"}]},{"type":"element","tag":"pre","props":{"code":"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"collectstatic --no-input\"}' \\\n    resp.json\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --function-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" dev-mysite-com-djambda-lambda"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --invocation-type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" RequestResponse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '{\"manage\": \"collectstatic --no-input\"}'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    resp.json\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"api-gateway-and-the-lambda-proxy-pattern"},"children":[{"type":"text","value":"API Gateway and the Lambda proxy pattern"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I first read about the Lambda proxy pattern in an article titled "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/lambda-vpc-internet-access-no-nat-gateway/","rel":["nofollow"]},"children":[{"type":"text","value":"How to access VPC and internet resources from Lambda without paying for a NAT Gateway"}]},{"type":"text","value":" on Paul Swail's website "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/","rel":["nofollow"]},"children":[{"type":"text","value":"https://serverlessfirst.com/"}]},{"type":"text","value":". This site has tons of great serverless content, check out the "},{"type":"element","tag":"a","props":{"href":"https://serverlessfirst.com/articles/","rel":["nofollow"]},"children":[{"type":"text","value":"list of articles"}]},{"type":"text","value":". Thank you Paul for putting out great serverless resources!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take a look at the Proxy Lambda function next. The function itself is pretty straightforward:"}]},{"type":"element","tag":"pre","props":{"code":"import json\nimport os\nimport boto3\n\nlambda_client = boto3.client('lambda', region_name='us-east-1')\n\n\ndef handler(event, context):\n    invoke_response = lambda_client.invoke(\n        FunctionName=os.environ.get(\"FUNCTION_NAME\", None),\n        InvocationType='RequestResponse',\n        Payload=json.dumps(event),\n    )\n\n    data = invoke_response['Payload'].read()\n\n    return data\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" boto3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"lambda_client "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" boto3.client("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'lambda'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"region_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'us-east-1'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    invoke_response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lambda_client.invoke(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        FunctionName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FUNCTION_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        InvocationType"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'RequestResponse'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        Payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"json.dumps(event),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    data "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" invoke_response["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'Payload'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].read()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are just a few things to setup in our CDK code to make the proxy pattern work:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Lambda function"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Give the proxy Lambda permission to invoke the Django Lambda"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LambdaRestApi"}]},{"type":"text","value":" construct with the Proxy Lambda as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handler"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's what that code looks like:"}]},{"type":"element","tag":"pre","props":{"code":"        self.proxy_lambda = _lambda.Function(\n            self,\n            \"ProxyLambda\",\n            code=_lambda.AssetCode(\"./awslambda\"),\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            layers=[self.djambda_layer],\n            handler=\"proxy_lambda.handler\",\n            timeout=core.Duration.seconds(60),\n            environment={\"FUNCTION_NAME\": self.djambda_lambda.function_name},\n        )\n\n        self.djambda_lambda.grant_invoke(self.proxy_lambda)\n\n        self.apigw = apigw.LambdaRestApi(\n            self, 'DjambdaEndpoint', handler=self.proxy_lambda,\n        )\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"ProxyLambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./awslambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            layers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_layer],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"proxy_lambda.handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"core.Duration.seconds("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FUNCTION_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.function_name},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".djambda_lambda.grant_invoke("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".apigw "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" apigw.LambdaRestApi(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'DjambdaEndpoint'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".proxy_lambda,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's it! We can now access our Django project at the API Gateway "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"execute-api"}]},{"type":"text","value":" endpoint. This is a special URL that has the format:"}]},{"type":"element","tag":"pre","props":{"code":"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"abc123"}]},{"type":"text","value":" is the id of the API Gateway that we created (you can find the value of this id in the API Gateway section of the AWS management console)]"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The region "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"us-east-1"}]},{"type":"text","value":" is the region where you deployed the API Gateway"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" is the stage name"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The stage name part is a little confusing for me. It is meant to be a URL suffix that indicates production, staging, etc., but I typically separate environments at the level of the CloudFormation stack, so all of my environments use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" suffix. In order for Django to work properly, we need to tell it that our site will be served at this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" path (for example "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" will now be served at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod/admin"}]},{"type":"text","value":") by setting a special value in our settings module:"}]},{"type":"element","tag":"pre","props":{"code":"FORCE_SCRIPT_NAME = \"/prod\"\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"FORCE_SCRIPT_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/prod\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will make dealing with URLs easier, mostly because we don't actually have to change anything in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urls.py"}]},{"type":"text","value":". I tried adding "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" to my URL paths in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urls.py"}]},{"type":"text","value":", but the Django admin doesn't work properly because going to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod/admin"}]},{"type":"text","value":" will redirect you to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/login"}]},{"type":"text","value":" which will thrown an error with API Gateway since our application must be on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/prod"}]},{"type":"text","value":" subpath."}]},{"type":"element","tag":"h2","props":{"id":"setting-a-custom-url-for-api-gateway"},"children":[{"type":"text","value":"Setting a custom URL for API Gateway"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you don't mind having a URL in the form of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://abc123.execute-api.us-east-1.amazonaws.com/prod"}]},{"type":"text","value":", then everything should be good to go. If you do want a custom URL for API Gateway, there are only two things you need to do:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Get a domain and hosted zone set up in Route53 (this typically costs about $12/year)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":" to environment variables (see below for how to do this)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define an ACM certificate in our CDK code and"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LambdaRestApi"}]},{"type":"text","value":"'s "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_domain_name"}]},{"type":"text","value":" method to add the domain name and certificate to the API Gateway endpoint."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_apigateway/LambdaRestApi.html#aws_cdk.aws_apigateway.LambdaRestApi.add_domain_name","rel":["nofollow"]},"children":[{"type":"text","value":"link to the CDK Python documentation"}]},{"type":"text","value":" on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"add_domain_name"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you configure a custom domain name, you don't need to set the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FORCE_SCRIPT_NAME"}]},{"type":"text","value":" setting in Django settings."}]},{"type":"element","tag":"h2","props":{"id":"project-directory-structure"},"children":[{"type":"text","value":"Project directory structure"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take a quick look at the structure of the project using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tree"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"tree -L 3 .\n.\n awscdk\n    app.py\n    awscdk\n       app_stack.py  <----------------- CDK application overview\n       backend_assets.py\n       cert.py\n       cloudfront.py\n       hosted_zone.py\n       __init__.py\n       static_site_bucket.py\n       vpc.py <------------------------ VPC, Lambdas, API Gateway and more\n    cdk.json                             defined here\n    README.md\n    requirements.txt\n    setup.py\n    source.bat\n awslambda\n    proxy_lambda.py <------------------- Proxy Lambda\n django\n    core <------------------------------ A sample Django app\n       admin.py\n       apps.py\n       __init__.py\n       migrations\n       models.py\n       tests.py\n       urls.py\n       views.py\n    djambda\n       asgi.py\n       awsgi.py <---------------------- Django Lambda handler\n       __init__.py\n       settings.py <------------------- Django settings (RDS connections, S3 static/media)\n       storage_backends.py\n       urls.py\n       wsgi.py\n    manage.py\n    requirements.txt\n layers <-------------------------------- Lambda Layers (python dependencies)\n    django                               Note: This folder is not committed to git\n        python\n ARTICLE.md <---------------------------- This article\n gitlab-ci.yml\n .variables <---------------------------- Environment variables needed for deployment\n README.md\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"tree -L 3 .\n.\n awscdk\n    app.py\n    awscdk\n       app_stack.py  <----------------- CDK application overview\n       backend_assets.py\n       cert.py\n       cloudfront.py\n       hosted_zone.py\n       __init__.py\n       static_site_bucket.py\n       vpc.py <------------------------ VPC, Lambdas, API Gateway and more\n    cdk.json                             defined here\n    README.md\n    requirements.txt\n    setup.py\n    source.bat\n awslambda\n    proxy_lambda.py <------------------- Proxy Lambda\n django\n    core <------------------------------ A sample Django app\n       admin.py\n       apps.py\n       __init__.py\n       migrations\n       models.py\n       tests.py\n       urls.py\n       views.py\n    djambda\n       asgi.py\n       awsgi.py <---------------------- Django Lambda handler\n       __init__.py\n       settings.py <------------------- Django settings (RDS connections, S3 static/media)\n       storage_backends.py\n       urls.py\n       wsgi.py\n    manage.py\n    requirements.txt\n layers <-------------------------------- Lambda Layers (python dependencies)\n    django                               Note: This folder is not committed to git\n        python\n ARTICLE.md <---------------------------- This article\n gitlab-ci.yml\n .variables <---------------------------- Environment variables needed for deployment\n README.md\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The three top level folders are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awslambda"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django"}]},{"type":"text","value":". To deploy our CDK code, we run the following command from the root of the project:"}]},{"type":"element","tag":"pre","props":{"code":"cdk deploy --app awscdk/app.py\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"cdk"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" --app"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" awscdk/app.py\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can also run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py"}]},{"type":"text","value":" to preview changes to our CDK code by reviewing the CloudFormation templates generated by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":". Running the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" commands at root of the project means that we need to specificy lambda code assets from the root of the project as well. This is why the Django application's Lambda function references the code with:"}]},{"type":"element","tag":"pre","props":{"code":"code=_lambda.AssetCode('./django'),\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_lambda.AssetCode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'./django'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"deploying"},"children":[{"type":"text","value":"Deploying"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK is easy to use both locally and in a CI/CD tool such as GitLab CI, my CI/CD tool of choice. There are a few things to coordinate when deploying in both of these environments:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Environment variables"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Dependencies"}]}]},{"type":"element","tag":"h3","props":{"id":"deploying-from-a-terminal"},"children":[{"type":"text","value":"Deploying from a terminal"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you are new to CDK, you will need to make sure that you have ran the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" command at least once on your account. This command sets up a CloudFormation stack that CDK uses internally to manage deployments."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The environment variables needed for deployment are defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".variables.template"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"APP_NAME"}]},{"type":"text","value":" should be a URL compatible name, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"my-app"}]},{"type":"text","value":" (don't put "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" in this variable)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":" are needed for adding a custom domain name to API Gateway"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Copy this template into a file in the root of the project called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".variables"}]},{"type":"text","value":" and set these environment variables with the following command:"}]},{"type":"element","tag":"pre","props":{"code":". .variables\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":". .variables\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we need to install our Python dependencies locally with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" target flag so that the Lambda layers we define in CDK can find the files needed to be packaged into our Lambda layer and made available to our Lambda function at runtime. Install dependencies to the target directory by running the following command from the root of the project:"}]},{"type":"element","tag":"pre","props":{"code":"pip install -r django/requirements.txt -t layers/django/python\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install -r django/requirements.txt -t layers/django/python\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we can deploy our serverless application to AWS using CDK. First, activate the CDK Python virtual environment with:"}]},{"type":"element","tag":"pre","props":{"code":"source awscdk/.env/bin/activate\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"source awscdk/.env/bin/activate\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Also make sure that you are using a version of Node.js greater or equal to 10. I do this with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nvm use 13"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Make sure that all of the dependencies defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/setup.py"}]},{"type":"text","value":" are up-to-date. Make sure that there are no issues witht the CDK code by running:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Inspect the contents of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":"; these are the CloudFormation templates generated by CDK that will be used to deploy all of our resources. If everything looks good to go, deploy with the following command:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Follow the output of this command and ensure that it completes successfully. You can also follow along in the CloudFormation section of the AWS management console to make sure that things are deploying properly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once everything has finished deploying, you will need to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collecstatic"}]},{"type":"text","value":" after the first deployment."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"TODO: consolidate these steps with a Makefile or bash script"}]}]},{"type":"element","tag":"h3","props":{"id":"deploying-with-gitlab-ci"},"children":[{"type":"text","value":"Deploying with GitLab CI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Deploying locally is fine, but it is better to run CDK commands from a CI/CD process so we can keep track of the commits, pipeline results, commit messages, etc. The process is very similar to everything we do locally, but you will need to add environment variables to the GitLab project's Settings > CI/CD > Variables. I have broken out dependency installation into a separate stage. This is not entirely necessary, but it helps keep things easy to follow:"}]},{"type":"element","tag":"pre","props":{"code":"pip_install:\n  stage: build\n  artifacts:\n    paths:\n      - layers/django/python\n  script:\n    - pip install -r django/requirements.txt -t layers/django/python\n\ncdk_deploy:\n  stage: deploy\n  before_script:\n    - apt-get -qq update && apt-get -y install nodejs npm\n    - npm i -g aws-cdk\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"pip_install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  artifacts"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    paths"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"layers/django/python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip install -r django/requirements.txt -t layers/django/python\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"cdk_deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apt-get -qq update && apt-get -y install nodejs npm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"npm i -g aws-cdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip3 install -e awscdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk deploy --app awscdk/app.py --require-approval never\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For management commands, we use a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".base_task"}]},{"type":"text","value":" template and reuse this for each command:"}]},{"type":"element","tag":"pre","props":{"code":".base_task: &task\n  image: python:3.8\n  stage: deploy\n  rules:\n    - when: manual\n  before_script:\n    - pip install awscli\n  after_script:\n    - cat invoke_response.json\n\nmigrate:\n  <<: *task\n  script:\n    - |\n      aws lambda invoke \\\n        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n        --payload '{\"manage\": \"migrate --no-input\"}' \\\n        invoke_response.json\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":".base_task"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"python:3.8\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  rules"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"when"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"manual\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip install awscli\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  after_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cat invoke_response.json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"migrate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  <<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      aws lambda invoke \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        --payload '{\"manage\": \"migrate --no-input\"}' \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        invoke_response.json\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"manual"}]},{"type":"text","value":" commands, and can be started through the GitLab CI interface by pressing the \"Play\" button on the pipeline."}]},{"type":"element","tag":"h2","props":{"id":"next-steps"},"children":[{"type":"text","value":"Next Steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I still have lots of ideas and things to try out with this Django/Lambda architecture. Here are a few things that would be good to try:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using another Lambda function that proxies web requests to a Lambda outside of the VPC for basic network requests using either "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"urllib.request"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"requests"}]},{"type":"text","value":". This would be the easiest way to add simple internet access without needing a NAT Gateway"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use a NAT provider to add a cheap NAT instance using a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"t3a.nano"}]},{"type":"text","value":" instance ( about $5.00/month) to allow for internet access in the Django request/response cycle"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Figure out a good solution for async processing. Zappa has a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@task"}]},{"type":"text","value":" wrapper that allows you to run tasks asynchronously in separate Lambda functions. It would be interesting to experiment with direct invocation of async tasks as well as task queueing with SQS. Using SQS would involve a VPC Endpoint which does cost extra, or we could setup a dedicated SQS proxy function to do this in a way similar to how we would handle requests."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Lambda tuning. I'm pretty new to using Lambda and I would like to better understand how to fine-tune Lambda settings. There are lots of options in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"_lambda.Function"}]},{"type":"text","value":" construct, which would be a good place to start. This would be especially important for async tasks that require high memeory. From the "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"Lambda Developer Guide"}]},{"type":"text","value":" it looks like memory can be configured from 128 MB to 3,008 MB in 64 MB increments."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I typically setup Vue.js frontends with S3/CloudFront and use Django only for the admin and API with Django REST Framework. From what I understand, API Gateway uses CloudFront in the backround to do custom domains, but you don't have access to this CloudFront distribution. You can add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"execute-api"}]},{"type":"text","value":" URL as a Custom Origin for a single CloudFront distribution, or keep a CloudFront distribution separate from the API Gateway custom domain and serve these on different subdomains, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"api.mysite.com"}]},{"type":"text","value":" for the API Gateway domain name and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"mysite.com"}]},{"type":"text","value":" for the CloudFront distribution serving Vue.js files."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pricing. I'm still unsure about exactly how much this setup costs. The only major costs should be Aurora Postgres Serverless if it is used heavily, but I'm still not sure about how the pricing for this service works. Here's an in-depth article from Jeremy Daly that has more information on Aurora Serverless: "},{"type":"element","tag":"a","props":{"href":"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks for reading!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"why","depth":2,"text":"Why?"},{"id":"django-lambda-djambda","depth":2,"text":"Django + Lambda = djambda"},{"id":"rds","depth":2,"text":"RDS"},{"id":"s3","depth":2,"text":"S3"},{"id":"api-gateway-and-the-lambda-proxy-pattern","depth":2,"text":"API Gateway and the Lambda proxy pattern"},{"id":"setting-a-custom-url-for-api-gateway","depth":2,"text":"Setting a custom URL for API Gateway"},{"id":"project-directory-structure","depth":2,"text":"Project directory structure"},{"id":"deploying","depth":2,"text":"Deploying","children":[{"id":"deploying-from-a-terminal","depth":3,"text":"Deploying from a terminal"},{"id":"deploying-with-gitlab-ci","depth":3,"text":"Deploying with GitLab CI"}]},{"id":"next-steps","depth":2,"text":"Next Steps"}]}},"_type":"markdown","_id":"content:2020:08:01:django-and-lambda-with-cdk-and-api-gateway.md","_source":"content","_file":"2020/08/01/django-and-lambda-with-cdk-and-api-gateway.md","_stem":"2020/08/01/django-and-lambda-with-cdk-and-api-gateway","_extension":"md"},{"_path":"/2020/06/02/django-postgres-vue-gitlab-ecs","_dir":"02","_draft":false,"_partial":false,"_locale":"","title":"Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications","description":"","layout":"post","date":"2020-06-02T00:00:00.000Z","comments":true,"image":"/static/architecture_verbose_equals_true.png","tags":["fargate","django","gitlab","vue","cdk"],"body":{"type":"root","children":[{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article was originally posted on "},{"type":"element","tag":"a","props":{"href":"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i","rel":["nofollow"]},"children":[{"type":"text","value":"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i"}]},{"type":"text","value":". It is also available on the documentation site for the project: "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/"}]}]}]},{"type":"element","tag":"h1","props":{"id":"project-overview"},"children":[{"type":"text","value":"Project Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is an overview of a Proof-of-Concept web application I'm working on called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-postgres-vue-gitlab-ecs"}]},{"type":"text","value":". This project aims to demonstrate the development and deployment of a web application using some of my favorite tools, languages and frameworks including:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Python"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"JavaScript"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue.js/Quasar Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AWS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"and last but not least, "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK)"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This README will start by describing some features of the application I'm building and how the different technologies are used together. I also share my experience in adopting CDK for managing cloud infrastructure on AWS. Finally, I discuss my solution to a specific question I have been trying to answer: what's the best way to scale Celery workers to zero to reduce Total Cost of Ownership?"}]},{"type":"element","tag":"h2","props":{"id":"development-philosophies-and-best-practices"},"children":[{"type":"text","value":"Development Philosophies and Best Practices"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the best practices that this project aims to use:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Open-source, MIT-Licensed"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"12 Factor App"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Infrastructure as Code"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Containerization with Docker"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitOps"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Serverless* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Project documentation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Cost containment and tracking"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"KISS & DRY"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Initial AWS console interaction is strictly limited to what can "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"only"}]},{"type":"text","value":" be done through the AWS console, otherwise AWS CDK and AWS CLI (preferably in CI/CD pipelines) are the primary means of interacting with AWS resources and the AWS Console is treated as a \"read-only\" convenience."}]}]},{"type":"element","tag":"h2","props":{"id":"topics"},"children":[{"type":"text","value":"Topics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/architecture_verbose_equals_true.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"legend"},"children":[{"type":"text","value":"Legend"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This diagram was created with draw.io. Here's the link to the a read-only version of the diagram on draw.io: "},{"type":"element","tag":"a","props":{"href":"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing","rel":["nofollow"]},"children":[{"type":"text","value":"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"1 - GitLab is used to host the source code, test the source code and deploy the application to AWS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2 - Unit testing (see .gitlab-ci.yml)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2a - Pytest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2b - Jest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2c - Cypress"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3 - Deployment phase (see /gitlab-ci/aws/cdk.yml)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3a - Quasar PWA assets are built if there are changes in the quasar directory"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3b - AWS Cloud Development Kit (CDK) defines all infrastructure in AWS (4a - 12)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3c - AWS CLI is used to run Fargate tasks through manual GitLab CI jobs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4 - CDK Assets (ECR and S3 buckets that CDK uses internally to manage build assets and artifacts)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4a - Elastic Container Repository is used to manage the Django docker image used in various parts of the application"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"4b - S3 bucket used to store files associated with CDK and CloudFormation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"5 - Route53 is used to route traffic to the CloudFront distribution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"6 - CloudFront distribution that serves as the \"front desk\" of the application. It routes requests to to the correct CloudFront Origin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7 - CloudFront Origin Configurations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7a - S3 bucket for Quasar PWA assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7b - Application Load Balancer for Django application (/api/, /admin/, /flower/, /ws/, /graphql/)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"7c - S3 bucket for Django assets (static files, public media and private media)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8 - Web server and websocket servers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8a - Fargate service running uvicorn process (REST, GraphQL, Django Channels)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"8b - Autoscaling Group for Fargate Service that serves Django API"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9 - Celery and celery worker autoscaling"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9a - Fargate service that is autoscaled between 0 and N Fargate tasks for a given celery queue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9b - Scheduled Event that triggers a Lambda to make a request to Django backend which collects celery queue metrics and published\nmetrics to CloudWatch using boto3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9c - Lambda event the makes a request to /api/celery-metrics/"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9d - CloudWatch alarm that is used to scale the Fargate service for a celery queue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"9e - Autoscaling group for celery Fargate service"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"10 - Fargate tasks that run Django management commands such as migrate and collectstatic. These are triggered from manual GitLab CI\njobs using the AWS CLI (3c)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"11 - ElastiCache for Redis, used for Caching, Celery Broker, Channels Layer, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"12 - Aurora Postgres Serverless"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a list of some of the major topics covered:"}]},{"type":"element","tag":"h3","props":{"id":"local-development"},"children":[{"type":"text","value":"Local development"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a local development environment using docker with one easy command: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker-compose up"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hot-reloading for all parts of the application in local development"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Structuring a Django application (apps, settings modules, environment variables)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automatic code formatting with black and prettier"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Monitoring services (flower, pgadmin4, redis-commander)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VSCode settings and extensions"}]}]},{"type":"element","tag":"h3","props":{"id":"gitlab-ci"},"children":[{"type":"text","value":"GitLab CI"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI for running unit and integration tests"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI configuration for deployment to multiple environments (dev, prod) using AWS CDK"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI scheduled jobs for updating all project dependencies through automated merge requests with Renovate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitLab CI manual jobs for running admin and management commands (database migrations, collectstatic, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"How to deploy to multiple environments (master -> staging, tags -> prod pattern as well as optional ephemeral environments per commit) using the new GitLab CI "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rules"}]},{"type":"text","value":" syntax"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Recording Cypress test videos with GitLab CI artifacts for manual review"}]}]},{"type":"element","tag":"h3","props":{"id":"aws"},"children":[{"type":"text","value":"AWS"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Initial account setup"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Generating keys used in GitLab CI for deployment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Opting in to new ARN format for ECS services and tasks (used for resource tagging) and container insights"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AWS Cloud Development Kit (CDK) for Infrastructure as Code to manage all AWS resources with CloudFormation Stacks - Nested stacks for grouping related resources under parent tasks (one parent task represent on environment for the application, such as production)"}]}]},{"type":"element","tag":"h4","props":{"id":"aws-resources"},"children":[{"type":"text","value":"AWS Resources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automated provisioning of Amazon Certificate Manager certificates for TLS (HTTPS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Multi-AZ VPC with security groups and NACLs (no NAT Gateways/NAT instances used* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"2"}]}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 buckets for static site hosting and Django static and media assets"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CloudFront for serving Vue.js SPA (PWA) static assets, Django static/media files and proxy to Application Load Balancer which forwards to ECS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fargate for multiple Django processes: gunicorn for backend API, daphne for Django Channels, celery for asynchronous tasks and celery beat for scheduled tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Autoscaling (between 0 and N Fargate tasks) for infrequent, compute/memory intensive and long-running celery tasks with custom CloudWatch metrics"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hosted Redis with ElastiCache for celery broker, application caching, django-constance, etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Aurora Postgres and Aurora Postgres Serverless for cost savings in staging environments"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK Assets for automating S3 asset deployment and automated container building during deployment with AWS CDK"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Thorough resource tagging by both application and environment (dev, prod, etc.) for comprehensive cost tracking"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Optional bastion host for SSH access to bring up a Django shell in a container running on a container instance (this requires an EC2 instance)"}]}]},{"type":"element","tag":"h3","props":{"id":"django-application"},"children":[{"type":"text","value":"Django Application"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"JWT-based authentication with django-rest-framework-simplejwt"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Custom user model with email as username"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Social authentication with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python-social-auth"}]},{"type":"text","value":" (Google, Facebook, GitHub)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pytest for unit testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Settings broken into separate modules (development, ci, production)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django apps organized in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apps"}]},{"type":"text","value":" directory"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 for static assets, public media and private media files in production, local file system for assets in local development"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Multiple Celery queues for asynchronous tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django Channels for websocket support with daphne"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Graphene for GraphQL"}]}]},{"type":"element","tag":"h3","props":{"id":"vuejs-application"},"children":[{"type":"text","value":"Vue.js application"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Quasar Framework for creating a Vue.js app with multiple build targets (SPA, PWA, Electron, SSR and Cordova)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Internationalization"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Dark/Light mode"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vuex for state management"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"vue-router"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"axios"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue Apollo"}]}]},{"type":"element","tag":"h3","props":{"id":"aws-django-vuejs"},"children":[{"type":"text","value":"AWS  Django  Vue.js"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CloudFront is used as a CDN and proxy in order to serve the frontend Vue.js PWA* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"3"}]}]},{"type":"text","value":", static and media assets, Django API and other monitoring services all on the same URL with environments namespaced by subdomain (or a combination of domain and subdomains by production and non-production environments, respectively). The PWA uses Workbox to route certain URL paths to network only (not served by the local cache)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some examples:"}]},{"type":"element","tag":"h4","props":{"id":"staging-environment-urls"},"children":[{"type":"text","value":"Staging environment URLs"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/api/*"}]},{"type":"text","value":" - Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/admin/*"}]},{"type":"text","value":" - Django Admin"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/graphql/"}]},{"type":"text","value":" - Graphene/GraphQL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/flower/*"}]},{"type":"text","value":" - Flower (Celery monitoring utility)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/media/private/private-file.csv"}]},{"type":"text","value":" - private media files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://dev.mysite.com/*"}]},{"type":"text","value":" - Vue.js PWA (all other routes load "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"h4","props":{"id":"production-environment-urls"},"children":[{"type":"text","value":"Production environment URLs"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/api/*"}]},{"type":"text","value":" - Django REST Framework"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/admin/*"}]},{"type":"text","value":" - Django Admin"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/graphql/"}]},{"type":"text","value":" - Graphene/GraphQL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/flower/*"}]},{"type":"text","value":" - Flower (Celery monitoring utility)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com/media/private/private-file.csv"}]},{"type":"text","value":" - private media files"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://mysite.com"}]},{"type":"text","value":" - Vue.js PWA (all other routes load "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alternatively, the production domain name could be configured to use a dedicated subdomain such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://app.mysite.com"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"sample-application-logic"},"children":[{"type":"text","value":"Sample application logic"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While this is mostly a Proof-of-Concept project that focuses on architecture, I have included some light-weight examples of what you can do with this application. These examples are all WIP."}]},{"type":"element","tag":"h4","props":{"id":"social-authentication"},"children":[{"type":"text","value":"Social Authentication"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python-social-auth"}]},{"type":"text","value":" to allow users to Sign Up/Login with Google, Facebook and GitHub accounts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Makes use of the custom user model"}]}]},{"type":"element","tag":"h4","props":{"id":"credit-card-statement-app"},"children":[{"type":"text","value":"Credit Card Statement App"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a simple application for users to upload credit card statements in CSV format."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Credit card transactions in CSV files are created using bulk inserts via the Django ORM in a celery task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CSV files are saved in private S3 storage"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Basic visualization of spend over time"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Download consolidated CSV file"}]}]},{"type":"element","tag":"h4","props":{"id":"hacker-news-clone"},"children":[{"type":"text","value":"Hacker News Clone"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An implementation of the application from this tutorial: "},{"type":"element","tag":"a","props":{"href":"https://www.howtographql.com/graphql-python/0-introduction/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.howtographql.com/graphql-python/0-introduction/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Uses Vue Apollo GraphQL client"}]}]},{"type":"element","tag":"h3","props":{"id":"testing"},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Unit testing with pytest and Jest"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Test coverage reports"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Integration testing with Cypress"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Capture integration test run recordings as GitLab CI job artifacts"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing GitLab CI jobs locally with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gitlab-runner"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Tests for CDK?* "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"4"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"caveats-questions-confusion-and-footnotes"},"children":[{"type":"text","value":"Caveats, Questions, Confusion and Footnotes"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In the context of this project, it is serverless in the sense that AWS Fargate is serverless: there are no EC2 instances to manage. It is not serverless in the way that Zappa can deploy a Django application as an AWS Lambda function with one invocation per request. There are \"always on\" processes that listen for incoming requests. I'm interested in trying Zappa, but I'm confused about how CDK, zappa-cli, SAM and Serverless Framework would all play together. Aurora Postgres Serverless is another nice \"serverless\" aspect of this project and contributes significantly to cost savings."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This project currently uses no NAT Gateways. The Fargate services and tasks running Django processes (gunicorn, celery, daphne as well as migration, collectstatic and other management commands) are launched in public subnets and the databases (RDS and ElastiCache) are placed in private subnets. This is primarily done to avoid the cost of running a NAT Gateway."}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I think it would fairly easy to switch to using a NAT Gatway to add an additional layer of security that is recommended in this article: "},{"type":"element","tag":"a","props":{"href":"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/","rel":["nofollow"]},"children":[{"type":"text","value":"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I asked a question about this on the Stack Exchange Information Security forum: "},{"type":"element","tag":"a","props":{"href":"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job","rel":["nofollow"]},"children":[{"type":"text","value":"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job"}]},{"type":"text","value":"\nI'm curious to know if this is a reasonable tradeoff to make, as well as how secure the proposed solution is (using security groups and network ACLs)."}]}]},{"type":"element","tag":"ol","props":{"start":3},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I'm not focusing on SEO in this project. I'm using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" as the error document for the S3 website that CloudFront uses as the default behavior. This means that nested routes for the PWA have 404 response codes. I have heard about using lambda@edge to rewrite the the response code, I'm also curious about using this project in SSR mode (and also \"serverless-side rendering\"), but for now that is outside of the scope of what I want to do with this project."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CDK is an awesome tool!"}]},{"type":"text","value":" Here is a great introduction by Nathan Peck, Senior Developer Advocate at Amazon Web Services: "},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=184S7ki6fJA","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.youtube.com/watch?v=184S7ki6fJA"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"h2","props":{"id":"my-experience-with-aws-cdk"},"children":[{"type":"text","value":"My experience with AWS CDK"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Having worked with CloudFormation for almost a year, I was not looking forward to learning a another Infrastructure as Code (IaC) tool. I struggled with CloudFormation and the whole concept of using an extended version of YAML to define infrastructure for multiple environments. I have limited experience with Terraform, but learning another DSL seemed like a lateral move that didn't seem worth it. I'm glad I did spend time learning and using CloudFormation, because CDK is an abstraction layer over CloudFormation. Here are some of my thoughts on adopting CDK."}]},{"type":"element","tag":"h3","props":{"id":"start-here-httpscdkworkshopcom"},"children":[{"type":"text","value":"Start here: "},{"type":"element","tag":"a","props":{"href":"https://cdkworkshop.com","rel":["nofollow"]},"children":[{"type":"text","value":"https://cdkworkshop.com"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a great resource that was my first exposure to CDK. It focuses on using Lambda, DynamoDB and API Gateway, three technologies that I haven't used in production environments. In my mind this stack is the antithesis of the stack paradigm I am most experienced with: EC2, RDS and ELB. Regardless, I went ahead with it and was pretty much instantly hooked on CDK."}]},{"type":"element","tag":"h3","props":{"id":"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing"},"children":[{"type":"text","value":"The stack is defined by a small number of inputs used for namespacing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app.py"}]},{"type":"text","value":" is the entrypoint for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk"}]},{"type":"text","value":" commands. Here's what it contains:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the main parameters for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", which represents all of the resources for a specific environment environment. Each value is composed of environment variables set in GitLab CI when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" is called:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment_name"}]},{"type":"text","value":" - Possible examples could be "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"qa"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"some-feature-branch"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod"}]},{"type":"text","value":", etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"text","value":" - The domain name of the Hosted Zone that needs to be setup manually in Route53"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":" - "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"f\"{environment_name}.{base_domain_name}\""}]},{"type":"text","value":" or optionally just "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_app_name"}]},{"type":"text","value":" - Based on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"text","value":", but "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" is replaced with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" in order to be used for naming certain AWS resources, used for resources tagging so we can easily look at the costs of all environments for our application with one tag."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_app_name"}]},{"type":"text","value":" - Base on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"."}]},{"type":"text","value":" replaced with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" as well."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_region"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Expand to the following to view "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/app.py"}]},{"type":"text","value":":"}]},{"type":"element","tag":"details","props":{},"children":[{"type":"element","tag":"pre","props":{"code":"#!/usr/bin/env python3\nimport os\n\nfrom aws_cdk import core\n\nfrom awscdk.cdk_app_root import ApplicationStack\n\n# naming conventions, also used for ACM certs, DNS Records, resource naming\n# Dynamically generated resource names created in CDK are used in GitLab CI\n# such as cluster name, task definitions, etc.\nenvironment_name = f\"{os.environ.get('ENVIRONMENT', 'dev')}\"\nbase_domain_name = os.environ.get(\"DOMAIN_NAME\", \"mysite.com\")\n# if the the production environent subdomain should nott be included in the URL\n# redefine `full_domain_name` to `base_domain_name` for that environment\nfull_domain_name = f\"{environment_name}.{base_domain_name}\"  # dev.mysite.com\n# if environment_name == \"prod\":\n#     full_domain_name = base_domain_name\nbase_app_name = os.environ.get(\"APP_NAME\", \"mysite-com\")\nfull_app_name = f\"{environment_name}-{base_app_name}\"  # dev-mysite-com\naws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n\n\napp = core.App()\nstack = ApplicationStack(\n    app,\n    f\"{full_app_name}-stack\",\n    environment_name=environment_name,\n    base_domain_name=base_domain_name,\n    full_domain_name=full_domain_name,\n    base_app_name=base_app_name,\n    full_app_name=full_app_name,\n    env={\"region\": aws_region},\n)\n\n# in order to be able to tag ECS resources, you need to go to\n# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n# and enable at least Service and Task. Optionally enable\n# CloudWatch Container Insights\nstack.node.apply_aspect(core.Tag(\"StackName\", full_app_name))\nstack.node.apply_aspect(core.Tag(\"StackName\", base_app_name))\n\napp.synth()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/usr/bin/env python3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" aws_cdk "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" core\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" awscdk.cdk_app_root "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ApplicationStack\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# naming conventions, also used for ACM certs, DNS Records, resource naming\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Dynamically generated resource names created in CDK are used in GitLab CI\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# such as cluster name, task definitions, etc.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ENVIRONMENT'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'dev'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"DOMAIN_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mysite.com\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# if the the production environent subdomain should nott be included in the URL\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# redefine `full_domain_name` to `base_domain_name` for that environment\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_domain_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # dev.mysite.com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# if environment_name == \"prod\":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#     full_domain_name = base_domain_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"APP_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mysite-com\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # dev-mysite-com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_region "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"AWS_DEFAULT_REGION\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"us-east-1\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" core.App()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ApplicationStack(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    app,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-stack\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    environment_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    base_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_domain_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    full_domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_domain_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    base_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_app_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    full_app_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"full_app_name,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    env"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"region\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": aws_region},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# in order to be able to tag ECS resources, you need to go to\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# and enable at least Service and Task. Optionally enable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# CloudWatch Container Insights\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack.node.apply_aspect(core.Tag("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"StackName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", full_app_name))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"stack.node.apply_aspect(core.Tag("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"StackName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", base_app_name))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app.synth()\n"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"using-cdk-synth-in-development"},"children":[{"type":"text","value":"Using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" in development"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I first started using CDK, I defined a root stack containing multiple CDK constructs that each included groups of related CDK resources. For example, I had an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RDSConstruct"}]},{"type":"text","value":" that contained a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Secret"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StringParameter"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnSecurityGroup"}]},{"type":"text","value":", a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBSubnetGroup"}]},{"type":"text","value":" and a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBCluster"}]},{"type":"text","value":". Whenever I added a new section of CDK code, I would run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth > stack.yml"}]},{"type":"text","value":" to generate a \"snapshot\" of my infrastructure in one file. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" was committed in my repo, and I could easily see how changes in CDK code changed the resulting CloudFormation YAML by repeating this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"h3","props":{"id":"nestedstacks"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stack.yml"}]},{"type":"text","value":" grew larger and larger as I added more resources in my main \"master stack\" or \"skeleton stack\", and I realized that I was going to reach the hard limit of 200 resources per CloudFormation stack. Refactoring to use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s was pretty straightforward, all I had to do was replace "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"core.Construct"}]},{"type":"text","value":" with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cloudformation.NestedStack"}]},{"type":"text","value":". With nested stacks, running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk synth > stack.yml"}]},{"type":"text","value":" references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS::CloudFormation::Stack"}]},{"type":"text","value":"s that are created, with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TemplateURL"}]},{"type":"text","value":" and parameters from other stacks. It is more useful to look into contents of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":" when working with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s. The following command (executed from the root of the project) update the contents of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk/cdk.out"}]},{"type":"text","value":" directory with templates for each of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s:"}]},{"type":"element","tag":"pre","props":{"code":"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The result is JSON, not YAML, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.out"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":"d, but it can still be helpful in verifying that your CDK code is generating the correct CloudFormation templates. ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk diff"}]},{"type":"text","value":" may be the best option for seeing how CDK code changes will change your infrastructure)."}]},{"type":"element","tag":"h3","props":{"id":"cdk-deploy-and-cdk-in-gitlab-ci-pipelines"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" and CDK in GitLab CI pipelines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like how "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tail"}]},{"type":"text","value":"s the output of CloudFormation events until the stack update finishes or fails. I previously had been using the AWS CLI to call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws cloudformation update-stack"}]},{"type":"text","value":". This command kicks off a stack update and the GitLab pipeline will succeed regardless of the success of failure of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"update-stack"}]},{"type":"text","value":" command."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With CDK, the CI pipeline that calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" fails if "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" results in a stack rollback."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I couldn't find any examples of how to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" in a GitLab CI pipeline (using the Python version of CDK, or any version of CDK). It would be nice if there was an official image maintained for the different languages that are ready to run CDK deploy. Here's how I got "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" working correctly in my CI/CD pipline:"}]},{"type":"element","tag":"pre","props":{"code":"cdk deploy:\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  stage: deploy\n  only:\n    - master\n  variables:\n    ENVIRONMENT: dev\n    DOCKER_TLS_CERTDIR: ''\n  before_script:\n    - apk add nodejs-current npm\n    - npm i -g aws-cdk\n    - apk add --no-cache python3\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"docker:19.03.5-dind\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  stage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  only"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"master\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  variables"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    ENVIRONMENT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"dev\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    DOCKER_TLS_CERTDIR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"''\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  before_script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk add nodejs-current npm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"npm i -g aws-cdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"apk add --no-cache python3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pip3 install -e awscdk\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"cdk deploy --app awscdk/app.py --require-approval never\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have all of my CDK code in a top level directory called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awscdk"}]},{"type":"text","value":", my Django code is in the top level "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory and my frontend code is in the top level "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"quasar"}]},{"type":"text","value":" directory. This directory structure is important, I'll come back to it shortly. Here are some things to note about this GitLab CI job definition:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It uses the base "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" image with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker:dind"}]},{"type":"text","value":" as a dependent service. This is necessary only if you hare using CDK constructs that build docker images and make use of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":", such as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_ecs.AssetImage"}]},{"type":"text","value":" that I use to define "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.image"}]},{"type":"text","value":" in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":" class that defines that main stack of my application."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It requires node, npm python and pip, so these all need to be installed via "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apk"}]},{"type":"text","value":", the package manager for Alpine Linux. These are done in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"before_script"}]},{"type":"text","value":", the setup for the main \"script\" where "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk deploy"}]},{"type":"text","value":" is called."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The main "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"script"}]},{"type":"text","value":" section calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":". You only need to call "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" once to initialize resources that CDK will use, so placing it here in my CI script is more of a reminder that we are using CDK assets (S3 buckets and ECR images); calling it again once it has been called initially on your AWS account does nothing, and you will see a message that communicates this:"}]}]},{"type":"element","tag":"pre","props":{"code":" $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n    Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n    Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n"}]}]},{"type":"element","tag":"h3","props":{"id":"cdk-bootstap"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstap"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk bootstrap"}]},{"type":"text","value":" is one of my favorite features of CDK. As I mentioned earlier, it is used with S3 and ECR."}]},{"type":"element","tag":"h4","props":{"id":"s3-assets"},"children":[{"type":"text","value":"S3 Assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With S3, it allows you to populate the contents of an S3 bucket. Here's an example from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"        if os.path.isdir(\"./quasar/dist/pwa\"):\n            s3_deployment.BucketDeployment(\n                self,\n                \"BucketDeployment\",\n                destination_bucket=self.static_site_bucket,\n                sources=[s3_deployment.Source.asset(\"./quasar/dist/pwa\")],\n                distribution=self.cloudfront.distribution,\n            )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.path.isdir("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./quasar/dist/pwa\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            s3_deployment.BucketDeployment(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"                self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                \"BucketDeployment\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                destination_bucket"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".static_site_bucket,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                sources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[s3_deployment.Source.asset("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"./quasar/dist/pwa\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                distribution"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".cloudfront.distribution,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the directory "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./quasar/dist/pwa"}]},{"type":"text","value":" exists, CDK will upload the contents of that directory to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_bucket"}]},{"type":"text","value":" and then invalidate the cache for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"self.cloudfront.distribution"}]},{"type":"text","value":", all in one shot. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"./quasar/dist/pwa"}]},{"type":"text","value":" is the directory where assets from my frontend PWA are placed when compiled. GitLab CI passes these files between the jobs using artifacts:"}]},{"type":"element","tag":"pre","props":{"code":"artifacts:\n  paths:\n    - quasar/dist/pwa\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"artifacts"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  paths"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"quasar/dist/pwa\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The job to build PWA assets can be set to only run when there are changes in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"quasar"}]},{"type":"text","value":" directory, so the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".quasar/dist/pwa"}]},{"type":"text","value":" directory will only exist if the job is executed. This helps speed up our CI/CD pipeline."}]},{"type":"element","tag":"h4","props":{"id":"ecr-assets"},"children":[{"type":"text","value":"ECR Assets"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk boostrap"}]},{"type":"text","value":" and CDK assets in a similar way for building and pushing my application container. In "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", I define the following:"}]},{"type":"element","tag":"pre","props":{"code":"        self.image = ecs.AssetImage(\n            \"./backend\", file=\"scripts/prod/Dockerfile\", target=\"production\",\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".image "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ecs.AssetImage(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"./backend\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"scripts/prod/Dockerfile\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"target"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"production\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This image is then referenced by multiple "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"s that define Fargate services and tasks ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gunicorn"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"daphne"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery"}]},{"type":"text","value":" workers, etc.) This keeps our CDK code DRY.. Don't Repeat Yourself! Similarly, we aren't rebuilding, pushing and pulling the backend container when there are no changes to the code in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not setting up an ECR image repository for my application, but I believe there is a way to do this. One question that I have about using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs.AssetImage"}]},{"type":"text","value":" is about image lifecycle management. I know that you can implement rules about how many images you want to keep in an ECR image repository, but "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"I'm not sure how this works with CDK Image Assets"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"quick-tour-of-applicationstack"},"children":[{"type":"text","value":"Quick tour of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a very quick look at the structure of my CDK code, focusing on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ApplicationStack"}]},{"type":"text","value":", the \"master stack\" or \"skeleton stack\" that contains."}]},{"type":"element","tag":"h4","props":{"id":"hosted_zone"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"hosted_zone"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We get the hosted zone using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HOSTED_ZONE_ID"}]},{"type":"text","value":". This is not a nested stack."}]},{"type":"element","tag":"h4","props":{"id":"site_certificate"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"site_certificate"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The ACM Certificate that will be used for the given environment. This references the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"full_domain_name"}]},{"type":"text","value":" (environment + application)."}]},{"type":"element","tag":"h4","props":{"id":"vpc_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":" for defining VPC resources. This construct generates lots of CloudFormation resources. I currently have "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nat_gateways"}]},{"type":"text","value":" set to zero, and I'm "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PUBLIC"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PRIVATE"}]},{"type":"text","value":" subnets spread over 2 AZs. As I mentioned earlier, this is primarily for cost considerations and it is a best practice to use the tiered security model and run our Fargate tasks in private subnets instead of public subnets. I think I need to add NACL resources in this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"alb_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alb_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This defines the load balancer, configures that will send traffic to our Fargate services (such as our Django API). I was a little bit unclear about needing a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listener"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":". I might be able to get away with removing the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listener"}]},{"type":"text","value":" and only using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"static_site_stack"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_stack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the S3 bucket and policies that will be used for hosting our static site (Quasar PWA)."}]},{"type":"element","tag":"h4","props":{"id":"backend_assets"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_assets"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the bucket and policies for managing the bucket that holds static and media assets for Django."}]},{"type":"element","tag":"h4","props":{"id":"cloudfront"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cloudfront"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This defines the CloudFront distribution that ties together several different parts of the application. It is the \"front desk\" of the application, and acts as a CDN and proxy. There is a separate CloudFront distribution for each environment (dev, staging, production). This stack also defines the Route53 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ARecord"}]},{"type":"text","value":" that will be used to send traffic to a specific subdomain to the correct CloudFront distribution."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are three "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"origin_configs"}]},{"type":"text","value":" for each distribution:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomOriginConfig"}]},{"type":"text","value":" for the ALB"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomOriginConfig"}]},{"type":"text","value":" for the S3 bucket website"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"S3OriginConfig"}]},{"type":"text","value":" for the Django static assets"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note that these "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"origin_configs"}]},{"type":"text","value":" each have different "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"behaviors"}]},{"type":"text","value":", and that list comprehension is used to keep this code DRY."}]},{"type":"element","tag":"h4","props":{"id":"bucketdeployment"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"BucketDeployment"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will deploy our static site assets to the S3 bucket defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"static_site_stack"}]},{"type":"text","value":" if the static site assets are present at the time of deployment. If they are not present, this means that there were no changes made to the frontend site."}]},{"type":"element","tag":"h4","props":{"id":"ecs"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Defines the ECS Cluster."}]},{"type":"element","tag":"h4","props":{"id":"rds"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rds"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is no L2 construct for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DBCluster"}]},{"type":"text","value":", so I used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CfnDBCluster"}]},{"type":"text","value":" in order to use the Aurora Postgres "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"engine"}]},{"type":"text","value":" and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"serverless"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"engine_mode"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"elasticache"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"elasticache"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also had to use L1 constructs for ElastiCache, but this one is pretty straightforward."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For both RDS and ElastiCache I used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vpc_default_security_group"}]},{"type":"text","value":" as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"source_security_group"}]},{"type":"text","value":". It might be a better idea to define another security group altogether, but this approach works."}]},{"type":"element","tag":"h4","props":{"id":"assetimage"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AssetImage"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The docker image that references Django application code in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" directory. This image is referenced in Fargate services and tasks."}]},{"type":"element","tag":"h4","props":{"id":"variables"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"variables"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section defines and organizes all of the environment variables and secrets for my application."}]},{"type":"element","tag":"h4","props":{"id":"backend_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It might be a better idea to replace this with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NetworkLoadBalancedFargateService"}]},{"type":"text","value":", but instead I implemented this with lower-level constructs just to be clear about what I'm doing. To add a load balanced service, here is what I did:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the container to this task with other information (secrets, logging, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"command"}]},{"type":"text","value":", etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Give the task role permissions it needs such as access to Secrets, S3 permissions. (It might be a good idea to refactor this into a function that can be called on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"task_role"}]},{"type":"text","value":", but for now I am explicitly granting all permissions)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create and add a port mapping"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define an ECS Fargate Service that reference the previously defined Fargate task, configure security group"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the service as a target to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https_listener"}]},{"type":"text","value":" defined previously in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alb_stack"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Optionally configure autoscaling for the Fargate service"}]}]},{"type":"element","tag":"h4","props":{"id":"flower_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"flower_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Flower is a monitoring utility for Celery. I had trouble getting this to work correctly, but I managed to make it work by adding a simple nginx container that passes traffic to the flower container running in the same task. "},{"type":"element","tag":"a","props":{"href":"https://flower.readthedocs.io/en/latest/reverse-proxy.html","rel":["nofollow"]},"children":[{"type":"text","value":"https://flower.readthedocs.io/en/latest/reverse-proxy.html"}]}]},{"type":"element","tag":"h4","props":{"id":"celery_default_service"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery_default_service"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the default celery queue. This is discussed later in more detail, but the basic idea is to:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the container"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Define the Fargate service"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Grant permissions"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Configure autoscaling"}]}]},{"type":"element","tag":"h4","props":{"id":"celery_autoscaling"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery_autoscaling"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stack defines the Lambda function and schedule on which this Lambda is called. This stack is discussed in more detail later on."}]},{"type":"element","tag":"h4","props":{"id":"backend_tasks"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend_tasks"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are administrative tasks that are executed by running manual GitLab CI jobs such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createsuperuser"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"why-x-why-not-y"},"children":[{"type":"text","value":"Why "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"X"}]},{"type":"text","value":"? Why not "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Y"}]},{"type":"text","value":"?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section will compare some of the technology choices I have made in this project to other popular alternatives."}]},{"type":"element","tag":"h3","props":{"id":"why-ecs-why-not-kubernetes"},"children":[{"type":"text","value":"Why ECS? Why not Kubernetes?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like Kubernetes. I have never used it to support production workloads, but I have explored it in a limited capacity. I have set up this project in Kubernetes locally using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"minikube"}]},{"type":"text","value":", there is an article on this in the documentation. There are also lots of options for how you do Kubernetes, here are a few off of the top of my head:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"KOPS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"EKS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"k3s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"cdk8s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Kubernetes on Fargate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"\"Kuberetes the Hard Way\""}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With any of these options you are probably going to want to use Helm to do deployments, which adds another layer of abstraction that also has several different ways to be managed. On the other hand, ECS is \"just ECS\"; there are not a lot of other considerations to make when running workloads in ECS. You have to choose between the two available launch types: EC2 and Fargate. Comparisons of ECS and Kubernetes often mention that ECS integrates nicely with other AWS Services, something I have generally found to be true in setting up this project. Granting permissions to S3 buckets or CloudWatch, or using security groups to give ECS tasks access to certain resources in your VPC are some examples of what this \"tight integration\" has meant for me so far."}]},{"type":"element","tag":"h3","props":{"id":"why-django-why-not-flask"},"children":[{"type":"text","value":"Why Django? Why not Flask?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like Django for lots of reasons. I get why people say it can be \"overkill\", and there are definitely lots of parts of Django that don't use. I use Django primarily for the ORM, migrations system and the Django Admin. I also use the Django REST Framework, which gives me another big productivity boost when building APIs. I dislike Django Forms and Django templates, but that wasn't always the case. Before that, I disliked JavaScript frameworks and single page applications. That changes when I started working with Vue.js and Quasar."}]},{"type":"element","tag":"h3","props":{"id":"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react"},"children":[{"type":"text","value":"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Quasar Framework is a few different things, and just like Vue.js itself, Quasar can be incrementally adopted. Primarily, Quasar is a CLI for creating Vue.js projects. It offers some opinions on how to organize files and folders. It handles SPA, PWA, SSR, Electron, Cordova and other build targets. It implements the MaterialUI spec and it has an awesome and active community (but Django, GitLab and AWS do, too!)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Quasar does things a little bit differently than vanilla Vue.js. There is no "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main.js"}]},{"type":"text","value":" file in a typical Quasar application. Instead, bootfiles are used to initialize things that would typically go into "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main.js"}]},{"type":"text","value":". I believe this helps Quasar manage multiple build targets easily."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I really haven't worked a lot with Nuxt.js, but I would probably be drawn to it if Quasar was not an option. I like how it helps structure your application. In the same way that Django is \"batteries included\", Quasar is also very much \"batteries included\"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think React is neat, but I have similar feelings between React and Vue that I have between Django and Flask. One requires you make more decisions and therefore has a heavy mental load. The biggest example of this is the tight integration of an official router and state management system for Vue ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vue-router"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vuex"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h3","props":{"id":"why-celery-why-not-heuy-or-django-rq"},"children":[{"type":"text","value":"Why Celery? Why not Heuy or django-rq?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think celery is probably the most heavy-weight option for managing asynchronous tasks in Django. It is very flexible and \"pluggable\" which makes it slightly more challenging to get setup. I would be interested in trying another option, but celery is a mature option that has a large community of users."}]},{"type":"element","tag":"h2","props":{"id":"scaling-celery-workers-to-zero"},"children":[{"type":"text","value":"Scaling Celery workers to zero"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Django is used in a few different ways in this application:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a backend API supported by Django REST Framework, Postgres and static files stored in AWS S3, served over CloudFront"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a websocket server supported by Django Channels"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"an administrative backend that is automatically generated by Django (Django Admin)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"asynchronous task workers supported by Celery"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The API server, websocket server and Django admin can technically be served by the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"daphne"}]},{"type":"text","value":" process. In terms of our application and AWS architecture, this means that requests for URLs starting with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/ws/"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/"}]},{"type":"text","value":" can all be sent to the same Fargate service target group."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alternatively, we could split these up into two or three different process that can then be scaled individually."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Celery processes should be run as separate processes. If you have multiple queues, you may have workers that are dedicated to processing tasks from certain queues which run as individual Fargate tasks, each with certain CPU and memory allocations and other celery settings, such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max_concurrency"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To manage the total cost of ownership, I wanted to know how to scale Celery workers between 0 and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"N"}]},{"type":"text","value":". A celery worker is typically an \"always on\" process that watches for new messages that arrive in the queue and then processes message specified (the messages delivered to the queue contain information on which function to call, and what arguments that function should be called with."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's image that we have a celery task to process with the following properties:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It takes a long time to process (between 15 minutes and 1 or 2 hours)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It has lots of dependencies (such as pandas, scikit-learn, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It requires a high amount of CPU and memory"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It cannot easily be broken down into smaller sub-tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The time and frequency at which this task will be called is not predictable"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A 2 - 3 minute delay between calling the task and starting work on the task is acceptable"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This task might not be very easy to process with AWS Lambda without lots of additional logic, if not impossible."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To manage our project's TCO, we want scale down the number of Fargate tasks that process the queue this task is sent to. If there are no messages queued for this worker and no messages currently being processed by any of the workers for the queue, the number of Fargate tasks (celery workers) should be scaled down."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I haven't done much with autoscaling on AWS before, but I found that CDK provides some very nice abstractions that make scaling with Fargate task very straightforward."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ECS allows you to scale based on some built in metrics, such as CPU Utilization. Scaling between 0 and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"N"}]},{"type":"text","value":" workers based on CPU utilization metrics wouldn't work because there would be no CPU utilization after the Fargate tasks are scaled to zero; messages in the queue would remain unprocessed and no new workers would be brought online."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the number of tasks in the queue would be a better option. I tried a few different options to get this to work."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, I tried using one of the high-level constructs (L3 construct) from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs_patterns"}]},{"type":"text","value":" called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"QueueProcessingFargateService"}]},{"type":"text","value":", but this would require that I replace Redis with SQS as the broker to be used with Celery. Some people prefer to use SQS, but I like having the ability to inspect and control, which requires a broker like Redis and is not possible with SQS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My current solution involves:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Creating a CloudWatch metric (the namespace is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FULL_APP_NAME"}]},{"type":"text","value":" and the metric name is the name of the queue, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"default"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"auto_scale_task_count"}]},{"type":"text","value":" on the Fargate service to create a an \"autoscaling Fargate task\""}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"scale_on_metric"}]},{"type":"text","value":" on the \"autoscaling Fargate task\" with the CloudWatch metric created in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"1"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setting up a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery-metrics"}]},{"type":"text","value":" API endpoint on my Django API server that, when "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"POST"}]},{"type":"text","value":"ed to, collects celery metrics per queue and publishes these metrics to CloudWatch."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Scheduling a Lambda function to post to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery-metrics"}]},{"type":"text","value":" endpoint every 5 minutes."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code that takes care of steps 1, 2 and 3:"}]},{"type":"element","tag":"pre","props":{"code":"        self.default_celery_queue_cw_metric = cw.Metric(\n            namespace=scope.full_app_name, metric_name=\"default\"\n        )\n\n        self.celery_default_queue_asg = self.celery_default_worker_service.auto_scale_task_count(\n            min_capacity=0, max_capacity=2\n        )\n\n        self.celery_default_queue_asg.scale_on_metric(\n            \"CeleryDefaultQueueAutoscaling\",\n            metric=self.default_celery_queue_cw_metric,\n            scaling_steps=[\n                aas.ScalingInterval(change=-1, lower=0),\n                aas.ScalingInterval(change=1, lower=1),\n            ],\n            adjustment_type=aas.AdjustmentType.CHANGE_IN_CAPACITY,\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".default_celery_queue_cw_metric "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cw.Metric(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            namespace"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.full_app_name, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"metric_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"default\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_queue_asg "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_worker_service.auto_scale_task_count(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            min_capacity"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_capacity"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_queue_asg.scale_on_metric(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryDefaultQueueAutoscaling\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            metric"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".default_celery_queue_cw_metric,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            scaling_steps"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                aas.ScalingInterval("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"change"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lower"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                aas.ScalingInterval("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"change"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"lower"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            adjustment_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aas.AdjustmentType."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CHANGE_IN_CAPACITY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Step 4 inspects active and reserved tasks, filters the tasks by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"routing_key"}]},{"type":"text","value":" (which is the same as the queue name) and the combines this with any queued tasks by calling "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"llen(queue_name)"}]},{"type":"text","value":". Finally, the queue names and combined active, reserved and queued task totals are sent to CloudWatch via boto3. The code for this is in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend/apps/core/utils/celery_utils.py"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the code for the Lambda function in step 5:"}]},{"type":"element","tag":"pre","props":{"code":"import json\nimport os\nimport urllib.request\n\nFULL_DOMAIN_NAME = os.environ.get(\"FULL_DOMAIN_NAME\")\nCELERY_METRICS_PATH = \"api/celery-metrics/\"\n\nCELERY_METRICS_URL = f\"https://{FULL_DOMAIN_NAME}/{CELERY_METRICS_PATH}\"\nCELERY_METRICS_TOKEN = os.environ.get(\"CELERY_METRICS_TOKEN\")\n\n\ndef lambda_handler(event, context):\n    data = {\"celery_metrics_token\": CELERY_METRICS_TOKEN}\n    params = json.dumps(data).encode('utf8')\n    req = urllib.request.Request(\n        CELERY_METRICS_URL,\n        data=params,\n        headers={'content-type': 'application/json'},\n    )\n    response = urllib.request.urlopen(req)\n    return response.read()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"FULL_DOMAIN_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"FULL_DOMAIN_NAME\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_PATH"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"api/celery-metrics/\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"https://"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{FULL_DOMAIN_NAME}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{CELERY_METRICS_PATH}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_TOKEN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os.environ.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"CELERY_METRICS_TOKEN\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" lambda_handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    data "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"celery_metrics_token\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"CELERY_METRICS_TOKEN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    params "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json.dumps(data).encode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'utf8'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    req "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request.Request(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"        CELERY_METRICS_URL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        headers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'content-type'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'application/json'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" urllib.request.urlopen(req)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response.read()\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, here is the code for defining the lambda function and scheduled invocation of the lambda function:"}]},{"type":"element","tag":"pre","props":{"code":"class CeleryAutoscalingStack(cloudformation.NestedStack):\n    def __init__(self, scope: core.Construct, id: str, **kwargs) -> None:\n        super().__init__(\n            scope, id, **kwargs,\n        )\n\n        self.lambda_function = aws_lambda.Function(\n            self,\n            \"CeleryMetricsLambdaFunction\",\n            code=aws_lambda.Code.asset(\"awslambda\"),\n            handler=\"publish_celery_metrics.lambda_handler\",\n            runtime=aws_lambda.Runtime.PYTHON_3_7,\n            environment=scope.variables.regular_variables,\n        )\n\n        self.celery_default_cw_metric_schedule = events.Rule(\n            self,\n            \"CeleryDefaultCWMetricSchedule\",\n            schedule=events.Schedule.rate(core.Duration.minutes(5)),\n            targets=[\n                events_targets.LambdaFunction(handler=self.lambda_function)\n            ],\n        )\n\n        # TODO: refactor this to loop through CloudWatch metrics multiple celery queues\n        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n            scope.backend_service.backend_task.task_role\n        )\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" CeleryAutoscalingStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"cloudformation"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"NestedStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" __init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"scope"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": core.Construct, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"kwargs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") -> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        super"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"__init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            scope, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"kwargs,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_function "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" aws_lambda.Function(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryMetricsLambdaFunction\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_lambda.Code.asset("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"awslambda\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"publish_celery_metrics.lambda_handler\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"aws_lambda.Runtime."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"PYTHON_3_7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"scope.variables.regular_variables,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".celery_default_cw_metric_schedule "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" events.Rule(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"CeleryDefaultCWMetricSchedule\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            schedule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"events.Schedule.rate(core.Duration.minutes("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            targets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                events_targets.LambdaFunction("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".lambda_function)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":": refactor this to loop through CloudWatch metrics multiple celery queues\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            scope.backend_service.backend_task.task_role\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"miscellaneous-grievances"},"children":[{"type":"text","value":"Miscellaneous Grievances"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fargate tasks cannot access Secrets that use JSON template"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You cannot select "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FARGATE_SPOT"}]},{"type":"text","value":" on a CDK-created ECS cluster. This option seems to only be available from the ECS Wizard in the AWS Console"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It's not super clear how to package dependencies in Lambda with CDK. Here's an interesting approach that I would like to try: "},{"type":"element","tag":"a","props":{"href":"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487"}]},{"type":"text","value":". The Lambda functions I'm using don't require anything outside of the standard library, but if they did it would require some additional work to make sure dependencies can be added as Lambda Layers."}]}]},{"type":"element","tag":"h2","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create an IAM role template that can be used to create an IAM role that has access to setup infrastructure through CDK. Currently I'm using an admin account which is not a best practice."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Move this Wiki Article to the project documentation site and main README"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Expand on each topic, replace existing documentation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add a summary of each "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NestedStack"}]},{"type":"text","value":" from CDK code"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"development-philosophies-and-best-practices","depth":2,"text":"Development Philosophies and Best Practices"},{"id":"topics","depth":2,"text":"Topics","children":[{"id":"legend","depth":3,"text":"Legend"},{"id":"local-development","depth":3,"text":"Local development"},{"id":"gitlab-ci","depth":3,"text":"GitLab CI"},{"id":"aws","depth":3,"text":"AWS"},{"id":"django-application","depth":3,"text":"Django Application"},{"id":"vuejs-application","depth":3,"text":"Vue.js application"},{"id":"aws-django-vuejs","depth":3,"text":"AWS  Django  Vue.js"},{"id":"sample-application-logic","depth":3,"text":"Sample application logic"},{"id":"testing","depth":3,"text":"Testing"},{"id":"caveats-questions-confusion-and-footnotes","depth":3,"text":"Caveats, Questions, Confusion and Footnotes"}]},{"id":"my-experience-with-aws-cdk","depth":2,"text":"My experience with AWS CDK","children":[{"id":"start-here-httpscdkworkshopcom","depth":3,"text":"Start here: https://cdkworkshop.com"},{"id":"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing","depth":3,"text":"The stack is defined by a small number of inputs used for namespacing"},{"id":"using-cdk-synth-in-development","depth":3,"text":"Using cdk synth in development"},{"id":"nestedstacks","depth":3,"text":"NestedStacks"},{"id":"cdk-deploy-and-cdk-in-gitlab-ci-pipelines","depth":3,"text":"cdk deploy and CDK in GitLab CI pipelines"},{"id":"cdk-bootstap","depth":3,"text":"cdk bootstap"},{"id":"quick-tour-of-applicationstack","depth":3,"text":"Quick tour of ApplicationStack"}]},{"id":"why-x-why-not-y","depth":2,"text":"Why X? Why not Y?","children":[{"id":"why-ecs-why-not-kubernetes","depth":3,"text":"Why ECS? Why not Kubernetes?"},{"id":"why-django-why-not-flask","depth":3,"text":"Why Django? Why not Flask?"},{"id":"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react","depth":3,"text":"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?"},{"id":"why-celery-why-not-heuy-or-django-rq","depth":3,"text":"Why Celery? Why not Heuy or django-rq?"}]},{"id":"scaling-celery-workers-to-zero","depth":2,"text":"Scaling Celery workers to zero"},{"id":"miscellaneous-grievances","depth":2,"text":"Miscellaneous Grievances"},{"id":"todo","depth":2,"text":"TODO"}]}},"_type":"markdown","_id":"content:2020:06:02:django-postgres-vue-gitlab-ecs.md","_source":"content","_file":"2020/06/02/django-postgres-vue-gitlab-ecs.md","_stem":"2020/06/02/django-postgres-vue-gitlab-ecs","_extension":"md"},{"_path":"/2019/01/09/django-docker-vue-nginx-drf-traefik-celery","_dir":"09","_draft":false,"_partial":false,"_locale":"","title":"Setup, Development and Deployment of a web app using Django, VueJS, VuePress, Docker, nginx, traefik and GitLab","description":"This project is currently deployed on https://verbose-equals-true.tk. The source code is available at https://gitlab.com/briancaffey/verbose-equals-true.","layout":"post","date":"2019-01-09T00:00:00.000Z","comments":true,"image":"/static/technologies.png","tags":["django","vue","docker","gitlab"],"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This project is currently deployed on "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.tk","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.tk"}]},{"type":"text","value":". The source code is available at "},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/verbose-equals-true","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/verbose-equals-true"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The goal of this project is to explain how to setup a project starting with a fresh installation of 16.04. Setup includes local development environment, GitLab CI/CD, VSCode settings and configuration of the different containers that make up the application:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Node (for local development with VueJS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"nginx"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Traefik"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Postgres"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Celery"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"flower"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"portainer"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an overview of the architecture used in the application:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/architecture.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Extensive documentation for this project can be found at "},{"type":"element","tag":"a","props":{"href":"https://verbose-equals-true.tk/docs","rel":["nofollow"]},"children":[{"type":"text","value":"https://verbose-equals-true.tk/docs"}]},{"type":"text","value":"."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:2019:01:09:django-docker-vue-nginx-drf-traefik-celery.md","_source":"content","_file":"2019/01/09/django-docker-vue-nginx-drf-traefik-celery.md","_stem":"2019/01/09/django-docker-vue-nginx-drf-traefik-celery","_extension":"md"}]