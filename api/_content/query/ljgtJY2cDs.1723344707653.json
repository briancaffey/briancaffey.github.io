[{"_path":"/2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application","_dir":"02","_draft":false,"_partial":false,"_locale":"","title":"Using Stripe for recurring monthly SaaS subscriptions in a Django + Vue application","description":"This article shares my experience learning and implementing the Stripe API for recurring monthly SaaS subscription payments in an application using Django and Vue.js","date":"2021-01-02T00:00:00.000Z","image":"/static/django_vue_stripe.png","tags":["django","vue","drf","stripe"],"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"using-stripe-for-recurring-monthly-payments-to-a-paid-saas-subscription-in-a-django-vuejs-application"},"children":[{"type":"text","value":"Using Stripe for recurring monthly payments to a paid SaaS subscription in a Django + Vue.js application"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This diagram shows the flow of data for the lifecycle of a paid customer subscription in a Django application with a Vue.js client. There are four stages:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I. Account setup, configuration, model and object creation\nII. Logic and data flow for starting a customer's premium monthly subscription\nIII. Automatic subscription renewal\nIV. Cancelling a premium subscription"}]},{"type":"element","tag":"h2","props":{"id":"context"},"children":[{"type":"text","value":"Context"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is my first attempt at using Stripe, or any other online payment service API. Most of what I have diagramed here comes from this article from the Stripe documentation: "},{"type":"element","tag":"a","props":{"href":"https://stripe.com/docs/billing/subscriptions/fixed-price","rel":["nofollow"]},"children":[{"type":"text","value":"https://stripe.com/docs/billing/subscriptions/fixed-price"}]},{"type":"text","value":". Knowing almost nothing about what is needed to create a SaaS subscription, I found this article very helpful. It was a lot to read at once, but each call to to the Stripe API is very clear and straightforward."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I made some modifications and additions to this walk-through for my use case, which is an API service called Open SEC Data, an open source project that I'm working on ("},{"type":"element","tag":"a","props":{"href":"https://gitlab.com/briancaffey/sec-filings-app","rel":["nofollow"]},"children":[{"type":"text","value":"https://gitlab.com/briancaffey/sec-filings-app"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h2","props":{"id":"diagram"},"children":[{"type":"text","value":"Diagram"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a read-only link to the diagram: "},{"type":"element","tag":"a","props":{"href":"https://drive.google.com/file/d/1oH2b0W-c-dI5oXzc_jvCGvXx9sJagr4a/view?usp=sharing","rel":["nofollow"]},"children":[{"type":"text","value":"https://drive.google.com/file/d/1oH2b0W-c-dI5oXzc_jvCGvXx9sJagr4a/view?usp=sharing"}]},{"type":"text","value":". This diagram is made with "},{"type":"element","tag":"a","props":{"href":"https://www.diagrams.net/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.diagrams.net/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/django_vue_stripe_diagram.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"legend"},"children":[{"type":"text","value":"Legend"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a detailed description of each part of the diagram, starting with the first section."}]},{"type":"element","tag":"h3","props":{"id":"i-account-setup-configuration-model-and-object-creation"},"children":[{"type":"text","value":"I. Account setup, configuration, model and object creation"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Setup a Stripe account. For local development, make sure you turn on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"View test data"}]},{"type":"text","value":". On your local machine, install the stripe CLI and authenticate with your Stripe account"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a Product in Stripe (mine is called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Open SEC Data Premium Subscription"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a Price in Stripe that references the Product."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Instead of creating these objects in the Stripe Dashboard, you can also create them with the Stripe CLI or the Python SDK. I created a Django management command called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"create_stripe_data"}]},{"type":"text","value":" that will create a Product and related Price in Stripe. We will need the id of the Price, it looks like this: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"price_1Hx0goL67dRDwyuDh9yEWsBo"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the Price ID as an environment variable "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SUBSCRIPTION_PRICE_ID"}]},{"type":"text","value":" to the backend. This will be used later when we make API calls to Stripe from inside of Django views."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For production environments, you will need to a register a Stripe webhook. This is an endpoint in Django that Stripe will POST to in order to inform the Django application of events that have happened in Stripe."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"For local development we need to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe listen --forward-to localhost/api/stripe-webhooks/"}]},{"type":"text","value":" in order to forward webhook events to the local Django application. This works really well for local development."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In both local and production environments we need to add an environment variables to the Django application that will be used to validate the webhook event."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You will need to create a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscription"}]},{"type":"text","value":" model or similar in your Django models. This model should be related to your user model in some way. At a minimum it should have the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"subscription_id"}]},{"type":"text","value":" (the ID of the Stripe Subscription) and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"current_period_end"}]},{"type":"text","value":" (also from the Stripe Subscription object). We will use this model in the next sections."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/stripe-webhooks/"}]},{"type":"text","value":" is the endpoint in the Django application that Stripe will send POST requests to in order to inform the Django application of events that happen in Stripe. The URL can be called anything you want, as long as you register it with that URL. In local development, you need to specify this URL in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stipe listen"}]},{"type":"text","value":" command (for example, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe listen forward-to localhost/api/stripe-webhooks/"}]},{"type":"text","value":")."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"STRIPE_SECRET_KEY"}]},{"type":"text","value":" is the name of the secret API key that should only be accessible by the backend. In local development, this key looks like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sk_test_Abc123"}]},{"type":"text","value":". In production, this key will look like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sk_Abc123"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe"}]},{"type":"text","value":" is the name of the PyPI package that we need to add to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"requirements.txt"}]},{"type":"text","value":" ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"requirements/base.txt"}]},{"type":"text","value":")."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"STRIPE_PUBLISHABLE_KEY"}]},{"type":"text","value":" is the value of the Stripe API key that can be made public and is used in the Vue application to instantiate Stripe."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Stripe library is included in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" via CDN so that it is accessible anywhere in the Vue application. Stripe object is instantiated in the Vue application with:"},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"let stripe = Stripe(process.env.STRIPE_PUBLISHABLE_KEY)"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"ii-logic-and-data-flow-for-starting-a-customers-premium-monthly-subscription"},"children":[{"type":"text","value":"II. Logic and data flow for starting a customer's premium monthly subscription"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With everything setup and configured properly in Stripe, the backend Django application and the frontend Vue application, customers can now start paying for monthly subscriptions. In my application, a user can sign up for an account first without having a premium subscription. In other scenarios, having an active account may require a premium subscription."}]},{"type":"element","tag":"ol","props":{"start":13},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When a logged-in user visits their "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/account"}]},{"type":"text","value":" page, they will see the status of their account: Basic (free) or Premium (paid subscription). Users on a Basic plan will see the option to upgrade to Premium. They will be redirected to a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/premium"}]},{"type":"text","value":" page where they will be presented with a credit card form. This credit card form is generated by "},{"type":"element","tag":"a","props":{"href":"https://stripe.com/payments/elements","rel":["nofollow"]},"children":[{"type":"text","value":"Stripe Elements"}]},{"type":"text","value":". The user fills out their credit card, expiration date, card security code and billing ZIP code and then clicks "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Purchase"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Clicking on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Purchase"}]},{"type":"text","value":" calls a method "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"purchase"}]},{"type":"text","value":" that calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe.CreatePaymentMethod"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"paymentMethodId"}]},{"type":"text","value":" token returned from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe.CreatePaymentMethod"}]},{"type":"text","value":" is then passed to the method called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createSubscription"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Stripe creates this object and returns a response that contains a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"paymentMethodId"}]},{"type":"text","value":" token."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createSubscription"}]},{"type":"text","value":" sends a POST request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/stripe/create-subscription/"}]},{"type":"text","value":" in the Django application with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"paymentMethodId"}]},{"type":"text","value":" that we generated in the previous step."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/stripe/create-subscription/"}]},{"type":"text","value":" calls a view called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"create_subscription"}]},{"type":"text","value":" which makes a number of API calls to Stripe and then finally saves some data in the application's Postgres database."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The first API call creates the Customer object in Stripe if it does not exist. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"email=request.user.email"}]},{"type":"text","value":" is used in the API call to associate the Stripe customer with the user's email."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Next the payment method is attached to Stripe Customer model."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Next the Stripe payment method is set as the default payment method for Stripe customer for future billing."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Stripe subscription model is created with the customer ID that was created in the earlier and the price ID corresponding to the premium subscription (added in the setup stage)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Once these Stripe API calls have finished, a new Subscription is saved in the Postgres database. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe_subscription_id"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe_customer_id"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"valid_through"}]},{"type":"text","value":" (DateTimeField that keeps track of the date through which the user's subscription has been paid for) are saved to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscription"}]},{"type":"text","value":" model and then the subscription model is saved to the user model's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"subscription"}]},{"type":"text","value":" field."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createSubscription"}]},{"type":"text","value":" method's POST requests returns successfully, the user's account is fetched again from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The browser makes a request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" returns information on the user and their subscription."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Data from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" is updated in Vuex "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user"}]},{"type":"text","value":" store."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user is now able to make requests to resources for premium features."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In this application, one such example is the ability to request an API key for making for making API calls."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A user makes a request to an API endpoint for a premium feature."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When determining permissions for resources that should only be accessible to customers with valid subscriptions, we need to compare "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"request.user.subscription.valid_through"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"timezone.now()"}]},{"type":"text","value":" and make sure that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"valid_through"}]},{"type":"text","value":" is greater than "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"timezone.now()"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Requests for protected resources are successfully returned to the browser."}]}]},{"type":"element","tag":"h3","props":{"id":"iii-automatic-subscription-renewal"},"children":[{"type":"text","value":"III. Automatic subscription renewal"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The customer's credit card is charged once each month that they are subscribed to the service. This action happens in Stripe. This section assumes that the customer's primary payment method is still valid (it has not been canceled expired or not able to be charged for some other reason)."}]},{"type":"element","tag":"ol","props":{"start":32},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The customer's card is charged in Stripe and an event is sent to the Django backend via a webhook that we registered in the setup stage."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The webhook view checks "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"event.type"}]},{"type":"text","value":" and if the event is of type "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"invoice.paid"}]},{"type":"text","value":" we extend the user's subscription by one month."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"To extend the user's subscription, we modify the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DateTimeField"}]},{"type":"text","value":" field on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscription"}]},{"type":"text","value":" that tracks the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"current_period_end"}]},{"type":"text","value":" which is included in the webhook data object. The model field in my code is called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"valid_through"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"h3","props":{"id":"iv-cancelling-a-premium-subscription"},"children":[{"type":"text","value":"IV. Cancelling a premium subscription"}]},{"type":"element","tag":"ol","props":{"start":35},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When a user decides to cancel their payed subscription service, they click on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Cancel My Subscription"}]},{"type":"text","value":" button."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This makes a POST request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/stripe/cancel-subscription"}]},{"type":"text","value":" which calls the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cancel_subscription"}]},{"type":"text","value":" view. This view calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe.Subscription.delete(subscriptionId)"}]},{"type":"text","value":", where the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"subscriptionId"}]},{"type":"text","value":" is retrieved from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"request.user.subscription"}]},{"type":"text","value":" (the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Subscription"}]},{"type":"text","value":" model created in the setup section)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The subscription is deleted in Stripe through the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stripe.Subscription.delete"}]},{"type":"text","value":" API call."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user's subscription is deleted from the user model with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"request.user.subscription.delete()"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The frontend responds to the deleted subscription by fetching "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/account/"}]},{"type":"text","value":" again, refresh, or redirecting and the user no longer has access to their premium subscription."}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"context","depth":2,"text":"Context"},{"id":"diagram","depth":2,"text":"Diagram"},{"id":"legend","depth":2,"text":"Legend","children":[{"id":"i-account-setup-configuration-model-and-object-creation","depth":3,"text":"I. Account setup, configuration, model and object creation"},{"id":"ii-logic-and-data-flow-for-starting-a-customers-premium-monthly-subscription","depth":3,"text":"II. Logic and data flow for starting a customer's premium monthly subscription"},{"id":"iii-automatic-subscription-renewal","depth":3,"text":"III. Automatic subscription renewal"},{"id":"iv-cancelling-a-premium-subscription","depth":3,"text":"IV. Cancelling a premium subscription"}]}]}},"_type":"markdown","_id":"content:2021:01:02:using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application.md","_source":"content","_file":"2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application.md","_stem":"2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application","_extension":"md"}]