[{"_path":"/2024/10/09/redlm-ai-application-for-studying-chinese-literature-redology-nvidia-llama-index-developer-contest","_dir":"09","_draft":false,"_partial":false,"_locale":"","title":"RedLM: My submission for the NVIDIA and LlamaIndex Developer Contest","description":"RedLM is an AI-powered application for the study of China's greatest classical novel: Dream of the Red Chamber","date":"2024-11-09","image":"/static/redlm/title.png","tags":["nvidia","llama-index","ai","llm","rag","tensorrt-llm","chinese","redology"],"draft":false,"external":[{"link":"https://x.com/briancaffey/status/1855186768452321330","site":"x"},{"link":"https://dev.to/briancaffey/redlm-my-submission-for-the-nvidia-and-llamaindex-developer-contest-1c3k","site":"dev"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tddr"},"children":[{"type":"text","value":"td;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RedLM is a new way to study art and literature powered by artificial intelligence. It is an application that applies LLMs to the study of one of China‚Äôs most famous literary works: Dream of the Red Chamber. It uses leading language and vision models from Chinese AI groups including Alibaba‚Äôs Qwen, Baichuan Intelligence Technology and 01.AI. RedLM uses tools, techniques and services from NVIDIA and LlamaIndex including NVIDIA NIMs, Retrieval Augmented Generation and Multi-Modal RAG with vision language models. This project is my submission for the NVIDIA and LlamaIndex Developer Contest."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will cover how I built the project, challenges I faced and some of the lessons I learned while working with NVIDIA and LlamaIndex technologies."}]},{"type":"element","tag":"h3","props":{"id":"links"},"children":[{"type":"text","value":"Links"}]},{"type":"element","tag":"red-lm-tweet","props":{},"children":[]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://x.com/briancaffey/status/1855186768452321330","rel":["nofollow"]},"children":[{"type":"text","value":"ùïè Post"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/RedLM","rel":["nofollow"]},"children":[{"type":"text","value":"RedLM GitHub repository"}]}]}]},{"type":"element","tag":"h2","props":{"id":"what-is-redlm"},"children":[{"type":"text","value":"What is RedLM?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RedLM is a combination of the word ‚ÄúRed‚Äù and LM, an abbreviation for ‚Äúlanguage model‚Äù. Dream of the Red Chamber is such an important book in Chinese literature that it has its own field of study called Á∫¢Â≠¶ (literally ‚Äúthe study of red‚Äù), or Redology. So, RedLM is an application that uses language models for the study of Redology."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RedLM","src":"/static/redlm/title.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this project I focused on three applications of language models:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Summary and translation of the source text"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A Q&A bot that can answer questions about the book providing references to the specific paragraphs used to give answers"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An image-based Q&A bot that can answer questions about sections of paintings that depict scenes from each of the book‚Äôs chapters."}]}]},{"type":"element","tag":"h2","props":{"id":"notebooklm"},"children":[{"type":"text","value":"NotebookLM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used this article to create a \"Deep Dive\" podcast episode for RedLM using Google's NotebookLM."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"NotebookLM","src":"/static/redlm/notebooklm.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can "},{"type":"element","tag":"a","props":{"href":"https://x.com/briancaffey/status/1855186771409244491","rel":["nofollow"]},"children":[{"type":"text","value":"listen to this podcast episode here on ùïè"}]},{"type":"text","value":"."}]},{"type":"element","tag":"red-lm-deep-dive-video","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"how-i-built-redlm"},"children":[{"type":"text","value":"How I built RedLM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RedLM consists of two parts: a web UI built with Vue 3 using the Nuxt Framework and a backend API built with Python, FastAPI and LlamaIndex. There are lots of great tools for building full-stack AI applications such as Gradio and Streamlit, but I wanted to build with the web tools that I‚Äôm most familiar with and that provide the most flexibility. These frameworks (Nuxt and FastAPI) are simple and effective and they allowed me to develop quickly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of the code for this project was written by AI. I used OpenAI‚Äôs ChatGPT 4o, Anthropic‚Äôs Claude 3.5 Sonnet and 01.AI‚Äôs Yi-1.5-9B-Chat model. In my development process with AI, I prompted for one logical piece of the application at a time, such as one API route, one Vue component, one pinia store or one utility function, for example. In this article I'll share some of the prompts I used in my development workflow."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This project embraces a hybrid AI inference model, meaning that the AI inference can be done either on local RTX PCs or using NVIDIA‚Äôs Cloud APIs from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build.nvidia.com"}]},{"type":"text","value":" depending on configuration via environment variables. I used PCs with NVIDIA GeForce RTX 4090 GPUs to do inference with language and vision models, and with a change of configuration, I was able to do similar inference using NVIDIA‚Äôs API endpoints. This allowed me to develop the project both on powerful RTX desktop workstations and Mac laptops."}]},{"type":"element","tag":"h2","props":{"id":"translating-dream-of-the-red-chamber-with-tensorrt-llm"},"children":[{"type":"text","value":"Translating Dream of the Red Chamber with TensorRT-LLM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Translation is often mentioned as one of the capabilities of bilingual LLMs from China. I wanted to try translating this book from Chinese to English, but I also wanted to better understand the meaning of the original text written in vernacular Chinese. Written vernacular Chinese is essentially a form of Chinese that closely resembles the way Chinese was spoken in imperial China by common people. The use of vernacular Chinese (Baihua) in literary works marked a significant cultural shift that started to make literature and education more accessible. Before the emergence of written vernacular Chinese, Chinese literature was dominated by Classical Chinese (Wenyanwen) which is a more concise, ambiguous and specialized for of languages that assumes an understanding of ancient texts and Confucian classics. The difference between vernacular Chinese and modern Mandarin Chinese is somewhat analogous to the different between Shakespearian English (Early Modern English) and Modern English."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Baihua, Mandarin and English","src":"/static/redlm/translations.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Chinese large language models are well versed in Classical Chinese, written Chinese vernacular and modern Mandarin Chinese. I decided to rewrite the original vernacular text in simple, modern Mandarin Chinese and then using this new modern Mandarin version, translate the story into English."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dream of the Red Chamber is a large book. It is composed of over 800,000 Chinese characters, using 4303 unique Chinese characters. It has 120 chapters and a total of 3996 paragraphs. Here is a histogram showing the number of characters per paragraph."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Paragraph lengths","src":"/static/redlm/paragraphs.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I rented a large multi-GPU instance from AWS using some of the credits I get as a member of the AWS Community Builders program. The g5.12xlarge instance I selected has 4 A10G Tensor Core GPUs. The TensorRT-LLM LLM API is a relatively new part of the TensorRT-LLM library. It provides a very simple, high-level interface for doing inference. Following the "},{"type":"element","tag":"a","props":{"href":"https://nvidia.github.io/TensorRT-LLM/llm-api-examples/llm_inference_distributed.html","rel":["nofollow"]},"children":[{"type":"text","value":"LLM Generate Distributed example"}]},{"type":"text","value":" from the TensorRT-LLM documentation, I was able to translate the entire book into simple Mandarin and then from Mandarin into English in about an hour and 15 minutes. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tensor_parallel_size"}]},{"type":"text","value":" option in the LLM API allows for distributed inference, this meant that up to 4 paragraphs could be translated at the same time on different GPUs on the same EC2 instance."}]},{"type":"element","tag":"pre","props":{"code":"Translating: data/book/22.json\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 38/38 [00:15<00:00,  2.41it/s]\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 38/38 [00:24<00:00,  1.54it/s]\nTranslated: data/book/22.json\nTranslating: data/book/114.json\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 20/20 [00:11<00:00,  1.81it/s]\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 20/20 [00:12<00:00,  1.58it/s]\nTranslated: data/book/114.json\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n\nreal    74m1.578s\nuser    0m45.936s\nsys 0m36.283s\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Translating: data/book/22.json\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 38/38 [00:15<00:00,  2.41it/s]\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 38/38 [00:24<00:00,  1.54it/s]\nTranslated: data/book/22.json\nTranslating: data/book/114.json\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 20/20 [00:11<00:00,  1.81it/s]\nProcessed requests: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 20/20 [00:12<00:00,  1.58it/s]\nTranslated: data/book/114.json\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n[TensorRT-LLM][INFO] Refreshed the MPI local session\n\nreal    74m1.578s\nuser    0m45.936s\nsys 0m36.283s\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Getting good results required a bit of experimentation with parameters. The LLM API makes this very easy. The following code configures settings and builds the inference engine that can be used for doing completions:"}]},{"type":"element","tag":"pre","props":{"code":"sampling_params = SamplingParams(temperature=0.7, top_p=0.95, max_tokens=256)\nbuild_config = BuildConfig(max_seq_len=2048)\nllm = LLM(model=MODEL, build_config=build_config, tensor_parallel_size=4)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"sampling_params "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" SamplingParams("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"temperature"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"top_p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.95"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_tokens"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"256"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"build_config "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" BuildConfig("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"max_seq_len"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2048"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"llm "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" LLM("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"model"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"MODEL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"build_config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"build_config, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"tensor_parallel_size"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used the following prompts to rewrite each paragraph of the original text in simple, modern Mandarin Chinese:"}]},{"type":"element","tag":"pre","props":{"code":"bai_prompts = [\n    # Here are examples of how to rewrite Chinese vernacular into simple modern Mandarin.\\n\\nChinese vernacular:\\n\\n{p}\\n\\nSimple modern Mandarin\n    f\"‰ª•‰∏ãÊòØÂ¶Ç‰ΩïÂ∞Ü‰∏≠ÂõΩÁôΩËØùÊîπÂÜô‰∏∫ÁÆÄÂçïÁöÑÁé∞‰ª£ÊôÆÈÄöËØùÁöÑÁ§∫‰æã„ÄÇ\\n\\n‰∏≠ÊñáÁôΩËØùÔºö\\n\\n{p}\\n\\nÁÆÄÂçïÁöÑÁé∞‰ª£ÊôÆÈÄöËØùÔºö\\n\\n\"\n    for p in flat_bai\n]\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"bai_prompts "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # Here are examples of how to rewrite Chinese vernacular into simple modern Mandarin.\\n\\nChinese vernacular:\\n\\n{p}\\n\\nSimple modern Mandarin\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"‰ª•‰∏ãÊòØÂ¶Ç‰ΩïÂ∞Ü‰∏≠ÂõΩÁôΩËØùÊîπÂÜô‰∏∫ÁÆÄÂçïÁöÑÁé∞‰ª£ÊôÆÈÄöËØùÁöÑÁ§∫‰æã„ÄÇ"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"‰∏≠ÊñáÁôΩËØùÔºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n\\n{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}\\n\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ÁÆÄÂçïÁöÑÁé∞‰ª£ÊôÆÈÄöËØùÔºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" p "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" flat_bai\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It was difficult to get good results consistently. Here are some observations I had:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Some of the translated paragraphs were perfect"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"some translated paragraphs would randomly hallucinate the same phrase over and over again"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Some requests to translate text to English would reply in Mandarin Chinese rather than in English"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sometimes I would even see computer code generated when asking for a translation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The names of characters were sometimes translated inconsistently, sometimes literally and sometimes using differing versions of pinyin, the Romanization system for transcribing the sounds of Mandarin Chinese"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I found that ChatGPT 4o could handle any Chinese translation task flawlessly, but the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen2-7B"}]},{"type":"text","value":" model I used had mixed results! The change that I made that seemed to have the biggest impact on translation quality was setting "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*max_tokens*=256"}]},{"type":"text","value":" in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SamplingParams"}]},{"type":"text","value":". I probably could have used a dynamic value for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max_tokens"}]},{"type":"text","value":" based on the size of the current paragraph being translated. I also would have like to set up side-by-side comparisons of translations using different sized models, but rather than spend time and AWS credits on optimizing translation with TensorRT-LLM, I wanted to focus on the main part of this project: retrieval augmented generation (RAG) with LlamaIndex."}]},{"type":"element","tag":"h2","props":{"id":"building-qa-bots-with-rag-using-llamaindex"},"children":[{"type":"text","value":"Building Q&A bots with RAG using LlamaIndex"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My primary objective with this project was to implement a simple chat bot that responds to questions about the book with references to the specific paragraphs used in the response. The following shows images of the UI I built with one of the examples I included in the video I made for this project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RAG Example","src":"/static/redlm/rag_example.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I haven't read that much of the book before working on this project, but I have read a lot "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"about"}]},{"type":"text","value":" this book's characters, major themes and plot. This Q&A bot was a very interesting entrypoint to explore specific passages of the book starting with questions coming from my knowledge about the book. The question in the screenshots above is: ‚ÄúWhat does Jia Baoyu‚Äôs father think about him?‚Äù The response includes references to paragraphs where Jia Zheng (Baoyu‚Äôs father) is discussing his son. I was pretty amazed that the RAG query was able to pull out these two paragraphs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"In Dream of the Red Chamber, the relationship between protagonist Jia Baoyu and his father, Jia Zheng, is complex and fraught with tension. Jia Zheng, a strict, traditional Confucian patriarch, embodies values of discipline, scholarly rigor, and duty. He expects his son to excel in his studies and uphold the family‚Äôs honor by pursuing an official career in government. Baoyu, however, is sensitive, imaginative, and inclined toward poetry and the company of women, especially his cousins Lin Daiyu and Xue Baochai. This preference clashes with Jia Zheng‚Äôs expectations, leading to frequent misunderstandings and disappointment."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default, LlamaIndex uses cosine similarity as the distance metric for finding the vectors representing the documents (paragraphs) that are ‚Äúclosest‚Äù to the vector representing the user query. This is the central mechanism by which RAG works. LlamaIndex provides an abstraction of this process, hiding the implementation details and allowing rapid development of retrieval systems."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Cosine Similarity","src":"/static/redlm/cosine_similarity.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Source: "},{"type":"element","tag":"a","props":{"href":"https://medium.com/@kbdhunga/a-beginners-guide-to-similarity-search-vector-indexing-part-one-9cf5e9171976","rel":["nofollow"]},"children":[{"type":"text","value":"https://medium.com/@kbdhunga/a-beginners-guide-to-similarity-search-vector-indexing-part-one-9cf5e9171976"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is some of the code I wrote for the text-based Q&A bot using LlamaIndex‚Äôs "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomQueryEngine"}]},{"type":"text","value":" class to fetch the nodes from which I get the referenced paragraph text, chapter number and paragraph number."}]},{"type":"element","tag":"pre","props":{"code":"class QAndAQueryEngine(CustomQueryEngine):\n    \"\"\"RAG Completion Query Engine optimized for Q&A\"\"\"\n\n    retriever: BaseRetriever\n    response_synthesizer: BaseSynthesizer\n    llm: OpenAILike\n    qa_prompt: PromptTemplate\n\n    def custom_query(self, query_str: str):\n        nodes = self.retriever.retrieve(query_str)\n        metadata = []\n        # Collect the metadata into a list of dicts so that it can be sent to UI for references\n        for node in nodes:\n            metadata_dict = {}\n            node_metadata = node.node.metadata\n            metadata_dict[\"content\"] = node.node.text\n            metadata_dict[\"chapter\"] = int(node_metadata.get(\"chapter\"))\n            metadata_dict[\"paragraph\"] = int(node_metadata.get(\"paragraph\"))\n\n            metadata.append(metadata_dict)\n\n        context_str = \"\\n\\n\".join([n.node.get_content() for n in nodes])\n        response = self.llm.chat(\n            [\n                ChatMessage(\n                    role=\"user\",\n                    content=q_and_a_prompt.format( # the English and Chinese prompt templates are discussed below\n                        context_str=context_str, query_str=query_str\n                    ),\n                )\n            ]\n        )\n\n        return response, metadata\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" QAndAQueryEngine"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"CustomQueryEngine"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"RAG Completion Query Engine optimized for Q&A\"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    retriever: BaseRetriever\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    response_synthesizer: BaseSynthesizer\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    llm: OpenAILike\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    qa_prompt: PromptTemplate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" custom_query"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"query_str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        nodes "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".retriever.retrieve(query_str)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        metadata "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # Collect the metadata into a list of dicts so that it can be sent to UI for references\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" nodes:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            metadata_dict "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            node_metadata "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node.node.metadata\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            metadata_dict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"content\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node.node.text\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            metadata_dict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"chapter\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(node_metadata.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"chapter\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            metadata_dict["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"paragraph\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(node_metadata.get("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"paragraph\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            metadata.append(metadata_dict)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        context_str "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".join([n.node.get_content() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" n "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" nodes])\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".llm.chat(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ChatMessage(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    role"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"user\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    content"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"q_and_a_prompt.format( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# the English and Chinese prompt templates are discussed below\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                        context_str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"context_str, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"query_str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"query_str\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response, metadata\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"indexing-the-book-data"},"children":[{"type":"text","value":"Indexing the book data"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the indexing process, embedding models are used to translate chunks of text (paragraphs) into high-dimensional vectors that represent the relationships between the tokens in a chunk of text. These are the vectors stored in the \"Vector Database\" used by LlamaIndex. The chapter number, paragraph number and version (original, Mandarin Chinese and English) of each paragraph are added to the database entry as metadata during the indexing step which runs via a script before starting the FastAPI server. Here's how I indexed the original text and translations with LlamaIndex:"}]},{"type":"element","tag":"pre","props":{"code":"from llama_index.core import Document, VectorStoreIndex\nfrom llama_index.embeddings.huggingface import HuggingFaceEmbedding\n\nen_embedding_model = HuggingFaceEmbedding(model_name=\"BAAI/bge-small-en-v1.5\")\nzh_embedding_model = HuggingFaceEmbedding(model_name=\"BAAI/bge-small-zh-v1.5\")\n\ndef persist_index():\n    documents = []\n    for chapter in range(1, 121):\n        with open(f\"data/book/{chapter}.json\", \"r\") as f:\n            data = json.load(f)\n            paragraphs = data[\"paragraphs\"]\n\n        for i, p in enumerate(paragraphs):\n            for lang in [\"original\", \"chinese\", \"english\"]:\n                document = Document(\n                    text=p[lang],\n                    metadata={\n                        \"chapter\": str(chapter),\n                        \"paragraph\": str(i),\n                        \"language\": lang,\n                    },\n                    metadata_seperator=\"::\",\n                    metadata_template=\"{key}=>{value}\",\n                    text_template=\"Metadata: {metadata_str}\\n-----\\nContent: {content}\",\n                    embed_model=(\n                        en_embedding_model if lang == \"english\" else zh_embedding_model\n                    ),\n                )\n                documents.append(document)\n\n    index = VectorStoreIndex.from_documents(documents)\n    index.storage_context.persist(persist_dir=\"storage\")\n\nif __name__ == \"__main__\":\n    persist_index()\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" llama_index.core "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Document, VectorStoreIndex\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" llama_index.embeddings.huggingface "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" HuggingFaceEmbedding\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"en_embedding_model "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" HuggingFaceEmbedding("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"BAAI/bge-small-en-v1.5\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"zh_embedding_model "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" HuggingFaceEmbedding("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"BAAI/bge-small-zh-v1.5\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" persist_index"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"():\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    documents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" chapter "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" range"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"121"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"data/book/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chapter"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".json\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"r\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" f:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            data "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json.load(f)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            paragraphs "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"paragraphs\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i, p "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" enumerate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(paragraphs):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lang "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"original\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"chinese\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"english\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                document "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Document(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"p[lang],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    metadata"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                        \"chapter\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(chapter),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                        \"paragraph\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(i),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                        \"language\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": lang,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    metadata_seperator"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"::\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    metadata_template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{key}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{value}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    text_template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Metadata: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{metadata_str}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-----"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Content: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{content}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                    embed_model"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                        en_embedding_model "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" lang "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"english\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" else"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" zh_embedding_model\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    ),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                documents.append(document)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    index "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" VectorStoreIndex.from_documents(documents)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    index.storage_context.persist("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"persist_dir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"storage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" __name__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" =="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"__main__\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    persist_index()\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For the embedding models, I used the small BAAI General Embedding models (BGE) for English and Chinese. BAAI is the Beijing Academy of Artificial Intelligence, and I learned about this organization through some of the examples on the LlamaIndex site that use BAAI embeddings. There are multi-lingual embedding models (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"BAAI/bge-m3"}]},{"type":"text","value":"), but setting the embedding model on a per-document basis is possible and in some cases it might be preferable to using a single embedding model for all documents."}]},{"type":"element","tag":"h3","props":{"id":"milvus-vector-database"},"children":[{"type":"text","value":"Milvus Vector Database"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I did most of the development for this project using the in-memory VectorIndexStore provided by LlamaIndex. This worked well, but making any changes to the FastAPI server required the data to be reloaded into memory which took several seconds each time. This can really hinder a good development flow, so I looked into using an external service for the vector database instead of running it in memory."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Vector Database Options","src":"/static/redlm/vectordbs.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a LOT of options to consider when picking a vector database for a RAG application. Milvus has a highly decoupled architecture, it is fully open source and I had seen it in some examples in the "},{"type":"element","tag":"a","props":{"href":"https://github.com/NVIDIA/GenerativeAIExamples/tree/main/RAG/examples/advanced_rag/multimodal_rag","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NVIDIA/GenerativeAIExamples"}]}]},{"type":"text","value":" repo, so I decided to give it a try."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Milvus Vector Database Architecture","src":"/static/redlm/milvus.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the "},{"type":"element","tag":"a","props":{"href":"https://milvus.io/docs/v2.0.x/install_standalone-docker.md","rel":["nofollow"]},"children":[{"type":"text","value":"Milvus docker compose example"}]},{"type":"text","value":" I was able to set up an external vector database based on etcd and minio. Milvus also provides a Helm chart for running their vector database, this would be helpful if I was going to be running everything in Kubernetes (inference, vector database and application containers)."}]},{"type":"element","tag":"h3","props":{"id":"other-examples-of-rag-with-english-questions"},"children":[{"type":"text","value":"Other examples of RAG with English questions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One interesting design question I faced was how to support answering questions in both English and Chinese. I initially built the Q&A bot with only Chinese language support. Later, I added a simple helper function to determine if the input text is Chinese:"}]},{"type":"element","tag":"pre","props":{"code":"def is_chinese_text(text: str) -> bool:\n    \"\"\"\n    This is a simple helper function that is used to determine which prompt to use\n    depending on the language of the original user query\n    \"\"\"\n    chinese_count = sum(1 for char in text if '\\u4e00' <= char <= '\\u9fff')\n    english_count = sum(1 for char in text if 'a' <= char.lower() <= 'z')\n\n    return chinese_count > english_count\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" is_chinese_text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") -> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"bool"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    This is a simple helper function that is used to determine which prompt to use\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    depending on the language of the original user query\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    chinese_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sum"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" char "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" text "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\u4e00"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" char "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\u9fff"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    english_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" sum"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" char "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" text "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'a'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" char.lower() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'z'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" chinese_count "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" english_count\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This boolean value would then be used in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomQueryEngine"}]},{"type":"text","value":" to use either the Chinese or English "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PromptTemplate"}]},{"type":"text","value":". This allowed the Q&A bot to answer questions in either Chinese or English, and it does not require translating back and forth between Chinese and English. However, this method relies on high-quality translations, so I don't expect English language questions to be answered as accurately as Chinese language questions. Here are the Chinese and English prompts that I used for the text-based Q&A bot, as well as some examples of the Q&A bot answering questions in English. The referenced materials include paragraphs from the English translation."}]},{"type":"element","tag":"pre","props":{"code":"# Chinese prompt for text-based Q&A bot\nq_and_a_prompt = PromptTemplate(\n    \"ËøôÊòØÁõ∏ÂÖ≥ÁöÑÂèÇËÄÉËµÑÊñôÔºö\\n\"\n    \"---------------------\\n\"\n    \"{context_str}\\n\" # context_str contains Chinese paragraphs retrieved via RAG query\n    \"---------------------\\n\"\n    \"Ê†πÊçÆ‰∏äËø∞ÁöÑÂèÇËÄÉËµÑÊñôÔºåÂõûÁ≠î‰∏ãÈù¢ÁöÑÈóÆÈ¢ò\\n\"\n    \"ÈóÆÈ¢òÔºö{user_question}\\n\"\n)\n\n# English prompt for text-based Q&A bot\nq_and_a_prompt_english = PromptTemplate(\n    \"This is some related reference material:\\n\"\n    \"---------------------\\n\"\n    \"{context_str}\\n\" # context_str contains English paragraphs retrieved via RAG query\n    \"---------------------\\n\"\n    \"Based on the above material, answer the following question:\\n\"\n    \"Question: {user_question}\\n\"\n)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Chinese prompt for text-based Q&A bot\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"q_and_a_prompt "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PromptTemplate(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"ËøôÊòØÁõ∏ÂÖ≥ÁöÑÂèÇËÄÉËµÑÊñôÔºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{context_str}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # context_str contains Chinese paragraphs retrieved via RAG query\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Ê†πÊçÆ‰∏äËø∞ÁöÑÂèÇËÄÉËµÑÊñôÔºåÂõûÁ≠î‰∏ãÈù¢ÁöÑÈóÆÈ¢ò"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"ÈóÆÈ¢òÔºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{user_question}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# English prompt for text-based Q&A bot\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"q_and_a_prompt_english "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PromptTemplate(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"This is some related reference material:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{context_str}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # context_str contains English paragraphs retrieved via RAG query\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Based on the above material, answer the following question:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Question: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{user_question}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Multi-modal Q&A example 1","src":"/static/redlm/qa_example_01.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Asking random questions like this one is a fun way to explore the many scenes of Dream of the Red Chamber."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RAG Flower Pedal Example","src":"/static/redlm/qa_example_flower_pedals.png"},"children":[]},{"type":"element","tag":"img","props":{"alt":"RAG Flower Pedal Example with Reference","src":"/static/redlm/qa_example_flower_pedals_a.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"redlm-rag-evaluation"},"children":[{"type":"text","value":"RedLM RAG Evaluation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Examinations have long been a cornerstone of Chinese society, shaping individual aspirations, cultural values, and even government structures. This legacy began with the imperial civil service exams, kƒìj«î (Áßë‰∏æ), established during the Sui and Tang dynasties, and carries through in Modern China with the gaokao (È´òËÄÉ) college entrance examination, both of which have allowed for unprecedented meritocratic routes to power and prestige. Given how widely this novel is studied in China, I was not surprised to find a wealth of examination questions written for students studying Dream of the Red Chamber."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used "},{"type":"element","tag":"a","props":{"href":"https://www.examcoo.com/editor/do/view/id/246401","rel":["nofollow"]},"children":[{"type":"text","value":"a set of 1000 multiple choice questions about Dream of the Red Chamber on examcoo.com"}]},{"type":"text","value":" to evaluate the effectiveness of the RAG system I built with LlamaIndex. I wrote a script to parse the questions from the website HTML using ChatGPT (parsing HTML is one of my favorite use cases of LLMs!) I filtered the list of 1000 questions down to 877 questions based on the following criteria:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Four answer choices"}]},{"type":"text","value":": some of the questions had more than four answer choices. I filtered questions with more than four answer choices to keep the evaluation simple. This would allow me to assume that random answer choices would have a 25% chance of being correct."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Only one answer"}]},{"type":"text","value":": For some questions the correct answer required selecting multiple answer choices. This would also help keep the evaluation logic simple."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Multiple Choice Questions from Dream of the Red Chamber Test","src":"/static/redlm/hlm_mcq.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Multiple choice questions from a Dream of the Red Chamber test (examcoo.com)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To run the evaluation I set up two scripts. The first script would prompt the LLM to answer the question without any additional information from the RAG system. This served as a baseline to see how well the LLM could do at answering multiple choice questions about the book. The script simply checks to see if the LLM response contains the letter (A, B, C or D) of the correct answer and keeps track of the number of questions answered correctly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another script was used to take the test using large language models with RAG. In this script, the prompt sent to the LLM included relevant paragraphs from the book based on how similar the query is to each paragraph in the book based on the cosine similarity metric mentioned earlier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RAG evaluation","src":"/static/redlm/rag_eval.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some results and other observations from this experiment:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"LLMs alone scored in the mid 30% range (36%)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"LLMs using retrieval augmented generation with the set of questions score in the mid 40% range (44%)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I used the completion API rather than the chat API and set the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max_tokens"}]},{"type":"text","value":" to 16. This was done to ensure that the LLM only gave a short response with a valid answer choice rather than giving a long response with an explanation."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The evaluation took longer for LLM + RAG test because of the time required for making the RAG query and the longer prompt (including both the original multiple-choice question and the referenced paragraphs)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"01-ai/Yi-1.5-9B-Chat"}]},{"type":"text","value":" model for this test, but I probably should have used the base model rather than the chat model."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Some questions would not be capable of being answered by RAG. For example, some of the questions are about film renditions of the novel. Most of the questions seemed relevant to the content of the book, so I didn‚Äôt bother to filter out the questions that were not directly related to the book‚Äôs content."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is an example of a question that the LLM test script answered "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"incorrectly"}]},{"type":"text","value":" and the LLM + RAG test script answered "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"correctly"}]},{"type":"text","value":"."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Áß¶ÈíüÁöÑÁà∂‰∫≤ÊòØÂ¶Ç‰ΩïÊ≠ªÁöÑÔºü"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A„ÄÅÂ§ñÊÑüÈ£éÂØí„ÄÅÈ£éÊØí‰πãÁóá"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"B„ÄÅË¢´Êô∫ËÉΩÂÑøÊ∞îÊ≠ªÁöÑ"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C„ÄÅÁîüÊ∞îÂºïÂèëÊóßÁóÖÂä†Èáç"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"D„ÄÅÁîüÊ∞îËÄåËØ±Âèë‰∏≠È£éËÄåÊ≠ª"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Translation:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"How did Qin Zhong's father die?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"A."}]},{"type":"text","value":" He caught a cold and developed wind-related illnesses."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"B."}]},{"type":"text","value":" He was angered to death by Zhineng'er (a character)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"C."}]},{"type":"text","value":" His old illness worsened due to anger."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"D."}]},{"type":"text","value":" He had a stroke induced by anger and died."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is the paragraphs that the RAG query returned along with the English translation:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Original"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ëç£‰∏§Â§Ñ‰∏ä‰∏ãÂÜÖÂ§ñ‰∫∫Á≠âËé´‰∏çÊ¨¢Â§©ÂñúÂú∞ÔºåÁã¨ÊúâÂÆùÁéâÁΩÆËã•ÁΩîÈóª„ÄÇ‰Ω†ÈÅì‰ªÄ‰πàÁºòÊïÖÔºüÂéüÊù•ËøëÊó•Ê∞¥ÊúàÂ∫µÁöÑÊô∫ËÉΩÁßÅÈÄÉÂÖ•ÂüéÔºåÊù•ÊâæÁß¶ÈíüÔºå‰∏çÊÑèË¢´Áß¶ÈÇ¶‰∏öÁü•ËßâÔºåÂ∞ÜÊô∫ËÉΩÈÄêÂá∫ÔºåÂ∞ÜÁß¶ÈíüÊâì‰∫Ü‰∏ÄÈ°øÔºåËá™Â∑±Ê∞îÁöÑËÄÅÁóÖÂèë‰∫ÜÔºå‰∏â‰∫îÊó•‰æøÂëúÂëºÂìÄÂìâ‰∫Ü„ÄÇÁß¶ÈíüÊú¨Ëá™ÊÄØÂº±ÔºåÂèàÂ∏¶ÁóÖÊú™ÁóäÔºåÂèó‰∫ÜÁ¨ûÊùñÔºå‰ªäËßÅËÄÅÁà∂Ê∞îÊ≠ªÔºåÊÇîÁóõÊó†ÂèäÔºåÂèàÊ∑ª‰∫ÜËÆ∏Â§öÁóÖÁóá„ÄÇÂõ†Ê≠§ÔºåÂÆùÁéâÂøÉ‰∏≠ÊÄÖÊÄÖ‰∏ç‰πê„ÄÇËôΩÊúâÂÖÉÊò•ÊôãÂ∞Å‰πã‰∫ãÔºåÈÇ£Ëß£Âæó‰ªñÁöÑÊÑÅÈó∑ÔºüË¥æÊØçÁ≠âÂ¶Ç‰ΩïË∞¢ÊÅ©ÔºåÂ¶Ç‰ΩïÂõûÂÆ∂Ôºå‰∫≤ÂèãÂ¶Ç‰ΩïÊù•Â∫ÜË¥∫ÔºåÂÆÅËç£‰∏§Â∫úËøëÊó•Â¶Ç‰ΩïÁÉ≠ÈóπÔºå‰ºó‰∫∫Â¶Ç‰ΩïÂæóÊÑèÔºåÁã¨‰ªñ‰∏Ä‰∏™ÁöÜËßÜÊúâÂ¶ÇÊó†ÔºåÊØ´‰∏ç‰ªãÊÑè„ÄÇÂõ†Ê≠§Ôºå‰ºó‰∫∫Âò≤‰ªñË∂äÂèëÂëÜ‰∫Ü„ÄÇ"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"English"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Everyone in the Rong and Ning households, both inside and outside, were extremely happy, except for Baoyu, who seemed indifferent. Do you want to know why? It turns out that recently, the nun Zhineng from Shuiyue Temple secretly ran into the city to find Qin Zhong. Unexpectedly, she was discovered by Qin Zhong's father, Qin Banger. Qin Banger not only drove Zhineng away but also gave Qin Zhong a beating. This made Qin Banger so angry that his old illness relapsed, and within three to five days, he passed away. Qin Zhong had always been weak and hadn't fully recovered from a previous illness. After being beaten and seeing his father die in anger, he was overwhelmed with regret and sorrow, which worsened his condition. As a result, Baoyu felt very melancholic. Although the promotion of Yuan Chun to imperial concubine was a joyful event, it couldn't alleviate the gloom in his heart. While Grandmother Jia and others were busy expressing their gratitude and returning home, and relatives and friends came to celebrate, and the Rong and Ning households were bustling with excitement, Baoyu alone remained completely indifferent to it all. Consequently, everyone started to mock him for becoming more and more absent-minded."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The correct answer for this question is C."}]},{"type":"element","tag":"h2","props":{"id":"multi-modal-rag-for-visual-reasoning"},"children":[{"type":"text","value":"Multi-modal RAG for visual reasoning"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Qwen2-VL is a new AI model that was released in late August 2024. Qwen is the name of Alibaba‚Äôs AI Lab, and it is an abbreviation of the Chinese characters: ÂçÉÈóÆ (\"qian wen\", meaning 1000 questions). VL stands for vision-language, meaning that the model is capable of understanding both text and images. I had tested out the previous version of Qwen‚Äôs vision-language model and was very impressed by how it could accurately describe the contents of images and also answer general questions about images."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sun Wen was a Qing-era painter who spent 36 years of his life creating a series of 230 paintings capturing scenes from Dream of the Red Chamber. The paintings are incredibly detailed and often contain repeated figures in a temporal sequence. If you asked a Qwen-VL model to describe one of the images, it might return lengthy description that doesn't fully capture the full detail of the scene. It might also be difficult for a language model to \"focus\" on a portion of the whole image."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Dream of the Red Chamber Painting 131","src":"/static/redlm/painting_131.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This sparked the idea to create a feature where users can click and drag over an image to select part of a painting, then ask questions specifically about the selected portion. I knew that while this could be achieved with tools like HTML canvas, writing it on my own would be quite time-consuming. It took me just a few minutes to write out the prompt, and Claude 3.5 Sonnet generated a perfect prototype of this feature in under a minute. Here‚Äôs the prompt I used:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm going to describe a Vue component and I want you to write it using Vue 3 to the best of your ability."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"write a simple single-file vue component using Vue 3 that does the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"displays an image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"allows the users to click and drag to select a subsection of the image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the subsection of the image is saved as a base64-encoded data url to a variable that is displayed below the image"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The solution should make use of HTML canvas. When you click down on the image you begin selecting the subsection. You then move the mouse to make your subsection on the image, and when you mouse-up the subsection is selected and the data url is updated. Then the subsection is displayed at the very bottom of the page as a \"preview\" image using the base 64 image string as the image source."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The selection box should be a dashed red line"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RedLM Image Q&A","src":"/static/redlm/image-qa.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This shows the final result of the UI I built for the image Q&A feature in RedLM. It uses a similar chat layout that the text-based Q&A feature uses, with the addition of the image preview included in the chat log. The user query in this example just says ‚ÄúPlease describe the contents of the image‚Äù. This was the first image that I tested when building the image Q&A feature to see if the correct passage can be referenced based on the description of an image. This pulled the exact passage and the answer provides details about what happened (a fire broke out) where it happened (at the Gourd Temple) and why it happened (a Monk accidentally set an oil pot on fire)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is a diagram showing the overall flow of data in the image Q&A feature:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Diagram of RedLM Image Q&A with RAG and Vision Language Models","src":"/static/redlm/redlm.drawio.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This flow chart shows how the image Q&A feature works."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user selects part of an image and writes a question. This data is then sent to the RedLM API as a post request to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/mm-q-and-a"}]},{"type":"text","value":" endpoint (multi-modal Q&A)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vision language models are used to get a description of the image. Depending on the application configuration, this query can use models such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen/Qwen2-VL-2B-Instruct"}]},{"type":"text","value":" on RTX PCs or using the NVIDIA API Catalog using larger models such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta/llama-3.2-90b-vision-instruct"}]},{"type":"text","value":". Not all vision language models have the same interface, so I added some logic to handle different model formats."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The image description is used to fetch relevant documents from the Vector Database"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The full prompt with the image description and relevant documents is sent to the LLM. Again, inference for this step is done either with RTX PCs or using models from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build.nvidia.com"}]},{"type":"text","value":" API catalog."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The response from the LLM is sent back to the browser and is displayed to the user as a chat message."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is the prompt I used for the image Q&A feature:"}]},{"type":"element","tag":"pre","props":{"code":"# Chinese prompt for image-based Q&A bot\nmm_q_and_a_prompt = PromptTemplate(\n    \"ËøôÊòØ‰π¶‰∏≠Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºö\\n\"\n    \"{context_str}\\n\"\n    \"---------------------\\n\"\n    \"‰∏ãÈù¢ÊòØÂú∫ÊôØÁöÑÊèèËø∞Ôºö\\n\"\n    \"---------------------\\n\"\n    \"{image_description}\\n\"\n    \"---------------------\\n\"\n    \"Ê†πÊçÆ‰∏äËø∞ÁöÑ‰ø°ÊÅØÔºåÂ∞ΩÈáèËß£Èáä‰∏äËØ¥ÁöÑÂú∫ÊôØÂíå‰π¶ÁöÑÂÖ≥Á≥ª„ÄÇ\"\n)\n\n# English prompt for image-based Q&A bot\nmm_q_and_a_prompt_english = PromptTemplate(\n    \"Here is relevant content from the book:\\n\"\n    \"{context_str}\\n\"\n    \"---------------------\\n\"\n    \"Below is the description of a scene:\\n\"\n    \"---------------------\\n\"\n    \"{image_description}\\n\"\n    \"---------------------\\n\"\n    \"Based on the information provided above, try to explain the relationship between the described scene and the book content.\"\n)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Chinese prompt for image-based Q&A bot\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"mm_q_and_a_prompt "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PromptTemplate(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"ËøôÊòØ‰π¶‰∏≠Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{context_str}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"‰∏ãÈù¢ÊòØÂú∫ÊôØÁöÑÊèèËø∞Ôºö"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{image_description}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Ê†πÊçÆ‰∏äËø∞ÁöÑ‰ø°ÊÅØÔºåÂ∞ΩÈáèËß£Èáä‰∏äËØ¥ÁöÑÂú∫ÊôØÂíå‰π¶ÁöÑÂÖ≥Á≥ª„ÄÇ\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# English prompt for image-based Q&A bot\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"mm_q_and_a_prompt_english "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PromptTemplate(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Here is relevant content from the book:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{context_str}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Below is the description of a scene:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{image_description}\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"---------------------"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"Based on the information provided above, try to explain the relationship between the described scene and the book content.\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The prompt engineering for this feature was tricky. I was able to get some awesome results that would give me detailed and accurate responses, and then sometimes the LLM would seem confused about my query and tell me that there was no relationship between the scene description and the book content. Sometimes it would give me an accurate description of the scene, but then proceed to tell me that the book content is not related to the scene at all."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is another important concept from LlamaIndex that I used to build the image Q&A feature: metadata filtering. Metadata filtering is an important concept in RAG systems  because it helps you focus your query on relevant documents in a precise way. A very simple example might be a RAG system that indexes news articles and stores the associated date as metadata. You could allow a user to set a date range for their query and only include articles that match the given date range."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For my image Q&A system, I have a mapping between the paintings and their associated chapters. When I ask a question about a painting, I want to use the description of the image to find similar paragraphs, but only the paragraphs that occur in the painting‚Äôs associated chapter. What I ended up doing was filtering the entire index before making the query. The alternative would be filtering the returned nodes after making the query, but this would have the possibility of not returning any nodes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here‚Äôs what some of the metadata filtering code looks like:"}]},{"type":"element","tag":"pre","props":{"code":"# main.py\n# filter by chapters associated with the queried image\nfilters = MetadataFilters(\n    filters=[ExactMatchFilter(key=\"chapter\", value=str(req_data.chapter))]\n)\nquery_engine = get_query_engine_for_multi_modal(filters)\n\n# rag.py\n# utility function that returns the query engine use for image Q&A\n# the index is filtered to only include nodes associated with the image being queried\ndef get_query_engine_for_multi_modal(filters):\n    retriever = index.as_retriever(filters=filters)\n    synthesizer = get_response_synthesizer(response_mode=\"compact\")\n    try:\n        query_engine = QAndAQueryEngine(\n            retriever=retriever,\n            response_synthesizer=synthesizer,\n            llm=model,\n            qa_prompt=mm_q_and_a_prompt,\n        )\n    except Exception as e:\n        print(e)\n    return query_engine\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# main.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# filter by chapters associated with the queried image\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"filters "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MetadataFilters(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    filters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[ExactMatchFilter("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"chapter\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(req_data.chapter))]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"query_engine "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" get_query_engine_for_multi_modal(filters)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# rag.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# utility function that returns the query engine use for image Q&A\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# the index is filtered to only include nodes associated with the image being queried\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" get_query_engine_for_multi_modal"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"filters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    retriever "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" index.as_retriever("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"filters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"filters)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    synthesizer "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" get_response_synthesizer("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"response_mode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"compact\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    try"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        query_engine "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" QAndAQueryEngine(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            retriever"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"retriever,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            response_synthesizer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"synthesizer,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"model,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            qa_prompt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"mm_q_and_a_prompt,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    except"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" Exception"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" e:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"        print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(e)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" query_engine\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This seemed to work well for my use case, but it might not be a best practice, and it might not be efficient at a bigger scale."}]},{"type":"element","tag":"h3","props":{"id":"multi-modal-qa-examples"},"children":[{"type":"text","value":"Multi-modal Q&A examples"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some more examples of results from different types of questions from the multi-modal Q&A bot."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The response to the following query did a good job of combining information gathered from the image description and image from related passages."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Multi-modal Q&A example 2","src":"/static/redlm/qa_example_02.png"},"children":[]},{"type":"element","tag":"img","props":{"alt":"Multi-modal Q&A example 3","src":"/static/redlm/qa_example_03.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Q&A Example with Carriage","src":"/static/redlm/qa_example_carriage.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Ou Guan Example","src":"/static/redlm/qa_example_ou_guan.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is one of my favorite examples of the RedLM image Q&A bot in action. The query here in Chinese says: \"What are these two people doing\"? The answer incorporates a description of what is happening in the story (Jia Baoyu comes across Ou Guan while visiting a temple) and also describes the significance of what is happening ("},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Joss_paper","rel":["nofollow"]},"children":[{"type":"text","value":"burning paper money as a form of Chinese ancestral worship"}]},{"type":"text","value":"). But this answer is not perfect and it demonstrates some of the difficulties I had with the prompt engineering for this project. The first part makes a lot of sense:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ËøôÊÆµÂèÇËÄÉËµÑÊñôÊù•Ëá™‰∏≠ÂõΩÂè§ÂÖ∏Â∞èËØ¥„ÄäÁ∫¢Ê•ºÊ¢¶„ÄãÔºåËÆ≤Ëø∞‰∫ÜË¥æÂÆùÁéâÂú®Êé¢ËÆøÂØ∫Â∫ôÊó∂ÂèëÁé∞ËóïÂÆòÂú®Ê≤≥ËæπÁÉßÁ∫∏Èí±ÁöÑÊÉÖÊôØ„ÄÇËóïÂÆòÊòØË¥æÂ∫ú‰∏≠ÁöÑ‰∏Ä‰∏™ÊàèÂ≠êÔºåÂ•πÁöÑË°å‰∏∫ÂèØËÉΩ‰ª£Ë°®‰∫ÜÂØπÂéª‰∏ñ‰∫≤‰∫∫ÁöÑÂìÄÊÇºÊàñÁ•≠Â••„ÄÇË¥æÂÆùÁéâËØ¢ÈóÆÂ•πÁÉßÁ∫∏ÁöÑÂéüÂõ†ÔºåËóïÂÆòÈÄèÈú≤‰∫ÜËá™Â∑±ÊúâÁßÅ‰∏ãÁöÑÊÉÖÊÑüÈóÆÈ¢òÔºåÂπ∂‰∏îÊèêÂà∞‰∫ÜËä≥ÂÆòÂíåËïäÂÆòÔºåÊöóÁ§∫‰∫ÜÂ•π‰ª¨‰πãÈó¥ÂèØËÉΩÂ≠òÂú®ÊüêÁßçÁßòÂØÜÊàñÊÉÖÊÑüËÅîÁ≥ª„ÄÇ"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This reference is from the classical Chinese novel Dream of the Red Chamber, describing a scene where Jia Baoyu discovers Ou Guan burning paper money by the river during his visit to a temple. Ou Guan is a performer in the Jia household, and her actions might represent mourning or honoring deceased loved ones. Jia Baoyu asks her why she is burning the paper, and Ou Guan reveals that she has private emotional issues, mentioning Fang Guan and Rui Guan, hinting that there might be some kind of secret or emotional connection among them."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"But the second part seems to contradict the first part of the response:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Áõ∏ÊØî‰πã‰∏ãÔºå‰Ω†ÊèèËø∞ÁöÑÁîª‰ΩúÂú∫ÊôØ‰∏é„ÄäÁ∫¢Ê•ºÊ¢¶„Äã‰∏≠ÁöÑÊèèËø∞‰∏çÂêå„ÄÇÁîª‰ΩúÊèèÁªòÁöÑÊòØ‰∏§‰∏™‰∫∫Âú®Ê≤≥ËæπÁöÑÂú∫ÊôØÔºåÂ∑¶ËæπÁöÑ‰∫∫Ë∑™Âú®Âú∞‰∏äÔºå‰ºº‰πéÂú®ÁÉß‰∏úË•øÔºåÂè≥ËæπÁöÑ‰∫∫Á´ôÂú®ÊóÅËæπÔºå‰ºº‰πéÂú®ËßÇÂØüÊàñÊåáÂØº„ÄÇÊ†πÊçÆ‰Ω†Êèê‰æõÁöÑÊèèËø∞ÔºåÊó†Ê≥ïÁ°ÆÂÆöÁîª‰∏≠‰∫∫Áâ©ÁöÑÂÖ∑‰ΩìË°å‰∏∫ÔºåÂ¶ÇÂèØËÉΩÊòØÁÉßÊ∞¥„ÄÅÁÖÆÈ•≠„ÄÅÁÉßËçØÁ≠â„ÄÇÂõ†Ê≠§ÔºåËøôÂπÖÁîªÂèØËÉΩÊòØ‰∏ÄÂπÖÁé∞ÂÆû‰∏ª‰πâ‰ΩúÂìÅÔºåÊèèÁªò‰∫ÜÊó•Â∏∏ÁîüÊ¥ª‰∏≠ÁöÑ‰∏ÄÂπï„ÄÇÂÆÉÂèØËÉΩÊ≤°ÊúâÂÉè„ÄäÁ∫¢Ê•ºÊ¢¶„Äã‰∏≠ÁöÑÊÉÖËäÇÈÇ£Ê†∑Ê∑±ÂàªÁöÑÊÉÖÊÑüÊàñÁßòÂØÜËÉåÊôØÔºåËÄåÊòØÂçïÁ∫ØÂú∞Ë°®Áé∞‰∫Ü‰∫∫‰∏é‰∫∫‰πãÈó¥ÁöÑÂÖ≥Á≥ªÂíåË°å‰∏∫„ÄÇÊ≠§Â§ñÔºåÁîª‰∏≠ÁöÑËÉåÊôØ„ÄÅ‰∫∫Áâ©ÁöÑË°®ÊÉÖÂíåÂßøÊÄÅÁ≠âÁªÜËäÇ‰πü‰ºöÂØπÁîªÈù¢ÁöÑÊÑè‰πâ‰∫ßÁîüÂΩ±ÂìçÔºåÈúÄË¶ÅÁªìÂêàÂÖ∑‰ΩìÁöÑÁîª‰ΩúËøõË°åÂàÜÊûê„ÄÇ"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In contrast, the scene you described in the painting differs from the depiction in Dream of the Red Chamber. The painting shows two people by the river: the person on the left is kneeling on the ground, seemingly burning something, while the person on the right stands nearby, possibly observing or guiding. Based on your description, it‚Äôs unclear what specific action the figures are engaged in, such as possibly boiling water, cooking, or burning herbs. Therefore, this painting might be a realist work, portraying a moment from everyday life. It may not have the profound emotional or secretive background found in the storyline of Dream of the Red Chamber, instead simply highlighting the relationships and actions between individuals. Additionally, details such as the background, expressions, and postures of the figures in the painting would also influence the scene‚Äôs meaning and would require analysis based on the specific artwork."}]}]},{"type":"element","tag":"h2","props":{"id":"llamaindex-developer-experience"},"children":[{"type":"text","value":"LlamaIndex Developer Experience"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Overall, I found the LlamaIndex documentation to be very helpful. Before using LlamaIndex for this project I had used LangChain to build a RAG POC, but I didn‚Äôt get very good results. I love how the LlamaIndex documentation has a 5-line starter example for building a RAG system:"}]},{"type":"element","tag":"pre","props":{"code":"from llama_index.core import VectorStoreIndex, SimpleDirectoryReader\n\ndocuments = SimpleDirectoryReader(\"data\").load_data()\nindex = VectorStoreIndex.from_documents(documents)\nquery_engine = index.as_query_engine()\nresponse = query_engine.query(\"Some question about the data should go here\")\nprint(response)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" llama_index.core "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" VectorStoreIndex, SimpleDirectoryReader\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"documents "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" SimpleDirectoryReader("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"data\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").load_data()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"index "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" VectorStoreIndex.from_documents(documents)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"query_engine "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" index.as_query_engine()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"response "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" query_engine.query("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Some question about the data should go here\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(response)\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Source: "},{"type":"element","tag":"a","props":{"href":"https://docs.llamaindex.ai/en/stable/#getting-started","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.llamaindex.ai/en/stable/#getting-started"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I was able to expand this simple example to implement the text and image Q&A bots for RedLM fairly easily. The application I built is somewhat similar to the "},{"type":"element","tag":"a","props":{"href":"https://docs.llamaindex.ai/en/stable/understanding/putting_it_all_together/apps/fullstack_app_guide/","rel":["nofollow"]},"children":[{"type":"text","value":"Full-Stack Web App with LLamaIndex"}]},{"type":"text","value":" included in their documentation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of the early development I did on this project used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomQueryEngine"}]},{"type":"text","value":". Later I tried using "},{"type":"element","tag":"a","props":{"href":"https://docs.llamaindex.ai/en/stable/module_guides/workflow/","rel":["nofollow"]},"children":[{"type":"text","value":"LlamaIndex Workflows"}]},{"type":"text","value":" to better organize the logic in the text and image-based Q&A bots. The same workflow "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RAGWorkflow"}]},{"type":"text","value":" is used to handle requests for both the text and image Q&A bot queries. Workflows also work seamlessly with asynchronous Python frameworks like FastAPI. Here's the API endpoint for the multimodal image-Q&A bot using a LlamaIndex Workflow:"}]},{"type":"element","tag":"pre","props":{"code":"@app.post(\"/mm-q-and-a\")\nasync def mm_q_and_a_workflow(req_data: MultiModalRequest):\n    \"\"\"\n    This function handles Multimodal Q&A bot requests using a LlamaIndex workflow\n    \"\"\"\n    try:\n        # parse data from request object\n        image_b64 = req_data.image\n        prompt = req_data.prompt\n        chapter = req_data.chapter\n\n        # setup LlamaIndex Workflow and run it with data from request\n        w = RAGWorkflow(timeout=None)\n        result = await w.run(query=prompt, image_data=image_b64, chapter_number=chapter)\n\n        # return response\n        return QAQueryResponse(\n            response=result[\"response\"].message.content,\n            metadata=result[\"metadata\"],\n            image_desc=result[\"image_description\"],\n        )\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"@app.post"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"/mm-q-and-a\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" mm_q_and_a_workflow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"req_data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": MultiModalRequest):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    This function handles Multimodal Q&A bot requests using a LlamaIndex workflow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    try"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # parse data from request object\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        image_b64 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" req_data.image\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        prompt "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" req_data.prompt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        chapter "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" req_data.chapter\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # setup LlamaIndex Workflow and run it with data from request\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        w "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" RAGWorkflow("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        result "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" w.run("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"query"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"prompt, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"image_data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"image_b64, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"chapter_number"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chapter)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # return response\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" QAQueryResponse(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            response"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"result["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"response\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"].message.content,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            metadata"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"result["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"metadata\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            image_desc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"result["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"image_description\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    except"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" Exception"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" e:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        raise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" HTTPException("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"status_code"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"500"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"detail"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(e))\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using LlamaIndex Workflows also helped me add additional logic in a maintainable and standardized way. For example, I expanded the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RAGWorkflow"}]},{"type":"text","value":" logic to include LLM-based re-ranking in order to ensure retrieval of the most relevant documents for my chatbot queries. This technique increases request latency, but this is an acceptable tradeoff for an application like RedLM."}]},{"type":"element","tag":"h3","props":{"id":"llmrerank"},"children":[{"type":"text","value":"LLMRerank"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"LLM Rerank was an interesting technique to try out, and LlamaIndex provides "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LLMRerank"}]},{"type":"text","value":" to make the implementation as simple as possible. Here's my understanding of how it works:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"LLMRerank searches in the vector database for a high number of documents that are relevant to your query. This is done using cosine similarity, which essentially compares the vectors that represent the query and the documents."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Next, LLMRerank goes through a process of assigning a numerical to each document to score relevancy. It does this via a special prompt that requests relevancy score for each document in batches."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For example, I configured "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LLMRerank"}]},{"type":"text","value":" to initially fetch 4 documents from the vector database based on cosine similarity. Then in batches of 2, relevancy scores are assigned. Finally, the top 2 most relevant documents based on the LLM-give scores are used to make the RAG query."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Adding LLMRerank can require a number of additional queries based on how you configure the batch size and the number of documents you would like to compare. This will increase latency for your application and use more resources to make the extra calls."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an example LLM query that "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LLMRerank"}]},{"type":"text","value":" uses to do assign scores:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"LLMRerank Prompt","src":"/static/redlm/llmrerank_prompt.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are logs from my application showing what happens inside the workflow."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Application for text-base Q&A query:"}]},{"type":"element","tag":"pre","props":{"code":"INFO:     üí¨Request for Q&A chatbot: query='ÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü'\nINFO:     üîÄRouting Workflow to next step\nINFO:     üí¨Routing to QueryEvent\nINFO:     üßÆQuery the vector database with: ÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü\nINFO:     üñ•Ô∏èUsing in-memory embedding database\nINFO:     ‚è≥Loading index from storage directory...\nINFO:     ‚úÖFinished loading index.\nINFO:     üìêRetrieved 4 nodes.\nINFO:     üîÄDoing LLMRerank\nINFO:     ‚ÑπÔ∏è Chat Model Info:\nINFO:     üü©Using NVIDIA Cloud API for inference\nINFO:     üîòChat Model: baichuan-inc/baichuan2-13b-chat\nINFO:     üî¢Reranked nodes to 2\nINFO:     ü§ñDoing inference step\nINFO:     ‚öôÔ∏è Getting query engine..\nINFO:     üîéGetting response from custom query engine\nINFO:     üí¨Text-based Q&A query\nINFO:     üÄÑText is Chinese\nINFO:     Using nodes from workflow...\nINFO:     üîèFormatting prompt\nINFO:     Prompt is\n\nËøôÊòØÁõ∏ÂÖ≥ÁöÑÂèÇËÄÉËµÑÊñôÔºö\n---------------------\nÂÆùÁéâ‰ªéÊù•Ê≤°ÊúâÁªèÂéÜËøáËøôÊ†∑ÁöÑÁóõËã¶„ÄÇËµ∑ÂàùÔºå‰ªñËßâÂæóË¢´ÊâìÂæóÂæàÁóõÔºå‰π±Âñä‰π±Âè´„ÄÇÂêéÊù•Ôºå‰ªñÁöÑÊ∞îÂèòÂæóËôöÂº±ÔºåÂ£∞Èü≥ÂèòÂæóÂò∂ÂìëÔºåÊó†Ê≥ïËØ¥ËØù„ÄÇ‰ºóÈó®ÂÆ¢ËßÅ‰ªñË¢´ÊâìÂæóÂæàÊÉ®ÔºåËµ∂‰∏äÊù•ÊÅ≥Ê±Ç‰ªñÂÅú‰∏ãÊù•„ÄÇË¥æÊîø‰∏çËÇØÂê¨ÔºåËØ¥Ôºö‚Äú‰Ω†‰ª¨Áü•ÈÅì‰ªñÂπ≤‰∫Ü‰ªÄ‰πàÂùè‰∫ãÔºåËøòËÉΩÈ•∂‰ªñÂêóÔºüÂπ≥Êó∂ÈÉΩÊòØ‰Ω†‰ª¨Ëøô‰∫õ‰∫∫Êää‰ªñÂ∏¶Âùè‰∫ÜÔºåÁé∞Âú®Âà∞‰∫ÜËøôÊ≠•Áî∞Âú∞Ôºå‰Ω†‰ª¨ËøòÊù•Âäù‰ªñ„ÄÇÊòéÂ§©ÔºåÂ¶ÇÊûú‰ªñÊùÄÁà∂ÂºëÂêõÔºå‰Ω†‰ª¨Êâç‰∏çÂäùÂêóÔºü‚Äù\n\nÂÆùÁéâ‰ªéÊù•Ê≤°ÊúâÁªèÂéÜËøáËøôÊ†∑ÁöÑÁóõËã¶„ÄÇËµ∑ÂàùÔºå‰ªñËßâÂæóÊâìÂæóÂæàÁóõÔºå‰π±Âñä‰π±Âè´„ÄÇÂêéÊù•Ôºå‰ªñÁöÑÊ∞îÂèòÂæóËôöÂº±ÔºåÂ£∞Èü≥ÂèòÂæóÂò∂ÂìëÔºåÊó†Ê≥ïËØ¥ËØù„ÄÇ‰ºóÈó®ÂÆ¢ËßÅ‰ªñË¢´ÊâìÂæóÂæàÊÉ®ÔºåËµ∂‰∏äÊù•ÊÅ≥Ê±Ç‰ªñÂÅú‰∏ãÊù•„ÄÇË¥æÊîø‰∏çËÇØÂê¨ÔºåËØ¥Ôºö‚Äú‰Ω†‰ª¨Áü•ÈÅì‰ªñÂπ≤‰∫Ü‰ªÄ‰πàÂùè‰∫ãÔºåËøòËÉΩÈ•∂‰ªñÂêóÔºüÂπ≥Êó∂ÈÉΩÊòØ‰Ω†‰ª¨Ëøô‰∫õ‰∫∫Êää‰ªñÂ∏¶Âùè‰∫ÜÔºåÁé∞Âú®Âà∞‰∫ÜËøôÊ≠•Áî∞Âú∞Ôºå‰Ω†‰ª¨ËøòÊù•Âäù‰ªñ„ÄÇÊòéÂ§©ÔºåÂ¶ÇÊûú‰ªñÊùÄÁà∂ÂºëÂêõÔºå‰Ω†‰ª¨Êâç‰∏çÂäùÂêóÔºü‚Äù\n---------------------\nÊ†πÊçÆ‰∏äËø∞ÁöÑÂèÇËÄÉËµÑÊñôÔºåÂõûÁ≠î‰∏ãÈù¢ÁöÑÈóÆÈ¢ò\nÈóÆÈ¢òÔºöÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü\n\nResponse...\nÂÆùÁéâÂíåË¥æÊîøÊâìÊû∂„ÄÇ\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"INFO:     üí¨Request for Q&A chatbot: query='ÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü'\nINFO:     üîÄRouting Workflow to next step\nINFO:     üí¨Routing to QueryEvent\nINFO:     üßÆQuery the vector database with: ÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü\nINFO:     üñ•Ô∏èUsing in-memory embedding database\nINFO:     ‚è≥Loading index from storage directory...\nINFO:     ‚úÖFinished loading index.\nINFO:     üìêRetrieved 4 nodes.\nINFO:     üîÄDoing LLMRerank\nINFO:     ‚ÑπÔ∏è Chat Model Info:\nINFO:     üü©Using NVIDIA Cloud API for inference\nINFO:     üîòChat Model: baichuan-inc/baichuan2-13b-chat\nINFO:     üî¢Reranked nodes to 2\nINFO:     ü§ñDoing inference step\nINFO:     ‚öôÔ∏è Getting query engine..\nINFO:     üîéGetting response from custom query engine\nINFO:     üí¨Text-based Q&A query\nINFO:     üÄÑText is Chinese\nINFO:     Using nodes from workflow...\nINFO:     üîèFormatting prompt\nINFO:     Prompt is\n\nËøôÊòØÁõ∏ÂÖ≥ÁöÑÂèÇËÄÉËµÑÊñôÔºö\n---------------------\nÂÆùÁéâ‰ªéÊù•Ê≤°ÊúâÁªèÂéÜËøáËøôÊ†∑ÁöÑÁóõËã¶„ÄÇËµ∑ÂàùÔºå‰ªñËßâÂæóË¢´ÊâìÂæóÂæàÁóõÔºå‰π±Âñä‰π±Âè´„ÄÇÂêéÊù•Ôºå‰ªñÁöÑÊ∞îÂèòÂæóËôöÂº±ÔºåÂ£∞Èü≥ÂèòÂæóÂò∂ÂìëÔºåÊó†Ê≥ïËØ¥ËØù„ÄÇ‰ºóÈó®ÂÆ¢ËßÅ‰ªñË¢´ÊâìÂæóÂæàÊÉ®ÔºåËµ∂‰∏äÊù•ÊÅ≥Ê±Ç‰ªñÂÅú‰∏ãÊù•„ÄÇË¥æÊîø‰∏çËÇØÂê¨ÔºåËØ¥Ôºö‚Äú‰Ω†‰ª¨Áü•ÈÅì‰ªñÂπ≤‰∫Ü‰ªÄ‰πàÂùè‰∫ãÔºåËøòËÉΩÈ•∂‰ªñÂêóÔºüÂπ≥Êó∂ÈÉΩÊòØ‰Ω†‰ª¨Ëøô‰∫õ‰∫∫Êää‰ªñÂ∏¶Âùè‰∫ÜÔºåÁé∞Âú®Âà∞‰∫ÜËøôÊ≠•Áî∞Âú∞Ôºå‰Ω†‰ª¨ËøòÊù•Âäù‰ªñ„ÄÇÊòéÂ§©ÔºåÂ¶ÇÊûú‰ªñÊùÄÁà∂ÂºëÂêõÔºå‰Ω†‰ª¨Êâç‰∏çÂäùÂêóÔºü‚Äù\n\nÂÆùÁéâ‰ªéÊù•Ê≤°ÊúâÁªèÂéÜËøáËøôÊ†∑ÁöÑÁóõËã¶„ÄÇËµ∑ÂàùÔºå‰ªñËßâÂæóÊâìÂæóÂæàÁóõÔºå‰π±Âñä‰π±Âè´„ÄÇÂêéÊù•Ôºå‰ªñÁöÑÊ∞îÂèòÂæóËôöÂº±ÔºåÂ£∞Èü≥ÂèòÂæóÂò∂ÂìëÔºåÊó†Ê≥ïËØ¥ËØù„ÄÇ‰ºóÈó®ÂÆ¢ËßÅ‰ªñË¢´ÊâìÂæóÂæàÊÉ®ÔºåËµ∂‰∏äÊù•ÊÅ≥Ê±Ç‰ªñÂÅú‰∏ãÊù•„ÄÇË¥æÊîø‰∏çËÇØÂê¨ÔºåËØ¥Ôºö‚Äú‰Ω†‰ª¨Áü•ÈÅì‰ªñÂπ≤‰∫Ü‰ªÄ‰πàÂùè‰∫ãÔºåËøòËÉΩÈ•∂‰ªñÂêóÔºüÂπ≥Êó∂ÈÉΩÊòØ‰Ω†‰ª¨Ëøô‰∫õ‰∫∫Êää‰ªñÂ∏¶Âùè‰∫ÜÔºåÁé∞Âú®Âà∞‰∫ÜËøôÊ≠•Áî∞Âú∞Ôºå‰Ω†‰ª¨ËøòÊù•Âäù‰ªñ„ÄÇÊòéÂ§©ÔºåÂ¶ÇÊûú‰ªñÊùÄÁà∂ÂºëÂêõÔºå‰Ω†‰ª¨Êâç‰∏çÂäùÂêóÔºü‚Äù\n---------------------\nÊ†πÊçÆ‰∏äËø∞ÁöÑÂèÇËÄÉËµÑÊñôÔºåÂõûÁ≠î‰∏ãÈù¢ÁöÑÈóÆÈ¢ò\nÈóÆÈ¢òÔºöÂÆùÁéâÂíåË∞ÅÊâìÊû∂Ôºü\n\nResponse...\nÂÆùÁéâÂíåË¥æÊîøÊâìÊû∂„ÄÇ\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My question here was basically asking \"Who gets in a fight with Baoyu?\" The reply says that his father, Jiazheng, gets in a fight with Baoyu, and the documents that are used here very similar, differing by only one character. One of the documents is supposed to be and English translation, but in fact there was a failure in the translation for this paragraph and it \"translated\" the Chinese by simply repeating it. A translation of this paragraph using GPT 4o describes a tense scene between protagonist Jia Baoyu and his father Jia Zheng:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Baoyu had never endured such agony before. At first, he felt the pain intensely and cried out loudly. Later, his breath grew weak, his voice turned hoarse, and he couldn‚Äôt speak. The attendants, seeing how severely he was being beaten, rushed forward to plead for him to stop. Jia Zheng refused to listen, saying, ‚ÄúDo you know the misdeeds he‚Äôs committed, and still you want to spare him? Normally, it‚Äôs you people who lead him astray, and now that it‚Äôs come to this, you still try to persuade him? Tomorrow, if he were to commit patricide or treason, would you still not advise him?‚Äù"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another benefit of LlamaIndex workflows is the ability to create visualizations of each step, the branches between them and the overall flow of events and the functions that accept/emit them as arguments/return values. It took a little bit of getting used to the patterns used to create workflows, but the documentation for Workflows provided a good starting point that I could adapt for my application. Here's a visualization of the LlamaIndex Workflow that is used by the image and text-based Q&A bots:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RedLM RAG Workflow","src":"/static/redlm/rag_workflow.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"observability-and-tracing-with-langfuse"},"children":[{"type":"text","value":"Observability and Tracing with Langfuse"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is never too soon to add observability and tracing to a RAG application! I learned this the hard way after doing some refactoring of prompts and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CustomQueryEngine"}]},{"type":"text","value":" logic."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Langfuse is an open source LLM engineering platform to help teams collaboratively debug, analyze and iterate on their LLM Applications. With the Langfuse integration, you can seamlessly track and monitor performance, traces, and metrics of your LlamaIndex application. Detailed traces of the LlamaIndex context augmentation and the LLM querying processes are captured and can be inspected directly in the Langfuse UI."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"LlamaIndex supports lots of different observability and tracing solutions. I tried using "},{"type":"element","tag":"a","props":{"href":"https://langfuse.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Langfuse"}]},{"type":"text","value":" (YC W23) which is an open-source option that has a self hosted option."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Langfuse tracing for RedLM","src":"/static/redlm/langfuse.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Langfuse came in handy when debugging the prompts for the image-based Q&A bot. This screenshot shows a trace of a multi-modal Q&A bot query about the fire at the Gourd Temple that occurs in Chapter 1 of the book."}]},{"type":"element","tag":"h2","props":{"id":"nvidia-inference-stack-tensorrt-llm-and-buildnvidiacom"},"children":[{"type":"text","value":"NVIDIA inference stack (TensorRT-LLM and build.nvidia.com)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The LLM API for TensorRT-LLM is a very nice developer experience compared with my earlier attempts with manually building inference engines. The roadmap for TensorRT-LLM looks promising, I‚Äôm looking forward to support for an OpenAI Compatible API and more models. NVIDIA NIMs using TensorRT-LLM are an easy way to run models as OpenAI compatible API servers, but the selection of models is still pretty limited. vLLM provides a strong alternative with a wide range of support models. NVIDIA NIMs for LLMs build on vLLM libraries and the TensorRT-LLM library, so it is helpful to have an understanding of both of these libraries to stay on the bleeding edge of performant inference engines."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"trt-llm-roadmap","src":"/static/redlm/trt-llm-roadmap.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The NVIDIA API catalog is a great way to test a variety of different models, especially large models that cannot fit into consumer hardware like RTX PCs or high-end MacBooks. I got to try out the new meta/llama-3.2-90b-vision-instruct model in my project by simply changing a value in my .env file, this is a great developer experience!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"build.nvidia.com","src":"/static/redlm/build.nvidia.com.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The NVIDIA API catalog doesn‚Äôt have every model in every size, however. For example, it has the qwen/qwen2-7b-instruct model, but doesn‚Äôt have the qwen/qwen2-7b-instruct model. Also, only some of the models are labeled as ‚ÄúRun Anywhere‚Äù; a lot of the models say ‚ÄúSelf-Hosted API Coming Soon‚Äù meaning that they can‚Äôt be downloaded an run locally as a container. To get around this, I ran inferences services locally using both vLLM‚Äôs vllm/vllm-openai container and my own container running Qwen and other services."}]},{"type":"element","tag":"h2","props":{"id":"my-local-inference-stack-rtx"},"children":[{"type":"text","value":"My local inference stack (RTX)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RTX PCs","src":"/static/redlm/rtxpcs.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Two of the RTX PCs in my home network: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a3"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"a1"}]},{"type":"text","value":" was the first PC I built by myself and was the beginning of my GeForce journey. Luckily I built it with an over-provisioned PSU, so it can use a 4090 FE card! The front panel doesn't fit, however."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One limitation of the NVIDIA API catalog is the number of free credits given for a trial account. Using 1 credit per API call, I would use up the 1000 credits very quickly when running scripts like translation or the RAG evaluation. The same would be true with rate limits of the OpenAI API. That‚Äôs why running LLMs locally is still an important part of the development cycle for this type of project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This project primarily uses two models: a large language model and a vision language models. Running the Yi-1.5-9B-Chat model from "},{"type":"element","tag":"a","props":{"href":"http://01.AI","rel":["nofollow"]},"children":[{"type":"text","value":"01.AI"}]},{"type":"text","value":" takes up just about all of the GPU memory on one of my RTX 4090 PCs, so I had to run the vision model on another PC. In a previous project, I used Kubernetes to manage lots of different inference services: LLMs, ComfyUI, ChatTTS and MusicGen for making AI videos and I found it to a nice way to manage different containerized inference services."}]},{"type":"element","tag":"pre","props":{"code":"brian@a3:~$ microk8s kubectl get no -o wide\nNAME   STATUS   ROLES    AGE    VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\na1     Ready    <none>   4d4h   v1.30.5   192.168.5.182   <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\na2     Ready    <none>   11d    v1.30.5   192.168.5.96    <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\na3     Ready    <none>   11d    v1.30.5   192.168.5.173   <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"brian@a3:~$ microk8s kubectl get no -o wide\nNAME   STATUS   ROLES    AGE    VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\na1     Ready    <none>   4d4h   v1.30.5   192.168.5.182   <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\na2     Ready    <none>   11d    v1.30.5   192.168.5.96    <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\na3     Ready    <none>   11d    v1.30.5   192.168.5.173   <none>        Ubuntu 24.04.1 LTS   6.8.0-45-generic   containerd://1.6.28\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the RedLM GitHub repo I included kubernetes manifests that show how to run the LLM and VLM across two different computers. I used Kustomize as a way to replace dynamic values in the YAML files for different resources. The kubernetes set up is experimental; the LLM and VLM can more reliably be run with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"docker run"}]},{"type":"text","value":" commands."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"k8s dashboard for local inference services","src":"/static/redlm/k8s-dashboard.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I had a lot of driver issues when trying to get kubernetes to run the vLLM container for the Yi LLM. I struggled with the following error message when trying to run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vllm"}]},{"type":"text","value":" LLM service:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RuntimeError: Unexpected error from cudaGetDeviceCount(). Did you run some cuda functions before calling NumCudaDevices() that might have already set an error? Error 804: forward compatibility was attempted on non supported HW"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I tried uninstalling and reinstalling different versions of the NVIDIA drivers and CUDA but kept seeing the same message once the server would try to start up in the vLLM container logs. Rebooting my PC didn't work either. I saw a recommendation to turn off secure boot in BIOS. I didn't turn it on, but having nothing else to try I went into the BIOS settings and found that there were some keys configured in the secure boot section. After I deleted these keys and reboot, everything seemed to work normally. I'm not sure why my PC was in secure boot mode, though!"}]},{"type":"element","tag":"h2","props":{"id":"ai-models-used-in-this-project"},"children":[{"type":"text","value":"AI Models used in this project"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I selected LLMs that run efficiently on RTX PCs, are available in the NVIDIA API catalog, and offer strong bilingual support in Chinese and English, ensuring compatibility, performance, and linguistic flexibility. Here are the models that I ended up using with RedLM:"}]},{"type":"element","tag":"h3","props":{"id":"_01-aiyi-15-9b-chat-and-nvidiayi-large"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"01-ai/Yi-1.5-9B-Chat"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nvidia/yi-large"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"01-ai/Yi-1.5-9B-Chat"}]},{"type":"text","value":" for most of the LLM inference while developing RedLM on my RTX PCs. "},{"type":"element","tag":"a","props":{"href":"https://github.com/01-ai/Yi","rel":["nofollow"]},"children":[{"type":"text","value":"This model family"}]},{"type":"text","value":" performs well on both Chinese and English benchmarks, and has a variety of model sizes. I was able to try using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"01-ai/yi-large"}]},{"type":"text","value":" model from the NVIDIA API catalog when using remote cloud inference. I used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vllm/vllm-openai:latest"}]},{"type":"text","value":" container to run this locally."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are also vision models in the Yi series, such as "},{"type":"element","tag":"a","props":{"href":"https://huggingface.co/01-ai/Yi-VL-34B","rel":["nofollow"]},"children":[{"type":"text","value":"01-ai/Yi-VL-34B"}]},{"type":"text","value":", but I didn't use these models in my project."}]},{"type":"element","tag":"h3","props":{"id":"baichuan-incbaichuan2-13b-chat"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"baichuan-inc/baichuan2-13b-chat"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This model is available in the NVIDIA API catalog, and it was the main model I used when testing remote inference. It performs well in a variety of tasks and scores highly on the the Chinese Massive Multitask Language Understanding (CMMLU) benchmark."}]},{"type":"element","tag":"h3","props":{"id":"qwenqwen2-7b"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen/Qwen2-7B"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This model was used for summary and translation of the source text. It was supported by the TensorRT-LLM LLM API and I didn't have any issues building the TensorRT-LLM model with it on the EC2 instance used to do the completion inference for translations."}]},{"type":"element","tag":"h3","props":{"id":"qwenqwen2-vl-2b-instruct"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen/Qwen2-VL-2B-Instruct"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This was the vision language model (VLM) that I used locally when developing on RTX. I was impressed at how well it could describe images given the small parameter count of the model (2 billion parameters). The small size of this model made it easy to run in my RTX PC cluster."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is "},{"type":"element","tag":"a","props":{"href":"https://github.com/NVIDIA/TensorRT-LLM/issues/2183","rel":["nofollow"]},"children":[{"type":"text","value":"an open GitHub issue for TensorRT-LLM support for Qwen2-VL"}]},{"type":"text","value":" at the time of writing."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I wrote a simple FastAPI server using the Hugging Face "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"transformers"}]},{"type":"text","value":" library based on example code from this model's documentation (see "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"services/qwen2-vl"}]},{"type":"text","value":" in the RedLM GitHub repo for more details). I packaged this service into a container in order to run it in my local kubernetes cluster along with other inference services."}]},{"type":"element","tag":"h3","props":{"id":"metallama-32-90b-vision-instruct"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta/llama-3.2-90b-vision-instruct"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This model came out while I was working on the project, and I decided to use it instead of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"adept/fuyu-8b"}]},{"type":"text","value":" model that was previously one of the only vision language models in the NVIDIA API catalog. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta/llama-3.2-90b-vision-instruct"}]},{"type":"text","value":" model has strong Chinese language skills, so it was a good model to use when doing remote inference for the image Q&A bot."}]},{"type":"element","tag":"h3","props":{"id":"nvidianvlm-d-72b"},"children":[{"type":"element","tag":"a","props":{"href":"https://huggingface.co/nvidia/NVLM-D-72B","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nvidia/NVLM-D-72B"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I didn't use this model in my project, but it came out recently and looks awesome! Hopefully this model will be available on the NVIDIA API catalog soon. It is trained on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen2-72B-Instruct"}]},{"type":"text","value":" text-only model, so it likely also has very strong support for Chinese language."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Today (September 17th, 2024), we introduce NVLM 1.0, a family of frontier-class multimodal large language models (LLMs) that achieve state-of-the-art results on vision-language tasks, rivaling the leading proprietary models (e.g., GPT-4o) and open-access models (e.g., Llama 3-V 405B and InternVL 2). Remarkably, NVLM 1.0 shows improved text-only performance over its LLM backbone after multimodal training."}]}]},{"type":"element","tag":"h2","props":{"id":"the-success-of-black-myth-wukong"},"children":[{"type":"text","value":"The success of Black Myth: Wukong"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I originally got the idea to build this project after seeing the release of Black Myth: Wukong. This game is a blockbuster success from a Chinese developer that tells the story of the Monkey King‚Äôs adventure in the Journey West universe. Journey West (Ë•øÊ∏∏ËÆ∞) is another one of the ‚ÄúFour Great Works‚Äù of Chinese literature. It tells the story of the legendary pilgrimage of the monk Xuanzang (also known as Tang Sanzang) to India, accompanied by his three disciples‚ÄîSun Wukong (the Monkey King), Zhu Bajie (Pigsy), and Sha Wujing (Sandy). The group travels from China to India to retrieve sacred Buddhist scriptures, facing numerous challenges, demons, and supernatural beings along the way."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The novel blends elements of adventure, mythology, and spiritual allegory, with Sun Wukong's mischievous nature and extraordinary powers adding humor and excitement. Through their journey, the characters grow and overcome personal flaws, ultimately achieving enlightenment and spiritual success. The video game adaptation has set world records for numbers of concurrent players, and it has rewritten the narrative around what is possible with single-player, offline games in the gaming industry."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Black Myth: Wukong","src":"/static/redlm/wukong.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Three renditions of Journey West: Songok≈´ (The Monkey King) polychrome woodblock (surimono) (1824) by Yashima Gakutei (1786‚Äì1868), Black Myth: Wukong video game by Game Science (2024), Journey to the West TV series by CCTV (1982-2000)"}]},{"type":"element","tag":"h2","props":{"id":"redlm-video"},"children":[{"type":"text","value":"RedLM video"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://x.com/briancaffey/status/1855186768452321330","rel":["nofollow"]},"children":[{"type":"text","value":"Watch the RedLM video on ùïè"}]}]},{"type":"element","tag":"red-lm-video","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I created the video for this project using Blender.The Blender sequencer editor is a great non-linear video editing tool for simple video projects like this one. I used the following formula to create the project video for RedLM:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Background music: I used the AI music generation service called Suno with the prompt ‚Äúmystical strange traditional Chinese music from the Qing Dynasty‚Äù. Here‚Äôs the link to my Suno playlist called ‚ÄúQing Dynasty Music‚Äù where you can find the original song and some other good songs that I generated using this prompt. My "},{"type":"element","tag":"a","props":{"href":"https://suno.com/playlist/863ea0dd-1921-467c-8b69-16dbd126d966","rel":["nofollow"]},"children":[{"type":"text","value":"Qing Dynasty Music Playlist on Suno"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Outline: For this project, the main sections are the introduction, then explaining each part with a short demo: translation, text-based Q&A, evaluation for text-based Q&A, image-based Q&A, and finally a short outro. I wrote an outline and then ChatGPT helped with filling out the content."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Narration: I used ElevenLabs to narrate the main part of the video using a clone of my voice using the ElevenLabs Voice Lab. The Chinese voices were generated on my computer with an open-source text-to-speech model called ChatTTS."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Images and videos: I gathered images and screen captures of different parts of the project including code snippets, paintings of the book, flow diagrams and screen recordings of the application."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The video is composed of different ‚Äústrips‚Äù. The green strips represent the music and voice clips. Red strips are images and yellow strips are videos. Here is what the final cut of the video looks like in Blender‚Äôs Sequencer view:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Blender Sequence Editor","src":"/static/redlm/blender_sequence_editor.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ChatTTS is one of the most impressive open-source models I have seen for generating conversational speech with prosodic elements (pausing, laughter, etc.) It is developed by a Chinese company called 2noise. Earlier this year I made a small contribution to this project with an API example using FastAPI to show how to run a standalone API using the model. Another example in this project provides a comprehensive example application built with gradio:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"ChatTTS UI","src":"/static/redlm/chattts_ui.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I was planning on streaming the narration audio for Q&A answers using my ChatTTS API service, but I didn‚Äôt get around to doing this. Instead, I just used the Gradio application to generate the Chinese narration for Q&A and image Q&A examples included in the video."}]},{"type":"element","tag":"h3","props":{"id":"redlm-deep-dive-video-with-notebooklm"},"children":[{"type":"text","value":"RedLM Deep Dive video with NotebookLM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NotebookLM is a new application from Google that is a truly magical application of retrieval augmented generation."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NotebookLM is a research and note-taking online tool developed by Google Labs that uses artificial intelligence, specifically Google Gemini, to assist users in interacting with their documents. It can generate summaries, explanations, and answers based on content uploaded by users."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used NotebookLM to generate a \"Deep Dive\" podcast episode using only this article. I was pretty impressed with what it was able to produce, and I wanted to share it as part of this project, so I used Blender and some Python scripts to put together a simple and engaging visualization."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Deep Dive video in Blender","src":"/static/redlm/deep_dive_blender.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"openai/whisper-base"}]},{"type":"text","value":" model was used to get time stamps for the start and end of each spoken word using Automated Speech Recognition (ASR). A speaker segmentation library called "},{"type":"element","tag":"a","props":{"href":"https://github.com/pyannote/pyannote-audio","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pyannote/audio"}]}]},{"type":"text","value":" was used to perform speaker diarization. This is an interesting algorithm that can segment any number of distinct speakers in an audio recording using a series of models and a discrete-time stochastic process known as the "},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Chinese_restaurant_process","rel":["nofollow"]},"children":[{"type":"text","value":"Chinese restaurant process"}]},{"type":"text","value":". This gave a list of time intervals with a speaker ID, and I used the intervals to attribute a speaker ID to each word. Then I segmented the audio into two files using this data and used the files to generate audio waveforms using Blender's geometry nodes. Another script was used to animate each word of as it is spoken in one of two positions for each speaker."}]},{"type":"element","tag":"h2","props":{"id":"final-thoughts"},"children":[{"type":"text","value":"Final thoughts"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I‚Äôm glad to have had the opportunity to join three NVIDIA developer contests this year. I like the idea of a ‚Äúdeveloper contest‚Äù that takes place over several weeks compared to hackathons that take place over just a few days. Having more time allows you to learn about a new tool or framework at a deeper level and think about how to apply it in a creative project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"NVIDIA and LlamaIndex Contest","src":"/static/redlm/llama-contest-og.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also like how this contest is not team based. Working on this project I was able to do a lot of high-level thinking, write out features as detailed prompts, and then delegate the code writing to LLMs as if I was giving tasks to teammates."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NVIDIA‚Äôs contests are ‚Äúglobal developer contests‚Äù, but the contests so far are not open to developers in India and China. This is probably due to local rules and regulations governing how contests, prizes and taxes work. It is too bad; I would love to see what types of applications would come from participants in these countries. Also, there are also a lot of really interesting developments happening in the LLM space in both China and India!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The LLMs I used in this project were developed by leading Chinese AI companies, and they are competitive with LLMs from Western countries on LLM benchmarks despite having access to fewer GPU resources. "},{"type":"element","tag":"a","props":{"href":"https://qwenlm.github.io/blog/qwen2.5-coder-family/","rel":["nofollow"]},"children":[{"type":"text","value":"Qwen recently released a new model called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Qwen2.5-Coder-32B"}]}]},{"type":"text","value":" that has outperfomed leading models at coding tasks."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Qwen coder model","src":"/static/redlm/qwen_coder.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=UitJxc9LE60","rel":["nofollow"]},"children":[{"type":"text","value":"Kaifu Lee mentioned in a Bloomberg interview"}]},{"type":"text","value":" that the scarcity of GPU resources in China will force Chinese engineers to innovate in new ways to gain an advantage. One example of this we saw recently was when Chinese hardware hackers doubled the usable memory of the RTX 4090D (a variant of the RTX 4090 card with lower processing power to comply with US export regulations for China - the D stands for Dragon, apparently!)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RTX 4090D 48GB","src":"/static/redlm/RTX4090D.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NVIDIA recently concluded it's AI Summit in Mumbai. I was intrigued by the fact that Hindi has unique challenges that have have limited the development of Hindi LLMs compared to the development of English and Chinese LLMs. In a conversation with Jensen Huang, Indian industrial titan and CEO of Reliance Industries Mukesh Ambani spoke about his aspirations and ambition for India to overcome these challenges and develop a Hindi LLM. In a viral moment Mukesh Ambani shared that through devotion to attaining knowledge through the Hindu Goddess of knowledge Sarawati, India will be met by the Goddess of prosperity, Lakshmi."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Mukesh Ambani","src":"/static/redlm/mukesh_ambani.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NVIDIA recently released a small language model for Hindi at the AI Summit in Mumbai called  "},{"type":"element","tag":"a","props":{"href":"https://indiaai.gov.in/article/nvidia-unveils-nemotron-4-mini-hindi-4b-ai-for-india-s-500-million-hindi-speakers","rel":["nofollow"]},"children":[{"type":"text","value":"Nemotron-4-Mini-Hindi-4B"}]},{"type":"text","value":". Hindi LLMs could enable applications to explore important works of literature from India. I don't know that much about India literature, but a comparable work of literature in size and cultural significance might be the Ramayana."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"The Ramayana is an ancient Indian epic that tells the story of Prince Rama's heroic quest to rescue his wife, Sita, who has been kidnapped by the demon king Ravana. Set in a world of gods, demons, and celestial beings, the story explores themes of duty, loyalty, and the triumph of good over evil. Guided by wisdom, strength, and the support of devoted allies like Hanuman, the monkey god, and his brother Lakshmana, Rama's journey is a deeply spiritual tale, celebrated for its poetic beauty and moral depth. The Ramayana continues to inspire and captivate audiences across cultures."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Ramayana story journeyed to Thailand centuries ago, transforming into the Ramakien, a Thai adaptation that retains the essence of the original Indian epic while adding distinctive Thai cultural elements. Introduced through trade, diplomacy, and cultural exchange between India and Southeast Asia, the story became deeply woven into Thailand‚Äôs art, literature, and performance traditions. Thai kings, particularly King Rama I, adapted and documented the Ramakien, giving it a prominent place in Thai history. Lavishly detailed murals surrounding the Temple of the Emerald Buddha in Bangkok‚Äôs Grand Palace depict the Ramakien in over 178 panels that totaling over 2 kilometers in length. On a recent visit to the Grand Palace, I imagined having an application that could link the detailed murals to elements of the story in Hindi, Thai, English, Chinese or any language."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Ramakien murals surrounding Temple of the Emerald Buddha","src":"/static/redlm/ramakien.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Dream of the Red Chamber, originally titled The Story of the Stone, is one of China‚Äôs greatest literary works and a masterpiece of world literature. The novel begins with a frame story centered on a magical stone, left over from the Chinese creation myth where the goddess Nuwa mends the heavens. Longing to experience the human world, the sentient stone persuades a Buddhist monk and a Taoist priest to reincarnate it as a boy. This boy, Baoyu, is born into a wealthy and influential family‚Äîa character partly based on the author, Cao Xueqin, and his own aristocratic upbringing. Through Baoyu's life, friendships, and romantic relationships, the novel delves into his family‚Äôs gradual decline, mirroring the instability of China‚Äôs own noble families in the late Qing dynasty. The story also portrays the era's customs, social structures, and beliefs, offering readers a richly detailed exploration of life in Qing China."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It was a lot of fun to work on this project with tools from LlamaIndex and NVIDIA. With AI technology, GPUs are now essentially sentient stones, and I was able to share this important touchstone of the human experience with my computers using LlamaIndex and open source language models. In turn, RedLM shared with me delightful insights into world of Dream of the Red Chamber."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Story of a Stone","src":"/static/redlm/stone_story.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Story of a Stone Analysis","src":"/static/redlm/stone_story_analysis.png"},"children":[]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This scene describes a piece of traditional Chinese painting, depicting two elderly figures conversing amidst mountains and rivers. The painting likely visually represents the scene from the book where a monk and a Taoist are chatting at the foot of Qinggeng Peak. The two elderly figures in the painting may represent the monk and Taoist from the book, discussing their discovery of a bright and pristine stone, and planning to take it to a bustling, splendid place for a happy life. The painting‚Äôs elements‚Äîmountains, peaks, flowing water, trees, and rocks‚Äîmight echo the book's descriptions, illustrating the natural environment at the base of Qinggeng Peak where the monk and Taoist reside. The painting‚Äôs tranquil and harmonious atmosphere may also align with the storyline, expressing the monk and Taoist's care for the stone and their wish for it to live a happy life. In summary, this painted scene might be an artistic portrayal of the story between the monk, the Taoist, and the stone from the book, using visual elements and ambiance to convey the narrative and themes within the story."}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tddr","depth":2,"text":"td;dr","children":[{"id":"links","depth":3,"text":"Links"}]},{"id":"what-is-redlm","depth":2,"text":"What is RedLM?"},{"id":"notebooklm","depth":2,"text":"NotebookLM"},{"id":"how-i-built-redlm","depth":2,"text":"How I built RedLM"},{"id":"translating-dream-of-the-red-chamber-with-tensorrt-llm","depth":2,"text":"Translating Dream of the Red Chamber with TensorRT-LLM"},{"id":"building-qa-bots-with-rag-using-llamaindex","depth":2,"text":"Building Q&A bots with RAG using LlamaIndex","children":[{"id":"indexing-the-book-data","depth":3,"text":"Indexing the book data"},{"id":"milvus-vector-database","depth":3,"text":"Milvus Vector Database"},{"id":"other-examples-of-rag-with-english-questions","depth":3,"text":"Other examples of RAG with English questions"}]},{"id":"redlm-rag-evaluation","depth":2,"text":"RedLM RAG Evaluation"},{"id":"multi-modal-rag-for-visual-reasoning","depth":2,"text":"Multi-modal RAG for visual reasoning","children":[{"id":"multi-modal-qa-examples","depth":3,"text":"Multi-modal Q&A examples"}]},{"id":"llamaindex-developer-experience","depth":2,"text":"LlamaIndex Developer Experience","children":[{"id":"llmrerank","depth":3,"text":"LLMRerank"},{"id":"observability-and-tracing-with-langfuse","depth":3,"text":"Observability and Tracing with Langfuse"}]},{"id":"nvidia-inference-stack-tensorrt-llm-and-buildnvidiacom","depth":2,"text":"NVIDIA inference stack (TensorRT-LLM and build.nvidia.com)"},{"id":"my-local-inference-stack-rtx","depth":2,"text":"My local inference stack (RTX)"},{"id":"ai-models-used-in-this-project","depth":2,"text":"AI Models used in this project","children":[{"id":"_01-aiyi-15-9b-chat-and-nvidiayi-large","depth":3,"text":"01-ai/Yi-1.5-9B-Chat and nvidia/yi-large"},{"id":"baichuan-incbaichuan2-13b-chat","depth":3,"text":"baichuan-inc/baichuan2-13b-chat"},{"id":"qwenqwen2-7b","depth":3,"text":"Qwen/Qwen2-7B"},{"id":"qwenqwen2-vl-2b-instruct","depth":3,"text":"Qwen/Qwen2-VL-2B-Instruct"},{"id":"metallama-32-90b-vision-instruct","depth":3,"text":"meta/llama-3.2-90b-vision-instruct"},{"id":"nvidianvlm-d-72b","depth":3,"text":"nvidia/NVLM-D-72B"}]},{"id":"the-success-of-black-myth-wukong","depth":2,"text":"The success of Black Myth: Wukong"},{"id":"redlm-video","depth":2,"text":"RedLM video","children":[{"id":"redlm-deep-dive-video-with-notebooklm","depth":3,"text":"RedLM Deep Dive video with NotebookLM"}]},{"id":"final-thoughts","depth":2,"text":"Final thoughts"}]}},"_type":"markdown","_id":"content:2024:10:09:redlm-ai-application-for-studying-chinese-literature-redology-nvidia-llama-index-developer-contest.md","_source":"content","_file":"2024/10/09/redlm-ai-application-for-studying-chinese-literature-redology-nvidia-llama-index-developer-contest.md","_stem":"2024/10/09/redlm-ai-application-for-studying-chinese-literature-redology-nvidia-llama-index-developer-contest","_extension":"md"},{"_path":"/2025/05/27/mediation-simulator-project-for-nvidia-agent-intelligence-toolkit","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"Mediation Simulator: My submission for the NVIDIA Agent Intelligence Toolkit Hackathon","description":"Mediation Simulator is an AI application designed to help legal students and professionals build dispute resolution skills through simulated mediation sessions","date":"2024-11-09","image":"/static/mediation-simulator/mediation_simulator_title_image.png","tags":["nvidia","ai","agents","llm","nim","mediation"],"draft":false,"external":[{"link":"https://x.com/briancaffey/status/1926036369597510117","site":"x"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"building-mediation-simulator-for-the-nvidia-agent-intelligence-toolkit-hackathon"},"children":[{"type":"text","value":"Building Mediation Simulator for the NVIDIA Agent Intelligence Toolkit Hackathon!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm excited to share a project I've been building for the NVIDIA Agent Intelligence Toolkit Hackathon: "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Mediation Simulator"}]},{"type":"text","value":"! The NVIDIA Agent Intelligence Toolkit (or AgentIQ Toolkit, as it's often called) is a powerful open-source library designed for connecting, evaluating, and accelerating teams of AI agents. My goal? To see if I could leverage this toolkit to build AI agent teams capable of simulating the entire, complex process of a law school mediation competition."}]},{"type":"element","tag":"h2","props":{"id":"what-is-mediation-simulator-and-why-mediation"},"children":[{"type":"text","value":"What is Mediation Simulator? And Why Mediation?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At its core, Mediation Simulator is my attempt to model the nuanced, semi-structured, three-way conversations that happen in mediation. Law school mediation tournaments are events where students practice negotiation and dispute resolution skills. This seemed like a really interesting challenge! How do you get language models to effectively navigate such a dynamic environment?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Mediation competitions also present some unique data challenges that are perfect for AI:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Layered Information:"}]},{"type":"text","value":" There are \"common facts\" known to everyone, and \"confidential facts\" privy only to one party (and sometimes shared strategically with the mediator or the other side)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Dynamic Conversations:"}]},{"type":"text","value":" The main discussion involves all three parties (mediator and two disputants), but it also features \"caucuses\"‚Äîprivate, two-way conversations between the mediator and one party."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Creative Scenarios:"}]},{"type":"text","value":" The cases are entirely fictional, often involving made-up companies, fictional countries, and even fictional currencies! This is a deliberate choice to help students avoid real-world biases. And guess what? AI is really good at generating fake data!"}]}]},{"type":"element","tag":"h3","props":{"id":"what-i-built"},"children":[{"type":"text","value":"What I built"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Mediation Simulator consists of three main components:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Case Generation Workflow"}]},{"type":"text","value":": A CLI tool that uses LLMs to generate realistic mediation case scenarios, complete with common facts, confidential information for each party, and supporting documents. This workflow creates the foundation for all mediation simulations. The data for the case scenarios is saved in both YAML files and in my Redis database. I'll talk about why I did chose to store data in local files and on Redis later in this article."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Automated Mediation Workflow"}]},{"type":"text","value":": Another CLI tool that orchestrates a full mediation session between three AI agents (mediator, requesting party, and responding party). This workflow simulates the entire mediation process, from opening statements through negotiation to conclusion, with the AI agents engaging in realistic dialogue based on their roles and the case information. A clerk agent helps to guide the converstaion, controlling who the next speaker should be based on a summary of what has already been said by different parties."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Interactive Mediation API"}]},{"type":"text","value":": A REST API that allows a human user to participate in a mediation session by taking on the role of either the requesting or responding party. The API manages the session state and coordinates the interaction between the human participant and the AI mediator and opposing party. The conversation history for the mediation session is stored in Redis using a memory backend that I implemented with NVIDIA Agent Intelligence Toolkit."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To make the results of these workflows easily viewable, I also built two web interfaces:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Viewer Interface"}]},{"type":"text","value":" that displays the full three-party dialogue from automated mediation sessions, making it easy to review and analyze the AI agents' interactions."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Mediation Simulator Viewer","src":"/static/mediation-simulator/mediation_simulator_viewer.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Interactive Interface"}]},{"type":"text","value":" that provides a chat-like experience for human participants in the interactive mediation mode, with real-time updates and a clean, intuitive design."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Mediation Simulator Interactive","src":"/static/mediation-simulator/interactive_mediation_screenshot.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"the-genesis-from-idea-to-data"},"children":[{"type":"text","value":"The Genesis: From Idea to Data"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first major hurdle was generating the foundational case data. Here's how that unfolded:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Deep Dive Research:"}]},{"type":"text","value":" I started by brainstorming with an LLM (OpenAI's o3, in this case) to get a comprehensive understanding of law school mediation competitions. I wanted to know everything: the rules, structure, participants, judging criteria and different types of cases."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Prompt Engineering for Cases:"}]},{"type":"text","value":" With that knowledge, I tasked another LLM (GPT-4o) with generating prompts to be used for creating diverse and realistic (albeit fictional) mediation case scenarios."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Case Generation:"}]},{"type":"text","value":" Using these prompts, I generated sets of distinct cases facts and related documents."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Structuring with LangGraph:"}]},{"type":"text","value":" To manage the data for each case, I used LangGraph. I designed a state object to encapsulate all crucial elements:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Common facts."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Confidential facts for both the requesting and responding parties."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Related Documents!"}]},{"type":"text","value":" This was my own little twist. I wanted to test RAG (Retrieval Augmented Generation) integration within the agentic workflow. Could parties use tools to search for information in these documents to bolster their arguments during mediation? Ultimately I couldn't really get this to work. I'll share more on why later in this article."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Data Persistence:"}]},{"type":"text","value":" With the data structured, I saved it in accessible formats: the LangGraph state was serialized to YAML, and the case details (like facts and documents) were stored in Markdown files. I also stored same LangGraph state to Redis using a simple JSON string."}]}]},{"type":"element","tag":"h3","props":{"id":"orchestrating-the-simulation"},"children":[{"type":"text","value":"Orchestrating the Simulation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With the case data ready, the next step was to build out the mediation simulation itself:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Defining the Flow:"}]},{"type":"text","value":" I broke down the mediation process into its typical phases:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Opening Statements"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Information Gathering"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Caucuses (for each party)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Negotiation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Conclusion"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Assembling the Agent Team:"}]},{"type":"text","value":" I set up a LangGraph graph consisting of:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Mediator"}]},{"type":"text","value":" agent"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Two "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Party"}]},{"type":"text","value":" agents (Requesting and Responding parties)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Clerk"}]},{"type":"text","value":" agent, whose job is to help manage the conversation flow and transition the simulation between the different phases."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Dynamic Prompting:"}]},{"type":"text","value":" The prompts for the mediator and the parties (both when initiating a statement and when responding) change significantly based on the current phase of the mediation. Critically, these prompts also dynamically include a summary log of what has already been said, providing context."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Message Logging:"}]},{"type":"text","value":" Each time a party speaks, I store the message using my Redis backend and also store additional metadata in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"additional_kwargs"}]},{"type":"text","value":" section of each message, such as the speaker, the current phase of mediation and a summary of the message (the summary is generated by another LLM call that just summarizes the response.)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Getting to a functional mediation workflow was crucial! It allowed me to see the actual dialogue unfold and immediately highlighted areas for improvement. For instance, I realized that prompts needed to guide parties to ask one clear question at a time, directed at a specific participant, rather than posing multiple questions to several people at once. This really helps keep the simulated conversation straightforward and more realistic. I also had to instruct the LLM to use the names of the differnt parties, and I had to provide the names of the parties to the prompt. Without this instruction the LLM would give responses like this: \"Hello "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"Requesting Party Name"}]},{"type":"text","value":", thank you for sharing your opinion.\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a look at the main workflow generated from the LangGraph code:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Mediation Simulator Workflow with LangGraph","src":"/static/mediation-simulator/mediation_workflow.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"bringing-it-to-life-the-vibe-coding-web-viewer"},"children":[{"type":"text","value":"Bringing it to Life: The \"Vibe Coding\" Web Viewer!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Reading through raw Markdown files or terminal output to follow a complex, multi-turn mediation isn't ideal. I needed a better way to visualize the results! And this is where a bit of \"vibe coding\" came in incredibly handy."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I prompted an LLM to generate a single HTML page using Vue.js and Tailwind CSS. My requirements were simple: list all generated mediation cases, and when a case is selected, display the full dialogue. The amazing part? I never actually looked at the generated code in detail! I was able to make incremental improvements by simply describing changes or new features I wanted, and the LLM iterated until it was almost exactly what I envisioned. This was super easy and fast! I also made a page that lists all of the different mediation sessions with cover images that I generated with the NVIDIA Flux.1 Dev NIM:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Mediation Simulator Viewer","src":"/static/mediation-simulator/viewer.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Having this simple web interface has been a game-changer for reviewing simulations. Plus, keeping it in my project repository means I can easily host it on GitHub Pages at "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"briancaffey.github.io/mediation-simulator"}]},{"type":"text","value":" to share the results of my project. It's just so much better than staring at text files, and took just a few minutes to put together."}]},{"type":"element","tag":"h2","props":{"id":"a-deeper-look-into-the-nvidia-agent-intelligence-toolkit"},"children":[{"type":"text","value":"A deeper look into the NVIDIA Agent Intelligence Toolkit"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now, I know what some developers think about LLM frameworks like LangChain/LangGraph, LlamaIndex, and CrewAI‚Äîthere's often a bit of \"framework fatigue.\" But hear me out! The NVIDIA Agent Intelligence Toolkit brings all of these Frameworks together in a manageable way and it makes it really easy to not only write an agentic program, but it also makes it really easy to read other programs written with the framework."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The key to understanding the AIQ Toolkit is the config files. These are YAML files that neatly list out all of the dependencies of your agentic application. Let's take a look at the config file I made for mediation simulator. It's a long file, so I'll share it and then break down the important sections:"}]},{"type":"element","tag":"pre","props":{"code":"general:\n  use_uvloop: true\n  front_end:\n    _type: fastapi\n    cors:\n      allow_origins: ['*']\n      allow_methods:\n        - GET\n        - POST\n        - OPTIONS\n    endpoints:\n      - path: /case/{case_id}\n        method: GET\n        description: Gets the mediation case for the given case ID.\n        function_name: get_mediation_case\n      - path: /case/{case_id}/session/{session_id}\n        method: GET\n        description: Gets the mediation session data for the given case ID and session ID.\n        function_name: get_mediation_session\n      - path: /case/{case_id}/session/{session_id}/send\n        method: POST\n        description: Sends a message to the mediation session for the given case ID and session ID.\n        function_name: send_message_to_mediation_session\n  telemetry:\n    enabled: false\n    tracing:\n      phoenix:\n        _type: phoenix\n        endpoint: http://localhost:6006/v1/traces\n        project: default\n\nretrievers:\n  milvus_retriever:\n    _type: milvus_retriever\n    uri: \"http://localhost:19530\"\n    embedding_model: \"nv-embedqa-e5-v5\"\n    collection_name: \"aiq_case_documents\"\n    vector_field: \"embedding\"\n    search_params:\n      metric_type: \"IP\" # works best with nv-embedqa-e5-v5\n\nllms:\n  nim_llm:\n    _type: nim\n    base_url: http://192.168.5.96:1234/v1\n    model_name: qwen3-8b\n    max_tokens: 10000\n    temperature: 0.7\n  mediation_llm:\n    _type: nim\n    base_url: http://192.168.5.96:1234/v1\n    model_name: qwen3-8b\n    max_tokens: 10000\n    temperature: 0.7\n\nmemory:\n  redis_memory:\n    _type: redis_memory\n    connection_url: redis://localhost:6379/0\n\nfunctions:\n  case_document_rag:\n    _type: case_document_rag\n    retriever: milvus_retriever\n    llm_name: nim_llm\n    collection_name: \"mediation_simulator_case_documents\"\n    top_k: 5\n  case_query_agent:\n    _type: case_query_agent\n    llm_name: nim_llm\n    tool_names:\n      - case_document_rag\n    verbose: true\n    max_iterations: 5\n\n  # server route functions\n  get_mediation_case:\n    _type: server/get_mediation_case\n  get_mediation_session:\n    _type: server/get_mediation_session\n  send_message_to_mediation_session:\n    _type: mediation\n\nembedders:\n  nv-embedqa-e5-v5:\n    _type: nim\n    base_url: http://192.168.5.96:8000/v1\n    model_name: nvidia/nv-embedqa-e5-v5\n\nworkflow:\n  _type: mediation\n  llm: mediation_llm\n  data_dir: ./data\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"general"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  use_uvloop"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  front_end"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"fastapi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    cors"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      allow_origins"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'*'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      allow_methods"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"POST\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"OPTIONS\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    endpoints"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/case/{case_id}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Gets the mediation case for the given case ID.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        function_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"get_mediation_case\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/case/{case_id}/session/{session_id}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"GET\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Gets the mediation session data for the given case ID and session ID.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        function_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"get_mediation_session\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/case/{case_id}/session/{session_id}/send\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        method"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"POST\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Sends a message to the mediation session for the given case ID and session ID.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        function_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"send_message_to_mediation_session\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  telemetry"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    enabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    tracing"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      phoenix"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"phoenix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        endpoint"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://localhost:6006/v1/traces\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        project"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"default\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"retrievers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  milvus_retriever"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"milvus_retriever\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    uri"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"http://localhost:19530\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    embedding_model"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"nv-embedqa-e5-v5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    collection_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"aiq_case_documents\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    vector_field"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"embedding\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    search_params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      metric_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"IP\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # works best with nv-embedqa-e5-v5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"llms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  nim_llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    base_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://192.168.5.96:1234/v1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"qwen3-8b\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    max_tokens"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    temperature"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  mediation_llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    base_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://192.168.5.96:1234/v1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"qwen3-8b\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    max_tokens"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    temperature"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  redis_memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis_memory\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    connection_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis://localhost:6379/0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"functions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  case_document_rag"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"case_document_rag\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    retriever"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"milvus_retriever\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    llm_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim_llm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    collection_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"mediation_simulator_case_documents\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    top_k"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  case_query_agent"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"case_query_agent\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    llm_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim_llm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    tool_names"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"case_document_rag\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    verbose"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":74},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    max_iterations"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":75},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":76},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # server route functions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":77},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  get_mediation_case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":78},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"server/get_mediation_case\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":79},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  get_mediation_session"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":80},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"server/get_mediation_session\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":81},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  send_message_to_mediation_session"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":82},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mediation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":83},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":84},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"embedders"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":85},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  nv-embedqa-e5-v5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":86},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":87},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    base_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://192.168.5.96:8000/v1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":88},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nvidia/nv-embedqa-e5-v5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":89},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":90},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"workflow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":91},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mediation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":92},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mediation_llm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":93},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  data_dir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"./data\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's start at the top with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"general"}]},{"type":"text","value":" key"}]},{"type":"element","tag":"h3","props":{"id":"general"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"general"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section mainly defines the API routes for the FastAPI integration and the telemetry options I set up to view all of my programs traces. When building applications with LLMs, instrumenting for observability is key! Agent Intelligence Toolkit makes it really easy to hook up not just one observability tool, but really any number of observability tools! It all works through asynchronous calls, so it doesn't slow down the application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"LLM observability","src":"/static/mediation-simulator/Phoenix.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Defining the API routes was pretty straightforward. You define an AIQ Toolkit function that handles the route's behavior. These routes are also automatically added to the API's documentation page using OpenAPI/Swagger:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"API documentation","src":"/static/mediation-simulator/fastapi.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"retrievers"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"retrievers"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section allows you to define different vector storage databases that your application uses. I used Milvus to store embeddings of case documents. Ultimately I wasn't able to incorporate these embeddings into my application."}]},{"type":"element","tag":"h3","props":{"id":"llms"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"llms"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The LLMs section allows you to plug in to any LLM. I used a combination of LM Studio and NVIDIA NIMs to test my application. You can pretty much use any LLM that provides an OpenAI API interface. Local models have come a long way! New models like Qwen3 and Llama 3.1 have massive context windows (130k tokens!) which is a total game changer. These models are also getting a lot smarter. I was really impressed with how well these models followed my prompts. Using local models is nice because you will not be rate limited. I processed about 2 million prompt tokens and generated about 1.5 million completion tokens during the development of Mediation Simulator. As amazing as these new frontier models are now, I'm still bullish on the capabilities of (small) large language models that can run on consumer hardware like NVIDIA RTX GPUs."}]},{"type":"element","tag":"h3","props":{"id":"memory"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"memory"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Figure out how memory works in the AIQ toolkit was a big \"ah-ha!\" moment for me. It allows for persisting chat messages between generations, and also storing arbitrary data that you can use in your workflows. I decided to use Redis (Redis Stack) to build a memory backend. Here's a quick look at what that code looks like:"}]},{"type":"element","tag":"pre","props":{"code":"@register_memory(config_type=RedisMemoryConfig)\nasync def redis_memory(config: RedisMemoryConfig, builder: Builder):\n\n    class RedisMemoryEditor(MemoryEditor):\n        def __init__(self, config: RedisMemoryConfig):\n            self._conn_url = config.connection_url\n            self.redis = Redis.from_url(self._conn_url)\n\n        async def get_client(self, session_id: str) -> RedisChatMessageHistory:\n            conn = RedisChatMessageHistory(\n                session_id=session_id, redis_url=self._conn_url\n            )\n            return conn\n\n        # mediation session state management\n        async def add_messages(\n            self, items: Sequence[BaseMessage], session_id: str\n        ) -> None:\n            client = await self.get_client(session_id)\n            await client.aadd_messages(items)\n\n        async def get_messages(self, session_id: str) -> Sequence[BaseMessage]:\n            client = await self.get_client(session_id)\n            messages = await client.aget_messages()\n            return messages\n\n        # case generation state management\n        async def save_case_description(\n            self, case_description: str, case_id: str\n        ) -> None:\n            \"\"\"\n            sets the case description using the <case_id>_case_description as the redis key\n            \"\"\"\n            self.redis.set(f\"{case_id}_case_description\", case_description)\n\n        ...\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"@register_memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"config_type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"RedisMemoryConfig)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" redis_memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": RedisMemoryConfig, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"builder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Builder):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" RedisMemoryEditor"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"MemoryEditor"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" __init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": RedisMemoryConfig):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"._conn_url "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" config.connection_url\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".redis "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Redis.from_url("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"._conn_url)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" get_client"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"session_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") -> RedisChatMessageHistory:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            conn "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" RedisChatMessageHistory(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"                session_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"session_id, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"redis_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"._conn_url\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # mediation session state management\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" add_messages"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"items"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": Sequence[BaseMessage], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"session_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ) -> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            client "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".get_client(session_id)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" client.aadd_messages(items)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" get_messages"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"session_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") -> Sequence[BaseMessage]:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            client "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".get_client(session_id)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            messages "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" client.aget_messages()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" messages\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        # case generation state management\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" save_case_description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"case_description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"case_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ) -> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            sets the case description using the <case_id>_case_description as the redis key\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"            self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".redis.set("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"case_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"_case_description\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", case_description)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"        ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I found that LangChain has a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RedisChatMessageHistory"}]},{"type":"text","value":" class that made putting this backend together almost trivial. Redis Stack also ships with a web viewer which really came in handy for debugging my memory backend:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Reis Memory Backend","src":"/static/mediation-simulator/redis.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For storing other types of data, I was able to implement my own methods and store things like case data or other metadata for a mediation simulator session for things like current_speaker, number of session, current session, etc. I love Redis! The setup is also really easy, I just added a docker compose file:"}]},{"type":"element","tag":"pre","props":{"code":"services:\n  redis:\n    image: redis/redis-stack:latest\n    volumes:\n      - redis-data:/data\n    container_name: redis\n    ports:\n      - 6379:6379\n      - 8001:8001  # RedisInsight port\n\nvolumes:\n  redis-data:\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  redis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis/redis-stack:latest\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis-data:/data\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    container_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    ports"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"6379:6379\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"8001:8001"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # RedisInsight port\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  redis-data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"functions"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"functions"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Functions are the building blocks of the AIQ Toolkit. You need to register the functions in your config file, then you can use them for different things, like the function that handles an API route, or the function that handles an agentic workflow. I defined some functions for RAG to allow my agents to look up case data, but I wasn't able to fully implement this in my main mediation simualator workflow. But the setup was easy!"}]},{"type":"element","tag":"h3","props":{"id":"embedders"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"embedders"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Embedders is a section that allows you to define embedding models that you would use together with RAG (for converting text to a vector embedding). Since I needed to make a lot of embeddings for all of the documents I generated for case facts, I used a locally hosted NVIDIA NIM:"}]},{"type":"element","tag":"pre","props":{"code":"embedders:\n  nv-embedqa-e5-v5:\n    _type: nim\n    base_url: http://192.168.5.96:8000/v1\n    model_name: nvidia/nv-embedqa-e5-v5\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"embedders"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  nv-embedqa-e5-v5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    base_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://192.168.5.96:8000/v1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nvidia/nv-embedqa-e5-v5\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I would have run into rate limits if I was using the hosted version, so being able to run this locally was important for my use case."}]},{"type":"element","tag":"h3","props":{"id":"workflow"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"workflow"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The workflow is the main \"application\" part of the config file. It is the entrypoint for your application. In my case, the workflow invokes a LangGraph that does my simulation. First it loads data from my memory backend and when I'm using the interactive mode it gathers information from the request like path parameters so it knows what data fetch from memory (like the case id and session id)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My mediation workflow code is a little bit messy. I tried to keep all of my prompting logic in separate files for simplicity. The trickiest part for me was serializing data between different formats: langgraph state, YAML files and Redis memory. I'm happy to have something now that is functional, but there are a lot of improvements and further refactoring that would make the code easier to read and maintain."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That wraps up the tour of my main config file for mediation simulator! I also had another smaller config file for case generation. Here's a quick look at that:"}]},{"type":"element","tag":"pre","props":{"code":"general:\n  use_uvloop: true\n  telemetry:\n    enabled: false\n    tracing:\n      phoenix:\n        _type: phoenix\n        endpoint: http://localhost:6006/v1/traces\n        project: mediation-simulator\n\nllms:\n  nim_llm:\n    _type: nim\n    base_url: http://192.168.5.96:1234/v1\n    model_name: qwen3-8b\n    max_tokens: 10000\n    temperature: 0.7\n  # nim_llm:\n  #   _type: nim\n  #   model_name: meta/llama-3.1-70b-instruct\n  #   max_tokens: 10000\n  #   temperature: 0.7\n\nmemory:\n  redis_memory:\n    _type: redis_memory\n    connection_url: redis://localhost:6379/0\n\nworkflow:\n  _type: case_generation\n  llm_name: nim_llm\n  data_dir: ./data\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"general"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  use_uvloop"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  telemetry"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    enabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    tracing"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      phoenix"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"phoenix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        endpoint"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://localhost:6006/v1/traces\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        project"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"mediation-simulator\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"llms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  nim_llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    base_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"http://192.168.5.96:1234/v1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    model_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"qwen3-8b\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    max_tokens"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    temperature"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # nim_llm:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  #   _type: nim\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  #   model_name: meta/llama-3.1-70b-instruct\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  #   max_tokens: 10000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  #   temperature: 0.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  redis_memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis_memory\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    connection_url"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"redis://localhost:6379/0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"workflow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  _type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"case_generation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  llm_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nim_llm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  data_dir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"./data\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I added a lot of logging to my workflow in order to keep an eye on how the workflows progressed. Here's a sample of the logs from the CLI invocation of the mediation simulator program:"}]},{"type":"element","tag":"pre","props":{"code":"12:08:48 mediation.register INFO   ‚öñÔ∏è [MEDIATOR]: Mediator node called\n12:08:56 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 3\n12:08:56 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:12 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: RESPONDING_PARTY\n12:09:12 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 4, Phase turns: 4\n12:09:12 mediation.register INFO   üåö Responding party node called\n12:09:20 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 4\n12:09:20 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:23 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: REQUESTING_PARTY\n12:09:23 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 5, Phase turns: 5\n12:09:23 mediation.register INFO   üåù Requesting party node called\n12:09:31 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 5\n12:09:31 mediation.register INFO   ‚è∞ [CLERK] Max turns (5) reached for current phase\n12:09:31 mediation.register INFO   üîÑ [CLERK] Transitioning from joint discussion to negotiation\n12:09:31 mediation.register INFO   üë®‚Äç‚öñÔ∏è [CLERK] Mediator will start the new phase\n12:09:31 mediation.register INFO   ‚öñÔ∏è [MEDIATOR]: Mediator node called\n12:09:40 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: NEGOTIATION_BARGAINING, Turn: 5\n12:09:40 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:48 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: REQUESTING_PARTY\n12:09:48 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 6, Phase turns: 1\n12:09:48 mediation.register INFO   üåù Requesting party node called\n12:09:56 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: NEGOTIATION_BARGAINING, Turn: 6\n12:09:56 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:58 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: RESPONDING_PARTY\n12:09:58 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 7, Phase turns: 2\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"12:08:48 mediation.register INFO   ‚öñÔ∏è [MEDIATOR]: Mediator node called\n12:08:56 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 3\n12:08:56 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:12 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: RESPONDING_PARTY\n12:09:12 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 4, Phase turns: 4\n12:09:12 mediation.register INFO   üåö Responding party node called\n12:09:20 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 4\n12:09:20 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:23 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: REQUESTING_PARTY\n12:09:23 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 5, Phase turns: 5\n12:09:23 mediation.register INFO   üåù Requesting party node called\n12:09:31 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: JOINT_DISCUSSION_INFO_GATHERING, Turn: 5\n12:09:31 mediation.register INFO   ‚è∞ [CLERK] Max turns (5) reached for current phase\n12:09:31 mediation.register INFO   üîÑ [CLERK] Transitioning from joint discussion to negotiation\n12:09:31 mediation.register INFO   üë®‚Äç‚öñÔ∏è [CLERK] Mediator will start the new phase\n12:09:31 mediation.register INFO   ‚öñÔ∏è [MEDIATOR]: Mediator node called\n12:09:40 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: NEGOTIATION_BARGAINING, Turn: 5\n12:09:40 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:48 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: REQUESTING_PARTY\n12:09:48 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 6, Phase turns: 1\n12:09:48 mediation.register INFO   üåù Requesting party node called\n12:09:56 mediation.register INFO   üë§ [CLERK] Starting clerk node - Phase: NEGOTIATION_BARGAINING, Turn: 6\n12:09:56 mediation.register INFO   ü§î [CLERK] Using LLM to decide next speaker\n12:09:58 mediation.register INFO   üéØ [CLERK] LLM selected next speaker: RESPONDING_PARTY\n12:09:58 mediation.register INFO   üìä [CLERK] Updated counters - Turn: 7, Phase turns: 2\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Config files can be as simple or as complex as they need to be depending on your workflow."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The AgentIQ Toolkit is doing something really valuable by bringing patterns and components from these (and other) frameworks into a cohesive system. This allows for some truly interesting and powerful combinations. The examples provided are excellent and taught me a lot about new patterns for building agentic workflows. ReWOO agents, for instance, were a new concept for me, as was seeing how to effectively combine LangGraph with LlamaIndex."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"What I particularly appreciated was:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Standardized Patterns:"}]},{"type":"text","value":" AgentIQ promotes good practices for crucial aspects of AI development, like evaluations and telemetry/tracing."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"YAML Configuration:"}]},{"type":"text","value":" I really like using YAML for configuring development environments, similar to Docker Compose. It standardizes things and vastly improves readability. The way AgentIQ allows registering functions that can be included in workflows via YAML config files is a great example of this."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"A Learning Goldmine:"}]},{"type":"text","value":" Working through as many examples as possible was incredibly beneficial. Reading the code helped me grasp the patterns underpinning AgentIQ. You are pretty much guaranteed to learn something new!"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm so glad I took the plunge and got my feet wet with the AgentIQ Toolkit. It's been a fantastic learning resource."}]},{"type":"element","tag":"h3","props":{"id":"mediation-competitions-but-for-llms"},"children":[{"type":"text","value":"Mediation Competitions, But for LLMs?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One of the fun, forward-looking ideas this project sparks is the concept of \"mediation competitions, but for LLMs.\" Imagine pitting different LLMs against each other, representing the requesting and responding parties, to see how they fare in these complex negotiation scenarios!"}]},{"type":"element","tag":"h3","props":{"id":"whats-next"},"children":[{"type":"text","value":"What's Next?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This hackathon project has been an incredible learning journey. Building Mediation Simulator has not only been a fun technical challenge but has also opened my eyes to the potential of AI agents in simulating complex human interactions. I'm excited to continue refining it and exploring more possibilities with the AgentIQ Toolkit!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"what-is-mediation-simulator-and-why-mediation","depth":2,"text":"What is Mediation Simulator? And Why Mediation?","children":[{"id":"what-i-built","depth":3,"text":"What I built"},{"id":"the-genesis-from-idea-to-data","depth":3,"text":"The Genesis: From Idea to Data"},{"id":"orchestrating-the-simulation","depth":3,"text":"Orchestrating the Simulation"},{"id":"bringing-it-to-life-the-vibe-coding-web-viewer","depth":3,"text":"Bringing it to Life: The \"Vibe Coding\" Web Viewer!"}]},{"id":"a-deeper-look-into-the-nvidia-agent-intelligence-toolkit","depth":2,"text":"A deeper look into the NVIDIA Agent Intelligence Toolkit","children":[{"id":"general","depth":3,"text":"general"},{"id":"retrievers","depth":3,"text":"retrievers"},{"id":"llms","depth":3,"text":"llms"},{"id":"memory","depth":3,"text":"memory"},{"id":"functions","depth":3,"text":"functions"},{"id":"embedders","depth":3,"text":"embedders"},{"id":"workflow","depth":3,"text":"workflow"},{"id":"mediation-competitions-but-for-llms","depth":3,"text":"Mediation Competitions, But for LLMs?"},{"id":"whats-next","depth":3,"text":"What's Next?"}]}]}},"_type":"markdown","_id":"content:2025:05:27:mediation-simulator-project-for-nvidia-agent-intelligence-toolkit.md","_source":"content","_file":"2025/05/27/mediation-simulator-project-for-nvidia-agent-intelligence-toolkit.md","_stem":"2025/05/27/mediation-simulator-project-for-nvidia-agent-intelligence-toolkit","_extension":"md"},{"_path":"/2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3","_dir":"11","_draft":false,"_partial":false,"_locale":"","title":"Upgrading my GitHub Pages blog to Nuxt 3","description":"An overview of my newly upgraded GitHub Pages blog powered by Nuxt 3","date":"2024-08-11","image":"/static/nuxt/new-site.png","tags":["vue","nuxt","github","pinia"],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"blog-history"},"children":[{"type":"text","value":"Blog history"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My personal website has always lived on GitHub Pages at "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"briancaffey.github.io"}]}]},{"type":"text","value":". The first version was built with the Jekyll framework. I started learning about Vue, and Nuxt seemed like an interesting alternative to Jekyll that would allow me to practice frontend development. In September 2020 I deployed the first version of the new site using Nuxt 2 and Vue 2."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently went through the process of upgrading from Nuxt 2 to Nuxt 3. This upgrade path also included an upgrade from Vue 2 to Vue 3. My previous attempts to upgrade this site from Nuxt 2 to Nuxt 3 failed because of error messages that I couldn't work through. This time, with a big help from AI, I got through the entire upgrade and learned a lot in the process. I'm happy to share my new blog that is powered by Vue 3, Nuxt 3 and Nuxt Content v2!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will go over the features of my site, how I'm using Nuxt and Vue and some of the changes I had to make when doing the upgrade. Let's go!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"New site powered by Nuxt 3, Tailwind and Pinia","src":"/static/nuxt/nuxt3.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"features-of-my-blog"},"children":[{"type":"text","value":"Features of my blog"}]},{"type":"element","tag":"h3","props":{"id":"modules-and-plugins-overview"},"children":[{"type":"text","value":"Modules and plugins overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the modules and plugins I use on my site defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"export default defineNuxtConfig({\n  modules: [\n    '@nuxt/content',\n    '@nuxtjs/tailwindcss',\n    '@nuxtjs/i18n',\n    '@nuxtjs/color-mode',\n    '@pinia/nuxt',\n    '@nuxt/eslint',\n    '@nuxtjs/sitemap',\n    '@nuxt/image',\n    'nuxt-gtag',\n    // '@nuxtjs/feed', --> this module is not yet supported in Nuxt 3!\n  ],\n\n  plugins: [\n    '~/plugins/disqus',\n    { src: '~/plugins/apexcharts', mode: 'client' },\n    { src: '~/plugins/drift', mode: 'client' }\n  ]\n})\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" defineNuxtConfig"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  modules: [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxt/content'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/tailwindcss'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/i18n'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/color-mode'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@pinia/nuxt'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxt/eslint'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/sitemap'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxt/image'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'nuxt-gtag'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // '@nuxtjs/feed', --> this module is not yet supported in Nuxt 3!\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  plugins: [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '~/plugins/disqus'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    { src: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'~/plugins/apexcharts'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", mode: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'client'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    { src: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'~/plugins/drift'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", mode: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'client'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"})\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"nuxt-content"},"children":[{"type":"text","value":"Nuxt Content"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Nuxt Content module is a powerful git-based CMS. Articles on my site are written in Markdown files that contains frontmatter like the following:"}]},{"type":"element","tag":"pre","props":{"code":"---\ntitle: \"Upgrading my GitHub Pages blog to Nuxt 3\" # used on the page and in the <head> metadata\ndate: '2024-08-11'\ndescription: \"An overview of my newly upgraded GitHub Pages blog powered by Nuxt 3\"\nimage: /static/nuxt/nuxt3.png # cover image and og:image + twitter:image\ntags: # tags are used to categorize and navigate content\n  - vue\n  - nuxt\n  - github\n  - pinia\n\ndraft: true # drafts are publicly available but not displayed in the list of blog articles and not indexed\n\nexternal: # a list of external links where the article has been shared or republished\n  - link: https://x.com/briancaffey/status/abc123\n    site: x\n\ncomments: true # shows disqus comments\n---\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"---\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"title"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Upgrading my GitHub Pages blog to Nuxt 3\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # used on the page and in the <head> metadata\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"date"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'2024-08-11'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"An overview of my newly upgraded GitHub Pages blog powered by Nuxt 3\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/static/nuxt/nuxt3.png"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # cover image and og:image + twitter:image\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# tags are used to categorize and navigate content\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"vue\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"nuxt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"github\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"pinia\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"draft"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # drafts are publicly available but not displayed in the list of blog articles and not indexed\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"external"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# a list of external links where the article has been shared or republished\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"link"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"https://x.com/briancaffey/status/abc123\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    site"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"x\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"comments"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # shows disqus comments\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"---\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Files for articles are stored in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/content/[year]/[month]/[day]/[slug].md"}]},{"type":"text","value":", and the URLs for the articles are "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/${year}/${month}/${day}/${slug}"}]},{"type":"text","value":". This URL scheme was used in the Jekyll blog on my GitHub Pages site and kept this URL structure when I switched to Nuxt."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"contentQuery"}]},{"type":"text","value":" is used for getting content from Nuxt Content. Here's a comparison of the old and new way of fetching data from Nuxt content."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Old way using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"asyncData"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"<script>\nexport default {\n  async asyncData ({ $content, params }) {\n    const file = `${params.year}/${params.month}/${params.day}/${params.slug}`\n    const article = await $content(file).fetch()\n    return { article }\n  }\n}\n</script>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" asyncData"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ({ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"$content"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" }) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" file"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" `"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"year"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"month"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"day"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" article"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" $content"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(file)."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"fetch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { article }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the new way of fetching content using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"useAsyncData"}]},{"type":"text","value":" with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<script setup>"}]},{"type":"text","value":" syntax:"}]},{"type":"element","tag":"pre","props":{"code":"<script setup>\nconst route = useRoute();\nconst { year, month, day, slug } = route.params;\nconst page = `/${year}/${month}/${day}/${slug}`;\nconst { data: article } = await useAsyncData(route.params.slug, () =>\n  queryContent(page).findOne()\n);\n</script>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" setup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" route"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" useRoute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"year"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"month"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"day"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" route.params;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" page"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" `/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"year"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"month"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"day"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"article"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" useAsyncData"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(route.params.slug, () "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  queryContent"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(page)."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"findOne"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"route.param.slug"}]},{"type":"text","value":" as the first argument for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"useAsyncData"}]},{"type":"text","value":" is important when using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"useAsyncData"}]},{"type":"text","value":". I initially misunderstood the statement about this needing to be a unique value and I gave it a value of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"article"}]},{"type":"text","value":", but this caused a strange cache issue when I viewed different articles. The problem didn't show when I was developing with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn dev"}]},{"type":"text","value":", it only showed up when I built the site and served in locally with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn generate && yarn serve"}]},{"type":"text","value":". Since it is used in a dynamic page "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"[slug].vue"}]},{"type":"text","value":", it needs to have a unique value for every individual page for the dynamic route."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I learned about this from "},{"type":"element","tag":"a","props":{"href":"https://nuxt.com/docs/getting-started/upgrade#shared-prerender-data","rel":["nofollow"]},"children":[{"type":"text","value":"an example"}]},{"type":"text","value":" on the Nuxt 3 site about migration to Nuxt 4:"}]},{"type":"element","tag":"pre","props":{"code":"// This would be unsafe in a dynamic page (e.g. `[slug].vue`) because the route slug makes a difference\n// to the data fetched, but Nuxt can't know that because it's not reflected in the key.\nconst route = useRoute()\nconst { data } = await useAsyncData(async () => {\n  return await $fetch(`/api/my-page/${route.params.slug}`)\n})\n// Instead, you should use a key that uniquely identifies the data fetched.\nconst { data } = await useAsyncData(route.params.slug, async () => {\n  return await $fetch(`/api/my-page/${route.params.slug}`)\n})\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// This would be unsafe in a dynamic page (e.g. `[slug].vue`) because the route slug makes a difference\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// to the data fetched, but Nuxt can't know that because it's not reflected in the key.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" route"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" useRoute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" useAsyncData"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" $fetch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`/api/my-page/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"route"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"})\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// Instead, you should use a key that uniquely identifies the data fetched.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" useAsyncData"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(route.params.slug, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" $fetch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`/api/my-page/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"route"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"slug"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"})\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Wow, there is already a Nuxt 4 in the works! Hopefully the upgrade process from Nuxt 3 to 4 is easier than Nuxt 2 to 3."}]},{"type":"element","tag":"h3","props":{"id":"development-process"},"children":[{"type":"text","value":"Development process"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn clean && yarn generate && yarn serve"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I want to run the site locally I run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn dev"}]},{"type":"text","value":" which is an alias for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt dev --host"}]},{"type":"text","value":". Adding the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--host"}]},{"type":"text","value":" option is important for when you want to view the site on a mobile device. It provides a QR code that links directly to the local IP:"}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/briancaffey.github.io$ yarn dev\nyarn run v1.22.21\n$ nuxt dev --host\nNuxt 3.12.4 with Nitro 2.9.7                                                   8:04:47 AM\n                                                                               8:04:47 AM\n\n              ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà‚ñà‚ñÑ ‚ñà‚ñÄ  ‚ñà‚ñà‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà\n              ‚ñà ‚ñà   ‚ñà ‚ñà‚ñà‚ñÄ‚ñà‚ñÄ‚ñÑ ‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà   ‚ñà ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñà ‚ñà ‚ñà‚ñÄ‚ñà‚ñÄ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà\n              ‚ñà‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñà‚ñÑ‚ñÄ  ‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ‚ñà\n              ‚ñà‚ñÄ ‚ñÑ‚ñÄ ‚ñÑ‚ñÄ‚ñÑ‚ñÑ‚ñÑ‚ñÄ‚ñÄ‚ñÑ ‚ñÄ ‚ñÑ ‚ñÄ‚ñÄ  ‚ñÑ‚ñÑ‚ñÄ‚ñà\n              ‚ñà‚ñÑ‚ñÑ  ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñà ‚ñÑ  ‚ñà‚ñÄ‚ñÑ‚ñÄ ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÄ‚ñÑ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñà ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÄ ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñÑ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚ñà ‚ñÄ‚ñÑ‚ñà\n              ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÑ ‚ñà ‚ñÑ‚ñÄ ‚ñÑ ‚ñà‚ñÄ‚ñà ‚ñÄ‚ñà‚ñÑ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà‚ñÄ ‚ñÄ ‚ñÄ‚ñÑ‚ñÑ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñà\n              ‚ñà ‚ñà   ‚ñà ‚ñà‚ñÑ‚ñÑ‚ñà  ‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÄ  ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà ‚ñà‚ñà ‚ñÑ‚ñà‚ñÄ ‚ñÄ‚ñÑ ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÑ ‚ñà\n              ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ\n\n  ‚ûú Local:    http://localhost:3000/\n  ‚ûú Network:  http://192.168.5.98:3000/ [QR code]\n\n‚Ñπ Using Tailwind CSS from ~/assets/css/tailwind.css          nuxt:tailwindcss 8:04:49 AM\n  ‚ûú DevTools: press Shift + Option + D in the browser (v1.3.9)                 8:04:50 AM\n\n‚Ñπ Tailwind Viewer: http://localhost:3000/_tailwind/          nuxt:tailwindcss 8:04:50 AM\n‚úî Vite client built in 32ms                                                   8:04:51 AM\n‚úî Vite server built in 1286ms                                                 8:04:52 AM\n‚úî Nuxt Nitro server built in 1895 ms                                                            nitro 8:05:05 AM\n‚Ñπ Vite client warmed up in 0ms                                                                        8:05:05 AM\n‚Ñπ Vite server warmed up in 2186ms                                                                     8:05:07 AM\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/briancaffey.github.io$ yarn dev\nyarn run v1.22.21\n$ nuxt dev --host\nNuxt 3.12.4 with Nitro 2.9.7                                                   8:04:47 AM\n                                                                               8:04:47 AM\n\n              ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà‚ñà‚ñÑ ‚ñà‚ñÄ  ‚ñà‚ñà‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà\n              ‚ñà ‚ñà   ‚ñà ‚ñà‚ñà‚ñÄ‚ñà‚ñÄ‚ñÑ ‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà   ‚ñà ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñà ‚ñà ‚ñà‚ñÄ‚ñà‚ñÄ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà\n              ‚ñà‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñà‚ñÑ‚ñÄ  ‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ‚ñà\n              ‚ñà‚ñÄ ‚ñÑ‚ñÄ ‚ñÑ‚ñÄ‚ñÑ‚ñÑ‚ñÑ‚ñÄ‚ñÄ‚ñÑ ‚ñÄ ‚ñÑ ‚ñÄ‚ñÄ  ‚ñÑ‚ñÑ‚ñÄ‚ñà\n              ‚ñà‚ñÑ‚ñÑ  ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñà ‚ñÑ  ‚ñà‚ñÄ‚ñÑ‚ñÄ ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÄ‚ñÑ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñà ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÄ ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñÑ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚ñà ‚ñÄ‚ñÑ‚ñà\n              ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÑ ‚ñà ‚ñÑ‚ñÄ ‚ñÑ ‚ñà‚ñÄ‚ñà ‚ñÄ‚ñà‚ñÑ‚ñÄ‚ñà\n              ‚ñà ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñà‚ñÄ ‚ñÄ ‚ñÄ‚ñÑ‚ñÑ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñà\n              ‚ñà ‚ñà   ‚ñà ‚ñà‚ñÑ‚ñÑ‚ñà  ‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÄ  ‚ñà\n              ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñà ‚ñà‚ñà ‚ñÑ‚ñà‚ñÄ ‚ñÄ‚ñÑ ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÑ ‚ñà\n              ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ\n\n  ‚ûú Local:    http://localhost:3000/\n  ‚ûú Network:  http://192.168.5.98:3000/ [QR code]\n\n‚Ñπ Using Tailwind CSS from ~/assets/css/tailwind.css          nuxt:tailwindcss 8:04:49 AM\n  ‚ûú DevTools: press Shift + Option + D in the browser (v1.3.9)                 8:04:50 AM\n\n‚Ñπ Tailwind Viewer: http://localhost:3000/_tailwind/          nuxt:tailwindcss 8:04:50 AM\n‚úî Vite client built in 32ms                                                   8:04:51 AM\n‚úî Vite server built in 1286ms                                                 8:04:52 AM\n‚úî Nuxt Nitro server built in 1895 ms                                                            nitro 8:05:05 AM\n‚Ñπ Vite client warmed up in 0ms                                                                        8:05:05 AM\n‚Ñπ Vite server warmed up in 2186ms                                                                     8:05:07 AM\n"}]}]},{"type":"element","tag":"h3","props":{"id":"nuxt-dev-tools"},"children":[{"type":"text","value":"Nuxt Dev Tools"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://devtools.nuxt.com/guide/getting-started","rel":["nofollow"]},"children":[{"type":"text","value":"Nuxt DevTools"}]},{"type":"text","value":" is amazing! This is one of the best benefits of upgrading to Nuxt 3 for me."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/nuxt/nuxt_dev_tools.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is available in Nuxt 3.9.0 or higher."}]},{"type":"element","tag":"h3","props":{"id":"vue-3-and-script-setup"},"children":[{"type":"text","value":"Vue 3 and Script setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vue 3 allows for a much more streamlined single file component syntax with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<script setup>"}]},{"type":"text","value":". For most of the component I did some minimal cleanup and then asked ChatGPT to convert the component script tag to use the new script setup syntax, and that worked very well!"}]},{"type":"element","tag":"h3","props":{"id":"cicd"},"children":[{"type":"text","value":"CI/CD"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My blog is update using the following GitHub Action:"}]},{"type":"element","tag":"pre","props":{"code":"name: github pages\n\non:\n  push:\n    branches:\n      - master\n  pull_request:\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Setup Node\n        uses: actions/setup-node@v4\n        with:\n          node-version: \"20\"\n\n      - name: Cache dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.npm\n          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}\n          restore-keys: |\n            ${{ runner.os }}-node-\n\n      - run: yarn\n      - run: yarn build\n      - run: yarn lint\n      - run: yarn generate\n\n      - name: deploy\n        uses: peaceiris/actions-gh-pages@v4\n        with:\n          github_token: ${{ secrets.GITHUB_TOKEN }}\n          publish_dir: dist\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"github pages\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"on"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    branches"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"master\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  pull_request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"jobs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    runs-on"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"ubuntu-latest\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    steps"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"uses"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"actions/checkout@v4\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Setup Node\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        uses"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"actions/setup-node@v4\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          node-version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"20\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Cache dependencies\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        uses"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"actions/cache@v4\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"~/.npm\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          restore-keys"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            ${{ runner.os }}-node-\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"yarn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"yarn build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"yarn lint\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"yarn generate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"deploy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        uses"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"peaceiris/actions-gh-pages@v4\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          github_token"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"${{ secrets.GITHUB_TOKEN }}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"          publish_dir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"dist\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I upgraded to Nuxt 3, I needed to add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn build"}]},{"type":"text","value":" ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt build"}]},{"type":"text","value":") step in order to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn lint"}]},{"type":"text","value":" ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"eslint ."}]},{"type":"text","value":")."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It takes about 3 minutes to build the site, most of that time is for building the HTML files for each route:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"GitHub Action for deploying briancaffey.github.io","src":"/static/nuxt/gha.png"},"children":[]}]},{"type":"element","tag":"pre","props":{"code":"[log] [nitro]   ‚îú‚îÄ /sitemap.xml (26ms)\n[info] [nitro] Prerendered 525 routes in 67.595 seconds\n[success] [nitro] Generated public .output/public\n[success] [nitro] You can preview this build using `npx serve .output/public`\n[success] You can now deploy `.output/public` to any static hosting!\nDone in 81.09s.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[log] [nitro]   ‚îú‚îÄ /sitemap.xml (26ms)\n[info] [nitro] Prerendered 525 routes in 67.595 seconds\n[success] [nitro] Generated public .output/public\n[success] [nitro] You can preview this build using `npx serve .output/public`\n[success] You can now deploy `.output/public` to any static hosting!\nDone in 81.09s.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Shout out to GitHub user "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"peaceiris"}]},{"type":"text","value":" for maintaining the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"peaceiris/actions-gh-pages@v4"}]},{"type":"text","value":" GitHub Action. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dist"}]},{"type":"text","value":" is a symbolic link that links to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".output/public"}]},{"type":"text","value":" where the static build files from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn generate"}]},{"type":"text","value":" are stored."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"GitHub Action for deploying briancaffey.github.io","src":"/static/nuxt/gha_deploy.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"data-heavy-articles"},"children":[{"type":"text","value":"Data-heavy articles"}]},{"type":"element","tag":"h3","props":{"id":"migrating-from-vuex-to-pinia"},"children":[{"type":"text","value":"Migrating from Vuex to Pinia"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of my blog articles only include text and images. In some articles I include dynamic content through iframes to other projects on my GitHub that are deployed on subdomains of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"briancaffey.github.io"}]},{"type":"text","value":". Another way to add dynamic content it to write Vue components and then embed those directly in the Nuxt Content Markdown files. I wrote "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2021/01/16/i-scraped-analyzed-and-generated-yc-companies-founders-and-work-at-a-startup-job-postings","rel":["nofollow"]},"children":[{"type":"text","value":"an article about data from YC's Work at a Startup jobs page"}]},{"type":"text","value":" and made components that get data from a data store and then render that data using Apex Charts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Previoulsy I had used Vuex to do this, but I switched to using Pinia which is Vue's new module for managing state. I use LLMs to convert the store module from Vuex to Pinia and also used LLMs to update the components that use the store, and it worked!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Setting up the plugin for Apex Charts looks like this:"}]},{"type":"element","tag":"pre","props":{"code":"import VueApexCharts from 'vue3-apexcharts'\n\nexport default defineNuxtPlugin(nuxtApp => {\n    nuxtApp.vueApp.use(VueApexCharts)\n});\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" VueApexCharts "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'vue3-apexcharts'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" defineNuxtPlugin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"nuxtApp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    nuxtApp.vueApp."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"use"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(VueApexCharts)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"});\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"lessons-learned"},"children":[{"type":"text","value":"Lessons learned"}]},{"type":"element","tag":"h3","props":{"id":"embedding-tweets-in-nuxt-content"},"children":[{"type":"text","value":"Embedding Tweets in Nuxt Content"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The upgrade from Nuxt 2 to Nuxt 3 broke some twitter embeds that were working in Nuxt 2 (directly copy and pasting the embed code into a Nuxt Content Markdown file). Here's how I got it working for now:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"create a new global component in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"components/content"}]},{"type":"text","value":" ("},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/briancaffey.github.io/blob/master/components/content/aoi/AgentsOfInferenceTweet.vue","rel":["nofollow"]},"children":[{"type":"text","value":"example"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"convert the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<script>"}]},{"type":"text","value":" tag in the embed code to a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<component>"}]},{"type":"text","value":" tag and include the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":":is=\"'script'\""}]},{"type":"text","value":" (ES Lint will throw an error if you do not have the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v-bind:is"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"include the component in your Markdown like this: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<MyComponent></MyComponent>"}]},{"type":"text","value":" ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<MyComponent />"}]},{"type":"text","value":" will not work, for me it would not render and also cut off the rest of the content from the page)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The same process works for video embeds from ùïè"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update","rel":["nofollow"]},"children":[{"type":"text","value":"This post on my GitHub Pages blog"}]},{"type":"text","value":" uses an embedded tweet."}]}]},{"type":"element","tag":"h3","props":{"id":"internationalization-i18n"},"children":[{"type":"text","value":"Internationalization (i18n)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I added i18n to my site mostly to learn how it works. Nuxt i18n has different strategies for how different locales are displayed. Previously I used a URL prefix for all locales other than the default locale (English). Switching to other locales would switch from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/contact-me"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/zh/contact-me"}]},{"type":"text","value":" for example."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this upgrade I switched to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"no_prefix"}]},{"type":"text","value":" option which instead stores the locale in a cookie. This makes generating my site easier because it does not require generating a locale for each blog tag or blog article."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I currently do not have i18n for the articles on my blog, but I'm hoping to add this in a future update once there is better support for it in Nuxt Content."}]},{"type":"element","tag":"h2","props":{"id":"lighthouse"},"children":[{"type":"text","value":"Lighthouse"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I made a number of improvements to the site to get an almost-perfect Lighthouse score for the home page of my site:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Lighthouse results for briancaffey.github.io","src":"/static/nuxt/lighthouse.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@nuxt/image"}]},{"type":"text","value":" for optimized image formats ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"webp"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"adjust colors for improved contrast (measured using "},{"type":"element","tag":"a","props":{"href":"https://webaim.org/resources/contrastchecker/","rel":["nofollow"]},"children":[{"type":"text","value":"webaim.org"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fixes for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"head"}]},{"type":"text","value":" metadata"}]}]},{"type":"element","tag":"h2","props":{"id":"interactivity"},"children":[{"type":"text","value":"Interactivity"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I use a few plugins for interactity on my site. These plugins needed some slight modifications and upgrades"}]},{"type":"element","tag":"h3","props":{"id":"drift"},"children":[{"type":"text","value":"Drift"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Drift is a chat box that lets users send me message. When someone sends me a message I can see what page of my website they are on and I can also see their location (based on their IP address). I get messages in the Drift app on my phone. In total I have had 320 conversations since I initially added the plugin a few years ago."}]},{"type":"element","tag":"h3","props":{"id":"mailchimp-email-list"},"children":[{"type":"text","value":"MailChimp email list"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have an email list of 55 people that I manage through MailChimp. Occasionally I send out emails about new articles on my blog and other updates. It is a fun way to practice email marketing! It uses a global component in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"content/components"}]},{"type":"text","value":" directory so I can use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<Subscribe>"}]},{"type":"text","value":" component here in the Markdown file where I am writing this article:"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"subscribe","props":{},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also use this component in the footer of the site. Feel free to sign up to get updates about what I'm doing on this site!"}]},{"type":"element","tag":"h3","props":{"id":"formsubmit"},"children":[{"type":"text","value":"FormSubmit"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"FormSubmit is a free service that lets people send me a message through a form on my site's "},{"type":"element","tag":"a","props":{"href":"/contact"},"children":[{"type":"text","value":"Contact"}]},{"type":"text","value":" page."}]},{"type":"element","tag":"h3","props":{"id":"disqus"},"children":[{"type":"text","value":"Disqus"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Disqus is a comments plugin that I use on my blog articles. I don't get a lot of comments, but comments are always welcome!"}]},{"type":"element","tag":"h2","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"h3","props":{"id":"feedxml"},"children":[{"type":"text","value":"feed.xml"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I need to find a way to automate "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feed.xml"}]},{"type":"text","value":" generation. "},{"type":"element","tag":"a","props":{"href":"https://nuxt.com/modules/feed","rel":["nofollow"]},"children":[{"type":"text","value":"The feed module"}]},{"type":"text","value":" is not yet compatible with Nuxt 3. I do use the RSS feed with DEV.to which allows me to set up canonical links back to my GitHub Pages site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For now I am going to copy the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feed.xml"}]},{"type":"text","value":" to a file in the public directory and update it manually. Here's the entry I'll make for this article:"}]},{"type":"element","tag":"pre","props":{"code":"        <item>\n            <title>\n                <![CDATA[ Upgrading my GitHub Pages blog to Nuxt 3 ]]>\n            </title>\n            <link>\n                https://briancaffey.github.io/2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3\n            </link>\n            <guid>\n                https://briancaffey.github.io/2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3\n            </guid>\n            <description>\n                <![CDATA[ An overview of my newly upgraded GitHub Pages blog powered by Nuxt 3 ]]>\n            </description>\n        </item>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"title"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                <![CDATA["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" Upgrading my GitHub Pages blog to Nuxt 3 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]]>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"title"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"link"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                https://briancaffey.github.io/2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"link"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"guid"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                https://briancaffey.github.io/2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"guid"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                <![CDATA["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" An overview of my newly upgraded GitHub Pages blog powered by Nuxt 3 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]]>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"console-errors"},"children":[{"type":"text","value":"Console errors"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have tried to clean up as many of the errors as I could, but there are stil some that I see in the dev console. Here is one of the issues that puzzles me:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Hydration completed but contains mismatches."}]},{"type":"text","value":": I only see this error on the production build; I don't see it when running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn dev"}]},{"type":"text","value":". As I understand, this error message means that the HTML that was built during prerendering is not the same as the HTML on the site once the Javascript has all been loaded."}]},{"type":"element","tag":"h3","props":{"id":"build-errors"},"children":[{"type":"text","value":"Build errors"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently got some errors in my CI/CD pipeline related to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"string-width"}]},{"type":"text","value":" package, and I was able to add the following to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":" to fix the build pipeline:"}]},{"type":"element","tag":"pre","props":{"code":"  \"resolutions\": {\n      \"string-width\": \"4.2.3\"\n  }\n","language":"javascript","meta":"","className":"language-javascript shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  \"resolutions\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      \"string-width\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"4.2.3\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm still not exactly sure what this is about."}]},{"type":"element","tag":"h3","props":{"id":"refactoring"},"children":[{"type":"text","value":"Refactoring"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I like using TailwindCSS, and I was able to use it to build a responsive design for my site. After upgrading to Nuxt 3, I feel like most of the technical debt is now in the design. I also don't change the design that often, but I think I could do a lot to refactor the use of Tailwind, such as using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@apply"}]},{"type":"text","value":" in CSS to make classes more DRY across the different components I use to build this site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Please let me know if you have any questions, suggestions or tips for using Nuxt and Vue to build static prerendered sites. Thanks for reading!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"blog-history","depth":2,"text":"Blog history"},{"id":"features-of-my-blog","depth":2,"text":"Features of my blog","children":[{"id":"modules-and-plugins-overview","depth":3,"text":"Modules and plugins overview"},{"id":"nuxt-content","depth":3,"text":"Nuxt Content"},{"id":"development-process","depth":3,"text":"Development process"},{"id":"nuxt-dev-tools","depth":3,"text":"Nuxt Dev Tools"},{"id":"vue-3-and-script-setup","depth":3,"text":"Vue 3 and Script setup"},{"id":"cicd","depth":3,"text":"CI/CD"}]},{"id":"data-heavy-articles","depth":2,"text":"Data-heavy articles","children":[{"id":"migrating-from-vuex-to-pinia","depth":3,"text":"Migrating from Vuex to Pinia"}]},{"id":"lessons-learned","depth":2,"text":"Lessons learned","children":[{"id":"embedding-tweets-in-nuxt-content","depth":3,"text":"Embedding Tweets in Nuxt Content"},{"id":"internationalization-i18n","depth":3,"text":"Internationalization (i18n)"}]},{"id":"lighthouse","depth":2,"text":"Lighthouse"},{"id":"interactivity","depth":2,"text":"Interactivity","children":[{"id":"drift","depth":3,"text":"Drift"},{"id":"mailchimp-email-list","depth":3,"text":"MailChimp email list"},{"id":"formsubmit","depth":3,"text":"FormSubmit"},{"id":"disqus","depth":3,"text":"Disqus"}]},{"id":"todo","depth":2,"text":"TODO","children":[{"id":"feedxml","depth":3,"text":"feed.xml"},{"id":"console-errors","depth":3,"text":"Console errors"},{"id":"build-errors","depth":3,"text":"Build errors"},{"id":"refactoring","depth":3,"text":"Refactoring"}]}]}},"_type":"markdown","_id":"content:2024:08:11:upgrading-my-github-pages-blog-to-nuxt-3.md","_source":"content","_file":"2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3.md","_stem":"2024/08/11/upgrading-my-github-pages-blog-to-nuxt-3","_extension":"md"},{"_path":"/2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update","_dir":"24","_draft":false,"_partial":false,"_locale":"","title":"Agents of Inference: Speed of Light -- Accelerating my Generative AI Agents project with NVIDIA NIMs, TensorRT and TensorRT-LLM","description":"This article is a brief discusion on recent updates to my project for the Generative AI Agents Developer Contest by NVIDIA and LangChain","date":"2024-06-24","image":"/static/aoi/aoi_title.png","tags":["nvidia","langchain","agents","rtx","gpu","tensorrt","tensorrt-llm","ai","llm","llama","007","stable-diffusion","stable-video-diffusion","comfyui"],"draft":false,"external":[{"link":"https://x.com/briancaffey/status/1802754703207583886","site":"x"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\"Agents of Inference: Speed of Light\" is an update to my original entry for the Generative AI Agents Developer Contest by NVIDIA and LangChain. This update focuses on how I accelerated local text, image and video generation using TensorRT, TensorRT-LLM and NVIDIA NIMs. You can read the original article about \"Agents of Inference\" "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2024/06/17/agents-of-inference-nvidia-and-langchain-generative-ai-agent-developer-contest","rel":["nofollow"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's my original project submission post on ùïè that introduces the idea of generating short 007-style films using agents, LLMs and stable diffusion:"}]},{"type":"element","tag":"agents-of-inference-tweet","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a link to the "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/agents-of-inference","rel":["nofollow"]},"children":[{"type":"text","value":"Agents of Inference code repository on GitHub"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"nvidia-nim-inference-microservices"},"children":[{"type":"text","value":"NVIDIA NIM inference microservices"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I thought NVIDIA NIMs was one of the most exciting announcements from GTC 2024. I'm a big fan of using docker containers everywhere, and the idea of standardizing NVIDIA tools and dependencies seemed to make a lot of sense. I had previously struggled to get TensorRT-LLM installed on Windows using example repos provided by NVIDIA."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A few weeks ago NVIDIA announced that NVIDIA NIMs can be downloaded and run anywhere. I was able to download this NIM for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta/llama3-8b-instruct"}]},{"type":"text","value":" model:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"llama3 nim","src":"/static/aoi/meta-llama3-nim.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the logs for my NVIDIA NIM "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Meta/Llama-3-8B-Instruct"}]},{"type":"text","value":" running in docker container on Windows Subsystem for Linux on my NVIDIA GeForce RTX 4090 GPU-powered PC. Notice that it generates over 50 tokens per second!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"trt llama3 local","src":"/static/aoi/trt-llama3.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"token factory","src":"/static/aoi/token-factory.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The one main hurdle I faced when running the NIM local was an error about no runnable profiles being available:"}]},{"type":"element","tag":"pre","props":{"code":"ERROR 06-23 15:41:21.19 utils.py:21] Could not find a profile that is currently runnable with the detected hardware. Please check the system information below and make sure you have enough free GPUs.\nSYSTEM INFO\n- Free GPUs: <None>\n- Non-free GPUs:\n  -  [2684:10de] (0) NVIDIA GeForce RTX 4090 [current utilization: 7%]\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ERROR 06-23 15:41:21.19 utils.py:21] Could not find a profile that is currently runnable with the detected hardware. Please check the system information below and make sure you have enough free GPUs.\nSYSTEM INFO\n- Free GPUs: <None>\n- Non-free GPUs:\n  -  [2684:10de] (0) NVIDIA GeForce RTX 4090 [current utilization: 7%]\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This seemed odd, and I found another user with the same issue on the NVIDIA Developer Forum. I was able to get around this by going into the EUFI/BIOS of my PC and switch to integrated graphics:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"bios","src":"/static/aoi/bios.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It was great to be able to run \"Agents of Inference\" using NVIDIA NIM because it is just as simple as running a docker container:"}]},{"type":"element","tag":"pre","props":{"code":"export CONTAINER_NAME=llama3-8b-instruct\nexport IMG_NAME=\"nvcr.io/nim/meta/${CONTAINER_NAME}:1.0.0\"\nexport LOCAL_NIM_CACHE=~/.cache/nim\nmkdir -p \"$LOCAL_NIM_CACHE\"\ndocker run -it --rm --name=$CONTAINER_NAME \\\n  --runtime=nvidia \\\n  --gpus all \\\n  --shm-size=16GB \\\n  -e NGC_API_KEY \\\n  -v \"$LOCAL_NIM_CACHE:/opt/nim/.cache\" \\\n  -u $(id -u) \\\n  -p 8000:8000 \\\n  $IMG_NAME\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"export CONTAINER_NAME=llama3-8b-instruct\nexport IMG_NAME=\"nvcr.io/nim/meta/${CONTAINER_NAME}:1.0.0\"\nexport LOCAL_NIM_CACHE=~/.cache/nim\nmkdir -p \"$LOCAL_NIM_CACHE\"\ndocker run -it --rm --name=$CONTAINER_NAME \\\n  --runtime=nvidia \\\n  --gpus all \\\n  --shm-size=16GB \\\n  -e NGC_API_KEY \\\n  -v \"$LOCAL_NIM_CACHE:/opt/nim/.cache\" \\\n  -u $(id -u) \\\n  -p 8000:8000 \\\n  $IMG_NAME\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before getting this to work, I was able to get a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/chat/completions"}]},{"type":"text","value":" endpoint working with the Llama3 model on my fork of the "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/trt-llm-as-openai-windows/commit/edaa15fd026fe95e645e3d4ae9718dc3ecc3bb65","rel":["nofollow"]},"children":[{"type":"text","value":"trt-llm-as-openai-windows"}]},{"type":"text","value":". I borrowed code for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TrtLlmAPI"}]},{"type":"text","value":" from the "},{"type":"element","tag":"a","props":{"href":"https://github.com/NVIDIA/ChatRTX","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NVIDIA/ChatRTX"}]}]},{"type":"text","value":" repo and a function from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"llama-index"}]},{"type":"text","value":" called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"messages_to_prompt_v3_instruct"}]},{"type":"text","value":" which encodes messages with special tokens for chat. This was an interesting exercise and it taught me a lot about how LLMs do chat. I would like to continue working on this fork and see how to implement streaming endpoints for the Llama 3 model."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is how Llama 3 does the instruct prompting:"}]},{"type":"element","tag":"pre","props":{"code":"<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nYou are a helpful AI assistant for travel tips and recommendations<|eot_id|><|start_header_id|>user<|end_header_id|>\n\nWhat can you help me with?<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nYou are a helpful AI assistant for travel tips and recommendations<|eot_id|><|start_header_id|>user<|end_header_id|>\n\nWhat can you help me with?<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Compare this with how it was done with Llama2 chat:"}]},{"type":"element","tag":"pre","props":{"code":"<s>[INST] <<SYS>>\n{{ system_prompt }}\n<</SYS>>\n\n{{ user_message_1 }} [/INST] {{ model_answer_1 }} </s>\n<s>[INST] {{ user_message_2 }} [/INST]\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<s>[INST] <<SYS>>\n{{ system_prompt }}\n<</SYS>>\n\n{{ user_message_1 }} [/INST] {{ model_answer_1 }} </s>\n<s>[INST] {{ user_message_2 }} [/INST]\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can read more about the difference between Llama 2 and 3 on the "},{"type":"element","tag":"a","props":{"href":"https://llama.meta.com/docs/model-cards-and-prompt-formats","rel":["nofollow"]},"children":[{"type":"text","value":"Model Card & Prompt formats"}]},{"type":"text","value":" page on Meta's Llama website."}]},{"type":"element","tag":"h2","props":{"id":"langsmith"},"children":[{"type":"text","value":"LangSmith"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently started using LangSmith. It is an awesome product and it ties in really well to doing prototype work like in my project \"Agents of Inference\". I wish I had started using it earlier in my development cycle! All you need to do is add an API key to your environment and your application automatically starts tracing LLM calls. It also works well with LangGraph and allows you to trace the execution path of your graph. Also it is good to be aware that there are other products similar to LangSmith like LangFuse. I also saw a really neat demo from Datadog at GTC showing an alpha version of their LLM tracing and observability product."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"langsmith screenshot","src":"/static/aoi/langsmith.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"LangSmith can also be helpful when the wrong JSON shape is parsed. I had a lot of difficulty with this in my project. When I used the Q4_K_M gguf quantized "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Meta-Llama-3 8B-Instruct"}]},{"type":"text","value":" model I had no issues with output parsing. Switching to the TensorRT-LLM model provided by the NIM resulted in some parsing errors. The application would report that JSON could not be parsed because the result contained text like: \"Here is the JSON that you requested\". I was able to get around this by changing the prompt template from:"}]},{"type":"element","tag":"pre","props":{"code":"Answer the user query.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Answer the user query.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"to"}]},{"type":"element","tag":"pre","props":{"code":"Don't include ANYTHING except for valid JSON in your response. Answer the user query.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Don't include ANYTHING except for valid JSON in your response. Answer the user query.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This was the most frustrating part of development, and I'm still getting occasional errors that I just skip over. I'm also probably have not exhausted all of the tools that LangChain provides to avoid these types of errors. Don't assume that output parsing that works with one model will work with another! This is another good reason to use something like LangSmith when developing LLM-based applications."}]},{"type":"element","tag":"h2","props":{"id":"comfyui-tensorrt"},"children":[{"type":"text","value":"ComfyUI TensorRT"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My goal with \"Agents of Inference\" was to be able to test out how small upstream prompt changes can impact the quality and consistency of a series of generated images and videos. Iteration speed is very important! I was able to significantly speed up image and video generation by using the "},{"type":"element","tag":"a","props":{"href":"https://github.com/comfyanonymous/ComfyUI_TensorRT","rel":["nofollow"]},"children":[{"type":"text","value":"ComfyUI TensorRT custom nodes"}]},{"type":"text","value":". These nodes allow you to build engines with specifications for parameters that can be either static or dynamic. I had better luck with building dynamic engines. I was able to build and use engines for Stable Diffusion SDXL and Stable Video Diffusion XT."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Building a TensorRT engine for ComfyUI can be done using the following workflow:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"trt comfyUI build process","src":"/static/aoi/comfyui-trt-svd-xt.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The engines can then be used in custom workflows like the following:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"trt comfyui workflow","src":"/static/aoi/svd-workflow-trt.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once these workflows are configured and are working as expected, you can export them in API format (JSON) and use them to make API calls to the ComfyUI backend. The agents for stable diffusion and stable video diffusion made API calls in this way and it worked pretty well."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"comfy its","src":"/static/aoi/comfy-its.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using 50 iterations, I was able to generate 1024x576 images in 3 seconds or about 19 iterations per second (it/s). Videos"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ComfyUI is still early in development and it refers to itself as \"alpha software\" even though it has a large adoption by a very active community already. I'm excited to see what is next from the developers of ComfyUI."}]},{"type":"element","tag":"h2","props":{"id":"speed-of-light"},"children":[{"type":"text","value":"Speed of Light"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\"Speed of Light\" is a term that I learned from a stable diffusion talk at GTC."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"SOL analysis reveals how your code performs, and device utilization compared to relevant maximums."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adding TensorRT and TensorRT-LLM to inference services on my RTX PC helped increase the throughput of text, image and video generation for my \"Agents of Inference\" project. I'm looking forward to learning more about profiling and optimization techniques for both LLMs and Stable Diffusion workloads."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks again to NVIDIA and LangChain for organizing this contest! It was a lot of fun to learn about builing agents with LangChain and LangGraph and the latest developments from NVIDIA in Generative AI."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"nvidia-nim-inference-microservices","depth":2,"text":"NVIDIA NIM inference microservices"},{"id":"langsmith","depth":2,"text":"LangSmith"},{"id":"comfyui-tensorrt","depth":2,"text":"ComfyUI TensorRT"},{"id":"speed-of-light","depth":2,"text":"Speed of Light"}]}},"_type":"markdown","_id":"content:2024:06:24:agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update.md","_source":"content","_file":"2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update.md","_stem":"2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update","_extension":"md"},{"_path":"/2024/06/17/agents-of-inference-nvidia-and-langchain-generative-ai-agent-developer-contest","_dir":"17","_draft":false,"_partial":false,"_locale":"","title":"Agents of Inference: My submission for NVIDIA's Generative AI Agents Developer Contest by NVIDIA and LangChain","description":"This article discusses my entry for NVIDIA's Generative AI Agents Developer Contest entry: Agents of Inference","date":"2024-06-17","image":"/static/aoi/aoi_title.png","tags":["nvidia","langchain","agents","rtx","gpu","tensorrt","tensorrt-llm","ai","llm","llama","007","stable-diffusion","stable-video-diffusion","comfyui"],"draft":false,"external":[{"link":"https://x.com/briancaffey/status/1802754703207583886","site":"x"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"update"},"children":[{"type":"text","value":"Update"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently posted another article about optimizing this project with TensorRT and TensorRT-LLM running on local NVIDIA NIM inference microservices, please have a look here: "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update","rel":["nofollow"]},"children":[{"type":"text","value":"https://briancaffey.github.io/2024/06/24/agents-of-inference-speed-of-light-nvidia-langchain-generative-ai-agents-developer-contest-update"}]}]},{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"‚ÄúAgents of Inference‚Äù is my entry for the Generative AI Agents Developer Contest by NVIDIA and LangChain. This project aims to integrate techniques for generating text, images and video to create an application capable of producing short thematic films. In this article, I will detail how I developed the project leveraging LangGraph‚Äîa library for building stateful, multi-actor applications with LLMs--and hybrid AI workflows using NVIDIA AI-powered tools and technologies running on RTX PCs and in the cloud."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's my project submission post on ùïè:"}]},{"type":"element","tag":"agents-of-inference-tweet","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a link to the "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/agents-of-inference","rel":["nofollow"]},"children":[{"type":"text","value":"Agents of Inference code repository on GitHub"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"nvidias-generative-ai-agents-developer-contest"},"children":[{"type":"text","value":"NVIDIA's Generative AI Agents Developer Contest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AI agents are having a moment. They are the building blocks for building \"applications that reason\", and LangChain is a company that provides a comprehensive set of tools for developing, deploying and monitoring AI agents. I have struggled to understand how I can build or use agents in my own projects, and with the contest I have been able to just scratch the surface of what is possible with AI agents--but I think it is a promising paradigm for developing AI-driven applications."}]},{"type":"element","tag":"h2","props":{"id":"coming-up-with-an-idea"},"children":[{"type":"text","value":"Coming up with an idea"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I love stable diffusion. I closely follow the development of the three leading applications for generating images with stable dissuion models: Stable Diffusion WebUI, InvokeAI and ComfyUI. Write a prompt, instantly see the result, tweak the prompt and generate again. This is the basic process by which I have previously used stable diffusion. It is a satisfying mental exercise that feeds the creative and imaginative part of my brain. My idea for this project came from wanting to automate this process: use large language models to build cohesive scenes and detailed prompts and then feed them into my stable diffusion programs via API. Using LangChain and LangGraph allowed me to rapidly prototype the idea and start generating short feature films in the style of my favorite British Secret Agent: 007."}]},{"type":"element","tag":"h2","props":{"id":"putting-together-the-puzzle-pieces"},"children":[{"type":"text","value":"Putting together the puzzle pieces"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's how I set up an MVP for my project project to get started. I set up a simple graph (a linked list, really) that included the following nodes. *Important: in this context, a node is an agent, and that agent is a simple Python function. It takes one parameter which is the state, a Python dictionary, that holds the output of LLM calls that the agents make. Not all nodes make LLM calls, some just run basic functions like initializing directories or calling external stable diffusion APIs."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Casting Agent ‚Üí come up with some characters"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Location Agent ‚Üí come up with some locations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Synopsis Agent ‚Üí write a synopsis based on the characters and locations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Scene Agent ‚Üí write some number of scenes based on the synopsis based on the synopsis"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Shot agent ‚Üí describe some number of camera shots for each scene based on the scene"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Photography agent ‚Üí take each shot description and generate and image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Videography agent ‚Üí take each image generated by the photography agent and convert it to a 4 second clip using stable video diffusion"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Editor agent ‚Üí compile the movie clips together"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"simple graph of agents of inference","src":"/static/aoi/graph.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It may look simple, but there is a lot going on in this graph."}]},{"type":"element","tag":"h3","props":{"id":"casting-and-location"},"children":[{"type":"text","value":"Casting and Location"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first two agents in my graph are tasked with generating characters and locations that would appear in a British secret agent film. The prompts used for these agents are as follows:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"casting"}]},{"type":"text","value":": \"Come up with four to five characters who will appear in an upcoming British spy movie. The list should include the main character who is male, the villain, an attractive female actress who eventually falls in love with the main character, and some other characters as well.\""}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"locations"}]},{"type":"text","value":": \"Provide three main locations that can be used in an international British Spy movie. The locations should include a variety of cities, remote environments, iconic landmarks, etc. The locations should make for good background scenes for an action movie with lots of stunts, chases, explosions, fights, etc. and other things you would find in an action movie. Be sure to include the country and a description of the environment where these places are.\""}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These agents leverage the LangChain Expression Language (LCEL) to generate "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"structured output"}]},{"type":"text","value":" based on Pydantic models. For"}]},{"type":"element","tag":"pre","props":{"code":"class Character(BaseModel):\n    \"\"\"\n    The type for character that the casting agent casts for a role in the movie\n    \"\"\"\n    full_name: str = Field(description=\"The character's name\")\n    short_name: str = Field(description=\"The character's short name\")\n    background: str = Field(description=\"The character's background\")\n    physical_traits: str = Field(description=\"The physical traits of the character\")\n    ethnicity: str = Field(description=\"The character's ethnicity\")\n    gender: str = Field(description=\"The character's gender, either male of female\")\n    nationality: str = Field(description=\"The character's nationality\")\n    main_character: bool = Field(description=\"If the character is or is not the main character\")\n\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" Character"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"BaseModel"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    The type for character that the casting agent casts for a role in the movie\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    full_name: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's name\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    short_name: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's short name\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    background: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's background\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    physical_traits: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The physical traits of the character\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ethnicity: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's ethnicity\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    gender: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's gender, either male of female\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    nationality: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"The character's nationality\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    main_character: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"bool"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Field("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"If the character is or is not the main character\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"LCEL offers wonderful syntactic sugar, I can use this model in a parse and pip that into the output from the mode:"}]},{"type":"element","tag":"pre","props":{"code":"chain = prompt | model | parser\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chain "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" prompt "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" model "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" parser\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This results in our structured data:"}]},{"type":"element","tag":"pre","props":{"code":"cast:\n- background: Former MI6 agent\n  ethnicity: British\n  full_name: James Alexander\n  gender: Male\n  main_character: true\n  nationality: British\n  physical_traits: Tall, dark hair, blue eyes\n  short_name: Jamie\n","language":"yml","meta":"","className":"language-yml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"cast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"- "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"background"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Former MI6 agent\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  ethnicity"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"British\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  full_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"James Alexander\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  gender"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Male\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  main_character"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  nationality"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"British\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  physical_traits"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Tall, dark hair, blue eyes\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  short_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Jamie\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I saved the state for all \"Agents of Inference\" invocations in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"output"}]},{"type":"text","value":" directory of my "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/agents-of-inference/tree/main/output","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"agents-of-inference"}]}]},{"type":"text","value":" GitHub repo. I didn't commit the images and videos, but you can follow @AgentInference on X to see more of the results from my development process and future improvements, as well!"}]},{"type":"element","tag":"h3","props":{"id":"synopsis-agent"},"children":[{"type":"text","value":"Synopsis Agent"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With a cast of characters and locations selected, we need a synopsis to determine what happens. Here's the prompt:"}]},{"type":"element","tag":"pre","props":{"code":"synopsis: |\n  Generate a synopsis for a British spy agent movie in the style of the James Bond series. The synopsis should include the following elements:\n  Protagonist: A charismatic and skilled British secret agent with a code name (e.g., \"Agent X\") who works for a top-secret government agency (e.g., MI6).\n  Antagonist: A formidable villain with a grand, sinister plan that threatens global security. The antagonist should have a unique, memorable persona and a well-defined motivation.\n  Mission: Outline the high-stakes mission that the protagonist must undertake to thwart the antagonist‚Äôs plan.\n  Gadgets and Vehicles: Mention the cutting-edge gadgets and vehicles that the protagonist uses throughout the mission. These should be inventive and integral to the plot.\n  Action Sequences: Include a brief description of some thrilling action sequences, such as car, boat, plane chases, hand-to-hand combat, and daring escapes, and dangerous situations.\n  Big Reveal: There is a big reveal toward the end of the storyline that is surprising and the reveal helps to move the story along.\n  Climactic Showdown: Describe the final confrontation between the protagonist and the antagonist. This should be intense and action-packed, leading to a satisfying resolution. Should include details about the main character is victorious.\n  Setting: Ensure that the settings are diverse and visually striking, adding to the overall excitement and suspense of the story. This should involve multiple locations in exotic environments, the wilderness, in dangerous situations, on board planes, trains, boats and fancy cars, etc.\n  Tone and Style: Maintain the sophisticated, suave, and adventurous tone that is characteristic of the James Bond series. Include elements of intrigue, romance, and humor.\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"synopsis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Generate a synopsis for a British spy agent movie in the style of the James Bond series. The synopsis should include the following elements:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Protagonist: A charismatic and skilled British secret agent with a code name (e.g., \"Agent X\") who works for a top-secret government agency (e.g., MI6).\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Antagonist: A formidable villain with a grand, sinister plan that threatens global security. The antagonist should have a unique, memorable persona and a well-defined motivation.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Mission: Outline the high-stakes mission that the protagonist must undertake to thwart the antagonist‚Äôs plan.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Gadgets and Vehicles: Mention the cutting-edge gadgets and vehicles that the protagonist uses throughout the mission. These should be inventive and integral to the plot.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Action Sequences: Include a brief description of some thrilling action sequences, such as car, boat, plane chases, hand-to-hand combat, and daring escapes, and dangerous situations.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Big Reveal: There is a big reveal toward the end of the storyline that is surprising and the reveal helps to move the story along.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Climactic Showdown: Describe the final confrontation between the protagonist and the antagonist. This should be intense and action-packed, leading to a satisfying resolution. Should include details about the main character is victorious.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Setting: Ensure that the settings are diverse and visually striking, adding to the overall excitement and suspense of the story. This should involve multiple locations in exotic environments, the wilderness, in dangerous situations, on board planes, trains, boats and fancy cars, etc.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Tone and Style: Maintain the sophisticated, suave, and adventurous tone that is characteristic of the James Bond series. Include elements of intrigue, romance, and humor.\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The synopsis to any good film is key, so I decided to use a feature of LangGraph that would allow a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synopsis_review_agent"}]},{"type":"text","value":" to provide multiple rounds of feedback to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synopsis_agent"}]},{"type":"text","value":" to make it even better. Here's what the new graph look like after implementing the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synopsis_review_agent"}]},{"type":"text","value":" using conditional graph edges:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"synopsis_review_agent","src":"/static/aoi/graph_with_cycle.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Conditional edges are a very powerful feature and I just used it in one part of my graph. Other parts of the graph could benefit from this as well, and they can allow for \"human-in-the-loop\" interactions which are becoming very popular in AI-powered applications."}]},{"type":"element","tag":"h3","props":{"id":"scene-and-shot-agents"},"children":[{"type":"text","value":"Scene and shot agents"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With our perfected synopsis, we are ready to put more agents to work. The scene agent builds out the basic structure of the storyline. It provides a structured list of the main sections of the movie. The shot agent then loops over the scenes and creates a number of different shots for the given scene. This was an effective way to have consistent thematic content for shots within a scene. Here are the prompts I used for the scene and shot agents:"}]},{"type":"element","tag":"pre","props":{"code":"scenes: |\n  Create a list of detailed scenes for an exciting and entertaining British spy film. The scenes should be comprehensive and include all scenes necessary for a complete film. Each scene should include the following elements:\n  Location: Describe the location and setting of the scene, including any notable landmarks, time of day, and general atmosphere.\n  Characters Involved: List the main characters present in the scene, with a brief description of their roles and appearances.\n  Description of What Happens: Provide a detailed account of the action, and key events that take place in the scene.\nshot: |\n  You are a film director working on a new British spy film and your writers have provided you with a scene. Your task is to come up with four to five shots that will be filmed during the scene. The shot descriptions needs to be specific and should include a varietry of closeup shots on characters, environment shots that consider the scene location and shots of specific items or other things that are featured in the scene. Each shot should also have a title. The description should be a brief densely worded block of text that captures the important elements of the scene. Consider the style of camera angle, lighting, character expressions, clothing, and other important visual elements for each shot. Be very descriptive. The description will be used to generate an image of the shot. Also, there should be at most one actor for each shot that contains people. Don't use the name of the character, instead use a physical description of the character based on their physical traits described below if needed. Also consider what the actor is wearing in the description.\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"scenes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Create a list of detailed scenes for an exciting and entertaining British spy film. The scenes should be comprehensive and include all scenes necessary for a complete film. Each scene should include the following elements:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Location: Describe the location and setting of the scene, including any notable landmarks, time of day, and general atmosphere.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Characters Involved: List the main characters present in the scene, with a brief description of their roles and appearances.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  Description of What Happens: Provide a detailed account of the action, and key events that take place in the scene.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"shot"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  You are a film director working on a new British spy film and your writers have provided you with a scene. Your task is to come up with four to five shots that will be filmed during the scene. The shot descriptions needs to be specific and should include a varietry of closeup shots on characters, environment shots that consider the scene location and shots of specific items or other things that are featured in the scene. Each shot should also have a title. The description should be a brief densely worded block of text that captures the important elements of the scene. Consider the style of camera angle, lighting, character expressions, clothing, and other important visual elements for each shot. Be very descriptive. The description will be used to generate an image of the shot. Also, there should be at most one actor for each shot that contains people. Don't use the name of the character, instead use a physical description of the character based on their physical traits described below if needed. Also consider what the actor is wearing in the description.\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"stable-diffusion-and-stable-video-diffusion-agents"},"children":[{"type":"text","value":"Stable Diffusion and Stable Video Diffusion agents"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The stable diffusion agent makes an API call to a local instance of the Stable Diffusion WebUI API, saves the generated image and saves a reference to that image in the state:"}]},{"type":"element","tag":"pre","props":{"code":"- description: A medium close-up shot of Ethan Jameson's face, with a concerned expression,\n    as he reads the message from Natalie Jackson. The lighting is dim, with only a\n    single lamp on his desk casting a warm glow. His eyes are narrowed, and his brow\n    is furrowed in concentration. He is wearing a dark blue suit and a white shirt.\n  image: 000.png\n  title: Ethan's Concerned Expression\n  video: 000.mp4\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"- "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"A medium close-up shot of Ethan Jameson's face, with a concerned expression,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    as he reads the message from Natalie Jackson. The lighting is dim, with only a\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    single lamp on his desk casting a warm glow. His eyes are narrowed, and his brow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    is furrowed in concentration. He is wearing a dark blue suit and a white shirt.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"000.png\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  title"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Ethan's Concerned Expression\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  video"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"000.mp4\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"A medium close-up shot of Ethan Jameson's face","src":"/static/aoi/ethan.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With the perfectly prompted image in hand, we can use Stable Video Diffusion to bring it to life. I prompted phind to come up with a FastAPI service that would accept an image in a post request and return a short video created with stable video diffusion using the diffusers library."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Stable video diffusion can generate about 4 seconds of text at 7 frames per second. This isn't great, but I was able to use ffmpeg to do frame interpolation bringing the frame rate to a much smoother 14 fps using motion compensated interpolation (MCI):"}]},{"type":"element","tag":"pre","props":{"code":"ffmpeg -i output/1718453390/final.mp4 -crf 10 -vf \"minterpolate=fps=14:mi_mode=mci:mc_mode=aobmc:me_mode=bidir:vsbmc=1\" output/1718453390/final.14fps.mp4\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"ffmpeg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" output/1718453390/final.mp4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -crf"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 10"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -vf"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"minterpolate=fps=14:mi_mode=mci:mc_mode=aobmc:me_mode=bidir:vsbmc=1\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" output/1718453390/final.14fps.mp4\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"editor_agent"}]},{"type":"text","value":" uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"moviepy"}]},{"type":"text","value":" to join the clips together into a single video."}]},{"type":"element","tag":"h2","props":{"id":"development-environment"},"children":[{"type":"text","value":"Development environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I struggled to optimize the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta-llama/Meta-Llama-3-8B-Instruct"}]},{"type":"text","value":" with TensorRT-LLM, so I ran LLM inference on a combination of older Llama2 TensorRT-LLM models, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Meta-Llama-3-8B-Instruct"}]},{"type":"text","value":" on LM Studio (which I found to be painfully slow compared to TensorRT-LLM)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you provide an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NVIDIA_API_KEY"}]},{"type":"text","value":" in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".env"}]},{"type":"text","value":" file, LLM calls will be made using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"meta/llam3-70b-instruct"}]},{"type":"text","value":" model on "},{"type":"element","tag":"a","props":{"href":"https://build.nvidia.com/meta/llama3-70b","rel":["nofollow"]},"children":[{"type":"text","value":"build.nvidia.com/meta/llama3-70b"}]},{"type":"text","value":". In fact, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"build.nvidia.com"}]},{"type":"text","value":" also provides stable diffusion and stable video diffusion inference via API. This would be very convenient in the event that my RTX PCs become compromised."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My RTX 4090 GPU with 24 GB of memory was able to run lots of different inference servers concurrently (LLM, Stable Diffusion WebUI, ComfyUI, InvokeAI, Stable Video Diffusion FastAPI service), but I generally stuck to doing one type of inference at a time, otherwise things would grind to a hault or crash. I also experimented with ChatTTS, a new text-to-speech model."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I developed this project on a MacBook Pro, and I used my RTX PC as if it were a remote service providing inference for text, images and video. This is a helpful mindset when working with hybrid AI workflows that leverage inference services both on local machines and in the cloud."}]},{"type":"element","tag":"h2","props":{"id":"how-it-works"},"children":[{"type":"text","value":"How it works"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To run the program, you need to install python dependencies and then run an OpenAI compatible LLM and Stable Duffsion WebUI server with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--api"}]},{"type":"text","value":" flag. You also need to run the Stable Video Diffusion service. Apologies for any hardcoded local IP address in the source code. Deadlines, you know! With everything configured, you can run the following command:"}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/agents-of-inference$ poetry run python agents_of_inference/main.py\n## üìÄ Using local models üìÄ ##\n## üé≠ Generating Cast üé≠ ##\n## üó∫Ô∏è Generating Locations üó∫Ô∏è ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to synopsis_review_agent ##\n## üìë Reviewing Synopsis üìë ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to synopsis_review_agent ##\n## üìë Reviewing Synopsis üìë ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to scene_agent ##\n## üìí Generating Scenes üìí ##\n## üé¨ Generating Shots üé¨ ##\n## Generated 5 shots for scene 1/5 ##\n## Generated 5 shots for scene 2/5 ##\n## Generated 5 shots for scene 3/5 ##\n## Generated 5 shots for scene 4/5 ##\n## Generated 5 shots for scene 5/5 ##\n\n000/0025\nA medium shot of a bustling Tokyo street, with neon lights reflecting off wet pavement. Jim Thompson, dressed in a black leather jacket and dark jeans, walks purposefully through the crowd, his piercing blue eyes scanning the area. The sound design features the hum of traffic and chatter of pedestrians.\nGenerated image output/1718426686/images/000.png\n\n001/0025\nA tight close-up shot of Emily Chen's face, her piercing brown eyes intense as she briefs Jim on the situation. Her short black hair is styled neatly, and she wears a crisp white blouse with a silver necklace. The camera lingers on her lips as she speaks, emphasizing the importance of the information.\nGenerated image output/1718426686/images/001.png\n\nGenerated video output/1718426686/videos/000.mp4\n== stable video diffusion generation complete ==\nGenerated video output/1718426686/videos/001.mp4\n== stable video diffusion generation complete ==\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/agents-of-inference$ poetry run python agents_of_inference/main.py\n## üìÄ Using local models üìÄ ##\n## üé≠ Generating Cast üé≠ ##\n## üó∫Ô∏è Generating Locations üó∫Ô∏è ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to synopsis_review_agent ##\n## üìë Reviewing Synopsis üìë ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to synopsis_review_agent ##\n## üìë Reviewing Synopsis üìë ##\n## ‚úçÔ∏è Generating Synopsis ‚úçÔ∏è ##\n## going to scene_agent ##\n## üìí Generating Scenes üìí ##\n## üé¨ Generating Shots üé¨ ##\n## Generated 5 shots for scene 1/5 ##\n## Generated 5 shots for scene 2/5 ##\n## Generated 5 shots for scene 3/5 ##\n## Generated 5 shots for scene 4/5 ##\n## Generated 5 shots for scene 5/5 ##\n\n000/0025\nA medium shot of a bustling Tokyo street, with neon lights reflecting off wet pavement. Jim Thompson, dressed in a black leather jacket and dark jeans, walks purposefully through the crowd, his piercing blue eyes scanning the area. The sound design features the hum of traffic and chatter of pedestrians.\nGenerated image output/1718426686/images/000.png\n\n001/0025\nA tight close-up shot of Emily Chen's face, her piercing brown eyes intense as she briefs Jim on the situation. Her short black hair is styled neatly, and she wears a crisp white blouse with a silver necklace. The camera lingers on her lips as she speaks, emphasizing the importance of the information.\nGenerated image output/1718426686/images/001.png\n\nGenerated video output/1718426686/videos/000.mp4\n== stable video diffusion generation complete ==\nGenerated video output/1718426686/videos/001.mp4\n== stable video diffusion generation complete ==\n"}]}]},{"type":"element","tag":"h2","props":{"id":"demo-video-for-contest-submission"},"children":[{"type":"text","value":"Demo Video for Contest Submission"}]},{"type":"element","tag":"agents-of-inference-video","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Making this video was a lot of fun. The \"Agents of Inference\" highlight reel includes some of the most interesting, exciting and fun clips that I found in the dozens of short films it created. It is important to note that a lot of the content is not very good. Misunderstood prompts, color confusion (prompt includes green eyes, but other things in the scene are also conspicuously green), unrealistic or noisy motion from Stable Video Diffusion--these are some of the issues you will find in the films. Generating AI images sometimes feels like panning for gold: you go through a lot of sediment to get a few good flakes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Also, I added a few short animations that I made with Blender. The final scene shows the NVIDIA Omniverse orange humanoid from the barrel of a pistol. I think we are rapidly approaching a future where agents can generate full-scale theatrical movies by generating OpenUSD code, directly or indirectly. Maybe for the next NVIDIA Developer contest!"}]},{"type":"element","tag":"h2","props":{"id":"shortcomings-of-my-project"},"children":[{"type":"text","value":"Shortcomings of my project"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My goodness, how embarrasing. There are quite a few shortcomings that can be easily identified looking over the output and the source code. Here are a few:"}]},{"type":"element","tag":"h3","props":{"id":"character-variety"},"children":[{"type":"text","value":"Character variety"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When generating characters I would frequently see one named Dr. Sophia Patel who is apparently a brilliant cryptologist. Other characters would often have different names or backgrounds, but a saw Dr. Sophia Patel more often than not."}]},{"type":"element","tag":"h3","props":{"id":"character-consistency"},"children":[{"type":"text","value":"Character consistency"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The characters are not consistent. This is a notoriously difficult problem to solve, but I made a lot of progress on it during this contest. I experimented with calling the ComfyUI API to run a custom workflow built with the ComfyUI graph-based workflow tool for face transfer:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Dr. Sophia Patel","src":"/static/aoi/sophia.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using ComfyUI would be nice, but it wouldn't be as easy to tap into cloud APIs if my workflow heavily relied on ComfyUI server with custom models."}]},{"type":"element","tag":"h3","props":{"id":"understanding-langchain"},"children":[{"type":"text","value":"Understanding LangChain"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I started out with the idea I would store all LLM calls to a local JSON to serve as a cache, allowing me to avoid regenerating responses from early in the workflow. This worked well, until I tried to serialize an Annotated list (required for cycles such as the one used with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synopsis_review_agent"}]},{"type":"text","value":"). I ended up wasting a lot of time trying to figure this out, and I came across some built-in LangChain features for storing state in memory and in Sqlite. I'm sure there are other areas where I used the wrong pattern, but I turned over a lot of stones and look forward to continuing development with LangChain."}]},{"type":"element","tag":"h2","props":{"id":"whats-next"},"children":[{"type":"text","value":"What's next?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thank you to NVIDIA and LangChain for organizing this contest. It was a great way to explore a powerful toolset for automated content generation using AI agents."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Video models like Dream Machine and Sora have made some big splashes on the internet and the results are remarkable. However, I'm still almost more interested in finding the limitations of quality content using open-source models on consumer hardware like RTX GPUs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I would also have loved to generate my own music for these films. I am a Suno poweruser and love the songs I have generated on that site. Will the gap between video and music generation on private, payed services and local machines? Or does it just need time to catch up? Hopefully a future installment of \"Agents of Inference\" will integrate music and voice, and can't wait to hear it!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"update","depth":2,"text":"Update"},{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"nvidias-generative-ai-agents-developer-contest","depth":2,"text":"NVIDIA's Generative AI Agents Developer Contest"},{"id":"coming-up-with-an-idea","depth":2,"text":"Coming up with an idea"},{"id":"putting-together-the-puzzle-pieces","depth":2,"text":"Putting together the puzzle pieces","children":[{"id":"casting-and-location","depth":3,"text":"Casting and Location"},{"id":"synopsis-agent","depth":3,"text":"Synopsis Agent"},{"id":"scene-and-shot-agents","depth":3,"text":"Scene and shot agents"},{"id":"stable-diffusion-and-stable-video-diffusion-agents","depth":3,"text":"Stable Diffusion and Stable Video Diffusion agents"}]},{"id":"development-environment","depth":2,"text":"Development environment"},{"id":"how-it-works","depth":2,"text":"How it works"},{"id":"demo-video-for-contest-submission","depth":2,"text":"Demo Video for Contest Submission"},{"id":"shortcomings-of-my-project","depth":2,"text":"Shortcomings of my project","children":[{"id":"character-variety","depth":3,"text":"Character variety"},{"id":"character-consistency","depth":3,"text":"Character consistency"},{"id":"understanding-langchain","depth":3,"text":"Understanding LangChain"}]},{"id":"whats-next","depth":2,"text":"What's next?"}]}},"_type":"markdown","_id":"content:2024:06:17:agents-of-inference-nvidia-and-langchain-generative-ai-agent-developer-contest.md","_source":"content","_file":"2024/06/17/agents-of-inference-nvidia-and-langchain-generative-ai-agent-developer-contest.md","_stem":"2024/06/17/agents-of-inference-nvidia-and-langchain-generative-ai-agent-developer-contest","_extension":"md"},{"_path":"/2024/02/17/rocket-league-botchat-nvidia-generative-ai-on-rtx-pcs-developer-contest","_dir":"17","_draft":false,"_partial":false,"_locale":"","title":"Rocket League BotChat powered by TensorRT-LLM: My submission for NVIDIA's Generative AI on RTX PCs Developer Contest","description":"This article discusses my entry for NVIDIA's Generative AI on RTX PCs Developer Contest: Rocket Leauge BotChat","date":"2024-02-17","image":"/static/rlbc/cover.png","tags":["nvidia","rtx","gpu","tensorrt-llm","ai","llm","llama","rocket-league","gaming","windows"],"external":[{"link":"https://twitter.com/briancaffey/status/1760529251072118901","site":"x"},{"link":"https://www.reddit.com/r/RocketLeague/comments/1au0po3/rocket_league_botchat_an_llmpowered_bakkesmod/","site":"reddit"},{"link":"https://dev.to/briancaffey/rocket-league-botchat-powered-by-tensorrt-llm-my-submission-for-nvidias-generative-ai-on-rtx-pcs-developer-contest-2oao","site":"dev"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article is about my submission to NVIDIA's Generative AI on RTX PCs Developer Contest: Rocket League BotChat. Rocket League BotChat is a BakkesMod plugin for Rocket League that allows bots to send chat messages based on in-game events. It is designed to be used with a local LLM service optimized and accelerated with NVIDIA's TensorRT-LLM library."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's my project submission post on ùïè:"}]},{"type":"element","tag":"rocket-league-bot-chat-tweet","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a link to the "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/RocketLeagueBotChat","rel":["nofollow"]},"children":[{"type":"text","value":"Rocket League BotChat GitHub repository"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"nvidias-gen-ai-developer-contest"},"children":[{"type":"text","value":"NVIDIA's Gen AI Developer Contest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The following email caught my attention last month:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Generative AI on RTX PCs Developer Contest: Build your next innovative Gen AI project using NVIDIA TensorRT or TensorRT-LLM on Windows PC with NVIDIA RTX systems"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The part about ‚Äúon Windows PC‚Äù made me think: why would a developer contest focus on a particular operating system? I use all three of the major operating systems: macOS, Ubuntu and Windows 11, but most of the development work I do is on macOS and Ubuntu. I discovered WSL (Windows Subsystem for Linux) a few years ago and really enjoy using that for development as well, but I had never considered doing development work on Windows outside of WSL. I had also never used any of the Windows-specific development frameworks like .NET or Visual Studio."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My experience with Windows goes back to 2016 when I built my fist PC with an NVIDIA GeForce GTX 1080 graphics card. When I built another personal computer last year in 2023, getting the NVIDIA GeForce RTX 4090 graphics card was a big step up. I bought two NVMe drives in order to dual boot into both Windows and Ubuntu operating systems. Switching between the operating systems requires turning off the computer, going into the BIOS settings and changing the boot order and restarting the computer."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Last year I started learning more about AI image generation using Stable Diffusion with programs like Automatic1111, InvokeAI and ComfyUI. I set up everything on my PC's Ubuntu operating system, and frequently had to switch between using Ubuntu for working with stable diffusion and Windows for gaming and other Windows-specific software. The friction of having to constantly switch operating systems pushed me to move my stable diffusion software workflows to Windows. All of my models and images are stored to external drives, so moving things over to Windows was pretty easy."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I learned PowerShell and got more familiar with how Windows works as a development machine. Environment variables and system variables are one example of how Windows does things differently compared ot Linux-based operating systems. And just like that, I became a Windows developer! This experience got me interested in coming up with an idea for the NVIDIA Generative AI on NVIDIA RTX PCs Developer Contest."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Windows winfetch screenshot","src":"/static/rlbc/winfetch.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"coming-up-with-an-idea"},"children":[{"type":"text","value":"Coming up with an Idea"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The contest description and some related NVIDIA articles about the contest helped me with brainstorming:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Whether it‚Äôs a RAG-based chatbot, a plug-in for an existing application, or a code generation tool, the possibilities are endless."}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Many use cases would benefit from running LLMs locally on Windows PCs, including gaming, creativity, productivity, and developer experiences."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This contest is focused on NVIDIA's consumer hardware line: GeForce RTX. It has a diverse set of use cases including gaming, crypto mining, VR, simulation software, creative tools and new AI techniques including image generation and LLM (Large Language Model) inference."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"A stacked bar chart showing the composition of Nvidia's revenue each quarter going back to fiscal 2019.","src":"https://g.foolcdn.com/image/?url=https%3A%2F%2Fg.foolcdn.com%2Feditorial%2Fimages%2F764886%2Fnvda_revenue_bar.png&op=resize&w=700"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Gaming seemed like an interesting avenue for me to explore. PC gaming is still an industry that is developed primarily for Windows operating systems, and the gaming industry has been the largest revenue driver of NVIDIA in recent years, only recently surpassed by the data center segment. GPUs are needed to render graphics of enormous open-world environments. Some story-driven games include huge amounts of dialogue that can be considered as huge literary works in their own right. Red Dead Redemption and Genshin Impact are two massively popular games of this type. There might be an interesting project idea that could use LLMs and RAG (retrieval augmented generation), but I don't play these types of games and it didn't seem practical for a project that would be built in just over a month. I thought about trying to build something for a simpler game that I already know."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Rocket League is a vehicular soccer game that is played on both game consoles and on PCs. It is an eSports with a very high skill ceiling and a massive player base (85 million active players in the last 30 days). I started playing it during the pandemic with some of my friends and all got hooked. We also came to learn that Rocket League's in-game is varies from entertaining, annoying, toxic and in some cases, sportsmanlike."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other thing I learned about Rocket League is that it has an active modding community. Developers create plugins for the game for all different purposes, such as coaching, practice drills, capturing replays, tracking player statistics, etc. Most Rocket League Mods are written in a popular framework called Bakkesmod (developed Andreas \"bakkes\" Bakke, a Norwegian software engineer). Rocket League's in-game chat inspired the idea for my submission to NVIDIA's Generative AI Developer Contest: Rocket League BotChat. The idea for my project is to build a plugin with Bakkesmod that allows Rocket League bots to send chat messages based on game events using an LLM accelerated and optimized by TensorRT-LLM (more on TensorRT-LLM soon!)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Bots are built into the Rocket League game and you can play with or against them in offline matches. However, the built-in bots are not very good. Another 3rd-party project called RLBot allows players to play against community-developed AI bots that are developed with machine learning frameworks like TensorFlow and PyTorch. These bots are very good, but they are not infallible. My contest project idea was now clear: develop a plugin for Rocket League capable of sending messages from bot players. This idea seemed to check the boxes for the large language model category of NVIDIA's developer contest: develop a project in a Windows environment for a Windows-specific program, and use an LLM powered by TensorRT-LLM."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"RLBot Ascii Art","src":"/static/rlbc/bot.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"putting-together-the-puzzle-pieces"},"children":[{"type":"text","value":"Putting together the puzzle pieces"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this idea in mind, I looked into the project's feasibility. I really had no idea if this would work. I looked through the Bakkesmod documentation and found some helpful resources that gave me confidence that I could pull something together for at least a proof-of-concept."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Bakkesmod Plugin Wiki "},{"type":"element","tag":"a","props":{"href":"https://wiki.bakkesplugins.com/","rel":["nofollow"]},"children":[{"type":"text","value":"https://wiki.bakkesplugins.com/"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://wiki.bakkesplugins.com/code_snippets/using_http_wrapper/","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HttpWrapper"}]}]},{"type":"text","value":" for sending HTTP requests from Bakkesmod"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://wiki.bakkesplugins.com/functions/stat_events/","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StatEvents"}]}]},{"type":"text","value":" that allow for running custom code when specific event functions are triggered in the game (such as scoring a goal, or making a save)."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Bakkesmod plugin template: "},{"type":"element","tag":"a","props":{"href":"https://github.com/Martinii89/BakkesmodPluginTemplate","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/Martinii89/BakkesmodPluginTemplate"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This provides a great starting-off point for developing Bakkesmod plugins. Plugins for Bakkesmod are written in C++ and this repo provides an organized file structure that allows your to get started quickly"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Plugin Tutorial: "},{"type":"element","tag":"a","props":{"href":"https://wiki.bakkesplugins.com/plugin_tutorial/getting_started/","rel":["nofollow"]},"children":[{"type":"text","value":"https://wiki.bakkesplugins.com/plugin_tutorial/getting_started/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Open-source chat-related Bakkesmod plugins on GitHub\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"BetterChat: "},{"type":"element","tag":"a","props":{"href":"https://github.com/JulienML/BetterChat","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/JulienML/BetterChat"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Translate: "},{"type":"element","tag":"a","props":{"href":"https://github.com/0xleft/trnslt","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/0xleft/trnslt"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Starting with the Plugin Template, I wrote a simple console command that when triggered sends an HTTP request to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localhost:8000/hello"}]},{"type":"text","value":". I set up a Hello World Flask app running on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localhost:8000"}]},{"type":"text","value":" and I was able to get a response from my Hello World server! There didn't seem to be any network or permission errors that would prevent my game code from communicating with other applications on my PC."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next I started looking into how to build and run optimized LLMs with NVIDIA's TensorRT-LLM library, the software that this contest is promoting. The contest announcement included an interesting building block that I thought could be very useful: an example repo showing how to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CodeLlama-13b-instruct-hf"}]},{"type":"text","value":" optimized by TensorRT-LLM to provide inference for a VSCode extension called Continue (Continue.dev)."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CodeLlama-13b-instruct-hf"}]},{"type":"text","value":" is an open source model from Meta that is trained on code and can help with code generation tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"TensorRT-LLM is a Python library that accelerates and optimizes inference performance of large language models. It takes a Large Language Model like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CodeLlama-13b-instruct-hf"}]},{"type":"text","value":" and generates an engine that can be used for doing inference"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VSCode is an open source code editor developed by Microsoft with an large number of community plugins"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Continue.dev is a startup backed by Y Combinator that is developing an open-source autopilot (code assistant) for VSCode and JetBrains that works with local LLMs or paid services like ChatGPT"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To get the coding assistant project working I needed to build the TensorRT-LLM engine. Building TensorRT-LLM engines on Windows can be done in one of two ways:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"using a \"bare-metal\" virtual environment on Windows (with PowerShell)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"using WSL"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At the time of writing, building a TensorRT-LLM engine on Windows can only be done with version "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v0.6.1"}]},{"type":"text","value":" of the TensorRT-LLM repo and version "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v0.7.1"}]},{"type":"text","value":" of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tensorrt_llm"}]},{"type":"text","value":" Python package."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With WSL you can use the up-to-date versions of the TensorRT-LLM repo (main branch). The engines produced by Windows and WSL (Ubuntu) are not interchangeable and you will get errors if you try to use an engine created with one operating system on another operating system."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once the engines are built you can use them to run the example from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"trt-llm-as-openai-windows"}]},{"type":"text","value":" repo."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The example repo exposes an OpenAI-compatible API locally that can do chat completions. You then need to configure the Continue.dev extension to use the local LLM service:"}]},{"type":"element","tag":"pre","props":{"code":"{\n  \"title\": \"CodeLlama-13b-instruct-hf\",\n  \"apiBase\": \"http://192.168.5.96:5000/\",\n  \"provider\": \"openai\",\n  \"apiKey\": \"None\",\n  \"model\": \"gpt-4\"\n}\n","language":"json","meta":"","className":"language-json shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  \"title\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#CFCFC2"},"children":[{"type":"text","value":"\"CodeLlama-13b-instruct-hf\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  \"apiBase\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#CFCFC2"},"children":[{"type":"text","value":"\"http://192.168.5.96:5000/\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  \"provider\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#CFCFC2"},"children":[{"type":"text","value":"\"openai\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  \"apiKey\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#CFCFC2"},"children":[{"type":"text","value":"\"None\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"  \"model\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#CFCFC2"},"children":[{"type":"text","value":"\"gpt-4\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Continue.dev extension using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CodeLlama-13b-instruct-hf"}]},{"type":"text","value":" accelerated and optimized by TensorRT-LLM is very fast. According to "},{"type":"element","tag":"a","props":{"href":"https://blog.continue.dev/programming-languages/","rel":["nofollow"]},"children":[{"type":"text","value":"this post on Continue.dev's blog"}]},{"type":"text","value":", C++ is a \"first tier\" language:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C++ has one of the largest presences on GitHub and Stack Overflow. This shows up in its representation in public LLM datasets, where it is one of the languages with the most data. Its performance is near the top of the MultiPL-E, BabelCode / TP3, MBXP / Multilingual HumanEval, and HumanEval-X benchmarks. However, given that C++ is often used when code performance and exact algorithm implementation is very important, many developers don‚Äôt believe that LLMs are as helpful for C++ as some of the other languages in this tier."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most of the time I'm working with either Python and TypeScript. I've read about C++ but haven't used it for anything before doing this project. I primarily used Microsoft Visual Studio to build the plugin, but VSCode with the Continue.dev autopilot extension was helpful for tackling smaller problems in a REPL-like environment. For example, I used Continue.dev in VSCode to figure out how to handle JSON. Coming from Python and JavaScript languages, I found the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nlohmann/json"}]},{"type":"text","value":" JSON library syntax to be somewhat different. For example, here is how to add a message to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"messages"}]},{"type":"text","value":" in the body of an OpenAI API request:"}]},{"type":"element","tag":"pre","props":{"code":"messages.push_back({ {\"role\", role}, {\"content\", content } });\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"messages."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"push_back"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"({ {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"role\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", role}, {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"content\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", content } });\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In Python the code for appending a message to a list of messages would be written differently:"}]},{"type":"element","tag":"pre","props":{"code":"messages.append({\"role\": role, \"content\": content})\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"messages.append({"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"role\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": role, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"content\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": content})\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"development-environment"},"children":[{"type":"text","value":"Development environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While working on different projects using web technologies and frameworks in the Python and JavaScript ecosystems, I developed an appreciation for well-structured development environments that are easy to use. Development environment refers to the tools and processes by which a developer can make a change to source code and see these changes reflected in some version of the application running on a local environment. The local environment (the developer's computer) should be a close proxy for the production environment where the code will ultimately deployed to for end users. For this project the local development environment is our PC itself, which simplifies things. A development environment should support hot-reloading so incremental changes can be run to test functionality, offering a tight feedback loop. I really like the development environment for this project. Here's a screenshot that shows the different parts of the development environment I used for working on Rocket League BotChat:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Screenshot of Rocket League BotChat development environment","src":"/static/rlbc/devenv2.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Rocket League (running with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"-dev"}]},{"type":"text","value":" flag turned on). The console is helpful for viewing log messages and the plugin settings panel can be used to view and change plugin configuration values. The BakkesMod plugin also needs to be running in order to inject plugin code into the game engine"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Visual Studio for working on the plugin code. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Control"}]},{"type":"text","value":"+"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Shift"}]},{"type":"text","value":"+"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"B"}]},{"type":"text","value":" rebuilds the code and automatically reloads the plugin in the game"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"OpenAI-compatible LLM server powered by TensorRT-LLM (using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Llama-2-13b-chat-hf"}]},{"type":"text","value":" with AWQ INT4 quantization) running in a docker container on Ubuntu in WSL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VSCode for debugging C++ code with Continue.dev extension powered by TensorRT-LLM (using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CodeLlama-13b-instruct-hf"}]},{"type":"text","value":" with AWQ INT4 quantization) running in a virtual environment on Windows"}]}]},{"type":"element","tag":"h3","props":{"id":"building-the-tensorrt-llm-engines"},"children":[{"type":"text","value":"Building the TensorRT-LLM engines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I was able to build and run the TensorRT LLM engines for my game plugin's inference and the Continue.dev extension's inference both in Python virtual environments on Windows and on Ubuntu in WSL. For building the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Llama-2-13b-chat-hf"}]},{"type":"text","value":" model with INT4 AWQ quantization on Windows 11 I used this command:"}]},{"type":"element","tag":"pre","props":{"code":"(.venv) PS C:\\Users\\My PC\\GitHub\\TensorRT-LLM\\examples\\llama> python build.py --model_dir D:\\llama\\Llama-2-13b-chat-hf\\ --quant_ckpt_path D:\\llama\\Llama-2-13b-chat-hf\\llama_tp1_rank0.npz --dtype float16 --use_gpt_attention_plugin float16 --use_gemm_plugin float16 --use_weight_only --weight_only_precision int4_awq --per_group --enable_context_fmha --max_batch_size 1 --max_input_len 3500 --max_output_len 1024 --output_dir D:\\llama\\Llama-2-13b-chat-hf\\single-gpu\\ --vocab_size 32064\n","language":"powershell","meta":"","className":"language-powershell shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(.venv) PS C:\\Users\\My PC\\GitHub\\TensorRT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"LLM\\examples\\llama"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" python build.py "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"model_dir D:\\llama\\Llama"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"13b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"hf\\ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"quant_ckpt_path D:\\llama\\Llama"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"13b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"hf\\llama_tp1_rank0.npz "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dtype float16 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"use_gpt_attention_plugin float16 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"use_gemm_plugin float16 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"use_weight_only "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"weight_only_precision int4_awq "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"per_group "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"enable_context_fmha "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"max_batch_size "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"max_input_len "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3500"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"max_output_len "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1024"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"output_dir D:\\llama\\Llama"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"13b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"chat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"hf\\single"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"gpu\\ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"vocab_size "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"32064\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"running-the-tensorrt-llm-engines"},"children":[{"type":"text","value":"Running the TensorRT-LLM engines"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using Windows PowerShell to start the CodeLlama server for Continue.dev:"}]},{"type":"element","tag":"pre","props":{"code":"(.venv) PS C:\\Users\\My PC\\GitHub\\trt-llm-as-openai-windows> python .\\app.py --trt_engine_path \"D:\\llama\\CodeLlama-13b-Instruct-hf\\trt_engines\\1-gpu\\\" --trt_engine_name llama_float16_tp1_rank0.engine --tokenizer_dir_path \"D:\\llama\\CodeLlama-13b-Instruct-hf\\\" --port 5000 --host 0.0.0.0\n","language":"powershell","meta":"","className":"language-powershell shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(.venv) PS C:\\Users\\My PC\\GitHub\\trt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"llm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"openai"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"windows"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" python .\\app.py "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"trt_engine_path "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"D:\\llama\\CodeLlama-13b-Instruct-hf\\trt_engines\\1-gpu\\\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"trt_engine_name llama_float16_tp1_rank0.engine "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tokenizer_dir_path "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"D:\\llama\\CodeLlama-13b-Instruct-hf\\\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"port "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5000"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"host "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0.0\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Tip: Adding "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--host 0.0.0.0"}]},{"type":"text","value":" isn't required here, but it allows me to use the CodeLlama/TensorRT-LLM server with VSCode any computer on my local network using my PC's local IP address in the Continue.dev configuration."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using docker in WSL to start the Llama-2-13b-chat-hf LLM server:"}]},{"type":"element","tag":"pre","props":{"code":"root@0a5b5b75f079:/code/git/TensorRT-LLM/examples/server/flask# python3 app.py --trt_engine_path /llama/Llama-2-13b-chat-hf/trt_engines/1-gpu/ --trt_engine_name  llama_float16_t_rank0.engine --tokenizer_dir_path /llama/Llama-2-13b-chat-hf/ --port 5001 --host 0.0.0.0\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"root@0a5b5b75f079:/code/git/TensorRT-LLM/examples/server/flask# python3 app.py --trt_engine_path /llama/Llama-2-13b-chat-hf/trt_engines/1-gpu/ --trt_engine_name  llama_float16_t_rank0.engine --tokenizer_dir_path /llama/Llama-2-13b-chat-hf/ --port 5001 --host 0.0.0.0\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: Here I also add "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--host 0.0.0.0"}]},{"type":"text","value":", but this is required in order for the service in the docker container to be reached from WSL by the game running on Windows."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"BakkesMod includes a console window that came in handy for debugging errors during development."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At the beginning of this developer contest on January 9, NVIDIA announced Chat with RTX. This is a demo program for Windows that automates a lots of the processes needed to set up a TensorRT-LLM-powered LLM running on your PC. Keep an eye on this project as it may become the best way to install and manage large language models on Windows PCs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Chat with RTX image","src":"/static/rlbc/chat_with_rtx.jpeg"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"how-it-works"},"children":[{"type":"text","value":"How it works"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick look at key parts of the plugin source code ("},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/RocketLeagueBotChat","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/briancaffey/RocketLeagueBotChat"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h3","props":{"id":"hooking-events"},"children":[{"type":"text","value":"Hooking events"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hooking events is the core of how this plugin works. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StatTickerMessage"}]},{"type":"text","value":" events cover most of the events that are triggered in Rocket League, such as scoring a goal, making a save or demolishing a car."}]},{"type":"element","tag":"pre","props":{"code":"    // Hooks different types of events that are handled in onStatTickerMessage\n    // See https://wiki.bakkesplugins.com/functions/stat_events/\n    gameWrapper->HookEventWithCallerPost<ServerWrapper>(\"Function TAGame.GFxHUD_TA.HandleStatTickerMessage\",\n        [this](ServerWrapper caller, void* params, std::string eventname) {\n            onStatTickerMessage(params);\n        });\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Hooks different types of events that are handled in onStatTickerMessage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // See https://wiki.bakkesplugins.com/functions/stat_events/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    gameWrapper->HookEventWithCallerPost"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ServerWrapper"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Function TAGame.GFxHUD_TA.HandleStatTickerMessage\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"ServerWrapper"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" caller"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" params"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" eventname"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"            onStatTickerMessage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(params);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        });\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"handling-events-and-building-the-prompt"},"children":[{"type":"text","value":"Handling events and building the prompt"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can unpack values from the event to determine the player to which the event should be attributed. The code then translates the game event and related data into an English sentence. This is appended to a vector of message objects with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"appendToPrompt"}]},{"type":"text","value":" method."}]},{"type":"element","tag":"pre","props":{"code":"    // handle different events like scoring a goal or making a save\n    if (statEvent.GetEventName() == \"Goal\") {\n\n        // was the goal scored by the human player or the bot?\n        if (playerPRI.memory_address == receiver.memory_address) {\n            appendToPrompt(\"Your human opponent just scored a goal against you! \" + score_sentence, \"user\");\n        }\n        else {\n            appendToPrompt(\"You just scored a goal against the human player! \" + score_sentence, \"user\");\n        }\n    }\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // handle different events like scoring a goal or making a save\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (statEvent."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"GetEventName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Goal\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // was the goal scored by the human player or the bot?\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (playerPRI.memory_address "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" receiver.memory_address) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"            appendToPrompt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Your human opponent just scored a goal against you! \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" score_sentence, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"user\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        else"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"            appendToPrompt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"You just scored a goal against the human player! \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" +"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" score_sentence, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"user\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"making-requests-and-handling-responses"},"children":[{"type":"text","value":"Making requests and handling responses"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The last main part of the code is making a request to the LLM server with the prompt that we have formed above based on game messages. This code should look familiar to anyone who has worked with OpenAI's API."}]},{"type":"element","tag":"pre","props":{"code":"std::string message = response_json[\"choices\"][0][\"message\"][\"content\"];\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string message "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" response_json["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"choices\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"message\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"content\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"];\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"LogToChatbox"}]},{"type":"text","value":" method is used to send a message to the in-game chat box with the name of the bot that is sending the message. Since messages could possibly be longer than the limit of 120 characters, I send messages to the chatbox in chunks of 120 characters at a time."}]},{"type":"element","tag":"pre","props":{"code":"gameWrapper->LogToChatbox(messages[i], this->bot_name);\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"gameWrapper->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"LogToChatbox"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(messages[i], "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"->bot_name);\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's it! The code isn't that complicated. I had to sanitize the message so that it would not include emoji or the stop character that the LLM server would include in messages ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"</s>"}]},{"type":"text","value":"). Oddly, I had a hard time getting the LLM to not use emoji even when I instructed it to not use emoji in the system prompt."}]},{"type":"element","tag":"h2","props":{"id":"rocket-league-botchat-ui"},"children":[{"type":"text","value":"Rocket League BotChat UI"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most BakkesMod plugins for RocketLeague UIs that allow for controlling settings. Here's what the UI for Rocket League BotChat looks like:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Rocket League BotChat Plugin UI","src":"/static/rlbc/rlbcui.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"system-prompt"},"children":[{"type":"text","value":"System prompt"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The system prompt instructs the bot on how it shoud reply. This is an important part of the prompt engineering for this project, and I used Postman to experiment with lots of different types of instructions. Here's the default prompt that I used:"}]},{"type":"element","tag":"pre","props":{"code":"    std::string ai_player = \"You are an elite AI player in the car soccer game Rocket League. \";\n    std::string one_v_one = \"You are playing a 1v1 match against a human player. \";\n    std::string instructions = \"You will send short chat messages to your human opponent in response to what happens in the game. \";\n    std::string details = \"Respond to the human player with brief messages no more than 12 words long.\";\n    // initial system prompt\n    std::string initial_system_prompt = ai_player + one_v_one + instructions + details;\n","language":"cpp","meta":"","className":"language-cpp shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"    std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string ai_player "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"You are an elite AI player in the car soccer game Rocket League. \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"    std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string one_v_one "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"You are playing a 1v1 match against a human player. \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"    std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string instructions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"You will send short chat messages to your human opponent in response to what happens in the game. \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"    std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string details "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Respond to the human player with brief messages no more than 12 words long.\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // initial system prompt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"    std"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"::string initial_system_prompt "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ai_player "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" one_v_one "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" instructions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" details;\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The last part about "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"no more than 12 words long"}]},{"type":"text","value":" was the most effective way of controlling the length responses from the LLM. I tried changing the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max_output_len"}]},{"type":"text","value":" when building the TensorRT engine, but this degraded the quality of the responses. The system prompt can be changed by the user. Changing the system prompt was a lot of fun to expirment with!"}]},{"type":"element","tag":"h3","props":{"id":"temperature-and-seed"},"children":[{"type":"text","value":"Temperature and Seed"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These values are included in the body of the request to the LLM, but I didn't have much luck with these. Early on I had issues with getting sufficient variation in the responses from the LLM, so I tried using random values for seed and temperature, but this didn't really work."}]},{"type":"element","tag":"h3","props":{"id":"messages"},"children":[{"type":"text","value":"Messages"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section of the UI displays the messages that are used in requests to the LLM. In order keep the prompt within the context window limit, I only used the most recent six messages sent from the \"user\" (which are messages about game events) and the \"assistant\" (which are LLM responses from the bot). Whenever the user changes the system prompt, the messages vector is reset to only include the new system prompt."}]},{"type":"element","tag":"h2","props":{"id":"demo-video-for-contest-submission"},"children":[{"type":"text","value":"Demo Video for Contest Submission"}]},{"type":"element","tag":"rocket-league-bot-chat-video","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I used Blender's sequence editor to create a demo video for my contest submission. I don't edit a lot of videos, but it is a fun process and I learned a lot about Blender and non-linear video editing in the process. Here's how I approached creating the demo video for my project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Blender video sequence editor UI used to create my project video","src":"/static/rlbc/blender.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Structure the video in three main parts: introduction to my project and the contest, description of how it works, demo of my project in action"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Find an upbeat song from playlists included in Rocket League with no vocals to use as background music. I used "},{"type":"element","tag":"a","props":{"href":"https://open.spotify.com/track/68ahXxPJrxcEvQFjRmC2ja?si=2147d6d652064d51","rel":["nofollow"]},"children":[{"type":"text","value":"\"Dads in Space\" by Steven Walking"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Get stock Rocket League footage from YouTube with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"youtube-dl"}]},{"type":"text","value":" (this is an amazing tool!). I mostly used footage from the "},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=e1tqWldCYOI&pp=ygUQcmxjcyB3aW50ZXIgMjAyMw%3D%3D","rel":["nofollow"]},"children":[{"type":"text","value":"RLCS 2023 Winter Major Trailer"}]},{"type":"text","value":". This video was uploaded at 24 fps, and my Blender Video project frame rate was set to 29.97, so I used ffmpeg to convert this video from 24 fps to 29.97 fps."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Record myself playing Rocket League with my plugin enabled using NVIDIA Share. Miraculously, I was able to score against the Nexto bot!"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use ComfyUI to animate some of the images used in the contest description and use these in my video"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"ComfyUI workflow for animating images using img2vid model","src":"/static/rlbc/comfyui.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use ElevenLabs to narrate a simple voice over script that describes the video content. This tuned out a lot better than I expected. I paid $1 for the ElevenLabs creator plan and got lots of tokens to experiment with different settings for voice generation using a clone of my voice."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Eleven Labs Voice Generation Web UI","src":"/static/rlbc/elevenlabs.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#"},"children":[{"type":"text","value":"Embed twitter video here"}]}]},{"type":"element","tag":"h2","props":{"id":"shortcomings-of-my-project"},"children":[{"type":"text","value":"Shortcomings of my project"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin is a proof of concept and it has some shortcomings. One issue is that some events that my plugin listens to can happen in rapid succession. This results in \"user\" and \"assistant\" prompts getting out of order which breaks assertions on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"trt-llm-as-openai-windows"}]},{"type":"text","value":" repo. It would make more sense to have the bot send messages not immediately after the events are triggered, but on a different type of schedule that allows for multiple events to happen before sending the prompt to the LLM."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are lots of events that are triggered that would be interesting things for the bot to react to, but I decided not to prompt on every event since the above situation would be triggered frequently. For example, suppose I listen for events like taking a shot on goal and scoring a goal. If the goal is scored immediately after the shot is taken, then the second prompt is sent before the response for the first prompt comes back. For this reason I decided to simply not listen to events like \"shot on goal\" to avoid prompt messages getting out of order. This could also be addressed with more code logic."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Prompt engineering is something that can always be improved. It is hard to measure and testing it is subjective. I am pleased with the results I was able to capture for the demo video, but the quality of the LLM responses can very depending on what happens during gameplay. One idea I had to address this would be to provide multiple English translations for any given event, and then select one at random. This might help improve the variety of responses, for example."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I faced some limitations that are built in to the game iteself. For example, it is not possible for a player to send messages to the in-game chat in offline matches, which makes sense! I built a backdoor for doing this through the BakkesMod developer console, so you can send messages to the bot by typing something like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SendMessage Good shot, bot!"}]},{"type":"text","value":", for example."}]},{"type":"element","tag":"h2","props":{"id":"whats-next"},"children":[{"type":"text","value":"What's next?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Participating in this contest was a great opportunity to learn more about LLMs and how to use them to extend programs in a Windows environment. It was also a lot of fun to build something by putting together new tools like TensorRT-LLM. Seeing the bot send me chat messages was very satisfying when I first got it to work! Overall it is a pretty simple implementation, but this idea could be extended to produce useful application. I could imagine a \"Rocket League Coach\" plugin that expands on this idea to give helpful feedback based on higher-level data, statistical trends, training goals, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think the gaming industry's adoption of LLMs for new games will be BIG, and it will present a huge opportunity for LLM optimization and acceleration software like TensorRT-LLM that I was able to use in my Rocket League BotChat. This is not to discredit the work of writers which play an important role in game development. I'm excited to see what other developers have built for this contest, especially submissions that are building mods for games using TensorRT-LLM."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks NVIDIA and the TensorRT and TensorRT-LLM teams for organizing this contest! Keep on building!!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"nvidias-gen-ai-developer-contest","depth":2,"text":"NVIDIA's Gen AI Developer Contest"},{"id":"coming-up-with-an-idea","depth":2,"text":"Coming up with an Idea"},{"id":"putting-together-the-puzzle-pieces","depth":2,"text":"Putting together the puzzle pieces"},{"id":"development-environment","depth":2,"text":"Development environment","children":[{"id":"building-the-tensorrt-llm-engines","depth":3,"text":"Building the TensorRT-LLM engines"},{"id":"running-the-tensorrt-llm-engines","depth":3,"text":"Running the TensorRT-LLM engines"}]},{"id":"how-it-works","depth":2,"text":"How it works","children":[{"id":"hooking-events","depth":3,"text":"Hooking events"},{"id":"handling-events-and-building-the-prompt","depth":3,"text":"Handling events and building the prompt"},{"id":"making-requests-and-handling-responses","depth":3,"text":"Making requests and handling responses"}]},{"id":"rocket-league-botchat-ui","depth":2,"text":"Rocket League BotChat UI","children":[{"id":"system-prompt","depth":3,"text":"System prompt"},{"id":"temperature-and-seed","depth":3,"text":"Temperature and Seed"},{"id":"messages","depth":3,"text":"Messages"}]},{"id":"demo-video-for-contest-submission","depth":2,"text":"Demo Video for Contest Submission"},{"id":"shortcomings-of-my-project","depth":2,"text":"Shortcomings of my project"},{"id":"whats-next","depth":2,"text":"What's next?"}]}},"_type":"markdown","_id":"content:2024:02:17:rocket-league-botchat-nvidia-generative-ai-on-rtx-pcs-developer-contest.md","_source":"content","_file":"2024/02/17/rocket-league-botchat-nvidia-generative-ai-on-rtx-pcs-developer-contest.md","_stem":"2024/02/17/rocket-league-botchat-nvidia-generative-ai-on-rtx-pcs-developer-contest","_extension":"md"},{"_path":"/2023/08/27/python-vue-chinese-llama-2-and-the-three-body-problem","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"Python, Vue, Chinese-LLaMA-2 and The Three-Body Problem","description":"Translating The Three-Body Problem book to English with Chinese LLMs, making visualizations with stable diffusion and running n-body simulations with CUDA","date":"2023-11-23","image":"/static/three-body-problem/cover.png","tags":["three-body-problem","llama","llm","ai","chinese","python","nvidia","cuda","gpu","stable-diffusion","langchain","vue","three.js"],"external":[{"link":"https://news.ycombinator.com/item?id=38393757","site":"hn"},{"link":"https://www.reddit.com/r/threebodyproblem/comments/1823l5j/python_vue_chinesellama2_and_the_threebody_problem/","site":"reddit"},{"link":"https://twitter.com/briancaffey/status/1727710878349332614","site":"x"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This articles brings together several of my interest, both old and new:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Sci-Fi book series 'Three-Body Problem' by Liu Cixun"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese language"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"NLP techniques"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Large Language Models (LLMs)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Stable Diffusion"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Data visualization and 3D graphics"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Mathematics"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"NVIDIA / CUDA"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a linguistic, artistic and computational experiment with the two big AI algorithms of 2023: large language models (LLMs) and Stable Diffusion. I used the leading open-source LLMs from China‚Äôs tech sector to translate and summarize the text of Chinese author Liu Cixin‚Äôs award-winning science fiction novel: The Three-Body Problem. The book's storyline is based on a simple yet elusive problem from classical physics: predicting the movement of three gravitationally-attracted objects in space. I generated code for simulations and visualizations of this physics problem to present my own solutions to the three-body problem based on parallel computation. I also used Stable Diffusion to portray the imaginitive solutions to the three-body physics problem from one of the book‚Äôs main settings: an immersive virtual-reality game that spans centries of world history."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I also share some of my experiences in China as an exchange student and research manager in the renewable energy technology sector. I wrote this article in English and translated it into Chinese using the same large language models I used to translate the Chinese text of the sci-fi novel into English. Warning: this article contains spoilers for the first book in the trilogy!"}]},{"type":"element","tag":"h2","props":{"id":"back-story"},"children":[{"type":"text","value":"Back story"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A few months ago my company announced that another round of layoffs was to come the following week. I'm on an engineering team that had already been impacted by a few rounds of layoffs in the past year, and I was expecting to be let go. On an impulse I bought a book at the top of my reading list from Amazon: \"Three-Body Problem\". It is an award-winning Sci-Fi trilogy written by Liu Cixin, a Chinese computer engineer who started writing the book as a series of essays that were published in China's \"World of Sci-Fi\" magazine."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Images of Three Body Problem Book Series","src":"/static/three-body-problem/books.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I started learning Chinese in college, adding a major in Chinese Language to the mathematics major I decided on in my freshman year after taking vector calculus and linear algebra. In my sophmore year I did a semester abroad at Fudan University's "},{"type":"element","tag":"a","props":{"href":"https://ices.fudan.edu.cn/6628/list.htm","rel":["nofollow"]},"children":[{"type":"text","value":"International Cultural Exchange School"}]},{"type":"text","value":". In 2007, living and studying Chinese in Shanghai as a 19 year old American was a really fun time. I was placed in an advanced-level course with a diverse group of students where English was not the lowest common linguistic denominator. We had a demanding cirriculum that emphasized reading, listening and speaking Chinese, but most of the language learning came through extracirricular activities: exploring Shanghai's food scene, bartering with vendors at the fabric markets, late night clubbing, walking around the Bund and the French Concession and chatting with my taxi cab drivers. It is hard to imagine how I did this without an iPhone, but I was able to get pretty far with an old Nokia 3310."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At the end of one night of particularly heavy drinking, some of my classmates and I dropped in on an wangba (internet cafe) before heading back to the international dorm. Chinese internet cafes in 2007 were an expansive underground dens of computers, monitors, MMORPGs, FPSs, cigarets, and on-demand instant noodles delivered directly to your seat through an app on the desktop. That night our game of choice was Counter-Strike. In one of the lowest points of my gaming career, my classmates and I were crushed by our Chinese counterterrorist opponent."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Chinese internet cafe","src":"/static/three-body-problem/wangba.webp"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My favorite memory of that semester at Fudan University was travelling on an epic over-night sleeper train from Shanghai to Guangxi province with a school-sponsored class trip to see Guilin. Multiple games of sam-yuk-gu (3-6-9) ran in parallel across the matrix of 3-by-2 sleeper car bunk beds lining the train car like workloads distributed across multiple GPU cores. The rules of 3-6-9 are simple: a group of people go around in a circle counting up from 1. If your number contains a 3, 6 or 9, you clap once for each occurance of the number instead of saying your number. The first person to break the rules takes a drink. Then repeat indefinitely. The next morning we all boarded a boat cruise in a daze to see the Lijiang river's stunning limestone peaks featured on the 20 yuan note:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"20 yuan note with Guilin rock formations","src":"/static/three-body-problem/twenty_small.gif"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My second job after college took me back to China where I specialized in the technologies, policies and applications of large scale battery projects as a research manager for China's energy storage industry association. The job exposed me to the power industry and cutting-edge battery projects, and also sharpened my technical Chinese as I was frequently reading, translating in a bi-linguagl environment. It was fun  I didn't realize it at the time, but that job was great preperation for reading Chinese Sci-Fi novels."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"State Grid HQ in Xi Cheng","src":"/static/three-body-problem/invokeai/castles.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My first introduction to the 'Three-Body Problem' book came from one of my best friends from college. He lived at the inner-most leaf-node of one of Beijing's most labrythnian hutongs next to a family that trained racing pigeons. My friend and I bonded over our study of Chinese language, classical guitar and our experiences in Beijing. I strongly considered his recommendation to check out ‰∏â‰Ωì (Three Body), the Chinese Sci-Fi novel about alien life in a solar system with three stars as he described it, but I never had the chance to read the book."}]},{"type":"element","tag":"iframe","props":{"width":"100%","height":315,"src":"https://www.youtube.com/embed/5lj99Uz1d50?si=TwrypbY4vTfeWGRf","title":"YouTube video player","frameBorder":"0","allow":"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share","allowFullScreen":true},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Almost 10 years later I came across across a preview for the Netflix production of \"3 Body Problem\" scheduled to come out in early 2024. With the possibility of loosing my job weighing heavily on me, I picked up the books on Amazon hoping to have something to if I was going to be layed off. Over the weekend I was able to read a few of the chapters on my Kindle. I had not completely forgotten how to speak Chinese, and I could easily look up words and translate entire paragraphs with Google Translate."}]},{"type":"element","tag":"h2","props":{"id":"chinese-in-numbers"},"children":[{"type":"text","value":"Chinese in numbers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick primer on the Chinese language from a mathematical perspective. This will be helpful before jumping into using NLP and LLMs with Chinese text later in this article."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, how many Chinese characters are there? This question isn't specific enough to have a single answer. A common rule of thumb that I have heard before says that there are over 50,000 characters in total with roughly 10,000 characters in use and about 3,000 characters frequently used in Chinese media and newspapers ("},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Chinese_language#Vocabulary","rel":["nofollow"]},"children":[{"type":"text","value":"source"}]},{"type":"text","value":"). "},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/a/1366113/6084948","rel":["nofollow"]},"children":[{"type":"text","value":"This answer"}]},{"type":"text","value":" from StackOverflow's legendary #1 ranked user VonC gives a good answer based on the number of Unicode characters in the CJK Unified Ideographs block: 20,992."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some numbers and statistics to be better understand the text of the Three-Body Problem Chinese text:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"188,380 total charactes in the book"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"2,859 unique characters in the book"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"36 chapters in the book"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"average of 69.78 paragraphs per chapter"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"total of 2,512 paragraphs in the book"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"average of 74.99 characters per paragraph"}]}]},{"type":"element","tag":"h3","props":{"id":"character-frequency"},"children":[{"type":"text","value":"Character Frequency"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's look at how frequently each character in the book is used. We can also combine this with some data on the overall frequency of Chinese characters. The best measurement I found for overall character frequency is from "},{"type":"element","tag":"a","props":{"href":"https://lingua.mtsu.edu/chinese-computing/statistics/char/list.php?Which=MO","rel":["nofollow"]},"children":[{"type":"text","value":"Middle Tennessee State University"}]},{"type":"text","value":". Here's a visualization that shows of all of unique characters in the book. The height of a column represents how frequently a character occurs in the book, and the color represents the relatively frequency of the character in Chinese language overall."}]},{"type":"element","tag":"div","props":{"className":["wrap"]},"children":[{"type":"element","tag":"iframe","props":{"className":["p-4"],"src":"https://briancaffey.github.io/three-body-problem/tjs/load.html","width":"100%","height":550},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"meta-llms-and-grass-mud-horse"},"children":[{"type":"text","value":"Meta, LLMs, and Grass Mud Horse"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In recent months I have been following the development of big open source AI projects. Two projects in particular are InvokeAI, an image generation tool based on Stable Diffusion, and "},{"type":"element","tag":"a","props":{"href":"https://ai.meta.com/llama/","rel":["nofollow"]},"children":[{"type":"text","value":"LLaMA 2"}]},{"type":"text","value":", the latest generation of Meta's open source LLM. The name LLaMA stands for 'Large Language Model Meta AI', which happens to be the same spelling as the word for the domesticated South American camelid: llama. Before going deeper into LLMs we need a quick Chinese lesson."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ËçâÊ≥•È©¨ is a non-technical word that referes to animals like Llama or Alpaca. It can be directly translated as \"Grass Mud Horse\" and it is phonetically similar to the most common Chinese profanity: Êìç‰Ω†Â¶à, which literally means \"f*** your mother\". The characters in these two words are nearly synonymous: the sounds of both words are \"cao ni ma\", but the tones are different, which in Chinese changes the meaning completely. The llama is basically a legendary Chinese internet meme subversive in the face of government censorship. ü¶ô was approved as part of Unicode 11.0 in 2018. The extended version of this profanity is ËçâÊ≥•È©¨ÊààÂ£Å (C«éon√≠m«é Gƒìb√¨: Grass Mud Horse Gobi), refering to the geographical origin of this mythical creature: the Gobi Dessert. This term is more explicit as it synonymous with \"f*** your mother's c***\". Coincidentally, the Gobi Desert is a region of Inner Mongolia which borders the mountainous region of Greater Khingan Range (Â§ßÂÖ¥ÂÆâÂ≤≠), the location of Red Coast and Radar Peak in Three-Body Problem where Ye Wenjie makes first contact with the Trisolarians."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I requested access to Meta's LLaMa 2 models as soon as they came out and I was able to get it to run on my NVIDIA RTX 4090 GPU. I also joined a subreddit called "},{"type":"element","tag":"a","props":{"href":"https://www.reddit.com/r/LocalLLaMA/","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"r/LocalLLaMa"}]}]},{"type":"text","value":" with over seventy thousand members discussing how to run large language models on consumer hardware. Another annoucement that caught my attention in July was the release of "},{"type":"element","tag":"a","props":{"href":"https://github.com/ymcui/Chinese-LLaMA-Alpaca-2","rel":["nofollow"]},"children":[{"type":"text","value":"Chinese LLaMa 2"}]},{"type":"text","value":", an open-source large language model trained on Chinese and English which does very well against Chinese Language LLM Benchmarks such as the CMMCU: Chinese Massive Multitask Language Understanding."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image of CMMLU","src":"/static/three-body-problem/cmmlu.jpeg"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"translation-in-and-of-the-three-body-problem"},"children":[{"type":"text","value":"Translation in and of The Three-Body Problem"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two important plot developments related to language translation in the Three-Body Problem novel, both of which involve book‚Äôs main female protagonist Ye Wenjie. First, copying the translation of Rachel Carson's 'Silent Spring' leads to her being relegated to the Red Coast project. At the Red Coast Ye Wenjie communicates with extraterrestrial life through a universal translation technology developed by the top-secret project."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ken Liu‚Äôs translation of the Three-Body Problem book from Chinese to English places the events during the Cultural Revolution at the beginning of the book rather than in the middle of the book. According to Liu, this was done in order to avoid attention of government censors, and his original intention was to tell the story in this way, starting with the events of the late 1960's in China."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I tried translating the Chinese text of the Three-Body Problem book using LLMs. I started with the Chinese-LLaMA-2 model and then tried Qwen-7B-Chat, Baichuan-13B-Chat when these models came out. I found that the Qwen-7B-Chat model worked best for my translation tasks. Qwen is short for Qian Wen (ÂçÉÈóÆ, or \"one thousand questions\") and is developed by Alibaba Cloud."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"How do you get an LLM to translate text? Ultimately the quality of the translation returned by the LLM depends on the prompt and other parameters used for inference. I experimented with both chat and completion approaches and tried lots of different kinds of prompts. The models I worked with have a 4K context window (the number of tokens the model can take as input when generating responses), so for translation tasks I had the LLM work on one paragraph at a time. Here's the prompt I used with the Qwen-7B-Chat model:"}]},{"type":"element","tag":"pre","props":{"code":"\"‰Ω†ÊòØ‰∏ÄÂêçÁøªËØë„ÄÇËØ∑Â∞ÜÊØèÊù°Ê∂àÊÅØ‰ªé‰∏≠ÊñáÁøªËØëÊàêËã±Êñá„ÄÇ\"\n(You are a translator. Please translate each message from Chinese to English.)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\"‰Ω†ÊòØ‰∏ÄÂêçÁøªËØë„ÄÇËØ∑Â∞ÜÊØèÊù°Ê∂àÊÅØ‰ªé‰∏≠ÊñáÁøªËØëÊàêËã±Êñá„ÄÇ\"\n(You are a translator. Please translate each message from Chinese to English.)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I did some basic prompt engineering to get the LLM to translate the books in the Three-Body problem paragraph by paragraph. My computer was able to translate the first book overnight in under 500 minutes. Here are the results of my translation of Three-Body Problem with Qwen-7B-Chat model:"}]},{"type":"element","tag":"iframe","props":{"className":["p-4"],"src":"https://briancaffey.github.io/three-body-problem/reader/?book=three_body&chapterNumber=1","width":"100%","height":550},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It was interesting to see the failure modes of translation tasks for the different models. Most of the time the LLM was able to provided accurate translations. Some of the failure modes I observed were:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a few Chinese characters would show up in the English translations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a complete Chinese sentence would show up in an otherwise complete translation of a paragraph"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The LLM refused to translate certain paragraphs that included violent imagery, such as the violent scenes from the Cultural Revolution chapters"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If the sentence it was asked to translate was a question, the LLM would respond in Chinese to the question rather than providing a translation of the question itself"}]}]},{"type":"element","tag":"h3","props":{"id":"tokenization"},"children":[{"type":"text","value":"Tokenization"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you feed a prompt to an LLM, it first puts the prompt through a process called tokenization. Tokenization takes a string of text and breaks it down into tokens (defined by the Large Language Model you are using). The process of tokenization is similar to the tokenization done by spaCy mentioned earlier. These tokens produced by LLM tokenization are numbers. Here's an example of tokenization in action using the Chinese-Llama-2 model:"}]},{"type":"element","tag":"pre","props":{"code":"import json\nimport os\nfrom llama_cpp import Llama, LlamaTokenizer\n\nllm = Llama(\n    model_path=\"/path/to/models/ggml-model-q4_0.bin\",\n    n_ctx=4096,\n    n_gpu_layers=30\n)\n\ntokenizer = LlamaTokenizer(llama=llm)\n\nTEXT=\"Âú®ÈÇ£‰∏™Â∑≤Ë¢´ÂøòÂç¥ÁöÑÊó•Â≠êÈáåÔºåÂÆÉÁöÑ‰∏ñÁïåÈ¢†Ë¶Ü‰∫Ü„ÄÇÊ≥•ÂúüÈ£ûËµ∞ÔºåÂá∫Áé∞‰∫Ü‰∏ÄÊù°ÂèàÊ∑±ÂèàÂÆΩÁöÑÂ≥°Ë∞∑ÔºåÁÑ∂ÂêéÊ≥•ÂúüÂèàËΩ∞ÈöÜÈöÜÂú∞È£ûÂõûÊù•ÔºåÂ≥°Ë∞∑Ê∂àÂ§±‰∫ÜÔºåÂú®ÂéüÊù•Â≥°Ë∞∑ÁöÑÂ∞ΩÂ§¥Âá∫Áé∞‰∫Ü‰∏ÄÂ∫ßÈªëËâ≤ÁöÑÂ≠§Â≥∞„ÄÇÂÖ∂ÂÆûÔºåÂú®ËøôÁâáÂπøÈòîÁöÑÁñÜÂüü‰∏äÔºåËøôÁßç‰∫ãÂ∏∏Â∏∏ÂèëÁîüÔºåÊ≥•ÂúüÈ£ûËµ∞ÂèàÈ£ûÂõûÔºåÂ≥°Ë∞∑Âá∫Áé∞ÂèàÊ∂àÂ§±ÔºåÁÑ∂ÂêéÊòØÂ≠§Â≥∞Èôç‰∏¥ÔºåÂ•ΩÂÉèÊòØÁªôÊØèÊ¨°ÁÅæÂèòÊâì‰∏ä‰∏Ä‰∏™ÈÜíÁõÆÁöÑÊ†áËÆ∞„ÄÇË§êËöÅÂíåÂá†Áôæ‰∏™ÂêåÊóèÂ∏¶ÁùÄÂπ∏Â≠òÁöÑËöÅÂêéÂêëÂ§™Èò≥ËêΩ‰∏ãÁöÑÊñπÂêëËµ∞‰∫Ü‰∏ÄÊÆµË∑ØÔºåÂª∫Á´ã‰∫ÜÊñ∞ÁöÑÂ∏ùÂõΩ„ÄÇ\"\ntokens = tokenizer.encode(TEXT)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" os\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" llama_cpp "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Llama, LlamaTokenizer\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"llm "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Llama(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    model_path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"/path/to/models/ggml-model-q4_0.bin\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    n_ctx"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4096"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    n_gpu_layers"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"30\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tokenizer "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" LlamaTokenizer("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"llama"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"llm)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"TEXT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Âú®ÈÇ£‰∏™Â∑≤Ë¢´ÂøòÂç¥ÁöÑÊó•Â≠êÈáåÔºåÂÆÉÁöÑ‰∏ñÁïåÈ¢†Ë¶Ü‰∫Ü„ÄÇÊ≥•ÂúüÈ£ûËµ∞ÔºåÂá∫Áé∞‰∫Ü‰∏ÄÊù°ÂèàÊ∑±ÂèàÂÆΩÁöÑÂ≥°Ë∞∑ÔºåÁÑ∂ÂêéÊ≥•ÂúüÂèàËΩ∞ÈöÜÈöÜÂú∞È£ûÂõûÊù•ÔºåÂ≥°Ë∞∑Ê∂àÂ§±‰∫ÜÔºåÂú®ÂéüÊù•Â≥°Ë∞∑ÁöÑÂ∞ΩÂ§¥Âá∫Áé∞‰∫Ü‰∏ÄÂ∫ßÈªëËâ≤ÁöÑÂ≠§Â≥∞„ÄÇÂÖ∂ÂÆûÔºåÂú®ËøôÁâáÂπøÈòîÁöÑÁñÜÂüü‰∏äÔºåËøôÁßç‰∫ãÂ∏∏Â∏∏ÂèëÁîüÔºåÊ≥•ÂúüÈ£ûËµ∞ÂèàÈ£ûÂõûÔºåÂ≥°Ë∞∑Âá∫Áé∞ÂèàÊ∂àÂ§±ÔºåÁÑ∂ÂêéÊòØÂ≠§Â≥∞Èôç‰∏¥ÔºåÂ•ΩÂÉèÊòØÁªôÊØèÊ¨°ÁÅæÂèòÊâì‰∏ä‰∏Ä‰∏™ÈÜíÁõÆÁöÑÊ†áËÆ∞„ÄÇË§êËöÅÂíåÂá†Áôæ‰∏™ÂêåÊóèÂ∏¶ÁùÄÂπ∏Â≠òÁöÑËöÅÂêéÂêëÂ§™Èò≥ËêΩ‰∏ãÁöÑÊñπÂêëËµ∞‰∫Ü‰∏ÄÊÆµË∑ØÔºåÂª∫Á´ã‰∫ÜÊñ∞ÁöÑÂ∏ùÂõΩ„ÄÇ\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"tokens "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" tokenizer.encode("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"TEXT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"pre","props":{"code":"print(str(tokens[:4]) + \" ...\")\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"print(str(tokens[:4]) + \" ...\")\n"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1, 30505, 32380, 36812"}]},{"type":"text","value":" ..."}]}]},{"type":"element","tag":"pre","props":{"code":"for token in tokens:\n    text = tokenizer.decode([token])\n    print(text, end=\" \")\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"for token in tokens:\n    text = tokenizer.decode([token])\n    print(text, end=\" \")\n"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Âú® ÈÇ£‰∏™ Â∑≤Ë¢´ Âøò Âç¥ ÁöÑÊó•Â≠ê Èáå Ôºå ÂÆÉÁöÑ ‰∏ñÁïå È¢†Ë¶Ü ‰∫Ü „ÄÇ Ê≥• Âúü È£û Ëµ∞ Ôºå Âá∫Áé∞‰∫Ü ‰∏ÄÊù° Âèà Ê∑± Âèà ÂÆΩ ÁöÑ Â≥°Ë∞∑ Ôºå ÁÑ∂Âêé Ê≥• Âúü Âèà ËΩ∞ ÈöÜ ÈöÜ Âú∞ È£û ÂõûÊù• Ôºå Â≥°Ë∞∑ Ê∂àÂ§± ‰∫Ü Ôºå Âú® ÂéüÊù• Â≥°Ë∞∑ ÁöÑ Â∞ΩÂ§¥ Âá∫Áé∞‰∫Ü ‰∏ÄÂ∫ß ÈªëËâ≤ ÁöÑ Â≠§ Â≥∞ „ÄÇ ÂÖ∂ÂÆû Ôºå Âú®Ëøô Áâá ÂπøÈòî ÁöÑ ÁñÜ Âüü ‰∏ä Ôºå ËøôÁßç‰∫ã Â∏∏Â∏∏ ÂèëÁîü Ôºå Ê≥• Âúü È£û Ëµ∞ Âèà È£û Âõû Ôºå Â≥°Ë∞∑ Âá∫Áé∞ Âèà Ê∂àÂ§± Ôºå ÁÑ∂Âêé ÊòØ Â≠§ Â≥∞ Èôç‰∏¥ Ôºå Â•ΩÂÉèÊòØ Áªô ÊØèÊ¨° ÁÅæ Âèò Êâì ‰∏ä ‰∏Ä‰∏™ ÈÜíÁõÆ ÁöÑ Ê†áËÆ∞ „ÄÇ Ë§ê ËöÅ Âíå Âá†Áôæ ‰∏™ Âêå Êóè Â∏¶ÁùÄ Âπ∏ Â≠ò ÁöÑ ËöÅ Âêé Âêë Â§™Èò≥ ËêΩ ‰∏ãÁöÑ ÊñπÂêë Ëµ∞‰∫Ü ‰∏ÄÊÆµ Ë∑Ø Ôºå Âª∫Á´ã‰∫Ü Êñ∞ÁöÑ Â∏ùÂõΩ „ÄÇ"}]}]},{"type":"element","tag":"pre","props":{"code":"english_text = \"This is an example of tokenization using a large language model.\"\nenglish_tokens = tokenizer.encode(english_text)\nprint(str(english_tokens[:4]) + \" ...\")\n\nfor token in english_tokens:\n    text = tokenizer.decode([token])\n    print(f\"'{text}'\", end=\" \")\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"english_text "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"This is an example of tokenization using a large language model.\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"english_tokens "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" tokenizer.encode(english_text)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"str"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(english_tokens[:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \" ...\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" token "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" english_tokens:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    text "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" tokenizer.decode([token])\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"    print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"end"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1, 4013, 338, 385"}]},{"type":"text","value":" ..."}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"'' 'This' ' is' ' an' ' example' ' of' ' token' 'ization' ' using' ' a' ' large' ' language' ' model' '.'"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some key differences between English and Chinese that have implications for how the language is tokenized by large language models:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese does not use spaces between words like English does"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese words are typically formed from 2 or more characters"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese verbs are not conjugated and do not have different tenses"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese words don't have singular and plural variants"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese grammar is very simple and is similar to English"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Chinese characters do not have capitization like ASCII characters"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The token represented by the number 1 encodes a starting token"}]}]},{"type":"element","tag":"h2","props":{"id":"imagining-scenes-from-three-body-problem-with-stable-diffusion"},"children":[{"type":"text","value":"Imagining scenes from Three-Body Problem with Stable Diffusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some images I generated using Stable Diffusion with InvokeAI that depict scenes from the Three-Body Problem book. These scenes portray solutions to the Three-Body Problem that players in the Three-Body game devised. The first is a Confucian system of etiquette for predicting the movement of the three suns. The second is a human-powered computer that Qin Shi Huang used to try to predict the movement of the three suns."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Prompt: Ceremonies and etiquette system related to the sun and multiple celestial++ bodies Confucius artistic style"}]}]},{"type":"element","tag":"client-only","props":{},"children":[{"type":"element","tag":"carousel","props":{":count":"8","dir":"confucius"},"children":[]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"array of chinese++ warriors++ on a electronics+ circuit+ board qing+ dynasty style art logic puzzle"}]}]},{"type":"element","tag":"client-only","props":{},"children":[{"type":"element","tag":"carousel","props":{":count":"5","dir":"computer"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Congrats to the InvokeAI team on the 3.0 release. It has been awesome to use and the current docker compose setup is a huge improvement on the 2.x version."}]},{"type":"element","tag":"h2","props":{"id":"n-body-simulations-cuda-and-threejs"},"children":[{"type":"text","value":"n-body simulations, CUDA and Three.js"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The nbody problem has no closed-form analytical solution, but it is possible to do a basic simulation of the three-body problem on consumer hardware and open source software, like NVIDIA and CUDA."}]},{"type":"element","tag":"h3","props":{"id":"three-body-cuda-simulation"},"children":[{"type":"text","value":"Three-Body CUDA simulation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I wrote a simple program with the help of ChatGPT for running nbody problem simulations. The program uses CuPy, a Python library that exposes APIs for doing matrix multiplication to predict the position of three bodies using Euclidian Integration. Here's the script:"}]},{"type":"element","tag":"pre","props":{"code":"import numpy as np\nimport cupy as cp\nimport time\nimport json\n\n# Simulation parameters\nNUM_PARTICLES = 3\nDIMENSIONS = 3 # 3D space\nNUM_STEPS = 30\nDT = 0.1\n\n# Generate initial positions and velocities\nnp_positions = np.random.randn(NUM_PARTICLES, DIMENSIONS)\nnp_velocities = np.random.randn(NUM_PARTICLES, DIMENSIONS)\n\ncp_positions = cp.array(np_positions)\ncp_velocities = cp.array(np_velocities)\n\nnp_ticks = np.expand_dims(np_positions, axis=0)\ncp_ticks = cp.array(np_ticks)\n\n# nbody simulation loop\nstart_time = time.time()\nfor step in range(NUM_STEPS):\n\n    # this gets pairwise differences\n    diff = cp_positions[:, None, :] - cp_positions[None, :, :]\n    distances = cp.sqrt(cp.sum(diff**2, axis=2))\n\n    # avoid division by zero\n    epsilon = 1e-5\n    inv_distances = 1.0 / cp.maximum(distances, epsilon)\n\n    # calculate forces\n    cp_forces = cp.sum((diff.T * inv_distances**3).T, axis=1)\n\n    # update velocities and positions\n    cp_velocities += DT * cp_forces\n    cp_positions += DT * cp_velocities\n    cp_ticks = cp.append(cp_ticks, cp.expand_dims(cp_positions, 0), 0)\n\nsim_time = time.time() - start_time\nprint(\"Simulation time:\", sim_time)\n\n\nclass NumpyArrayEncoder(json.JSONEncoder):\n    def default(self, obj):\n        if isinstance(obj, np.ndarray):\n            return obj.tolist()\n        return json.JSONEncoder.default(self, obj)\n\n\nnp_ticks = cp_ticks.get()\n\n\n# this is data we can work with in python and write to a file\nwith open(\"ticks.json\", \"w\") as f:\n    f.write(json.dumps(np_ticks, cls=NumpyArrayEncoder))\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" numpy "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" np\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cupy "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" time\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Simulation parameters\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"NUM_PARTICLES"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DIMENSIONS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":" # 3D space\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"NUM_STEPS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 30\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0.1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Generate initial positions and velocities\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"np_positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" np.random.randn("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"NUM_PARTICLES"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DIMENSIONS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"np_velocities "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" np.random.randn("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"NUM_PARTICLES"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"DIMENSIONS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.array(np_positions)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_velocities "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.array(np_velocities)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"np_ticks "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" np.expand_dims(np_positions, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"axis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_ticks "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.array(np_ticks)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# nbody simulation loop\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"start_time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" time.time()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" step "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" range"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"NUM_STEPS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # this gets pairwise differences\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    diff "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_positions[:, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", :] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_positions["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", :, :]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    distances "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.sqrt(cp.sum(diff"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"axis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # avoid division by zero\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    epsilon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1e-5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    inv_distances "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1.0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" /"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.maximum(distances, epsilon)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # calculate forces\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cp_forces "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.sum((diff.T "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" inv_distances"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").T, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"axis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    # update velocities and positions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cp_velocities "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_forces\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cp_positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_velocities\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cp_ticks "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.append(cp_ticks, cp.expand_dims(cp_positions, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"sim_time "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" time.time() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" start_time\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Simulation time:\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", sim_time)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" NumpyArrayEncoder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"json"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"JSONEncoder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" isinstance"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(obj, np.ndarray):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" obj.tolist()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" json.JSONEncoder.default("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", obj)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"np_ticks "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_ticks.get()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# this is data we can work with in python and write to a file\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"with"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" open"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"ticks.json\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"w\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" f:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    f.write(json.dumps(np_ticks, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"cls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"NumpyArrayEncoder))\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To better understand the matrix math here I walked through a simple example of what each step does:"}]},{"type":"element","tag":"pre","props":{"code":"# particle coordinates (x,y,z) in 3D space\npositions = cp.array([[1,2.5,3], [4,5,6], [7,8,9]])\n","language":"py","meta":"","className":"language-py shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# particle coordinates (x,y,z) in 3D space\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.array([["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2.5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"], ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]])\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first operation creates an array for pairwise distances for each dimension:"}]},{"type":"element","tag":"pre","props":{"code":"diff = positions[None, :, :] - positions[:, None, :]\nprint(diff)\n\narray([[[ 0. ,  0. ,  0. ],\n        [ 3. ,  2.5,  3. ],\n        [ 6. ,  5.5,  6. ]],\n\n       [[-3. , -2.5, -3. ],\n        [ 0. ,  0. ,  0. ],\n        [ 3. ,  3. ,  3. ]],\n\n       [[-6. , -5.5, -6. ],\n        [-3. , -3. , -3. ],\n        [ 0. ,  0. ,  0. ]]])\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"diff "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" positions["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", :, :] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" positions[:, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"None"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", :]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(diff)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"array([[[ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2.5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5.5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ]],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       [["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". , "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2.5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ]],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       [["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". , "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5.5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". , "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". , "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":". ]]])\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The rows of zeros correspond to a particle's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"x"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"y"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"z"}]},{"type":"text","value":" distances to itself, which are all zero by axioms of Euclidian vector spaces."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next operation calculates the distance between each particle:"}]},{"type":"element","tag":"pre","props":{"code":"distances = cp.sqrt(cp.sum(diff**2, axis=2))\nprint(distances)\n\narray([[ 0.        ,  4.9244289 , 10.11187421],\n       [ 4.9244289 ,  0.        ,  5.19615242],\n       [10.11187421,  5.19615242,  0.        ]])\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"distances "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.sqrt(cp.sum(diff"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"axis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(distances)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"array([[ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".        ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4.9244289"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" , "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10.11187421"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       [ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"4.9244289"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".        ,  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5.19615242"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"10.11187421"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5.19615242"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",  "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".        ]])\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The diagonal or zeros represents that fact that a particle "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"n"}]},{"type":"text","value":" has a distance of zero to iself."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next step calculates inverse distances and uses a small "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"epsilon"}]},{"type":"text","value":" value to avoid division by 0:"}]},{"type":"element","tag":"pre","props":{"code":"epsilon = 1e-5\ninv_distances = 1.0 / cp.maximum(distances, epsilon)\nprint(inv_distances)\n\narray([[1.00000000e+05, 2.03069233e-01, 9.88936353e-02],\n       [2.03069233e-01, 1.00000000e+05, 1.92450090e-01],\n       [9.88936353e-02, 1.92450090e-01, 1.00000000e+05]])\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"epsilon "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1e-5\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"inv_distances "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 1.0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" /"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.maximum(distances, epsilon)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"print"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(inv_distances)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"array([["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1.00000000e+05"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2.03069233e-01"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9.88936353e-02"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2.03069233e-01"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1.00000000e+05"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1.92450090e-01"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"],\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"       ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"9.88936353e-02"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1.92450090e-01"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1.00000000e+05"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"]])\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next step is the most elegant part of the simulation and really flexes the GPU's parallel compute capabilities:"}]},{"type":"element","tag":"pre","props":{"code":"cp_forces = cp.sum((diff.T * inv_distances**3).T, axis=1)\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_forces "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp.sum((diff.T "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" inv_distances"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"**"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").T, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"axis"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".T"}]},{"type":"text","value":" operation transposes a matrix, multiplies by the cube of inverse distances, then transposes the matrix again before summing along the first axis. Transposing a matrix basically swaps rows and columns."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The next two steps are also pretty elegant:"}]},{"type":"element","tag":"pre","props":{"code":"# update velocities and positions\ncp_velocities += DT * cp_forces\ncp_positions += DT * cp_velocities\n","language":"python","meta":"","className":"language-python shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# update velocities and positions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_velocities "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_forces\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cp_positions "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" DT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cp_velocities\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the last step I append the updated positions to an array that holds every \"tick\" (the positions of each particle between each time interval, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DT"}]},{"type":"text","value":" - \"delta time\")"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the formula for the mathematical equation used to calculate the force on any given body in an n-body system:"}]},{"type":"element","tag":"iframe","props":{"src":"https://briancaffey.github.io/three-body-problem/iframe/formula.html","width":"100%","height":110},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To test that the simulation was working correctly I used ChatGPT again to construct a 3D scene in Blender with a Python script:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Blender Animation","src":"/static/three-body-problem/blender.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"threejs"},"children":[{"type":"text","value":"Three.js"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Imagine that we are working for a Chinese startup called the Qin Dynasty. The founder, Qin Shi Huang, is a brutal tyrant with an obsessive fear of assassination. Let's put on our product hat for a minute and think about how we can impress him with a clean solution to the three-body problem. A recent attempt involved building a 30,000-person analog computer that was destroyed in tri-solar syzygy. Failing to accurately predict the movement of the suns could mean execution by live-burial, a fiery death or worse. Using CUDA and Blender is a good MVP but doesn't make for the best technical demo since it involves so many different steps: running the simulation in CUDA, exporting data to JSON, loading data into a visualuzation and then finally rendering a video of the simulation. With a popular Javascript library called Three.js we can run an interactive three-body problem simulation in real-time right in the browser. Here's the three-body simulation I also co-authored with ChatGPT-4 using Three.js:"}]},{"type":"element","tag":"iframe","props":{"src":"https://briancaffey.github.io/three-body-problem/three/","width":"100%","height":350},"children":[]},{"type":"element","tag":"h2","props":{"id":"screen-adaptations-the-gaming-industry-and-the-ccp"},"children":[{"type":"text","value":"Screen adaptations, the gaming industry and the CCP"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dream of the Red Chamber is one of China's Four Great Classical Novels and is often seen as the pinacle of Chinese fiction. It was written in the mid 18th century and first published in 1791. It is a long saga that totals 960,000 characters in length, on similar scale to the length of the Three-Body Problem trilogy. Sun Wen, a Qing dynasty artist, spent 36 years of his life doing a series of 230 paintings depicting scenes from the Dream of the Red Chamber: dream sequences, demons, goddesses, nuns, nobles, beggars, raging fires, landscapes, interiors, wildlife, gardens, temples, funerals, battles, processions, banquets, trials, operas, marriages."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Sun Wen paintings sample","src":"/static/three-body-problem/dorc.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Following in this tradition of celebrating great literature, Tencent Video and China Central Television produced a 30-episode adaptation of the Three-Body Problem that was released in Feburary 2023. It is a surprisingly faithful reproduction of the book that is worth checking out. The portrayal of Shi Qiang (Da Shi) was easily my favorite part of the series. I was also impressed by how the Three-Body VR game scenes were done with computer graphics. It got me thinking about how China is represented in some of the worlds most popular video games."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"games","src":"/static/three-body-problem/game.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is Rocket League, a competitive vehicular soccer game where players, like in the Three-Body game, must master the laws of gravity. The Chinese-themed Forbiden Temple arena shown here is one of many virtual international venues in the game. Epic Games (creator of Fortnite) bought Rocket League in 2019 for an estimated $250 to $300 million."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Like Rocket League, Overwatch is a highly-competitive eSport on a global scale. It features a large roster of 38 players from all over the world. Dr. Mei-Ling Zhou (Âë®ÁæéÁÅµ) is a Chinese climatologist who uses ice both to attack opponents and to defend herself. Mei became controversial in China due to her adoption as a symbolic figure in the 2019 Hong Kong protests."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Three college friends combined their interest in anime, comics and games (ACG) and literature to publish one of the most successful games created by a Chinese company and arguably one of China's most important cultural exports: Genshin Impact. miHoYo, the Shanghai-based company that develops Genshin Impact, grossed $4 billion of revenue globally in the game's first year setting a new record in the gaming industry. Like other companies of its size, miHoYo has a party committee under the Chinese Communist Party that influences the company's operations."}]},{"type":"element","tag":"h2","props":{"id":"ai-and-layoffs-in-the-tech-industry"},"children":[{"type":"text","value":"AI and layoffs in the tech industry"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have a positive attitude toward AI and its ability to supercharge the creative work we do, but I also think that replacing humans and AI-related layoffs should should be a part of the conversation. I wasn't impacted by the recent round of layoffs at my company, and I'm grateful to have the opportunity to work with a talented team on interesting problems in the health tech industry. I do have some solid references for folks in DevOps, product and backend and frontend engineering, and I‚Äôm happy to "},{"type":"element","tag":"a","props":{"href":"https://www.linkedin.com/in/brian-caffey-06b22a18/","rel":["nofollow"]},"children":[{"type":"text","value":"connect and share via LinkedIn"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Layoffs in both China and the U.S. have been pummled the tech sector over the last two years. New graduates in China are also facing a difficult job market. There are some popular expressions that paint a picture of the job market in China:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Ë∫∫Âπ≥ Lying flat: avoiding relentless work"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"‰πù‰πùÂÖ≠ 996 Work culture: describes working from 9AM to 9PM, 6 days a week, a common work schedule for many Chinese employees"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ÂÖ®ËÅåÂÑøÂ•≥ Full-time Children: "},{"type":"element","tag":"a","props":{"href":"https://www.cnn.com/2023/07/26/economy/china-youth-unemployment-intl-hnk/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"Young Chinese are getting paid to be ‚Äòfull-time children‚Äô as jobs become harder to find"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"35Â≤ÅËØÖÂíí The curse of 35: "},{"type":"element","tag":"a","props":{"href":"https://www.marketplace.org/shows/marketplace-tech/chinas-tech-workers-ageism-the-curse-of-35/","rel":["nofollow"]},"children":[{"type":"text","value":"Ageism in China‚Äôs tech sector has workers fearing the ‚Äúcurse of 35‚Äù"}]},{"type":"text","value":". Shout out to my fellow Year of the Dragon 35 year olds! üê≤"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ÂêÉËã¶ Eat Bitterness: "},{"type":"element","tag":"a","props":{"href":"https://www.nytimes.com/2023/05/30/business/china-youth-unemployment.html","rel":["nofollow"]},"children":[{"type":"text","value":"China‚Äôs Young People Can‚Äôt Find Jobs. Xi Jinping Says to ‚ÄòEat Bitterness.‚Äô"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is an exciting time for AI. Elon Musk and Kaifu Lee have both recently released open-source large language models: Grok and Yi. Sam Altman was fired as CEO of OpenAI, then came back. Stable Diffusion just released a text to video model. AGI might already be here. In the U.S., we are going into our first presidential election cycle with AI fully turned on. Here's a "},{"type":"element","tag":"a","props":{"href":"https://www.amazon.com/Three-Body-Problem-Cixin-Liu/dp/0765382032","rel":["nofollow"]},"children":[{"type":"text","value":"link to The Three-Body Problem book on Amazon"}]},{"type":"text","value":". Thanks for reading and Happy Thanksgiving!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Happy Thanksgiving","src":"/static/three-body-problem/thanksgiving.png"},"children":[]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"back-story","depth":2,"text":"Back story"},{"id":"chinese-in-numbers","depth":2,"text":"Chinese in numbers","children":[{"id":"character-frequency","depth":3,"text":"Character Frequency"}]},{"id":"meta-llms-and-grass-mud-horse","depth":2,"text":"Meta, LLMs, and Grass Mud Horse"},{"id":"translation-in-and-of-the-three-body-problem","depth":2,"text":"Translation in and of The Three-Body Problem","children":[{"id":"tokenization","depth":3,"text":"Tokenization"}]},{"id":"imagining-scenes-from-three-body-problem-with-stable-diffusion","depth":2,"text":"Imagining scenes from Three-Body Problem with Stable Diffusion"},{"id":"n-body-simulations-cuda-and-threejs","depth":2,"text":"n-body simulations, CUDA and Three.js","children":[{"id":"three-body-cuda-simulation","depth":3,"text":"Three-Body CUDA simulation"},{"id":"threejs","depth":3,"text":"Three.js"}]},{"id":"screen-adaptations-the-gaming-industry-and-the-ccp","depth":2,"text":"Screen adaptations, the gaming industry and the CCP"},{"id":"ai-and-layoffs-in-the-tech-industry","depth":2,"text":"AI and layoffs in the tech industry"}]}},"_type":"markdown","_id":"content:2023:08:27:python-vue-chinese-llama-2-and-the-three-body-problem.md","_source":"content","_file":"2023/08/27/python-vue-chinese-llama-2-and-the-three-body-problem.md","_stem":"2023/08/27/python-vue-chinese-llama-2-and-the-three-body-problem","_extension":"md"},{"_path":"/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","_dir":"07","_draft":false,"_partial":false,"_locale":"","title":"My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi","description":"Three reusable infrastructure as code libraries for abstracting containerized web app architecture on AWS ECS","date":"2023-01-07","image":"/static/iac_rosetta_stone_og_image.png","tags":["django","cdk","terraform","pulumi","cloudformation","github-actions","aws","ecs","fargate","containers","docker"],"draft":false,"external":[{"link":"https://news.ycombinator.com/item?id=34291336","site":"hn"},{"link":"https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/","site":"reddit"},{"link":"https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4","site":"dev"},{"link":"https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a","site":"medium"},{"link":"https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions","site":"hashnode"},{"link":"https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta","site":"substack"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CDK Construct Library"}]},{"type":"text","value":": "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/cdk-django","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/briancaffey/cdk-django"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Terraform Modules"}]},{"type":"text","value":": "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/terraform-aws-django","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/briancaffey/terraform-aws-django"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Pulumi Component Library"}]},{"type":"text","value":": "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/pulumi-aws-django","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/briancaffey/pulumi-aws-django"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Mono repo with a sample Django micro blogging app (Œºblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"consumes"}]},{"type":"text","value":" each of the libraries listed above, "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/django-step-by-step/","rel":["nofollow"]},"children":[{"type":"text","value":"VuePress documentation site"}]},{"type":"text","value":" and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/django-step-by-step","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/briancaffey/django-step-by-step"}]}]}]},{"type":"element","tag":"h2","props":{"id":"eli5"},"children":[{"type":"text","value":"eli5"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"to YouTube"}]},{"type":"text","value":", but the code I'm writing allows you to upload any type of website (even site YouTube) "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"to the internet"}]},{"type":"text","value":". When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach."}]},{"type":"element","tag":"h2","props":{"id":"why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi"},"children":[{"type":"text","value":"Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"To push me to learn more about AWS, IaC, CI/CD, automation, and Platform Engineering"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"To fail as many times as possible"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Every time I fail when I think I have things right, I learn something new"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"To take an application-first approach to DevOps"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Application developers are increasingly being tasked with operational duties"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"While learning about IaC, I had a hard time finding in-depth materials covering application development, CI/CD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"To develop a project I can reference when helping myself and others"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"companies and projects that do IaC and CI/CD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hopefully, the sample application, IaC, and CI/CD pipelines "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"aren't overly complex"}]},{"type":"text","value":". There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"show"}]},{"type":"text","value":" people how it can be done"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"To encourage others (specifically Developer Advocates / Developer Relations / Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"in use"}]},{"type":"text","value":" with an actual application."}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"There are many ways one could create an \"IaC Rosetta Stone\" ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"public cloud providers x CI/CD providers x IaC tools"}]},{"type":"text","value":" is a big number)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This takes a lot of effort and time"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"I have nothing to sell you"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"So many articles about Cloud/DevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I'm also not trying to sell anyone on using my IaC packages"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hopefully, my IaC packages can serve as a helpful reference or starting point"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Walk before running"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I want to build up confidence with vanilla use cases before getting too fancy"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"12 Factor App, DevOps, and Platform Engineering"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://12factor.net/","rel":["nofollow"]},"children":[{"type":"text","value":"12 Factor App"}]},{"type":"text","value":" is great and has guided how I approach both Django application development and IaC library development"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"a","props":{"href":"https://platformengineering.org/","rel":["nofollow"]},"children":[{"type":"text","value":"platformengineering.org"}]},{"type":"text","value":" community has some good guiding principles"}]}]},{"type":"element","tag":"h2","props":{"id":"cdkterraformpulumi-terminology"},"children":[{"type":"text","value":"CDK/Terraform/Pulumi terminology"}]},{"type":"element","tag":"h3","props":{"id":"constructs-modules-and-components"},"children":[{"type":"text","value":"constructs, modules and components"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article I will refer to "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"constructs/modules/components"}]},{"type":"text","value":" as "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":" for short, and the term "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"stack"}]},{"type":"text","value":" can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apply"}]},{"type":"text","value":" ran against it."}]},{"type":"element","tag":"h3","props":{"id":"what-is-a-stack"},"children":[{"type":"text","value":"what is a stack?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@pulumi/aws"}]},{"type":"text","value":" package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses)."}]},{"type":"element","tag":"h3","props":{"id":"verbs"},"children":[{"type":"text","value":"verbs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In CDK you "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"synth"}]},{"type":"text","value":" CDK code to generate CloudFormation templates. You can also run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"diff"}]},{"type":"text","value":" to see what changes would be applied during a stack update."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In Terraform you "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"init"}]},{"type":"text","value":" to download all providers and modules. This is sort of like running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"npm install"}]},{"type":"text","value":" in CDK and Pulumi. You then run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" to see the changes that would result. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":" does CRUD operations on your cloud resources."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In Pulumi you run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi preview"}]},{"type":"text","value":" to see what changes would be made to a stack. You can use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--diff"}]},{"type":"text","value":" flag to see the specifics of what would change."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To summarize:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In Terraform you plan a configuration made up of modules, and then run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":" to build the configuration/stack ("},{"type":"element","tag":"a","props":{"href":"https://discuss.hashicorp.com/t/what-is-a-terraform-stack/31985","rel":["nofollow"]},"children":[{"type":"text","value":"discuss.hashicorp.com/t/what-is-a-terraform-stack/31985"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi: You preview a Pulumi stack made up of components, and then run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi up"}]},{"type":"text","value":" to build the resources"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"To tear down a stack in all three tools, you run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"destroy"}]}]}]},{"type":"element","tag":"h2","props":{"id":"infrastructure-as-code-library-repos"},"children":[{"type":"text","value":"Infrastructure as Code library repos"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK: "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/cdk-django","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform: "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/terraform-aws-django","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi: "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/pulumi-aws-django","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"language"},"children":[{"type":"text","value":"Language"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]},{"type":"text","value":" are both written in TypeScript. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"text","value":" is written in HCL, a domain specific language created by HashiCorp. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]},{"type":"text","value":" is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using "},{"type":"element","tag":"a","props":{"href":"https://github.com/aws/jsii","rel":["nofollow"]},"children":[{"type":"text","value":"jsii"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See "},{"type":"element","tag":"a","props":{"href":"https://github.com/pulumi/pulumi-component-provider-ts-boilerplate","rel":["nofollow"]},"children":[{"type":"text","value":"this GitHub repo"}]},{"type":"text","value":" for more information on this."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called "},{"type":"element","tag":"a","props":{"href":"https://developer.hashicorp.com/terraform/cdktf","rel":["nofollow"]},"children":[{"type":"text","value":"CDKTF"}]},{"type":"text","value":" which allows you to write HCL Terraform in TypeScript, but I haven't used it yet."}]},{"type":"element","tag":"h3","props":{"id":"release-management-versioning-and-publishing"},"children":[{"type":"text","value":"Release management, versioning and publishing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"text","value":" both use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"release-please"}]},{"type":"text","value":" for automatically generating a changelog file and bumping versions. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"release-please"}]},{"type":"text","value":" is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"main"}]},{"type":"text","value":", a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":" and adds a new git tag (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.2.3"}]},{"type":"text","value":") based on commit messages."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]},{"type":"text","value":" uses "},{"type":"element","tag":"a","props":{"href":"https://github.com/projen/projen","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"projen"}]}]},{"type":"text","value":" for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".projenrc.ts"}]},{"type":"text","value":") to configure your entire repo, including files like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tsconfig.json"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":", and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These tools are both based on "},{"type":"element","tag":"a","props":{"href":"https://www.conventionalcommits.org/en/v1.0.0/","rel":["nofollow"]},"children":[{"type":"text","value":"conventional commits"}]},{"type":"text","value":" to automatically update the Changelog file."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm still manually publishing my "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]},{"type":"text","value":" package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!"}]},{"type":"element","tag":"h3","props":{"id":"makefile-examples-and-local-development"},"children":[{"type":"text","value":"Makefile, examples and local development"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"synthesizing CDK to CloudFormation / running "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" / previewing pulumi up for both the base and app stacks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"creating/updating an ad hoc base stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"destroying resources in the ad-hoc base stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"creating an ad hoc app stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alpha"}]},{"type":"text","value":" that uses resources from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"destroying an ad hoc app stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alpha"}]},{"type":"text","value":" that uses resources from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"creating/updating a prod base stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stage"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"destroying resources in the prod base stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stage"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"creating a prod app stack using called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stage"}]},{"type":"text","value":" that uses resources from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stage"}]},{"type":"text","value":" base stack"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"destroying resources in the prod app stack called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stage"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an example of what these commands look like in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]},{"type":"text","value":" for prod infrastructure base and app stacks:"}]},{"type":"element","tag":"pre","props":{"code":"prod-base-preview:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive preview\n\nprod-base-up:   build\n    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n\nprod-base-destroy:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n\nprod-app-preview:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview\n\nprod-app-preview-diff:  build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n\nprod-app-up:    build\n    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n\nprod-app-destroy:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n","language":"make","meta":"","className":"language-make shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-base-preview"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":  build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/base --stack stage --non-interactive preview\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-base-up"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":   build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-base-destroy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":  build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-app-preview"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":   build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/app --stack stage --non-interactive preview\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-app-preview-diff"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":  build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-app-up"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":    build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"prod-app-destroy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":   build\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s to create environments and smoke check the environments to make sure everything works correctly."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adding unit tests is another item for the backlog."}]},{"type":"element","tag":"h3","props":{"id":"ad-hoc-vs-prod"},"children":[{"type":"text","value":"ad-hoc vs prod"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","rel":["nofollow"]},"children":[{"type":"text","value":"the last article I wrote was about ad hoc environments"}]},{"type":"text","value":". Also known as \"on-demand\" environments or \"preview\" environments."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"prod can be used for a production environment and any number of pre-production environments"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment"}]}]},{"type":"element","tag":"h3","props":{"id":"directory-structure"},"children":[{"type":"text","value":"Directory structure"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The directory structures for each repo are all similar with some minor differences."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two types of environments: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad-hoc"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"prod"}]},{"type":"text","value":". Within ad-hoc and production, there are two directories "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each repo has a directory called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"internal"}]},{"type":"text","value":" which contain building blocks used by the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s that are exposed. The contents of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"internal"}]},{"type":"text","value":" directories are not intended to be used by anyone who is using the libraries."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CDK construct library repo structure"}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/cdk-django$ tree -L 4 -d src/\nsrc/\n‚îú‚îÄ‚îÄ constructs\n‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îÇ   ‚îú‚îÄ‚îÄ internal\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alb\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bastion\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customResources\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ highestPriorityRule\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecs\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iam\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management-command\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduler\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ web\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ worker\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rds\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sg\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vpc\n‚îÇ   ‚îî‚îÄ‚îÄ prod\n‚îÇ       ‚îú‚îÄ‚îÄ app\n‚îÇ       ‚îî‚îÄ‚îÄ base\n‚îî‚îÄ‚îÄ examples\n    ‚îî‚îÄ‚îÄ ad-hoc\n        ‚îú‚îÄ‚îÄ app\n        ‚îÇ   ‚îî‚îÄ‚îÄ config\n        ‚îî‚îÄ‚îÄ base\n            ‚îî‚îÄ‚îÄ config\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/cdk-django$ tree -L 4 -d src/\nsrc/\n‚îú‚îÄ‚îÄ constructs\n‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îÇ   ‚îú‚îÄ‚îÄ internal\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alb\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bastion\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customResources\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ highestPriorityRule\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecs\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iam\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management-command\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduler\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ web\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ worker\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rds\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sg\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vpc\n‚îÇ   ‚îî‚îÄ‚îÄ prod\n‚îÇ       ‚îú‚îÄ‚îÄ app\n‚îÇ       ‚îî‚îÄ‚îÄ base\n‚îî‚îÄ‚îÄ examples\n    ‚îî‚îÄ‚îÄ ad-hoc\n        ‚îú‚îÄ‚îÄ app\n        ‚îÇ   ‚îî‚îÄ‚îÄ config\n        ‚îî‚îÄ‚îÄ base\n            ‚îî‚îÄ‚îÄ config\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Terraform module library repo structure"}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/terraform-aws-django$ tree -L 4 -d modules\nmodules\n‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îú‚îÄ‚îÄ internal\n‚îÇ   ‚îú‚îÄ‚îÄ alb\n‚îÇ   ‚îú‚îÄ‚îÄ autoscaling\n‚îÇ   ‚îú‚îÄ‚îÄ bastion\n‚îÇ   ‚îú‚îÄ‚îÄ ecs\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_beat\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_worker\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cluster\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management_command\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ web\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prod\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_beat\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_worker\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cluster\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ management_command\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ web\n‚îÇ   ‚îú‚îÄ‚îÄ elasticache\n‚îÇ   ‚îú‚îÄ‚îÄ iam\n‚îÇ   ‚îú‚îÄ‚îÄ rds\n‚îÇ   ‚îú‚îÄ‚îÄ route53\n‚îÇ   ‚îú‚îÄ‚îÄ s3\n‚îÇ   ‚îú‚îÄ‚îÄ sd\n‚îÇ   ‚îî‚îÄ‚îÄ sg\n‚îî‚îÄ‚îÄ prod\n    ‚îú‚îÄ‚îÄ app\n    ‚îî‚îÄ‚îÄ base\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/terraform-aws-django$ tree -L 4 -d modules\nmodules\n‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îú‚îÄ‚îÄ internal\n‚îÇ   ‚îú‚îÄ‚îÄ alb\n‚îÇ   ‚îú‚îÄ‚îÄ autoscaling\n‚îÇ   ‚îú‚îÄ‚îÄ bastion\n‚îÇ   ‚îú‚îÄ‚îÄ ecs\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_beat\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_worker\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cluster\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management_command\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ web\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prod\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_beat\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_worker\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cluster\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ management_command\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ web\n‚îÇ   ‚îú‚îÄ‚îÄ elasticache\n‚îÇ   ‚îú‚îÄ‚îÄ iam\n‚îÇ   ‚îú‚îÄ‚îÄ rds\n‚îÇ   ‚îú‚îÄ‚îÄ route53\n‚îÇ   ‚îú‚îÄ‚îÄ s3\n‚îÇ   ‚îú‚îÄ‚îÄ sd\n‚îÇ   ‚îî‚îÄ‚îÄ sg\n‚îî‚îÄ‚îÄ prod\n    ‚îú‚îÄ‚îÄ app\n    ‚îî‚îÄ‚îÄ base\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Pulumi component library repo structure"}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/pulumi-aws-django$ tree -L 3 src/\nsrc/\n‚îú‚îÄ‚îÄ components\n‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îÇ   ‚îî‚îÄ‚îÄ internal\n‚îÇ       ‚îú‚îÄ‚îÄ README.md\n‚îÇ       ‚îú‚îÄ‚îÄ alb\n‚îÇ       ‚îú‚îÄ‚îÄ bastion\n‚îÇ       ‚îú‚îÄ‚îÄ cw\n‚îÇ       ‚îú‚îÄ‚îÄ ecs\n‚îÇ       ‚îú‚îÄ‚îÄ iam\n‚îÇ       ‚îú‚îÄ‚îÄ rds\n‚îÇ       ‚îî‚îÄ‚îÄ sg\n‚îî‚îÄ‚îÄ util\n    ‚îú‚îÄ‚îÄ index.ts\n    ‚îî‚îÄ‚îÄ taggable.ts\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/pulumi-aws-django$ tree -L 3 src/\nsrc/\n‚îú‚îÄ‚îÄ components\n‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base\n‚îÇ   ‚îî‚îÄ‚îÄ internal\n‚îÇ       ‚îú‚îÄ‚îÄ README.md\n‚îÇ       ‚îú‚îÄ‚îÄ alb\n‚îÇ       ‚îú‚îÄ‚îÄ bastion\n‚îÇ       ‚îú‚îÄ‚îÄ cw\n‚îÇ       ‚îú‚îÄ‚îÄ ecs\n‚îÇ       ‚îú‚îÄ‚îÄ iam\n‚îÇ       ‚îú‚îÄ‚îÄ rds\n‚îÇ       ‚îî‚îÄ‚îÄ sg\n‚îî‚îÄ‚îÄ util\n    ‚îú‚îÄ‚îÄ index.ts\n    ‚îî‚îÄ‚îÄ taggable.ts\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Pulumi examples directory"}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/pulumi-aws-django$ tree -L 3 examples/\nexamples/\n‚îî‚îÄ‚îÄ ad-hoc\n    ‚îú‚îÄ‚îÄ app\n    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.alpha.yaml\n    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.yaml\n    ‚îÇ   ‚îú‚îÄ‚îÄ index.ts\n    ‚îÇ   ‚îú‚îÄ‚îÄ node_modules\n    ‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json\n    ‚îÇ   ‚îú‚îÄ‚îÄ package.json\n    ‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json\n    ‚îî‚îÄ‚îÄ base\n        ‚îú‚îÄ‚îÄ Pulumi.yaml\n        ‚îú‚îÄ‚îÄ bin\n        ‚îú‚îÄ‚îÄ index.ts\n        ‚îú‚îÄ‚îÄ package-lock.json\n        ‚îú‚îÄ‚îÄ package.json\n        ‚îî‚îÄ‚îÄ tsconfig.json\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/pulumi-aws-django$ tree -L 3 examples/\nexamples/\n‚îî‚îÄ‚îÄ ad-hoc\n    ‚îú‚îÄ‚îÄ app\n    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.alpha.yaml\n    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.yaml\n    ‚îÇ   ‚îú‚îÄ‚îÄ index.ts\n    ‚îÇ   ‚îú‚îÄ‚îÄ node_modules\n    ‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json\n    ‚îÇ   ‚îú‚îÄ‚îÄ package.json\n    ‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json\n    ‚îî‚îÄ‚îÄ base\n        ‚îú‚îÄ‚îÄ Pulumi.yaml\n        ‚îú‚îÄ‚îÄ bin\n        ‚îú‚îÄ‚îÄ index.ts\n        ‚îú‚îÄ‚îÄ package-lock.json\n        ‚îú‚îÄ‚îÄ package.json\n        ‚îî‚îÄ‚îÄ tsconfig.json\n"}]}]},{"type":"element","tag":"h3","props":{"id":"cloc"},"children":[{"type":"text","value":"CLOC"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's use CLOC (count lines of code) to compare the lines of code used in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":" of CDK/CloudFormation/Terraform/Pulumi."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/cdk-django$ cloc src/constructs/\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/cdk-django$ cloc src/constructs/\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/terraform-aws-django$ cloc modules/\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/terraform-aws-django$ cloc modules/\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]}]}]},{"type":"element","tag":"pre","props":{"code":"~/git/github/pulumi-aws-django$ cloc src/components/\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"~/git/github/pulumi-aws-django$ cloc src/components/\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n"}]}]},{"type":"element","tag":"h2","props":{"id":"communities"},"children":[{"type":"text","value":"Communities"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://cdk.dev/","rel":["nofollow"]},"children":[{"type":"text","value":"cdk.dev"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://discuss.hashicorp.com/c/terraform-core/27","rel":["nofollow"]},"children":[{"type":"text","value":"Terraform Section of HashiCorp Discuss Forum"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://slack.pulumi.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Pulumi Slack"}]}]}]},{"type":"element","tag":"h2","props":{"id":"Œºblog"},"children":[{"type":"text","value":"Œºblog"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Œºblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"ublog","src":"/static/ublog_screenshot.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts."}]},{"type":"element","tag":"h3","props":{"id":"mono-repo-structure"},"children":[{"type":"text","value":"Mono-repo structure"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It lives in a GitHub mono repo called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"text","value":". This mono repo contains a few different things:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend Django application"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"frontend Vue.js application"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"IaC code that uses c/m/c from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk-django"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitHub Actions workflows for both Infrastructure deployments and application deployments"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Œºblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. Œºblog is meant to represent a generic 12 Factor application that uses:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"gunicorn for a backend API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vue.js for a client that consumes the backend API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"celery for async task processing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"celery beat for scheduling tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Postgres for relational data"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Redis for caching and message brokering"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 for object storage"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Django admin for a simple admin interface"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a lot more I could add on Œºblog. For now I'll just mention that it:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"has a great local development environment (supports both docker-compose and virtual environments)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitHub Actions for running unit tests"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"k6 for load testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/django-step-by-step/","rel":["nofollow"]},"children":[{"type":"text","value":"https://briancaffey.github.io/django-step-by-step/"}]}]}]},{"type":"element","tag":"h1","props":{"id":"infrastructure-deep-dive"},"children":[{"type":"text","value":"Infrastructure Deep Dive"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's go through each of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll first talk about the two stacks used in ad hoc environments: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":". Then I'll talk about the prod environments which are also composed of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" stacks."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"especially with Terraform"}]},{"type":"text","value":". In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried)."}]},{"type":"element","tag":"h2","props":{"id":"splitting-up-the-stacks"},"children":[{"type":"text","value":"Splitting up the stacks"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform enables this with outputs and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform_remote_state"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi encourages the use of "},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/docs/guides/organizing-projects-stacks/","rel":["nofollow"]},"children":[{"type":"text","value":"micro stacks"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK has an article on how to "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/v2/guide/stack_how_to_create_multiple_stacks.html","rel":["nofollow"]},"children":[{"type":"text","value":"create an app with multiple stacks"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Also, on-demand environments really lends itself to stacks that are split up."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the section "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/v2/guide/resources.html","rel":["nofollow"]},"children":[{"type":"text","value":"\"Passing unique identifiers\""}]},{"type":"text","value":", the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a balance to be found between single stacks vs micro stacks. Both the base and app "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s could be split out further. For example, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base"}]},{"type":"text","value":" "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s could be split into "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"networking"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rds"}]},{"type":"text","value":". The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" stack could be split into different ECS services so that their infrastructure can be deployed independently, like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cluster"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"frontend"}]},{"type":"text","value":". The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My rules of thumbs are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Lots of small stacks can cause overhead and make things more complex than they need to be"}]}]},{"type":"element","tag":"h2","props":{"id":"ad-hoc-base-overview"},"children":[{"type":"text","value":"Ad hoc base overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an overview of the resources used in an ad hoc base environment."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"(Inputs)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"(Optional environment configs)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VPC and Service Discovery"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Security Groups"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Load Balancer"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"RDS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Bastion Host"}]}]},{"type":"element","tag":"h3","props":{"id":"visualization"},"children":[{"type":"text","value":"Visualization"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Resources"}]},{"type":"text","value":" tab of the ad hoc base stack in the Pulumi console."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Graph view of ad hoc base infrastructure","src":"/static/pulumi_ad_hoc_base_dep_graph.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"inputs"},"children":[{"type":"text","value":"Inputs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are only two required inputs for the ad hoc base stack"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ACM certificate ARN"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Domain Name"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy/apply/up or synth/plan/preview."}]},{"type":"element","tag":"h3","props":{"id":"vpc"},"children":[{"type":"text","value":"VPC"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The VPC is the first resource that is created as part of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"base"}]},{"type":"text","value":" stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsx"}]},{"type":"text","value":" has a VPC module"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-vpc"}]},{"type":"text","value":" module"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"L2 VPC Construct in CDK"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The setting in the Terraform VPC module "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"one_nat_gateway_per_az = false"}]},{"type":"text","value":" doesn't seem to exist on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"awsx.ec2.Vpc"}]},{"type":"text","value":" module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3."}]},{"type":"element","tag":"h3","props":{"id":"security-groups"},"children":[{"type":"text","value":"Security Groups"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups."}]},{"type":"element","tag":"pre","props":{"code":"    const albSecurityGroup = new SecurityGroup(scope, 'AlbSecurityGroup', {\n      vpc: props.vpc,\n    });\n\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(443), 'HTTPS');\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(80), 'HTTP');\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" albSecurityGroup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" SecurityGroup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(scope, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'AlbSecurityGroup'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      vpc: props.vpc,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    albSecurityGroup."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addIngressRule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(Peer."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"anyIpv4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(), Port."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"tcp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"443"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'HTTPS'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    albSecurityGroup."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"addIngressRule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(Peer."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"anyIpv4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(), Port."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"tcp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"80"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'HTTP'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"load-balancer-resources"},"children":[{"type":"text","value":"Load Balancer Resources"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There's not much to comment on here. In each library I have resource group that defines the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Application Load Balancer"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A default target group"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An HTTP listener that redirects to HTTPS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An HTTPS listener with a default \"fixed-response\" action"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Properties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ad hoc app environments all share a common load balancer from the base stack that they use."}]},{"type":"element","tag":"h3","props":{"id":"rds-resources"},"children":[{"type":"text","value":"RDS Resources"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All three libraries have the RDS security group and Subnet Group in the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":" as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Currently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential."}]},{"type":"element","tag":"pre","props":{"code":"    const secret = new Secret(scope, 'dbSecret', {\n      secretName: props.dbSecretName,\n      description: 'secret for rds',\n      generateSecretString: {\n        secretStringTemplate: JSON.stringify({ username: 'postgres' }),\n        generateStringKey: 'password',\n        excludePunctuation: true,\n        includeSpace: false,\n      },\n    });\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" secret"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Secret"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(scope, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'dbSecret'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      secretName: props.dbSecretName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      description: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'secret for rds'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      generateSecretString: {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        secretStringTemplate: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"stringify"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"({ username: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'postgres'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" }),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        generateStringKey: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'password'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        excludePunctuation: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        includeSpace: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    });\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DatabaseInstance"}]},{"type":"text","value":" props we can then use this secret like so:"}]},{"type":"element","tag":"pre","props":{"code":"    credentials: Credentials.fromSecret(secret),\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    credentials: Credentials.fromSecret(secret),\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the application deployed with CDK, I use a Django settings module package that uses a package called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_secretsmanager_caching"}]},{"type":"text","value":" to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Terraform and Pulumi database instance arguments simply accept a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"password"}]},{"type":"text","value":" field. This will be another item for the backlog for Terraform and Pulumi. The "},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/registry/packages/random/api-docs/randompassword/","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"randompassword"}]}]},{"type":"text","value":" and "},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/registry/packages/aws/api-docs/secretsmanager/secretversion/","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"secretversion"}]}]},{"type":"text","value":" components can be used to do this."}]},{"type":"element","tag":"h3","props":{"id":"bastion-host"},"children":[{"type":"text","value":"Bastion Host"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two main use cases for the bastion host in ad-hoc environments."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When creating a new ad hoc app environment, the bastion host is used to create a new database called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ad-hoc-env-name}-db"}]},{"type":"text","value":" that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"localhost:5432"}]},{"type":"text","value":" on your local machine."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:"}]},{"type":"element","tag":"pre","props":{"code":"aws ssm start-session --target $INSTANCE_ID\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ssm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" start-session"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" --target"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $INSTANCE_ID\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"outputs"},"children":[{"type":"text","value":"Outputs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"vpc_id"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"assets_bucket_name"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"private_subnet_ids"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"app_sg_id"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"alb_sg_id"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"listener_arn"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"alb_dns_name"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"task_role_arn"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"execution_role_arn"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"rds_address"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Vpc"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RdsInstance"}]},{"type":"text","value":". More on this later in the following section "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Passing data between stacks"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"ad-hoc-app-overview"},"children":[{"type":"text","value":"Ad hoc app overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Graph view of ad hoc app infrastructure","src":"/static/pulumi_ad_hoc_app_dep_graph.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"ecs-cluster"},"children":[{"type":"text","value":"ECS Cluster"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This is a small component that defines both ECS Cluster and the default capacity providers"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It defaults to not using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FARGATE_SPOT"}]},{"type":"text","value":"; ad hoc environments do use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"FARGATE_SPOT"}]},{"type":"text","value":" for cost savings"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NOTE: defaultCapacityProviderStrategy on cluster not currently supported. ("},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ecs.CapacityProviderStrategy.html","rel":["nofollow"]},"children":[{"type":"text","value":"link"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"h3","props":{"id":"shared-environment-variables"},"children":[{"type":"text","value":"Shared environment variables"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I struggled to get this right in pulumi. A lot of Pulumi examples used "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"JSON.stringify"}]},{"type":"text","value":" for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi.jsonStringify"}]},{"type":"text","value":" which was added in a relatively recent version of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi/pulumi"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK allows you to declare environment variables for a containerDefinition like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ FOO: \"bar\" }"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi and Terraform require that values are passed like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ name: \"FOO\", value: \"bar\"}"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You could transform "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ FOO: \"bar\" }"}]},{"type":"text","value":" into the name/value format, but I didn't bother to do this"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"concat"}]},{"type":"text","value":" function to add these to the list of default environment variables."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's what the code looks like for joining extra environment variables to the default environment variables:"}]},{"type":"element","tag":"pre","props":{"code":"    // CDK\n    if (extraEnvVars) {\n      environmentVariables = { ...extraEnvVars, ...environmentVariables };\n    }\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // CDK\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (extraEnvVars) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      environmentVariables "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"extraEnvVars, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environmentVariables };\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]}]}]},{"type":"element","tag":"pre","props":{"code":"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n"}]}]},{"type":"element","tag":"pre","props":{"code":"    // Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x => x.concat(extraEnvVars!))\n    }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    // Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x => x.concat(extraEnvVars!))\n    }\n"}]}]},{"type":"element","tag":"h3","props":{"id":"route53-record"},"children":[{"type":"text","value":"Route53 Record"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"example.com/api/*"}]},{"type":"text","value":" are routed to the backend API and all other requests matching "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"example.com/*"}]},{"type":"text","value":" are routed to the frontend service."}]},{"type":"element","tag":"h3","props":{"id":"redis"},"children":[{"type":"text","value":"Redis"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable."}]},{"type":"element","tag":"h3","props":{"id":"web-service"},"children":[{"type":"text","value":"Web Service"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":" has an input parameter called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pathPatterns"}]},{"type":"text","value":" which determines which paths it serves. For example, the API container may serve traffic for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/*"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/*"}]},{"type":"text","value":" only, or it may want to serve all traffic ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/*"}]},{"type":"text","value":")."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The way I use these components in ad hoc and prod environments is heavily opinionated in that:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"it assumes that the frontend SPA/SSR site should have a lower priority rule than the backend service and should route request paths matching "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/*"}]},{"type":"text","value":", while the backend service routes requests for a specific list of path patterns ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api/*"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin/*"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/graphql/*"}]},{"type":"text","value":", etc.)."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring."}]},{"type":"element","tag":"h3","props":{"id":"celery"},"children":[{"type":"text","value":"Celery"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The reason for having a celery service is to be able to have potentially multiple workers that scale independently"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I use the same Pulumi component for both works and schedulers"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AsyncWorker"}]},{"type":"text","value":" across the board rather than using the term "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"celery"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"management-command"},"children":[{"type":"text","value":"Management Command"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Defines a task that can be used to run commands like "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"These tasks are ran both after the initial "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" stack deployment and before rolling application upgrades"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my Django app I have a single management command that calls "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other thing to note about this "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":" is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"saves the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"START"}]},{"type":"text","value":" timestamp"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"runs the task with the required settings"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"waits for the task to complete"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"saves the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"END"}]},{"type":"text","value":" timestamp"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"collects the logs for the task between "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"START"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"END"}]},{"type":"text","value":" and prints them to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"stdout"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an example of what the script looks like in Pulumi:"}]},{"type":"element","tag":"pre","props":{"code":"    const executionScript = pulumi.interpolate`#!/bin/bash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster ${props.ecsClusterId} --task-definition ${taskDefinition.arn} --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[${props.privateSubnetIds.apply(x => x.join(\",\"))}],securityGroups=[${props.appSgId}],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster ${props.ecsClusterId}\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name ${cwLoggingResources.cwLogGroupName} --log-stream-name ${props.name}/${props.name}/\\${TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n`;\n    this.executionScript = executionScript;\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" executionScript"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pulumi."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"interpolate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`#!/bin/bash\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"START_TIME=$(date +%s000)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"TASK_ID=$(aws ecs run-task --cluster "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ecsClusterId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" --task-definition "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"taskDefinition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"arn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"privateSubnetIds"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"apply"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" x"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"join"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\",\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"))"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"],securityGroups=["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"appSgId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"aws ecs wait tasks-stopped --tasks $TASK_ID --cluster "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ecsClusterId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"END_TIME=$(date +%s000)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"aws logs get-log-events --log-group-name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cwLoggingResources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cwLogGroupName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" --log-stream-name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"props"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"{TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".executionScript "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" executionScript;\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:"}]},{"type":"element","tag":"pre","props":{"code":"      - name: \"Run backend update command\"\n        id: run_backend_update\n        run: |\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          ./backend_update_command.sh\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Run backend update command\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"run_backend_update\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          # get the script from the stack output with an output key that contains the string `backendUpdate`\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            --stack-name $AD_HOC_APP_NAME \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          cat backend_update_command.sh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          sudo chmod +x backend_update_command.sh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"          ./backend_update_command.sh\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"passing-data-between-stacks"},"children":[{"type":"text","value":"Passing data between stacks"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's what this looks like in Terraform"}]},{"type":"element","tag":"pre","props":{"code":"data \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"../base/terraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"../../../modules/ad-hoc/app\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n","language":"terraform","meta":"","className":"language-terraform shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \"terraform_remote_state\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \"this\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  backend"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"local\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    path "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"../base/terraform.tfstate\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"module"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" \"main\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  source"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"../../../modules/ad-hoc/app\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  vpc_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                         ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"vpc_id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  assets_bucket_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"             ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"assets_bucket_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  private_subnet_ids"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"             ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"private_subnet_ids\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  app_sg_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                      ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app_sg_id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  alb_sg_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                      ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"alb_sg_id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  listener_arn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                   ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"listener_arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  alb_dns_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                   ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"alb_dns_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  service_discovery_namespace_id"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"service_discovery_namespace_id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  rds_address"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                    ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"rds_address\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  domain_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                    ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"domain_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  base_stack_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"base_stack_name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  region"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                         ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"region\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In CDK:"}]},{"type":"element","tag":"pre","props":{"code":"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n\nconst adHocBase = new AdHocBase(baseStack, 'AdHocBase', { certificateArn, domainName });\n\nconst addHocApp = new AdHocApp(appStack, 'AdHocApp', {\n  baseStackName: adHocBaseEnvName,\n  vpc: adHocBase.vpc,\n  alb: adHocBase.alb,\n  appSecurityGroup: adHocBase.appSecurityGroup,\n  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n  rdsInstance: adHocBase.databaseInstance,\n  assetsBucket: adHocBase.assetsBucket,\n  domainName: adHocBase.domainName,\n  listener: adHocBase.listener,\n});\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" baseStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Stack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(app, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ExampleAdHocBaseStack'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { env, stackName: adHocBaseEnvName });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"baseStack.node."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setContext"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'config'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", adHocBaseEnvConfig);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" appStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Stack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(app, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ExampleAdHocAppStack'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { env, stackName: adHocAppEnvName });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"appStack.node."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setContext"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'config'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", adHocAppEnvConfig);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" adHocBase"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" AdHocBase"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(baseStack, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'AdHocBase'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { certificateArn, domainName });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" addHocApp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" AdHocApp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(appStack, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'AdHocApp'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  baseStackName: adHocBaseEnvName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  vpc: adHocBase.vpc,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  alb: adHocBase.alb,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  appSecurityGroup: adHocBase.appSecurityGroup,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  rdsInstance: adHocBase.databaseInstance,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  assetsBucket: adHocBase.assetsBucket,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  domainName: adHocBase.domainName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  listener: adHocBase.listener,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"});\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"and in Pulumi:"}]},{"type":"element","tag":"pre","props":{"code":"const stackReference = new pulumi.StackReference(`${org}/ad-hoc-base/${environment}`)\n\nconst vpcId = stackReference.getOutput(\"vpcId\") as pulumi.Output<string>;\nconst assetsBucketName = stackReference.getOutput(\"assetsBucketName\") as pulumi.Output<string>;\nconst privateSubnets = stackReference.getOutput(\"privateSubnetIds\") as pulumi.Output<string[]>;\nconst appSgId = stackReference.getOutput(\"appSgId\") as pulumi.Output<string>;\nconst albSgId = stackReference.getOutput(\"albSgId\") as pulumi.Output<string>;\nconst listenerArn = stackReference.getOutput(\"listenerArn\") as pulumi.Output<string>;\nconst albDnsName = stackReference.getOutput(\"albDnsName\") as pulumi.Output<string>;\nconst serviceDiscoveryNamespaceId = stackReference.getOutput(\"serviceDiscoveryNamespaceId\") as pulumi.Output<string>;\nconst rdsAddress = stackReference.getOutput(\"rdsAddress\") as pulumi.Output<string>;\nconst domainName = stackReference.getOutput(\"domainName\") as pulumi.Output<string>;\nconst baseStackName = stackReference.getOutput(\"baseStackName\") as pulumi.Output<string>;\n\n// ad hoc app env\nconst adHocAppComponent = new AdHocAppComponent(\"AdHocAppComponent\", {\n  vpcId,\n  assetsBucketName,\n  privateSubnets,\n  appSgId,\n  albSgId,\n  listenerArn,\n  albDnsName,\n  serviceDiscoveryNamespaceId,\n  rdsAddress,\n  domainName,\n  baseStackName\n});\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pulumi."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"StackReference"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"org"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/ad-hoc-base/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" vpcId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"vpcId\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" assetsBucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"assetsBucketName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" privateSubnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"privateSubnetIds\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[]>;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" appSgId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"appSgId\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" albSgId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"albSgId\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" listenerArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"listenerArn\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" albDnsName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"albDnsName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" serviceDiscoveryNamespaceId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"serviceDiscoveryNamespaceId\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" rdsAddress"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"rdsAddress\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" domainName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"domainName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" baseStackName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" stackReference."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getOutput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"baseStackName\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" pulumi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// ad hoc app env\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" adHocAppComponent"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" AdHocAppComponent"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"AdHocAppComponent\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  vpcId,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  assetsBucketName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  privateSubnets,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  appSgId,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  albSgId,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  listenerArn,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  albDnsName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  serviceDiscoveryNamespaceId,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  rdsAddress,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  domainName,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  baseStackName\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"});\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"cli-scaffolding"},"children":[{"type":"text","value":"CLI scaffolding"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK and Pulumi have some good options for how to scaffold a project."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi has "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi new aws-typescript"}]},{"type":"text","value":" among lots of other options (run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi new -l"}]},{"type":"text","value":" to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"text","value":" that consume the library."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK has "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"projen"}]},{"type":"text","value":" CLI commands which can help set up either library code or project code"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The major benefits of these tools is setting up "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tsconfig.json"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":" correctly"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform is so simple that it doesn't really need tooling for scaffolding"}]}]},{"type":"element","tag":"h2","props":{"id":"best-practices"},"children":[{"type":"text","value":"Best practices"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"text","value":", I tried to follow the recommendations from "},{"type":"element","tag":"a","props":{"href":"https://www.terraform-best-practices.com/","rel":["nofollow"]},"children":[{"type":"text","value":"terraform-best-practices.com"}]},{"type":"text","value":" which helped me a lot with things like consistent naming patterns and directory structures. For example:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"use the name "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"this"}]},{"type":"text","value":" for resources in a module where that resource is the only resource of its type"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Inputs"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Outputs"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi.interpolate"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"apply()"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"all()"}]},{"type":"text","value":" and the differences between "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"getX"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"getXOutput"}]},{"type":"text","value":". There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way."}]},{"type":"element","tag":"h2","props":{"id":"environment-configuration"},"children":[{"type":"text","value":"Environment configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Environment configuration allows for either a base or app stack to be configured with non-default values. For example:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi defines environment-specific config in files called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Pulumi.{env}.yaml"}]},{"type":"text","value":" ("},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/docs/intro/concepts/config/","rel":["nofollow"]},"children":[{"type":"text","value":"Pulumi article on configuration"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform uses "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{env}.tfvars"}]},{"type":"text","value":" for this type of configuration"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK has several options for this type of configuration ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cdk.context.json"}]},{"type":"text","value":", extending stack props, etc.)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For CDK I have been using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"setContext"}]},{"type":"text","value":" and the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tryGetContext"}]},{"type":"text","value":" method:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"setContext"}]},{"type":"text","value":" needs to be set on the node before any child nodes are added:"}]},{"type":"element","tag":"pre","props":{"code":"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" baseStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Stack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(app, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ExampleAdHocBaseStack'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { env, stackName: adHocBaseEnvName });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"baseStack.node."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setContext"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'config'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", adHocBaseEnvConfig);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" appStack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Stack"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(app, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ExampleAdHocAppStack'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", { env, stackName: adHocAppEnvName });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"appStack.node."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setContext"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'config'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", adHocAppEnvConfig);\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And the config objects are read from JSON files like this:"}]},{"type":"element","tag":"pre","props":{"code":"var adHocBaseEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/base/config/${adHocBaseEnvName}.json`, 'utf8'));\nvar adHocAppEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/app/config/${adHocAppEnvName}.json`, 'utf8'));\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" adHocBaseEnvConfig "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(fs."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"readFileSync"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`src/examples/ad-hoc/base/config/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"adHocBaseEnvName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".json`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'utf8'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"));\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" adHocAppEnvConfig "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(fs."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"readFileSync"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"`src/examples/ad-hoc/app/config/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"adHocAppEnvName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".json`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'utf8'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"));\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The context can be used in constructs like this:"}]},{"type":"element","tag":"pre","props":{"code":"    const extraEnvVars = this.node.tryGetContext('config').extraEnvVars;\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" extraEnvVars"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".node."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"tryGetContext"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'config'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":").extraEnvVars;\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:"}]},{"type":"element","tag":"pre","props":{"code":"    interface EnvVar {\n      name: string;\n      value: string;\n    }\n\n    let config = new pulumi.Config();\n    let extraEnvVars = config.getObject<EnvVar[]>(\"extraEnvVars\");\n","language":"ts","meta":"","className":"language-ts shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    interface"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" EnvVar"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    let"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" config "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pulumi."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    let"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" extraEnvVars "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" config."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getObject"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"EnvVar"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"[]>("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"extraEnvVars\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Pulumi.alpha.yaml"}]},{"type":"text","value":" file I have the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"extraEnvVars"}]},{"type":"text","value":" set like this:"}]},{"type":"element","tag":"pre","props":{"code":"config:\n  aws:region: us-east-1\n  extraEnvVars:\n    - name: FOO\n      value: BAR\n    - name: BIZ\n      value: BUZ\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"config"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  aws:region"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"us-east-1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  extraEnvVars"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"FOO\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"BAR\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"BIZ\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"BUZ\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)"}]},{"type":"element","tag":"h2","props":{"id":"local-development"},"children":[{"type":"text","value":"Local development"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the Makefile targets in each library repo, my process for developing "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"c/m/c"}]},{"type":"text","value":"s involves making code changes followed by Makefile targets that preview/plan/diff against my AWS account, then running deploy/apply/up and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some sample times for deploying ad hoc stacks with CDK."}]},{"type":"element","tag":"pre","props":{"code":"# CDK ad hoc base deployment time\n\n ‚úÖ  ExampleAdHocBaseStack (dev)\n\n‚ú®  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ‚úÖ  ExampleAdHocAppStack (alpha)\n\n‚ú®  Deployment time: 126.62s\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# CDK ad hoc base deployment time\n\n ‚úÖ  ExampleAdHocBaseStack (dev)\n\n‚ú®  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ‚úÖ  ExampleAdHocAppStack (alpha)\n\n‚ú®  Deployment time: 126.62s\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is an example of what the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi preview"}]},{"type":"text","value":" commands shows for the ad-hoc base stack:"}]},{"type":"element","tag":"pre","props":{"code":"# Pulumi preview\n~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview\nPreviewing update (dev)\n\nView Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   ‚îî‚îÄ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ‚îú‚îÄ pulumi-contrib:components:AlbResources            AlbResources                create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:TargetGroup                            DefaultTg                   create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:LoadBalancer                           LoadBalancer                create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:Listener                               HttpListener                create\n +      ‚îÇ  ‚îî‚îÄ aws:alb:Listener                               HttpsListener               create\n +      ‚îú‚îÄ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:Role                                   BastionHostRole             create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:Instance                               BastionHostInstance         create\n +      ‚îú‚îÄ pulumi-contrib:components:RdsResources            RdsResources                create\n +      ‚îÇ  ‚îú‚îÄ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      ‚îÇ  ‚îî‚îÄ aws:rds:Instance                               DbInstance                  create\n +      ‚îú‚îÄ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ‚îú‚îÄ aws:s3:Bucket                                     assetsBucket                create\n +      ‚îú‚îÄ awsx:ec2:Vpc                                      dev                         create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:Vpc                                    dev                         create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:InternetGateway                     dev                         create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-1               create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-1               create\n +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-1               create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-2               create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-2               create\n +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-2               create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:Eip                              dev-1                       create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:NatGateway                       dev-1                       create\n +      ‚îÇ     ‚îî‚îÄ aws:ec2:Subnet                              dev-public-2                create\n +      ‚îÇ        ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-2                create\n +      ‚îÇ        ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      ‚îÇ        ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-2                create\n +      ‚îÇ        ‚îú‚îÄ aws:ec2:Eip                              dev-2                       create\n +      ‚îÇ        ‚îî‚îÄ aws:ec2:NatGateway                       dev-2                       create\n +      ‚îî‚îÄ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output<string>\n    albSgId                    : output<string>\n    appSgId                    : output<string>\n    assetsBucketName           : output<string>\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output<string>\n    domainName                 : \"example.com\"\n    listenerArn                : output<string>\n    privateSubnetIds           : output<string>\n    rdsAddress                 : output<string>\n    serviceDiscoveryNamespaceId: output<string>\n    vpcId                      : output<string>\n\nResources:\n    + 44 to create\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# Pulumi preview\n~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview\nPreviewing update (dev)\n\nView Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   ‚îî‚îÄ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ‚îú‚îÄ pulumi-contrib:components:AlbResources            AlbResources                create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:TargetGroup                            DefaultTg                   create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:LoadBalancer                           LoadBalancer                create\n +      ‚îÇ  ‚îú‚îÄ aws:alb:Listener                               HttpListener                create\n +      ‚îÇ  ‚îî‚îÄ aws:alb:Listener                               HttpsListener               create\n +      ‚îú‚îÄ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:Role                                   BastionHostRole             create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      ‚îÇ  ‚îú‚îÄ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:Instance                               BastionHostInstance         create\n +      ‚îú‚îÄ pulumi-contrib:components:RdsResources            RdsResources                create\n +      ‚îÇ  ‚îú‚îÄ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      ‚îÇ  ‚îî‚îÄ aws:rds:Instance                               DbInstance                  create\n +      ‚îú‚îÄ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ‚îú‚îÄ aws:s3:Bucket                                     assetsBucket                create\n +      ‚îú‚îÄ awsx:ec2:Vpc                                      dev                         create\n +      ‚îÇ  ‚îî‚îÄ aws:ec2:Vpc                                    dev                         create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:InternetGateway                     dev                         create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-1               create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-1               create\n +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-1               create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-2               create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-2               create\n +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-2               create\n +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-1                create\n +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:Eip                              dev-1                       create\n +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:NatGateway                       dev-1                       create\n +      ‚îÇ     ‚îî‚îÄ aws:ec2:Subnet                              dev-public-2                create\n +      ‚îÇ        ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-2                create\n +      ‚îÇ        ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      ‚îÇ        ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-2                create\n +      ‚îÇ        ‚îú‚îÄ aws:ec2:Eip                              dev-2                       create\n +      ‚îÇ        ‚îî‚îÄ aws:ec2:NatGateway                       dev-2                       create\n +      ‚îî‚îÄ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output<string>\n    albSgId                    : output<string>\n    appSgId                    : output<string>\n    assetsBucketName           : output<string>\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output<string>\n    domainName                 : \"example.com\"\n    listenerArn                : output<string>\n    privateSubnetIds           : output<string>\n    rdsAddress                 : output<string>\n    serviceDiscoveryNamespaceId: output<string>\n    vpcId                      : output<string>\n\nResources:\n    + 44 to create\n"}]}]},{"type":"element","tag":"h2","props":{"id":"running-infrastructure-pipelines-in-github-actions"},"children":[{"type":"text","value":"Running infrastructure pipelines in GitHub Actions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".github/workflows"}]},{"type":"text","value":" directory of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"text","value":" repo, I will have the following "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"2 * 2 * 2 * 3 = 24"}]},{"type":"text","value":" pipelines for running infrastructure as code pipelines:"}]},{"type":"element","tag":"pre","props":{"code":"{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n"}]}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For CDK I'm using CDK CLI commands"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For Terraform I'm also using terraform CLI commands"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For Pulumi I'm using the official Pulumi GitHub Action"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pulumi has "},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/docs/guides/continuous-delivery/github-actions/","rel":["nofollow"]},"children":[{"type":"text","value":"a great article"}]},{"type":"text","value":" about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The general pattern that all of these pipelines use is:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Do a synth/plan/preview, and upload the synth/plan/preview file to an artifact"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pause and wait on manual review of the planned changes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"download the artifact and run deploy/apply/up against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I do this by having two jobs in each GitHub Action: one for synth/plan/preview and one for deploy/apply/up."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The job for deploy/apply/up includes an "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"environment"}]},{"type":"text","value":" that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job."}]},{"type":"element","tag":"h2","props":{"id":"application-deployments"},"children":[{"type":"text","value":"Application deployments"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The backend deployment script runs database migrations, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks."}]}]},{"type":"element","tag":"h2","props":{"id":"interacting-with-aws-via-iac"},"children":[{"type":"text","value":"Interacting with AWS via IaC"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides "},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/cdk/v2/guide/constructs.html","rel":["nofollow"]},"children":[{"type":"text","value":"L1, L2 and L3 constructs"}]},{"type":"text","value":" which offer different levels of abstraction over CloudFormation."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform has the "},{"type":"element","tag":"a","props":{"href":"https://registry.terraform.io/providers/hashicorp/aws/latest/docs","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Provider"}]},{"type":"text","value":" and the "},{"type":"element","tag":"a","props":{"href":"https://registry.terraform.io/namespaces/terraform-aws-modules","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-modules"}]}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pulumi has AWS Classic ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"@pulumi/aws"}]},{"type":"text","value":") "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"provider"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWSx"}]},{"type":"text","value":" ("},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/registry/packages/awsx/","rel":["nofollow"]},"children":[{"type":"text","value":"Crosswalk for Pulumi"}]},{"type":"text","value":") "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"library"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_native"}]},{"type":"text","value":" "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"provider"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_native"}]},{"type":"text","value":" \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\""}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_native"}]},{"type":"text","value":" looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For CDK I use mostly L2 constructs and some L1 constructs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Fot Terraform I use the VPC from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-modules"}]},{"type":"text","value":", and everything else uses the AWS Terraform Provider."}]},{"type":"element","tag":"h2","props":{"id":"what-i-did-not-put-in-iac"},"children":[{"type":"text","value":"What I did not put in IaC"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ECR (Elastic Container Registry)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ACM (Amazon Certificate Manager)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"(Roles used for deployments)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I created the Elastic Container Registry "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"frontend"}]},{"type":"text","value":" repos manually in the AWS Console. I also manually requested an ACM certificate for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.mydomain.com"}]},{"type":"text","value":" for the domain that I use for testing that I purchased through Route53 domains."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog."}]},{"type":"element","tag":"h2","props":{"id":"tagging"},"children":[{"type":"text","value":"Tagging"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Terraform and CDK both make it easy to automatically tag all resources in a stack"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It is possible to do this in Pulumi, but you need to write a little bit of code."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Automatically tagging resources works through "},{"type":"element","tag":"a","props":{"href":"https://www.pulumi.com/docs/intro/vs/terraform/","rel":["nofollow"]},"children":[{"type":"text","value":"stack transformations"}]},{"type":"text","value":" are unique to Pulumi"}]}]},{"type":"element","tag":"h2","props":{"id":"smoke-checking-application-environments"},"children":[{"type":"text","value":"Smoke checking application environments"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the list of things I check when standing up an application environment:"}]},{"type":"element","tag":"ul","props":{"className":["contains-task-list"]},"children":[{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Run the init/tsc, synth/plan/preview and deploy/apply/up commands successfully"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Access the bastion host ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"make aws-ssm-start-session"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Run ECSExec to access a shell in a backend container ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"make aws-ecs-exec"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Test database connectivity ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python manage.py showmigrations"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Run the migrations ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python manage.py migrate"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Run collectstatic ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"python manage.py collectstatic"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Visit the site ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"alpha.example.com"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Publish a blog post"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Publish a blog post with an image"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Check celery worker logs for successfully complete scheduled tasks"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Trigger an autoscaling event by running k6 load tests against an environment"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Destroy the app stack"}]},{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Destroy the base stack"}]}]},{"type":"element","tag":"h2","props":{"id":"backlog-and-next-steps"},"children":[{"type":"text","value":"Backlog and next steps"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are some of the next things I'll be working on in these project, roughly in order of importance:"}]},{"type":"element","tag":"ul","props":{"className":["contains-task-list"]},"children":[{"type":"element","tag":"li","props":{"className":["task-list-item"]},"children":[{"type":"element","tag":"input","props":{"checked":true,"disabled":true,"type":"checkbox"},"children":[]},{"type":"text","value":" Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Show how to do account isolation (different accounts for prod vs pre-prod environments)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"GitHub Actions deployment pipeline for publishing "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pulumi-aws-django"}]},{"type":"text","value":" package"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"random"}]},{"type":"text","value":" functions to do this"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Refactor GitHub Actions and make them reusable across different projects"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use graviton instances and have the option to select between different architectures"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Standardize all resources names across CDK, Terraform and Pulumi"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Pulumi components that define the resources associated with each ECS service are not very dry"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you want to get involved or help with any of the above, please let me know!"}]},{"type":"element","tag":"h2","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I first started out with IaC following this project "},{"type":"element","tag":"a","props":{"href":"https://github.com/aws-samples/ecs-refarch-cloudformation","rel":["nofollow"]},"children":[{"type":"text","value":"aws-samples/ecs-refarch-cloudformation"}]},{"type":"text","value":" (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"eli5","depth":2,"text":"eli5"},{"id":"why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi","depth":2,"text":"Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi"},{"id":"cdkterraformpulumi-terminology","depth":2,"text":"CDK/Terraform/Pulumi terminology","children":[{"id":"constructs-modules-and-components","depth":3,"text":"constructs, modules and components"},{"id":"what-is-a-stack","depth":3,"text":"what is a stack?"},{"id":"verbs","depth":3,"text":"verbs"}]},{"id":"infrastructure-as-code-library-repos","depth":2,"text":"Infrastructure as Code library repos","children":[{"id":"language","depth":3,"text":"Language"},{"id":"release-management-versioning-and-publishing","depth":3,"text":"Release management, versioning and publishing"},{"id":"makefile-examples-and-local-development","depth":3,"text":"Makefile, examples and local development"},{"id":"ad-hoc-vs-prod","depth":3,"text":"ad-hoc vs prod"},{"id":"directory-structure","depth":3,"text":"Directory structure"},{"id":"cloc","depth":3,"text":"CLOC"}]},{"id":"communities","depth":2,"text":"Communities"},{"id":"Œºblog","depth":2,"text":"Œºblog","children":[{"id":"mono-repo-structure","depth":3,"text":"Mono-repo structure"}]},{"id":"splitting-up-the-stacks","depth":2,"text":"Splitting up the stacks"},{"id":"ad-hoc-base-overview","depth":2,"text":"Ad hoc base overview","children":[{"id":"visualization","depth":3,"text":"Visualization"},{"id":"inputs","depth":3,"text":"Inputs"},{"id":"vpc","depth":3,"text":"VPC"},{"id":"security-groups","depth":3,"text":"Security Groups"},{"id":"load-balancer-resources","depth":3,"text":"Load Balancer Resources"},{"id":"rds-resources","depth":3,"text":"RDS Resources"},{"id":"bastion-host","depth":3,"text":"Bastion Host"},{"id":"outputs","depth":3,"text":"Outputs"}]},{"id":"ad-hoc-app-overview","depth":2,"text":"Ad hoc app overview","children":[{"id":"ecs-cluster","depth":3,"text":"ECS Cluster"},{"id":"shared-environment-variables","depth":3,"text":"Shared environment variables"},{"id":"route53-record","depth":3,"text":"Route53 Record"},{"id":"redis","depth":3,"text":"Redis"},{"id":"web-service","depth":3,"text":"Web Service"},{"id":"celery","depth":3,"text":"Celery"},{"id":"management-command","depth":3,"text":"Management Command"},{"id":"passing-data-between-stacks","depth":3,"text":"Passing data between stacks"}]},{"id":"cli-scaffolding","depth":2,"text":"CLI scaffolding"},{"id":"best-practices","depth":2,"text":"Best practices"},{"id":"environment-configuration","depth":2,"text":"Environment configuration"},{"id":"local-development","depth":2,"text":"Local development"},{"id":"running-infrastructure-pipelines-in-github-actions","depth":2,"text":"Running infrastructure pipelines in GitHub Actions"},{"id":"application-deployments","depth":2,"text":"Application deployments"},{"id":"interacting-with-aws-via-iac","depth":2,"text":"Interacting with AWS via IaC"},{"id":"what-i-did-not-put-in-iac","depth":2,"text":"What I did not put in IaC"},{"id":"tagging","depth":2,"text":"Tagging"},{"id":"smoke-checking-application-environments","depth":2,"text":"Smoke checking application environments"},{"id":"backlog-and-next-steps","depth":2,"text":"Backlog and next steps"},{"id":"conclusion","depth":2,"text":"Conclusion"}]}},"_type":"markdown","_id":"content:2023:01:07:i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","_source":"content","_file":"2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","_stem":"2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","_extension":"md"},{"_path":"/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","_dir":"27","_draft":false,"_partial":false,"_locale":"","title":"Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions","description":"This article will show how software development teams can build on-demand environments for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete instances of a web application.","date":"2022-06-11","image":"/static/adhoc.png","tags":["django","terraform","github-actions","aws","ecs","containers","docker"],"external":[{"link":"https://news.ycombinator.com/item?id=31704417","site":"hn"},{"link":"https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/","site":"reddit"},{"link":"https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh","site":"dev"},{"link":"https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539","site":"medium"},{"link":"https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions","site":"hashnode"},{"link":"https://twitter.com/briancaffey/status/1535683865330831360","site":"twitter"},{"link":"https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments","site":"substack"},{"link":"https://hackernoon.com/ad-hoc-environments-for-django-applications-with-ecs-terraform-and-github-actions","site":"hackernoon"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"tldr"},"children":[{"type":"text","value":"tl;dr"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article will show how software development teams can build on-demand instances of a web application project for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete environments. It will focus on the technical implementation of building ad hoc environments using a specific set of tools (including AWS ECS, Terraform and GitHub Actions). I will also be giving context on high-level implementation decisions based on what I think are best practices guided by the "},{"type":"element","tag":"a","props":{"href":"https://12factor.net/","rel":["nofollow"]},"children":[{"type":"text","value":"12-Factor Application methodology"}]},{"type":"text","value":". If any of this interests you, please have a read and let me know what you think in the comments on the outlets where I'll be sharing this article (links at the end)."}]},{"type":"element","tag":"h2","props":{"id":"github-links"},"children":[{"type":"text","value":"GitHub Links"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article references three open-source code repositories on GitHub."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/django-step-by-step","rel":["nofollow"]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this repo contains an example microblogging application called Œºblog built with Django"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the same application is implemented as a traditional Model Template View (MTV) site, a decoupled REST API and Javascript web application and a GraphQL API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"it is a monorepo that also includes a frontend Vue.js application, CI/CD pipelines, a VuePress documentation site as well as tooling and instructions for settings up a local development environments (both with and without docker)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"it includes a complete set of GitHub Action examples for automating the processes of creating, updating and destroying ad hoc environments that will be an important part of what is covered in this article"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/terraform-aws-django","rel":["nofollow"]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a collection of modules for running Django applications on AWS using Terraform"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"one of the submodules can be used for creating ad hoc environments which will be what we use to create ad hoc environments"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this module has been published to Terraform Registry and is used in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform/live/ad-hoc"}]},{"type":"text","value":" directory of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"text","value":" repo"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/terraform-aws-ad-hoc-environments","rel":["nofollow"]},"children":[{"type":"text","value":"terraform-aws-ad-hoc-environments"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a Terraform module that provides shared infrastructure used by ad hoc environments (including VPC, RDS instance, bastion host, security groups and IAM roles, etc.)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this module has also been published to Terraform Registry and is also used in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this module is designed to be used with the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform-aws-django"}]},{"type":"text","value":" Terraform module"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"assumptions"},"children":[{"type":"text","value":"Assumptions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are all sorts of applications, and all sort of engineering teams. For some context on what I'm describing in this article, here are some basic assumptions that I'm making about the type of engineering team and software application product that would be a good fit for this type of development workflow."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"engineering team is composed of a backend team, a frontend team, a devops team and works closely with a product team"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend team primarily develops a REST API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"frontend team develops a JavaScript SPA (frontend website)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"SPA consumes backend REST API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"product team frequently needs to demo applications to prospective clients"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"development teams don't have deep expertise in infrastructure, containers, CI/CD or automation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"devops team has been tasked with building automation that will allow anyone on the team to quickly spin up a complete environment for testing and demoing purposes within minutes"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here are assumptions about specific tools and technologies used at the company:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend is a REST API developed with Django and a Postgres database"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend is packaged into a docker container"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"frontend is also packaged into a docker container using multi-stage builds and NGINX"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"frontend does not require any build-time configuration (all configuration needed by frontend is fetched from backend)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend application's configuration is driven by plain-text environment variables at run-time"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"engineering team uses AWS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"automation pipeline exists for building, tagging and pushing backend and frontend container images to an ECR repository"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"devops team uses AWS ECS for running containerized workloads"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"devops team uses Terraform for provisioning infrastructure"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"devops team uses GitHub Actions for building automation pipelines"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"team is somewhat cost-conscious"}]}]},{"type":"element","tag":"h2","props":{"id":"what-are-ad-hoc-environments"},"children":[{"type":"text","value":"What are ad hoc environments?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ad hoc environments are short-lived environments that are designed to be used for testing a specific set of features or for demoing a specific application configuration in an isolated environment. It is intended to be a functional duplicate of the main production environment. An ad hoc environment is the first cloud environment that the application code will be deployed to after a developer has been working on it in a local development environment."}]},{"type":"element","tag":"h2","props":{"id":"trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation"},"children":[{"type":"text","value":"Trade-offs to make when designing ad hoc environment infrastructure and automation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have a sense of what we are building and the team we are working with, let's think about the high-level trade-offs that we will face as we build a solution for providing on-demand ad hoc environments. When building infrastructure and workflows for ad hoc environments, there are a few things to solve for:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"simplicity of the end-user interface and process for requesting an ad hoc environment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"startup speed"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"total cost of ownership"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"degree of similarity to production environments"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"shared vs isolated resources"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"automation complexity"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's look at these items by considering how we can set up the main infrastructure components that will be used to run our ad hoc application environments."}]},{"type":"element","tag":"h3","props":{"id":"relational-databases"},"children":[{"type":"text","value":"Relational Databases"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Startup speed can be measured by the time between when an environment is requested and when that environment can be used by whoever requested it. In this period of time, an automation pipeline may do some of the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform init"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":" to build infrastructure"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"run scripts to prepare the application such as database migrations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"seeding initial sample data with a script or database dump"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"message the user with information about the environment (URLs, commands for accessing an interactive shell, etc.)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"RDS instances can take a long time to create relative to other AWS resources such as S3 buckets and IAM roles. RDS instances are also more costly than other resources. We could use a single, shared RDS instance placed in a private subnet of a shared VPC. Each ad hoc environment could use a different named database in the RDS instance in the form "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ad-hoc-env-name}-db"}]},{"type":"text","value":". Using one RDS instance per ad hoc environment would be slow to startup and tear down and also costly if there are many developers using ad hoc environments simultaneously."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If we choose to isolate the application's relational database at the database level (and not the RDS instance level), then we will need our automation workflow to create a database per ad hoc environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's spin up a simple example to illustrate how this would would work."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A developer is working on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" that involves a significant refactor of the data model."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The developer decides to spin up an ad hoc environment called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Our automation will need to create a database in the RDS instance called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"We can configure a bastion host with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"psql"}]},{"type":"text","value":" installed that has network and security group access to our RDS instance, and we can give our GitHub Actions an SSH key that can be used to run "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"createdb"}]},{"type":"text","value":" over SSH."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The automation also runs database migrations once the application has started, and we can view the logs of the database migration to check for any irregularities or other issues."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This will give the developer and the rest of team confidence that the promoting "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" to the next pre-production environments will not have any errors."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The developer may even choose to load a SQL dump of the next pre-production environment into their "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" database get even more confidence that there will be no data integrity errors."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"When the developer's PR is merged and approved, the ad hoc environment "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" can be destroyed, including the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" database in the shared RDS instance."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this approach we won't incur the costs of multiple RDS instances. Ad hoc environments will start up faster because an RDS instance per environment is not required. We do have slightly less resource isolation, and we need to introduce a bastion host, but I consider this an acceptable trade-off."}]},{"type":"element","tag":"h3","props":{"id":"redis-key-value-database"},"children":[{"type":"text","value":"Redis (key-value database)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Redis is another database used in the application and it plays a few different roles:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"primarily, it is a caching layer that can cache request responses to reduce load on the database and speed up our application"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"it is a message broker for our async task workers (celery)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"it can be used as a backend for other 3rd party Django apps that our main application may need to use (such as django-constance, cache-ops, django-channels, etc.)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AWS offers a managed Redis service called ElastiCache. Redis running on an ElastiCache instance can do database isolation similar to how Postgres running on RDS can do database isolation as we discussed previously, but there are some key differences:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"redis databases are numbered, not named"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the backend application uses isolated numbered databases for the different 3rd party apps that I just mentioned (for example: celery can use database "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":",  API caching layer can use database "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":", etc.)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This makes it difficult to use a single ElastiCache instance for our ad hoc environments since we would need to figure out which numbered database to assign to a specific role for each ad hoc environment (e.g. how do we know which numbered database to use for the API caching for the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"feature-abc"}]},{"type":"text","value":" ad hoc environment)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"So how can we approach providing isolated redis instances for multiple ad hoc environments? Spoiler: my solution is to run redis as a stateful service in ECS. Before we dig into how to do this, we need to talk about another important part of our application: compute."}]},{"type":"element","tag":"h3","props":{"id":"compute"},"children":[{"type":"text","value":"Compute"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Our backend application is composed of a few different services that all share the same code base. In other words, our backend's services uses the same docker image but run different processes for each component:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"gunicorn for the core API"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"celery for the task workers"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"celerybeat for task scheduling"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If our application used websockets, we could have another service that runs an asgi server process (like daphne or uvicorn)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since our backend application is packaged into a container and we are using AWS as our cloud provider, ECS is a great choice for running our backend services. ECS is a container orchestration tool that I usually describe as a nice middle ground between docker swarm and Kubernetes. Simply put, it is a flexible option for running our containerized services that make up our backend application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With ECS you can choose to run containers directly on EC2 instances that you manage, or you can run containers using Fargate. Fargate is a serverless compute option that takes care of managing both the underlying \"computer\" and operating system that run our application's containers. All of our backend dependencies are defined in our Dockerfile, so we do not to maintain or update the underlying operating system that runs our containers -- AWS handles all of this for us. To use Fargate, we simply tell AWS which containers to run and how much CPU and memory to use in the ECS Task that runs the containers. To scale our app horizontally, the ECS service that managed ECS tasks simply increases the number of tasks that run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since we are going to use the Fargate launch type for our ECS Tasks, let's talk about the ergonomics of these serverless compute instances compared to running our services directly on an EC2 instances."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"We can't SSH into Fargate compute instances. We can instead use AWS Systems Manager and EcsExec to open an interactive shell in a running backend container. This can be useful for developers who might need to run a management command or access an interactive Django shell to verify behavior in their ad hoc environment."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"We can't simply change code on the server and restart services. This can sometimes be a useful pattern for debugging something that can only be tested on a cloud environment (e.g. something that can't easily be reproduced on your local machine), so this requires that developers push new images to their backend services for every change they want to see reflected on their ad hoc environment. Later on I'll discuss how we can provide tooling for developers to quickly update the image used in their backend services."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With AWS Fargate, you will pay more than you would for a comparable amount of CPU and memory on EC2 instances. Similar to EC2 spot instances, Fargate offers interruptable instances called Fargate Spot which costs significantly less than regular Fargate instances. Fargate spot is appropriate for our ad hoc environments since ad hoc environments are non-critical workloads. In the event that a Fargate spot instance is interrupted, the ECS service will automatically launch another Fargate task to replace the task that was stopped."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my opinion, ECS with Fargate is ideal for running the stateless services that make up our backend application. In terms of parity with our production environment, we can keep almost everything the same, except use regular Fargate instances instead of Fargate spot instances."}]},{"type":"element","tag":"h3","props":{"id":"redis-revisited"},"children":[{"type":"text","value":"Redis, revisited"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can run redis as an ECS service instead of using ElastiCache. In order to do this, we will need our backend services (gunicorn, celery and celerybeat) to be able to communicate with a fourth ECS service that will be running redis (using an official redis image from Docker Hub, or a redis image that we define in ECR)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default, "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"there is no way for our backend services to know how to communicate with any other service in our ECS cluster"}]},{"type":"text","value":". If you have used docker-compose, you may know that you can use the service name "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":" in a backend service to easily communicate with a redis service called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis"}]},{"type":"text","value":". This networking convenience is not available to use out of the box with ECS. To achieve this in AWS, we need some way to manage a unique ad hoc environment-specific Route 53 DNS record that points to the private IP of the Fargate task that is running redis in an ECS cluster for a given ad hoc environment. Such a service exists in AWS and it is called Cloud Map. Cloud Map offers service discovery so that our backend services can make network calls to a static DNS address that will reliably point to the correct private IP of the ECS task running the redis container."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can define a service discovery namespace (which will essentially be a top level domain, or TLD) that all of our ad hoc environments can share. Let's assume this namespace is called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad-hoc"}]},{"type":"text","value":". Each ad hoc environment can then define a service discovery service in the shared namespace for redis that is called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ad-hoc-env-name}-redis"}]},{"type":"text","value":". This way, we can have a reliable address that we can configure as an environment for our backend that will look like this: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"redis://{ad-hoc-env-name}-redis.ad-hoc:6379/0"}]},{"type":"text","value":". "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ad-hoc-env-name-redis}.ad-hoc"}]},{"type":"text","value":" will be the hostname of the redis service, and Route 53 will create records that point to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ad-hoc-env-name}-redis.ad-hoc"}]},{"type":"text","value":" to the private IP of the redis Fargate task for each ad hoc environment."}]},{"type":"element","tag":"h3","props":{"id":"load-balancing"},"children":[{"type":"text","value":"Load Balancing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We now have our backend services (gunicorn, celery and celerybeat) running on Fargate spot instances, and these services can communicate with the redis service in our ad hoc environment's ECS cluster using service discovery that we configured with Cloud Map. We still need to think about a few things:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"how will we expose our API service to the public (or private) internet"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"how will we expose our frontend application to the public (or private) internet"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"how will we make sure that requests go the correct ECS services"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Application load balancers (ALBs) are a great way to expose web app traffic to the internet. We could either have one application load balancer per ad hoc environment, or one application load balancer shared between all ad hoc environments. ALBs are somewhat slow to create and they also incur a significant monthly cost. They are also highly scalable, so using a shared ALB for all ad hoc environments would work."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Individual ad hoc environments can then create target groups and listener rules for a shared ALB for each service that needs to serve requests from the internet (the backend and the frontend). In our case this is the backend API server and the frontend server that serves our static frontend site using NGINX."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ECS services that need to be exposed to the internet can specify the target group, port and container to use for load balancing. A target group is created that defines the health check and other settings, and a load balancer listener rule is created on the shared load balancer that will forward traffic matching certain conditions to the target group for our service."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For a given ad hoc environment, we need to specify that only traffic with certain paths should be sent to the backend service, and all other traffic should be sent to the frontend service. For example, we may only want to send traffic that starts with the path "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" to the backend target group, and all other traffic should be sent to the frontend target group. We can do this by setting conditions on the listener rules that forward traffic do the frontend and backend target groups based on the hostname and path."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We want our listener rule logic to forward "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/api"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/admin"}]},{"type":"text","value":" and any other backend traffic to the backend target group, and forward all other traffic ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/*"}]},{"type":"text","value":") to the frontend target group. In order to do this, we need the backend listener rule to have a higher priority than the frontend listener rule for each ad hoc environment. Since we are using the same load balancer for all ad hoc environments, the priority values for each listener rule need to be unique. If we don't set the priority explicitly, then the priority will be set automatically to the next available value in ascending order. In order to make sure that the backend listener rule has a higher priority than the frontend listener rule for each ad hoc environment, we need to tell Terraform that the frontend module "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"depends_on"}]},{"type":"text","value":" the backend module. This way the backend listener rule will have a higher priority (e.g. priority of 1) because it will be created first, and the frontend listener rule will have a lower priority (e.g. priority of 2)."}]},{"type":"element","tag":"h2","props":{"id":"more-on-shared-resources-vs-per-environment-resources"},"children":[{"type":"text","value":"More on shared resources vs per-environment resources"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Up until now we have discussed infrastructure design decisions at a high level, but we have not yet talked about how to organize our infrastructure as code. At a basic level, components of our ad hoc environment either fall into shared infrastructure or infrastructure that is specific to an individual ad hoc environment. Here's a list of the resources that are shared and the resources that are specific to each ad hoc environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Shared resources include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"VPC"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"IAM policies"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Security groups"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"RDS instance"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Service Discovery namespace"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Application Load Balancer"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Bastion host"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ad hoc environment resources include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ECS Cluster"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ECS Tasks and Services (for backend and frontend applications)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ECS Tasks for running management commands (such as migrate)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CloudWatch logging groups for containers defined in ECS Tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ALB Target groups"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ALB listener rules"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Route 53 record that points to the load balancer (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad-hoc-env-name.example.com"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"S3 bucket for static and media assets"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Service Discovery Service for redis service in ECS cluster"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Shared resources can be defined in one terraform configuration and deployed once. These resources will be long-lived as long as the application is under active development and the team requires on-demand provisioning of ad hoc environments."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ad hoc environment resources can be defined in another terraform configuration that references outputs from the shared resource configuration using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform_remote_state"}]},{"type":"text","value":". Each ad hoc environment can be defined by a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file that contains the name of the ad hoc environment (such as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian2"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"demo-feature-abc"}]},{"type":"text","value":", etc.). This "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>"}]},{"type":"text","value":" value will also be the name of the Terraform workspace and will be used to name and tag AWS resources associated with the corresponding ad hoc environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file will allow developers to use a simple, standard file interface for defining application specific values, such as the version of the backend and frontend. This brings developers into the concepts and practices of \"infrastructure as code\" and \"configuration as code\" and also helps the entire team keep track of how different environments are configured."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ad hoc environment "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" files are stored in a directory of a special git repository that also defines the ad hoc environment terraform configuration. Currently, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tfvars"}]},{"type":"text","value":" files are stored "},{"type":"element","tag":"a","props":{"href":"https://github.com/briancaffey/django-step-by-step/tree/main/terraform/live/ad-hoc/envs","rel":["nofollow"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now let's look at the two terraform configurations used for defining "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"shared resources"}]},{"type":"text","value":" and "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"ad hoc environment resources"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"ad-hoc-environment-diagram"},"children":[{"type":"text","value":"Ad Hoc Environment Diagram"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an overview of the resources used for the ad hoc environments. The "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"letters represent shared resources"}]},{"type":"text","value":" and the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"numbers represent per-environment resources"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/adhoc.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"shared-architecture"},"children":[{"type":"text","value":"Shared architecture"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A. VPC (created using the "},{"type":"element","tag":"a","props":{"href":"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest","rel":["nofollow"]},"children":[{"type":"text","value":"official AWS VPC Module"}]},{"type":"text","value":")"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"B. Public subnets for bastion host, NAT Gateways and Load Balancer"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C. Private subnets for application workloads and RDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"D. Application Load Balancer that is shared between all ad hoc environments. A pre-provisioned wildcard ACM certificate is attached to the load balancer that is used to secure traffic for load-balanced ECS services"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"E. Service discovery namespace that provides a namespace for application workloads to access the redis service running in ECS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"F. IAM roles needed for ECS tasks to access AWS services"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"G. RDS instance using postgres engine that is shared between all ad hoc environments"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"H. Bastion host used to access RDS from GitHub Actions (needed for creating per-environment databases)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I. NAT Gateway used to give traffic in private subnets a route to the public internet"}]},{"type":"element","tag":"h3","props":{"id":"environment-specific-architecture"},"children":[{"type":"text","value":"Environment-specific architecture"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ECS Cluster that groups all ECS tasks for a single ad hoc environment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Listener rules and target groups that direct traffic from the load balancer to the ECS services for an ad hoc environment."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Redis service running in ECS that provides caching and serves as a task broker for celery"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Route53 records that point to the load balancer"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Frontend service that serves the Vue.js application over NGINX"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"API service that serves the backend with Gunicorn"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Celery worker that process jobs in the default queue"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Celery beat that schedules celery tasks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"collectstatic"}]},{"type":"text","value":" task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" task"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CloudWatch log groups are created for each ECS task in an ad hoc environment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Each ad hoc environment gets a database in the shared RDS instance"}]}]},{"type":"element","tag":"h2","props":{"id":"shared-resources-terraform-configuration"},"children":[{"type":"text","value":"Shared resources terraform configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's have a detailed look at the terraform configuration for shared resources that will support ad hoc environments."}]},{"type":"element","tag":"h3","props":{"id":"vpc"},"children":[{"type":"text","value":"VPC"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can use the "},{"type":"element","tag":"a","props":{"href":"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest","rel":["nofollow"]},"children":[{"type":"text","value":"AWS VPC module"}]},{"type":"text","value":" for creating the shared VPC with Terraform. This module provides a high level interface that will provision lots of the components that are needed for a VPC following best practices, and it is less code for the DevOps team to manage compared to defining each component of a VPC (route tables, subnets, internet gateways, etc.)."}]},{"type":"element","tag":"h3","props":{"id":"cloud-map-service-discovery-namespace"},"children":[{"type":"text","value":"Cloud Map Service Discovery Namespace"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Cloud Map is used in order to allow services in our ECS cluster to communicate with each other. The only reason that Cloud Map is needed is so that the backend services (API, celery workers, beat) can communicate with Redis, which will be an important service for our application, providing caching and also serving as a broker for celery. If we were to use Django Channels for websockets, the Redis service would also function as the backend for Django Channels."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We will only need to specify "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"service_registries"}]},{"type":"text","value":" on the redis service in our ECS cluster. What this will do is provide an address that our other services can use to communicate with redis. This address is created in the form of a Route 53 record, and it points to the private IP address of the redis service. If the private IP of the redis service is updated, the Route 53 record record for our redis service will be updated as well."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In order for service discovery to work in the VPC that we created, we need to add the following options to the terraform AWS VPC module:"}]},{"type":"element","tag":"pre","props":{"code":"# DNS settings\nenable_dns_hostnames = true\nenable_dns_support   = true\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# DNS settings\nenable_dns_hostnames = true\nenable_dns_support   = true\n"}]}]},{"type":"element","tag":"h3","props":{"id":"security-groups"},"children":[{"type":"text","value":"Security Groups"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two important security groups that we will set up as part of the shared infrastructure layer to be used by each ad hoc environment: one security group for the load balancer, and one security group where all of our ECS services will run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The load balancer security group will allow all traffic on port "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"80"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"443"}]},{"type":"text","value":" for "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HTTP"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"HTTPS"}]},{"type":"text","value":" traffic. The ECS security group will only allow inbound traffic from the application load balancer security group. It will also allow for traffic from port 6379 for redis traffic."}]},{"type":"element","tag":"h3","props":{"id":"iam-roles"},"children":[{"type":"text","value":"IAM Roles"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two important IAM roles that we will need for our ECS tasks. We need a task execution role that our ECS tasks will use to interact with other AWS services, such as S3, Secrets Manager, etc."}]},{"type":"element","tag":"h3","props":{"id":"rds-instance"},"children":[{"type":"text","value":"RDS Instance"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We will create one RDS instance in one of the private subnets in our VPC. This RDS instance will have one Postgres database per ad hoc environment. This RDS instance has a security group that allows all traffic from our ECS security group."}]},{"type":"element","tag":"h3","props":{"id":"load-balancer"},"children":[{"type":"text","value":"Load Balancer"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We will use one load balancer for all ad hoc environments. This load balancer will have a wildcard ACM certificate attached to it ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.dev.example.com"}]},{"type":"text","value":", for example). Each ad hoc environment will create a Route 53 record that will point to this load balancer's public DNS name. For example, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian.dev.example.com"}]},{"type":"text","value":" will be the address of my ad hoc environment. Requests to this address will then be routed to either the frontend ECS service or the backend ECS service depending on request header values and request path values that will be set on the listener rules."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default, a load balancer supports up to 50 listener rules, so we can create plenty of ad hoc environments before we need to increase the default quota. There will be a discussion at the end of this article about AWS service quotas."}]},{"type":"element","tag":"h3","props":{"id":"bastion-host"},"children":[{"type":"text","value":"Bastion Host"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The bastion host will be created in one of the VPC's public subnets. This will primarily be used for connecting to RDS to create new databases for new ad hoc environments, or for manually manipulating data in an ad hoc environment for debugging."}]},{"type":"element","tag":"h2","props":{"id":"ad-hoc-environment-resources"},"children":[{"type":"text","value":"Ad hoc environment resources"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have defined a shared set of infrastructure that our ad hoc environments will use, let's have a look at the resources that will be specific to ad hoc environments that will be added on top of the shared resources."}]},{"type":"element","tag":"h3","props":{"id":"ecs-cluster"},"children":[{"type":"text","value":"ECS Cluster"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The ECS Cluster is a simple grouping of ECS tasks and services."}]},{"type":"element","tag":"h3","props":{"id":"ecs-tasks-and-services"},"children":[{"type":"text","value":"ECS Tasks and Services"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each environment will have a set of ECS tasks and services that will be used to run the application."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are four important ECS services in our application that are used to run \"long-running\" ECS tasks. Long-running tasks are tasks that start processes that run indefinitely, rather than running until completion. The long-running tasks in our application include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend web application (gunciron web server)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend celery worker"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"backend celery beat"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"frontend web site (nginx web server)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"redis"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The infrastructure code also defines some tasks that are not long-running but rather short lived tasks that run until completion and do not start again. These tasks include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"collectstatic"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"database migrations"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"any other ad-hoc task that we want to run, usually wrapped in a Django management command"}]}]},{"type":"element","tag":"h2","props":{"id":"how-to-setup-an-ad-hoc-environment"},"children":[{"type":"text","value":"How to setup an ad hoc environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have been over the resources that will be created to support our ad hoc environments, let's talk about how we can enable individuals on our team to create and update ad hoc environments."}]},{"type":"element","tag":"h3","props":{"id":"design-decisions"},"children":[{"type":"text","value":"Design decisions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The devops team will decide on the interface that will be used for creating an ad hoc environment. Since we are using Terraform, this interface will be a Terraform configuration. The minimum amount of information that our ad hoc environment configuration needs is image tags for the frontend and backend images to use. Other configurations will be provided by default values set in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"variables.tf"}]},{"type":"text","value":", and these defaults can easily be overridden by passing values to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":". I'm choosing to use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" as the way to pass configuration values to our ad hoc environments where "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>"}]},{"type":"text","value":" is the name of the ad hoc environment being created. This will give us the following benefits:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"all ad hoc environments will be visible to the entire team in git since each ad hoc environment will have a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file associated with it"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"adding additional customization to an ad hoc environment does not add additional complexity to our automation pipeline since all customization is added through a single file that will be referenced by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$WORKSPACE.tfvars"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The downsides of this approach are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"creating ad hoc environments requires knowledge of git, so non-technical product team members might need help from the engineering team when setting up an ad hoc environment"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"there is an additional \"manual\" step of creating a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file that must be done before running a pipeline to create an ad hoc environment"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Provided that a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file has been created and pushed to the repo, creating or updating an ad hoc environment will be as simple as running a pipeline in GitHub Actions that specifies the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>"}]},{"type":"text","value":" of our ad hoc environment. If no such "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file exists, our pipeline will fail."}]},{"type":"element","tag":"h3","props":{"id":"github-action"},"children":[{"type":"text","value":"GitHub Action"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Creating ad hoc environments will involve manually triggering a GitHub Action that runs on "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"workflow_dispatch"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"on:\n  workflow_dispatch:\n    inputs:\n      workspace:\n        description: 'Name of terraform workspace to use'\n        required: true\n        default: 'dev'\n        type: string\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"on:\n  workflow_dispatch:\n    inputs:\n      workspace:\n        description: 'Name of terraform workspace to use'\n        required: true\n        default: 'dev'\n        type: string\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We only have to enter the name of the ad hoc environment we want to create or update. The ad hoc environment name is used as the Terraform workspace name. This name is also the name of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file that must be created per environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This workflow will do "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform init"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":" using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<name>.tfvars"}]},{"type":"text","value":" file. When everything has been created, we will use the AWS CLI to prepare the environment so that it can be used. We will use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs run-task"}]},{"type":"text","value":" command to run database migrations needed so that the application code can make database queries."}]},{"type":"element","tag":"h2","props":{"id":"how-to-update-code-in-an-existing-ad-hoc-environment"},"children":[{"type":"text","value":"How to update code in an existing ad hoc environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Assuming that we have deployed an ad hoc environment called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian"}]},{"type":"text","value":" with version "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.0"}]},{"type":"text","value":" of the backend application and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v2.0.0"}]},{"type":"text","value":" of the frontend application, let's think about the process of updating the application to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.1.0"}]},{"type":"text","value":" of the backend and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v2.1.0"}]},{"type":"text","value":" of the frontend."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The simplest approach to updating the application would be edit the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian.tfvars"}]},{"type":"text","value":" file with the new versions:"}]},{"type":"element","tag":"pre","props":{"code":"# brian.tfvars\nbe_image_tag = \"v1.1.0\"\nfe_image_tag = \"v2.1.0\"\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# brian.tfvars\nbe_image_tag = \"v1.1.0\"\nfe_image_tag = \"v2.1.0\"\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If we run the same pipeline that we initially used to deploy ad hoc environment (with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform init"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform plan"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":") against the updated "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian.tfvars"}]},{"type":"text","value":" file, this will result in a rolling update of the frontend and backend services ("},{"type":"element","tag":"a","props":{"href":"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html","rel":["nofollow"]},"children":[{"type":"text","value":"more on rolling updates here"}]},{"type":"text","value":")."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If there are database migrations included in the new version of the code that is going out, we need to run database migrations after the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform apply"}]},{"type":"text","value":" completes. We use a top level output from the ad hov environment terraform configuration that is a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"run-task"}]},{"type":"text","value":" command with all appropriate arguments that will run database migrations when called from GitHub Actions."}]},{"type":"element","tag":"h3","props":{"id":"order-of-operations"},"children":[{"type":"text","value":"Order of Operations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For ad hoc environments, it is probably fine to update the services and then run the database migrations. Ad hoc environments may only have a single \"user\" -- the developer, so "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"we don't need to worry about any errors that may occur if requests are made against the new version of code before database migrations have been applied"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's consider a simple example to illustrate what can go wrong here. If we add a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"total_views"}]},{"type":"text","value":" to our blog post model to track the total number of page views a post has, we would add a field to the model, generate migration file with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"makemigrations"}]},{"type":"text","value":", and then update our views and model serializers to make use of this new field. In the time between updating our service and running the database migrations, any requests to endpoints that access the new database field will fail since the table does not yet exist."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If we first run database migrations "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"and then"}]},{"type":"text","value":" update application code (ECS services), then we can avoid errors about fields not existing. In our production application, we want to aim for fewer errors, so we should be using this \"order of operations\": first run new database migrations and then update application code."}]},{"type":"element","tag":"h3","props":{"id":"github-action-for-application-updates"},"children":[{"type":"text","value":"GitHub Action for application updates"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We need a GitHub Action that can do the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fetch the current container definition JSON files for each backend tasks ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs describe-task-definition"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"write new container definitions JSON with the new backend image tag (using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"jq"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"register new task definitions with the new container definition JSON files for each task ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs register-task-definition"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"call run-task with the newly updated migration ECS task ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs run-task"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"wait for the task to exit and display the logs ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs wait tasks-stopped"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"update the backend services (gunicorn, celery, celery beat) ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs update-service"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"wait for the new backend services to be stable ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs wait services-stable"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a visual representation of the backend update process:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"png","src":"/static/adhoc/ad_hoc.backend_update.drawio.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In order have the correct arguments for all of the AWS CLI calls used in the above workflow, we can use the AWS CLI to fetch resource names by tag."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is what I'm using for the script. There lots of comments, so please refer to those comments for an explanation of what the script is doing."}]},{"type":"element","tag":"pre","props":{"code":"#!/bin/bash\n\n# This script will be called to update an ad hoc environment backend\n# with a new image tag. It will first run pre-update tasks (such as migrations)\n# and then do a rolling update of the backend services.\n\n# It is called from the ad_hock_backend_update.yml GitHub Actions file\n\n# Required environment variables that need to be exported before running this script:\n\n# WORKSPACE - ad hoc environment workspace\n# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n\necho \"Updating backend services...\"\n\n# first define a variable containing the new image URI\nNEW_BACKEND_IMAGE_URI=\"$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/backend:$BACKEND_IMAGE_TAG\"\n\n\n# register new task definitions\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\nfor TASK in \"migrate\" \"gunicorn\" \"default\" \"beat\"\ndo\n  echo \"Updating $TASK task definition...\"\n\n  # in Terraform we name our tasks based on the ad hoc environment name\n  # (also the Terraform workspace name) and the name of the task\n  # (e.g. migrate, gunicorn, default, beat)\n  TASK_FAMILY=$WORKSPACE-$TASK\n\n  # save the task definition JSON to a variable\n  TASK_DESCRIPTION=$(aws ecs describe-task-definition \\\n    --task-definition $TASK_FAMILY \\\n  )\n\n  # save container definitions to a file for each task\n  echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.containerDefinitions \\\n    > /tmp/$TASK_FAMILY.json\n\n  # write new container definition JSON with updated image\n  echo \"Writing new $TASK_FAMILY container definitions JSON...\"\n\n  # replace old image URI with new image URI in a new container definitions JSON\n  cat /tmp/$TASK_FAMILY.json \\\n    | jq \\\n    --arg IMAGE \"$NEW_BACKEND_IMAGE_URI\" '.[0].image |= $IMAGE' \\\n    > /tmp/$TASK_FAMILY-new.json\n\n  # Get the existing configuration for the task definition (memory, cpu, etc.)\n  # from the variable that we saved the task definition JSON to earlier\n  echo \"Getting existing configuration for $TASK_FAMILY...\"\n\n  MEMORY=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.memory \\\n  )\n\n  CPU=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.cpu \\\n  )\n\n  ECS_EXECUTION_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.executionRoleArn \\\n  )\n\n  ECS_TASK_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.taskRoleArn \\\n  )\n\n  # check the content of the new container definition JSON\n  cat /tmp/$TASK_FAMILY-new.json\n\n  # register new task definition using the new container definitions\n  # and the values that we read off of the existing task definitions\n  echo \"Registering new $TASK_FAMILY task definition...\"\n\n  aws ecs register-task-definition \\\n    --family $TASK_FAMILY \\\n    --container-definitions file:///tmp/$TASK_FAMILY-new.json \\\n    --memory $MEMORY \\\n    --cpu $CPU \\\n    --network-mode awsvpc \\\n    --execution-role-arn $ECS_EXECUTION_ROLE_ARN \\\n    --task-role-arn $ECS_TASK_ROLE_ARN \\\n    --requires-compatibilities \"FARGATE\"\n\ndone\n\n# Now we need to run migrate, collectstatic and any other commands that need to be run\n# before doing a rolling update of the backend services\n\n# We will use the new task definitions we just created to run these commands\n\n# get the ARN of the most recent revision of the migrate task definition\nTASK_DEFINITION=$( \\\n  aws ecs describe-task-definition \\\n    --task-definition $WORKSPACE-migrate \\\n    | jq -r \\\n    .taskDefinition.taskDefinitionArn \\\n)\n\n# get private subnets as space separated string from shared resources VPC\nSUBNETS=$( \\\n  aws ec2 describe-subnets \\\n    --filters \"Name=tag:env,Values=$SHARED_RESOURCES_WORKSPACE\" \"Name=tag:Name,Values=*private*\" \\\n    --query 'Subnets[*].SubnetId' \\\n    --output text \\\n)\n\n# replace spaces with commas using tr\nSUBNET_IDS=$(echo $SUBNETS | tr ' ' ',')\n\n# https://github.com/aws/aws-cli/issues/5348\n# get ecs_sg_id - just a single value\nECS_SG_ID=$( \\\n  aws ec2 describe-security-groups \\\n    --filters \"Name=tag:Name,Values=$SHARED_RESOURCES_WORKSPACE-ecs-sg\" \\\n    --query 'SecurityGroups[*].GroupId' \\\n    --output text \\\n)\n\necho \"Running database migrations...\"\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nSTART_TIME=$(date +%s000)\n\n# run the migration task and capture the taskArn into a variable called TASK_ID\nTASK_ID=$( \\\n  aws ecs run-task \\\n    --cluster $WORKSPACE-cluster \\\n    --task-definition $TASK_DEFINITION \\\n    --network-configuration \"awsvpcConfiguration={subnets=[$SUBNET_IDS],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}\" \\\n    | jq -r '.tasks[0].taskArn' \\\n  )\n\necho \"Task ID is $TASK_ID\"\n\n# wait for the migrate task to exit\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n# > It will poll every 6 seconds until a successful state has been reached.\n# > This will exit with a return code of 255 after 100 failed checks.\naws ecs wait tasks-stopped \\\n  --tasks $TASK_ID \\\n  --cluster $WORKSPACE-cluster\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nEND_TIME=$(date +%s000)\n\n# print the CloudWatch log events to STDOUT\naws logs get-log-events \\\n  --log-group-name \"/ecs/$WORKSPACE/migrate\" \\\n  --log-stream-name \"migrate/migrate/${TASK_ID##*/}\" \\\n  --start-time $START_TIME \\\n  --end-time $END_TIME \\\n  | jq -r '.events[].message'\n\necho \"Migrations complete. Starting rolling update for backend services...\"\n\n# update backend services\nfor TASK in \"gunicorn\" \"default\" \"beat\"\ndo\n\n  # get taskDefinitionArn for each service to be used in update-service command\n  # this will get the most recent revision of each task (the one that was just created)\n  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n  TASK_DEFINITION=$( \\\n    aws ecs describe-task-definition \\\n      --task-definition $WORKSPACE-$TASK \\\n      | jq -r \\\n      .taskDefinition.taskDefinitionArn \\\n  )\n\n  # update each service with new task definintion\n  aws ecs update-service \\\n    --cluster $WORKSPACE-cluster \\\n    --service $WORKSPACE-$TASK \\\n    --task-definition $TASK_DEFINITION \\\n    --no-cli-pager\n\ndone\n\necho \"Services updated. Waiting for services to become stable...\"\n\n# wait for all service to be stable (runningCount == desiredCount for each service)\naws ecs wait services-stable \\\n  --cluster $WORKSPACE-cluster \\\n  --services $WORKSPACE-gunicorn $WORKSPACE-default $WORKSPACE-beat\n\necho \"Services are now stable. Backend services are now up to date with $BACKEND_IMAGE_TAG.\"\n\necho \"Backend update is now complete!\"\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"#!/bin/bash\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# This script will be called to update an ad hoc environment backend\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# with a new image tag. It will first run pre-update tasks (such as migrations)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# and then do a rolling update of the backend services.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# It is called from the ad_hock_backend_update.yml GitHub Actions file\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Required environment variables that need to be exported before running this script:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# WORKSPACE - ad hoc environment workspace\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Updating backend services...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# first define a variable containing the new image URI\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"NEW_BACKEND_IMAGE_URI"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$AWS_ACCOUNT_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".dkr.ecr.us-east-1.amazonaws.com/backend:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$BACKEND_IMAGE_TAG"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# register new task definitions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" TASK "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"migrate\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"gunicorn\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"default\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"beat\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"do\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"  echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Updating "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" task definition...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # in Terraform we name our tasks based on the ad hoc environment name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # (also the Terraform workspace name) and the name of the task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # (e.g. migrate, gunicorn, default, beat)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # save the task definition JSON to a variable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  TASK_DESCRIPTION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" describe-task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_FAMILY "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # save container definitions to a file for each task\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"  echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DESCRIPTION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.containerDefinitions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    >"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" /tmp/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # write new container definition JSON with updated image\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"  echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Writing new "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" container definitions JSON...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # replace old image URI with new image URI in a new container definitions JSON\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  cat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" /tmp/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".json"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --arg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" IMAGE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$NEW_BACKEND_IMAGE_URI"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '.[0].image |= $IMAGE'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    >"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" /tmp/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-new.json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # Get the existing configuration for the task definition (memory, cpu, etc.)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # from the variable that we saved the task definition JSON to earlier\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"  echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Getting existing configuration for "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  MEMORY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DESCRIPTION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  CPU"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DESCRIPTION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.cpu"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  ECS_EXECUTION_ROLE_ARN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DESCRIPTION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.executionRoleArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  ECS_TASK_ROLE_ARN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DESCRIPTION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.taskRoleArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # check the content of the new container definition JSON\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  cat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" /tmp/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-new.json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":74},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":75},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # register new task definition using the new container definitions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":76},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # and the values that we read off of the existing task definitions\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":77},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"  echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Registering new "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" task definition...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":78},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":79},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" register-task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":80},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --family"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_FAMILY "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":81},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --container-definitions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" file:///tmp/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_FAMILY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-new.json"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":82},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $MEMORY "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":83},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --cpu"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $CPU "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":84},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --network-mode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" awsvpc"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":85},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --execution-role-arn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $ECS_EXECUTION_ROLE_ARN "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":86},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task-role-arn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $ECS_TASK_ROLE_ARN "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":87},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --requires-compatibilities"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"FARGATE\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":88},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":89},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"done\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":90},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":91},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# Now we need to run migrate, collectstatic and any other commands that need to be run\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":92},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# before doing a rolling update of the backend services\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":93},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":94},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# We will use the new task definitions we just created to run these commands\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":95},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":96},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# get the ARN of the most recent revision of the migrate task definition\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":97},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"TASK_DEFINITION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":98},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" describe-task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":99},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-migrate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":100},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":101},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    .taskDefinition.taskDefinitionArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":102},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":103},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":104},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# get private subnets as space separated string from shared resources VPC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":105},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"SUBNETS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":106},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ec2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" describe-subnets"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":107},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --filters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Name=tag:env,Values="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$SHARED_RESOURCES_WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Name=tag:Name,Values=*private*\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":108},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --query"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'Subnets[*].SubnetId'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":109},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":110},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":111},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":112},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# replace spaces with commas using tr\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":113},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"SUBNET_IDS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $SUBNETS "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" tr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ' '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ','"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":114},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":115},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# https://github.com/aws/aws-cli/issues/5348\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":116},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# get ecs_sg_id - just a single value\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":117},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ECS_SG_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":118},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ec2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" describe-security-groups"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":119},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --filters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Name=tag:Name,Values="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$SHARED_RESOURCES_WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-ecs-sg\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":120},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --query"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'SecurityGroups[*].GroupId'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":121},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" text"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":122},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":123},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":124},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Running database migrations...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":125},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":126},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":127},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"START_TIME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"date"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" +%s000"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":128},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":129},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# run the migration task and capture the taskArn into a variable called TASK_ID\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":130},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"TASK_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":131},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" run-task"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":132},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":133},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DEFINITION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":134},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --network-configuration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"awsvpcConfiguration={subnets=["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$SUBNET_IDS"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"],securityGroups=["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$ECS_SG_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"],assignPublicIp=ENABLED}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":135},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '.tasks[0].taskArn'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":136},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":137},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":138},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Task ID is "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":139},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":140},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# wait for the migrate task to exit\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":141},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":142},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# > It will poll every 6 seconds until a successful state has been reached.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":143},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# > This will exit with a return code of 255 after 100 failed checks.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":144},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" wait"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" tasks-stopped"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":145},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --tasks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_ID "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":146},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-cluster\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":147},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":148},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":149},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"END_TIME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"date"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" +%s000"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":150},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":151},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# print the CloudWatch log events to STDOUT\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":152},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" logs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" get-log-events"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":153},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --log-group-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/ecs/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"/migrate\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":154},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --log-stream-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"migrate/migrate/${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"TASK_ID"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"##*/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":155},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --start-time"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $START_TIME "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":156},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --end-time"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $END_TIME "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":157},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '.events[].message'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":158},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":159},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Migrations complete. Starting rolling update for backend services...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":160},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":161},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# update backend services\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":162},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" TASK "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"gunicorn\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"default\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"beat\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":163},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"do\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":164},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":165},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # get taskDefinitionArn for each service to be used in update-service command\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":166},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # this will get the most recent revision of each task (the one that was just created)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":167},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":168},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  TASK_DEFINITION"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$( "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":169},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" describe-task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":170},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"      --task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":171},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":172},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"      .taskDefinition.taskDefinitionArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":173},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  )\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":174},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":175},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  # update each service with new task definintion\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":176},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" update-service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":177},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":178},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$TASK "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":179},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task-definition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_DEFINITION "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":180},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --no-cli-pager\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":181},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":182},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"done\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":183},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":184},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Services updated. Waiting for services to become stable...\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":185},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":186},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"# wait for all service to be stable (runningCount == desiredCount for each service)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":187},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" wait"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" services-stable"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":188},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":189},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --services"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-gunicorn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $WORKSPACE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"-beat\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":190},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":191},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Services are now stable. Backend services are now up to date with "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$BACKEND_IMAGE_TAG"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":".\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":192},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":193},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"Backend update is now complete!\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With this GitHub Actions workflow, a developer can now easily change the version of backend code that is running in their ad hoc environments without needing to involve Terraform. Using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad_hoc_backend_update.yml"}]},{"type":"text","value":" GitHub Actions workflow, a developer only needs to enter the name of the workspace and the version of the backend code they want to use. The workflow will then run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" task and update the backend services."}]},{"type":"element","tag":"h3","props":{"id":"using-ignore_changes-in-the-definitions"},"children":[{"type":"text","value":"Using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ignore_changes"}]},{"type":"text","value":" in the definitions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is one more important point to make about Terraform before we conclude this discussion on updating backend code for existing ad hoc environments. Consider the scenario where a developer has launched an ad hoc environment with backend version "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.0"}]},{"type":"text","value":". They make a small change to the backend code and push version "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.1"}]},{"type":"text","value":". Next, the developer remembers that a backend environment variable needs to be changed. This can be done by updating their "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.tfvars"}]},{"type":"text","value":" file. If they now re-run the ad hoc environment update pipeline "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"without also updating the backend version in their "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.tfvars"}]},{"type":"text","value":" file"}]},{"type":"text","value":", then their code will be reverted from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.1"}]},{"type":"text","value":" to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.0"}]},{"type":"text","value":". We would need to coordinate version changes between updating the backend with the pipelines that use Terraform commands and the pipelines that use the AWS CLI commands."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is a setting on the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws_ecs_service"}]},{"type":"text","value":" resource in Terraform we can can use to prevent this from happening. This setting is called "},{"type":"element","tag":"a","props":{"href":"https://www.terraform.io/language/meta-arguments/lifecycle","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ignore_changes"}]}]},{"type":"text","value":" and is defined under the resource's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lifecycle"}]},{"type":"text","value":" configuration block. With this setting, when we update the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.tfvars"}]},{"type":"text","value":" file with our new environment variable value, we will create another recent task definition with the same "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.0"}]},{"type":"text","value":" image, but the ECS service will not update in response to this change (that's what the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ignore_changes"}]},{"type":"text","value":" is for). Once we make the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"*.tfvars"}]},{"type":"text","value":" file update and redeploy using the Terraform pipeline, nothing on our ad hoc changes, but we did get a new task definitions defined in our AWS account for each backend service. When we go to make the backend update with the pipeline that uses AWS CLI commands, the most recent task revision is used to create the new task definition, so it will include the environment variable change that we added earlier."}]},{"type":"element","tag":"h3","props":{"id":"frontend-updates"},"children":[{"type":"text","value":"Frontend updates"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The process described above is needed for updating the backend application. Updating the frontend application involves a similar process to the backend update. The main difference is that no task (such as the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"migrate"}]},{"type":"text","value":" command on the backend) needs to run before the service is updated. Here's an overview of the frontend update process:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fetch the container definition JSON for the frontend tasks ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs describe-task-definition"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"write new container definition JSON with the new frontend image tag (using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"jq"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"register new task definitions with the new container definition JSON file for the frontend task ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs register-task-definition"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"update the frontend service ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs update-service"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"wait for the new backend services to be stable ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aws ecs wait services-stable"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"h2","props":{"id":"setting-up-everything-from-a-new-aws-account-and-github-actions"},"children":[{"type":"text","value":"Setting up everything from a new AWS account and GitHub Actions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a quick overview of initial setup steps that are needed in order to use the automation defined in the GitHub Actions for ad hoc environments."}]},{"type":"element","tag":"h3","props":{"id":"configure-aws-credentials-locally"},"children":[{"type":"text","value":"Configure AWS credentials locally"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There is one Terraform command that we will run on our local machine to setup a remote backend for storing our Terraform state. In order to run this, we need to configure AWS credentials locally."}]},{"type":"element","tag":"h3","props":{"id":"run-the-make-tf-bootstrap-command"},"children":[{"type":"text","value":"Run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"make tf-bootstrap"}]},{"type":"text","value":" command"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This command will setup an S3 bucket and DynamoDB table for storing Terraform state. Running this command will also require that a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bootstrap.tfvars"}]},{"type":"text","value":" file has been created from the template. This will define the AWS region and name to be used for creating resources."}]},{"type":"element","tag":"h3","props":{"id":"build-and-push-a-backend-and-frontend-image"},"children":[{"type":"text","value":"Build and push a backend and frontend image"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tf-bootstrap"}]},{"type":"text","value":" command also creates ECR repositories for the backend and frontend images. We can use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecr_backend.yml"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecr_frontend.yml"}]},{"type":"text","value":" GitHub Actions workflows to build and push the backend and frontend images to the ECR repositories. These pipelines accept a single parameter which is a git tag that must exist in the repo. This git tag will then be used as the image tag for the backend and frontend images."}]},{"type":"element","tag":"h3","props":{"id":"purchase-a-domain-name-in-route-53"},"children":[{"type":"text","value":"Purchase a domain name in Route 53"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I use Route 53 to manage DNS records, and have purchased a domain name that I use for testing and debugging in this and other projects."}]},{"type":"element","tag":"h3","props":{"id":"create-a-wildcard-acm-certificate"},"children":[{"type":"text","value":"Create a wildcard ACM certificate"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I chose to create this certificate outside of Terraform and import it via ARN. We need a wildcard certificate so that multiple ad hoc environments can be hosted on subdomains of the same domain."}]},{"type":"element","tag":"h3","props":{"id":"create-a-new-ec2-key-pair"},"children":[{"type":"text","value":"Create a new EC2 key pair"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The key pair should be created manually and it needs to be added to GitHub repository secrets so that it can be used in the ad hoc environment pipelines."}]},{"type":"element","tag":"h3","props":{"id":"add-secrets-to-github"},"children":[{"type":"text","value":"Add secrets to GitHub"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The following secrets are needed for GitHub Actions to run. Add these as repository secrets:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ACM_CERTIFICATE_ARN"}]},{"type":"text","value":" - ARN of the wildcard ACM certificate"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS_ACCESS_KEY_ID"}]},{"type":"text","value":" - AWS access key ID"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS_ACCOUNT_ID"}]},{"type":"text","value":" - AWS account ID"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS_DEFAULT_REGION"}]},{"type":"text","value":" - AWS default region (I use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"us-east-1"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AWS_SECRET_ACCESS_KEY"}]},{"type":"text","value":" - AWS secret access key"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DOMAIN_NAME"}]},{"type":"text","value":" - domain name for the ad hoc environment (e.g. example.com)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"KEY_NAME"}]},{"type":"text","value":" - name of the EC2 key pair"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SSH_PRIVATE_KEY"}]},{"type":"text","value":" - private key for the EC2 key pair"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TF_BACKEND_BUCKET"}]},{"type":"text","value":" - name of the S3 bucket used for storing Terraform state"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TF_BACKEND_DYNAMODB_TABLE"}]},{"type":"text","value":" - name of the DynamoDB table used for locking the Terraform state file"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TF_BACKEND_REGION"}]},{"type":"text","value":" - AWS region for the S3 bucket and DynamoDB table"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These secrets are referenced in the GitHub Actions workflows."}]},{"type":"element","tag":"h3","props":{"id":"create-shared-resources"},"children":[{"type":"text","value":"Create shared resources"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that we have GitHub secrets configured, we can run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"shared_resources_create_update.yml"}]},{"type":"text","value":" GitHub Actions workflow. This will create  shared resources environment in which we can build our ad hoc environments. This workflow requires a name (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":"). This require that we create a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev.tfvars"}]},{"type":"text","value":" file in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform/live/shared-resources"}]},{"type":"text","value":" directory. This usually takes between 5 and 7 minutes to complete since it needs to create an RDS instance which takes a few minutes to provision."}]},{"type":"element","tag":"h3","props":{"id":"create-an-ad-hoc-environment"},"children":[{"type":"text","value":"Create an ad hoc environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can now create an ad hoc environment. This requires the name of the shared resources environment (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":") and the name of the ad hoc environment (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian-test"}]},{"type":"text","value":"). The only thing we need to do before creating the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian-test"}]},{"type":"text","value":" ad hoc environment is to create the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian-test.tfvars"}]},{"type":"text","value":" file in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform/live/ad-hoc/envs"}]},{"type":"text","value":" directory. This will define the versions of the application and any other environment configuration that is needed. This pipeline usually takes about 3 minutes to finish."}]},{"type":"element","tag":"h3","props":{"id":"update-the-backend-version-in-an-ad-hoc-environment"},"children":[{"type":"text","value":"Update the backend version in an ad hoc environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that the backend is up and running and usable, we can update the backend version used in our ad hoc environment. This can be done by running the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad_hoc_backend_update.yml"}]},{"type":"text","value":" GitHub Actions workflow. To run this workflow you must specify:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the shared resource workspace (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the ad hoc environment name (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian-test"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the new version of the backend to be used (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v1.0.2"}]},{"type":"text","value":")"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The backend version should already have been built and pushed to the ECR repository using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecr_backend.yml"}]},{"type":"text","value":" GitHub Actions workflow."}]},{"type":"element","tag":"h3","props":{"id":"use-ecs-exec-to-access-a-django-shell-in-a-running-container"},"children":[{"type":"text","value":"Use ECS Exec to access a Django shell in a running container"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Instead of SSHing into the container, we can use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs-exec"}]},{"type":"text","value":" command to access a shell in the container. This is useful for debugging and testing. One of the outputs of the ad hoc environment terraform configuration contains the script needed to run the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ecs-exec"}]},{"type":"text","value":" command:"}]},{"type":"element","tag":"pre","props":{"code":"TASK_ARN=$(aws ecs list-tasks \\\n  --cluster alpha-cluster \\\n  --service-name  alpha-gunicorn | jq -r '.taskArns | .[0]' \\\n)\naws ecs execute-command --cluster alpha-cluster \\\n    --task $TASK_ARN \\\n    --container gunicorn \\\n    --interactive \\\n    --command \"/bin/bash\"\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"TASK_ARN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" list-tasks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" alpha-cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"  --service-name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"  alpha-gunicorn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" jq"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" -r"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '.taskArns | .[0]'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"aws"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" ecs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" execute-command"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" --cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" alpha-cluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --task"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" $TASK_ARN "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"\\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --container"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" gunicorn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --interactive"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"    --command"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"/bin/bash\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You will then have a shell in the container:"}]},{"type":"element","tag":"pre","props":{"code":"The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.\n\n\nStarting session with SessionId: ecs-execute-command-073d1947fa71c058c\nroot@ip-10-0-2-167:/code# python manage.py shell\nPython 3.9.9 (main, Dec 21 2021, 10:03:34)\n[GCC 10.2.1 20210110] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.\n\n\nStarting session with SessionId: ecs-execute-command-073d1947fa71c058c\nroot@ip-10-0-2-167:/code# python manage.py shell\nPython 3.9.9 (main, Dec 21 2021, 10:03:34)\n[GCC 10.2.1 20210110] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>>\n"}]}]},{"type":"element","tag":"h3","props":{"id":"destroy-an-ad-hoc-environment"},"children":[{"type":"text","value":"Destroy an ad hoc environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ad_hoc_env_destroy.yml"}]},{"type":"text","value":" GitHub Actions workflow to destroy an ad hoc environment. To run this workflow you need to specify the shared resource workspace (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":") and the ad hoc environment name (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"brian-test"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h3","props":{"id":"destroy-the-shared-resources-environment"},"children":[{"type":"text","value":"Destroy the shared resources environment"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"shared_resources_destroy.yml"}]},{"type":"text","value":" GitHub Actions workflow to destroy the shared resources environment. To run this workflow you need to specify the shared resource workspace (e.g. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":")."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This defines the full lifecycle of creating and destroying ad hoc environments."}]},{"type":"element","tag":"h2","props":{"id":"future-improvements-open-questions-and-next-steps"},"children":[{"type":"text","value":"Future improvements, open questions and next steps"}]},{"type":"element","tag":"h3","props":{"id":"enhanced-security"},"children":[{"type":"text","value":"Enhanced Security"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The low hanging fruit here is to use least privilege (for roles used in automation) and to define all roles with IaC. Currently I am using Admin roles for the credentials I store in GitHub which is a shortcut to using IaC and is not a best practice."}]},{"type":"element","tag":"h3","props":{"id":"keeping-track-of-ad-hoc-environments"},"children":[{"type":"text","value":"Keeping track of ad hoc environments"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We need to think about how we can keep track of our active ad hoc environments. Active environments will incur additional AWS costs, and we do not want developers or the product team to create lots of environments and then leave them running without actively using them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We may decide to have some long-lived ad hoc environments, but those would be managed primarily by the DevOps team and respective owners (e.g. QA, product team, etc.)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One way to check the active ad hoc environments would be to use the AWS CLI. We could list the ECS clusters in our development account, and this would show the number of ad hoc environments running. We could go farther and list the ad hoc environments by when they were last updated. We could then request developers or team members to remove ad hoc environments that are not in use."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Or we could have a policy that all ad-hoc environments are deleted automatically at the end of each week."}]},{"type":"element","tag":"h3","props":{"id":"terraform-tooling"},"children":[{"type":"text","value":"Terraform Tooling"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing Terraform Code"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Testing GitHub Actions"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using advanced Terraform frameworks like Terragrunt"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using Terraform Cloud for more advanced Terraform features"}]}]},{"type":"element","tag":"h3","props":{"id":"more-secure-way-of-defining-rds-username-and-password"},"children":[{"type":"text","value":"More secure way of defining RDS username and password"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Currently the postgres database does not have a secure password. It is both hardcoded in the module as a default value and it will also be saved in plaintext in the Terraform state file."}]},{"type":"element","tag":"h3","props":{"id":"backend-application-update-script"},"children":[{"type":"text","value":"Backend application update script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The script used for updating the backend application could be improved or broken up into multiple scripts to better handle errors and failures that happen during the pipeline. The script runs several different commands and could potentially fail at any step, so it would be nice to improve the error messages so that both developers and DevOps teams can more quickly diagnose pipeline failures."}]},{"type":"element","tag":"h3","props":{"id":"limiting-traffic-to-ad-hoc-environments-to-a-vpn"},"children":[{"type":"text","value":"Limiting traffic to ad hoc environments to a VPN"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another good next step would be to show how we can limit traffic to ad hoc environments to a VPN."}]},{"type":"element","tag":"h3","props":{"id":"figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas"},"children":[{"type":"text","value":"Figure out how many ad hoc environments we can create with the default quotas"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AWS accounts limit the number of resources you can create, but for most of this quota limits you can request an increase per account. I need to figure out how many ad hoc environments I can create with the default quotas."}]},{"type":"element","tag":"h3","props":{"id":"code-repo-organization"},"children":[{"type":"text","value":"Code Repo Organization"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One minor improvement would be to move the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"terraform"}]},{"type":"text","value":" directory out of the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"django-step-by-step"}]},{"type":"text","value":" monorepo into a dedicated repo. We may also want to move GitHub Actions for creating, updating and destroying environments to this new repo. For early stage development, using a single repository that stores both application code and Terraform configuration works, but it would be better to keep these separate at the repository level as the project grows."}]},{"type":"element","tag":"h3","props":{"id":"multiple-aws-accounts"},"children":[{"type":"text","value":"Multiple AWS Accounts"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Everything shown here uses a single AWS account: ECR images, Terraform remote state storage, all shared resource environments and all ad hoc environments. Using one account keeps things simple for a demonstration of this workflow, but in practice it would be beneficial to use multiple AWS accounts for different purposes. This would also involve more carefully planned IAM roles for cross-account resource access."}]},{"type":"element","tag":"h3","props":{"id":"modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments"},"children":[{"type":"text","value":"Modules for stable environments to be used for long-lived pre-production and production environments"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article looked at how to make tradeoffs between costs, speed of deployment and production parity in ad hoc environments. I'm interested in building a new set of modules that can be used to set up environments that:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"are more stable and more long-lived"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"have less resource sharing (dedicated RDS and ElastiCache resources)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"implement autoscaling for load-testing (or maybe implement autoscaling for ad hoc environments)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"can be used to perform load testing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"have enhanced observability tooling"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These environments might be used as part of a QA process that does a final sign-off on a new set of features scheduled for deployment to production environments, for example."}]},{"type":"element","tag":"h2","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This wraps up the tour of my ad hoc environment infrastructure automation. Thank you for having a read through my article. If you have a similar (or different) approach to building ad hoc environments, I would love to hear about it."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"tldr","depth":2,"text":"tl;dr"},{"id":"github-links","depth":2,"text":"GitHub Links"},{"id":"assumptions","depth":2,"text":"Assumptions"},{"id":"what-are-ad-hoc-environments","depth":2,"text":"What are ad hoc environments?"},{"id":"trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation","depth":2,"text":"Trade-offs to make when designing ad hoc environment infrastructure and automation","children":[{"id":"relational-databases","depth":3,"text":"Relational Databases"},{"id":"redis-key-value-database","depth":3,"text":"Redis (key-value database)"},{"id":"compute","depth":3,"text":"Compute"},{"id":"redis-revisited","depth":3,"text":"Redis, revisited"},{"id":"load-balancing","depth":3,"text":"Load Balancing"}]},{"id":"more-on-shared-resources-vs-per-environment-resources","depth":2,"text":"More on shared resources vs per-environment resources"},{"id":"ad-hoc-environment-diagram","depth":2,"text":"Ad Hoc Environment Diagram","children":[{"id":"shared-architecture","depth":3,"text":"Shared architecture"},{"id":"environment-specific-architecture","depth":3,"text":"Environment-specific architecture"}]},{"id":"shared-resources-terraform-configuration","depth":2,"text":"Shared resources terraform configuration","children":[{"id":"vpc","depth":3,"text":"VPC"},{"id":"cloud-map-service-discovery-namespace","depth":3,"text":"Cloud Map Service Discovery Namespace"},{"id":"security-groups","depth":3,"text":"Security Groups"},{"id":"iam-roles","depth":3,"text":"IAM Roles"},{"id":"rds-instance","depth":3,"text":"RDS Instance"},{"id":"load-balancer","depth":3,"text":"Load Balancer"},{"id":"bastion-host","depth":3,"text":"Bastion Host"}]},{"id":"ad-hoc-environment-resources","depth":2,"text":"Ad hoc environment resources","children":[{"id":"ecs-cluster","depth":3,"text":"ECS Cluster"},{"id":"ecs-tasks-and-services","depth":3,"text":"ECS Tasks and Services"}]},{"id":"how-to-setup-an-ad-hoc-environment","depth":2,"text":"How to setup an ad hoc environment","children":[{"id":"design-decisions","depth":3,"text":"Design decisions"},{"id":"github-action","depth":3,"text":"GitHub Action"}]},{"id":"how-to-update-code-in-an-existing-ad-hoc-environment","depth":2,"text":"How to update code in an existing ad hoc environment","children":[{"id":"order-of-operations","depth":3,"text":"Order of Operations"},{"id":"github-action-for-application-updates","depth":3,"text":"GitHub Action for application updates"},{"id":"using-ignore_changes-in-the-definitions","depth":3,"text":"Using ignore_changes in the definitions"},{"id":"frontend-updates","depth":3,"text":"Frontend updates"}]},{"id":"setting-up-everything-from-a-new-aws-account-and-github-actions","depth":2,"text":"Setting up everything from a new AWS account and GitHub Actions","children":[{"id":"configure-aws-credentials-locally","depth":3,"text":"Configure AWS credentials locally"},{"id":"run-the-make-tf-bootstrap-command","depth":3,"text":"Run the make tf-bootstrap command"},{"id":"build-and-push-a-backend-and-frontend-image","depth":3,"text":"Build and push a backend and frontend image"},{"id":"purchase-a-domain-name-in-route-53","depth":3,"text":"Purchase a domain name in Route 53"},{"id":"create-a-wildcard-acm-certificate","depth":3,"text":"Create a wildcard ACM certificate"},{"id":"create-a-new-ec2-key-pair","depth":3,"text":"Create a new EC2 key pair"},{"id":"add-secrets-to-github","depth":3,"text":"Add secrets to GitHub"},{"id":"create-shared-resources","depth":3,"text":"Create shared resources"},{"id":"create-an-ad-hoc-environment","depth":3,"text":"Create an ad hoc environment"},{"id":"update-the-backend-version-in-an-ad-hoc-environment","depth":3,"text":"Update the backend version in an ad hoc environment"},{"id":"use-ecs-exec-to-access-a-django-shell-in-a-running-container","depth":3,"text":"Use ECS Exec to access a Django shell in a running container"},{"id":"destroy-an-ad-hoc-environment","depth":3,"text":"Destroy an ad hoc environment"},{"id":"destroy-the-shared-resources-environment","depth":3,"text":"Destroy the shared resources environment"}]},{"id":"future-improvements-open-questions-and-next-steps","depth":2,"text":"Future improvements, open questions and next steps","children":[{"id":"enhanced-security","depth":3,"text":"Enhanced Security"},{"id":"keeping-track-of-ad-hoc-environments","depth":3,"text":"Keeping track of ad hoc environments"},{"id":"terraform-tooling","depth":3,"text":"Terraform Tooling"},{"id":"more-secure-way-of-defining-rds-username-and-password","depth":3,"text":"More secure way of defining RDS username and password"},{"id":"backend-application-update-script","depth":3,"text":"Backend application update script"},{"id":"limiting-traffic-to-ad-hoc-environments-to-a-vpn","depth":3,"text":"Limiting traffic to ad hoc environments to a VPN"},{"id":"figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas","depth":3,"text":"Figure out how many ad hoc environments we can create with the default quotas"},{"id":"code-repo-organization","depth":3,"text":"Code Repo Organization"},{"id":"multiple-aws-accounts","depth":3,"text":"Multiple AWS Accounts"},{"id":"modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments","depth":3,"text":"Modules for stable environments to be used for long-lived pre-production and production environments"}]},{"id":"conclusion","depth":2,"text":"Conclusion"}]}},"_type":"markdown","_id":"content:2022:03:27:ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","_source":"content","_file":"2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","_stem":"2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","_extension":"md"},{"_path":"/2021/10/31/how-and-why-i-added-adsense-and-adblock-detector-to-my-website","_dir":"31","_draft":false,"_partial":false,"_locale":"","title":"How and why I added AdSense and an AdBlock detector to my personal website","description":"This article describes how I added AdSense to my personal website and how I request that site visitors pause AdBlock while reading my blog","date":"2021-10-31","image":"https://briancaffey.github.io/static/ab_cover.png","tags":["nuxt","ads","adsense","adblock"],"external":[{"link":"https://news.ycombinator.com/item?id=29143003","site":"hn"},{"link":"https://www.reddit.com/r/Nuxt/comments/qowjbu/how_and_why_i_added_adsense_and_a_custom_adblock/","site":"reddit"},{"link":"https://dev.to/briancaffey/how-and-why-i-added-adsense-and-an-adblock-detector-to-my-personal-website-5ag3","site":"dev"},{"link":"https://medium.com/@briancaffey/how-and-why-i-added-adsense-and-an-adblock-detector-to-my-personal-website-b210d7f45e22","site":"medium"},{"link":"https://briancaffey.hashnode.dev/how-and-why-i-added-adsense-and-an-adblock-detector-to-my-personal-website","site":"hashnode"},{"link":"https://briancaffey.substack.com/p/how-and-why-i-added-adsense-and-an","site":"substack"}],"comments":true,"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Update: I disabled the ad block blocker on my personal website. It was an interesting experiment and I learned that ad block detection is a game of cat and mouse. It did not work with uBlock Origin, but it did work with AdBlock. I probably won't be revisiting this topic."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you are reading this article on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/2021/10/31/how-and-why-i-added-adsense-and-adblock-detector-to-my-website","rel":["nofollow"]},"children":[{"type":"text","value":"briancaffey.github.io/2021/10/31/how-and-why-i-added-adsense-and-adblock-detector-to-my-website"}]},{"type":"text","value":", then you will be prompted to pause your ad blocker if you are using one. If you are "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":" using an ad blocker, I recommend that you consider installing one. Reading this article on a browser with AdBlock enabled will allow you to see how I detect AdBlock and ask people to pause it when they are on my site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article is a deep dive on how I added ads to my site with Google AdSense and how I request that visitors to my site pause AdBlock so that I can make more money from Google AdSense."}]},{"type":"element","tag":"h2","props":{"id":"how-i-added-adsense-to-my-site"},"children":[{"type":"text","value":"How I added AdSense to my site"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have been enjoying using my GitHub Pages website to learn more about static sites, JAMStack and Nuxt.js, an awesome Vue.js framework with support for building statically generated sites. I have been able to learn and implement several different features which I have written about on my blog. Some examples include:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Adding a Drift chat window so users can message me directly"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Implementing a contact form with formsubmit.io"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using Vue.js components in Markdown files to add interactive elements to my articles (such as graphs)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Adding a custom MailChimp newsletter sign-up form that is included in the footer of each page of my blog"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Adding an RSS feed for my blog"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Adding a site index and submitting it to Google"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I have also been learning the suite of Google tools for monitoring and measuring traffic to my site, including Google Analytics and Google Search Console. Google Search Console is helpful for understanding the search terms that people are using when searching Google that result in organic traffic to my site."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At one point I found out that another website was using the same Google Tracking code that I had previously hard-coded into an old version of my website, and my Google Analytics started measuring traffic to URLs that I didn't recognize as belonging to my site. I was able to fix this by adding a Hostname filter rule in Google Analytics."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One area that I have not had any experience with until recently is Google AdSense. Google AdSense allows you to place ads on your website. Here's an overview of what I did to get started:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add a site in Google AdSense"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Submit my site for approval (this takes a few days)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Install and configure the Google AdSense plugin for NuxtJS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ads.txt"}]},{"type":"text","value":" file generated by Google AdSense to my site"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Confirm my address by entering a code that was mailed to me"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Connect a bank account to my Google AdSense account"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the address confirmation code that I received from Google:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Address confirmation","src":"/static/google_letter.jpeg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's the config code for AdSense from "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxt.config.js"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"  /*\n   ** Nuxt.js modules\n   */\n  modules: [\n    // Doc: https://axios.nuxtjs.org/usage\n    '@nuxtjs/axios',\n    // Doc: https://github.com/nuxt/content\n    '@nuxt/content',\n    // Doc: https://www.npmjs.com/package/@nuxtjs/sitemap\n    '@nuxtjs/sitemap',\n    '@nuxtjs/feed',\n    'nuxt-i18n',\n    ['@nuxtjs/google-adsense', {     <-- AdSense config\n      id: 'ca-pub-4924597640144289'\n    }]\n  ],\n","language":"js","meta":"","className":"language-js shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"  /*\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"   ** Nuxt.js modules\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"   */\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  modules"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Doc: https://axios.nuxtjs.org/usage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/axios'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Doc: https://github.com/nuxt/content\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxt/content'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Doc: https://www.npmjs.com/package/@nuxtjs/sitemap\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/sitemap'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    '@nuxtjs/feed'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    'nuxt-i18n'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'@nuxtjs/google-adsense'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", {     <-- AdSense config\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      id: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'ca-pub-4924597640144289'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  ],\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The process was pretty simple. Google now automatically places ads on my site in a few different formats:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ads displayed on the top and bottom of the page"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"popup ads displayed between route navigation"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ads automatically inserted into the body of the page between paragraphs in my articles"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ads that I place on articles explicitly using the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<adsbygoogle />"}]},{"type":"text","value":" Vue component"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When everything was set up properly I started seeing ads on my site, and I see a non-zero value in my estimated earnings in the AdSense console. Google has a payment threshold of $100, so I need make this amount before I can start receiving money from Google."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"My estimated earning report shows that I make between $0 and $4.32 in ad sales per day. I'm interested to see how much I can make with an article that I post across the many different channels that I can publish to. I explored this in a previous article, but the main channels I can use for sharing content are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DEV.to"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Facebook"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hashnode"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Medium"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Reddit"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Discord"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hacker Noon"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Twitter"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"My MailChimp mailing list"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Substack"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Hacker News"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This article should be a good place to start exploring how effective the different channels are in driving content to my site, and I'll update this article later with more details and numbers from my AdSense reports."}]},{"type":"element","tag":"h2","props":{"id":"how-i-built-an-adblock-detector-for-my-site"},"children":[{"type":"text","value":"How I built an AdBlock detector for my site"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I assume that most people reading my blog have an AdBlock extension installed in their browser like I do, such as AdBlock or ABP (AdBlock Pro). This got me thinking about how I could implement a simple AdBlock detector for my site that would hide the contents of the page if AdBlock is enabled."}]},{"type":"element","tag":"h3","props":{"id":"how-do-you-check-to-see-if-adblock-is-enabled"},"children":[{"type":"text","value":"How do you check to see if AdBlock is enabled?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I started with this question, and I came across "},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/questions/4869154/how-to-detect-adblock-on-my-website","rel":["nofollow"]},"children":[{"type":"text","value":"this StackOverflow question"}]},{"type":"text","value":" which inspired the code that I am now using on this site to detect AdBlock."}]},{"type":"element","tag":"h3","props":{"id":"the-components-of-my-adblock-detector"},"children":[{"type":"text","value":"The components of my AdBlock detector"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are a few different parts of my Nuxt Application that work together to detect if AdBlock is active and request that the user pause AdBlock for the site. The main components are:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A component called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AdBlockBlocker"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"This component is used in the default layout, so it is included in all pages on briancaffey.github.io"}]}]},{"type":"element","tag":"ol","props":{"start":2},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Vuex store module called "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"adblock"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this module is used to keep track of a boolean value that indicates if AdBlock is enabled"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the module also has a simple getter and a mutation for turning adBlock to true or false"}]}]},{"type":"element","tag":"ol","props":{"start":3},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Some logic in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"default.vue"}]},{"type":"text","value":" layout that is used for almost all of the pages on my site"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"the getter from the Vuex store is used here to either show regular content or a message that the user needs to pause AdBlock"}]}]},{"type":"element","tag":"ol","props":{"start":4},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A component/page to display when AdBlock is enabled"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this component asks the user to please pause AdBlock"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"I named this component "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PleaseDisableAdblock.vue"}]}]}]},{"type":"element","tag":"ol","props":{"start":5},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"localStorage"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"this is used to keep track of the presence of an AdBlocker that is blocking ads"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's an overview of each part:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AdBlockBlocker.vue"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is the key part of how the AdBlock detection works. If the client is unable to download the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"adsbygoogle.js"}]},{"type":"text","value":" file, then that indicates that the user is using AdBlock."}]},{"type":"element","tag":"pre","props":{"code":"<template>\n  <div />\n</template>\n\n<script>\nexport default {\n  mounted () {\n    // if adblock is detected through a value that is set local storage, then show the AdBlock message\n    // the `adblockEnabled` value is set in the catch block of the `detectAdBlock` method\n    // (see adblock/setAdblockEnabled mutation)\n    if (JSON.parse(localStorage.getItem('adblockEnabled')) === true) {\n      this.$store.commit('adblock/setAdblockEnabled', true)\n    }\n    // check to see if the URL can be accessed on a 5 second interval\n    setInterval(() => {\n      this.detectAdBlock()\n    }, 5000)\n  },\n  methods: {\n    async  detectAdBlock () {\n      // this is a URL that should be blocked by AdBlock\n      const googleAdUrl = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'\n      // make a request to the above URL\n      await fetch(new Request(googleAdUrl)).then((_) => {\n        // isAdblockEnabled is false by default\n        // Check to see if isAblockEnabled was set to true by a previous request\n        if (this.$store.getters['adblock/isAdblockEnabled'] === true) {\n          // if the request was successful, then the user does not have AdBlock enabled,\n          // so we can set isAdblockEnabled to false using the setAdblockEnabled mutation\n          // this mutation will also set the `adblockEnabled` value in local storage to \"false\"\n          // `adblockEnabled` be `JSON.parse`d since it is saved in localStorage as a string\n          this.$store.commit('adblock/setAdblockEnabled', false)\n          window.localStorage.setItem('adblockEnabled', 'false')\n          // do a full reload of the page\n          window.location.reload()\n        }\n      }).catch((_) => {\n        // if the request was unsuccessful, then the user has AdBlock enabled.\n        // we can set isAdblockEnabled to true using the setAdblockEnabled mutation\n        // this will also set the `adblockEnabled` value in local storage to \"true\"\n        this.$store.commit('adblock/setAdblockEnabled', true)\n        window.localStorage.setItem('adblockEnabled', 'true')\n      })\n    }\n  }\n}\n</script>\n","language":"html","meta":"","className":"language-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":" /"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  mounted"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" () {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // if adblock is detected through a value that is set local storage, then show the AdBlock message\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // the `adblockEnabled` value is set in the catch block of the `detectAdBlock` method\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // (see adblock/setAdblockEnabled mutation)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(localStorage."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"      this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".$store."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"commit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblock/setAdblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // check to see if the URL can be accessed on a 5 second interval\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"    setInterval"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"      this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"detectAdBlock"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5000"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  methods: {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  detectAdBlock"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" () {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"      // this is a URL that should be blocked by AdBlock\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"      const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" googleAdUrl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"      // make a request to the above URL\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" fetch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(googleAdUrl))."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"then"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"_"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // isAdblockEnabled is false by default\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // Check to see if isAblockEnabled was set to true by a previous request\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".$store.getters["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblock/isAdblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          // if the request was successful, then the user does not have AdBlock enabled,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          // so we can set isAdblockEnabled to false using the setAdblockEnabled mutation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          // this mutation will also set the `adblockEnabled` value in local storage to \"false\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          // `adblockEnabled` be `JSON.parse`d since it is saved in localStorage as a string\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"          this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".$store."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"commit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblock/setAdblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          window.localStorage."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'false'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"          // do a full reload of the page\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"          window.location."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"reload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      })."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"catch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"_"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // if the request was unsuccessful, then the user has AdBlock enabled.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // we can set isAdblockEnabled to true using the setAdblockEnabled mutation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // this will also set the `adblockEnabled` value in local storage to \"true\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F"},"children":[{"type":"text","value":"        this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":".$store."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"commit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblock/setAdblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        window.localStorage."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"setItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'true'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One other important point about this component is that it runs AdBlock detection using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"setInterval"}]},{"type":"text","value":", meaning that it will check if AdBlock is enabled every few seconds while a user is on my site."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If AdBlock is enabled, the request will fail and the Vuex store value will be updated, which will cause the site to display the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"PleaseDisableAdblock.vue"}]},{"type":"text","value":" component."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Id AdBlock is not enabled, then the file will be read from disk cache and the Vuex store value will remain "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"false"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Vuex Store"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a very simple Vuex store module. The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"isAdblockEnabled"}]},{"type":"text","value":" getter will be used in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"default.vue"}]},{"type":"text","value":" layout to component."}]},{"type":"element","tag":"pre","props":{"code":"let initialValue = false\n\nif (process.window) {\n  initialValue = JSON.parse(window.localStorage.getItem('adblockEnabled')) || false\n}\nexport const state = () => ({\n  adblockEnabled: initialValue\n})\n\nexport const getters = {\n  isAdblockEnabled: state => state.adblockEnabled\n}\n\nexport const mutations = {\n  setAdblockEnabled (state, payload) {\n    state.adblockEnabled = payload\n  }\n}\n","language":"js","meta":"","className":"language-js shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"let"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" initialValue "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" false\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (process.window) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  initialValue "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(window.localStorage."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"getItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'adblockEnabled'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"||"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" false\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  adblockEnabled: initialValue\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"})\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" getters"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  isAdblockEnabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" state.adblockEnabled\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" mutations"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"  setAdblockEnabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"payload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    state.adblockEnabled "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" payload\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"default.vue layout logic"}]}]},{"type":"element","tag":"pre","props":{"code":"<template>\n  <div>\n    <Navigation />\n    <PleaseDisableAdblock v-if=\"$store.getters['adblock/isAdblockEnabled']\" />\n    <Nuxt v-else />\n    <AdBlockerBlocker />\n\n    <Footer />\n  </div>\n</template>\n","language":"vue-html","meta":"","className":"language-vue-html shiki shiki-themes github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<template>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  <div>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    <Navigation />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    <PleaseDisableAdblock v-if=\"$store.getters['adblock/isAdblockEnabled']\" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    <Nuxt v-else />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    <AdBlockerBlocker />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    <Footer />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  </div>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"</template>\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Content to show to request that a user pauses AdBlock"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When users has AdBlock enabled, I show a simple message that asks them to please disable AdBlock. I also want to invite people who do not wish to disabled AdBlock to read my blog directly on GitHub, or to read it without ads by cloning or forking my repo, building it and running it in development mode with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"yarn dev"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"why-am-i-adding-ads-and-an-adblock-detector-to-my-site"},"children":[{"type":"text","value":"Why am I adding ads and an AdBlock detector to my site?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Being asked to pause AdBlock is increasingly common. I have noticed that the experience is not the same on each site that requests AdBlock be paused. For example:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a site might ask you to pause AdBlock, but you have the option to continue without pausing AdBlock"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"a site shows you a preview of an article and asks you to unpause AdBlock to see the full article"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"all site content is hidden if you are using AdBlock, and a pop-up message ask you to \"Continue to site\" once you have paused AdBlock."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I remember being able to delete AdBlock detection modals and backgrounds on some sites as a way of getting around ad block detectors. This is as easy as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Cmd + Shift + C"}]},{"type":"text","value":", click on the element that is blocking the page content and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"delete"}]},{"type":"text","value":" the selected element."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One of the reasons I wanted to implement AdBlock detection is to see what is possible from the perspective of user experience (UX). Ideally, here's how I want to the \"please disable AdBlock\" experience to work on my site:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A user visits my site with AdBlock enabled"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"For a few seconds, the user can start reading the content of the article"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The page content is replaced with a message that says \"Please disable AdBlock\" and some other links that people may find interesting or helpful."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The user goes into the AdBlock extension and pauses AdBlock on my site"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The original page content is then displayed with ads"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If the user re-enables AdBlock shortly after pausing it, then the \"Please disable AdBlock\" message should be displayed again"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If a u"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I don't want to ask the user to press a button or make the user think that they need to refresh the page. This is why I'm using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"setInterval"}]},{"type":"text","value":", I continuously make requests to the Google Ads JavaScript file that will be used to detect if AdBlock enabled."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm happy to pause my AdBlock for smaller sites that ask me to, or for newspaper sites that are supported by advertising, and I'm assuming that people visiting my site will also be OK with pausing AdBlock as a way of thanking me for the work that goes into what I share on my blog."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm mostly curious to see what happens to my site's traffic, and to see what impact it could have on the earnings I make from AdSense."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Some of my questions are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What will happen to the bounce rate if I request that AdBlock users pause AdBlock for my site?"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What is the most effective amount of time to wait before requesting that a new user pause AdBlock for my site"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"What else can I include on my \"Please Disable AdBlock\" page to encourage new users to pause AdBlock on my site?"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'll have a good follow-up article to share with numbers from my AdSense and Google analytics."}]},{"type":"element","tag":"h3","props":{"id":"one-small-issue"},"children":[{"type":"text","value":"One small issue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While ads are working on my site, I did notice that a console error related to AdSense:"}]},{"type":"element","tag":"pre","props":{"code":"K {message: \"adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\", name: 'TagError', pbr: true, stack: \"TagError: adsbygoogle.push() error: Only one 'enab‚Ä¶agead/js/adsbygoogle.js?client=ca-google:77:1130)\"}\nmessage: \"adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\"\nname: \"TagError\"\npbr: true\nstack: \"TagError: adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\n    at go (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:219:326)\n    at fo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:218:788)\n    at mo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:225:365)\n    at c (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:226:38)\n    at no (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:226:156)\n    at yo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:235:248)\n    at oo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:232:89)\n    at http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:227:47\n    at Od.aa.ma (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:64:802)\n    at Jf (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:77:1130)\"\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"K {message: \"adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\", name: 'TagError', pbr: true, stack: \"TagError: adsbygoogle.push() error: Only one 'enab‚Ä¶agead/js/adsbygoogle.js?client=ca-google:77:1130)\"}\nmessage: \"adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\"\nname: \"TagError\"\npbr: true\nstack: \"TagError: adsbygoogle.push() error: Only one 'enable_page_level_ads' allowed per page.\n    at go (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:219:326)\n    at fo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:218:788)\n    at mo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:225:365)\n    at c (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:226:38)\n    at no (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:226:156)\n    at yo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:235:248)\n    at oo (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:232:89)\n    at http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:227:47\n    at Od.aa.ma (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:64:802)\n    at Jf (http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-google:77:1130)\"\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here's a related issue on GitHub: "},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt-community/google-adsense-module/issues/141","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/nuxt-community/google-adsense-module/issues/141"}]},{"type":"text","value":". I'm still not sure how to fix this issue. If anyone has any ideas, please let me know!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you are interested in following my progress, feel free to subscribe to my MailChimp newsletter by filling out the form in the footer of my website, or by following me on any of the accounts listed on "},{"type":"element","tag":"a","props":{"href":"https://briancaffey.github.io/contact","rel":["nofollow"]},"children":[{"type":"text","value":"briancaffey.github.io/contact"}]},{"type":"text","value":"."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"how-i-added-adsense-to-my-site","depth":2,"text":"How I added AdSense to my site"},{"id":"how-i-built-an-adblock-detector-for-my-site","depth":2,"text":"How I built an AdBlock detector for my site","children":[{"id":"how-do-you-check-to-see-if-adblock-is-enabled","depth":3,"text":"How do you check to see if AdBlock is enabled?"},{"id":"the-components-of-my-adblock-detector","depth":3,"text":"The components of my AdBlock detector"}]},{"id":"why-am-i-adding-ads-and-an-adblock-detector-to-my-site","depth":2,"text":"Why am I adding ads and an AdBlock detector to my site?","children":[{"id":"one-small-issue","depth":3,"text":"One small issue"}]}]}},"_type":"markdown","_id":"content:2021:10:31:how-and-why-i-added-adsense-and-adblock-detector-to-my-website.md","_source":"content","_file":"2021/10/31/how-and-why-i-added-adsense-and-adblock-detector-to-my-website.md","_stem":"2021/10/31/how-and-why-i-added-adsense-and-adblock-detector-to-my-website","_extension":"md"}]