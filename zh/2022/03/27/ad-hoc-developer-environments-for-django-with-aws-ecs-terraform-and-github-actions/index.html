<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="og:title" content="Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions"><meta data-n-head="ssr" property="og:description" content="This article will show how software development teams can build on-demand environments for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete instances of a web application."><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/adhoc.png"><meta data-n-head="ssr" property="twitter:card" content="https://briancaffey.github.io/static/adhoc.png"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><script data-n-head="ssr" data-hid="adsbygoogle-script" defer crossorigin="anonymous" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4924597640144289"></script><script data-n-head="ssr" data-hid="adsbygoogle">window.__abg_called||((adsbygoogle=window.adsbygoogle||[]).pauseAdRequests=0,(window.adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4924597640144289",enable_page_level_ads:!1,overlays:{bottom:!1}}),window.__abg_called=!0)</script><link rel="preload" href="/_nuxt/c77e7fe.js" as="script"><link rel="preload" href="/_nuxt/9ee0ef6.js" as="script"><link rel="preload" href="/_nuxt/f51c3d4.js" as="script"><link rel="preload" href="/_nuxt/0f451e7.js" as="script"><link rel="preload" href="/_nuxt/b5afa39.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 5a4b6265:0 14b1eaf9:0 a0fa61ae:0 7f6c3ed0:0 64516d8e:0 5586ddaf:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-8{grid-gap:2rem;gap:2rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 5px 10px 0 #0e2233;box-shadow:0 5px 10px 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 10px 40px 0 #0e2233;box-shadow:0 10px 40px 0 var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-style:italic}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{content:" ";margin-top:-85px;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-3f691362]{padding:0}.selected[data-v-3f691362]{text-shadow:.25px 0 0 #000}.picker[data-v-3f691362]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-3f691362]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-107ae01e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-4f7c5820]{padding:0}.modal[data-v-4f7c5820]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-4f7c5820],.picker[data-v-4f7c5820]{position:absolute;left:0}.picker[data-v-4f7c5820]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.cover-image[data-v-4b9599ea]{transition:transform .2s}.cover-image[data-v-4b9599ea]:hover{transform:scale(1.025)}.tag[data-v-3fbcd028]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-3fbcd028]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1655175621/zh/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions/state.js" as="script"><link rel="preload" href="/_nuxt/static/1655175621/zh/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1655175621/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-3f691362><div class="top" data-v-3f691362></div> <div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-3f691362><div class="justify-left flex-grow flex-cols-4" data-v-3f691362><a href="/zh" class="text-xl nuxt-link-active" data-v-3f691362><span class="hidden sm:inline text-2xl" data-v-3f691362>布莱恩</span><span class="inline sm:hidden" data-v-3f691362>JBC</span></a></div> <div class="flex-grow relative" data-v-3f691362><nav z-index="10000" data-v-107ae01e data-v-3f691362><div data-v-107ae01e><ul class="items-right float-right hidden md:flex" data-v-107ae01e><li class="px-4 text-lg" data-v-107ae01e><a href="/zh/blog/1" data-v-107ae01e>
          博客
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/zh/projects" data-v-107ae01e>
          项目
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/zh/contact" data-v-107ae01e>
          联系
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-107ae01e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-107ae01e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-107ae01e><title data-v-107ae01e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-107ae01e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-3f691362><div class="centered" data-v-288717a6 data-v-3f691362><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🖥️, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🌞, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🌚, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="☕, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-4f7c5820 data-v-288717a6><!----> <ul data-v-4f7c5820><li class="md:px-1 px-1 cursor-pointer" data-v-4f7c5820><span aria-label="🇨🇳, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-4f7c5820><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-4f7c5820><a href="/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" data-v-4f7c5820><span aria-label="🇺🇸, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-4f7c5820></a><a href="/fr/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" data-v-4f7c5820><span aria-label="🇫🇷, fr, flag-fr" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Français <br data-v-4f7c5820></a><a href="/zh/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-4f7c5820><span aria-label="🇨🇳, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> 简体中文 <br data-v-4f7c5820></a><a href="/ru/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" data-v-4f7c5820><span aria-label="🇷🇺, ru, flag-ru" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> Русский <br data-v-4f7c5820></a><a href="/jp/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" data-v-4f7c5820><span aria-label="🇯🇵, jp, flag-jp" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> 日本語 <br data-v-4f7c5820></a><a href="/in/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" data-v-4f7c5820><span aria-label="🇮🇳, flag-in" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> हिंदी <br data-v-4f7c5820></a></div></div></div></li></ul></div></div></div></div> <article data-v-4b9599ea><img src="/static/adhoc.png" class="pt-2 h-64 w-full object-cover cover-image" data-v-4b9599ea> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-4b9599ea><h1 class="prose text-3xl leading-9" data-v-4b9599ea>
      Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-4b9599ea><a href="/zh/blog/tags/django" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    django 🏷️
    <!----></div></a><a href="/zh/blog/tags/terraform" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    terraform 🏷️
    <!----></div></a><a href="/zh/blog/tags/github-actions" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    github-actions 🏷️
    <!----></div></a><a href="/zh/blog/tags/aws" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    aws 🏷️
    <!----></div></a><a href="/zh/blog/tags/ecs" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    ecs 🏷️
    <!----></div></a><a href="/zh/blog/tags/containers" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    containers 🏷️
    <!----></div></a><a href="/zh/blog/tags/docker" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    docker 🏷️
    <!----></div></a></div> <div class="flex py-2" data-v-23cbc744 data-v-4b9599ea><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://news.ycombinator.com/item?id=31704417" data-v-86c576ca><img src="/icons/hn.png" alt="https://news.ycombinator.com/item?id=31704417" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/" data-v-86c576ca><img src="/icons/reddit.png" alt="https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh" data-v-86c576ca><img src="/icons/dev.png" alt="https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539" data-v-86c576ca><img src="/icons/medium.png" alt="https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions" data-v-86c576ca><img src="/icons/hashnode.png" alt="https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://twitter.com/briancaffey/status/1535683865330831360" data-v-86c576ca><img src="/icons/twitter.png" alt="https://twitter.com/briancaffey/status/1535683865330831360" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments" data-v-86c576ca><img src="/icons/substack.png" alt="https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments" width="25" class="rounded" data-v-86c576ca></a></div></div> <p class="blog-date text-gray-500 mb-4" data-v-4b9599ea>
      更新日期
      2022年6月11日
    </p> <!----> <div class="markdown nuxt-content" data-v-4b9599ea data-v-4b9599ea><h2 id="tldr" data-v-4b9599ea data-v-4b9599ea><a href="#tldr" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>tl;dr</h2>
<p data-v-4b9599ea data-v-4b9599ea>This article will show how software development teams can build on-demand instances of a web application project for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete environments. It will focus on the technical implementation of building ad hoc environments using a specific set of tools (including AWS ECS, Terraform and GitHub Actions). I will also be giving context on high-level implementation decisions based on what I think are best practices guided by the <a href="https://12factor.net/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>12-Factor Application methodology</a>. If any of this interests you, please have a read and let me know what you think in the comments on the outlets where I'll be sharing this article (links at the end).</p>
<h2 id="github-links" data-v-4b9599ea data-v-4b9599ea><a href="#github-links" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>GitHub Links</h2>
<p data-v-4b9599ea data-v-4b9599ea>This article references three open-source code repositories on GitHub.</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea><a href="https://github.com/briancaffey/django-step-by-step" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>django-step-by-step</a></p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>this repo contains an example microblogging application called μblog built with Django</li>
<li data-v-4b9599ea data-v-4b9599ea>the same application is implemented as a traditional Model Template View (MTV) site, a decoupled REST API and Javascript web application and a GraphQL API</li>
<li data-v-4b9599ea data-v-4b9599ea>it is a monorepo that also includes a frontend Vue.js application, CI/CD pipelines, a VuePress documentation site as well as tooling and instructions for settings up a local development environments (both with and without docker)</li>
<li data-v-4b9599ea data-v-4b9599ea>it includes a complete set of GitHub Action examples for automating the processes of creating, updating and destroying ad hoc environments that will be an important part of what is covered in this article</li>
</ul>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea><a href="https://github.com/briancaffey/terraform-aws-django" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>terraform-aws-django</a></p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>a collection of modules for running Django applications on AWS using Terraform</li>
<li data-v-4b9599ea data-v-4b9599ea>one of the submodules can be used for creating ad hoc environments which will be what we use to create ad hoc environments</li>
<li data-v-4b9599ea data-v-4b9599ea>this module has been published to Terraform Registry and is used in the <code data-v-4b9599ea data-v-4b9599ea>terraform/live/ad-hoc</code> directory of the <code data-v-4b9599ea data-v-4b9599ea>django-step-by-step</code> repo</li>
</ul>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea><a href="https://github.com/briancaffey/terraform-aws-ad-hoc-environments" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>terraform-aws-ad-hoc-environments</a></p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>a Terraform module that provides shared infrastructure used by ad hoc environments (including VPC, RDS instance, bastion host, security groups and IAM roles, etc.)</li>
<li data-v-4b9599ea data-v-4b9599ea>this module has also been published to Terraform Registry and is also used in <code data-v-4b9599ea data-v-4b9599ea>django-step-by-step</code></li>
<li data-v-4b9599ea data-v-4b9599ea>this module is designed to be used with the <code data-v-4b9599ea data-v-4b9599ea>terraform-aws-django</code> Terraform module</li>
</ul>
</li>
</ul>
<h2 id="assumptions" data-v-4b9599ea data-v-4b9599ea><a href="#assumptions" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Assumptions</h2>
<p data-v-4b9599ea data-v-4b9599ea>There are all sorts of applications, and all sort of engineering teams. For some context on what I'm describing in this article, here are some basic assumptions that I'm making about the type of engineering team and software application product that would be a good fit for this type of development workflow.</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>engineering team is composed of a backend team, a frontend team, a devops team and works closely with a product team</li>
<li data-v-4b9599ea data-v-4b9599ea>backend team primarily develops a REST API</li>
<li data-v-4b9599ea data-v-4b9599ea>frontend team develops a JavaScript SPA (frontend website)</li>
<li data-v-4b9599ea data-v-4b9599ea>SPA consumes backend REST API</li>
<li data-v-4b9599ea data-v-4b9599ea>product team frequently needs to demo applications to prospective clients</li>
<li data-v-4b9599ea data-v-4b9599ea>development teams don't have deep expertise in infrastructure, containers, CI/CD or automation</li>
<li data-v-4b9599ea data-v-4b9599ea>devops team has been tasked with building automation that will allow anyone on the team to quickly spin up a complete environment for testing and demoing purposes within minutes</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Here are assumptions about specific tools and technologies used at the company:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>backend is a REST API developed with Django and a Postgres database</li>
<li data-v-4b9599ea data-v-4b9599ea>backend is packaged into a docker container</li>
<li data-v-4b9599ea data-v-4b9599ea>frontend is also packaged into a docker container using multi-stage builds and NGINX</li>
<li data-v-4b9599ea data-v-4b9599ea>frontend does not require any build-time configuration (all configuration needed by frontend is fetched from backend)</li>
<li data-v-4b9599ea data-v-4b9599ea>backend application's configuration is driven by plain-text environment variables at run-time</li>
<li data-v-4b9599ea data-v-4b9599ea>engineering team uses AWS</li>
<li data-v-4b9599ea data-v-4b9599ea>automation pipeline exists for building, tagging and pushing backend and frontend container images to an ECR repository</li>
<li data-v-4b9599ea data-v-4b9599ea>devops team uses AWS ECS for running containerized workloads</li>
<li data-v-4b9599ea data-v-4b9599ea>devops team uses Terraform for provisioning infrastructure</li>
<li data-v-4b9599ea data-v-4b9599ea>devops team uses GitHub Actions for building automation pipelines</li>
<li data-v-4b9599ea data-v-4b9599ea>team is somewhat cost-conscious</li>
</ul>
<h2 id="what-are-ad-hoc-environments" data-v-4b9599ea data-v-4b9599ea><a href="#what-are-ad-hoc-environments" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>What are ad hoc environments?</h2>
<p data-v-4b9599ea data-v-4b9599ea>Ad hoc environments are short-lived environments that are designed to be used for testing a specific set of features or for demoing a specific application configuration in an isolated environment. It is intended to be a functional duplicate of the main production environment. An ad hoc environment is the first cloud environment that the application code will be deployed to after a developer has been working on it in a local development environment.</p>
<h2 id="trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation" data-v-4b9599ea data-v-4b9599ea><a href="#trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Trade-offs to make when designing ad hoc environment infrastructure and automation</h2>
<p data-v-4b9599ea data-v-4b9599ea>Now that we have a sense of what we are building and the team we are working with, let's think about the high-level trade-offs that we will face as we build a solution for providing on-demand ad hoc environments. When building infrastructure and workflows for ad hoc environments, there are a few things to solve for:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>simplicity of the end-user interface and process for requesting an ad hoc environment</li>
<li data-v-4b9599ea data-v-4b9599ea>startup speed</li>
<li data-v-4b9599ea data-v-4b9599ea>total cost of ownership</li>
<li data-v-4b9599ea data-v-4b9599ea>degree of similarity to production environments</li>
<li data-v-4b9599ea data-v-4b9599ea>shared vs isolated resources</li>
<li data-v-4b9599ea data-v-4b9599ea>automation complexity</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Let's look at these items by considering how we can set up the main infrastructure components that will be used to run our ad hoc application environments.</p>
<h3 id="relational-databases" data-v-4b9599ea data-v-4b9599ea><a href="#relational-databases" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Relational Databases</h3>
<p data-v-4b9599ea data-v-4b9599ea>Startup speed can be measured by the time between when an environment is requested and when that environment can be used by whoever requested it. In this period of time, an automation pipeline may do some of the following:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>run <code data-v-4b9599ea data-v-4b9599ea>terraform init</code>, <code data-v-4b9599ea data-v-4b9599ea>terraform plan</code> and <code data-v-4b9599ea data-v-4b9599ea>terraform apply</code> to build infrastructure</li>
<li data-v-4b9599ea data-v-4b9599ea>run scripts to prepare the application such as database migrations</li>
<li data-v-4b9599ea data-v-4b9599ea>seeding initial sample data with a script or database dump</li>
<li data-v-4b9599ea data-v-4b9599ea>message the user with information about the environment (URLs, commands for accessing an interactive shell, etc.)</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>RDS instances can take a long time to create relative to other AWS resources such as S3 buckets and IAM roles. RDS instances are also more costly than other resources. We could use a single, shared RDS instance placed in a private subnet of a shared VPC. Each ad hoc environment could use a different named database in the RDS instance in the form <code data-v-4b9599ea data-v-4b9599ea>{ad-hoc-env-name}-db</code>. Using one RDS instance per ad hoc environment would be slow to startup and tear down and also costly if there are many developers using ad hoc environments simultaneously.</p>
<p data-v-4b9599ea data-v-4b9599ea>If we choose to isolate the application's relational database at the database level (and not the RDS instance level), then we will need our automation workflow to create a database per ad hoc environment.</p>
<p data-v-4b9599ea data-v-4b9599ea>Let's spin up a simple example to illustrate how this would would work.</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>A developer is working on <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> that involves a significant refactor of the data model.</li>
<li data-v-4b9599ea data-v-4b9599ea>The developer decides to spin up an ad hoc environment called <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code>.</li>
<li data-v-4b9599ea data-v-4b9599ea>Our automation will need to create a database in the RDS instance called <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code>.</li>
<li data-v-4b9599ea data-v-4b9599ea>We can configure a bastion host with <code data-v-4b9599ea data-v-4b9599ea>psql</code> installed that has network and security group access to our RDS instance, and we can give our GitHub Actions an SSH key that can be used to run <code data-v-4b9599ea data-v-4b9599ea>createdb</code> over SSH.</li>
<li data-v-4b9599ea data-v-4b9599ea>The automation also runs database migrations once the application has started, and we can view the logs of the database migration to check for any irregularities or other issues.</li>
<li data-v-4b9599ea data-v-4b9599ea>This will give the developer and the rest of team confidence that the promoting <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> to the next pre-production environments will not have any errors.</li>
<li data-v-4b9599ea data-v-4b9599ea>The developer may even choose to load a SQL dump of the next pre-production environment into their <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> database get even more confidence that there will be no data integrity errors.</li>
<li data-v-4b9599ea data-v-4b9599ea>When the developer's PR is merged and approved, the ad hoc environment <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> can be destroyed, including the <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> database in the shared RDS instance.</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>With this approach we won't incur the costs of multiple RDS instances. Ad hoc environments will start up faster because an RDS instance per environment is not required. We do have slightly less resource isolation, and we need to introduce a bastion host, but I consider this an acceptable trade-off.</p>
<h3 id="redis-key-value-database" data-v-4b9599ea data-v-4b9599ea><a href="#redis-key-value-database" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Redis (key-value database)</h3>
<p data-v-4b9599ea data-v-4b9599ea>Redis is another database used in the application and it plays a few different roles:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>primarily, it is a caching layer that can cache request responses to reduce load on the database and speed up our application</li>
<li data-v-4b9599ea data-v-4b9599ea>it is a message broker for our async task workers (celery)</li>
<li data-v-4b9599ea data-v-4b9599ea>it can be used as a backend for other 3rd party Django apps that our main application may need to use (such as django-constance, cache-ops, django-channels, etc.)</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>AWS offers a managed Redis service called ElastiCache. Redis running on an ElastiCache instance can do database isolation similar to how Postgres running on RDS can do database isolation as we discussed previously, but there are some key differences:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>redis databases are numbered, not named</li>
<li data-v-4b9599ea data-v-4b9599ea>the backend application uses isolated numbered databases for the different 3rd party apps that I just mentioned (for example: celery can use database <code data-v-4b9599ea data-v-4b9599ea>0</code>,  API caching layer can use database <code data-v-4b9599ea data-v-4b9599ea>1</code>, etc.)</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>This makes it difficult to use a single ElastiCache instance for our ad hoc environments since we would need to figure out which numbered database to assign to a specific role for each ad hoc environment (e.g. how do we know which numbered database to use for the API caching for the <code data-v-4b9599ea data-v-4b9599ea>feature-abc</code> ad hoc environment).</p>
<p data-v-4b9599ea data-v-4b9599ea>So how can we approach providing isolated redis instances for multiple ad hoc environments? Spoiler: my solution is to run redis as a stateful service in ECS. Before we dig into how to do this, we need to talk about another important part of our application: compute.</p>
<h3 id="compute" data-v-4b9599ea data-v-4b9599ea><a href="#compute" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Compute</h3>
<p data-v-4b9599ea data-v-4b9599ea>Our backend application is composed of a few different services that all share the same code base. In other words, our backend's services uses the same docker image but run different processes for each component:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>gunicorn for the core API</li>
<li data-v-4b9599ea data-v-4b9599ea>celery for the task workers</li>
<li data-v-4b9599ea data-v-4b9599ea>celerybeat for task scheduling</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>If our application used websockets, we could have another service that runs an asgi server process (like daphne or uvicorn).</p>
<p data-v-4b9599ea data-v-4b9599ea>Since our backend application is packaged into a container and we are using AWS as our cloud provider, ECS is a great choice for running our backend services. ECS is a container orchestration tool that I usually describe as a nice middle ground between docker swarm and Kubernetes. Simply put, it is a flexible option for running our containerized services that make up our backend application.</p>
<p data-v-4b9599ea data-v-4b9599ea>With ECS you can choose to run containers directly on EC2 instances that you manage, or you can run containers using Fargate. Fargate is a serverless compute option that takes care of managing both the underlying "computer" and operating system that run our application's containers. All of our backend dependencies are defined in our Dockerfile, so we do not to maintain or update the underlying operating system that runs our containers -- AWS handles all of this for us. To use Fargate, we simply tell AWS which containers to run and how much CPU and memory to use in the ECS Task that runs the containers. To scale our app horizontally, the ECS service that managed ECS tasks simply increases the number of tasks that run.</p>
<p data-v-4b9599ea data-v-4b9599ea>Since we are going to use the Fargate launch type for our ECS Tasks, let's talk about the ergonomics of these serverless compute instances compared to running our services directly on an EC2 instances.</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>We can't SSH into Fargate compute instances. We can instead use AWS Systems Manager and EcsExec to open an interactive shell in a running backend container. This can be useful for developers who might need to run a management command or access an interactive Django shell to verify behavior in their ad hoc environment.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>We can't simply change code on the server and restart services. This can sometimes be a useful pattern for debugging something that can only be tested on a cloud environment (e.g. something that can't easily be reproduced on your local machine), so this requires that developers push new images to their backend services for every change they want to see reflected on their ad hoc environment. Later on I'll discuss how we can provide tooling for developers to quickly update the image used in their backend services.</p>
</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>With AWS Fargate, you will pay more than you would for a comparable amount of CPU and memory on EC2 instances. Similar to EC2 spot instances, Fargate offers interruptable instances called Fargate Spot which costs significantly less than regular Fargate instances. Fargate spot is appropriate for our ad hoc environments since ad hoc environments are non-critical workloads. In the event that a Fargate spot instance is interrupted, the ECS service will automatically launch another Fargate task to replace the task that was stopped.</p>
<p data-v-4b9599ea data-v-4b9599ea>In my opinion, ECS with Fargate is ideal for running the stateless services that make up our backend application. In terms of parity with our production environment, we can keep almost everything the same, except use regular Fargate instances instead of Fargate spot instances.</p>
<h3 id="redis-revisited" data-v-4b9599ea data-v-4b9599ea><a href="#redis-revisited" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Redis, revisited</h3>
<p data-v-4b9599ea data-v-4b9599ea>We can run redis as an ECS service instead of using ElastiCache. In order to do this, we will need our backend services (gunicorn, celery and celerybeat) to be able to communicate with a fourth ECS service that will be running redis (using an official redis image from Docker Hub, or a redis image that we define in ECR).</p>
<p data-v-4b9599ea data-v-4b9599ea>By default, <strong data-v-4b9599ea data-v-4b9599ea>there is no way for our backend services to know how to communicate with any other service in our ECS cluster</strong>. If you have used docker-compose, you may know that you can use the service name <code data-v-4b9599ea data-v-4b9599ea>redis</code> in a backend service to easily communicate with a redis service called <code data-v-4b9599ea data-v-4b9599ea>redis</code>. This networking convenience is not available to use out of the box with ECS. To achieve this in AWS, we need some way to manage a unique ad hoc environment-specific Route 53 DNS record that points to the private IP of the Fargate task that is running redis in an ECS cluster for a given ad hoc environment. Such a service exists in AWS and it is called Cloud Map. Cloud Map offers service discovery so that our backend services can make network calls to a static DNS address that will reliably point to the correct private IP of the ECS task running the redis container.</p>
<p data-v-4b9599ea data-v-4b9599ea>We can define a service discovery namespace (which will essentially be a top level domain, or TLD) that all of our ad hoc environments can share. Let's assume this namespace is called <code data-v-4b9599ea data-v-4b9599ea>ad-hoc</code>. Each ad hoc environment can then define a service discovery service in the shared namespace for redis that is called <code data-v-4b9599ea data-v-4b9599ea>{ad-hoc-env-name}-redis</code>. This way, we can have a reliable address that we can configure as an environment for our backend that will look like this: <code data-v-4b9599ea data-v-4b9599ea>redis://{ad-hoc-env-name}-redis.ad-hoc:6379/0</code>. <code data-v-4b9599ea data-v-4b9599ea>{ad-hoc-env-name-redis}.ad-hoc</code> will be the hostname of the redis service, and Route 53 will create records that point to <code data-v-4b9599ea data-v-4b9599ea>{ad-hoc-env-name}-redis.ad-hoc</code> to the private IP of the redis Fargate task for each ad hoc environment.</p>
<h3 id="load-balancing" data-v-4b9599ea data-v-4b9599ea><a href="#load-balancing" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Load Balancing</h3>
<p data-v-4b9599ea data-v-4b9599ea>We now have our backend services (gunicorn, celery and celerybeat) running on Fargate spot instances, and these services can communicate with the redis service in our ad hoc environment's ECS cluster using service discovery that we configured with Cloud Map. We still need to think about a few things:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>how will we expose our API service to the public (or private) internet</li>
<li data-v-4b9599ea data-v-4b9599ea>how will we expose our frontend application to the public (or private) internet</li>
<li data-v-4b9599ea data-v-4b9599ea>how will we make sure that requests go the correct ECS services</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Application load balancers (ALBs) are a great way to expose web app traffic to the internet. We could either have one application load balancer per ad hoc environment, or one application load balancer shared between all ad hoc environments. ALBs are somewhat slow to create and they also incur a significant monthly cost. They are also highly scalable, so using a shared ALB for all ad hoc environments would work.</p>
<p data-v-4b9599ea data-v-4b9599ea>Individual ad hoc environments can then create target groups and listener rules for a shared ALB for each service that needs to serve requests from the internet (the backend and the frontend). In our case this is the backend API server and the frontend server that serves our static frontend site using NGINX.</p>
<p data-v-4b9599ea data-v-4b9599ea>ECS services that need to be exposed to the internet can specify the target group, port and container to use for load balancing. A target group is created that defines the health check and other settings, and a load balancer listener rule is created on the shared load balancer that will forward traffic matching certain conditions to the target group for our service.</p>
<p data-v-4b9599ea data-v-4b9599ea>For a given ad hoc environment, we need to specify that only traffic with certain paths should be sent to the backend service, and all other traffic should be sent to the frontend service. For example, we may only want to send traffic that starts with the path <code data-v-4b9599ea data-v-4b9599ea>/api</code> or <code data-v-4b9599ea data-v-4b9599ea>/admin</code> to the backend target group, and all other traffic should be sent to the frontend target group. We can do this by setting conditions on the listener rules that forward traffic do the frontend and backend target groups based on the hostname and path.</p>
<p data-v-4b9599ea data-v-4b9599ea>We want our listener rule logic to forward <code data-v-4b9599ea data-v-4b9599ea>/api</code>, <code data-v-4b9599ea data-v-4b9599ea>/admin</code> and any other backend traffic to the backend target group, and forward all other traffic (<code data-v-4b9599ea data-v-4b9599ea>/*</code>) to the frontend target group. In order to do this, we need the backend listener rule to have a higher priority than the frontend listener rule for each ad hoc environment. Since we are using the same load balancer for all ad hoc environments, the priority values for each listener rule need to be unique. If we don't set the priority explicitly, then the priority will be set automatically to the next available value in ascending order. In order to make sure that the backend listener rule has a higher priority than the frontend listener rule for each ad hoc environment, we need to tell Terraform that the frontend module <code data-v-4b9599ea data-v-4b9599ea>depends_on</code> the backend module. This way the backend listener rule will have a higher priority (e.g. priority of 1) because it will be created first, and the frontend listener rule will have a lower priority (e.g. priority of 2).</p>
<h2 id="more-on-shared-resources-vs-per-environment-resources" data-v-4b9599ea data-v-4b9599ea><a href="#more-on-shared-resources-vs-per-environment-resources" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>More on shared resources vs per-environment resources</h2>
<p data-v-4b9599ea data-v-4b9599ea>Up until now we have discussed infrastructure design decisions at a high level, but we have not yet talked about how to organize our infrastructure as code. At a basic level, components of our ad hoc environment either fall into shared infrastructure or infrastructure that is specific to an individual ad hoc environment. Here's a list of the resources that are shared and the resources that are specific to each ad hoc environment.</p>
<p data-v-4b9599ea data-v-4b9599ea>Shared resources include:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>VPC</li>
<li data-v-4b9599ea data-v-4b9599ea>IAM policies</li>
<li data-v-4b9599ea data-v-4b9599ea>Security groups</li>
<li data-v-4b9599ea data-v-4b9599ea>RDS instance</li>
<li data-v-4b9599ea data-v-4b9599ea>Service Discovery namespace</li>
<li data-v-4b9599ea data-v-4b9599ea>Application Load Balancer</li>
<li data-v-4b9599ea data-v-4b9599ea>Bastion host</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Ad hoc environment resources include:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>ECS Cluster</li>
<li data-v-4b9599ea data-v-4b9599ea>ECS Tasks and Services (for backend and frontend applications)</li>
<li data-v-4b9599ea data-v-4b9599ea>ECS Tasks for running management commands (such as migrate)</li>
<li data-v-4b9599ea data-v-4b9599ea>CloudWatch logging groups for containers defined in ECS Tasks</li>
<li data-v-4b9599ea data-v-4b9599ea>ALB Target groups</li>
<li data-v-4b9599ea data-v-4b9599ea>ALB listener rules</li>
<li data-v-4b9599ea data-v-4b9599ea>Route 53 record that points to the load balancer (e.g. <code data-v-4b9599ea data-v-4b9599ea>ad-hoc-env-name.example.com</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>S3 bucket for static and media assets</li>
<li data-v-4b9599ea data-v-4b9599ea>Service Discovery Service for redis service in ECS cluster</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Shared resources can be defined in one terraform configuration and deployed once. These resources will be long-lived as long as the application is under active development and the team requires on-demand provisioning of ad hoc environments.</p>
<p data-v-4b9599ea data-v-4b9599ea>Ad hoc environment resources can be defined in another terraform configuration that references outputs from the shared resource configuration using <code data-v-4b9599ea data-v-4b9599ea>terraform_remote_state</code>. Each ad hoc environment can be defined by a <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file that contains the name of the ad hoc environment (such as <code data-v-4b9599ea data-v-4b9599ea>brian</code>, <code data-v-4b9599ea data-v-4b9599ea>brian2</code>, <code data-v-4b9599ea data-v-4b9599ea>demo-feature-abc</code>, etc.). This <code data-v-4b9599ea data-v-4b9599ea>&lt;name></code> value will also be the name of the Terraform workspace and will be used to name and tag AWS resources associated with the corresponding ad hoc environment.</p>
<p data-v-4b9599ea data-v-4b9599ea>The <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file will allow developers to use a simple, standard file interface for defining application specific values, such as the version of the backend and frontend. This brings developers into the concepts and practices of "infrastructure as code" and "configuration as code" and also helps the entire team keep track of how different environments are configured.</p>
<p data-v-4b9599ea data-v-4b9599ea>Ad hoc environment <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> files are stored in a directory of a special git repository that also defines the ad hoc environment terraform configuration. Currently, the <code data-v-4b9599ea data-v-4b9599ea>tfvars</code> files are stored <a href="https://github.com/briancaffey/django-step-by-step/tree/main/terraform/live/ad-hoc/envs" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>here</a>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Now let's look at the two terraform configurations used for defining <strong data-v-4b9599ea data-v-4b9599ea>shared resources</strong> and <strong data-v-4b9599ea data-v-4b9599ea>ad hoc environment resources</strong>.</p>
<h2 id="ad-hoc-environment-diagram" data-v-4b9599ea data-v-4b9599ea><a href="#ad-hoc-environment-diagram" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Ad Hoc Environment Diagram</h2>
<p data-v-4b9599ea data-v-4b9599ea>Here's an overview of the resources used for the ad hoc environments. The <strong data-v-4b9599ea data-v-4b9599ea>letters represent shared resources</strong> and the <strong data-v-4b9599ea data-v-4b9599ea>numbers represent per-environment resources</strong>.</p>
<p data-v-4b9599ea data-v-4b9599ea><img alt="png" src="/static/adhoc.png" data-v-4b9599ea data-v-4b9599ea></p>
<h3 id="shared-architecture" data-v-4b9599ea data-v-4b9599ea><a href="#shared-architecture" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Shared architecture</h3>
<p data-v-4b9599ea data-v-4b9599ea>A. VPC (created using the <a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>official AWS VPC Module</a>)</p>
<p data-v-4b9599ea data-v-4b9599ea>B. Public subnets for bastion host, NAT Gateways and Load Balancer</p>
<p data-v-4b9599ea data-v-4b9599ea>C. Private subnets for application workloads and RDS</p>
<p data-v-4b9599ea data-v-4b9599ea>D. Application Load Balancer that is shared between all ad hoc environments. A pre-provisioned wildcard ACM certificate is attached to the load balancer that is used to secure traffic for load-balanced ECS services</p>
<p data-v-4b9599ea data-v-4b9599ea>E. Service discovery namespace that provides a namespace for application workloads to access the redis service running in ECS</p>
<p data-v-4b9599ea data-v-4b9599ea>F. IAM roles needed for ECS tasks to access AWS services</p>
<p data-v-4b9599ea data-v-4b9599ea>G. RDS instance using postgres engine that is shared between all ad hoc environments</p>
<p data-v-4b9599ea data-v-4b9599ea>H. Bastion host used to access RDS from GitHub Actions (needed for creating per-environment databases)</p>
<p data-v-4b9599ea data-v-4b9599ea>I. NAT Gateway used to give traffic in private subnets a route to the public internet</p>
<h3 id="environment-specific-architecture" data-v-4b9599ea data-v-4b9599ea><a href="#environment-specific-architecture" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Environment-specific architecture</h3>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>ECS Cluster that groups all ECS tasks for a single ad hoc environment</li>
<li data-v-4b9599ea data-v-4b9599ea>Listener rules and target groups that direct traffic from the load balancer to the ECS services for an ad hoc environment.</li>
<li data-v-4b9599ea data-v-4b9599ea>Redis service running in ECS that provides caching and serves as a task broker for celery</li>
<li data-v-4b9599ea data-v-4b9599ea>Route53 records that point to the load balancer</li>
<li data-v-4b9599ea data-v-4b9599ea>Frontend service that serves the Vue.js application over NGINX</li>
<li data-v-4b9599ea data-v-4b9599ea>API service that serves the backend with Gunicorn</li>
<li data-v-4b9599ea data-v-4b9599ea>Celery worker that process jobs in the default queue</li>
<li data-v-4b9599ea data-v-4b9599ea>Celery beat that schedules celery tasks</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>collectstatic</code> task</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>migrate</code> task</li>
<li data-v-4b9599ea data-v-4b9599ea>CloudWatch log groups are created for each ECS task in an ad hoc environment</li>
<li data-v-4b9599ea data-v-4b9599ea>Each ad hoc environment gets a database in the shared RDS instance</li>
</ol>
<h2 id="shared-resources-terraform-configuration" data-v-4b9599ea data-v-4b9599ea><a href="#shared-resources-terraform-configuration" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Shared resources terraform configuration</h2>
<p data-v-4b9599ea data-v-4b9599ea>Let's have a detailed look at the terraform configuration for shared resources that will support ad hoc environments.</p>
<p data-v-4b9599ea data-v-4b9599ea><img alt="Shared AWS resources for ad hoc environment" src="/image/shared-resources.png" data-v-4b9599ea data-v-4b9599ea></p>
<h3 id="vpc" data-v-4b9599ea data-v-4b9599ea><a href="#vpc" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>VPC</h3>
<p data-v-4b9599ea data-v-4b9599ea>We can use the <a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>AWS VPC module</a> for creating the shared VPC with Terraform. This module provides a high level interface that will provision lots of the components that are needed for a VPC following best practices, and it is less code for the DevOps team to manage compared to defining each component of a VPC (route tables, subnets, internet gateways, etc.).</p>
<h3 id="cloud-map-service-discovery-namespace" data-v-4b9599ea data-v-4b9599ea><a href="#cloud-map-service-discovery-namespace" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Cloud Map Service Discovery Namespace</h3>
<p data-v-4b9599ea data-v-4b9599ea>Cloud Map is used in order to allow services in our ECS cluster to communicate with each other. The only reason that Cloud Map is needed is so that the backend services (API, celery workers, beat) can communicate with Redis, which will be an important service for our application, providing caching and also serving as a broker for celery. If we were to use Django Channels for websockets, the Redis service would also function as the backend for Django Channels.</p>
<p data-v-4b9599ea data-v-4b9599ea>We will only need to specify <code data-v-4b9599ea data-v-4b9599ea>service_registries</code> on the redis service in our ECS cluster. What this will do is provide an address that our other services can use to communicate with redis. This address is created in the form of a Route 53 record, and it points to the private IP address of the redis service. If the private IP of the redis service is updated, the Route 53 record record for our redis service will be updated as well.</p>
<p data-v-4b9599ea data-v-4b9599ea>In order for service discovery to work in the VPC that we created, we need to add the following options to the terraform AWS VPC module:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea># DNS settings
enable_dns_hostnames = true
enable_dns_support   = true
</code></pre></div>
<h3 id="security-groups" data-v-4b9599ea data-v-4b9599ea><a href="#security-groups" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Security Groups</h3>
<p data-v-4b9599ea data-v-4b9599ea>There are two important security groups that we will set up as part of the shared infrastructure layer to be used by each ad hoc environment: one security group for the load balancer, and one security group where all of our ECS services will run.</p>
<p data-v-4b9599ea data-v-4b9599ea>The load balancer security group will allow all traffic on port <code data-v-4b9599ea data-v-4b9599ea>80</code> and <code data-v-4b9599ea data-v-4b9599ea>443</code> for <code data-v-4b9599ea data-v-4b9599ea>HTTP</code> and <code data-v-4b9599ea data-v-4b9599ea>HTTPS</code> traffic. The ECS security group will only allow inbound traffic from the application load balancer security group. It will also allow for traffic from port 6379 for redis traffic.</p>
<h3 id="iam-roles" data-v-4b9599ea data-v-4b9599ea><a href="#iam-roles" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>IAM Roles</h3>
<p data-v-4b9599ea data-v-4b9599ea>There are two important IAM roles that we will need for our ECS tasks. We need a task execution role that our ECS tasks will use to interact with other AWS services, such as S3, Secrets Manager, etc.</p>
<h3 id="rds-instance" data-v-4b9599ea data-v-4b9599ea><a href="#rds-instance" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>RDS Instance</h3>
<p data-v-4b9599ea data-v-4b9599ea>We will create one RDS instance in one of the private subnets in our VPC. This RDS instance will have one Postgres database per ad hoc environment. This RDS instance has a security group that allows all traffic from our ECS security group.</p>
<h3 id="load-balancer" data-v-4b9599ea data-v-4b9599ea><a href="#load-balancer" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Load Balancer</h3>
<p data-v-4b9599ea data-v-4b9599ea>We will use one load balancer for all ad hoc environments. This load balancer will have a wildcard ACM certificate attached to it (<code data-v-4b9599ea data-v-4b9599ea>*.dev.example.com</code>, for example). Each ad hoc environment will create a Route 53 record that will point to this load balancer's public DNS name. For example, <code data-v-4b9599ea data-v-4b9599ea>brian.dev.example.com</code> will be the address of my ad hoc environment. Requests to this address will then be routed to either the frontend ECS service or the backend ECS service depending on request header values and request path values that will be set on the listener rules.</p>
<p data-v-4b9599ea data-v-4b9599ea>By default, a load balancer supports up to 50 listener rules, so we can create plenty of ad hoc environments before we need to increase the default quota. There will be a discussion at the end of this article about AWS service quotas.</p>
<h3 id="bastion-host" data-v-4b9599ea data-v-4b9599ea><a href="#bastion-host" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Bastion Host</h3>
<p data-v-4b9599ea data-v-4b9599ea>The bastion host will be created in one of the VPC's public subnets. This will primarily be used for connecting to RDS to create new databases for new ad hoc environments, or for manually manipulating data in an ad hoc environment for debugging.</p>
<h2 id="ad-hoc-environment-resources" data-v-4b9599ea data-v-4b9599ea><a href="#ad-hoc-environment-resources" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Ad hoc environment resources</h2>
<p data-v-4b9599ea data-v-4b9599ea>Now that we have defined a shared set of infrastructure that our ad hoc environments will use, let's have a look at the resources that will be specific to ad hoc environments that will be added on top of the shared resources.</p>
<h3 id="ecs-cluster" data-v-4b9599ea data-v-4b9599ea><a href="#ecs-cluster" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>ECS Cluster</h3>
<p data-v-4b9599ea data-v-4b9599ea>The ECS Cluster is a simple grouping of ECS tasks and services.</p>
<h3 id="ecs-tasks-and-services" data-v-4b9599ea data-v-4b9599ea><a href="#ecs-tasks-and-services" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>ECS Tasks and Services</h3>
<p data-v-4b9599ea data-v-4b9599ea>Each environment will have a set of ECS tasks and services that will be used to run the application.</p>
<p data-v-4b9599ea data-v-4b9599ea>There are four important ECS services in our application that are used to run "long-running" ECS tasks. Long-running tasks are tasks that start processes that run indefinitely, rather than running until completion. The long-running tasks in our application include:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>backend web application (gunciron web server)</li>
<li data-v-4b9599ea data-v-4b9599ea>backend celery worker</li>
<li data-v-4b9599ea data-v-4b9599ea>backend celery beat</li>
<li data-v-4b9599ea data-v-4b9599ea>frontend web site (nginx web server)</li>
<li data-v-4b9599ea data-v-4b9599ea>redis</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>The infrastructure code also defines some tasks that are not long-running but rather short lived tasks that run until completion and do not start again. These tasks include:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>collectstatic</li>
<li data-v-4b9599ea data-v-4b9599ea>database migrations</li>
<li data-v-4b9599ea data-v-4b9599ea>any other ad-hoc task that we want to run, usually wrapped in a Django management command</li>
</ul>
<h2 id="how-to-setup-an-ad-hoc-environment" data-v-4b9599ea data-v-4b9599ea><a href="#how-to-setup-an-ad-hoc-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>How to setup an ad hoc environment</h2>
<p data-v-4b9599ea data-v-4b9599ea>Now that we have been over the resources that will be created to support our ad hoc environments, let's talk about how we can enable individuals on our team to create and update ad hoc environments.</p>
<h3 id="design-decisions" data-v-4b9599ea data-v-4b9599ea><a href="#design-decisions" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Design decisions</h3>
<p data-v-4b9599ea data-v-4b9599ea>The devops team will decide on the interface that will be used for creating an ad hoc environment. Since we are using Terraform, this interface will be a Terraform configuration. The minimum amount of information that our ad hoc environment configuration needs is image tags for the frontend and backend images to use. Other configurations will be provided by default values set in <code data-v-4b9599ea data-v-4b9599ea>variables.tf</code>, and these defaults can easily be overridden by passing values to <code data-v-4b9599ea data-v-4b9599ea>terraform plan</code> and <code data-v-4b9599ea data-v-4b9599ea>terraform apply</code>. I'm choosing to use <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> as the way to pass configuration values to our ad hoc environments where <code data-v-4b9599ea data-v-4b9599ea>&lt;name></code> is the name of the ad hoc environment being created. This will give us the following benefits:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>all ad hoc environments will be visible to the entire team in git since each ad hoc environment will have a <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file associated with it</li>
<li data-v-4b9599ea data-v-4b9599ea>adding additional customization to an ad hoc environment does not add additional complexity to our automation pipeline since all customization is added through a single file that will be referenced by <code data-v-4b9599ea data-v-4b9599ea>$WORKSPACE.tfvars</code></li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>The downsides of this approach are:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>creating ad hoc environments requires knowledge of git, so non-technical product team members might need help from the engineering team when setting up an ad hoc environment</li>
<li data-v-4b9599ea data-v-4b9599ea>there is an additional "manual" step of creating a <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file that must be done before running a pipeline to create an ad hoc environment</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Provided that a <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file has been created and pushed to the repo, creating or updating an ad hoc environment will be as simple as running a pipeline in GitHub Actions that specifies the <code data-v-4b9599ea data-v-4b9599ea>&lt;name></code> of our ad hoc environment. If no such <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file exists, our pipeline will fail.</p>
<h3 id="github-action" data-v-4b9599ea data-v-4b9599ea><a href="#github-action" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>GitHub Action</h3>
<p data-v-4b9599ea data-v-4b9599ea>Creating ad hoc environments will involve manually triggering a GitHub Action that runs on <code data-v-4b9599ea data-v-4b9599ea>workflow_dispatch</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Name of terraform workspace to use'
        required: true
        default: 'dev'
        type: string
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We only have to enter the name of the ad hoc environment we want to create or update. The ad hoc environment name is used as the Terraform workspace name. This name is also the name of the <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file that must be created per environment.</p>
<p data-v-4b9599ea data-v-4b9599ea>This workflow will do <code data-v-4b9599ea data-v-4b9599ea>terraform init</code>, <code data-v-4b9599ea data-v-4b9599ea>terraform plan</code> and <code data-v-4b9599ea data-v-4b9599ea>terraform apply</code> using the <code data-v-4b9599ea data-v-4b9599ea>&lt;name>.tfvars</code> file. When everything has been created, we will use the AWS CLI to prepare the environment so that it can be used. We will use the <code data-v-4b9599ea data-v-4b9599ea>aws ecs run-task</code> command to run database migrations needed so that the application code can make database queries.</p>
<h2 id="how-to-update-code-in-an-existing-ad-hoc-environment" data-v-4b9599ea data-v-4b9599ea><a href="#how-to-update-code-in-an-existing-ad-hoc-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>How to update code in an existing ad hoc environment</h2>
<p data-v-4b9599ea data-v-4b9599ea>Assuming that we have deployed an ad hoc environment called <code data-v-4b9599ea data-v-4b9599ea>brian</code> with version <code data-v-4b9599ea data-v-4b9599ea>v1.0.0</code> of the backend application and <code data-v-4b9599ea data-v-4b9599ea>v2.0.0</code> of the frontend application, let's think about the process of updating the application to <code data-v-4b9599ea data-v-4b9599ea>v1.1.0</code> of the backend and <code data-v-4b9599ea data-v-4b9599ea>v2.1.0</code> of the frontend.</p>
<p data-v-4b9599ea data-v-4b9599ea>The simplest approach to updating the application would be edit the <code data-v-4b9599ea data-v-4b9599ea>brian.tfvars</code> file with the new versions:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea># brian.tfvars
be_image_tag = "v1.1.0"
fe_image_tag = "v2.1.0"
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>If we run the same pipeline that we initially used to deploy ad hoc environment (with <code data-v-4b9599ea data-v-4b9599ea>terraform init</code>, <code data-v-4b9599ea data-v-4b9599ea>terraform plan</code> and <code data-v-4b9599ea data-v-4b9599ea>terraform apply</code>) against the updated <code data-v-4b9599ea data-v-4b9599ea>brian.tfvars</code> file, this will result in a rolling update of the frontend and backend services (<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>more on rolling updates here</a>).</p>
<p data-v-4b9599ea data-v-4b9599ea>If there are database migrations included in the new version of the code that is going out, we need to run database migrations after the <code data-v-4b9599ea data-v-4b9599ea>terraform apply</code> completes. We use a top level output from the ad hov environment terraform configuration that is a <code data-v-4b9599ea data-v-4b9599ea>run-task</code> command with all appropriate arguments that will run database migrations when called from GitHub Actions.</p>
<h3 id="order-of-operations" data-v-4b9599ea data-v-4b9599ea><a href="#order-of-operations" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Order of Operations</h3>
<p data-v-4b9599ea data-v-4b9599ea>For ad hoc environments, it is probably fine to update the services and then run the database migrations. Ad hoc environments may only have a single "user" -- the developer, so <strong data-v-4b9599ea data-v-4b9599ea>we don't need to worry about any errors that may occur if requests are made against the new version of code before database migrations have been applied</strong>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Let's consider a simple example to illustrate what can go wrong here. If we add a <code data-v-4b9599ea data-v-4b9599ea>total_views</code> to our blog post model to track the total number of page views a post has, we would add a field to the model, generate migration file with <code data-v-4b9599ea data-v-4b9599ea>makemigrations</code>, and then update our views and model serializers to make use of this new field. In the time between updating our service and running the database migrations, any requests to endpoints that access the new database field will fail since the table does not yet exist.</p>
<p data-v-4b9599ea data-v-4b9599ea>If we first run database migrations <strong data-v-4b9599ea data-v-4b9599ea>and then</strong> update application code (ECS services), then we can avoid errors about fields not existing. In our production application, we want to aim for fewer errors, so we should be using this "order of operations": first run new database migrations and then update application code.</p>
<h3 id="github-action-for-application-updates" data-v-4b9599ea data-v-4b9599ea><a href="#github-action-for-application-updates" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>GitHub Action for application updates</h3>
<p data-v-4b9599ea data-v-4b9599ea>We need a GitHub Action that can do the following:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>fetch the current container definition JSON files for each backend tasks (<code data-v-4b9599ea data-v-4b9599ea>aws ecs describe-task-definition</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>write new container definitions JSON with the new backend image tag (using <code data-v-4b9599ea data-v-4b9599ea>jq</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>register new task definitions with the new container definition JSON files for each task (<code data-v-4b9599ea data-v-4b9599ea>aws ecs register-task-definition</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>call run-task with the newly updated migration ECS task (<code data-v-4b9599ea data-v-4b9599ea>aws ecs run-task</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>wait for the task to exit and display the logs (<code data-v-4b9599ea data-v-4b9599ea>aws ecs wait tasks-stopped</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>update the backend services (gunicorn, celery, celery beat) (<code data-v-4b9599ea data-v-4b9599ea>aws ecs update-service</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>wait for the new backend services to be stable (<code data-v-4b9599ea data-v-4b9599ea>aws ecs wait services-stable</code>)</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Here's a visual representation of the backend update process:</p>
<p data-v-4b9599ea data-v-4b9599ea><img alt="png" src="/static/adhoc/ad_hoc.backend_update.drawio.png" data-v-4b9599ea data-v-4b9599ea></p>
<p data-v-4b9599ea data-v-4b9599ea>In order have the correct arguments for all of the AWS CLI calls used in the above workflow, we can use the AWS CLI to fetch resource names by tag.</p>
<p data-v-4b9599ea data-v-4b9599ea>Here is what I'm using for the script. There lots of comments, so please refer to those comments for an explanation of what the script is doing.</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-bash" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token shebang important" data-v-4b9599ea data-v-4b9599ea>#!/bin/bash</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># This script will be called to update an ad hoc environment backend</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># with a new image tag. It will first run pre-update tasks (such as migrations)</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># and then do a rolling update of the backend services.</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># It is called from the ad_hock_backend_update.yml GitHub Actions file</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># Required environment variables that need to be exported before running this script:</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># WORKSPACE - ad hoc environment workspace</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># SHARED_RESOURCES_WORKSPACE - shared resources workspace</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL</span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Updating backend services..."</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># first define a variable containing the new image URI</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>NEW_BACKEND_IMAGE_URI</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$AWS_ACCOUNT_ID</span>.dkr.ecr.us-east-1.amazonaws.com/backend:<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$BACKEND_IMAGE_TAG</span>"</span>


<span class="token comment" data-v-4b9599ea data-v-4b9599ea># register new task definitions</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>for</span> <span class="token for-or-select variable" data-v-4b9599ea data-v-4b9599ea>TASK</span> <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>in</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"migrate"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"gunicorn"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"default"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"beat"</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>do</span>
  <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Updating <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK</span> task definition..."</span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># in Terraform we name our tasks based on the ad hoc environment name</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># (also the Terraform workspace name) and the name of the task</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># (e.g. migrate, gunicorn, default, beat)</span>
  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_FAMILY</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK</span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># save the task definition JSON to a variable</span>
  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_DESCRIPTION</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span>aws ecs describe-task-definition <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task-definition $TASK_FAMILY <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># save container definitions to a file for each task</span>
  <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_DESCRIPTION</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.containerDefinitions <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    <span class="token operator" data-v-4b9599ea data-v-4b9599ea>></span> /tmp/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>.json

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># write new container definition JSON with updated image</span>
  <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Writing new <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span> container definitions JSON..."</span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># replace old image URI with new image URI in a new container definitions JSON</span>
  <span class="token function" data-v-4b9599ea data-v-4b9599ea>cat</span> /tmp/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>.json <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --arg IMAGE <span class="token string" data-v-4b9599ea data-v-4b9599ea>"<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$NEW_BACKEND_IMAGE_URI</span>"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'.[0].image |= $IMAGE'</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    <span class="token operator" data-v-4b9599ea data-v-4b9599ea>></span> /tmp/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>-new.json

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># Get the existing configuration for the task definition (memory, cpu, etc.)</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># from the variable that we saved the task definition JSON to earlier</span>
  <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Getting existing configuration for <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>..."</span>

  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>MEMORY</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> $TASK_DESCRIPTION <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.memory <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>CPU</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> $TASK_DESCRIPTION <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.cpu <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>ECS_EXECUTION_ROLE_ARN</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> $TASK_DESCRIPTION <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.executionRoleArn <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>ECS_TASK_ROLE_ARN</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> $TASK_DESCRIPTION <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.taskRoleArn <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># check the content of the new container definition JSON</span>
  <span class="token function" data-v-4b9599ea data-v-4b9599ea>cat</span> /tmp/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>-new.json

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># register new task definition using the new container definitions</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># and the values that we read off of the existing task definitions</span>
  <span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Registering new <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span> task definition..."</span>

  aws ecs register-task-definition <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --family <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --container-definitions file:///tmp/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_FAMILY</span>-new.json <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --memory <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$MEMORY</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --cpu <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$CPU</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --network-mode awsvpc <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --execution-role-arn <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$ECS_EXECUTION_ROLE_ARN</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task-role-arn <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$ECS_TASK_ROLE_ARN</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --requires-compatibilities <span class="token string" data-v-4b9599ea data-v-4b9599ea>"FARGATE"</span>

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>done</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># Now we need to run migrate, collectstatic and any other commands that need to be run</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># before doing a rolling update of the backend services</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># We will use the new task definitions we just created to run these commands</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># get the ARN of the most recent revision of the migrate task definition</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_DEFINITION</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  aws ecs describe-task-definition <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task-definition $WORKSPACE-migrate <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    .taskDefinition.taskDefinitionArn <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># get private subnets as space separated string from shared resources VPC</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>SUBNETS</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  aws ec2 describe-subnets <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --filters <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Name=tag:env,Values=<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$SHARED_RESOURCES_WORKSPACE</span>"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Name=tag:Name,Values=*private*"</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --query <span class="token string" data-v-4b9599ea data-v-4b9599ea>'Subnets[*].SubnetId'</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --output text <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># replace spaces with commas using tr</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>SUBNET_IDS</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span><span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> $SUBNETS <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>tr</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>' '</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>','</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://github.com/aws/aws-cli/issues/5348</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># get ecs_sg_id - just a single value</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>ECS_SG_ID</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  aws ec2 describe-security-groups <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --filters <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Name=tag:Name,Values=<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$SHARED_RESOURCES_WORKSPACE</span>-ecs-sg"</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --query <span class="token string" data-v-4b9599ea data-v-4b9599ea>'SecurityGroups[*].GroupId'</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --output text <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Running database migrations..."</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>START_TIME</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span><span class="token function" data-v-4b9599ea data-v-4b9599ea>date</span> +%s000<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># run the migration task and capture the taskArn into a variable called TASK_ID</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_ID</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  aws ecs run-task <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --cluster $WORKSPACE-cluster <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task-definition $TASK_DEFINITION <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --network-configuration <span class="token string" data-v-4b9599ea data-v-4b9599ea>"awsvpcConfiguration={subnets=[<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$SUBNET_IDS</span>],securityGroups=[<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$ECS_SG_ID</span>],assignPublicIp=ENABLED}"</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token string" data-v-4b9599ea data-v-4b9599ea>'.tasks[0].taskArn'</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Task ID is <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_ID</span>"</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># wait for the migrate task to exit</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># > It will poll every 6 seconds until a successful state has been reached.</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># > This will exit with a return code of 255 after 100 failed checks.</span>
aws ecs <span class="token function" data-v-4b9599ea data-v-4b9599ea>wait</span> tasks-stopped <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --tasks <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_ID</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --cluster <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-cluster

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)</span>
<span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>END_TIME</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span><span class="token function" data-v-4b9599ea data-v-4b9599ea>date</span> +%s000<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># print the CloudWatch log events to STDOUT</span>
aws logs get-log-events <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --log-group-name <span class="token string" data-v-4b9599ea data-v-4b9599ea>"/ecs/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>/migrate"</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --log-stream-name <span class="token string" data-v-4b9599ea data-v-4b9599ea>"migrate/migrate/<span class="token variable" data-v-4b9599ea data-v-4b9599ea>${TASK_ID<span class="token operator" data-v-4b9599ea data-v-4b9599ea>##</span>*<span class="token operator" data-v-4b9599ea data-v-4b9599ea>/</span>}</span>"</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --start-time <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$START_TIME</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --end-time <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$END_TIME</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token string" data-v-4b9599ea data-v-4b9599ea>'.events[].message'</span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Migrations complete. Starting rolling update for backend services..."</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># update backend services</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>for</span> <span class="token for-or-select variable" data-v-4b9599ea data-v-4b9599ea>TASK</span> <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>in</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"gunicorn"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"default"</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"beat"</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>do</span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># get taskDefinitionArn for each service to be used in update-service command</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># this will get the most recent revision of each task (the one that was just created)</span>
  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description</span>
  <span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_DEFINITION</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    aws ecs describe-task-definition <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
      --task-definition $WORKSPACE-$TASK <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
      <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
      .taskDefinition.taskDefinitionArn <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  <span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>

  <span class="token comment" data-v-4b9599ea data-v-4b9599ea># update each service with new task definintion</span>
  aws ecs update-service <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --cluster <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-cluster <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --service <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-<span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task-definition <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_DEFINITION</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --no-cli-pager

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>done</span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Services updated. Waiting for services to become stable..."</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># wait for all service to be stable (runningCount == desiredCount for each service)</span>
aws ecs <span class="token function" data-v-4b9599ea data-v-4b9599ea>wait</span> services-stable <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --cluster <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-cluster <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --services <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-gunicorn <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-default <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$WORKSPACE</span>-beat

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Services are now stable. Backend services are now up to date with <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$BACKEND_IMAGE_TAG</span>."</span>

<span class="token builtin class-name" data-v-4b9599ea data-v-4b9599ea>echo</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Backend update is now complete!"</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>With this GitHub Actions workflow, a developer can now easily change the version of backend code that is running in their ad hoc environments without needing to involve Terraform. Using the <code data-v-4b9599ea data-v-4b9599ea>ad_hoc_backend_update.yml</code> GitHub Actions workflow, a developer only needs to enter the name of the workspace and the version of the backend code they want to use. The workflow will then run the <code data-v-4b9599ea data-v-4b9599ea>migrate</code> task and update the backend services.</p>
<h3 id="using-ignore_changes-in-the-definitions" data-v-4b9599ea data-v-4b9599ea><a href="#using-ignore_changes-in-the-definitions" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Using <code data-v-4b9599ea data-v-4b9599ea>ignore_changes</code> in the definitions</h3>
<p data-v-4b9599ea data-v-4b9599ea>There is one more important point to make about Terraform before we conclude this discussion on updating backend code for existing ad hoc environments. Consider the scenario where a developer has launched an ad hoc environment with backend version <code data-v-4b9599ea data-v-4b9599ea>v1.0.0</code>. They make a small change to the backend code and push version <code data-v-4b9599ea data-v-4b9599ea>v1.0.1</code>. Next, the developer remembers that a backend environment variable needs to be changed. This can be done by updating their <code data-v-4b9599ea data-v-4b9599ea>*.tfvars</code> file. If they now re-run the ad hoc environment update pipeline <strong data-v-4b9599ea data-v-4b9599ea>without also updating the backend version in their <code data-v-4b9599ea data-v-4b9599ea>*.tfvars</code> file</strong>, then their code will be reverted from <code data-v-4b9599ea data-v-4b9599ea>v1.0.1</code> to <code data-v-4b9599ea data-v-4b9599ea>v1.0.0</code>. We would need to coordinate version changes between updating the backend with the pipelines that use Terraform commands and the pipelines that use the AWS CLI commands.</p>
<p data-v-4b9599ea data-v-4b9599ea>There is a setting on the <code data-v-4b9599ea data-v-4b9599ea>aws_ecs_service</code> resource in Terraform we can can use to prevent this from happening. This setting is called <a href="https://www.terraform.io/language/meta-arguments/lifecycle" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>ignore_changes</code></a> and is defined under the resource's <code data-v-4b9599ea data-v-4b9599ea>lifecycle</code> configuration block. With this setting, when we update the <code data-v-4b9599ea data-v-4b9599ea>*.tfvars</code> file with our new environment variable value, we will create another recent task definition with the same <code data-v-4b9599ea data-v-4b9599ea>v1.0.0</code> image, but the ECS service will not update in response to this change (that's what the <code data-v-4b9599ea data-v-4b9599ea>ignore_changes</code> is for). Once we make the <code data-v-4b9599ea data-v-4b9599ea>*.tfvars</code> file update and redeploy using the Terraform pipeline, nothing on our ad hoc changes, but we did get a new task definitions defined in our AWS account for each backend service. When we go to make the backend update with the pipeline that uses AWS CLI commands, the most recent task revision is used to create the new task definition, so it will include the environment variable change that we added earlier.</p>
<h3 id="frontend-updates" data-v-4b9599ea data-v-4b9599ea><a href="#frontend-updates" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Frontend updates</h3>
<p data-v-4b9599ea data-v-4b9599ea>The process described above is needed for updating the backend application. Updating the frontend application involves a similar process to the backend update. The main difference is that no task (such as the <code data-v-4b9599ea data-v-4b9599ea>migrate</code> command on the backend) needs to run before the service is updated. Here's an overview of the frontend update process:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>fetch the container definition JSON for the frontend tasks (<code data-v-4b9599ea data-v-4b9599ea>aws ecs describe-task-definition</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>write new container definition JSON with the new frontend image tag (using <code data-v-4b9599ea data-v-4b9599ea>jq</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>register new task definitions with the new container definition JSON file for the frontend task (<code data-v-4b9599ea data-v-4b9599ea>aws ecs register-task-definition</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>update the frontend service (<code data-v-4b9599ea data-v-4b9599ea>aws ecs update-service</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>wait for the new backend services to be stable (<code data-v-4b9599ea data-v-4b9599ea>aws ecs wait services-stable</code>)</li>
</ul>
<h2 id="setting-up-everything-from-a-new-aws-account-and-github-actions" data-v-4b9599ea data-v-4b9599ea><a href="#setting-up-everything-from-a-new-aws-account-and-github-actions" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Setting up everything from a new AWS account and GitHub Actions</h2>
<p data-v-4b9599ea data-v-4b9599ea>Here's a quick overview of initial setup steps that are needed in order to use the automation defined in the GitHub Actions for ad hoc environments.</p>
<h3 id="configure-aws-credentials-locally" data-v-4b9599ea data-v-4b9599ea><a href="#configure-aws-credentials-locally" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Configure AWS credentials locally</h3>
<p data-v-4b9599ea data-v-4b9599ea>There is one Terraform command that we will run on our local machine to setup a remote backend for storing our Terraform state. In order to run this, we need to configure AWS credentials locally.</p>
<h3 id="run-the-make-tf-bootstrap-command" data-v-4b9599ea data-v-4b9599ea><a href="#run-the-make-tf-bootstrap-command" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Run the <code data-v-4b9599ea data-v-4b9599ea>make tf-bootstrap</code> command</h3>
<p data-v-4b9599ea data-v-4b9599ea>This command will setup an S3 bucket and DynamoDB table for storing Terraform state. Running this command will also require that a <code data-v-4b9599ea data-v-4b9599ea>bootstrap.tfvars</code> file has been created from the template. This will define the AWS region and name to be used for creating resources.</p>
<h3 id="build-and-push-a-backend-and-frontend-image" data-v-4b9599ea data-v-4b9599ea><a href="#build-and-push-a-backend-and-frontend-image" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Build and push a backend and frontend image</h3>
<p data-v-4b9599ea data-v-4b9599ea>The <code data-v-4b9599ea data-v-4b9599ea>tf-bootstrap</code> command also creates ECR repositories for the backend and frontend images. We can use the <code data-v-4b9599ea data-v-4b9599ea>ecr_backend.yml</code> and <code data-v-4b9599ea data-v-4b9599ea>ecr_frontend.yml</code> GitHub Actions workflows to build and push the backend and frontend images to the ECR repositories. These pipelines accept a single parameter which is a git tag that must exist in the repo. This git tag will then be used as the image tag for the backend and frontend images.</p>
<h3 id="purchase-a-domain-name-in-route-53" data-v-4b9599ea data-v-4b9599ea><a href="#purchase-a-domain-name-in-route-53" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Purchase a domain name in Route 53</h3>
<p data-v-4b9599ea data-v-4b9599ea>I use Route 53 to manage DNS records, and have purchased a domain name that I use for testing and debugging in this and other projects.</p>
<h3 id="create-a-wildcard-acm-certificate" data-v-4b9599ea data-v-4b9599ea><a href="#create-a-wildcard-acm-certificate" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Create a wildcard ACM certificate</h3>
<p data-v-4b9599ea data-v-4b9599ea>I chose to create this certificate outside of Terraform and import it via ARN. We need a wildcard certificate so that multiple ad hoc environments can be hosted on subdomains of the same domain.</p>
<h3 id="create-a-new-ec2-key-pair" data-v-4b9599ea data-v-4b9599ea><a href="#create-a-new-ec2-key-pair" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Create a new EC2 key pair</h3>
<p data-v-4b9599ea data-v-4b9599ea>The key pair should be created manually and it needs to be added to GitHub repository secrets so that it can be used in the ad hoc environment pipelines.</p>
<h3 id="add-secrets-to-github" data-v-4b9599ea data-v-4b9599ea><a href="#add-secrets-to-github" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add secrets to GitHub</h3>
<p data-v-4b9599ea data-v-4b9599ea>The following secrets are needed for GitHub Actions to run. Add these as repository secrets:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>ACM_CERTIFICATE_ARN</code> - ARN of the wildcard ACM certificate</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_ACCESS_KEY_ID</code> - AWS access key ID</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_ACCOUNT_ID</code> - AWS account ID</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_DEFAULT_REGION</code> - AWS default region (I use <code data-v-4b9599ea data-v-4b9599ea>us-east-1</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_SECRET_ACCESS_KEY</code> - AWS secret access key</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DOMAIN_NAME</code> - domain name for the ad hoc environment (e.g. example.com)</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>KEY_NAME</code> - name of the EC2 key pair</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>SSH_PRIVATE_KEY</code> - private key for the EC2 key pair</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>TF_BACKEND_BUCKET</code> - name of the S3 bucket used for storing Terraform state</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>TF_BACKEND_DYNAMODB_TABLE</code> - name of the DynamoDB table used for locking the Terraform state file</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>TF_BACKEND_REGION</code> - AWS region for the S3 bucket and DynamoDB table</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>These secrets are referenced in the GitHub Actions workflows.</p>
<h3 id="create-shared-resources" data-v-4b9599ea data-v-4b9599ea><a href="#create-shared-resources" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Create shared resources</h3>
<p data-v-4b9599ea data-v-4b9599ea>Now that we have GitHub secrets configured, we can run the <code data-v-4b9599ea data-v-4b9599ea>shared_resources_create_update.yml</code> GitHub Actions workflow. This will create  shared resources environment in which we can build our ad hoc environments. This workflow requires a name (e.g. <code data-v-4b9599ea data-v-4b9599ea>dev</code>). This require that we create a <code data-v-4b9599ea data-v-4b9599ea>dev.tfvars</code> file in <code data-v-4b9599ea data-v-4b9599ea>terraform/live/shared-resources</code> directory. This usually takes between 5 and 7 minutes to complete since it needs to create an RDS instance which takes a few minutes to provision.</p>
<h3 id="create-an-ad-hoc-environment" data-v-4b9599ea data-v-4b9599ea><a href="#create-an-ad-hoc-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Create an ad hoc environment</h3>
<p data-v-4b9599ea data-v-4b9599ea>We can now create an ad hoc environment. This requires the name of the shared resources environment (e.g. <code data-v-4b9599ea data-v-4b9599ea>dev</code>) and the name of the ad hoc environment (e.g. <code data-v-4b9599ea data-v-4b9599ea>brian-test</code>). The only thing we need to do before creating the <code data-v-4b9599ea data-v-4b9599ea>brian-test</code> ad hoc environment is to create the <code data-v-4b9599ea data-v-4b9599ea>brian-test.tfvars</code> file in the <code data-v-4b9599ea data-v-4b9599ea>terraform/live/ad-hoc/envs</code> directory. This will define the versions of the application and any other environment configuration that is needed. This pipeline usually takes about 3 minutes to finish.</p>
<h3 id="update-the-backend-version-in-an-ad-hoc-environment" data-v-4b9599ea data-v-4b9599ea><a href="#update-the-backend-version-in-an-ad-hoc-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Update the backend version in an ad hoc environment</h3>
<p data-v-4b9599ea data-v-4b9599ea>Now that the backend is up and running and usable, we can update the backend version used in our ad hoc environment. This can be done by running the <code data-v-4b9599ea data-v-4b9599ea>ad_hoc_backend_update.yml</code> GitHub Actions workflow. To run this workflow you must specify:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>the shared resource workspace (e.g. <code data-v-4b9599ea data-v-4b9599ea>dev</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>the ad hoc environment name (e.g. <code data-v-4b9599ea data-v-4b9599ea>brian-test</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>the new version of the backend to be used (e.g. <code data-v-4b9599ea data-v-4b9599ea>v1.0.2</code>)</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>The backend version should already have been built and pushed to the ECR repository using the <code data-v-4b9599ea data-v-4b9599ea>ecr_backend.yml</code> GitHub Actions workflow.</p>
<h3 id="use-ecs-exec-to-access-a-django-shell-in-a-running-container" data-v-4b9599ea data-v-4b9599ea><a href="#use-ecs-exec-to-access-a-django-shell-in-a-running-container" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Use ECS Exec to access a Django shell in a running container</h3>
<p data-v-4b9599ea data-v-4b9599ea>Instead of SSHing into the container, we can use the <code data-v-4b9599ea data-v-4b9599ea>ecs-exec</code> command to access a shell in the container. This is useful for debugging and testing. One of the outputs of the ad hoc environment terraform configuration contains the script needed to run the <code data-v-4b9599ea data-v-4b9599ea>ecs-exec</code> command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-bash" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token assign-left variable" data-v-4b9599ea data-v-4b9599ea>TASK_ARN</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token variable" data-v-4b9599ea data-v-4b9599ea><span class="token variable" data-v-4b9599ea data-v-4b9599ea>$(</span>aws ecs list-tasks <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --cluster alpha-cluster <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
  --service-name  alpha-gunicorn <span class="token operator" data-v-4b9599ea data-v-4b9599ea>|</span> jq -r <span class="token string" data-v-4b9599ea data-v-4b9599ea>'.taskArns | .[0]'</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
<span class="token variable" data-v-4b9599ea data-v-4b9599ea>)</span></span>
aws ecs execute-command --cluster alpha-cluster <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --task <span class="token variable" data-v-4b9599ea data-v-4b9599ea>$TASK_ARN</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --container gunicorn <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --interactive <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>\</span>
    --command <span class="token string" data-v-4b9599ea data-v-4b9599ea>"/bin/bash"</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>You will then have a shell in the container:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.


Starting session with SessionId: ecs-execute-command-073d1947fa71c058c
root@ip-10-0-2-167:/code# python manage.py shell
Python 3.9.9 (main, Dec 21 2021, 10:03:34)
[GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
>>>
</code></pre></div>
<h3 id="destroy-an-ad-hoc-environment" data-v-4b9599ea data-v-4b9599ea><a href="#destroy-an-ad-hoc-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Destroy an ad hoc environment</h3>
<p data-v-4b9599ea data-v-4b9599ea>Use the <code data-v-4b9599ea data-v-4b9599ea>ad_hoc_env_destroy.yml</code> GitHub Actions workflow to destroy an ad hoc environment. To run this workflow you need to specify the shared resource workspace (e.g. <code data-v-4b9599ea data-v-4b9599ea>dev</code>) and the ad hoc environment name (e.g. <code data-v-4b9599ea data-v-4b9599ea>brian-test</code>).</p>
<h3 id="destroy-the-shared-resources-environment" data-v-4b9599ea data-v-4b9599ea><a href="#destroy-the-shared-resources-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Destroy the shared resources environment</h3>
<p data-v-4b9599ea data-v-4b9599ea>Use the <code data-v-4b9599ea data-v-4b9599ea>shared_resources_destroy.yml</code> GitHub Actions workflow to destroy the shared resources environment. To run this workflow you need to specify the shared resource workspace (e.g. <code data-v-4b9599ea data-v-4b9599ea>dev</code>).</p>
<p data-v-4b9599ea data-v-4b9599ea>This defines the full lifecycle of creating and destroying ad hoc environments.</p>
<h2 id="future-improvements-open-questions-and-next-steps" data-v-4b9599ea data-v-4b9599ea><a href="#future-improvements-open-questions-and-next-steps" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Future improvements, open questions and next steps</h2>
<h3 id="enhanced-security" data-v-4b9599ea data-v-4b9599ea><a href="#enhanced-security" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Enhanced Security</h3>
<p data-v-4b9599ea data-v-4b9599ea>The low hanging fruit here is to use least privilege (for roles used in automation) and to define all roles with IaC. Currently I am using Admin roles for the credentials I store in GitHub which is a shortcut to using IaC and is not a best practice.</p>
<h3 id="keeping-track-of-ad-hoc-environments" data-v-4b9599ea data-v-4b9599ea><a href="#keeping-track-of-ad-hoc-environments" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Keeping track of ad hoc environments</h3>
<p data-v-4b9599ea data-v-4b9599ea>We need to think about how we can keep track of our active ad hoc environments. Active environments will incur additional AWS costs, and we do not want developers or the product team to create lots of environments and then leave them running without actively using them.</p>
<p data-v-4b9599ea data-v-4b9599ea>We may decide to have some long-lived ad hoc environments, but those would be managed primarily by the DevOps team and respective owners (e.g. QA, product team, etc.).</p>
<p data-v-4b9599ea data-v-4b9599ea>One way to check the active ad hoc environments would be to use the AWS CLI. We could list the ECS clusters in our development account, and this would show the number of ad hoc environments running. We could go farther and list the ad hoc environments by when they were last updated. We could then request developers or team members to remove ad hoc environments that are not in use.</p>
<p data-v-4b9599ea data-v-4b9599ea>Or we could have a policy that all ad-hoc environments are deleted automatically at the end of each week.</p>
<h3 id="terraform-tooling" data-v-4b9599ea data-v-4b9599ea><a href="#terraform-tooling" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Terraform Tooling</h3>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>Testing Terraform Code</li>
<li data-v-4b9599ea data-v-4b9599ea>Testing GitHub Actions</li>
<li data-v-4b9599ea data-v-4b9599ea>Using advanced Terraform frameworks like Terragrunt</li>
<li data-v-4b9599ea data-v-4b9599ea>Using Terraform Cloud for more advanced Terraform features</li>
</ul>
<h3 id="more-secure-way-of-defining-rds-username-and-password" data-v-4b9599ea data-v-4b9599ea><a href="#more-secure-way-of-defining-rds-username-and-password" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>More secure way of defining RDS username and password</h3>
<p data-v-4b9599ea data-v-4b9599ea>Currently the postgres database does not have a secure password. It is both hardcoded in the module as a default value and it will also be saved in plaintext in the Terraform state file.</p>
<h3 id="backend-application-update-script" data-v-4b9599ea data-v-4b9599ea><a href="#backend-application-update-script" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Backend application update script</h3>
<p data-v-4b9599ea data-v-4b9599ea>The script used for updating the backend application could be improved or broken up into multiple scripts to better handle errors and failures that happen during the pipeline. The script runs several different commands and could potentially fail at any step, so it would be nice to improve the error messages so that both developers and DevOps teams can more quickly diagnose pipeline failures.</p>
<h3 id="limiting-traffic-to-ad-hoc-environments-to-a-vpn" data-v-4b9599ea data-v-4b9599ea><a href="#limiting-traffic-to-ad-hoc-environments-to-a-vpn" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Limiting traffic to ad hoc environments to a VPN</h3>
<p data-v-4b9599ea data-v-4b9599ea>Another good next step would be to show how we can limit traffic to ad hoc environments to a VPN.</p>
<h3 id="figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas" data-v-4b9599ea data-v-4b9599ea><a href="#figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Figure out how many ad hoc environments we can create with the default quotas</h3>
<p data-v-4b9599ea data-v-4b9599ea>AWS accounts limit the number of resources you can create, but for most of this quota limits you can request an increase per account. I need to figure out how many ad hoc environments I can create with the default quotas.</p>
<h3 id="code-repo-organization" data-v-4b9599ea data-v-4b9599ea><a href="#code-repo-organization" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Code Repo Organization</h3>
<p data-v-4b9599ea data-v-4b9599ea>One minor improvement would be to move the <code data-v-4b9599ea data-v-4b9599ea>terraform</code> directory out of the <code data-v-4b9599ea data-v-4b9599ea>django-step-by-step</code> monorepo into a dedicated repo. We may also want to move GitHub Actions for creating, updating and destroying environments to this new repo. For early stage development, using a single repository that stores both application code and Terraform configuration works, but it would be better to keep these separate at the repository level as the project grows.</p>
<h3 id="multiple-aws-accounts" data-v-4b9599ea data-v-4b9599ea><a href="#multiple-aws-accounts" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Multiple AWS Accounts</h3>
<p data-v-4b9599ea data-v-4b9599ea>Everything shown here uses a single AWS account: ECR images, Terraform remote state storage, all shared resource environments and all ad hoc environments. Using one account keeps things simple for a demonstration of this workflow, but in practice it would be beneficial to use multiple AWS accounts for different purposes. This would also involve more carefully planned IAM roles for cross-account resource access.</p>
<h3 id="modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments" data-v-4b9599ea data-v-4b9599ea><a href="#modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Modules for stable environments to be used for long-lived pre-production and production environments</h3>
<p data-v-4b9599ea data-v-4b9599ea>This article looked at how to make tradeoffs between costs, speed of deployment and production parity in ad hoc environments. I'm interested in building a new set of modules that can be used to set up environments that:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>are more stable and more long-lived</li>
<li data-v-4b9599ea data-v-4b9599ea>have less resource sharing (dedicated RDS and ElastiCache resources)</li>
<li data-v-4b9599ea data-v-4b9599ea>implement autoscaling for load-testing (or maybe implement autoscaling for ad hoc environments)</li>
<li data-v-4b9599ea data-v-4b9599ea>can be used to perform load testing</li>
<li data-v-4b9599ea data-v-4b9599ea>have enhanced observability tooling</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>These environments might be used as part of a QA process that does a final sign-off on a new set of features scheduled for deployment to production environments, for example.</p>
<h2 id="conclusion" data-v-4b9599ea data-v-4b9599ea><a href="#conclusion" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Conclusion</h2>
<p data-v-4b9599ea data-v-4b9599ea>This wraps up the tour of my ad hoc environment infrastructure automation. Thank you for having a read through my article. If you have a similar (or different) approach to building ad hoc environments, I would love to hear about it.</p></div> <div class="text-center pb-4 pt-8" data-v-4b9599ea><button class="mc-btn rounded py-1 px-2" data-v-4b9599ea>
        Show Disqus Comments 💬
      </button></div> <!----> <h1 data-v-4b9599ea></h1></div></article> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-27f2d9d4><hr class="mt-4" data-v-27f2d9d4> <div class="mx-auto py-4" data-v-27f2d9d4><div class="pb-4" data-v-27f2d9d4>
      加入我的通讯名单
    </div> <div class="mx-auto" data-v-89248ae4 data-v-27f2d9d4><div id="mc_embed_signup" class="mx-auto w-full md:w-1/2" data-v-89248ae4><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-89248ae4><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center" data-v-89248ae4><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="输入您的电子邮箱" class="rounded mc text-center" data-v-89248ae4> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-89248ae4><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-89248ae4></div> <div data-v-89248ae4><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="订阅" class="mc-btn rounded px-2 py-1 w-full" data-v-89248ae4></div></div></form></div></div></div> <hr data-v-27f2d9d4> <div class="py-4" data-v-27f2d9d4>
    感谢您访问我的网站！
  </div> <div class="pb-4" data-v-27f2d9d4>
    © 2021 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1655175621/zh/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions/state.js"></script><script src="/_nuxt/c77e7fe.js" defer></script><script src="/_nuxt/b5afa39.js" defer></script><script src="/_nuxt/9ee0ef6.js" defer></script><script src="/_nuxt/f51c3d4.js" defer></script><script src="/_nuxt/0f451e7.js" defer></script>
  </body>
</html>
