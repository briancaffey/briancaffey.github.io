<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="og:title" content="Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications"><meta data-n-head="ssr" property="og:description" content="undefined"><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/architecture_verbose_equals_true.png"><meta data-n-head="ssr" property="twitter:card" content="https://briancaffey.github.io/static/architecture_verbose_equals_true.png"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><script data-n-head="ssr" data-hid="adsbygoogle-script" defer crossorigin="anonymous" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4924597640144289"></script><script data-n-head="ssr" data-hid="adsbygoogle">window.__abg_called||((adsbygoogle=window.adsbygoogle||[]).pauseAdRequests=0,(window.adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4924597640144289",enable_page_level_ads:!1,overlays:{bottom:!1}}),window.__abg_called=!0)</script><link rel="preload" href="/_nuxt/e85cdba.js" as="script"><link rel="preload" href="/_nuxt/9ee0ef6.js" as="script"><link rel="preload" href="/_nuxt/f51c3d4.js" as="script"><link rel="preload" href="/_nuxt/279b353.js" as="script"><link rel="preload" href="/_nuxt/64dda2d.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 5a4b6265:0 14b1eaf9:0 a0fa61ae:0 7f6c3ed0:0 68771c59:0 23961490:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-4xl{font-size:2.25rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-16{margin-left:4rem;margin-right:4rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mb-1{margin-bottom:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mt-8{margin-top:2rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-16{padding-left:4rem;padding-right:4rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-16{grid-gap:4rem;gap:4rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 5px 10px 0 #0e2233;box-shadow:0 5px 10px 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 10px 40px 0 #0e2233;box-shadow:0 10px 40px 0 var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-style:italic}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{content:" ";margin-top:-85px;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-3f691362]{padding:0}.selected[data-v-3f691362]{text-shadow:.25px 0 0 #000}.picker[data-v-3f691362]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-3f691362]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-107ae01e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-4f7c5820]{padding:0}.modal[data-v-4f7c5820]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-4f7c5820],.picker[data-v-4f7c5820]{position:absolute;left:0}.picker[data-v-4f7c5820]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.tag[data-v-d8ade784]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-d8ade784]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1690292322/2020/06/02/django-postgres-vue-gitlab-ecs.html/state.js" as="script"><link rel="preload" href="/_nuxt/static/1690292322/2020/06/02/django-postgres-vue-gitlab-ecs.html/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1690292322/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-3f691362><div class="top" data-v-3f691362></div> <div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-3f691362><div class="justify-left flex-grow flex-cols-4" data-v-3f691362><a href="/" class="text-xl nuxt-link-active" data-v-3f691362><span class="hidden sm:inline text-2xl" data-v-3f691362>Brian Caffey</span><span class="inline sm:hidden" data-v-3f691362>JBC</span></a></div> <div class="flex-grow relative" data-v-3f691362><nav z-index="10000" data-v-107ae01e data-v-3f691362><div data-v-107ae01e><ul class="items-right float-right hidden md:flex" data-v-107ae01e><li class="px-4 text-lg" data-v-107ae01e><a href="/blog/1" data-v-107ae01e>
          Blog
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/projects" data-v-107ae01e>
          Projects
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/contact" data-v-107ae01e>
          Contact
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-107ae01e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-107ae01e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-107ae01e><title data-v-107ae01e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-107ae01e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-3f691362><div class="centered" data-v-288717a6 data-v-3f691362><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üñ•Ô∏è, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåû, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåö, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="‚òï, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-4f7c5820 data-v-288717a6><!----> <ul data-v-4f7c5820><li class="md:px-1 px-1 cursor-pointer" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-4f7c5820><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-4f7c5820><a href="/2020/06/02/django-postgres-vue-gitlab-ecs.html" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-4f7c5820></a><a href="/fr/2020/06/02/django-postgres-vue-gitlab-ecs.html" data-v-4f7c5820><span aria-label="üá´üá∑, fr, flag-fr" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Fran√ßais <br data-v-4f7c5820></a><a href="/zh/2020/06/02/django-postgres-vue-gitlab-ecs.html" data-v-4f7c5820><span aria-label="üá®üá≥, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> ÁÆÄ‰Ωì‰∏≠Êñá <br data-v-4f7c5820></a><a href="/ru/2020/06/02/django-postgres-vue-gitlab-ecs.html" data-v-4f7c5820><span aria-label="üá∑üá∫, ru, flag-ru" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> –†—É—Å—Å–∫–∏–π <br data-v-4f7c5820></a><a href="/jp/2020/06/02/django-postgres-vue-gitlab-ecs.html" data-v-4f7c5820><span aria-label="üáØüáµ, jp, flag-jp" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> Êó•Êú¨Ë™û <br data-v-4f7c5820></a><a href="/in/2020/06/02/django-postgres-vue-gitlab-ecs.html" data-v-4f7c5820><span aria-label="üáÆüá≥, flag-in" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> ‡§π‡§ø‡§Ç‡§¶‡•Ä <br data-v-4f7c5820></a></div></div></div></li></ul></div></div></div></div> <article data-v-07b74c72><img src="/static/architecture_verbose_equals_true.png" class="pt-2 w-full object-cover cover-image" style="height:24rem" data-v-07b74c72> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-07b74c72><h1 class="prose text-4xl leading-9 py-4 font-bold" data-v-07b74c72>
      Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-07b74c72><a href="/blog/tags/fargate" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    fargate üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/django" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    django üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/gitlab" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    gitlab üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/vue" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    vue üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/cdk" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    cdk üè∑Ô∏è
    <!----></div></a></div> <!----> <p class="blog-date text-gray-500 mb-4" data-v-07b74c72>
      Last Updated on
      June 2, 2020
    </p> <!----> <div class="markdown nuxt-content" data-v-07b74c72 data-v-07b74c72><blockquote data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>This article was originally posted on <a href="https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i</a>. It is also available on the documentation site for the project: <a href="https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/</a></p>
</blockquote>
<h1 id="project-overview" data-v-07b74c72 data-v-07b74c72><a href="#project-overview" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Project Overview</h1>
<p data-v-07b74c72 data-v-07b74c72>This is an overview of a Proof-of-Concept web application I'm working on called <code data-v-07b74c72 data-v-07b74c72>django-postgres-vue-gitlab-ecs</code>. This project aims to demonstrate the development and deployment of a web application using some of my favorite tools, languages and frameworks including:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Python</li>
<li data-v-07b74c72 data-v-07b74c72>Django</li>
<li data-v-07b74c72 data-v-07b74c72>JavaScript</li>
<li data-v-07b74c72 data-v-07b74c72>Vue.js/Quasar Framework</li>
<li data-v-07b74c72 data-v-07b74c72>GitLab</li>
<li data-v-07b74c72 data-v-07b74c72>AWS</li>
<li data-v-07b74c72 data-v-07b74c72>and last but not least, <strong data-v-07b74c72 data-v-07b74c72>AWS Cloud Development Kit (CDK)</strong></li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>This README will start by describing some features of the application I'm building and how the different technologies are used together. I also share my experience in adopting CDK for managing cloud infrastructure on AWS. Finally, I discuss my solution to a specific question I have been trying to answer: what's the best way to scale Celery workers to zero to reduce Total Cost of Ownership?</p>
<h2 id="development-philosophies-and-best-practices" data-v-07b74c72 data-v-07b74c72><a href="#development-philosophies-and-best-practices" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Development Philosophies and Best Practices</h2>
<p data-v-07b74c72 data-v-07b74c72>Here are some of the best practices that this project aims to use:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Open-source, MIT-Licensed</li>
<li data-v-07b74c72 data-v-07b74c72>12 Factor App</li>
<li data-v-07b74c72 data-v-07b74c72>Infrastructure as Code</li>
<li data-v-07b74c72 data-v-07b74c72>Containerization with Docker</li>
<li data-v-07b74c72 data-v-07b74c72>Testing</li>
<li data-v-07b74c72 data-v-07b74c72>GitOps</li>
<li data-v-07b74c72 data-v-07b74c72>Serverless* <strong data-v-07b74c72 data-v-07b74c72>[1]</strong></li>
<li data-v-07b74c72 data-v-07b74c72>Project documentation</li>
<li data-v-07b74c72 data-v-07b74c72>Cost containment and tracking</li>
<li data-v-07b74c72 data-v-07b74c72>KISS & DRY</li>
<li data-v-07b74c72 data-v-07b74c72>Initial AWS console interaction is strictly limited to what can <em data-v-07b74c72 data-v-07b74c72>only</em> be done through the AWS console, otherwise AWS CDK and AWS CLI (preferably in CI/CD pipelines) are the primary means of interacting with AWS resources and the AWS Console is treated as a "read-only" convenience.</li>
</ul>
<h2 id="topics" data-v-07b74c72 data-v-07b74c72><a href="#topics" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Topics</h2>
<p data-v-07b74c72 data-v-07b74c72><img alt="png" src="/static/architecture_verbose_equals_true.png" data-v-07b74c72 data-v-07b74c72></p>
<h3 id="legend" data-v-07b74c72 data-v-07b74c72><a href="#legend" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Legend</h3>
<blockquote data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>This diagram was created with draw.io. Here's the link to the a read-only version of the diagram on draw.io: <a href="https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing</a></p>
</blockquote>
<p data-v-07b74c72 data-v-07b74c72>1 - GitLab is used to host the source code, test the source code and deploy the application to AWS.</p>
<p data-v-07b74c72 data-v-07b74c72>2 - Unit testing (see .gitlab-ci.yml)</p>
<p data-v-07b74c72 data-v-07b74c72>2a - Pytest</p>
<p data-v-07b74c72 data-v-07b74c72>2b - Jest</p>
<p data-v-07b74c72 data-v-07b74c72>2c - Cypress</p>
<p data-v-07b74c72 data-v-07b74c72>3 - Deployment phase (see /gitlab-ci/aws/cdk.yml)</p>
<p data-v-07b74c72 data-v-07b74c72>3a - Quasar PWA assets are built if there are changes in the quasar directory</p>
<p data-v-07b74c72 data-v-07b74c72>3b - AWS Cloud Development Kit (CDK) defines all infrastructure in AWS (4a - 12)</p>
<p data-v-07b74c72 data-v-07b74c72>3c - AWS CLI is used to run Fargate tasks through manual GitLab CI jobs</p>
<p data-v-07b74c72 data-v-07b74c72>4 - CDK Assets (ECR and S3 buckets that CDK uses internally to manage build assets and artifacts)</p>
<p data-v-07b74c72 data-v-07b74c72>4a - Elastic Container Repository is used to manage the Django docker image used in various parts of the application</p>
<p data-v-07b74c72 data-v-07b74c72>4b - S3 bucket used to store files associated with CDK and CloudFormation</p>
<p data-v-07b74c72 data-v-07b74c72>5 - Route53 is used to route traffic to the CloudFront distribution</p>
<p data-v-07b74c72 data-v-07b74c72>6 - CloudFront distribution that serves as the "front desk" of the application. It routes requests to to the correct CloudFront Origin</p>
<p data-v-07b74c72 data-v-07b74c72>7 - CloudFront Origin Configurations</p>
<p data-v-07b74c72 data-v-07b74c72>7a - S3 bucket for Quasar PWA assets</p>
<p data-v-07b74c72 data-v-07b74c72>7b - Application Load Balancer for Django application (/api/, /admin/, /flower/, /ws/, /graphql/)</p>
<p data-v-07b74c72 data-v-07b74c72>7c - S3 bucket for Django assets (static files, public media and private media)</p>
<p data-v-07b74c72 data-v-07b74c72>8 - Web server and websocket servers</p>
<p data-v-07b74c72 data-v-07b74c72>8a - Fargate service running uvicorn process (REST, GraphQL, Django Channels)</p>
<p data-v-07b74c72 data-v-07b74c72>8b - Autoscaling Group for Fargate Service that serves Django API</p>
<p data-v-07b74c72 data-v-07b74c72>9 - Celery and celery worker autoscaling</p>
<p data-v-07b74c72 data-v-07b74c72>9a - Fargate service that is autoscaled between 0 and N Fargate tasks for a given celery queue</p>
<p data-v-07b74c72 data-v-07b74c72>9b - Scheduled Event that triggers a Lambda to make a request to Django backend which collects celery queue metrics and published
metrics to CloudWatch using boto3</p>
<p data-v-07b74c72 data-v-07b74c72>9c - Lambda event the makes a request to /api/celery-metrics/</p>
<p data-v-07b74c72 data-v-07b74c72>9d - CloudWatch alarm that is used to scale the Fargate service for a celery queue</p>
<p data-v-07b74c72 data-v-07b74c72>9e - Autoscaling group for celery Fargate service</p>
<p data-v-07b74c72 data-v-07b74c72>10 - Fargate tasks that run Django management commands such as migrate and collectstatic. These are triggered from manual GitLab CI
jobs using the AWS CLI (3c)</p>
<p data-v-07b74c72 data-v-07b74c72>11 - ElastiCache for Redis, used for Caching, Celery Broker, Channels Layer, etc.</p>
<p data-v-07b74c72 data-v-07b74c72>12 - Aurora Postgres Serverless</p>
<p data-v-07b74c72 data-v-07b74c72>Here's a list of some of the major topics covered:</p>
<h3 id="local-development" data-v-07b74c72 data-v-07b74c72><a href="#local-development" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Local development</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Setting up a local development environment using docker with one easy command: <code data-v-07b74c72 data-v-07b74c72>docker-compose up</code></li>
<li data-v-07b74c72 data-v-07b74c72>Hot-reloading for all parts of the application in local development</li>
<li data-v-07b74c72 data-v-07b74c72>Structuring a Django application (apps, settings modules, environment variables)</li>
<li data-v-07b74c72 data-v-07b74c72>Automatic code formatting with black and prettier</li>
<li data-v-07b74c72 data-v-07b74c72>Monitoring services (flower, pgadmin4, redis-commander)</li>
<li data-v-07b74c72 data-v-07b74c72>VSCode settings and extensions</li>
</ul>
<h3 id="gitlab-ci" data-v-07b74c72 data-v-07b74c72><a href="#gitlab-ci" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>GitLab CI</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>GitLab CI for running unit and integration tests</li>
<li data-v-07b74c72 data-v-07b74c72>GitLab CI configuration for deployment to multiple environments (dev, prod) using AWS CDK</li>
<li data-v-07b74c72 data-v-07b74c72>GitLab CI scheduled jobs for updating all project dependencies through automated merge requests with Renovate</li>
<li data-v-07b74c72 data-v-07b74c72>GitLab CI manual jobs for running admin and management commands (database migrations, collectstatic, etc.)</li>
<li data-v-07b74c72 data-v-07b74c72>How to deploy to multiple environments (master -> staging, tags -> prod pattern as well as optional ephemeral environments per commit) using the new GitLab CI <code data-v-07b74c72 data-v-07b74c72>rules</code> syntax</li>
<li data-v-07b74c72 data-v-07b74c72>Recording Cypress test videos with GitLab CI artifacts for manual review</li>
</ul>
<h3 id="aws" data-v-07b74c72 data-v-07b74c72><a href="#aws" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>AWS</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Initial account setup</li>
<li data-v-07b74c72 data-v-07b74c72>Generating keys used in GitLab CI for deployment</li>
<li data-v-07b74c72 data-v-07b74c72>Opting in to new ARN format for ECS services and tasks (used for resource tagging) and container insights</li>
<li data-v-07b74c72 data-v-07b74c72>AWS Cloud Development Kit (CDK) for Infrastructure as Code to manage all AWS resources with CloudFormation Stacks - Nested stacks for grouping related resources under parent tasks (one parent task represent on environment for the application, such as production)</li>
</ul>
<h4 id="aws-resources" data-v-07b74c72 data-v-07b74c72><a href="#aws-resources" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>AWS Resources</h4>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Automated provisioning of Amazon Certificate Manager certificates for TLS (HTTPS)</li>
<li data-v-07b74c72 data-v-07b74c72>Multi-AZ VPC with security groups and NACLs (no NAT Gateways/NAT instances used* <strong data-v-07b74c72 data-v-07b74c72>[2]</strong>)</li>
<li data-v-07b74c72 data-v-07b74c72>S3 buckets for static site hosting and Django static and media assets</li>
<li data-v-07b74c72 data-v-07b74c72>CloudFront for serving Vue.js SPA (PWA) static assets, Django static/media files and proxy to Application Load Balancer which forwards to ECS</li>
<li data-v-07b74c72 data-v-07b74c72>Fargate for multiple Django processes: gunicorn for backend API, daphne for Django Channels, celery for asynchronous tasks and celery beat for scheduled tasks</li>
<li data-v-07b74c72 data-v-07b74c72>Autoscaling (between 0 and N Fargate tasks) for infrequent, compute/memory intensive and long-running celery tasks with custom CloudWatch metrics</li>
<li data-v-07b74c72 data-v-07b74c72>Hosted Redis with ElastiCache for celery broker, application caching, django-constance, etc.</li>
<li data-v-07b74c72 data-v-07b74c72>Aurora Postgres and Aurora Postgres Serverless for cost savings in staging environments</li>
<li data-v-07b74c72 data-v-07b74c72>CDK Assets for automating S3 asset deployment and automated container building during deployment with AWS CDK</li>
<li data-v-07b74c72 data-v-07b74c72>Thorough resource tagging by both application and environment (dev, prod, etc.) for comprehensive cost tracking</li>
<li data-v-07b74c72 data-v-07b74c72>Optional bastion host for SSH access to bring up a Django shell in a container running on a container instance (this requires an EC2 instance)</li>
</ul>
<h3 id="django-application" data-v-07b74c72 data-v-07b74c72><a href="#django-application" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Django Application</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Django REST Framework</li>
<li data-v-07b74c72 data-v-07b74c72>JWT-based authentication with django-rest-framework-simplejwt</li>
<li data-v-07b74c72 data-v-07b74c72>Custom user model with email as username</li>
<li data-v-07b74c72 data-v-07b74c72>Social authentication with <code data-v-07b74c72 data-v-07b74c72>python-social-auth</code> (Google, Facebook, GitHub)</li>
<li data-v-07b74c72 data-v-07b74c72>Pytest for unit testing</li>
<li data-v-07b74c72 data-v-07b74c72>Settings broken into separate modules (development, ci, production)</li>
<li data-v-07b74c72 data-v-07b74c72>Django apps organized in <code data-v-07b74c72 data-v-07b74c72>apps</code> directory</li>
<li data-v-07b74c72 data-v-07b74c72>S3 for static assets, public media and private media files in production, local file system for assets in local development</li>
<li data-v-07b74c72 data-v-07b74c72>Multiple Celery queues for asynchronous tasks</li>
<li data-v-07b74c72 data-v-07b74c72>Django Channels for websocket support with daphne</li>
<li data-v-07b74c72 data-v-07b74c72>Graphene for GraphQL</li>
</ul>
<h3 id="vuejs-application" data-v-07b74c72 data-v-07b74c72><a href="#vuejs-application" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Vue.js application</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Quasar Framework for creating a Vue.js app with multiple build targets (SPA, PWA, Electron, SSR and Cordova)</li>
<li data-v-07b74c72 data-v-07b74c72>Internationalization</li>
<li data-v-07b74c72 data-v-07b74c72>Dark/Light mode</li>
<li data-v-07b74c72 data-v-07b74c72>Vuex for state management</li>
<li data-v-07b74c72 data-v-07b74c72>vue-router</li>
<li data-v-07b74c72 data-v-07b74c72>axios</li>
<li data-v-07b74c72 data-v-07b74c72>Vue Apollo</li>
</ul>
<h3 id="aws--django--vuejs" data-v-07b74c72 data-v-07b74c72><a href="#aws--django--vuejs" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>AWS ‚à© Django ‚à© Vue.js</h3>
<p data-v-07b74c72 data-v-07b74c72>CloudFront is used as a CDN and proxy in order to serve the frontend Vue.js PWA* <strong data-v-07b74c72 data-v-07b74c72>[3]</strong>, static and media assets, Django API and other monitoring services all on the same URL with environments namespaced by subdomain (or a combination of domain and subdomains by production and non-production environments, respectively). The PWA uses Workbox to route certain URL paths to network only (not served by the local cache).</p>
<p data-v-07b74c72 data-v-07b74c72>Here are some examples:</p>
<h4 id="staging-environment-urls" data-v-07b74c72 data-v-07b74c72><a href="#staging-environment-urls" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Staging environment URLs</h4>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/api/*</code> - Django REST Framework</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/admin/*</code> - Django Admin</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/graphql/</code> - Graphene/GraphQL</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/flower/*</code> - Flower (Celery monitoring utility)</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/media/private/private-file.csv</code> - private media files</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://dev.mysite.com/*</code> - Vue.js PWA (all other routes load <code data-v-07b74c72 data-v-07b74c72>index.html</code>)</li>
</ul>
<h4 id="production-environment-urls" data-v-07b74c72 data-v-07b74c72><a href="#production-environment-urls" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Production environment URLs</h4>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com/api/*</code> - Django REST Framework</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com/admin/*</code> - Django Admin</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com/graphql/</code> - Graphene/GraphQL</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com/flower/*</code> - Flower (Celery monitoring utility)</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com/media/private/private-file.csv</code> - private media files</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://mysite.com</code> - Vue.js PWA (all other routes load <code data-v-07b74c72 data-v-07b74c72>index.html</code>)</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>Alternatively, the production domain name could be configured to use a dedicated subdomain such as <code data-v-07b74c72 data-v-07b74c72>https://app.mysite.com</code>.</p>
<h3 id="sample-application-logic" data-v-07b74c72 data-v-07b74c72><a href="#sample-application-logic" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Sample application logic</h3>
<p data-v-07b74c72 data-v-07b74c72>While this is mostly a Proof-of-Concept project that focuses on architecture, I have included some light-weight examples of what you can do with this application. These examples are all WIP.</p>
<h4 id="social-authentication" data-v-07b74c72 data-v-07b74c72><a href="#social-authentication" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Social Authentication</h4>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Uses <code data-v-07b74c72 data-v-07b74c72>python-social-auth</code> to allow users to Sign Up/Login with Google, Facebook and GitHub accounts</li>
<li data-v-07b74c72 data-v-07b74c72>Makes use of the custom user model</li>
</ul>
<h4 id="credit-card-statement-app" data-v-07b74c72 data-v-07b74c72><a href="#credit-card-statement-app" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Credit Card Statement App</h4>
<p data-v-07b74c72 data-v-07b74c72>This is a simple application for users to upload credit card statements in CSV format.</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Credit card transactions in CSV files are created using bulk inserts via the Django ORM in a celery task</li>
<li data-v-07b74c72 data-v-07b74c72>CSV files are saved in private S3 storage</li>
<li data-v-07b74c72 data-v-07b74c72>Basic visualization of spend over time</li>
<li data-v-07b74c72 data-v-07b74c72>Download consolidated CSV file</li>
</ul>
<h4 id="hacker-news-clone" data-v-07b74c72 data-v-07b74c72><a href="#hacker-news-clone" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Hacker News Clone</h4>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>An implementation of the application from this tutorial: <a href="https://www.howtographql.com/graphql-python/0-introduction/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://www.howtographql.com/graphql-python/0-introduction/</a></li>
<li data-v-07b74c72 data-v-07b74c72>Uses Vue Apollo GraphQL client</li>
</ul>
<h3 id="testing" data-v-07b74c72 data-v-07b74c72><a href="#testing" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Testing</h3>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Unit testing with pytest and Jest</li>
<li data-v-07b74c72 data-v-07b74c72>Test coverage reports</li>
<li data-v-07b74c72 data-v-07b74c72>Integration testing with Cypress</li>
<li data-v-07b74c72 data-v-07b74c72>Capture integration test run recordings as GitLab CI job artifacts</li>
<li data-v-07b74c72 data-v-07b74c72>Testing GitLab CI jobs locally with <code data-v-07b74c72 data-v-07b74c72>gitlab-runner</code></li>
<li data-v-07b74c72 data-v-07b74c72>Tests for CDK?* <strong data-v-07b74c72 data-v-07b74c72>[4]</strong></li>
</ul>
<h3 id="caveats-questions-confusion-and-footnotes" data-v-07b74c72 data-v-07b74c72><a href="#caveats-questions-confusion-and-footnotes" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Caveats, Questions, Confusion and Footnotes</h3>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>In the context of this project, it is serverless in the sense that AWS Fargate is serverless: there are no EC2 instances to manage. It is not serverless in the way that Zappa can deploy a Django application as an AWS Lambda function with one invocation per request. There are "always on" processes that listen for incoming requests. I'm interested in trying Zappa, but I'm confused about how CDK, zappa-cli, SAM and Serverless Framework would all play together. Aurora Postgres Serverless is another nice "serverless" aspect of this project and contributes significantly to cost savings.</p>
</li>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>This project currently uses no NAT Gateways. The Fargate services and tasks running Django processes (gunicorn, celery, daphne as well as migration, collectstatic and other management commands) are launched in public subnets and the databases (RDS and ElastiCache) are placed in private subnets. This is primarily done to avoid the cost of running a NAT Gateway.</p>
</li>
</ol>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>I think it would fairly easy to switch to using a NAT Gatway to add an additional layer of security that is recommended in this article: <a href="https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/</a>.</li>
<li data-v-07b74c72 data-v-07b74c72>I asked a question about this on the Stack Exchange Information Security forum: <a href="https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job</a>
I'm curious to know if this is a reasonable tradeoff to make, as well as how secure the proposed solution is (using security groups and network ACLs).</li>
</ul>
<ol start="3" data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>I'm not focusing on SEO in this project. I'm using <code data-v-07b74c72 data-v-07b74c72>index.html</code> as the error document for the S3 website that CloudFront uses as the default behavior. This means that nested routes for the PWA have 404 response codes. I have heard about using lambda@edge to rewrite the the response code, I'm also curious about using this project in SSR mode (and also "serverless-side rendering"), but for now that is outside of the scope of what I want to do with this project.</p>
</li>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72><strong data-v-07b74c72 data-v-07b74c72>CDK is an awesome tool!</strong> Here is a great introduction by Nathan Peck, Senior Developer Advocate at Amazon Web Services: <a href="https://www.youtube.com/watch?v=184S7ki6fJA" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://www.youtube.com/watch?v=184S7ki6fJA</a>.</p>
</li>
</ol>
<h2 id="my-experience-with-aws-cdk" data-v-07b74c72 data-v-07b74c72><a href="#my-experience-with-aws-cdk" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>My experience with AWS CDK</h2>
<p data-v-07b74c72 data-v-07b74c72>Having worked with CloudFormation for almost a year, I was not looking forward to learning a another Infrastructure as Code (IaC) tool. I struggled with CloudFormation and the whole concept of using an extended version of YAML to define infrastructure for multiple environments. I have limited experience with Terraform, but learning another DSL seemed like a lateral move that didn't seem worth it. I'm glad I did spend time learning and using CloudFormation, because CDK is an abstraction layer over CloudFormation. Here are some of my thoughts on adopting CDK.</p>
<h3 id="start-here-httpscdkworkshopcom" data-v-07b74c72 data-v-07b74c72><a href="#start-here-httpscdkworkshopcom" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Start here: <a href="https://cdkworkshop.com" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://cdkworkshop.com</a></h3>
<p data-v-07b74c72 data-v-07b74c72>This is a great resource that was my first exposure to CDK. It focuses on using Lambda, DynamoDB and API Gateway, three technologies that I haven't used in production environments. In my mind this stack is the antithesis of the stack paradigm I am most experienced with: EC2, RDS and ELB. Regardless, I went ahead with it and was pretty much instantly hooked on CDK.</p>
<h3 id="the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing" data-v-07b74c72 data-v-07b74c72><a href="#the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>The stack is defined by a small number of inputs used for namespacing</h3>
<p data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>awscdk/app.py</code> is the entrypoint for <code data-v-07b74c72 data-v-07b74c72>cdk</code> commands. Here's what it contains:</p>
<p data-v-07b74c72 data-v-07b74c72>Here are the main parameters for <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code>, which represents all of the resources for a specific environment environment. Each value is composed of environment variables set in GitLab CI when <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> is called:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>environment_name</code> - Possible examples could be <code data-v-07b74c72 data-v-07b74c72>dev</code>, <code data-v-07b74c72 data-v-07b74c72>qa</code>, <code data-v-07b74c72 data-v-07b74c72>some-feature-branch</code>, <code data-v-07b74c72 data-v-07b74c72>prod</code>, etc.</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>base_domain_name</code> - The domain name of the Hosted Zone that needs to be setup manually in Route53</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>full_domain_name</code> - <code data-v-07b74c72 data-v-07b74c72>f"{environment_name}.{base_domain_name}"</code> or optionally just <code data-v-07b74c72 data-v-07b74c72>base_domain_name</code></li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>base_app_name</code> - Based on the <code data-v-07b74c72 data-v-07b74c72>base_domain_name</code>, but <code data-v-07b74c72 data-v-07b74c72>.</code> is replaced with <code data-v-07b74c72 data-v-07b74c72>-</code> in order to be used for naming certain AWS resources, used for resources tagging so we can easily look at the costs of all environments for our application with one tag.</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>full_app_name</code> - Base on <code data-v-07b74c72 data-v-07b74c72>full_domain_name</code>, <code data-v-07b74c72 data-v-07b74c72>.</code> replaced with <code data-v-07b74c72 data-v-07b74c72>-</code> as well.</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>aws_region</code></li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>Expand to the following to view <code data-v-07b74c72 data-v-07b74c72>awscdk/app.py</code>:</p>
<details data-v-07b74c72 data-v-07b74c72>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token comment" data-v-07b74c72 data-v-07b74c72>#!/usr/bin/env python3</span>
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> os

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>from</span> aws_cdk <span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> core

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>from</span> awscdk<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>cdk_app_root <span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> ApplicationStack

<span class="token comment" data-v-07b74c72 data-v-07b74c72># naming conventions, also used for ACM certs, DNS Records, resource naming</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># Dynamically generated resource names created in CDK are used in GitLab CI</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># such as cluster name, task definitions, etc.</span>
environment_name <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'ENVIRONMENT'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>'dev'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>"</span></span>
base_domain_name <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"DOMAIN_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"mysite.com"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># if the the production environent subdomain should nott be included in the URL</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># redefine `full_domain_name` to `base_domain_name` for that environment</span>
full_domain_name <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>environment_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>.</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>base_domain_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>"</span></span>  <span class="token comment" data-v-07b74c72 data-v-07b74c72># dev.mysite.com</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># if environment_name == "prod":</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72>#     full_domain_name = base_domain_name</span>
base_app_name <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"APP_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"mysite-com"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
full_app_name <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>environment_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>-</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>base_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>"</span></span>  <span class="token comment" data-v-07b74c72 data-v-07b74c72># dev-mysite-com</span>
aws_region <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"AWS_DEFAULT_REGION"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"us-east-1"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>


app <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>App<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
stack <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> ApplicationStack<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
    app<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>-stack"</span></span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    environment_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>environment_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    base_domain_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>base_domain_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    full_domain_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>full_domain_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    base_app_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>base_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    full_app_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    env<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"region"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> aws_region<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

<span class="token comment" data-v-07b74c72 data-v-07b74c72># in order to be able to tag ECS resources, you need to go to</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># and enable at least Service and Task. Optionally enable</span>
<span class="token comment" data-v-07b74c72 data-v-07b74c72># CloudWatch Container Insights</span>
stack<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>node<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>apply_aspect<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Tag<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"StackName"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
stack<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>node<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>apply_aspect<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Tag<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"StackName"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> base_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

app<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>synth<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
</details>
<h3 id="using-cdk-synth-in-development" data-v-07b74c72 data-v-07b74c72><a href="#using-cdk-synth-in-development" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Using <code data-v-07b74c72 data-v-07b74c72>cdk synth</code> in development</h3>
<p data-v-07b74c72 data-v-07b74c72>When I first started using CDK, I defined a root stack containing multiple CDK constructs that each included groups of related CDK resources. For example, I had an <code data-v-07b74c72 data-v-07b74c72>RDSConstruct</code> that contained a <code data-v-07b74c72 data-v-07b74c72>Secret</code>, a <code data-v-07b74c72 data-v-07b74c72>StringParameter</code>, a <code data-v-07b74c72 data-v-07b74c72>CfnSecurityGroup</code>, a <code data-v-07b74c72 data-v-07b74c72>CfnDBSubnetGroup</code> and a <code data-v-07b74c72 data-v-07b74c72>CfnDBCluster</code>. Whenever I added a new section of CDK code, I would run <code data-v-07b74c72 data-v-07b74c72>cdk synth > stack.yml</code> to generate a "snapshot" of my infrastructure in one file. <code data-v-07b74c72 data-v-07b74c72>stack.yml</code> was committed in my repo, and I could easily see how changes in CDK code changed the resulting CloudFormation YAML by repeating this <code data-v-07b74c72 data-v-07b74c72>cdk synth</code> command.</p>
<h3 id="nestedstacks" data-v-07b74c72 data-v-07b74c72><a href="#nestedstacks" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>NestedStack</code>s</h3>
<p data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>stack.yml</code> grew larger and larger as I added more resources in my main "master stack" or "skeleton stack", and I realized that I was going to reach the hard limit of 200 resources per CloudFormation stack. Refactoring to use <code data-v-07b74c72 data-v-07b74c72>NestedStack</code>s was pretty straightforward, all I had to do was replace <code data-v-07b74c72 data-v-07b74c72>core.Construct</code> with <code data-v-07b74c72 data-v-07b74c72>cloudformation.NestedStack</code>. With nested stacks, running <code data-v-07b74c72 data-v-07b74c72>cdk synth > stack.yml</code> references the <code data-v-07b74c72 data-v-07b74c72>AWS::CloudFormation::Stack</code>s that are created, with <code data-v-07b74c72 data-v-07b74c72>TemplateURL</code> and parameters from other stacks. It is more useful to look into contents of <code data-v-07b74c72 data-v-07b74c72>cdk.out</code> when working with <code data-v-07b74c72 data-v-07b74c72>NestedStack</code>s. The following command (executed from the root of the project) update the contents of the <code data-v-07b74c72 data-v-07b74c72>awscdk/cdk.out</code> directory with templates for each of the <code data-v-07b74c72 data-v-07b74c72>NestedStack</code>s:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>cdk synth --app awscdk/app.py --output awscdk/cdk.out
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>The result is JSON, not YAML, and <code data-v-07b74c72 data-v-07b74c72>cdk.out</code> is <code data-v-07b74c72 data-v-07b74c72>.gitignore</code>d, but it can still be helpful in verifying that your CDK code is generating the correct CloudFormation templates. (<code data-v-07b74c72 data-v-07b74c72>cdk diff</code> may be the best option for seeing how CDK code changes will change your infrastructure).</p>
<h3 id="cdk-deploy-and-cdk-in-gitlab-ci-pipelines" data-v-07b74c72 data-v-07b74c72><a href="#cdk-deploy-and-cdk-in-gitlab-ci-pipelines" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> and CDK in GitLab CI pipelines</h3>
<p data-v-07b74c72 data-v-07b74c72>I like how <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> <code data-v-07b74c72 data-v-07b74c72>tail</code>s the output of CloudFormation events until the stack update finishes or fails. I previously had been using the AWS CLI to call <code data-v-07b74c72 data-v-07b74c72>aws cloudformation update-stack</code>. This command kicks off a stack update and the GitLab pipeline will succeed regardless of the success of failure of the <code data-v-07b74c72 data-v-07b74c72>update-stack</code> command.</p>
<blockquote data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>With CDK, the CI pipeline that calls <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> fails if <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> results in a stack rollback.</p>
</blockquote>
<p data-v-07b74c72 data-v-07b74c72>I couldn't find any examples of how to run <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> in a GitLab CI pipeline (using the Python version of CDK, or any version of CDK). It would be nice if there was an official image maintained for the different languages that are ready to run CDK deploy. Here's how I got <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> working correctly in my CI/CD pipline:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-yaml" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token key atrule" data-v-07b74c72 data-v-07b74c72>cdk deploy</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>image</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> docker<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>19.03.1
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>services</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> docker<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>19.03.5<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>dind
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>stage</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> deploy
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>only</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> master
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>variables</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>ENVIRONMENT</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> dev
    <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>DOCKER_TLS_CERTDIR</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>''</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>before_script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> apk add nodejs<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>current npm
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> npm i <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>g aws<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>cdk
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> apk add <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>no<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>cache python3
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> pip3 install <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>e awscdk
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> cdk bootstrap <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>app awscdk/app.py aws<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>//$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> cdk deploy <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>app awscdk/app.py <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>require<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>approval never
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>I have all of my CDK code in a top level directory called <code data-v-07b74c72 data-v-07b74c72>awscdk</code>, my Django code is in the top level <code data-v-07b74c72 data-v-07b74c72>backend</code> directory and my frontend code is in the top level <code data-v-07b74c72 data-v-07b74c72>quasar</code> directory. This directory structure is important, I'll come back to it shortly. Here are some things to note about this GitLab CI job definition:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>It uses the base <code data-v-07b74c72 data-v-07b74c72>docker</code> image with <code data-v-07b74c72 data-v-07b74c72>docker:dind</code> as a dependent service. This is necessary only if you hare using CDK constructs that build docker images and make use of <code data-v-07b74c72 data-v-07b74c72>cdk bootstrap</code>, such as the <code data-v-07b74c72 data-v-07b74c72>aws_ecs.AssetImage</code> that I use to define <code data-v-07b74c72 data-v-07b74c72>self.image</code> in the <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code> class that defines that main stack of my application.</p>
</li>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>It requires node, npm python and pip, so these all need to be installed via <code data-v-07b74c72 data-v-07b74c72>apk</code>, the package manager for Alpine Linux. These are done in the <code data-v-07b74c72 data-v-07b74c72>before_script</code>, the setup for the main "script" where <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> is called.</p>
</li>
<li data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>The main <code data-v-07b74c72 data-v-07b74c72>script</code> section calls <code data-v-07b74c72 data-v-07b74c72>cdk bootstrap</code>. You only need to call <code data-v-07b74c72 data-v-07b74c72>cdk bootstrap</code> once to initialize resources that CDK will use, so placing it here in my CI script is more of a reminder that we are using CDK assets (S3 buckets and ECR images); calling it again once it has been called initially on your AWS account does nothing, and you will see a message that communicates this:</p>
</li>
</ul>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72> $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION
  ‚è≥  Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...
  ‚úÖ  Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).
</code></pre></div>
<h3 id="cdk-bootstap" data-v-07b74c72 data-v-07b74c72><a href="#cdk-bootstap" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>cdk bootstap</code></h3>
<p data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>cdk bootstrap</code> is one of my favorite features of CDK. As I mentioned earlier, it is used with S3 and ECR.</p>
<h4 id="s3-assets" data-v-07b74c72 data-v-07b74c72><a href="#s3-assets" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>S3 Assets</h4>
<p data-v-07b74c72 data-v-07b74c72>With S3, it allows you to populate the contents of an S3 bucket. Here's an example from <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code>:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        <span class="token keyword" data-v-07b74c72 data-v-07b74c72>if</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>path<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>isdir<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"./quasar/dist/pwa"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
            s3_deployment<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>BucketDeployment<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                <span class="token string" data-v-07b74c72 data-v-07b74c72>"BucketDeployment"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                destination_bucket<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>static_site_bucket<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                sources<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>s3_deployment<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Source<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>asset<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"./quasar/dist/pwa"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                distribution<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>cloudfront<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>distribution<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>If the directory <code data-v-07b74c72 data-v-07b74c72>./quasar/dist/pwa</code> exists, CDK will upload the contents of that directory to the <code data-v-07b74c72 data-v-07b74c72>static_site_bucket</code> and then invalidate the cache for <code data-v-07b74c72 data-v-07b74c72>self.cloudfront.distribution</code>, all in one shot. <code data-v-07b74c72 data-v-07b74c72>./quasar/dist/pwa</code> is the directory where assets from my frontend PWA are placed when compiled. GitLab CI passes these files between the jobs using artifacts:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-yaml" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token key atrule" data-v-07b74c72 data-v-07b74c72>artifacts</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>paths</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> quasar/dist/pwa
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>The job to build PWA assets can be set to only run when there are changes in the <code data-v-07b74c72 data-v-07b74c72>quasar</code> directory, so the <code data-v-07b74c72 data-v-07b74c72>.quasar/dist/pwa</code> directory will only exist if the job is executed. This helps speed up our CI/CD pipeline.</p>
<h4 id="ecr-assets" data-v-07b74c72 data-v-07b74c72><a href="#ecr-assets" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>ECR Assets</h4>
<p data-v-07b74c72 data-v-07b74c72>I use <code data-v-07b74c72 data-v-07b74c72>cdk boostrap</code> and CDK assets in a similar way for building and pushing my application container. In <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code>, I define the following:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>image <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> ecs<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>AssetImage<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"./backend"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token builtin" data-v-07b74c72 data-v-07b74c72>file</span><span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"scripts/prod/Dockerfile"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> target<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"production"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>This image is then referenced by multiple <code data-v-07b74c72 data-v-07b74c72>NestedStack</code>s that define Fargate services and tasks (<code data-v-07b74c72 data-v-07b74c72>gunicorn</code>, <code data-v-07b74c72 data-v-07b74c72>daphne</code>, <code data-v-07b74c72 data-v-07b74c72>celery</code> workers, etc.) This keeps our CDK code DRY.. Don't Repeat Yourself! Similarly, we aren't rebuilding, pushing and pulling the backend container when there are no changes to the code in <code data-v-07b74c72 data-v-07b74c72>backend</code> directory.</p>
<p data-v-07b74c72 data-v-07b74c72>I'm not setting up an ECR image repository for my application, but I believe there is a way to do this. One question that I have about using <code data-v-07b74c72 data-v-07b74c72>ecs.AssetImage</code> is about image lifecycle management. I know that you can implement rules about how many images you want to keep in an ECR image repository, but <strong data-v-07b74c72 data-v-07b74c72>I'm not sure how this works with CDK Image Assets</strong>.</p>
<h3 id="quick-tour-of-applicationstack" data-v-07b74c72 data-v-07b74c72><a href="#quick-tour-of-applicationstack" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Quick tour of <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code></h3>
<p data-v-07b74c72 data-v-07b74c72>Here's a very quick look at the structure of my CDK code, focusing on the <code data-v-07b74c72 data-v-07b74c72>ApplicationStack</code>, the "master stack" or "skeleton stack" that contains.</p>
<h4 id="hosted_zone" data-v-07b74c72 data-v-07b74c72><a href="#hosted_zone" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>hosted_zone</code></h4>
<p data-v-07b74c72 data-v-07b74c72>We get the hosted zone using the <code data-v-07b74c72 data-v-07b74c72>DOMAIN_NAME</code> and <code data-v-07b74c72 data-v-07b74c72>HOSTED_ZONE_ID</code>. This is not a nested stack.</p>
<h4 id="site_certificate" data-v-07b74c72 data-v-07b74c72><a href="#site_certificate" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>site_certificate</code></h4>
<p data-v-07b74c72 data-v-07b74c72>The ACM Certificate that will be used for the given environment. This references the <code data-v-07b74c72 data-v-07b74c72>full_domain_name</code> (environment + application).</p>
<h4 id="vpc_stack" data-v-07b74c72 data-v-07b74c72><a href="#vpc_stack" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>vpc_stack</code></h4>
<p data-v-07b74c72 data-v-07b74c72>A <code data-v-07b74c72 data-v-07b74c72>NestedStack</code> for defining VPC resources. This construct generates lots of CloudFormation resources. I currently have <code data-v-07b74c72 data-v-07b74c72>nat_gateways</code> set to zero, and I'm <code data-v-07b74c72 data-v-07b74c72>PUBLIC</code> and <code data-v-07b74c72 data-v-07b74c72>PRIVATE</code> subnets spread over 2 AZs. As I mentioned earlier, this is primarily for cost considerations and it is a best practice to use the tiered security model and run our Fargate tasks in private subnets instead of public subnets. I think I need to add NACL resources in this <code data-v-07b74c72 data-v-07b74c72>NestedStack</code>.</p>
<h4 id="alb_stack" data-v-07b74c72 data-v-07b74c72><a href="#alb_stack" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>alb_stack</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This defines the load balancer, configures that will send traffic to our Fargate services (such as our Django API). I was a little bit unclear about needing a <code data-v-07b74c72 data-v-07b74c72>listener</code> and <code data-v-07b74c72 data-v-07b74c72>https_listener</code>. I might be able to get away with removing the <code data-v-07b74c72 data-v-07b74c72>listener</code> and only using <code data-v-07b74c72 data-v-07b74c72>https_listener</code>.</p>
<h4 id="static_site_stack" data-v-07b74c72 data-v-07b74c72><a href="#static_site_stack" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>static_site_stack</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This stack defines the S3 bucket and policies that will be used for hosting our static site (Quasar PWA).</p>
<h4 id="backend_assets" data-v-07b74c72 data-v-07b74c72><a href="#backend_assets" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>backend_assets</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This stack defines the bucket and policies for managing the bucket that holds static and media assets for Django.</p>
<h4 id="cloudfront" data-v-07b74c72 data-v-07b74c72><a href="#cloudfront" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>cloudfront</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This defines the CloudFront distribution that ties together several different parts of the application. It is the "front desk" of the application, and acts as a CDN and proxy. There is a separate CloudFront distribution for each environment (dev, staging, production). This stack also defines the Route53 <code data-v-07b74c72 data-v-07b74c72>ARecord</code> that will be used to send traffic to a specific subdomain to the correct CloudFront distribution.</p>
<p data-v-07b74c72 data-v-07b74c72>There are three <code data-v-07b74c72 data-v-07b74c72>origin_configs</code> for each distribution:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>CustomOriginConfig</code> for the ALB</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>CustomOriginConfig</code> for the S3 bucket website</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>S3OriginConfig</code> for the Django static assets</li>
</ol>
<p data-v-07b74c72 data-v-07b74c72>Note that these <code data-v-07b74c72 data-v-07b74c72>origin_configs</code> each have different <code data-v-07b74c72 data-v-07b74c72>behaviors</code>, and that list comprehension is used to keep this code DRY.</p>
<h4 id="bucketdeployment" data-v-07b74c72 data-v-07b74c72><a href="#bucketdeployment" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>BucketDeployment</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This will deploy our static site assets to the S3 bucket defined in <code data-v-07b74c72 data-v-07b74c72>static_site_stack</code> if the static site assets are present at the time of deployment. If they are not present, this means that there were no changes made to the frontend site.</p>
<h4 id="ecs" data-v-07b74c72 data-v-07b74c72><a href="#ecs" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>ecs</code></h4>
<p data-v-07b74c72 data-v-07b74c72>Defines the ECS Cluster.</p>
<h4 id="rds" data-v-07b74c72 data-v-07b74c72><a href="#rds" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>rds</code></h4>
<p data-v-07b74c72 data-v-07b74c72>There is no L2 construct for <code data-v-07b74c72 data-v-07b74c72>DBCluster</code>, so I used <code data-v-07b74c72 data-v-07b74c72>CfnDBCluster</code> in order to use the Aurora Postgres <code data-v-07b74c72 data-v-07b74c72>engine</code> and the <code data-v-07b74c72 data-v-07b74c72>serverless</code> <code data-v-07b74c72 data-v-07b74c72>engine_mode</code>.</p>
<h4 id="elasticache" data-v-07b74c72 data-v-07b74c72><a href="#elasticache" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>elasticache</code></h4>
<p data-v-07b74c72 data-v-07b74c72>I also had to use L1 constructs for ElastiCache, but this one is pretty straightforward.</p>
<p data-v-07b74c72 data-v-07b74c72>For both RDS and ElastiCache I used the <code data-v-07b74c72 data-v-07b74c72>vpc_default_security_group</code> as the <code data-v-07b74c72 data-v-07b74c72>source_security_group</code>. It might be a better idea to define another security group altogether, but this approach works.</p>
<h4 id="assetimage" data-v-07b74c72 data-v-07b74c72><a href="#assetimage" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>AssetImage</code></h4>
<p data-v-07b74c72 data-v-07b74c72>The docker image that references Django application code in the <code data-v-07b74c72 data-v-07b74c72>backend</code> directory. This image is referenced in Fargate services and tasks.</p>
<h4 id="variables" data-v-07b74c72 data-v-07b74c72><a href="#variables" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>variables</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This section defines and organizes all of the environment variables and secrets for my application.</p>
<h4 id="backend_service" data-v-07b74c72 data-v-07b74c72><a href="#backend_service" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>backend_service</code></h4>
<p data-v-07b74c72 data-v-07b74c72>It might be a better idea to replace this with <code data-v-07b74c72 data-v-07b74c72>NetworkLoadBalancedFargateService</code>, but instead I implemented this with lower-level constructs just to be clear about what I'm doing. To add a load balanced service, here is what I did:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Define the Fargate task</li>
<li data-v-07b74c72 data-v-07b74c72>Add the container to this task with other information (secrets, logging, <code data-v-07b74c72 data-v-07b74c72>command</code>, etc.)</li>
<li data-v-07b74c72 data-v-07b74c72>Give the task role permissions it needs such as access to Secrets, S3 permissions. (It might be a good idea to refactor this into a function that can be called on <code data-v-07b74c72 data-v-07b74c72>task_role</code>, but for now I am explicitly granting all permissions)</li>
<li data-v-07b74c72 data-v-07b74c72>Create and add a port mapping</li>
<li data-v-07b74c72 data-v-07b74c72>Define an ECS Fargate Service that reference the previously defined Fargate task, configure security group</li>
<li data-v-07b74c72 data-v-07b74c72>Add the service as a target to the <code data-v-07b74c72 data-v-07b74c72>https_listener</code> defined previously in <code data-v-07b74c72 data-v-07b74c72>alb_stack</code>.</li>
<li data-v-07b74c72 data-v-07b74c72>Optionally configure autoscaling for the Fargate service</li>
</ol>
<h4 id="flower_service" data-v-07b74c72 data-v-07b74c72><a href="#flower_service" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>flower_service</code></h4>
<p data-v-07b74c72 data-v-07b74c72>Flower is a monitoring utility for Celery. I had trouble getting this to work correctly, but I managed to make it work by adding a simple nginx container that passes traffic to the flower container running in the same task. <a href="https://flower.readthedocs.io/en/latest/reverse-proxy.html" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://flower.readthedocs.io/en/latest/reverse-proxy.html</a></p>
<h4 id="celery_default_service" data-v-07b74c72 data-v-07b74c72><a href="#celery_default_service" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>celery_default_service</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This stack defines the default celery queue. This is discussed later in more detail, but the basic idea is to:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Define the Fargate task</li>
<li data-v-07b74c72 data-v-07b74c72>Add the container</li>
<li data-v-07b74c72 data-v-07b74c72>Define the Fargate service</li>
<li data-v-07b74c72 data-v-07b74c72>Grant permissions</li>
<li data-v-07b74c72 data-v-07b74c72>Configure autoscaling</li>
</ol>
<h4 id="celery_autoscaling" data-v-07b74c72 data-v-07b74c72><a href="#celery_autoscaling" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>celery_autoscaling</code></h4>
<p data-v-07b74c72 data-v-07b74c72>This stack defines the Lambda function and schedule on which this Lambda is called. This stack is discussed in more detail later on.</p>
<h4 id="backend_tasks" data-v-07b74c72 data-v-07b74c72><a href="#backend_tasks" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a><code data-v-07b74c72 data-v-07b74c72>backend_tasks</code></h4>
<p data-v-07b74c72 data-v-07b74c72>These are administrative tasks that are executed by running manual GitLab CI jobs such as <code data-v-07b74c72 data-v-07b74c72>migrate</code>, <code data-v-07b74c72 data-v-07b74c72>collectstatic</code> and <code data-v-07b74c72 data-v-07b74c72>createsuperuser</code>.</p>
<h2 id="why-x-why-not-y" data-v-07b74c72 data-v-07b74c72><a href="#why-x-why-not-y" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why <code data-v-07b74c72 data-v-07b74c72>X</code>? Why not <code data-v-07b74c72 data-v-07b74c72>Y</code>?</h2>
<p data-v-07b74c72 data-v-07b74c72>This section will compare some of the technology choices I have made in this project to other popular alternatives.</p>
<h3 id="why-ecs-why-not-kubernetes" data-v-07b74c72 data-v-07b74c72><a href="#why-ecs-why-not-kubernetes" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why ECS? Why not Kubernetes?</h3>
<p data-v-07b74c72 data-v-07b74c72>I like Kubernetes. I have never used it to support production workloads, but I have explored it in a limited capacity. I have set up this project in Kubernetes locally using <code data-v-07b74c72 data-v-07b74c72>minikube</code>, there is an article on this in the documentation. There are also lots of options for how you do Kubernetes, here are a few off of the top of my head:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>KOPS</li>
<li data-v-07b74c72 data-v-07b74c72>EKS</li>
<li data-v-07b74c72 data-v-07b74c72>k3s</li>
<li data-v-07b74c72 data-v-07b74c72>cdk8s</li>
<li data-v-07b74c72 data-v-07b74c72>Kubernetes on Fargate</li>
<li data-v-07b74c72 data-v-07b74c72>"Kuberetes the Hard Way"</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>With any of these options you are probably going to want to use Helm to do deployments, which adds another layer of abstraction that also has several different ways to be managed. On the other hand, ECS is "just ECS"; there are not a lot of other considerations to make when running workloads in ECS. You have to choose between the two available launch types: EC2 and Fargate. Comparisons of ECS and Kubernetes often mention that ECS integrates nicely with other AWS Services, something I have generally found to be true in setting up this project. Granting permissions to S3 buckets or CloudWatch, or using security groups to give ECS tasks access to certain resources in your VPC are some examples of what this "tight integration" has meant for me so far.</p>
<h3 id="why-django-why-not-flask" data-v-07b74c72 data-v-07b74c72><a href="#why-django-why-not-flask" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why Django? Why not Flask?</h3>
<p data-v-07b74c72 data-v-07b74c72>I like Django for lots of reasons. I get why people say it can be "overkill", and there are definitely lots of parts of Django that don't use. I use Django primarily for the ORM, migrations system and the Django Admin. I also use the Django REST Framework, which gives me another big productivity boost when building APIs. I dislike Django Forms and Django templates, but that wasn't always the case. Before that, I disliked JavaScript frameworks and single page applications. That changes when I started working with Vue.js and Quasar.</p>
<h3 id="why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react" data-v-07b74c72 data-v-07b74c72><a href="#why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?</h3>
<p data-v-07b74c72 data-v-07b74c72>Quasar Framework is a few different things, and just like Vue.js itself, Quasar can be incrementally adopted. Primarily, Quasar is a CLI for creating Vue.js projects. It offers some opinions on how to organize files and folders. It handles SPA, PWA, SSR, Electron, Cordova and other build targets. It implements the MaterialUI spec and it has an awesome and active community (but Django, GitLab and AWS do, too!)</p>
<p data-v-07b74c72 data-v-07b74c72>Quasar does things a little bit differently than vanilla Vue.js. There is no <code data-v-07b74c72 data-v-07b74c72>main.js</code> file in a typical Quasar application. Instead, bootfiles are used to initialize things that would typically go into <code data-v-07b74c72 data-v-07b74c72>main.js</code>. I believe this helps Quasar manage multiple build targets easily.</p>
<p data-v-07b74c72 data-v-07b74c72>I really haven't worked a lot with Nuxt.js, but I would probably be drawn to it if Quasar was not an option. I like how it helps structure your application. In the same way that Django is "batteries included", Quasar is also very much "batteries included".</p>
<p data-v-07b74c72 data-v-07b74c72>I think React is neat, but I have similar feelings between React and Vue that I have between Django and Flask. One requires you make more decisions and therefore has a heavy mental load. The biggest example of this is the tight integration of an official router and state management system for Vue (<code data-v-07b74c72 data-v-07b74c72>vue-router</code> and <code data-v-07b74c72 data-v-07b74c72>vuex</code>).</p>
<h3 id="why-celery-why-not-heuy-or-django-rq" data-v-07b74c72 data-v-07b74c72><a href="#why-celery-why-not-heuy-or-django-rq" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why Celery? Why not Heuy or django-rq?</h3>
<p data-v-07b74c72 data-v-07b74c72>I think celery is probably the most heavy-weight option for managing asynchronous tasks in Django. It is very flexible and "pluggable" which makes it slightly more challenging to get setup. I would be interested in trying another option, but celery is a mature option that has a large community of users.</p>
<h2 id="scaling-celery-workers-to-zero" data-v-07b74c72 data-v-07b74c72><a href="#scaling-celery-workers-to-zero" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Scaling Celery workers to zero</h2>
<p data-v-07b74c72 data-v-07b74c72>Django is used in a few different ways in this application:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>a backend API supported by Django REST Framework, Postgres and static files stored in AWS S3, served over CloudFront</li>
<li data-v-07b74c72 data-v-07b74c72>a websocket server supported by Django Channels</li>
<li data-v-07b74c72 data-v-07b74c72>an administrative backend that is automatically generated by Django (Django Admin)</li>
<li data-v-07b74c72 data-v-07b74c72>asynchronous task workers supported by Celery</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>The API server, websocket server and Django admin can technically be served by the same <code data-v-07b74c72 data-v-07b74c72>daphne</code> process. In terms of our application and AWS architecture, this means that requests for URLs starting with <code data-v-07b74c72 data-v-07b74c72>/api/</code>, <code data-v-07b74c72 data-v-07b74c72>/ws/</code> and <code data-v-07b74c72 data-v-07b74c72>/admin/</code> can all be sent to the same Fargate service target group.</p>
<p data-v-07b74c72 data-v-07b74c72>Alternatively, we could split these up into two or three different process that can then be scaled individually.</p>
<p data-v-07b74c72 data-v-07b74c72>Celery processes should be run as separate processes. If you have multiple queues, you may have workers that are dedicated to processing tasks from certain queues which run as individual Fargate tasks, each with certain CPU and memory allocations and other celery settings, such as <code data-v-07b74c72 data-v-07b74c72>max_concurrency</code>.</p>
<p data-v-07b74c72 data-v-07b74c72>To manage the total cost of ownership, I wanted to know how to scale Celery workers between 0 and <code data-v-07b74c72 data-v-07b74c72>N</code>. A celery worker is typically an "always on" process that watches for new messages that arrive in the queue and then processes message specified (the messages delivered to the queue contain information on which function to call, and what arguments that function should be called with.</p>
<p data-v-07b74c72 data-v-07b74c72>Let's image that we have a celery task to process with the following properties:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>It takes a long time to process (between 15 minutes and 1 or 2 hours)</li>
<li data-v-07b74c72 data-v-07b74c72>It has lots of dependencies (such as pandas, scikit-learn, etc.)</li>
<li data-v-07b74c72 data-v-07b74c72>It requires a high amount of CPU and memory</li>
<li data-v-07b74c72 data-v-07b74c72>It cannot easily be broken down into smaller sub-tasks</li>
<li data-v-07b74c72 data-v-07b74c72>The time and frequency at which this task will be called is not predictable</li>
<li data-v-07b74c72 data-v-07b74c72>A 2 - 3 minute delay between calling the task and starting work on the task is acceptable</li>
<li data-v-07b74c72 data-v-07b74c72>This task might not be very easy to process with AWS Lambda without lots of additional logic, if not impossible.</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>To manage our project's TCO, we want scale down the number of Fargate tasks that process the queue this task is sent to. If there are no messages queued for this worker and no messages currently being processed by any of the workers for the queue, the number of Fargate tasks (celery workers) should be scaled down.</p>
<p data-v-07b74c72 data-v-07b74c72>I haven't done much with autoscaling on AWS before, but I found that CDK provides some very nice abstractions that make scaling with Fargate task very straightforward.</p>
<p data-v-07b74c72 data-v-07b74c72>ECS allows you to scale based on some built in metrics, such as CPU Utilization. Scaling between 0 and <code data-v-07b74c72 data-v-07b74c72>N</code> workers based on CPU utilization metrics wouldn't work because there would be no CPU utilization after the Fargate tasks are scaled to zero; messages in the queue would remain unprocessed and no new workers would be brought online.</p>
<p data-v-07b74c72 data-v-07b74c72>Using the number of tasks in the queue would be a better option. I tried a few different options to get this to work.</p>
<p data-v-07b74c72 data-v-07b74c72>First, I tried using one of the high-level constructs (L3 construct) from <code data-v-07b74c72 data-v-07b74c72>ecs_patterns</code> called <code data-v-07b74c72 data-v-07b74c72>QueueProcessingFargateService</code>, but this would require that I replace Redis with SQS as the broker to be used with Celery. Some people prefer to use SQS, but I like having the ability to inspect and control, which requires a broker like Redis and is not possible with SQS.</p>
<p data-v-07b74c72 data-v-07b74c72>My current solution involves:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Creating a CloudWatch metric (the namespace is <code data-v-07b74c72 data-v-07b74c72>FULL_APP_NAME</code> and the metric name is the name of the queue, <code data-v-07b74c72 data-v-07b74c72>default</code>)</li>
<li data-v-07b74c72 data-v-07b74c72>Calling <code data-v-07b74c72 data-v-07b74c72>auto_scale_task_count</code> on the Fargate service to create a an "autoscaling Fargate task"</li>
<li data-v-07b74c72 data-v-07b74c72>Calling <code data-v-07b74c72 data-v-07b74c72>scale_on_metric</code> on the "autoscaling Fargate task" with the CloudWatch metric created in <code data-v-07b74c72 data-v-07b74c72>1</code></li>
<li data-v-07b74c72 data-v-07b74c72>Setting up a <code data-v-07b74c72 data-v-07b74c72>celery-metrics</code> API endpoint on my Django API server that, when <code data-v-07b74c72 data-v-07b74c72>POST</code>ed to, collects celery metrics per queue and publishes these metrics to CloudWatch.</li>
<li data-v-07b74c72 data-v-07b74c72>Scheduling a Lambda function to post to the <code data-v-07b74c72 data-v-07b74c72>celery-metrics</code> endpoint every 5 minutes.</li>
</ol>
<p data-v-07b74c72 data-v-07b74c72>Here's the code that takes care of steps 1, 2 and 3:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>default_celery_queue_cw_metric <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> cw<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Metric<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            namespace<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> metric_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"default"</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>celery_default_queue_asg <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>celery_default_worker_service<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>auto_scale_task_count<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            min_capacity<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>0</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> max_capacity<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>2</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>celery_default_queue_asg<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>scale_on_metric<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"CeleryDefaultQueueAutoscaling"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            metric<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>default_celery_queue_cw_metric<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            scaling_steps<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>
                aas<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>ScalingInterval<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>change<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token operator" data-v-07b74c72 data-v-07b74c72>-</span><span class="token number" data-v-07b74c72 data-v-07b74c72>1</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> lower<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>0</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                aas<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>ScalingInterval<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>change<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>1</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> lower<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>1</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            adjustment_type<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>aas<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>AdjustmentType<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>CHANGE_IN_CAPACITY<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Step 4 inspects active and reserved tasks, filters the tasks by the <code data-v-07b74c72 data-v-07b74c72>routing_key</code> (which is the same as the queue name) and the combines this with any queued tasks by calling <code data-v-07b74c72 data-v-07b74c72>llen(queue_name)</code>. Finally, the queue names and combined active, reserved and queued task totals are sent to CloudWatch via boto3. The code for this is in <code data-v-07b74c72 data-v-07b74c72>backend/apps/core/utils/celery_utils.py</code>.</p>
<p data-v-07b74c72 data-v-07b74c72>Here's the code for the Lambda function in step 5:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> json
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> os
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> urllib<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>request

FULL_DOMAIN_NAME <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"FULL_DOMAIN_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
CELERY_METRICS_PATH <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"api/celery-metrics/"</span>

CELERY_METRICS_URL <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"https://</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>FULL_DOMAIN_NAME<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>/</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>CELERY_METRICS_PATH<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>"</span></span>
CELERY_METRICS_TOKEN <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"CELERY_METRICS_TOKEN"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>


<span class="token keyword" data-v-07b74c72 data-v-07b74c72>def</span> <span class="token function" data-v-07b74c72 data-v-07b74c72>lambda_handler</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> context<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    data <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"celery_metrics_token"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> CELERY_METRICS_TOKEN<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span>
    params <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> json<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>dumps<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>data<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>encode<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'utf8'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
    req <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> urllib<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>request<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Request<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
        CELERY_METRICS_URL<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        data<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>params<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        headers<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'content-type'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>'application/json'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
    response <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> urllib<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>request<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>urlopen<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>req<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>return</span> response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>read<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Finally, here is the code for defining the lambda function and scheduled invocation of the lambda function:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-python" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token keyword" data-v-07b74c72 data-v-07b74c72>class</span> <span class="token class-name" data-v-07b74c72 data-v-07b74c72>CeleryAutoscalingStack</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>cloudformation<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>NestedStack<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>def</span> <span class="token function" data-v-07b74c72 data-v-07b74c72>__init__</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Construct<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token builtin" data-v-07b74c72 data-v-07b74c72>id</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token builtin" data-v-07b74c72 data-v-07b74c72>str</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token operator" data-v-07b74c72 data-v-07b74c72>**</span>kwargs<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span> <span class="token operator" data-v-07b74c72 data-v-07b74c72>-</span><span class="token operator" data-v-07b74c72 data-v-07b74c72>></span> <span class="token boolean" data-v-07b74c72 data-v-07b74c72>None</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
        <span class="token builtin" data-v-07b74c72 data-v-07b74c72>super</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>__init__<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token builtin" data-v-07b74c72 data-v-07b74c72>id</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token operator" data-v-07b74c72 data-v-07b74c72>**</span>kwargs<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>lambda_function <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> aws_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Function<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"CeleryMetricsLambdaFunction"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            code<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>aws_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Code<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>asset<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"awslambda"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            handler<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"publish_celery_metrics.lambda_handler"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            runtime<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>aws_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Runtime<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>PYTHON_3_7<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            environment<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>variables<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>regular_variables<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>celery_default_cw_metric_schedule <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> events<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Rule<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"CeleryDefaultCWMetricSchedule"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            schedule<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>events<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Schedule<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>rate<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Duration<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>minutes<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token number" data-v-07b74c72 data-v-07b74c72>5</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            targets<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>
                events_targets<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>LambdaFunction<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>handler<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>lambda_function<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        <span class="token comment" data-v-07b74c72 data-v-07b74c72># TODO: refactor this to loop through CloudWatch metrics multiple celery queues</span>
        scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>celery_default_service<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>default_celery_queue_cw_metric<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>grant_put_metric_data<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>backend_service<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>backend_task<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>task_role
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<h2 id="miscellaneous-grievances" data-v-07b74c72 data-v-07b74c72><a href="#miscellaneous-grievances" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Miscellaneous Grievances</h2>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Fargate tasks cannot access Secrets that use JSON template</li>
<li data-v-07b74c72 data-v-07b74c72>You cannot select <code data-v-07b74c72 data-v-07b74c72>FARGATE_SPOT</code> on a CDK-created ECS cluster. This option seems to only be available from the ECS Wizard in the AWS Console</li>
<li data-v-07b74c72 data-v-07b74c72>It's not super clear how to package dependencies in Lambda with CDK. Here's an interesting approach that I would like to try: <a href="https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487</a>. The Lambda functions I'm using don't require anything outside of the standard library, but if they did it would require some additional work to make sure dependencies can be added as Lambda Layers.</li>
</ul>
<h2 id="todo" data-v-07b74c72 data-v-07b74c72><a href="#todo" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>TODO</h2>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Create an IAM role template that can be used to create an IAM role that has access to setup infrastructure through CDK. Currently I'm using an admin account which is not a best practice.</li>
<li data-v-07b74c72 data-v-07b74c72>Move this Wiki Article to the project documentation site and main README</li>
<li data-v-07b74c72 data-v-07b74c72>Expand on each topic, replace existing documentation</li>
<li data-v-07b74c72 data-v-07b74c72>Add a summary of each <code data-v-07b74c72 data-v-07b74c72>NestedStack</code> from CDK code</li>
</ul></div> <div class="text-center pb-4 pt-8" data-v-07b74c72><button class="mc-btn rounded py-1 px-2" data-v-07b74c72>
        Show Disqus Comments üí¨
      </button></div> <!----> <h1 data-v-07b74c72></h1></div></article> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-7b3a3fe4><hr class="mt-4" data-v-7b3a3fe4> <div class="mx-auto py-4" data-v-7b3a3fe4><div class="pb-4" data-v-7b3a3fe4>
      Join my mailing list to get updated whenever I publish a new article.
    </div> <div class="mx-auto" data-v-570a300a data-v-7b3a3fe4><div id="mc_embed_signup" class="w-full md:w-1/2 justify-center" data-v-570a300a><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-570a300a><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4" data-v-570a300a><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Enter your email address" class="rounded mc text-center" data-v-570a300a> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-570a300a><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-570a300a></div> <div class="text-left" data-v-570a300a><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="Subscribe" class="mc-btn rounded px-2 py-1" data-v-570a300a></div></div></form></div></div></div> <hr data-v-7b3a3fe4> <div class="py-4" data-v-7b3a3fe4>
    Thanks for checking out my site!
  </div> <div class="pb-4" data-v-7b3a3fe4>
    ¬© 2023 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1690292322/2020/06/02/django-postgres-vue-gitlab-ecs.html/state.js"></script><script src="/_nuxt/e85cdba.js" defer></script><script src="/_nuxt/64dda2d.js" defer></script><script src="/_nuxt/9ee0ef6.js" defer></script><script src="/_nuxt/f51c3d4.js" defer></script><script src="/_nuxt/279b353.js" defer></script>
  </body>
</html>
