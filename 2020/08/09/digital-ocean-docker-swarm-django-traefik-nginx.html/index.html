<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="og:title" content="Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray"><meta data-n-head="ssr" property="og:description" content="undefined"><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/shark.jpg"><meta data-n-head="ssr" property="twitter:card" content="https://briancaffey.github.io/static/shark.jpg"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><script data-n-head="ssr" data-hid="adsbygoogle-script" defer crossorigin="anonymous" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4924597640144289"></script><script data-n-head="ssr" data-hid="adsbygoogle">window.__abg_called||((adsbygoogle=window.adsbygoogle||[]).pauseAdRequests=0,(window.adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4924597640144289",enable_page_level_ads:!1,overlays:{bottom:!1}}),window.__abg_called=!0)</script><link rel="preload" href="/_nuxt/e9c2366.js" as="script"><link rel="preload" href="/_nuxt/9ee0ef6.js" as="script"><link rel="preload" href="/_nuxt/f51c3d4.js" as="script"><link rel="preload" href="/_nuxt/0f451e7.js" as="script"><link rel="preload" href="/_nuxt/b5afa39.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 5a4b6265:0 14b1eaf9:0 a0fa61ae:0 7f6c3ed0:0 64516d8e:0 5586ddaf:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-8{grid-gap:2rem;gap:2rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 5px 10px 0 #0e2233;box-shadow:0 5px 10px 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 10px 40px 0 #0e2233;box-shadow:0 10px 40px 0 var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-style:italic}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{content:" ";margin-top:-85px;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-3f691362]{padding:0}.selected[data-v-3f691362]{text-shadow:.25px 0 0 #000}.picker[data-v-3f691362]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-3f691362]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-107ae01e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-4f7c5820]{padding:0}.modal[data-v-4f7c5820]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-4f7c5820],.picker[data-v-4f7c5820]{position:absolute;left:0}.picker[data-v-4f7c5820]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.cover-image[data-v-4b9599ea]{transition:transform .2s}.cover-image[data-v-4b9599ea]:hover{transform:scale(1.025)}.tag[data-v-3fbcd028]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-3fbcd028]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1672798569/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html/state.js" as="script"><link rel="preload" href="/_nuxt/static/1672798569/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1672798569/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-3f691362><div class="top" data-v-3f691362></div> <div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-3f691362><div class="justify-left flex-grow flex-cols-4" data-v-3f691362><a href="/" class="text-xl nuxt-link-active" data-v-3f691362><span class="hidden sm:inline text-2xl" data-v-3f691362>Brian Caffey</span><span class="inline sm:hidden" data-v-3f691362>JBC</span></a></div> <div class="flex-grow relative" data-v-3f691362><nav z-index="10000" data-v-107ae01e data-v-3f691362><div data-v-107ae01e><ul class="items-right float-right hidden md:flex" data-v-107ae01e><li class="px-4 text-lg" data-v-107ae01e><a href="/blog/1" data-v-107ae01e>
          Blog
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/projects" data-v-107ae01e>
          Projects
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/contact" data-v-107ae01e>
          Contact
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-107ae01e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-107ae01e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-107ae01e><title data-v-107ae01e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-107ae01e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-3f691362><div class="centered" data-v-288717a6 data-v-3f691362><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üñ•Ô∏è, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåû, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåö, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="‚òï, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-4f7c5820 data-v-288717a6><!----> <ul data-v-4f7c5820><li class="md:px-1 px-1 cursor-pointer" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-4f7c5820><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-4f7c5820><a href="/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-4f7c5820></a><a href="/fr/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" data-v-4f7c5820><span aria-label="üá´üá∑, fr, flag-fr" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Fran√ßais <br data-v-4f7c5820></a><a href="/zh/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" data-v-4f7c5820><span aria-label="üá®üá≥, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> ÁÆÄ‰Ωì‰∏≠Êñá <br data-v-4f7c5820></a><a href="/ru/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" data-v-4f7c5820><span aria-label="üá∑üá∫, ru, flag-ru" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> –†—É—Å—Å–∫–∏–π <br data-v-4f7c5820></a><a href="/jp/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" data-v-4f7c5820><span aria-label="üáØüáµ, jp, flag-jp" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> Êó•Êú¨Ë™û <br data-v-4f7c5820></a><a href="/in/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html" data-v-4f7c5820><span aria-label="üáÆüá≥, flag-in" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> ‡§π‡§ø‡§Ç‡§¶‡•Ä <br data-v-4f7c5820></a></div></div></div></li></ul></div></div></div></div> <article data-v-4b9599ea><img src="/static/shark.jpg" class="pt-2 h-64 w-full object-cover cover-image" data-v-4b9599ea> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-4b9599ea><h1 class="prose text-3xl leading-9" data-v-4b9599ea>
      Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-4b9599ea><a href="/blog/tags/django" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    django üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/docker" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    docker üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/digital-ocean" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    digital-ocean üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/vue" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    vue üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/gitlab" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    gitlab üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/rex-ray" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    rex-ray üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/traefik" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    traefik üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/nginx" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    nginx üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/swarm" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    swarm üè∑Ô∏è
    <!----></div></a></div> <!----> <p class="blog-date text-gray-500 mb-4" data-v-4b9599ea>
      Last Updated on
      August 9, 2020
    </p> <!----> <div class="markdown nuxt-content" data-v-4b9599ea data-v-4b9599ea><p data-v-4b9599ea data-v-4b9599ea>I recently wrote two articles about deploying Django applications to AWS serverless environments: one on <a href="https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>AWS Fargate</a> (CloudFront, ALB and ECS Fargate containers) and one on <a href="https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>AWS Lambda</a> (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of <a href="https://aws.amazon.com/cdk/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>AWS Cloud Development Kit (CDK)</a>, an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to "just use a VPS" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!</p>
<p data-v-4b9599ea data-v-4b9599ea>In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets).</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>Here's a link to my project that I'll be referencing: <a href="https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik</a>.</p>
<p data-v-4b9599ea data-v-4b9599ea>The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article.</p>
<h2 id="overview" data-v-4b9599ea data-v-4b9599ea><a href="#overview" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Overview</h2>
<p data-v-4b9599ea data-v-4b9599ea>Here are some of the key parts of the project that I'll go over:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>DigitalOcean and GitLab setup</li>
<li data-v-4b9599ea data-v-4b9599ea>Creating an A Record that points to our Droplet IP</li>
<li data-v-4b9599ea data-v-4b9599ea>Using a prebuilt VM image that ships with docker and docker-compose</li>
<li data-v-4b9599ea data-v-4b9599ea>Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes</li>
<li data-v-4b9599ea data-v-4b9599ea>Setting up a docker swarm cluster</li>
<li data-v-4b9599ea data-v-4b9599ea>Setting up a <code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code> file to build images and push them to a private GitLab CI project registry</li>
<li data-v-4b9599ea data-v-4b9599ea>Writing a docker-compose file to configure the services (containers) that will support the application</li>
<li data-v-4b9599ea data-v-4b9599ea>Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH</li>
<li data-v-4b9599ea data-v-4b9599ea>Django project settings and management commands for our Postgres database and static files</li>
<li data-v-4b9599ea data-v-4b9599ea>Monitoring, logging and debugging</li>
<li data-v-4b9599ea data-v-4b9599ea>Destroying the environment + cleanup</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Before I dig into all of this, I recommend that you check out <a href="https://mattsegal.dev/django-prod-architectures.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this article about Django production architectures by Matt Segal</a>. This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. <a href="https://mattsegal.dev" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>mattsegal.dev</a> has lots of good content related to Django, I also recommend checking out <a href="https://mattsegal.dev/nginx-django-reverse-proxy-config.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this article about how NGINX is used with Django</a>. Thanks for the great resources, Matt!</p>
<h2 id="digitalocean-setup" data-v-4b9599ea data-v-4b9599ea><a href="#digitalocean-setup" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>DigitalOcean setup</h2>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>Sign up for a new DigitalOcean account if you don't already have one</li>
<li data-v-4b9599ea data-v-4b9599ea>Create a DigitalOcean project <a href="https://cloud.digitalocean.com/projects/new" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://cloud.digitalocean.com/projects/new</a></li>
<li data-v-4b9599ea data-v-4b9599ea>Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) <a href="https://cloud.digitalocean.com/account/api/tokens" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://cloud.digitalocean.com/account/api/tokens</a></li>
<li data-v-4b9599ea data-v-4b9599ea>Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see <a href="https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this article</a> for more information)</li>
</ul>
<h2 id="prebuilt-docker-vm-image" data-v-4b9599ea data-v-4b9599ea><a href="#prebuilt-docker-vm-image" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Prebuilt Docker VM image</h2>
<p data-v-4b9599ea data-v-4b9599ea>From the <a href="https://cloud.digitalocean.com/droplets/new" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>Create Droplets</a> page, select <code data-v-4b9599ea data-v-4b9599ea>Marketplace</code> and search for <code data-v-4b9599ea data-v-4b9599ea>docker</code>. Select the <code data-v-4b9599ea data-v-4b9599ea>Docker 5:19.03.1~3 18.04</code> image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed.</p>
<p data-v-4b9599ea data-v-4b9599ea>Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options.</p>
<p data-v-4b9599ea data-v-4b9599ea>For Authentication, select the SSH key that you created earlier.</p>
<p data-v-4b9599ea data-v-4b9599ea>Take note of the Droplet's IP address; we will use this in the next step.</p>
<h2 id="gitlab-setup" data-v-4b9599ea data-v-4b9599ea><a href="#gitlab-setup" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>GitLab setup</h2>
<p data-v-4b9599ea data-v-4b9599ea>Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to <code data-v-4b9599ea data-v-4b9599ea>Settings > CI/CD > Variables</code> in your GitLab project and add the following environment variables:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>SSH_PRIVATE_KEY</code>: the value should start with <code data-v-4b9599ea data-v-4b9599ea>-----BEGIN RSA PRIVATE KEY-----</code> and end with <code data-v-4b9599ea data-v-4b9599ea>-----END RSA PRIVATE KEY-----</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DROPLET_IP</code>: the IP address of the droplet you just created</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>POSTGRES_PASSWORD</code>: a secure password that we will use for our Postgres database (we will share this with our Django application later on)</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>SECRET_KEY</code>: a random secret key to use for our Django application.</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DEBUG</code>: the number <code data-v-4b9599ea data-v-4b9599ea>0</code></li>
</ul>
<h2 id="a-record" data-v-4b9599ea data-v-4b9599ea><a href="#a-record" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>A Record</h2>
<p data-v-4b9599ea data-v-4b9599ea>By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free <code data-v-4b9599ea data-v-4b9599ea>.tk</code> domain from <a href="https://www.freenom.com/en/freeandpaiddomains.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>freenom</a>. I have used this before and it is a great option for testing things out.</p>
<h2 id="ssh-into-your-digitalocean-droplet" data-v-4b9599ea data-v-4b9599ea><a href="#ssh-into-your-digitalocean-droplet" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>SSH into your DigitalOcean Droplet</h2>
<p data-v-4b9599ea data-v-4b9599ea>You can do this with the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>ssh -i ~/.ssh/a1_rsa root@123.45.578.91
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>a1_rsa</code> is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly.</p>
<h2 id="add-the-rex-ray-docker-plugin" data-v-4b9599ea data-v-4b9599ea><a href="#add-the-rex-ray-docker-plugin" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add the REX-Ray docker plugin</h2>
<p data-v-4b9599ea data-v-4b9599ea>This step is very simple, you can follow along with this short guide: <a href="https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container</a>.</p>
<p data-v-4b9599ea data-v-4b9599ea>There is basically one command to run:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>You will need to make sure that you replace <code data-v-4b9599ea data-v-4b9599ea>YOUR_DIGITALOCEAN_TOKEN</code> with the personal access token you added earlier. Also, <code data-v-4b9599ea data-v-4b9599ea>DOBS_REGION</code> should be the region you selected for your Droplet earlier.</p>
<p data-v-4b9599ea data-v-4b9599ea>Check that the plugin was installed correctly with:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker plugin ls
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Here's a quick intro to REX-Ray from <a href="https://rexray.readthedocs.io/en/stable/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>rexray.readthedocs.io</a>:</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article.</p>
<h2 id="gitlab-ciyml" data-v-4b9599ea data-v-4b9599ea><a href="#gitlab-ciyml" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a><code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code></h2>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code> is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over <a href="https://docs.gitlab.com/ee/ci/yaml/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this page from the GitLab documentation</a> which goes over all of the configuration options with many examples. Also, <a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this documentation page</a> covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly.</p>
<p data-v-4b9599ea data-v-4b9599ea>CI/CD pipelines that I define with <code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code> typically contain three stages: <code data-v-4b9599ea data-v-4b9599ea>test</code>, <code data-v-4b9599ea data-v-4b9599ea>build</code> and <code data-v-4b9599ea data-v-4b9599ea>deploy</code>. We will focus on the <code data-v-4b9599ea data-v-4b9599ea>build</code> and <code data-v-4b9599ea data-v-4b9599ea>deploy</code> stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest).</p>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>build-backend</code> is the name of a GitLab CI job that builds and tags a docker image from the source code in the <code data-v-4b9599ea data-v-4b9599ea>backend</code> directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later.</p>
<p data-v-4b9599ea data-v-4b9599ea>Here's the YAML code for <code data-v-4b9599ea data-v-4b9599ea>build-backend</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>build-backend</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stage</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> build
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> docker<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>19.03.1
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>services</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>19.03.5<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>dind
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>before_script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker login <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>u gitlab<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>ci<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>token <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>p $CI_JOB_TOKEN $CI_REGISTRY
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>|</span><span class="token scalar string" data-v-4b9599ea data-v-4b9599ea>
      docker build \
        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \
        -f backend/docker/Dockerfile.prod \
        ./backend/</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker push $CI_REGISTRY_IMAGE/backend<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>$CI_COMMIT_SHORT_SHA
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>build-nginx</code> is almost identical, but the <code data-v-4b9599ea data-v-4b9599ea>docker build</code> arguments are slightly different. There are three arguments for the <code data-v-4b9599ea data-v-4b9599ea>docker build</code> command that I'm using here:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>-t</code>: the tag to tag the built image with</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>-f</code>: the Dockerfile to be used for building the image</li>
<li data-v-4b9599ea data-v-4b9599ea>the <code data-v-4b9599ea data-v-4b9599ea>context</code> that is sent to the docker daemon when we build the image</li>
</ol>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>-t</code> makes use of two predefined GitLab CI variables: <code data-v-4b9599ea data-v-4b9599ea>CI_REGISTRY_IMAGE</code> and <code data-v-4b9599ea data-v-4b9599ea>CI_COMMIT_SHORT_SHA</code>. <code data-v-4b9599ea data-v-4b9599ea>$CI_REGISTRY_IMAGE</code> is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: <code data-v-4b9599ea data-v-4b9599ea>registry.gitlab.com/&lt;gitlab_username>/&lt;project_name></code>, and <code data-v-4b9599ea data-v-4b9599ea>CI_COMMIT_SHORT_SHA</code> is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the <code data-v-4b9599ea data-v-4b9599ea>tag</code>, even though we pass in more than just this value. We combine these two values with <code data-v-4b9599ea data-v-4b9599ea>/</code> and the name of the image we are building, such as <code data-v-4b9599ea data-v-4b9599ea>backend</code>, so the full value being passed to <code data-v-4b9599ea data-v-4b9599ea>-t</code> is:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>registry.gitlab.com/gitlab-username/my-project/backend:abcd1234
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>-f</code> is the path to the <code data-v-4b9599ea data-v-4b9599ea>Dockerfile</code> we are using relative to the directory where we are running the <code data-v-4b9599ea data-v-4b9599ea>docker build</code> command, which is the root directory of the project.</p>
<p data-v-4b9599ea data-v-4b9599ea>The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with <code data-v-4b9599ea data-v-4b9599ea>docker build</code>, we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as <code data-v-4b9599ea data-v-4b9599ea>ADD</code> and <code data-v-4b9599ea data-v-4b9599ea>COPY</code> -- we will get to these soon). There's a key difference between the <code data-v-4b9599ea data-v-4b9599ea>backend</code> and <code data-v-4b9599ea data-v-4b9599ea>nginx</code> <code data-v-4b9599ea data-v-4b9599ea>docker build</code> commands: the context for <code data-v-4b9599ea data-v-4b9599ea>backend</code> is <code data-v-4b9599ea data-v-4b9599ea>backend</code>, but the context for <code data-v-4b9599ea data-v-4b9599ea>nginx</code> is <code data-v-4b9599ea data-v-4b9599ea>.</code> (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the <code data-v-4b9599ea data-v-4b9599ea>nginx</code> and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the <code data-v-4b9599ea data-v-4b9599ea>docker build</code> command to hang. The first line of output from a <code data-v-4b9599ea data-v-4b9599ea>docker build</code> command should be something like this:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>Sending build context to Docker daemon  24.58kB
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>If this number is too high, you should use a <code data-v-4b9599ea data-v-4b9599ea>.dockerignore</code> file that ignores any files or directories you don't want to send to the docker daemon (similar to how <code data-v-4b9599ea data-v-4b9599ea>.gitignore</code> works with git).</p>
<p data-v-4b9599ea data-v-4b9599ea>To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the <code data-v-4b9599ea data-v-4b9599ea>docker login</code> command in the <code data-v-4b9599ea data-v-4b9599ea>before_script</code> as well two other predefined GitLab CI variables: <code data-v-4b9599ea data-v-4b9599ea>CI_JOB_TOKEN</code> and <code data-v-4b9599ea data-v-4b9599ea>CI_REGISTRY</code>. This all happens using a special service called <code data-v-4b9599ea data-v-4b9599ea>docker-in-docker</code> which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key <code data-v-4b9599ea data-v-4b9599ea>image</code> -- and can define additional containers -- the <code data-v-4b9599ea data-v-4b9599ea>services</code> key -- to help with the CI job). Once the two images for <code data-v-4b9599ea data-v-4b9599ea>backend</code> and <code data-v-4b9599ea data-v-4b9599ea>nginx</code> have been built and pushed, our GitLab CI pipeline moves on to the next stage: <code data-v-4b9599ea data-v-4b9599ea>deploy</code>. In the <code data-v-4b9599ea data-v-4b9599ea>deploy</code> stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>initialize a single-node docker swarm cluster on our Droplet and</li>
<li data-v-4b9599ea data-v-4b9599ea>create a docker network that our cluster's services (containers) will use</li>
</ol>
<h2 id="setup-a-docker-swarm-cluster" data-v-4b9599ea data-v-4b9599ea><a href="#setup-a-docker-swarm-cluster" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Setup a docker swarm cluster</h2>
<p data-v-4b9599ea data-v-4b9599ea>To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above (<code data-v-4b9599ea data-v-4b9599ea>ssh -i ~/.ssh/a1_rsa root@123.45.578.91</code> where <code data-v-4b9599ea data-v-4b9599ea>a1_rsa</code> is the name of the private key file -- you can ignore the <code data-v-4b9599ea data-v-4b9599ea>-i ~/.ssh/a1_rsa</code> part if you are using an SSH key called <code data-v-4b9599ea data-v-4b9599ea>id_rsa</code>), and run the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker swarm init --advertise-addr DROPLET_IP
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Replace <code data-v-4b9599ea data-v-4b9599ea>DROPLET_IP</code> with your Droplet's IP address (e.g. <code data-v-4b9599ea data-v-4b9599ea>123.45.578.91</code>). Check out <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this article</a> for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here.</p>
<p data-v-4b9599ea data-v-4b9599ea>Docker swarm uses docker-compose files, but using docker swarm is very different from running <code data-v-4b9599ea data-v-4b9599ea>docker-compose up</code>, a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using <code data-v-4b9599ea data-v-4b9599ea>docker-compose</code> (the command) in production. Many people do this, and several official tutorials will often end with "now just run <code data-v-4b9599ea data-v-4b9599ea>docker-compose up</code> and you are done". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran <code data-v-4b9599ea data-v-4b9599ea>docker-compose up</code>. It is pretty easy and it works very similarly in both local and production environments, but this guide will be using <code data-v-4b9599ea data-v-4b9599ea>docker-compose</code> in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use.</p>
<h2 id="defining-an-overlay-network" data-v-4b9599ea data-v-4b9599ea><a href="#defining-an-overlay-network" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Defining an overlay network</h2>
<p data-v-4b9599ea data-v-4b9599ea>SSH into your droplet and run the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker network create --driver=overlay traefik-public
</code></pre></div>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>Let's go over one more docker concept that will helpful in the next few steps. When you run <code data-v-4b9599ea data-v-4b9599ea>docker ps</code> on your local machine, the docker CLI first looks to see if the <code data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST</code> environment variable is set. If it is not, then docker defaults to <code data-v-4b9599ea data-v-4b9599ea>unix:///var/run/docker.sock</code>, a UNIX socket. Check out <a href="https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this SO post</a> titled "Can anyone explain docker.sock?"</p>
<p data-v-4b9599ea data-v-4b9599ea>We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST=ssh://root@$DOCKER_IP
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>See this article for a more in-depth discussion: <a href="https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow</a>.</p>
<p data-v-4b9599ea data-v-4b9599ea>You can try this out locally. Run a container locally, check it with <code data-v-4b9599ea data-v-4b9599ea>docker ps</code>, then export the <code data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST</code> environment variable with the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>export DOCKER_HOST=ssh://root@123.45.678.91
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Replacing <code data-v-4b9599ea data-v-4b9599ea>123.45.678.91</code> with your Droplet IP. Run <code data-v-4b9599ea data-v-4b9599ea>docker ps</code> again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>unset DOCKER_HOST
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Running <code data-v-4b9599ea data-v-4b9599ea>docker ps</code> again you should see the containers on your machine. We will be using this idea in the next step when we look at the <code data-v-4b9599ea data-v-4b9599ea>docker stack deploy</code> command.</p>
<h2 id="docker-stack-deploy" data-v-4b9599ea data-v-4b9599ea><a href="#docker-stack-deploy" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a><code data-v-4b9599ea data-v-4b9599ea>docker stack deploy</code></h2>
<p data-v-4b9599ea data-v-4b9599ea>Now that we have done our one-time-setup steps, let's look at the <code data-v-4b9599ea data-v-4b9599ea>deploy</code> stage of <code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code>, the GitLab CI job that will get our containers running on our Droplet. First, let's break down the <code data-v-4b9599ea data-v-4b9599ea>deploy-digital-ocean</code> command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>deploy-digital-ocean</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stage</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> deploy
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> docker<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>19.03.1
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>services</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>19.03.5<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>dind
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>variables</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'ssh://root@$DROPLET_IP'</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>before_script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> apk update <span class="token important" data-v-4b9599ea data-v-4b9599ea>&&</span> apk add openssh<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>client bash
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> mkdir <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>p ~/.ssh
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> echo "$SSH_PRIVATE_KEY" <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>></span> ~/.ssh/id_rsa
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> chmod 600 ~/.ssh/id_rsa
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> eval "$(ssh<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>agent <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>s)"
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> ssh<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>add ~/.ssh/id_rsa
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> ssh<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>keyscan <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>H $DROPLET_IP <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>></span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>></span> ~/.ssh/known_hosts
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker login <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>u gitlab<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>ci<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>token <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>p $CI_JOB_TOKEN $CI_REGISTRY
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> docker stack deploy <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>c stack.yml my<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>stack <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>with<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>registry<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>auth
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This job uses the same <code data-v-4b9599ea data-v-4b9599ea>image</code> and <code data-v-4b9599ea data-v-4b9599ea>services</code> that our <code data-v-4b9599ea data-v-4b9599ea>build</code> stage jobs used. Notice that we set <code data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST</code> to <code data-v-4b9599ea data-v-4b9599ea>"ssh://root@$DROPLET_IP"</code>, this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The <code data-v-4b9599ea data-v-4b9599ea>before_script</code> has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, <code data-v-4b9599ea data-v-4b9599ea>docker:19.03.1</code> is based on Alpine Linus. This version of Linux is super light weight and doesn't come with <code data-v-4b9599ea data-v-4b9599ea>openssh-client</code> or <code data-v-4b9599ea data-v-4b9599ea>bash</code>, so our first step is to install these with the Alpine package manager, <code data-v-4b9599ea data-v-4b9599ea>apk</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>apk update && apk add openssh-client bash
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Next, we add the <code data-v-4b9599ea data-v-4b9599ea>SSH_PRIVATE_KEY</code> environment variable into the body of the <code data-v-4b9599ea data-v-4b9599ea>id_rsa</code> private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from <code data-v-4b9599ea data-v-4b9599ea>man ssh-agent</code> that provides a little bit more context into why we need to run <code data-v-4b9599ea data-v-4b9599ea>eval "$(ssh-agent -s)"</code> and <code data-v-4b9599ea data-v-4b9599ea>ssh-add ~/.ssh/id_rsa</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DESCRIPTION
     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).

     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Next, <code data-v-4b9599ea data-v-4b9599ea>ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts</code> tells our SSH agent about our Droplet so that it doesn't prompt us with a <code data-v-4b9599ea data-v-4b9599ea>Do you want to add this server to known hosts? (yes/no)</code>, or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH.</p>
<p data-v-4b9599ea data-v-4b9599ea>Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This essentially gives our DigitalOcean Droplet access to the <code data-v-4b9599ea data-v-4b9599ea>backend</code> and <code data-v-4b9599ea data-v-4b9599ea>nginx</code> images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images.</p>
<p data-v-4b9599ea data-v-4b9599ea>The last command in the <code data-v-4b9599ea data-v-4b9599ea>deploy-digital-ocean</code> job is:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker stack deploy -c stack.yml my-stack --with-registry-auth
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Check out this link from the docker docs on docker stacks <a href="https://docs.docker.com/engine/swarm/stack-deploy/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://docs.docker.com/engine/swarm/stack-deploy/</a>. <code data-v-4b9599ea data-v-4b9599ea>--with-registry-auth</code> is important, our command will complete if this is not included, but our application won't start.</p>
<h2 id="stackyml" data-v-4b9599ea data-v-4b9599ea><a href="#stackyml" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a><code data-v-4b9599ea data-v-4b9599ea>stack.yml</code></h2>
<p data-v-4b9599ea data-v-4b9599ea>Now we are ready to tackle the last big file in our repo: <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code>. This is a the docker-compose file that we use to deploy our project. The only reason we needed to run <code data-v-4b9599ea data-v-4b9599ea>docker login</code> above is because <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code> references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the <code data-v-4b9599ea data-v-4b9599ea>backend</code> service:</p>
<h3 id="backend" data-v-4b9599ea data-v-4b9599ea><a href="#backend" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>backend</h3>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>version</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'3.4'</span>
<span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>services</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>backend</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> $<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>CI_REGISTRY_IMAGE<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>/backend<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>$<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>CI_COMMIT_SHORT_SHA<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>networks</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> main
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>environment</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> POSTGRES_PASSWORD
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> SECRET_KEY
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> DEBUG
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>volumes</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> backendassets<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>/code/assets
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>depends_on</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> postgres
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> redis
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> web
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>The <code data-v-4b9599ea data-v-4b9599ea>image</code> is essentially what we defined in <code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code>, but the syntax is slightly different:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We pass environment variables that we defined in GitLab CI via the <code data-v-4b9599ea data-v-4b9599ea>environment</code> key.</p>
<p data-v-4b9599ea data-v-4b9599ea>The volume <code data-v-4b9599ea data-v-4b9599ea>backendassets</code> is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at <code data-v-4b9599ea data-v-4b9599ea>/code/assets</code> and then define our <code data-v-4b9599ea data-v-4b9599ea>STATIC_ROOT</code> in Django's <code data-v-4b9599ea data-v-4b9599ea>settings.py</code> to be:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>path<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>join<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>BASE_DIR<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"assets"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"static"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Later, when we run <code data-v-4b9599ea data-v-4b9599ea>collectstatic</code>, files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application.</p>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>network</code> and <code data-v-4b9599ea data-v-4b9599ea>depends_on</code> related to to the other services that this application will communicate with. <code data-v-4b9599ea data-v-4b9599ea>main</code> is a network defined in the <code data-v-4b9599ea data-v-4b9599ea>networks</code> part of <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code>, notice that we reference the <code data-v-4b9599ea data-v-4b9599ea>traefik-public</code> network here that we created earlier, as well.</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Depends on helps with service startup order, but it is a better practice to use <code data-v-4b9599ea data-v-4b9599ea>./wait-for-it.sh</code>. However, I have never had any issues related to startup order. I'll try adding this later to make things more robust.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>postgres</code> and <code data-v-4b9599ea data-v-4b9599ea>redis</code> will start before <code data-v-4b9599ea data-v-4b9599ea>backend</code>. Our Django application will communicate to these services by their hostnames: <code data-v-4b9599ea data-v-4b9599ea>postgres</code> and <code data-v-4b9599ea data-v-4b9599ea>redis</code>. The fact that <code data-v-4b9599ea data-v-4b9599ea>backend</code>, <code data-v-4b9599ea data-v-4b9599ea>postgres</code> and <code data-v-4b9599ea data-v-4b9599ea>redis</code> are all on the same network (<code data-v-4b9599ea data-v-4b9599ea>main</code>) means that they can resolve each other by these names. For example, the connection string to redis will look like: <code data-v-4b9599ea data-v-4b9599ea>redis://redis:6379</code>. Let's look at the <code data-v-4b9599ea data-v-4b9599ea>DATABASES</code> configuration in <code data-v-4b9599ea data-v-4b9599ea>settings.py</code> to see how we connect to Postgres:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>DATABASES <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"default"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"ENGINE"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"django.db.backends.postgresql_psycopg2"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"POSTGRES_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"postgres"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"USER"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"POSTGRES_USERNAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"postgres"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"PASSWORD"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"POSTGRES_PASSWORD"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"postgres"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"HOST"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"POSTGRES_SERVICE_HOST"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"postgres"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"PORT"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"POSTGRES_SERVICE_PORT"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>5432</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>I have defined the <code data-v-4b9599ea data-v-4b9599ea>HOST</code> to be based on the environment variable <code data-v-4b9599ea data-v-4b9599ea>POSTGRES_HOST</code>, but I have not defined this environment variable, so why didn't I just say <code data-v-4b9599ea data-v-4b9599ea>"HOST": "postgres"</code>? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values.</p>
<p data-v-4b9599ea data-v-4b9599ea>I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself.</p>
<h3 id="nginx" data-v-4b9599ea data-v-4b9599ea><a href="#nginx" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>NGINX</h3>
<p data-v-4b9599ea data-v-4b9599ea>The next service we should go over is <code data-v-4b9599ea data-v-4b9599ea>web</code>, the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>Reverse proxy</li>
<li data-v-4b9599ea data-v-4b9599ea>Serve static files for Django</li>
<li data-v-4b9599ea data-v-4b9599ea>Serve a frontend Javascript application</li>
</ol>
<p data-v-4b9599ea data-v-4b9599ea>Here's the definition of this service in <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>services</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>web</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> $<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>CI_REGISTRY_IMAGE<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>/nginx<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>$<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>CI_COMMIT_SHORT_SHA<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>networks</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> traefik<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>public
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> main
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>volumes</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> backendassets<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>/usr/src/app/assets
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>deploy</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>labels</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.enable=true'</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.entrypoints=websecure'</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.services.nginx-web.loadbalancer.server.port=80'</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>For now, ignore the contents under the <code data-v-4b9599ea data-v-4b9599ea>deploy</code> key; we will cover this next when we go over the <code data-v-4b9599ea data-v-4b9599ea>traefik</code> service.</p>
<p data-v-4b9599ea data-v-4b9599ea>NGINX acts as a reverse proxy when it sends request starting with <code data-v-4b9599ea data-v-4b9599ea>/api</code> or <code data-v-4b9599ea data-v-4b9599ea>/admin</code> to the <code data-v-4b9599ea data-v-4b9599ea>backend</code> container. Two blocks in <code data-v-4b9599ea data-v-4b9599ea>prod.conf</code> enable this behavior:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>  upstream backend {
    server backend:8000;
  }
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This hostname <code data-v-4b9599ea data-v-4b9599ea>backend</code> is defined as <code data-v-4b9599ea data-v-4b9599ea>backend:8000</code>. <code data-v-4b9599ea data-v-4b9599ea>backend:8000</code> can be resolved by the <code data-v-4b9599ea data-v-4b9599ea>web</code> service because it is on the same <code data-v-4b9599ea data-v-4b9599ea>main</code> network that <code data-v-4b9599ea data-v-4b9599ea>backend</code> is on. If either of the <code data-v-4b9599ea data-v-4b9599ea>web</code> or <code data-v-4b9599ea data-v-4b9599ea>backend</code> wasn't on the <code data-v-4b9599ea data-v-4b9599ea>main</code> network, NGINX would not be able to make sense of <code data-v-4b9599ea data-v-4b9599ea>backend:8000</code>.</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>    # backend urls
    location ~ ^/(admin|api) {
      proxy_redirect off;
      proxy_pass http://backend;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
    }
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This block does that actual request forwarding. <code data-v-4b9599ea data-v-4b9599ea>http://backend</code> references the <code data-v-4b9599ea data-v-4b9599ea>upstream backend {}</code> block defined above.</p>
<p data-v-4b9599ea data-v-4b9599ea>The volume <code data-v-4b9599ea data-v-4b9599ea>backendassets</code> is referenced here and mounts to <code data-v-4b9599ea data-v-4b9599ea>/usr/src/app/assets</code>. This path is then referenced in <code data-v-4b9599ea data-v-4b9599ea>prod.conf</code>, the NGINX configuration file that is used in our custom NGINX-based image:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>    # static files
    location /static {
      autoindex on;
      alias /usr/src/app/assets/static;
    }
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>In this block of <code data-v-4b9599ea data-v-4b9599ea>prod.conf</code>, we tell NGINX to serve files from <code data-v-4b9599ea data-v-4b9599ea>/usr/src/app/assets/static</code> for requests that start with <code data-v-4b9599ea data-v-4b9599ea>/static</code>. A request made to <code data-v-4b9599ea data-v-4b9599ea>https://mysite.com/static/base.css</code> would return a file located at <code data-v-4b9599ea data-v-4b9599ea>/usr/src/app/assets/static</code> if that file existed. Remember, when we run the <code data-v-4b9599ea data-v-4b9599ea>collecstatic</code> management command in our Django container, it will collect our static files to <code data-v-4b9599ea data-v-4b9599ea>backendassets</code>. Since <code data-v-4b9599ea data-v-4b9599ea>backendassets</code> is mounted to the <code data-v-4b9599ea data-v-4b9599ea>web</code> service at <code data-v-4b9599ea data-v-4b9599ea>/usr/src/app/assets</code>, NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container.</p>
<p data-v-4b9599ea data-v-4b9599ea>Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the <code data-v-4b9599ea data-v-4b9599ea>nginx</code> container:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea># # build stage
# FROM node:10-alpine as build-stage
# WORKDIR /app/
# COPY frontend/package.json /app/
# RUN npm cache verify
# RUN npm install
# COPY frontend /app/
# RUN npm run build

# production stage
# FROM nginx:1.19.1-alpine as production-stage
FROM nginx:1.19.1-alpine
COPY nginx/prod/prod.conf /etc/nginx/nginx.conf
COPY nginx/prod/index.html /dist/
# COPY --from=build-stage /app/dist /dist/
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>COPY --from=build-stage /app/dist /dist/
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This would copy the build files for our Javascript application into the <code data-v-4b9599ea data-v-4b9599ea>/dist/</code> folder of our NGINX container. Another few declarations and blocks in <code data-v-4b9599ea data-v-4b9599ea>prod.conf</code> allow all other requests to be served by the contents of this folder:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>    root /dist/;
    index index.html;
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This sets the root and the index document for our NGINX webserver.</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>    # frontend
    location / {
      try_files $uri $uri/ @rewrites;
    }

    location @rewrites {
      rewrite ^(.+)$ /index.html last;
    }
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>These two blocks route all other requests to the frontend Javascript app's <code data-v-4b9599ea data-v-4b9599ea>index.html</code> file location in <code data-v-4b9599ea data-v-4b9599ea>/dist/</code> (any request that doesn't start with <code data-v-4b9599ea data-v-4b9599ea>/static</code>, <code data-v-4b9599ea data-v-4b9599ea>/api</code> or <code data-v-4b9599ea data-v-4b9599ea>/admin</code>). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path.</p>
<p data-v-4b9599ea data-v-4b9599ea>Lastly, the <code data-v-4b9599ea data-v-4b9599ea>web</code> service's <code data-v-4b9599ea data-v-4b9599ea>deployment</code> key has some <code data-v-4b9599ea data-v-4b9599ea>labels</code> defined for Traefik. Let's come back to these after having a look at the <code data-v-4b9599ea data-v-4b9599ea>traefik</code> service.</p>
<h3 id="traefik" data-v-4b9599ea data-v-4b9599ea><a href="#traefik" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Traefik</h3>
<p data-v-4b9599ea data-v-4b9599ea><img alt="png" src="https://docs.traefik.io/assets/img/traefik-architecture.png" data-v-4b9599ea data-v-4b9599ea></p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- <a href="https://docs.traefik.io/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://docs.traefik.io/</a></p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>Traefik has three main functions in my application:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS</li>
<li data-v-4b9599ea data-v-4b9599ea>Do TLS termination</li>
<li data-v-4b9599ea data-v-4b9599ea>Route all requests to NGINX</li>
</ol>
<p data-v-4b9599ea data-v-4b9599ea>The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed "fun and easy", especially when it comes to requesting certificates.</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>There are two main ways to set up Traefik:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>write a <code data-v-4b9599ea data-v-4b9599ea>traefik.toml</code> file and build this into your own custom image (similar to what we do with NGINX and <code data-v-4b9599ea data-v-4b9599ea>prod.conf</code>)</li>
<li data-v-4b9599ea data-v-4b9599ea>use a base image and specify all configure options through command line arguments.</li>
</ol>
<p data-v-4b9599ea data-v-4b9599ea>I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code> (for now all the values I'm using in the <code data-v-4b9599ea data-v-4b9599ea>traefik</code> service are hard-coded, this is one more item for my ToDo list on this project).</p>
<p data-v-4b9599ea data-v-4b9599ea>I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses <code data-v-4b9599ea data-v-4b9599ea>docker-compose up</code>. There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled <a href="https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>How to install Traefik 2.x on a Docker Swarm</a> helped me a lot in figuring out how to get everything working. Thank you for the great article, <a href="https://github.com/creekorful" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>Alo√Øs</a>!</p>
<p data-v-4b9599ea data-v-4b9599ea>Here's the code that sets up the traefik service:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>services</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>traefik</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> traefik<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>v2.0.2
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>ports</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'80:80'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'443:443'</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>command</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--providers.docker.endpoint=unix:///var/run/docker.sock'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--providers.docker.swarmMode=true'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--providers.docker.exposedbydefault=false'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--providers.docker.network=traefik-public'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--entrypoints.web.address=:80'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--entrypoints.websecure.address=:443'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>volumes</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> letsencrypt<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>/letsencrypt
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> /var/run/docker.sock<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>/var/run/docker.sock
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>networks</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> traefik<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>public
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>deploy</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>placement</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>constraints</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
          <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> node.role == manager
</code></pre></div>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>web</code> and <code data-v-4b9599ea data-v-4b9599ea>websecure</code> refer to values declared on the <code data-v-4b9599ea data-v-4b9599ea>web</code> service. Let's take a look at those values:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yaml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>deploy</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>labels</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.enable=true'</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.entrypoints=websecure'</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'traefik.http.services.nginx-web.loadbalancer.server.port=80'</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>I still need to setup HTTP -> HTTPS redirecting, so for now only <code data-v-4b9599ea data-v-4b9599ea>websecure</code> is defined, but Alo√Øs explains this clearly in his article.</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>That wraps up our overview of <code data-v-4b9599ea data-v-4b9599ea>stack.yml</code>, we left off with the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker stack deploy -c stack.yml my-stack --with-registry-auth
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the <code data-v-4b9599ea data-v-4b9599ea>DOCKER_HOST</code> environment variable that I showed you earlier and run these commands from your local terminal:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker stack ps my-stack --no-trunc
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>--no-trunc</code> is important because important error messages tend to be cut off. This option will show the full version of each column returned by <code data-v-4b9599ea data-v-4b9599ea>docker stack ps</code>.</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker service ls
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This command shows some the active services on our Droplet.</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker ps
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This command is useful for shelling into a container to run commands and poke around for debugging.</p>
<p data-v-4b9599ea data-v-4b9599ea>You can get the Container ID of a running container and access it with the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>docker exec -it 0da8370ab283 bash
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This assumes that <code data-v-4b9599ea data-v-4b9599ea>bash</code> is installed on the container with ID <code data-v-4b9599ea data-v-4b9599ea>0da8370ab283</code>.</p>
<h2 id="management-commands" data-v-4b9599ea data-v-4b9599ea><a href="#management-commands" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Management commands</h2>
<p data-v-4b9599ea data-v-4b9599ea>Once the site is deployed we stil need to run a few commands to set up our Djnago application:</p>
<ol data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>collectstatic</li>
<li data-v-4b9599ea data-v-4b9599ea>migrate</li>
<li data-v-4b9599ea data-v-4b9599ea>createsuperuser</li>
</ol>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>One other ToDo is to figure out how to run these commands through manual GitLab CI jobs.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean.</p>
<h2 id="next-steps" data-v-4b9599ea data-v-4b9599ea><a href="#next-steps" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Next steps</h2>
<p data-v-4b9599ea data-v-4b9599ea>Here are some ideas about the next steps I could take on this project.</p>
<h3 id="local-environment" data-v-4b9599ea data-v-4b9599ea><a href="#local-environment" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Local environment</h3>
<p data-v-4b9599ea data-v-4b9599ea>I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings.</p>
<h3 id="infrastructure-as-code-setup" data-v-4b9599ea data-v-4b9599ea><a href="#infrastructure-as-code-setup" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Infrastructure as Code setup</h3>
<p data-v-4b9599ea data-v-4b9599ea>There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK.</p>
<h3 id="scaling-out-docker-swarm-services-across-multiple-machines" data-v-4b9599ea data-v-4b9599ea><a href="#scaling-out-docker-swarm-services-across-multiple-machines" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Scaling out docker swarm services across multiple machines</h3>
<p data-v-4b9599ea data-v-4b9599ea>I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads.</p>
<h3 id="kubernetes-on-digitalocean" data-v-4b9599ea data-v-4b9599ea><a href="#kubernetes-on-digitalocean" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Kubernetes on DigitalOcean</h3>
<p data-v-4b9599ea data-v-4b9599ea>DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP.</p>
<h3 id="deploying-locally-without-using-gitlab-ci" data-v-4b9599ea data-v-4b9599ea><a href="#deploying-locally-without-using-gitlab-ci" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Deploying locally, without using GitLab CI</h3>
<p data-v-4b9599ea data-v-4b9599ea>CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages.</p></div> <div class="text-center pb-4 pt-8" data-v-4b9599ea><button class="mc-btn rounded py-1 px-2" data-v-4b9599ea>
        Show Disqus Comments üí¨
      </button></div> <!----> <h1 data-v-4b9599ea></h1></div></article> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-27f2d9d4><hr class="mt-4" data-v-27f2d9d4> <div class="mx-auto py-4" data-v-27f2d9d4><div class="pb-4" data-v-27f2d9d4>
      Join my mailing list to get updated whenever I publish a new article.
    </div> <div class="mx-auto" data-v-89248ae4 data-v-27f2d9d4><div id="mc_embed_signup" class="mx-auto w-full md:w-1/2" data-v-89248ae4><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-89248ae4><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center" data-v-89248ae4><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Enter your email address" class="rounded mc text-center" data-v-89248ae4> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-89248ae4><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-89248ae4></div> <div data-v-89248ae4><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="Subscribe" class="mc-btn rounded px-2 py-1 w-full" data-v-89248ae4></div></div></form></div></div></div> <hr data-v-27f2d9d4> <div class="py-4" data-v-27f2d9d4>
    Thanks for checking out my site!
  </div> <div class="pb-4" data-v-27f2d9d4>
    ¬© 2021 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1672798569/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.html/state.js"></script><script src="/_nuxt/e9c2366.js" defer></script><script src="/_nuxt/b5afa39.js" defer></script><script src="/_nuxt/9ee0ef6.js" defer></script><script src="/_nuxt/f51c3d4.js" defer></script><script src="/_nuxt/0f451e7.js" defer></script>
  </body>
</html>
