<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="og:title" content="Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern"><meta data-n-head="ssr" property="og:description" content="undefined"><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/djambda.png"><meta data-n-head="ssr" property="twitter:card" content="https://briancaffey.github.io/static/djambda.png"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><script data-n-head="ssr" data-hid="adsbygoogle-script" defer crossorigin="anonymous" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4924597640144289"></script><script data-n-head="ssr" data-hid="adsbygoogle">window.__abg_called||((adsbygoogle=window.adsbygoogle||[]).pauseAdRequests=0,(window.adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4924597640144289",enable_page_level_ads:!1,overlays:{bottom:!1}}),window.__abg_called=!0)</script><link rel="preload" href="/_nuxt/2600eb3.js" as="script"><link rel="preload" href="/_nuxt/9ee0ef6.js" as="script"><link rel="preload" href="/_nuxt/f51c3d4.js" as="script"><link rel="preload" href="/_nuxt/d4698ff.js" as="script"><link rel="preload" href="/_nuxt/9d8324e.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 5a4b6265:0 14b1eaf9:0 a0fa61ae:0 7f6c3ed0:0 68771c59:0 5586ddaf:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-4xl{font-size:2.25rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-8{grid-gap:2rem;gap:2rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 5px 10px 0 #0e2233;box-shadow:0 5px 10px 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 10px 40px 0 #0e2233;box-shadow:0 10px 40px 0 var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-style:italic}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{content:" ";margin-top:-85px;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-3f691362]{padding:0}.selected[data-v-3f691362]{text-shadow:.25px 0 0 #000}.picker[data-v-3f691362]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-3f691362]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-107ae01e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-4f7c5820]{padding:0}.modal[data-v-4f7c5820]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-4f7c5820],.picker[data-v-4f7c5820]{position:absolute;left:0}.picker[data-v-4f7c5820]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.tag[data-v-3fbcd028]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-3fbcd028]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1682868278/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html/state.js" as="script"><link rel="preload" href="/_nuxt/static/1682868278/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1682868278/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-3f691362><div class="top" data-v-3f691362></div> <div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-3f691362><div class="justify-left flex-grow flex-cols-4" data-v-3f691362><a href="/" class="text-xl nuxt-link-active" data-v-3f691362><span class="hidden sm:inline text-2xl" data-v-3f691362>Brian Caffey</span><span class="inline sm:hidden" data-v-3f691362>JBC</span></a></div> <div class="flex-grow relative" data-v-3f691362><nav z-index="10000" data-v-107ae01e data-v-3f691362><div data-v-107ae01e><ul class="items-right float-right hidden md:flex" data-v-107ae01e><li class="px-4 text-lg" data-v-107ae01e><a href="/blog/1" data-v-107ae01e>
          Blog
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/projects" data-v-107ae01e>
          Projects
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/contact" data-v-107ae01e>
          Contact
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-107ae01e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-107ae01e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-107ae01e><title data-v-107ae01e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-107ae01e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-3f691362><div class="centered" data-v-288717a6 data-v-3f691362><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🖥️, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🌞, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="🌚, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="☕, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-4f7c5820 data-v-288717a6><!----> <ul data-v-4f7c5820><li class="md:px-1 px-1 cursor-pointer" data-v-4f7c5820><span aria-label="🇺🇸, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-4f7c5820><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-4f7c5820><a href="/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-4f7c5820><span aria-label="🇺🇸, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-4f7c5820></a><a href="/fr/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" data-v-4f7c5820><span aria-label="🇫🇷, fr, flag-fr" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Français <br data-v-4f7c5820></a><a href="/zh/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" data-v-4f7c5820><span aria-label="🇨🇳, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> 简体中文 <br data-v-4f7c5820></a><a href="/ru/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" data-v-4f7c5820><span aria-label="🇷🇺, ru, flag-ru" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> Русский <br data-v-4f7c5820></a><a href="/jp/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" data-v-4f7c5820><span aria-label="🇯🇵, jp, flag-jp" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> 日本語 <br data-v-4f7c5820></a><a href="/in/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html" data-v-4f7c5820><span aria-label="🇮🇳, flag-in" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> हिंदी <br data-v-4f7c5820></a></div></div></div></li></ul></div></div></div></div> <article data-v-07b74c72><img src="/static/djambda.png" class="pt-2 w-full object-cover cover-image" style="height:24rem" data-v-07b74c72> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-07b74c72><h1 class="prose text-4xl leading-9 py-4 font-bold" data-v-07b74c72>
      Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-07b74c72><a href="/blog/tags/serverless" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    serverless 🏷️
    <!----></div></a><a href="/blog/tags/django" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    django 🏷️
    <!----></div></a><a href="/blog/tags/aws" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    aws 🏷️
    <!----></div></a><a href="/blog/tags/lambda" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    lambda 🏷️
    <!----></div></a><a href="/blog/tags/cdk" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    cdk 🏷️
    <!----></div></a></div> <!----> <p class="blog-date text-gray-500 mb-4" data-v-07b74c72>
      Last Updated on
      August 1, 2020
    </p> <!----> <div class="markdown nuxt-content" data-v-07b74c72 data-v-07b74c72><h2 id="tldr" data-v-07b74c72 data-v-07b74c72><a href="#tldr" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>tl;dr</h2>
<p data-v-07b74c72 data-v-07b74c72>One way to deploy Django apps to AWS on a budget is to use the Lambda proxy pattern. The main idea is this: web requests are made to API Gateway that calls a Lambda outside of our VPC (proxy Lambda), which then invokes a second lambda (Django Lambda) inside of our VPC so that it can access VPC resources, namely RDS. The handler for the Django Lambda translates the API Gateway event into a WSGI-compatible request, processes the request and returns the response to the user back through the proxy Lambda. The big caveat is that you can't easily access the internet in Django's request/response cycle without network address translation (NAT) services which add additional costs. One other caveat is that there is high latency associated with the initial request. There are three cold starts to wait for: the cold start for the proxy Lambda, the cold start for the Django Lambda and the cold start for the Aurora Postgres Serverless database. Here's an architecture diagram:</p>
<p data-v-07b74c72 data-v-07b74c72><img alt="png" src="/static/djambda.png" data-v-07b74c72 data-v-07b74c72></p>
<p data-v-07b74c72 data-v-07b74c72>Route53 and CloudFront (1 and 2), discuessed later on, are optional. Starting with 5, API Gateway requests are passed to a proxy lambda (6) which calls a Lambda in a VPC that contains our Django code and special Django handler (7). This function can access RDS (8) and S3 (4) via a VPC Gateway Endpoint (9), but it cannot access the internet.</p>
<h2 id="why" data-v-07b74c72 data-v-07b74c72><a href="#why" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Why?</h2>
<p data-v-07b74c72 data-v-07b74c72>There are a few different reasons for why I put this project together. Before I get into these reasons, here is a little bit of background on how I typically deploy web apps and the motivations for this project.</p>
<p data-v-07b74c72 data-v-07b74c72>Django is my web framework of choice, and I'm most comfortable working with Django in docker containers. I previously wrote an article about <a href="https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>deploying Django applications with AWS Fargate</a>. This approach technically is "serverless", but it requires the use of "always on" services: an Application Load Balancer, NAT Gateways and long-running Fargate tasks to run gunicorn processes for our Django application. Even if you choose to run workloads in public subnets and don't use NAT Gateways or NAT instances, the costs are prohbitively high for many types of Django projects: personal projects, proof-of-concept projects, internal projects, toy projects, etc.</p>
<p data-v-07b74c72 data-v-07b74c72>The other serverless compute platform on AWS is Lambda. There is a popular framework for deploying serverless Django applications on Lambda called Zappa. I have been meaning to try out Zappa for a while now, and I still haven't used it, but it provided a good reference for how to do "serverless Django". I'll come back to Zappa in more detail later, but the main reason I didn't want to use it for my serverless Django project is because I already have a great deployment and Infrastructure as Code tool: CDK.</p>
<p data-v-07b74c72 data-v-07b74c72>CDK, or Cloud Development Kit, is a tool that allows you define and deploy AWS infrastructure using any popular programming language, Python in my case. It uses CloudFormation in the background, and it has great support for lots of AWS services. If you are looking for an introuction to CDK, check out <a href="https://cdkworkshop.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://cdkworkshop.com/</a>.</p>
<p data-v-07b74c72 data-v-07b74c72>Zappa makes it really easy to deploy serveless Django applications with Django, but it requires that you <a href="https://github.com/Miserlou/Zappa#running-tasks-in-a-vpc" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>setup NAT and other VPC resources before using it with RDS</a>. Since CDK is really good at setting up these kinds of resources, as well as the resources that Zappa creates (including Lambda functions and API Gateway), I wanted to know how far I could get in setting up a servless Django application only using CDK. I also didn't want everything abstracted away by a high level framework; I'm interested in a lower level view to get more familiar with how serverless technologies work. It's important to note that the biggest motivation of all is to learn try something out of my comfort zone, make mistakes and get feedback.</p>
<h2 id="django--lambda--djambda" data-v-07b74c72 data-v-07b74c72><a href="#django--lambda--djambda" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Django + Lambda = djambda</h2>
<p data-v-07b74c72 data-v-07b74c72>The name for this project came pretty easily. I created <a href="https://gitlab.com/briancaffey/djambda" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>a repo on GitLab called djambda</a> and then discovered <a href="https://github.com/netsome/djambda" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>a similar project by the same name on GitHub: netsome/djambda</a>. The <code data-v-07b74c72 data-v-07b74c72>netsome/djambda</code> project uses Terraform, and I encourage you to check it out and leave it a GitHub star. Before I came across this project, I hacked together a very basic djambda protoype using some code from Zappa's handler. A <code data-v-07b74c72 data-v-07b74c72>handler</code> is the name for the function that is called in your Lambda function's code when the Lambda function is invoked. Here's some pseudo code that shows how Zappa's handler works:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token keyword" data-v-07b74c72 data-v-07b74c72>from</span> werkzeug<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>wrappers <span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> Response

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>def</span> <span class="token function" data-v-07b74c72 data-v-07b74c72>handler</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> context<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>with</span> Response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>from_app<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>wsgi_app<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> wsgi_request<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span> <span class="token keyword" data-v-07b74c72 data-v-07b74c72>as</span> response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
        zappa_returndict <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token builtin" data-v-07b74c72 data-v-07b74c72>dict</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
        zappa_returndict<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'body'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span> <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>data
        zappa_returndict<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'statusCode'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span> <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>status_code
        <span class="token keyword" data-v-07b74c72 data-v-07b74c72>return</span> zappa_returndict
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>For reference, <a href="https://github.com/Miserlou/Zappa/blob/master/zappa/handler.py#L540" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>here is the link to the line in Zappa's source code that starts processing API Gateway requests</a> on which the above psuedo code is loosly based.</p>
<p data-v-07b74c72 data-v-07b74c72>The <code data-v-07b74c72 data-v-07b74c72>netsome/djambda</code> project makes use of a package called <a href="https://github.com/slank/awsgi" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>awsgi</a> that has active contributions from people at AWS. Similar to djambda, it is a mashup of words (acronyms): (<code data-v-07b74c72 data-v-07b74c72>AWS</code> + <code data-v-07b74c72 data-v-07b74c72>wsgi</code> = <code data-v-07b74c72 data-v-07b74c72>awsgi</code>). It does most of the work that Zappa's handler does, so I replaced the adapted Zappa handler code with a very elagant handler (borrowed from <code data-v-07b74c72 data-v-07b74c72>netsome/djambda</code>):</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token comment" data-v-07b74c72 data-v-07b74c72># djambda/src/djambda/awsgi.py</span>
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> io

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> awsgi
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>from</span> django<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>core <span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> management

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>from</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>wsgi <span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> application


<span class="token keyword" data-v-07b74c72 data-v-07b74c72>def</span> <span class="token function" data-v-07b74c72 data-v-07b74c72>lambda_handler</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> context<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>if</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"manage"</span> <span class="token keyword" data-v-07b74c72 data-v-07b74c72>in</span> event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
        output <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> io<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>StringIO<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
        management<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>call_command<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token operator" data-v-07b74c72 data-v-07b74c72>*</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"manage"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>split<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>" "</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> stdout<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>output<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
        <span class="token keyword" data-v-07b74c72 data-v-07b74c72>return</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"output"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> output<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>getvalue<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span>
    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>else</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
        <span class="token keyword" data-v-07b74c72 data-v-07b74c72>return</span> awsgi<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>application<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> context<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>This handler can takes care of translating API Gateway requests to WSGI requests as well as management commands such as <code data-v-07b74c72 data-v-07b74c72>migrate</code>, <code data-v-07b74c72 data-v-07b74c72>createsuperuser</code>, <code data-v-07b74c72 data-v-07b74c72>collectstatic</code> and other custom management commands. Let's talk about the management commands first as they relate to the two main AWS services that our Django application uses: RDS and S3. Then we will talk about API Gateway, the proxy Lambda and how the Lambda proxy pattern works.</p>
<h2 id="rds" data-v-07b74c72 data-v-07b74c72><a href="#rds" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>RDS</h2>
<p data-v-07b74c72 data-v-07b74c72>To run the management commands for our application, we can use the AWS CLI to invoke the Lambda function with a payload that will trigger the <code data-v-07b74c72 data-v-07b74c72>if "manage" in event:</code> code block from the above handler:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-bash" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>aws lambda invoke <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --function-name my-djambda-lambda <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --invocation-type RequestResponse <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --payload <span class="token string" data-v-07b74c72 data-v-07b74c72>'{"manage": "migrate --no-input"}'</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    resp.json
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>This will run the <code data-v-07b74c72 data-v-07b74c72>migrate</code> command by connecting to RDS from our Django application with a special version of <code data-v-07b74c72 data-v-07b74c72>psycopg2</code> called <code data-v-07b74c72 data-v-07b74c72>aws-psycopg2</code> (check <code data-v-07b74c72 data-v-07b74c72>django/requirements.txt</code> for this dependency). <code data-v-07b74c72 data-v-07b74c72>psycopg2</code> and <code data-v-07b74c72 data-v-07b74c72>psycopg2-binary</code> both gave error messages when trying to access the database, but the <code data-v-07b74c72 data-v-07b74c72>aws-psycopg2</code> package had no issues.</p>
<p data-v-07b74c72 data-v-07b74c72>RDS can sometimes be the most expensive part of a project on AWS. To reduce costs, we are using Aurora Postgres Serverless. This AWS service is ideal for small, infrequently-used projects that are in development. The database "goes to sleep" after a period of inactivity (5 minutes, I think). When new requests to the database are made, it can take up to 30 seconds for the database to wake up. For this reason, we need the timeout of the Django Lambda to be able to clear the wakeup period of the Aurora Postgres Serverless database.</p>
<p data-v-07b74c72 data-v-07b74c72>Since our Lambda function is in public subnet of our VPC and our RDS Aurora database cluster is in an isolated VPC, we need to make sure that the Lambda function can talk to the RDS cluster. CDK makes this really easy. I'll highlight a few important permission related parts of <code data-v-07b74c72 data-v-07b74c72>awscdk/vpc.py</code>, the code that defines the nested CloudFormation stack where we define our VPC and resources related to our application (including API Gateway, which is technically not located in our VPC).</p>
<p data-v-07b74c72 data-v-07b74c72>First, we define a new security group for our Django Lambda:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>lambda_security_group <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SecurityGroup<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"LambdaSecurityGroup"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> vpc<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Then, we reference this security group in the list of security group ingresses for our database cluster's security group:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>db_security_group <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>CfnSecurityGroup<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"DBSecurityGroup"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            vpc_id<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc_id<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            group_description<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"DBSecurityGroup"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            security_group_ingress<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>
                ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>CfnSecurityGroup<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>IngressProperty<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                    ip_protocol<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"tcp"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    to_port<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>5432</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    from_port<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>5432</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    source_security_group_id<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>lambda_security_group<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>security_group_id<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Now let's take a look at the code for the Django lambda itself:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_lambda <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> _lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Function<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"DjambdaLambda"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            runtime<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Runtime<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>PYTHON_3_8<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            code<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>AssetCode<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'./django'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            function_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>-djambda-lambda"</span></span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            handler<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"djambda.awsgi.lambda_handler"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            layers<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_layer<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            timeout<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Duration<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>seconds<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token number" data-v-07b74c72 data-v-07b74c72>60</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            vpc<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            vpc_subnets<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SubnetSelection<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>subnets<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>isolated_subnets<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            environment<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token operator" data-v-07b74c72 data-v-07b74c72>**</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>env_vars<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            security_groups<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>lambda_security_group<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        <span class="token comment" data-v-07b74c72 data-v-07b74c72># Use raw override because Lambda's can't be placed in</span>
        <span class="token comment" data-v-07b74c72 data-v-07b74c72># public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935</span>
        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>node<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>default_child<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>add_override<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"Properties.VpcConfig.SubnetIds"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>subnet<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>subnet_id <span class="token keyword" data-v-07b74c72 data-v-07b74c72>for</span> subnet <span class="token keyword" data-v-07b74c72 data-v-07b74c72>in</span> self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>public_subnets<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>lambda</code> is a reserved word in Python, so we import <code data-v-07b74c72 data-v-07b74c72>lambda</code> as <code data-v-07b74c72 data-v-07b74c72>_lambda</code> from <code data-v-07b74c72 data-v-07b74c72>aws_cdk</code>. Note that we have a reference to the <code data-v-07b74c72 data-v-07b74c72>awsgi.py</code> handler function in the <code data-v-07b74c72 data-v-07b74c72>handler</code> parameter of <code data-v-07b74c72 data-v-07b74c72>self.djambda_lambda</code>. I initially put the lambda in <code data-v-07b74c72 data-v-07b74c72>isolated_subnets</code> because CDK won't let you define a <code data-v-07b74c72 data-v-07b74c72>_lambda.Function</code> with <code data-v-07b74c72 data-v-07b74c72>public_subnets</code> for <code data-v-07b74c72 data-v-07b74c72>vpc_subnets</code>. We can override this using <code data-v-07b74c72 data-v-07b74c72>add_override</code> below the Lambda definition to place it in a public subnet instead.</p>
<blockquote data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>I'm not sure if this is necessary, or if this is recommended. Things get a little bit confusing for me here so I would love some insight if anyone knows what would be best to do here. The VPC construct for CDK doesn't allow you to have private subnets when <code data-v-07b74c72 data-v-07b74c72>nat_gateways=0</code>. Would I be better off placing the lambda in the isolated subnet with the RDS cluster? Would I still be able to access S3 via the VPC Gateway Endpoint from an isolated subnet?</p>
</blockquote>
<p data-v-07b74c72 data-v-07b74c72>Putting aside my uncertainties about the correct way to configure our Lambdas functions in a VPC, let's continue! Here's the Lambda invocation for <code data-v-07b74c72 data-v-07b74c72>createsuperuser</code> that we can run once we have successfully invoked the <code data-v-07b74c72 data-v-07b74c72>migrate</code> command.</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-bash" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>aws lambda invoke <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --function-name dev-mysite-com-djambda-lambda <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --invocation-type RequestResponse <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --payload <span class="token string" data-v-07b74c72 data-v-07b74c72>'{"manage": "createsuperuser --no-input --username admin --email brian@email.com"}'</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    resp.json
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>This assumes that there is an environment variable defined in our Lambda's <code data-v-07b74c72 data-v-07b74c72>environment</code> variables that we passed in <code data-v-07b74c72 data-v-07b74c72>{**self.env_vars}</code> for <code data-v-07b74c72 data-v-07b74c72>DJANGO_SUPERUSER_USERNAME</code>. Here's what we have in <code data-v-07b74c72 data-v-07b74c72>env_vars</code>:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>env_vars <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"POSTGRES_SERVICE_HOST"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>rds_cluster<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get_att<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                <span class="token string" data-v-07b74c72 data-v-07b74c72>"Endpoint.Address"</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>to_string<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"POSTGRES_PASSWORD"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"DB_PASSWORD"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"db-password"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"AWS_STORAGE_BUCKET_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>scope<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>full_app_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>-assets"</span></span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"DEBUG"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>""</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"DJANGO_SUPERUSER_PASSWORD"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                <span class="token string" data-v-07b74c72 data-v-07b74c72>"DJANGO_SUPERUSER_PASSWORD"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"Mypassword1!"</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"DJANGO_SUPERUSER_USERNAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                <span class="token string" data-v-07b74c72 data-v-07b74c72>"DJANGO_SUPERUSER_USERNAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"admin"</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>We can use environment variables to set an initial password for our superuser. We also define additionl environment variables that we will use for our datbase connection, and the S3 bucket that we will use for Django's static and media assets.</p>
<h2 id="s3" data-v-07b74c72 data-v-07b74c72><a href="#s3" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>S3</h2>
<p data-v-07b74c72 data-v-07b74c72>To access S3 from our Lambda function in a VPC, we need to use a VPC Gateway Endpoint for S3. This is a free service that enables us to access S3 directly from our VPC without going through the internet, and instead using a private connection . This again has to do with the fact that our Django Lambda can't access the internet because the network interfaces created by Lambda only have private IP addresses and would require NAT in order to connect to resources on the internet. Here's how we define the VPC as well as the VPC Gateway Endpoint using CDK:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"Vpc"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            max_azs<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>2</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            cidr<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"10.0.0.0/16"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            nat_gateways<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>0</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            subnet_configuration<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>
                ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SubnetConfiguration<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                    subnet_type<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SubnetType<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>PUBLIC<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"Public"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    cidr_mask<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>24</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SubnetConfiguration<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
                    subnet_type<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>SubnetType<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>ISOLATED<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"Isolated"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                    cidr_mask<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token number" data-v-07b74c72 data-v-07b74c72>24</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
                <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>add_gateway_endpoint<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"S3Gateway"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> service<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>ec2<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>GatewayVpcEndpointAwsService<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'s3'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>With this VPC endpoint in place, we are almost ready to run our collectstatic command, but it won't work yet. This is because we haven't given our Lambda function access to write files to the S3 assets bucket for our Django application's static and media files. We can grant this permission with the following snippet from <code data-v-07b74c72 data-v-07b74c72>awscdk/app_stack.py</code>, the file that defines the root CloudFormation stack for our application:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>backend_assets_bucket<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>grant_read_write<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>vpc_stack<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_lambda
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Finally, we need to add the following settings to <code data-v-07b74c72 data-v-07b74c72>settings.py</code>:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>STATIC_URL <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>'/static/'</span>
STATIC_ROOT <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>path<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>join<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>BASE_DIR<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>'static'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
STATICFILES_STORAGE <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"djambda.storage_backends.StaticStorage"</span>

AWS_DEFAULT_ACL <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token boolean" data-v-07b74c72 data-v-07b74c72>None</span>
AWS_STORAGE_BUCKET_NAME <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
    <span class="token string" data-v-07b74c72 data-v-07b74c72>"AWS_STORAGE_BUCKET_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"bucketname"</span>
<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
AWS_S3_OBJECT_PARAMETERS <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>
    <span class="token string" data-v-07b74c72 data-v-07b74c72>"CacheControl"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"max-age=86400"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span>
AWS_PRIVATE_MEDIA_LOCATION <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"media/private"</span>
AWS_STATIC_LOCATION <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"static"</span>
PRIVATE_FILE_STORAGE <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"backend.storage_backends.PrivateMediaStorage"</span>
AWS_S3_CUSTOM_DOMAIN <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>AWS_STORAGE_BUCKET_NAME<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>.s3.amazonaws.com"</span></span>

<span class="token keyword" data-v-07b74c72 data-v-07b74c72>if</span> <span class="token keyword" data-v-07b74c72 data-v-07b74c72>not</span> DEBUG<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    MEDIA_ROOT <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"media"</span>
    MEDIA_URL <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"https://</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>AWS_S3_CUSTOM_DOMAIN<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>/</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>MEDIA_ROOT<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>/"</span></span>
    STATIC_URL <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string-interpolation" data-v-07b74c72 data-v-07b74c72><span class="token string" data-v-07b74c72 data-v-07b74c72>f"https://</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>AWS_S3_CUSTOM_DOMAIN<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>/</span><span class="token interpolation" data-v-07b74c72 data-v-07b74c72><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span>AWS_STATIC_LOCATION<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span></span><span class="token string" data-v-07b74c72 data-v-07b74c72>/"</span></span>
    FORCE_SCRIPT_NAME <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"/prod"</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>We can run the collectstatic command with the following Lambda invocation:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-bash" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>aws lambda invoke <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --function-name dev-mysite-com-djambda-lambda <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --invocation-type RequestResponse <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    --payload <span class="token string" data-v-07b74c72 data-v-07b74c72>'{"manage": "collectstatic --no-input"}'</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>\</span>
    resp.json
</code></pre></div>
<h2 id="api-gateway-and-the-lambda-proxy-pattern" data-v-07b74c72 data-v-07b74c72><a href="#api-gateway-and-the-lambda-proxy-pattern" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>API Gateway and the Lambda proxy pattern</h2>
<p data-v-07b74c72 data-v-07b74c72>I first read about the Lambda proxy pattern in an article titled <a href="https://serverlessfirst.com/lambda-vpc-internet-access-no-nat-gateway/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>How to access VPC and internet resources from Lambda without paying for a NAT Gateway</a> on Paul Swail's website <a href="https://serverlessfirst.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://serverlessfirst.com/</a>. This site has tons of great serverless content, check out the <a href="https://serverlessfirst.com/articles/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>list of articles</a>. Thank you Paul for putting out great serverless resources!</p>
<p data-v-07b74c72 data-v-07b74c72>Let's take a look at the Proxy Lambda function next. The function itself is pretty straightforward:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> json
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> os
<span class="token keyword" data-v-07b74c72 data-v-07b74c72>import</span> boto3

lambda_client <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> boto3<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>client<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'lambda'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> region_name<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'us-east-1'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>


<span class="token keyword" data-v-07b74c72 data-v-07b74c72>def</span> <span class="token function" data-v-07b74c72 data-v-07b74c72>handler</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> context<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    invoke_response <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> lambda_client<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>invoke<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
        FunctionName<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>os<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>environ<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>get<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"FUNCTION_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token boolean" data-v-07b74c72 data-v-07b74c72>None</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        InvocationType<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'RequestResponse'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        Payload<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>json<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>dumps<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>event<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

    data <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> invoke_response<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'Payload'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>read<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

    <span class="token keyword" data-v-07b74c72 data-v-07b74c72>return</span> data
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>There are just a few things to setup in our CDK code to make the proxy pattern work:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Define the Lambda function</li>
<li data-v-07b74c72 data-v-07b74c72>Give the proxy Lambda permission to invoke the Django Lambda</li>
<li data-v-07b74c72 data-v-07b74c72>Define a <code data-v-07b74c72 data-v-07b74c72>LambdaRestApi</code> construct with the Proxy Lambda as the <code data-v-07b74c72 data-v-07b74c72>handler</code></li>
</ol>
<p data-v-07b74c72 data-v-07b74c72>Here's what that code looks like:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>proxy_lambda <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> _lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Function<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            <span class="token string" data-v-07b74c72 data-v-07b74c72>"ProxyLambda"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            code<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>AssetCode<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"./awslambda"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            runtime<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Runtime<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>PYTHON_3_8<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            layers<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>[</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_layer<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>]</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            handler<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"proxy_lambda.handler"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            timeout<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>core<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>Duration<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>seconds<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token number" data-v-07b74c72 data-v-07b74c72>60</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
            environment<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>{</span><span class="token string" data-v-07b74c72 data-v-07b74c72>"FUNCTION_NAME"</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>function_name<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>}</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>djambda_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>grant_invoke<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>proxy_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>

        self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>apigw <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> apigw<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>LambdaRestApi<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span>
            self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>'DjambdaEndpoint'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span> handler<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>self<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>proxy_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
        <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>That's it! We can now access our Django project at the API Gateway <code data-v-07b74c72 data-v-07b74c72>execute-api</code> endpoint. This is a special URL that has the format:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>https://abc123.execute-api.us-east-1.amazonaws.com/prod
</code></pre></div>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>abc123</code> is the id of the API Gateway that we created (you can find the value of this id in the API Gateway section of the AWS management console)]</li>
<li data-v-07b74c72 data-v-07b74c72>The region <code data-v-07b74c72 data-v-07b74c72>us-east-1</code> is the region where you deployed the API Gateway</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>/prod</code> is the stage name</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>The stage name part is a little confusing for me. It is meant to be a URL suffix that indicates production, staging, etc., but I typically separate environments at the level of the CloudFormation stack, so all of my environments use the <code data-v-07b74c72 data-v-07b74c72>/prod</code> suffix. In order for Django to work properly, we need to tell it that our site will be served at this <code data-v-07b74c72 data-v-07b74c72>/prod</code> path (for example <code data-v-07b74c72 data-v-07b74c72>/admin</code> will now be served at <code data-v-07b74c72 data-v-07b74c72>/prod/admin</code>) by setting a special value in our settings module:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>FORCE_SCRIPT_NAME <span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span> <span class="token string" data-v-07b74c72 data-v-07b74c72>"/prod"</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>This will make dealing with URLs easier, mostly because we don't actually have to change anything in our <code data-v-07b74c72 data-v-07b74c72>urls.py</code>. I tried adding <code data-v-07b74c72 data-v-07b74c72>/prod</code> to my URL paths in <code data-v-07b74c72 data-v-07b74c72>urls.py</code>, but the Django admin doesn't work properly because going to <code data-v-07b74c72 data-v-07b74c72>/prod/admin</code> will redirect you to <code data-v-07b74c72 data-v-07b74c72>/admin/login</code> which will thrown an error with API Gateway since our application must be on the <code data-v-07b74c72 data-v-07b74c72>/prod</code> subpath.</p>
<h2 id="setting-a-custom-url-for-api-gateway" data-v-07b74c72 data-v-07b74c72><a href="#setting-a-custom-url-for-api-gateway" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Setting a custom URL for API Gateway</h2>
<p data-v-07b74c72 data-v-07b74c72>If you don't mind having a URL in the form of <code data-v-07b74c72 data-v-07b74c72>https://abc123.execute-api.us-east-1.amazonaws.com/prod</code>, then everything should be good to go. If you do want a custom URL for API Gateway, there are only two things you need to do:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Get a domain and hosted zone set up in Route53 (this typically costs about $12/year)</li>
<li data-v-07b74c72 data-v-07b74c72>Add the <code data-v-07b74c72 data-v-07b74c72>DOMAIN_NAME</code> and the <code data-v-07b74c72 data-v-07b74c72>HOSTED_ZONE_ID</code> to environment variables (see below for how to do this)</li>
<li data-v-07b74c72 data-v-07b74c72>Define an ACM certificate in our CDK code and</li>
<li data-v-07b74c72 data-v-07b74c72>Use the <code data-v-07b74c72 data-v-07b74c72>LambdaRestApi</code>'s <code data-v-07b74c72 data-v-07b74c72>add_domain_name</code> method to add the domain name and certificate to the API Gateway endpoint.</li>
</ol>
<p data-v-07b74c72 data-v-07b74c72>Here's a <a href="https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_apigateway/LambdaRestApi.html#aws_cdk.aws_apigateway.LambdaRestApi.add_domain_name" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>link to the CDK Python documentation</a> on <code data-v-07b74c72 data-v-07b74c72>add_domain_name</code>.</p>
<p data-v-07b74c72 data-v-07b74c72>When you configure a custom domain name, you don't need to set the <code data-v-07b74c72 data-v-07b74c72>FORCE_SCRIPT_NAME</code> setting in Django settings.</p>
<h2 id="project-directory-structure" data-v-07b74c72 data-v-07b74c72><a href="#project-directory-structure" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Project directory structure</h2>
<p data-v-07b74c72 data-v-07b74c72>Let's take a quick look at the structure of the project using <code data-v-07b74c72 data-v-07b74c72>tree</code>:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>tree -L 3 .
.
├── awscdk
│   ├── app.py
│   ├── awscdk
│   │   ├── app_stack.py  &lt;----------------- CDK application overview
│   │   ├── backend_assets.py
│   │   ├── cert.py
│   │   ├── cloudfront.py
│   │   ├── hosted_zone.py
│   │   ├── __init__.py
│   │   ├── static_site_bucket.py
│   │   └── vpc.py &lt;------------------------ VPC, Lambdas, API Gateway and more
│   ├── cdk.json                             defined here
│   ├── README.md
│   ├── requirements.txt
│   ├── setup.py
│   └── source.bat
├── awslambda
│   └── proxy_lambda.py &lt;------------------- Proxy Lambda
├── django
│   ├── core &lt;------------------------------ A sample Django app
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── __init__.py
│   │   ├── migrations
│   │   ├── models.py
│   │   ├── tests.py
│   │   ├── urls.py
│   │   └── views.py
│   ├── djambda
│   │   ├── asgi.py
│   │   ├── awsgi.py &lt;---------------------- Django Lambda handler
│   │   ├── __init__.py
│   │   ├── settings.py &lt;------------------- Django settings (RDS connections, S3 static/media)
│   │   ├── storage_backends.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   ├── manage.py
│   └── requirements.txt
├── layers &lt;-------------------------------- Lambda Layers (python dependencies)
│   └── django                               Note: This folder is not committed to git
│       └── python
├── ARTICLE.md &lt;---------------------------- This article
├── gitlab-ci.yml
├── .variables &lt;---------------------------- Environment variables needed for deployment
└── README.md
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>The three top level folders are <code data-v-07b74c72 data-v-07b74c72>awscdk</code>, <code data-v-07b74c72 data-v-07b74c72>awslambda</code> and <code data-v-07b74c72 data-v-07b74c72>django</code>. To deploy our CDK code, we run the following command from the root of the project:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-bash" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>cdk deploy --app awscdk/app.py
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>We can also run <code data-v-07b74c72 data-v-07b74c72>cdk synth --app awscdk/app.py</code> to preview changes to our CDK code by reviewing the CloudFormation templates generated by <code data-v-07b74c72 data-v-07b74c72>cdk synth</code>. Running the <code data-v-07b74c72 data-v-07b74c72>cdk deploy</code> and <code data-v-07b74c72 data-v-07b74c72>cdk synth</code> commands at root of the project means that we need to specificy lambda code assets from the root of the project as well. This is why the Django application's Lambda function references the code with:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-py" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>code<span class="token operator" data-v-07b74c72 data-v-07b74c72>=</span>_lambda<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>.</span>AssetCode<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>(</span><span class="token string" data-v-07b74c72 data-v-07b74c72>'./django'</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>)</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>,</span>
</code></pre></div>
<h2 id="deploying" data-v-07b74c72 data-v-07b74c72><a href="#deploying" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Deploying</h2>
<p data-v-07b74c72 data-v-07b74c72>CDK is easy to use both locally and in a CI/CD tool such as GitLab CI, my CI/CD tool of choice. There are a few things to coordinate when deploying in both of these environments:</p>
<ol data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Environment variables</li>
<li data-v-07b74c72 data-v-07b74c72>Dependencies</li>
</ol>
<h3 id="deploying-from-a-terminal" data-v-07b74c72 data-v-07b74c72><a href="#deploying-from-a-terminal" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Deploying from a terminal</h3>
<p data-v-07b74c72 data-v-07b74c72>If you are new to CDK, you will need to make sure that you have ran the <code data-v-07b74c72 data-v-07b74c72>cdk bootstrap</code> command at least once on your account. This command sets up a CloudFormation stack that CDK uses internally to manage deployments.</p>
<p data-v-07b74c72 data-v-07b74c72>The environment variables needed for deployment are defined in <code data-v-07b74c72 data-v-07b74c72>.variables.template</code>:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>export APP_NAME=
export AWS_ACCESS_KEY_ID=
export AWS_ACCOUNT_ID=
export AWS_DEFAULT_REGION=
export AWS_SECRET_ACCESS_KEY=
export DOMAIN_NAME=
export HOSTED_ZONE_ID=
</code></pre></div>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>APP_NAME</code> should be a URL compatible name, such as <code data-v-07b74c72 data-v-07b74c72>my-app</code> (don't put <code data-v-07b74c72 data-v-07b74c72>.</code> in this variable)</li>
<li data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>DOMAIN_NAME</code> and <code data-v-07b74c72 data-v-07b74c72>HOSTED_ZONE_ID</code> are needed for adding a custom domain name to API Gateway</li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>Copy this template into a file in the root of the project called <code data-v-07b74c72 data-v-07b74c72>.variables</code> and set these environment variables with the following command:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>. .variables
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Next, we need to install our Python dependencies locally with the <code data-v-07b74c72 data-v-07b74c72>-t</code> target flag so that the Lambda layers we define in CDK can find the files needed to be packaged into our Lambda layer and made available to our Lambda function at runtime. Install dependencies to the target directory by running the following command from the root of the project:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>pip install -r django/requirements.txt -t layers/django/python
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Now we can deploy our serverless application to AWS using CDK. First, activate the CDK Python virtual environment with:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>source awscdk/.env/bin/activate
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Also make sure that you are using a version of Node.js greater or equal to 10. I do this with <code data-v-07b74c72 data-v-07b74c72>nvm use 13</code>.</p>
<p data-v-07b74c72 data-v-07b74c72>Make sure that all of the dependencies defined in <code data-v-07b74c72 data-v-07b74c72>awscdk/setup.py</code> are up-to-date. Make sure that there are no issues witht the CDK code by running:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>cdk synth --app awscdk/app.py
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Inspect the contents of <code data-v-07b74c72 data-v-07b74c72>cdk.out</code>; these are the CloudFormation templates generated by CDK that will be used to deploy all of our resources. If everything looks good to go, deploy with the following command:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-text" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72>cdk synth --app awscdk/app.py
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>Follow the output of this command and ensure that it completes successfully. You can also follow along in the CloudFormation section of the AWS management console to make sure that things are deploying properly.</p>
<p data-v-07b74c72 data-v-07b74c72>Once everything has finished deploying, you will need to run <code data-v-07b74c72 data-v-07b74c72>migrate</code>, <code data-v-07b74c72 data-v-07b74c72>createsuperuser</code> and <code data-v-07b74c72 data-v-07b74c72>collecstatic</code> after the first deployment.</p>
<blockquote data-v-07b74c72 data-v-07b74c72>
<p data-v-07b74c72 data-v-07b74c72>TODO: consolidate these steps with a Makefile or bash script</p>
</blockquote>
<h3 id="deploying-with-gitlab-ci" data-v-07b74c72 data-v-07b74c72><a href="#deploying-with-gitlab-ci" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Deploying with GitLab CI</h3>
<p data-v-07b74c72 data-v-07b74c72>Deploying locally is fine, but it is better to run CDK commands from a CI/CD process so we can keep track of the commits, pipeline results, commit messages, etc. The process is very similar to everything we do locally, but you will need to add environment variables to the GitLab project's Settings > CI/CD > Variables. I have broken out dependency installation into a separate stage. This is not entirely necessary, but it helps keep things easy to follow:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-yaml" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token key atrule" data-v-07b74c72 data-v-07b74c72>pip_install</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>stage</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> build
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>artifacts</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>paths</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
      <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> layers/django/python
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> pip install <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>r django/requirements.txt <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>t layers/django/python

<span class="token key atrule" data-v-07b74c72 data-v-07b74c72>cdk_deploy</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>stage</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> deploy
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>before_script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> apt<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>get <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>qq update <span class="token important" data-v-07b74c72 data-v-07b74c72>&&</span> apt<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>get <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>y install nodejs npm
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> npm i <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>g aws<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>cdk
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> pip3 install <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>e awscdk
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> cdk bootstrap <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>app awscdk/app.py aws<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>//$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> cdk deploy <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>app awscdk/app.py <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>require<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span>approval never
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>For management commands, we use a <code data-v-07b74c72 data-v-07b74c72>.base_task</code> template and reuse this for each command:</p>
<div class="nuxt-content-highlight" data-v-07b74c72 data-v-07b74c72><pre class="line-numbers language-yaml" data-v-07b74c72 data-v-07b74c72><code data-v-07b74c72 data-v-07b74c72><span class="token key atrule" data-v-07b74c72 data-v-07b74c72>.base_task</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token important" data-v-07b74c72 data-v-07b74c72>&task</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>image</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> python<span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span><span class="token number" data-v-07b74c72 data-v-07b74c72>3.8</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>stage</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> deploy
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>rules</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>when</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> manual
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>before_script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> pip install awscli
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>after_script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> cat invoke_response.json

<span class="token key atrule" data-v-07b74c72 data-v-07b74c72>migrate</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>&lt;&lt;</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span> <span class="token important" data-v-07b74c72 data-v-07b74c72>*task</span>
  <span class="token key atrule" data-v-07b74c72 data-v-07b74c72>script</span><span class="token punctuation" data-v-07b74c72 data-v-07b74c72>:</span>
    <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>-</span> <span class="token punctuation" data-v-07b74c72 data-v-07b74c72>|</span><span class="token scalar string" data-v-07b74c72 data-v-07b74c72>
      aws lambda invoke \
        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \
        --payload '{"manage": "migrate --no-input"}' \
        invoke_response.json</span>
</code></pre></div>
<p data-v-07b74c72 data-v-07b74c72>These are <code data-v-07b74c72 data-v-07b74c72>manual</code> commands, and can be started through the GitLab CI interface by pressing the "Play" button on the pipeline.</p>
<h2 id="next-steps" data-v-07b74c72 data-v-07b74c72><a href="#next-steps" aria-hidden="true" tabindex="-1" data-v-07b74c72 data-v-07b74c72><span class="icon icon-link" data-v-07b74c72 data-v-07b74c72></span></a>Next Steps</h2>
<p data-v-07b74c72 data-v-07b74c72>I still have lots of ideas and things to try out with this Django/Lambda architecture. Here are a few things that would be good to try:</p>
<ul data-v-07b74c72 data-v-07b74c72>
<li data-v-07b74c72 data-v-07b74c72>Using another Lambda function that proxies web requests to a Lambda outside of the VPC for basic network requests using either <code data-v-07b74c72 data-v-07b74c72>urllib.request</code> or <code data-v-07b74c72 data-v-07b74c72>requests</code>. This would be the easiest way to add simple internet access without needing a NAT Gateway</li>
<li data-v-07b74c72 data-v-07b74c72>Use a NAT provider to add a cheap NAT instance using a <code data-v-07b74c72 data-v-07b74c72>t3a.nano</code> instance ( about $5.00/month) to allow for internet access in the Django request/response cycle</li>
<li data-v-07b74c72 data-v-07b74c72>Figure out a good solution for async processing. Zappa has a <code data-v-07b74c72 data-v-07b74c72>@task</code> wrapper that allows you to run tasks asynchronously in separate Lambda functions. It would be interesting to experiment with direct invocation of async tasks as well as task queueing with SQS. Using SQS would involve a VPC Endpoint which does cost extra, or we could setup a dedicated SQS proxy function to do this in a way similar to how we would handle requests.</li>
<li data-v-07b74c72 data-v-07b74c72>Lambda tuning. I'm pretty new to using Lambda and I would like to better understand how to fine-tune Lambda settings. There are lots of options in the <code data-v-07b74c72 data-v-07b74c72>_lambda.Function</code> construct, which would be a good place to start. This would be especially important for async tasks that require high memeory. From the <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>Lambda Developer Guide</a> it looks like memory can be configured from 128 MB to 3,008 MB in 64 MB increments.</li>
<li data-v-07b74c72 data-v-07b74c72>I typically setup Vue.js frontends with S3/CloudFront and use Django only for the admin and API with Django REST Framework. From what I understand, API Gateway uses CloudFront in the backround to do custom domains, but you don't have access to this CloudFront distribution. You can add the <code data-v-07b74c72 data-v-07b74c72>execute-api</code> URL as a Custom Origin for a single CloudFront distribution, or keep a CloudFront distribution separate from the API Gateway custom domain and serve these on different subdomains, such as <code data-v-07b74c72 data-v-07b74c72>api.mysite.com</code> for the API Gateway domain name and <code data-v-07b74c72 data-v-07b74c72>mysite.com</code> for the CloudFront distribution serving Vue.js files.</li>
<li data-v-07b74c72 data-v-07b74c72>Pricing. I'm still unsure about exactly how much this setup costs. The only major costs should be Aurora Postgres Serverless if it is used heavily, but I'm still not sure about how the pricing for this service works. Here's an in-depth article from Jeremy Daly that has more information on Aurora Serverless: <a href="https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/" rel="nofollow noopener noreferrer" target="_blank" data-v-07b74c72 data-v-07b74c72>https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/</a></li>
</ul>
<p data-v-07b74c72 data-v-07b74c72>Thanks for reading!</p></div> <div class="text-center pb-4 pt-8" data-v-07b74c72><button class="mc-btn rounded py-1 px-2" data-v-07b74c72>
        Show Disqus Comments 💬
      </button></div> <!----> <h1 data-v-07b74c72></h1></div></article> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-7b3a3fe4><hr class="mt-4" data-v-7b3a3fe4> <div class="mx-auto py-4" data-v-7b3a3fe4><div class="pb-4" data-v-7b3a3fe4>
      Join my mailing list to get updated whenever I publish a new article.
    </div> <div class="mx-auto" data-v-89248ae4 data-v-7b3a3fe4><div id="mc_embed_signup" class="mx-auto w-full md:w-1/2" data-v-89248ae4><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-89248ae4><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center" data-v-89248ae4><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Enter your email address" class="rounded mc text-center" data-v-89248ae4> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-89248ae4><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-89248ae4></div> <div data-v-89248ae4><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="Subscribe" class="mc-btn rounded px-2 py-1 w-full" data-v-89248ae4></div></div></form></div></div></div> <hr data-v-7b3a3fe4> <div class="py-4" data-v-7b3a3fe4>
    Thanks for checking out my site!
  </div> <div class="pb-4" data-v-7b3a3fe4>
    © 2023 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1682868278/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html/state.js"></script><script src="/_nuxt/2600eb3.js" defer></script><script src="/_nuxt/9d8324e.js" defer></script><script src="/_nuxt/9ee0ef6.js" defer></script><script src="/_nuxt/f51c3d4.js" defer></script><script src="/_nuxt/d4698ff.js" defer></script>
  </body>
</html>
