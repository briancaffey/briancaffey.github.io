[{"data":1,"prerenderedAt":18910},["ShallowReactive",2],{"all-articles":3},[4,7815,13922],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"date":11,"image":12,"tags":13,"draft":7,"external":25,"comments":44,"body":45,"_type":7809,"_id":7810,"_source":7811,"_file":7812,"_stem":7813,"_extension":7814},"/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","07",false,"","My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi","Three reusable infrastructure as code libraries for abstracting containerized web app architecture on AWS ECS","2023-01-07","/static/iac_rosetta_stone_og_image.png",[14,15,16,17,18,19,20,21,22,23,24],"django","cdk","terraform","pulumi","cloudformation","github-actions","aws","ecs","fargate","containers","docker",[26,29,32,35,38,41],{"link":27,"site":28},"https://news.ycombinator.com/item?id=34291336","hn",{"link":30,"site":31},"https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/","reddit",{"link":33,"site":34},"https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4","dev",{"link":36,"site":37},"https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a","medium",{"link":39,"site":40},"https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions","hashnode",{"link":42,"site":43},"https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta","substack",true,{"type":46,"children":47,"toc":7754},"root",[48,57,63,149,154,159,164,183,189,197,210,218,236,244,262,270,302,317,339,347,365,373,386,394,423,429,436,441,475,481,486,499,504,525,562,583,588,641,647,652,700,706,746,760,774,780,835,881,895,907,913,918,1037,1049,1269,1281,1286,1292,1332,1338,1343,1377,1404,1412,1420,1428,1436,1444,1452,1460,1468,1474,1486,1497,1505,1516,1524,1535,1543,1549,1554,1587,1592,1597,1606,1611,1617,1630,1670,1675,1718,1723,1756,1763,1775,1806,1818,1824,1829,1867,1872,1877,1891,1961,1966,1979,1985,1990,2033,2039,2052,2060,2066,2071,2084,2089,2095,2107,2137,2158,2163,2168,2355,2361,2366,2389,2394,2399,2405,2417,2422,2427,2609,2622,2630,2643,2681,2686,2691,2720,2725,2761,2767,2772,2825,2851,2857,2862,2867,2875,2881,2909,2926,2932,2944,3022,3027,3101,3109,3117,3123,3128,3149,3155,3160,3165,3171,3214,3219,3254,3259,3265,3278,3297,3303,3336,3354,3366,3427,3432,3815,3820,3964,3969,3974,3979,4715,4720,5038,5043,6012,6018,6023,6089,6095,6116,6131,6136,6190,6196,6201,6214,6219,6269,6289,6299,6429,6434,6597,6602,6652,6657,6822,6843,6965,6970,6976,6988,6993,7001,7013,7021,7027,7035,7062,7076,7094,7107,7112,7130,7135,7147,7153,7178,7184,7276,7289,7299,7304,7316,7322,7340,7366,7371,7377,7427,7433,7438,7614,7620,7625,7723,7728,7734,7748],{"type":49,"tag":50,"props":51,"children":53},"element","h2",{"id":52},"tldr",[54],{"type":55,"value":56},"text","tl;dr",{"type":49,"tag":58,"props":59,"children":60},"p",{},[61],{"type":55,"value":62},"I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions.",{"type":49,"tag":64,"props":65,"children":66},"ul",{},[67,88,104,120],{"type":49,"tag":68,"props":69,"children":70},"li",{},[71,77,79],{"type":49,"tag":72,"props":73,"children":74},"strong",{},[75],{"type":55,"value":76},"CDK Construct Library",{"type":55,"value":78},": ",{"type":49,"tag":80,"props":81,"children":85},"a",{"href":82,"rel":83},"https://github.com/briancaffey/cdk-django",[84],"nofollow",[86],{"type":55,"value":87},"github.com/briancaffey/cdk-django",{"type":49,"tag":68,"props":89,"children":90},{},[91,96,97],{"type":49,"tag":72,"props":92,"children":93},{},[94],{"type":55,"value":95},"Terraform Modules",{"type":55,"value":78},{"type":49,"tag":80,"props":98,"children":101},{"href":99,"rel":100},"https://github.com/briancaffey/terraform-aws-django",[84],[102],{"type":55,"value":103},"github.com/briancaffey/terraform-aws-django",{"type":49,"tag":68,"props":105,"children":106},{},[107,112,113],{"type":49,"tag":72,"props":108,"children":109},{},[110],{"type":55,"value":111},"Pulumi Component Library",{"type":55,"value":78},{"type":49,"tag":80,"props":114,"children":117},{"href":115,"rel":116},"https://github.com/briancaffey/pulumi-aws-django",[84],[118],{"type":55,"value":119},"github.com/briancaffey/pulumi-aws-django",{"type":49,"tag":68,"props":121,"children":122},{},[123,125,131,133,140,142],{"type":55,"value":124},"Mono repo with a sample Django micro blogging app (μblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that ",{"type":49,"tag":126,"props":127,"children":128},"em",{},[129],{"type":55,"value":130},"consumes",{"type":55,"value":132}," each of the libraries listed above, ",{"type":49,"tag":80,"props":134,"children":137},{"href":135,"rel":136},"https://briancaffey.github.io/django-step-by-step/",[84],[138],{"type":55,"value":139},"VuePress documentation site",{"type":55,"value":141}," and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): ",{"type":49,"tag":80,"props":143,"children":146},{"href":144,"rel":145},"https://github.com/briancaffey/django-step-by-step",[84],[147],{"type":55,"value":148},"github.com/briancaffey/django-step-by-step",{"type":49,"tag":50,"props":150,"children":152},{"id":151},"eli5",[153],{"type":55,"value":151},{"type":49,"tag":58,"props":155,"children":156},{},[157],{"type":55,"value":158},"Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use.",{"type":49,"tag":58,"props":160,"children":161},{},[162],{"type":55,"value":163},"Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers.",{"type":49,"tag":58,"props":165,"children":166},{},[167,169,174,176,181],{"type":55,"value":168},"The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos ",{"type":49,"tag":126,"props":170,"children":171},{},[172],{"type":55,"value":173},"to YouTube",{"type":55,"value":175},", but the code I'm writing allows you to upload any type of website (even site YouTube) ",{"type":49,"tag":126,"props":177,"children":178},{},[179],{"type":55,"value":180},"to the internet",{"type":55,"value":182},". When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach.",{"type":49,"tag":50,"props":184,"children":186},{"id":185},"why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi",[187],{"type":55,"value":188},"Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi",{"type":49,"tag":58,"props":190,"children":191},{},[192],{"type":49,"tag":72,"props":193,"children":194},{},[195],{"type":55,"value":196},"To push me to learn more about AWS, IaC, CI/CD, automation, and Platform Engineering",{"type":49,"tag":64,"props":198,"children":199},{},[200,205],{"type":49,"tag":68,"props":201,"children":202},{},[203],{"type":55,"value":204},"Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate).",{"type":49,"tag":68,"props":206,"children":207},{},[208],{"type":55,"value":209},"Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward",{"type":49,"tag":58,"props":211,"children":212},{},[213],{"type":49,"tag":72,"props":214,"children":215},{},[216],{"type":55,"value":217},"To fail as many times as possible",{"type":49,"tag":64,"props":219,"children":220},{},[221,226,231],{"type":49,"tag":68,"props":222,"children":223},{},[224],{"type":55,"value":225},"Every time I fail when I think I have things right, I learn something new",{"type":49,"tag":68,"props":227,"children":228},{},[229],{"type":55,"value":230},"Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production",{"type":49,"tag":68,"props":232,"children":233},{},[234],{"type":55,"value":235},"You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important",{"type":49,"tag":58,"props":237,"children":238},{},[239],{"type":49,"tag":72,"props":240,"children":241},{},[242],{"type":55,"value":243},"To take an application-first approach to DevOps",{"type":49,"tag":64,"props":245,"children":246},{},[247,252,257],{"type":49,"tag":68,"props":248,"children":249},{},[250],{"type":55,"value":251},"Application developers are increasingly being tasked with operational duties",{"type":49,"tag":68,"props":253,"children":254},{},[255],{"type":55,"value":256},"While learning about IaC, I had a hard time finding in-depth materials covering application development, CI/CD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image",{"type":49,"tag":68,"props":258,"children":259},{},[260],{"type":55,"value":261},"You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind",{"type":49,"tag":58,"props":263,"children":264},{},[265],{"type":49,"tag":72,"props":266,"children":267},{},[268],{"type":55,"value":269},"To develop a project I can reference when helping myself and others",{"type":49,"tag":64,"props":271,"children":272},{},[273,278,290],{"type":49,"tag":68,"props":274,"children":275},{},[276],{"type":55,"value":277},"companies and projects that do IaC and CI/CD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor",{"type":49,"tag":68,"props":279,"children":280},{},[281,283,288],{"type":55,"value":282},"Hopefully, the sample application, IaC, and CI/CD pipelines ",{"type":49,"tag":126,"props":284,"children":285},{},[286],{"type":55,"value":287},"aren't overly complex",{"type":55,"value":289},". There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on",{"type":49,"tag":68,"props":291,"children":292},{},[293,295,300],{"type":55,"value":294},"People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to ",{"type":49,"tag":72,"props":296,"children":297},{},[298],{"type":55,"value":299},"show",{"type":55,"value":301}," people how it can be done",{"type":49,"tag":58,"props":303,"children":304},{},[305],{"type":49,"tag":72,"props":306,"children":307},{},[308,310,315],{"type":55,"value":309},"To encourage others (specifically Developer Advocates / Developer Relations / Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software ",{"type":49,"tag":72,"props":311,"children":312},{},[313],{"type":55,"value":314},"in use",{"type":55,"value":316}," with an actual application.",{"type":49,"tag":64,"props":318,"children":319},{},[320,334],{"type":49,"tag":68,"props":321,"children":322},{},[323,325,332],{"type":55,"value":324},"There are many ways one could create an \"IaC Rosetta Stone\" (",{"type":49,"tag":326,"props":327,"children":329},"code",{"className":328},[],[330],{"type":55,"value":331},"public cloud providers x CI/CD providers x IaC tools",{"type":55,"value":333}," is a big number)",{"type":49,"tag":68,"props":335,"children":336},{},[337],{"type":55,"value":338},"This takes a lot of effort and time",{"type":49,"tag":58,"props":340,"children":341},{},[342],{"type":49,"tag":72,"props":343,"children":344},{},[345],{"type":55,"value":346},"I have nothing to sell you",{"type":49,"tag":64,"props":348,"children":349},{},[350,355,360],{"type":49,"tag":68,"props":351,"children":352},{},[353],{"type":55,"value":354},"So many articles about Cloud/DevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here",{"type":49,"tag":68,"props":356,"children":357},{},[358],{"type":55,"value":359},"I'm also not trying to sell anyone on using my IaC packages",{"type":49,"tag":68,"props":361,"children":362},{},[363],{"type":55,"value":364},"Hopefully, my IaC packages can serve as a helpful reference or starting point",{"type":49,"tag":58,"props":366,"children":367},{},[368],{"type":49,"tag":72,"props":369,"children":370},{},[371],{"type":55,"value":372},"Walk before running",{"type":49,"tag":64,"props":374,"children":375},{},[376,381],{"type":49,"tag":68,"props":377,"children":378},{},[379],{"type":55,"value":380},"I want to build up confidence with vanilla use cases before getting too fancy",{"type":49,"tag":68,"props":382,"children":383},{},[384],{"type":55,"value":385},"With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)",{"type":49,"tag":58,"props":387,"children":388},{},[389],{"type":49,"tag":72,"props":390,"children":391},{},[392],{"type":55,"value":393},"12 Factor App, DevOps, and Platform Engineering",{"type":49,"tag":64,"props":395,"children":396},{},[397,409],{"type":49,"tag":68,"props":398,"children":399},{},[400,407],{"type":49,"tag":80,"props":401,"children":404},{"href":402,"rel":403},"https://12factor.net/",[84],[405],{"type":55,"value":406},"12 Factor App",{"type":55,"value":408}," is great and has guided how I approach both Django application development and IaC library development",{"type":49,"tag":68,"props":410,"children":411},{},[412,414,421],{"type":55,"value":413},"The ",{"type":49,"tag":80,"props":415,"children":418},{"href":416,"rel":417},"https://platformengineering.org/",[84],[419],{"type":55,"value":420},"platformengineering.org",{"type":55,"value":422}," community has some good guiding principles",{"type":49,"tag":50,"props":424,"children":426},{"id":425},"cdkterraformpulumi-terminology",[427],{"type":55,"value":428},"CDK/Terraform/Pulumi terminology",{"type":49,"tag":430,"props":431,"children":433},"h3",{"id":432},"constructs-modules-and-components",[434],{"type":55,"value":435},"constructs, modules and components",{"type":49,"tag":58,"props":437,"children":438},{},[439],{"type":55,"value":440},"A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources.",{"type":49,"tag":58,"props":442,"children":443},{},[444,446,451,453,458,460,465,467,473],{"type":55,"value":445},"In this article I will refer to ",{"type":49,"tag":72,"props":447,"children":448},{},[449],{"type":55,"value":450},"constructs/modules/components",{"type":55,"value":452}," as ",{"type":49,"tag":72,"props":454,"children":455},{},[456],{"type":55,"value":457},"c/m/c",{"type":55,"value":459}," for short, and the term ",{"type":49,"tag":72,"props":461,"children":462},{},[463],{"type":55,"value":464},"stack",{"type":55,"value":466}," can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had ",{"type":49,"tag":326,"props":468,"children":470},{"className":469},[],[471],{"type":55,"value":472},"apply",{"type":55,"value":474}," ran against it.",{"type":49,"tag":430,"props":476,"children":478},{"id":477},"what-is-a-stack",[479],{"type":55,"value":480},"what is a stack?",{"type":49,"tag":58,"props":482,"children":483},{},[484],{"type":55,"value":485},"AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module.",{"type":49,"tag":58,"props":487,"children":488},{},[489,491,497],{"type":55,"value":490},"CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the ",{"type":49,"tag":326,"props":492,"children":494},{"className":493},[],[495],{"type":55,"value":496},"@pulumi/aws",{"type":55,"value":498}," package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses).",{"type":49,"tag":430,"props":500,"children":502},{"id":501},"verbs",[503],{"type":55,"value":501},{"type":49,"tag":58,"props":505,"children":506},{},[507,509,515,517,523],{"type":55,"value":508},"In CDK you ",{"type":49,"tag":326,"props":510,"children":512},{"className":511},[],[513],{"type":55,"value":514},"synth",{"type":55,"value":516}," CDK code to generate CloudFormation templates. You can also run ",{"type":49,"tag":326,"props":518,"children":520},{"className":519},[],[521],{"type":55,"value":522},"diff",{"type":55,"value":524}," to see what changes would be applied during a stack update.",{"type":49,"tag":58,"props":526,"children":527},{},[528,530,536,538,544,546,552,554,560],{"type":55,"value":529},"In Terraform you ",{"type":49,"tag":326,"props":531,"children":533},{"className":532},[],[534],{"type":55,"value":535},"init",{"type":55,"value":537}," to download all providers and modules. This is sort of like running ",{"type":49,"tag":326,"props":539,"children":541},{"className":540},[],[542],{"type":55,"value":543},"npm install",{"type":55,"value":545}," in CDK and Pulumi. You then run ",{"type":49,"tag":326,"props":547,"children":549},{"className":548},[],[550],{"type":55,"value":551},"terraform plan",{"type":55,"value":553}," to see the changes that would result. ",{"type":49,"tag":326,"props":555,"children":557},{"className":556},[],[558],{"type":55,"value":559},"terraform apply",{"type":55,"value":561}," does CRUD operations on your cloud resources.",{"type":49,"tag":58,"props":563,"children":564},{},[565,567,573,575,581],{"type":55,"value":566},"In Pulumi you run ",{"type":49,"tag":326,"props":568,"children":570},{"className":569},[],[571],{"type":55,"value":572},"pulumi preview",{"type":55,"value":574}," to see what changes would be made to a stack. You can use the ",{"type":49,"tag":326,"props":576,"children":578},{"className":577},[],[579],{"type":55,"value":580},"--diff",{"type":55,"value":582}," flag to see the specifics of what would change.",{"type":49,"tag":58,"props":584,"children":585},{},[586],{"type":55,"value":587},"To summarize:",{"type":49,"tag":64,"props":589,"children":590},{},[591,596,617,630],{"type":49,"tag":68,"props":592,"children":593},{},[594],{"type":55,"value":595},"In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time",{"type":49,"tag":68,"props":597,"children":598},{},[599,601,606,608,615],{"type":55,"value":600},"In Terraform you plan a configuration made up of modules, and then run ",{"type":49,"tag":326,"props":602,"children":604},{"className":603},[],[605],{"type":55,"value":559},{"type":55,"value":607}," to build the configuration/stack (",{"type":49,"tag":80,"props":609,"children":612},{"href":610,"rel":611},"https://discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",[84],[613],{"type":55,"value":614},"discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",{"type":55,"value":616},")",{"type":49,"tag":68,"props":618,"children":619},{},[620,622,628],{"type":55,"value":621},"Pulumi: You preview a Pulumi stack made up of components, and then run ",{"type":49,"tag":326,"props":623,"children":625},{"className":624},[],[626],{"type":55,"value":627},"pulumi up",{"type":55,"value":629}," to build the resources",{"type":49,"tag":68,"props":631,"children":632},{},[633,635],{"type":55,"value":634},"To tear down a stack in all three tools, you run ",{"type":49,"tag":326,"props":636,"children":638},{"className":637},[],[639],{"type":55,"value":640},"destroy",{"type":49,"tag":50,"props":642,"children":644},{"id":643},"infrastructure-as-code-library-repos",[645],{"type":55,"value":646},"Infrastructure as Code library repos",{"type":49,"tag":58,"props":648,"children":649},{},[650],{"type":55,"value":651},"Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate.",{"type":49,"tag":64,"props":653,"children":654},{},[655,670,685],{"type":49,"tag":68,"props":656,"children":657},{},[658,660],{"type":55,"value":659},"CDK: ",{"type":49,"tag":80,"props":661,"children":663},{"href":82,"rel":662},[84],[664],{"type":49,"tag":326,"props":665,"children":667},{"className":666},[],[668],{"type":55,"value":669},"cdk-django",{"type":49,"tag":68,"props":671,"children":672},{},[673,675],{"type":55,"value":674},"Terraform: ",{"type":49,"tag":80,"props":676,"children":678},{"href":99,"rel":677},[84],[679],{"type":49,"tag":326,"props":680,"children":682},{"className":681},[],[683],{"type":55,"value":684},"terraform-aws-django",{"type":49,"tag":68,"props":686,"children":687},{},[688,690],{"type":55,"value":689},"Pulumi: ",{"type":49,"tag":80,"props":691,"children":693},{"href":115,"rel":692},[84],[694],{"type":49,"tag":326,"props":695,"children":697},{"className":696},[],[698],{"type":55,"value":699},"pulumi-aws-django",{"type":49,"tag":430,"props":701,"children":703},{"id":702},"language",[704],{"type":55,"value":705},"Language",{"type":49,"tag":58,"props":707,"children":708},{},[709,714,716,721,723,728,730,735,737,744],{"type":49,"tag":326,"props":710,"children":712},{"className":711},[],[713],{"type":55,"value":669},{"type":55,"value":715}," and ",{"type":49,"tag":326,"props":717,"children":719},{"className":718},[],[720],{"type":55,"value":699},{"type":55,"value":722}," are both written in TypeScript. ",{"type":49,"tag":326,"props":724,"children":726},{"className":725},[],[727],{"type":55,"value":684},{"type":55,"value":729}," is written in HCL, a domain specific language created by HashiCorp. The ",{"type":49,"tag":326,"props":731,"children":733},{"className":732},[],[734],{"type":55,"value":669},{"type":55,"value":736}," is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using ",{"type":49,"tag":80,"props":738,"children":741},{"href":739,"rel":740},"https://github.com/aws/jsii",[84],[742],{"type":55,"value":743},"jsii",{"type":55,"value":745},".",{"type":49,"tag":58,"props":747,"children":748},{},[749,751,758],{"type":55,"value":750},"My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See ",{"type":49,"tag":80,"props":752,"children":755},{"href":753,"rel":754},"https://github.com/pulumi/pulumi-component-provider-ts-boilerplate",[84],[756],{"type":55,"value":757},"this GitHub repo",{"type":55,"value":759}," for more information on this.",{"type":49,"tag":58,"props":761,"children":762},{},[763,765,772],{"type":55,"value":764},"The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called ",{"type":49,"tag":80,"props":766,"children":769},{"href":767,"rel":768},"https://developer.hashicorp.com/terraform/cdktf",[84],[770],{"type":55,"value":771},"CDKTF",{"type":55,"value":773}," which allows you to write HCL Terraform in TypeScript, but I haven't used it yet.",{"type":49,"tag":430,"props":775,"children":777},{"id":776},"release-management-versioning-and-publishing",[778],{"type":55,"value":779},"Release management, versioning and publishing",{"type":49,"tag":58,"props":781,"children":782},{},[783,788,789,794,796,802,804,809,811,817,819,825,827,833],{"type":49,"tag":326,"props":784,"children":786},{"className":785},[],[787],{"type":55,"value":699},{"type":55,"value":715},{"type":49,"tag":326,"props":790,"children":792},{"className":791},[],[793],{"type":55,"value":684},{"type":55,"value":795}," both use ",{"type":49,"tag":326,"props":797,"children":799},{"className":798},[],[800],{"type":55,"value":801},"release-please",{"type":55,"value":803}," for automatically generating a changelog file and bumping versions. ",{"type":49,"tag":326,"props":805,"children":807},{"className":806},[],[808],{"type":55,"value":801},{"type":55,"value":810}," is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to ",{"type":49,"tag":326,"props":812,"children":814},{"className":813},[],[815],{"type":55,"value":816},"main",{"type":55,"value":818},", a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in ",{"type":49,"tag":326,"props":820,"children":822},{"className":821},[],[823],{"type":55,"value":824},"package.json",{"type":55,"value":826}," and adds a new git tag (e.g. ",{"type":49,"tag":326,"props":828,"children":830},{"className":829},[],[831],{"type":55,"value":832},"v1.2.3",{"type":55,"value":834},") based on commit messages.",{"type":49,"tag":58,"props":836,"children":837},{},[838,843,845,856,858,864,866,872,874,879],{"type":49,"tag":326,"props":839,"children":841},{"className":840},[],[842],{"type":55,"value":669},{"type":55,"value":844}," uses ",{"type":49,"tag":80,"props":846,"children":849},{"href":847,"rel":848},"https://github.com/projen/projen",[84],[850],{"type":49,"tag":326,"props":851,"children":853},{"className":852},[],[854],{"type":55,"value":855},"projen",{"type":55,"value":857}," for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file (",{"type":49,"tag":326,"props":859,"children":861},{"className":860},[],[862],{"type":55,"value":863},".projenrc.ts",{"type":55,"value":865},") to configure your entire repo, including files like ",{"type":49,"tag":326,"props":867,"children":869},{"className":868},[],[870],{"type":55,"value":871},"tsconfig.json",{"type":55,"value":873},", ",{"type":49,"tag":326,"props":875,"children":877},{"className":876},[],[878],{"type":55,"value":824},{"type":55,"value":880},", and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action.",{"type":49,"tag":58,"props":882,"children":883},{},[884,886,893],{"type":55,"value":885},"These tools are both based on ",{"type":49,"tag":80,"props":887,"children":890},{"href":888,"rel":889},"https://www.conventionalcommits.org/en/v1.0.0/",[84],[891],{"type":55,"value":892},"conventional commits",{"type":55,"value":894}," to automatically update the Changelog file.",{"type":49,"tag":58,"props":896,"children":897},{},[898,900,905],{"type":55,"value":899},"I'm still manually publishing my ",{"type":49,"tag":326,"props":901,"children":903},{"className":902},[],[904],{"type":55,"value":699},{"type":55,"value":906}," package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!",{"type":49,"tag":430,"props":908,"children":910},{"id":909},"makefile-examples-and-local-development",[911],{"type":55,"value":912},"Makefile, examples and local development",{"type":49,"tag":58,"props":914,"children":915},{},[916],{"type":55,"value":917},"Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:",{"type":49,"tag":64,"props":919,"children":920},{},[921,933,943,953,971,987,998,1008,1027],{"type":49,"tag":68,"props":922,"children":923},{},[924,926,931],{"type":55,"value":925},"synthesizing CDK to CloudFormation / running ",{"type":49,"tag":326,"props":927,"children":929},{"className":928},[],[930],{"type":55,"value":551},{"type":55,"value":932}," / previewing pulumi up for both the base and app stacks",{"type":49,"tag":68,"props":934,"children":935},{},[936,938],{"type":55,"value":937},"creating/updating an ad hoc base stack called ",{"type":49,"tag":326,"props":939,"children":941},{"className":940},[],[942],{"type":55,"value":34},{"type":49,"tag":68,"props":944,"children":945},{},[946,948],{"type":55,"value":947},"destroying resources in the ad-hoc base stack called ",{"type":49,"tag":326,"props":949,"children":951},{"className":950},[],[952],{"type":55,"value":34},{"type":49,"tag":68,"props":954,"children":955},{},[956,958,964,966],{"type":55,"value":957},"creating an ad hoc app stack called ",{"type":49,"tag":326,"props":959,"children":961},{"className":960},[],[962],{"type":55,"value":963},"alpha",{"type":55,"value":965}," that uses resources from ",{"type":49,"tag":326,"props":967,"children":969},{"className":968},[],[970],{"type":55,"value":34},{"type":49,"tag":68,"props":972,"children":973},{},[974,976,981,982],{"type":55,"value":975},"destroying an ad hoc app stack called ",{"type":49,"tag":326,"props":977,"children":979},{"className":978},[],[980],{"type":55,"value":963},{"type":55,"value":965},{"type":49,"tag":326,"props":983,"children":985},{"className":984},[],[986],{"type":55,"value":34},{"type":49,"tag":68,"props":988,"children":989},{},[990,992],{"type":55,"value":991},"creating/updating a prod base stack called ",{"type":49,"tag":326,"props":993,"children":995},{"className":994},[],[996],{"type":55,"value":997},"stage",{"type":49,"tag":68,"props":999,"children":1000},{},[1001,1003],{"type":55,"value":1002},"destroying resources in the prod base stack called ",{"type":49,"tag":326,"props":1004,"children":1006},{"className":1005},[],[1007],{"type":55,"value":997},{"type":49,"tag":68,"props":1009,"children":1010},{},[1011,1013,1018,1020,1025],{"type":55,"value":1012},"creating a prod app stack using called ",{"type":49,"tag":326,"props":1014,"children":1016},{"className":1015},[],[1017],{"type":55,"value":997},{"type":55,"value":1019}," that uses resources from the ",{"type":49,"tag":326,"props":1021,"children":1023},{"className":1022},[],[1024],{"type":55,"value":997},{"type":55,"value":1026}," base stack",{"type":49,"tag":68,"props":1028,"children":1029},{},[1030,1032],{"type":55,"value":1031},"destroying resources in the prod app stack called ",{"type":49,"tag":326,"props":1033,"children":1035},{"className":1034},[],[1036],{"type":55,"value":997},{"type":49,"tag":58,"props":1038,"children":1039},{},[1040,1042,1047],{"type":55,"value":1041},"Here's an example of what these commands look like in ",{"type":49,"tag":326,"props":1043,"children":1045},{"className":1044},[],[1046],{"type":55,"value":699},{"type":55,"value":1048}," for prod infrastructure base and app stacks:",{"type":49,"tag":1050,"props":1051,"children":1055},"pre",{"code":1052,"language":1053,"meta":8,"className":1054,"style":8},"prod-base-preview:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive preview\n\nprod-base-up:   build\n    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n\nprod-base-destroy:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n\nprod-app-preview:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview\n\nprod-app-preview-diff:  build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n\nprod-app-up:    build\n    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n\nprod-app-destroy:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n","make","language-make shiki shiki-themes github-light github-dark monokai",[1056],{"type":49,"tag":326,"props":1057,"children":1058},{"__ignoreMap":8},[1059,1077,1086,1095,1109,1118,1126,1139,1148,1156,1169,1178,1186,1199,1208,1216,1230,1239,1247,1260],{"type":49,"tag":1060,"props":1061,"children":1064},"span",{"class":1062,"line":1063},"line",1,[1065,1071],{"type":49,"tag":1060,"props":1066,"children":1068},{"style":1067},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1069],{"type":55,"value":1070},"prod-base-preview",{"type":49,"tag":1060,"props":1072,"children":1074},{"style":1073},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[1075],{"type":55,"value":1076},":  build\n",{"type":49,"tag":1060,"props":1078,"children":1080},{"class":1062,"line":1079},2,[1081],{"type":49,"tag":1060,"props":1082,"children":1083},{"style":1073},[1084],{"type":55,"value":1085},"    pulumi -C examples/prod/base --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1087,"children":1089},{"class":1062,"line":1088},3,[1090],{"type":49,"tag":1060,"props":1091,"children":1092},{"emptyLinePlaceholder":44},[1093],{"type":55,"value":1094},"\n",{"type":49,"tag":1060,"props":1096,"children":1098},{"class":1062,"line":1097},4,[1099,1104],{"type":49,"tag":1060,"props":1100,"children":1101},{"style":1067},[1102],{"type":55,"value":1103},"prod-base-up",{"type":49,"tag":1060,"props":1105,"children":1106},{"style":1073},[1107],{"type":55,"value":1108},":   build\n",{"type":49,"tag":1060,"props":1110,"children":1112},{"class":1062,"line":1111},5,[1113],{"type":49,"tag":1060,"props":1114,"children":1115},{"style":1073},[1116],{"type":55,"value":1117},"    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1119,"children":1121},{"class":1062,"line":1120},6,[1122],{"type":49,"tag":1060,"props":1123,"children":1124},{"emptyLinePlaceholder":44},[1125],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1127,"children":1129},{"class":1062,"line":1128},7,[1130,1135],{"type":49,"tag":1060,"props":1131,"children":1132},{"style":1067},[1133],{"type":55,"value":1134},"prod-base-destroy",{"type":49,"tag":1060,"props":1136,"children":1137},{"style":1073},[1138],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1140,"children":1142},{"class":1062,"line":1141},8,[1143],{"type":49,"tag":1060,"props":1144,"children":1145},{"style":1073},[1146],{"type":55,"value":1147},"    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":1060,"props":1149,"children":1151},{"class":1062,"line":1150},9,[1152],{"type":49,"tag":1060,"props":1153,"children":1154},{"emptyLinePlaceholder":44},[1155],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1157,"children":1159},{"class":1062,"line":1158},10,[1160,1165],{"type":49,"tag":1060,"props":1161,"children":1162},{"style":1067},[1163],{"type":55,"value":1164},"prod-app-preview",{"type":49,"tag":1060,"props":1166,"children":1167},{"style":1073},[1168],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1170,"children":1172},{"class":1062,"line":1171},11,[1173],{"type":49,"tag":1060,"props":1174,"children":1175},{"style":1073},[1176],{"type":55,"value":1177},"    pulumi -C examples/prod/app --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1179,"children":1181},{"class":1062,"line":1180},12,[1182],{"type":49,"tag":1060,"props":1183,"children":1184},{"emptyLinePlaceholder":44},[1185],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1187,"children":1189},{"class":1062,"line":1188},13,[1190,1195],{"type":49,"tag":1060,"props":1191,"children":1192},{"style":1067},[1193],{"type":55,"value":1194},"prod-app-preview-diff",{"type":49,"tag":1060,"props":1196,"children":1197},{"style":1073},[1198],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1200,"children":1202},{"class":1062,"line":1201},14,[1203],{"type":49,"tag":1060,"props":1204,"children":1205},{"style":1073},[1206],{"type":55,"value":1207},"    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n",{"type":49,"tag":1060,"props":1209,"children":1211},{"class":1062,"line":1210},15,[1212],{"type":49,"tag":1060,"props":1213,"children":1214},{"emptyLinePlaceholder":44},[1215],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1217,"children":1219},{"class":1062,"line":1218},16,[1220,1225],{"type":49,"tag":1060,"props":1221,"children":1222},{"style":1067},[1223],{"type":55,"value":1224},"prod-app-up",{"type":49,"tag":1060,"props":1226,"children":1227},{"style":1073},[1228],{"type":55,"value":1229},":    build\n",{"type":49,"tag":1060,"props":1231,"children":1233},{"class":1062,"line":1232},17,[1234],{"type":49,"tag":1060,"props":1235,"children":1236},{"style":1073},[1237],{"type":55,"value":1238},"    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1240,"children":1242},{"class":1062,"line":1241},18,[1243],{"type":49,"tag":1060,"props":1244,"children":1245},{"emptyLinePlaceholder":44},[1246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1248,"children":1250},{"class":1062,"line":1249},19,[1251,1256],{"type":49,"tag":1060,"props":1252,"children":1253},{"style":1067},[1254],{"type":55,"value":1255},"prod-app-destroy",{"type":49,"tag":1060,"props":1257,"children":1258},{"style":1073},[1259],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1261,"children":1263},{"class":1062,"line":1262},20,[1264],{"type":49,"tag":1060,"props":1265,"children":1266},{"style":1073},[1267],{"type":55,"value":1268},"    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":58,"props":1270,"children":1271},{},[1272,1274,1279],{"type":55,"value":1273},"I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the ",{"type":49,"tag":326,"props":1275,"children":1277},{"className":1276},[],[1278],{"type":55,"value":457},{"type":55,"value":1280},"s to create environments and smoke check the environments to make sure everything works correctly.",{"type":49,"tag":58,"props":1282,"children":1283},{},[1284],{"type":55,"value":1285},"Adding unit tests is another item for the backlog.",{"type":49,"tag":430,"props":1287,"children":1289},{"id":1288},"ad-hoc-vs-prod",[1290],{"type":55,"value":1291},"ad-hoc vs prod",{"type":49,"tag":64,"props":1293,"children":1294},{},[1295,1307,1312,1317,1322,1327],{"type":49,"tag":68,"props":1296,"children":1297},{},[1298,1305],{"type":49,"tag":80,"props":1299,"children":1302},{"href":1300,"rel":1301},"https://briancaffey.github.io/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",[84],[1303],{"type":55,"value":1304},"the last article I wrote was about ad hoc environments",{"type":55,"value":1306},". Also known as \"on-demand\" environments or \"preview\" environments.",{"type":49,"tag":68,"props":1308,"children":1309},{},[1310],{"type":55,"value":1311},"the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)",{"type":49,"tag":68,"props":1313,"children":1314},{},[1315],{"type":55,"value":1316},"you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)",{"type":49,"tag":68,"props":1318,"children":1319},{},[1320],{"type":55,"value":1321},"prod can be used for a production environment and any number of pre-production environments",{"type":49,"tag":68,"props":1323,"children":1324},{},[1325],{"type":55,"value":1326},"multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)",{"type":49,"tag":68,"props":1328,"children":1329},{},[1330],{"type":55,"value":1331},"the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment",{"type":49,"tag":430,"props":1333,"children":1335},{"id":1334},"directory-structure",[1336],{"type":55,"value":1337},"Directory structure",{"type":49,"tag":58,"props":1339,"children":1340},{},[1341],{"type":55,"value":1342},"The directory structures for each repo are all similar with some minor differences.",{"type":49,"tag":58,"props":1344,"children":1345},{},[1346,1348,1354,1355,1361,1363,1369,1370,1376],{"type":55,"value":1347},"There are two types of environments: ",{"type":49,"tag":326,"props":1349,"children":1351},{"className":1350},[],[1352],{"type":55,"value":1353},"ad-hoc",{"type":55,"value":715},{"type":49,"tag":326,"props":1356,"children":1358},{"className":1357},[],[1359],{"type":55,"value":1360},"prod",{"type":55,"value":1362},". Within ad-hoc and production, there are two directories ",{"type":49,"tag":326,"props":1364,"children":1366},{"className":1365},[],[1367],{"type":55,"value":1368},"base",{"type":55,"value":715},{"type":49,"tag":326,"props":1371,"children":1373},{"className":1372},[],[1374],{"type":55,"value":1375},"app",{"type":55,"value":745},{"type":49,"tag":58,"props":1378,"children":1379},{},[1380,1382,1388,1390,1395,1397,1402],{"type":55,"value":1381},"Each repo has a directory called ",{"type":49,"tag":326,"props":1383,"children":1385},{"className":1384},[],[1386],{"type":55,"value":1387},"internal",{"type":55,"value":1389}," which contain building blocks used by the ",{"type":49,"tag":326,"props":1391,"children":1393},{"className":1392},[],[1394],{"type":55,"value":457},{"type":55,"value":1396},"s that are exposed. The contents of the ",{"type":49,"tag":326,"props":1398,"children":1400},{"className":1399},[],[1401],{"type":55,"value":1387},{"type":55,"value":1403}," directories are not intended to be used by anyone who is using the libraries.",{"type":49,"tag":58,"props":1405,"children":1406},{},[1407],{"type":49,"tag":72,"props":1408,"children":1409},{},[1410],{"type":55,"value":1411},"CDK construct library repo structure",{"type":49,"tag":1050,"props":1413,"children":1415},{"code":1414},"~/git/github/cdk-django$ tree -L 4 -d src/\nsrc/\n├── constructs\n│   ├── ad-hoc\n│   │   ├── app\n│   │   └── base\n│   ├── internal\n│   │   ├── alb\n│   │   ├── bastion\n│   │   ├── customResources\n│   │   │   └── highestPriorityRule\n│   │   ├── ecs\n│   │   │   ├── iam\n│   │   │   ├── management-command\n│   │   │   ├── redis\n│   │   │   ├── scheduler\n│   │   │   ├── web\n│   │   │   └── worker\n│   │   ├── rds\n│   │   ├── sg\n│   │   └── vpc\n│   └── prod\n│       ├── app\n│       └── base\n└── examples\n    └── ad-hoc\n        ├── app\n        │   └── config\n        └── base\n            └── config\n",[1416],{"type":49,"tag":326,"props":1417,"children":1418},{"__ignoreMap":8},[1419],{"type":55,"value":1414},{"type":49,"tag":58,"props":1421,"children":1422},{},[1423],{"type":49,"tag":72,"props":1424,"children":1425},{},[1426],{"type":55,"value":1427},"Terraform module library repo structure",{"type":49,"tag":1050,"props":1429,"children":1431},{"code":1430},"~/git/github/terraform-aws-django$ tree -L 4 -d modules\nmodules\n├── ad-hoc\n│   ├── app\n│   └── base\n├── internal\n│   ├── alb\n│   ├── autoscaling\n│   ├── bastion\n│   ├── ecs\n│   │   ├── ad-hoc\n│   │   │   ├── celery_beat\n│   │   │   ├── celery_worker\n│   │   │   ├── cluster\n│   │   │   ├── management_command\n│   │   │   ├── redis\n│   │   │   └── web\n│   │   └── prod\n│   │       ├── celery_beat\n│   │       ├── celery_worker\n│   │       ├── cluster\n│   │       ├── management_command\n│   │       └── web\n│   ├── elasticache\n│   ├── iam\n│   ├── rds\n│   ├── route53\n│   ├── s3\n│   ├── sd\n│   └── sg\n└── prod\n    ├── app\n    └── base\n",[1432],{"type":49,"tag":326,"props":1433,"children":1434},{"__ignoreMap":8},[1435],{"type":55,"value":1430},{"type":49,"tag":58,"props":1437,"children":1438},{},[1439],{"type":49,"tag":72,"props":1440,"children":1441},{},[1442],{"type":55,"value":1443},"Pulumi component library repo structure",{"type":49,"tag":1050,"props":1445,"children":1447},{"code":1446},"~/git/github/pulumi-aws-django$ tree -L 3 src/\nsrc/\n├── components\n│   ├── ad-hoc\n│   │   ├── README.md\n│   │   ├── app\n│   │   └── base\n│   └── internal\n│       ├── README.md\n│       ├── alb\n│       ├── bastion\n│       ├── cw\n│       ├── ecs\n│       ├── iam\n│       ├── rds\n│       └── sg\n└── util\n    ├── index.ts\n    └── taggable.ts\n",[1448],{"type":49,"tag":326,"props":1449,"children":1450},{"__ignoreMap":8},[1451],{"type":55,"value":1446},{"type":49,"tag":58,"props":1453,"children":1454},{},[1455],{"type":49,"tag":72,"props":1456,"children":1457},{},[1458],{"type":55,"value":1459},"Pulumi examples directory",{"type":49,"tag":1050,"props":1461,"children":1463},{"code":1462},"~/git/github/pulumi-aws-django$ tree -L 3 examples/\nexamples/\n└── ad-hoc\n    ├── app\n    │   ├── Pulumi.alpha.yaml\n    │   ├── Pulumi.yaml\n    │   ├── index.ts\n    │   ├── node_modules\n    │   ├── package-lock.json\n    │   ├── package.json\n    │   └── tsconfig.json\n    └── base\n        ├── Pulumi.yaml\n        ├── bin\n        ├── index.ts\n        ├── package-lock.json\n        ├── package.json\n        └── tsconfig.json\n",[1464],{"type":49,"tag":326,"props":1465,"children":1466},{"__ignoreMap":8},[1467],{"type":55,"value":1462},{"type":49,"tag":430,"props":1469,"children":1471},{"id":1470},"cloc",[1472],{"type":55,"value":1473},"CLOC",{"type":49,"tag":58,"props":1475,"children":1476},{},[1477,1479,1484],{"type":55,"value":1478},"Let's use CLOC (count lines of code) to compare the lines of code used in the ",{"type":49,"tag":326,"props":1480,"children":1482},{"className":1481},[],[1483],{"type":55,"value":457},{"type":55,"value":1485}," of CDK/CloudFormation/Terraform/Pulumi.",{"type":49,"tag":58,"props":1487,"children":1488},{},[1489],{"type":49,"tag":72,"props":1490,"children":1491},{},[1492],{"type":49,"tag":326,"props":1493,"children":1495},{"className":1494},[],[1496],{"type":55,"value":669},{"type":49,"tag":1050,"props":1498,"children":1500},{"code":1499},"~/git/github/cdk-django$ cloc src/constructs/\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n",[1501],{"type":49,"tag":326,"props":1502,"children":1503},{"__ignoreMap":8},[1504],{"type":55,"value":1499},{"type":49,"tag":58,"props":1506,"children":1507},{},[1508],{"type":49,"tag":72,"props":1509,"children":1510},{},[1511],{"type":49,"tag":326,"props":1512,"children":1514},{"className":1513},[],[1515],{"type":55,"value":684},{"type":49,"tag":1050,"props":1517,"children":1519},{"code":1518},"~/git/github/terraform-aws-django$ cloc modules/\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n",[1520],{"type":49,"tag":326,"props":1521,"children":1522},{"__ignoreMap":8},[1523],{"type":55,"value":1518},{"type":49,"tag":58,"props":1525,"children":1526},{},[1527],{"type":49,"tag":72,"props":1528,"children":1529},{},[1530],{"type":49,"tag":326,"props":1531,"children":1533},{"className":1532},[],[1534],{"type":55,"value":699},{"type":49,"tag":1050,"props":1536,"children":1538},{"code":1537},"~/git/github/pulumi-aws-django$ cloc src/components/\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n",[1539],{"type":49,"tag":326,"props":1540,"children":1541},{"__ignoreMap":8},[1542],{"type":55,"value":1537},{"type":49,"tag":50,"props":1544,"children":1546},{"id":1545},"communities",[1547],{"type":55,"value":1548},"Communities",{"type":49,"tag":58,"props":1550,"children":1551},{},[1552],{"type":55,"value":1553},"The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!",{"type":49,"tag":64,"props":1555,"children":1556},{},[1557,1567,1577],{"type":49,"tag":68,"props":1558,"children":1559},{},[1560],{"type":49,"tag":80,"props":1561,"children":1564},{"href":1562,"rel":1563},"https://cdk.dev/",[84],[1565],{"type":55,"value":1566},"cdk.dev",{"type":49,"tag":68,"props":1568,"children":1569},{},[1570],{"type":49,"tag":80,"props":1571,"children":1574},{"href":1572,"rel":1573},"https://discuss.hashicorp.com/c/terraform-core/27",[84],[1575],{"type":55,"value":1576},"Terraform Section of HashiCorp Discuss Forum",{"type":49,"tag":68,"props":1578,"children":1579},{},[1580],{"type":49,"tag":80,"props":1581,"children":1584},{"href":1582,"rel":1583},"https://slack.pulumi.com/",[84],[1585],{"type":55,"value":1586},"Pulumi Slack",{"type":49,"tag":50,"props":1588,"children":1590},{"id":1589},"μblog",[1591],{"type":55,"value":1589},{"type":49,"tag":58,"props":1593,"children":1594},{},[1595],{"type":55,"value":1596},"μblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:",{"type":49,"tag":58,"props":1598,"children":1599},{},[1600],{"type":49,"tag":1601,"props":1602,"children":1605},"img",{"alt":1603,"src":1604},"ublog","/static/ublog_screenshot.png",[],{"type":49,"tag":58,"props":1607,"children":1608},{},[1609],{"type":55,"value":1610},"It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts.",{"type":49,"tag":430,"props":1612,"children":1614},{"id":1613},"mono-repo-structure",[1615],{"type":55,"value":1616},"Mono-repo structure",{"type":49,"tag":58,"props":1618,"children":1619},{},[1620,1622,1628],{"type":55,"value":1621},"It lives in a GitHub mono repo called ",{"type":49,"tag":326,"props":1623,"children":1625},{"className":1624},[],[1626],{"type":55,"value":1627},"django-step-by-step",{"type":55,"value":1629},". This mono repo contains a few different things:",{"type":49,"tag":64,"props":1631,"children":1632},{},[1633,1638,1643,1665],{"type":49,"tag":68,"props":1634,"children":1635},{},[1636],{"type":55,"value":1637},"backend Django application",{"type":49,"tag":68,"props":1639,"children":1640},{},[1641],{"type":55,"value":1642},"frontend Vue.js application",{"type":49,"tag":68,"props":1644,"children":1645},{},[1646,1648,1653,1654,1659,1660],{"type":55,"value":1647},"IaC code that uses c/m/c from ",{"type":49,"tag":326,"props":1649,"children":1651},{"className":1650},[],[1652],{"type":55,"value":669},{"type":55,"value":873},{"type":49,"tag":326,"props":1655,"children":1657},{"className":1656},[],[1658],{"type":55,"value":684},{"type":55,"value":715},{"type":49,"tag":326,"props":1661,"children":1663},{"className":1662},[],[1664],{"type":55,"value":699},{"type":49,"tag":68,"props":1666,"children":1667},{},[1668],{"type":55,"value":1669},"GitHub Actions workflows for both Infrastructure deployments and application deployments",{"type":49,"tag":58,"props":1671,"children":1672},{},[1673],{"type":55,"value":1674},"μblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. μblog is meant to represent a generic 12 Factor application that uses:",{"type":49,"tag":64,"props":1676,"children":1677},{},[1678,1683,1688,1693,1698,1703,1708,1713],{"type":49,"tag":68,"props":1679,"children":1680},{},[1681],{"type":55,"value":1682},"gunicorn for a backend API",{"type":49,"tag":68,"props":1684,"children":1685},{},[1686],{"type":55,"value":1687},"Vue.js for a client that consumes the backend API",{"type":49,"tag":68,"props":1689,"children":1690},{},[1691],{"type":55,"value":1692},"celery for async task processing",{"type":49,"tag":68,"props":1694,"children":1695},{},[1696],{"type":55,"value":1697},"celery beat for scheduling tasks",{"type":49,"tag":68,"props":1699,"children":1700},{},[1701],{"type":55,"value":1702},"Postgres for relational data",{"type":49,"tag":68,"props":1704,"children":1705},{},[1706],{"type":55,"value":1707},"Redis for caching and message brokering",{"type":49,"tag":68,"props":1709,"children":1710},{},[1711],{"type":55,"value":1712},"S3 for object storage",{"type":49,"tag":68,"props":1714,"children":1715},{},[1716],{"type":55,"value":1717},"Django admin for a simple admin interface",{"type":49,"tag":58,"props":1719,"children":1720},{},[1721],{"type":55,"value":1722},"There is a lot more I could add on μblog. For now I'll just mention that it:",{"type":49,"tag":64,"props":1724,"children":1725},{},[1726,1731,1736,1741,1746],{"type":49,"tag":68,"props":1727,"children":1728},{},[1729],{"type":55,"value":1730},"has a great local development environment (supports both docker-compose and virtual environments)",{"type":49,"tag":68,"props":1732,"children":1733},{},[1734],{"type":55,"value":1735},"demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL.",{"type":49,"tag":68,"props":1737,"children":1738},{},[1739],{"type":55,"value":1740},"GitHub Actions for running unit tests",{"type":49,"tag":68,"props":1742,"children":1743},{},[1744],{"type":55,"value":1745},"k6 for load testing",{"type":49,"tag":68,"props":1747,"children":1748},{},[1749,1751],{"type":55,"value":1750},"contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: ",{"type":49,"tag":80,"props":1752,"children":1754},{"href":135,"rel":1753},[84],[1755],{"type":55,"value":135},{"type":49,"tag":1757,"props":1758,"children":1760},"h1",{"id":1759},"infrastructure-deep-dive",[1761],{"type":55,"value":1762},"Infrastructure Deep Dive",{"type":49,"tag":58,"props":1764,"children":1765},{},[1766,1768,1773],{"type":55,"value":1767},"Let's go through each of the ",{"type":49,"tag":326,"props":1769,"children":1771},{"className":1770},[],[1772],{"type":55,"value":457},{"type":55,"value":1774},"s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi.",{"type":49,"tag":58,"props":1776,"children":1777},{},[1778,1780,1785,1786,1791,1793,1798,1799,1804],{"type":55,"value":1779},"I'll first talk about the two stacks used in ad hoc environments: ",{"type":49,"tag":326,"props":1781,"children":1783},{"className":1782},[],[1784],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1787,"children":1789},{"className":1788},[],[1790],{"type":55,"value":1375},{"type":55,"value":1792},". Then I'll talk about the prod environments which are also composed of ",{"type":49,"tag":326,"props":1794,"children":1796},{"className":1795},[],[1797],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1800,"children":1802},{"className":1801},[],[1803],{"type":55,"value":1375},{"type":55,"value":1805}," stacks.",{"type":49,"tag":58,"props":1807,"children":1808},{},[1809,1811,1816],{"type":55,"value":1810},"Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, ",{"type":49,"tag":72,"props":1812,"children":1813},{},[1814],{"type":55,"value":1815},"especially with Terraform",{"type":55,"value":1817},". In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried).",{"type":49,"tag":50,"props":1819,"children":1821},{"id":1820},"splitting-up-the-stacks",[1822],{"type":55,"value":1823},"Splitting up the stacks",{"type":49,"tag":58,"props":1825,"children":1826},{},[1827],{"type":55,"value":1828},"While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so.",{"type":49,"tag":64,"props":1830,"children":1831},{},[1832,1843,1855],{"type":49,"tag":68,"props":1833,"children":1834},{},[1835,1837],{"type":55,"value":1836},"Terraform enables this with outputs and ",{"type":49,"tag":326,"props":1838,"children":1840},{"className":1839},[],[1841],{"type":55,"value":1842},"terraform_remote_state",{"type":49,"tag":68,"props":1844,"children":1845},{},[1846,1848],{"type":55,"value":1847},"Pulumi encourages the use of ",{"type":49,"tag":80,"props":1849,"children":1852},{"href":1850,"rel":1851},"https://www.pulumi.com/docs/guides/organizing-projects-stacks/",[84],[1853],{"type":55,"value":1854},"micro stacks",{"type":49,"tag":68,"props":1856,"children":1857},{},[1858,1860],{"type":55,"value":1859},"CDK has an article on how to ",{"type":49,"tag":80,"props":1861,"children":1864},{"href":1862,"rel":1863},"https://docs.aws.amazon.com/cdk/v2/guide/stack_how_to_create_multiple_stacks.html",[84],[1865],{"type":55,"value":1866},"create an app with multiple stacks",{"type":49,"tag":58,"props":1868,"children":1869},{},[1870],{"type":55,"value":1871},"My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack.",{"type":49,"tag":58,"props":1873,"children":1874},{},[1875],{"type":55,"value":1876},"Also, on-demand environments really lends itself to stacks that are split up.",{"type":49,"tag":58,"props":1878,"children":1879},{},[1880,1882,1889],{"type":55,"value":1881},"In the section ",{"type":49,"tag":80,"props":1883,"children":1886},{"href":1884,"rel":1885},"https://docs.aws.amazon.com/cdk/v2/guide/resources.html",[84],[1887],{"type":55,"value":1888},"\"Passing unique identifiers\"",{"type":55,"value":1890},", the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app.",{"type":49,"tag":58,"props":1892,"children":1893},{},[1894,1896,1901,1903,1908,1910,1915,1917,1923,1924,1930,1932,1937,1939,1945,1946,1952,1953,1959],{"type":55,"value":1895},"There is a balance to be found between single stacks vs micro stacks. Both the base and app ",{"type":49,"tag":326,"props":1897,"children":1899},{"className":1898},[],[1900],{"type":55,"value":457},{"type":55,"value":1902},"s could be split out further. For example, the ",{"type":49,"tag":326,"props":1904,"children":1906},{"className":1905},[],[1907],{"type":55,"value":1368},{"type":55,"value":1909}," ",{"type":49,"tag":326,"props":1911,"children":1913},{"className":1912},[],[1914],{"type":55,"value":457},{"type":55,"value":1916},"s could be split into ",{"type":49,"tag":326,"props":1918,"children":1920},{"className":1919},[],[1921],{"type":55,"value":1922},"networking",{"type":55,"value":715},{"type":49,"tag":326,"props":1925,"children":1927},{"className":1926},[],[1928],{"type":55,"value":1929},"rds",{"type":55,"value":1931},". The ",{"type":49,"tag":326,"props":1933,"children":1935},{"className":1934},[],[1936],{"type":55,"value":1375},{"type":55,"value":1938}," stack could be split into different ECS services so that their infrastructure can be deployed independently, like ",{"type":49,"tag":326,"props":1940,"children":1942},{"className":1941},[],[1943],{"type":55,"value":1944},"cluster",{"type":55,"value":873},{"type":49,"tag":326,"props":1947,"children":1949},{"className":1948},[],[1950],{"type":55,"value":1951},"backend",{"type":55,"value":715},{"type":49,"tag":326,"props":1954,"children":1956},{"className":1955},[],[1957],{"type":55,"value":1958},"frontend",{"type":55,"value":1960},". The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article.",{"type":49,"tag":58,"props":1962,"children":1963},{},[1964],{"type":55,"value":1965},"My rules of thumbs are:",{"type":49,"tag":64,"props":1967,"children":1968},{},[1969,1974],{"type":49,"tag":68,"props":1970,"children":1971},{},[1972],{"type":55,"value":1973},"single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change",{"type":49,"tag":68,"props":1975,"children":1976},{},[1977],{"type":55,"value":1978},"Lots of small stacks can cause overhead and make things more complex than they need to be",{"type":49,"tag":50,"props":1980,"children":1982},{"id":1981},"ad-hoc-base-overview",[1983],{"type":55,"value":1984},"Ad hoc base overview",{"type":49,"tag":58,"props":1986,"children":1987},{},[1988],{"type":55,"value":1989},"Here's an overview of the resources used in an ad hoc base environment.",{"type":49,"tag":64,"props":1991,"children":1992},{},[1993,1998,2003,2008,2013,2018,2023,2028],{"type":49,"tag":68,"props":1994,"children":1995},{},[1996],{"type":55,"value":1997},"(Inputs)",{"type":49,"tag":68,"props":1999,"children":2000},{},[2001],{"type":55,"value":2002},"(Optional environment configs)",{"type":49,"tag":68,"props":2004,"children":2005},{},[2006],{"type":55,"value":2007},"VPC and Service Discovery",{"type":49,"tag":68,"props":2009,"children":2010},{},[2011],{"type":55,"value":2012},"S3",{"type":49,"tag":68,"props":2014,"children":2015},{},[2016],{"type":55,"value":2017},"Security Groups",{"type":49,"tag":68,"props":2019,"children":2020},{},[2021],{"type":55,"value":2022},"Load Balancer",{"type":49,"tag":68,"props":2024,"children":2025},{},[2026],{"type":55,"value":2027},"RDS",{"type":49,"tag":68,"props":2029,"children":2030},{},[2031],{"type":55,"value":2032},"Bastion Host",{"type":49,"tag":430,"props":2034,"children":2036},{"id":2035},"visualization",[2037],{"type":55,"value":2038},"Visualization",{"type":49,"tag":58,"props":2040,"children":2041},{},[2042,2044,2050],{"type":55,"value":2043},"Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the ",{"type":49,"tag":326,"props":2045,"children":2047},{"className":2046},[],[2048],{"type":55,"value":2049},"Resources",{"type":55,"value":2051}," tab of the ad hoc base stack in the Pulumi console.",{"type":49,"tag":58,"props":2053,"children":2054},{},[2055],{"type":49,"tag":1601,"props":2056,"children":2059},{"alt":2057,"src":2058},"Graph view of ad hoc base infrastructure","/static/pulumi_ad_hoc_base_dep_graph.png",[],{"type":49,"tag":430,"props":2061,"children":2063},{"id":2062},"inputs",[2064],{"type":55,"value":2065},"Inputs",{"type":49,"tag":58,"props":2067,"children":2068},{},[2069],{"type":55,"value":2070},"There are only two required inputs for the ad hoc base stack",{"type":49,"tag":64,"props":2072,"children":2073},{},[2074,2079],{"type":49,"tag":68,"props":2075,"children":2076},{},[2077],{"type":55,"value":2078},"ACM certificate ARN",{"type":49,"tag":68,"props":2080,"children":2081},{},[2082],{"type":55,"value":2083},"Domain Name",{"type":49,"tag":58,"props":2085,"children":2086},{},[2087],{"type":55,"value":2088},"I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy/apply/up or synth/plan/preview.",{"type":49,"tag":430,"props":2090,"children":2092},{"id":2091},"vpc",[2093],{"type":55,"value":2094},"VPC",{"type":49,"tag":58,"props":2096,"children":2097},{},[2098,2100,2105],{"type":55,"value":2099},"The VPC is the first resource that is created as part of the ",{"type":49,"tag":326,"props":2101,"children":2103},{"className":2102},[],[2104],{"type":55,"value":1368},{"type":55,"value":2106}," stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources.",{"type":49,"tag":64,"props":2108,"children":2109},{},[2110,2121,2132],{"type":49,"tag":68,"props":2111,"children":2112},{},[2113,2119],{"type":49,"tag":326,"props":2114,"children":2116},{"className":2115},[],[2117],{"type":55,"value":2118},"awsx",{"type":55,"value":2120}," has a VPC module",{"type":49,"tag":68,"props":2122,"children":2123},{},[2124,2130],{"type":49,"tag":326,"props":2125,"children":2127},{"className":2126},[],[2128],{"type":55,"value":2129},"terraform-aws-vpc",{"type":55,"value":2131}," module",{"type":49,"tag":68,"props":2133,"children":2134},{},[2135],{"type":55,"value":2136},"L2 VPC Construct in CDK",{"type":49,"tag":58,"props":2138,"children":2139},{},[2140,2142,2148,2150,2156],{"type":55,"value":2141},"The setting in the Terraform VPC module ",{"type":49,"tag":326,"props":2143,"children":2145},{"className":2144},[],[2146],{"type":55,"value":2147},"one_nat_gateway_per_az = false",{"type":55,"value":2149}," doesn't seem to exist on the ",{"type":49,"tag":326,"props":2151,"children":2153},{"className":2152},[],[2154],{"type":55,"value":2155},"awsx.ec2.Vpc",{"type":55,"value":2157}," module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3.",{"type":49,"tag":430,"props":2159,"children":2161},{"id":2160},"security-groups",[2162],{"type":55,"value":2017},{"type":49,"tag":58,"props":2164,"children":2165},{},[2166],{"type":55,"value":2167},"Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups.",{"type":49,"tag":1050,"props":2169,"children":2173},{"code":2170,"language":2171,"meta":8,"className":2172,"style":8},"    const albSecurityGroup = new SecurityGroup(scope, 'AlbSecurityGroup', {\n      vpc: props.vpc,\n    });\n\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(443), 'HTTPS');\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(80), 'HTTP');\n","ts","language-ts shiki shiki-themes github-light github-dark monokai",[2174],{"type":49,"tag":326,"props":2175,"children":2176},{"__ignoreMap":8},[2177,2224,2232,2240,2247,2306],{"type":49,"tag":1060,"props":2178,"children":2179},{"class":1062,"line":1063},[2180,2186,2192,2198,2203,2208,2213,2219],{"type":49,"tag":1060,"props":2181,"children":2183},{"style":2182},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[2184],{"type":55,"value":2185},"    const",{"type":49,"tag":1060,"props":2187,"children":2189},{"style":2188},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[2190],{"type":55,"value":2191}," albSecurityGroup",{"type":49,"tag":1060,"props":2193,"children":2195},{"style":2194},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[2196],{"type":55,"value":2197}," =",{"type":49,"tag":1060,"props":2199,"children":2200},{"style":2194},[2201],{"type":55,"value":2202}," new",{"type":49,"tag":1060,"props":2204,"children":2205},{"style":1067},[2206],{"type":55,"value":2207}," SecurityGroup",{"type":49,"tag":1060,"props":2209,"children":2210},{"style":1073},[2211],{"type":55,"value":2212},"(scope, ",{"type":49,"tag":1060,"props":2214,"children":2216},{"style":2215},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[2217],{"type":55,"value":2218},"'AlbSecurityGroup'",{"type":49,"tag":1060,"props":2220,"children":2221},{"style":1073},[2222],{"type":55,"value":2223},", {\n",{"type":49,"tag":1060,"props":2225,"children":2226},{"class":1062,"line":1079},[2227],{"type":49,"tag":1060,"props":2228,"children":2229},{"style":1073},[2230],{"type":55,"value":2231},"      vpc: props.vpc,\n",{"type":49,"tag":1060,"props":2233,"children":2234},{"class":1062,"line":1088},[2235],{"type":49,"tag":1060,"props":2236,"children":2237},{"style":1073},[2238],{"type":55,"value":2239},"    });\n",{"type":49,"tag":1060,"props":2241,"children":2242},{"class":1062,"line":1097},[2243],{"type":49,"tag":1060,"props":2244,"children":2245},{"emptyLinePlaceholder":44},[2246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":2248,"children":2249},{"class":1062,"line":1111},[2250,2255,2260,2265,2270,2275,2280,2285,2291,2296,2301],{"type":49,"tag":1060,"props":2251,"children":2252},{"style":1073},[2253],{"type":55,"value":2254},"    albSecurityGroup.",{"type":49,"tag":1060,"props":2256,"children":2257},{"style":1067},[2258],{"type":55,"value":2259},"addIngressRule",{"type":49,"tag":1060,"props":2261,"children":2262},{"style":1073},[2263],{"type":55,"value":2264},"(Peer.",{"type":49,"tag":1060,"props":2266,"children":2267},{"style":1067},[2268],{"type":55,"value":2269},"anyIpv4",{"type":49,"tag":1060,"props":2271,"children":2272},{"style":1073},[2273],{"type":55,"value":2274},"(), Port.",{"type":49,"tag":1060,"props":2276,"children":2277},{"style":1067},[2278],{"type":55,"value":2279},"tcp",{"type":49,"tag":1060,"props":2281,"children":2282},{"style":1073},[2283],{"type":55,"value":2284},"(",{"type":49,"tag":1060,"props":2286,"children":2288},{"style":2287},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2289],{"type":55,"value":2290},"443",{"type":49,"tag":1060,"props":2292,"children":2293},{"style":1073},[2294],{"type":55,"value":2295},"), ",{"type":49,"tag":1060,"props":2297,"children":2298},{"style":2215},[2299],{"type":55,"value":2300},"'HTTPS'",{"type":49,"tag":1060,"props":2302,"children":2303},{"style":1073},[2304],{"type":55,"value":2305},");\n",{"type":49,"tag":1060,"props":2307,"children":2308},{"class":1062,"line":1120},[2309,2313,2317,2321,2325,2329,2333,2337,2342,2346,2351],{"type":49,"tag":1060,"props":2310,"children":2311},{"style":1073},[2312],{"type":55,"value":2254},{"type":49,"tag":1060,"props":2314,"children":2315},{"style":1067},[2316],{"type":55,"value":2259},{"type":49,"tag":1060,"props":2318,"children":2319},{"style":1073},[2320],{"type":55,"value":2264},{"type":49,"tag":1060,"props":2322,"children":2323},{"style":1067},[2324],{"type":55,"value":2269},{"type":49,"tag":1060,"props":2326,"children":2327},{"style":1073},[2328],{"type":55,"value":2274},{"type":49,"tag":1060,"props":2330,"children":2331},{"style":1067},[2332],{"type":55,"value":2279},{"type":49,"tag":1060,"props":2334,"children":2335},{"style":1073},[2336],{"type":55,"value":2284},{"type":49,"tag":1060,"props":2338,"children":2339},{"style":2287},[2340],{"type":55,"value":2341},"80",{"type":49,"tag":1060,"props":2343,"children":2344},{"style":1073},[2345],{"type":55,"value":2295},{"type":49,"tag":1060,"props":2347,"children":2348},{"style":2215},[2349],{"type":55,"value":2350},"'HTTP'",{"type":49,"tag":1060,"props":2352,"children":2353},{"style":1073},[2354],{"type":55,"value":2305},{"type":49,"tag":430,"props":2356,"children":2358},{"id":2357},"load-balancer-resources",[2359],{"type":55,"value":2360},"Load Balancer Resources",{"type":49,"tag":58,"props":2362,"children":2363},{},[2364],{"type":55,"value":2365},"There's not much to comment on here. In each library I have resource group that defines the following:",{"type":49,"tag":64,"props":2367,"children":2368},{},[2369,2374,2379,2384],{"type":49,"tag":68,"props":2370,"children":2371},{},[2372],{"type":55,"value":2373},"Application Load Balancer",{"type":49,"tag":68,"props":2375,"children":2376},{},[2377],{"type":55,"value":2378},"A default target group",{"type":49,"tag":68,"props":2380,"children":2381},{},[2382],{"type":55,"value":2383},"An HTTP listener that redirects to HTTPS",{"type":49,"tag":68,"props":2385,"children":2386},{},[2387],{"type":55,"value":2388},"An HTTPS listener with a default \"fixed-response\" action",{"type":49,"tag":58,"props":2390,"children":2391},{},[2392],{"type":55,"value":2393},"Properties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services.",{"type":49,"tag":58,"props":2395,"children":2396},{},[2397],{"type":55,"value":2398},"Ad hoc app environments all share a common load balancer from the base stack that they use.",{"type":49,"tag":430,"props":2400,"children":2402},{"id":2401},"rds-resources",[2403],{"type":55,"value":2404},"RDS Resources",{"type":49,"tag":58,"props":2406,"children":2407},{},[2408,2410,2415],{"type":55,"value":2409},"All three libraries have the RDS security group and Subnet Group in the same ",{"type":49,"tag":326,"props":2411,"children":2413},{"className":2412},[],[2414],{"type":55,"value":457},{"type":55,"value":2416}," as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources.",{"type":49,"tag":58,"props":2418,"children":2419},{},[2420],{"type":55,"value":2421},"Currently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment.",{"type":49,"tag":58,"props":2423,"children":2424},{},[2425],{"type":55,"value":2426},"The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential.",{"type":49,"tag":1050,"props":2428,"children":2430},{"code":2429,"language":2171,"meta":8,"className":2172,"style":8},"    const secret = new Secret(scope, 'dbSecret', {\n      secretName: props.dbSecretName,\n      description: 'secret for rds',\n      generateSecretString: {\n        secretStringTemplate: JSON.stringify({ username: 'postgres' }),\n        generateStringKey: 'password',\n        excludePunctuation: true,\n        includeSpace: false,\n      },\n    });\n",[2431],{"type":49,"tag":326,"props":2432,"children":2433},{"__ignoreMap":8},[2434,2472,2480,2498,2506,2543,2560,2577,2594,2602],{"type":49,"tag":1060,"props":2435,"children":2436},{"class":1062,"line":1063},[2437,2441,2446,2450,2454,2459,2463,2468],{"type":49,"tag":1060,"props":2438,"children":2439},{"style":2182},[2440],{"type":55,"value":2185},{"type":49,"tag":1060,"props":2442,"children":2443},{"style":2188},[2444],{"type":55,"value":2445}," secret",{"type":49,"tag":1060,"props":2447,"children":2448},{"style":2194},[2449],{"type":55,"value":2197},{"type":49,"tag":1060,"props":2451,"children":2452},{"style":2194},[2453],{"type":55,"value":2202},{"type":49,"tag":1060,"props":2455,"children":2456},{"style":1067},[2457],{"type":55,"value":2458}," Secret",{"type":49,"tag":1060,"props":2460,"children":2461},{"style":1073},[2462],{"type":55,"value":2212},{"type":49,"tag":1060,"props":2464,"children":2465},{"style":2215},[2466],{"type":55,"value":2467},"'dbSecret'",{"type":49,"tag":1060,"props":2469,"children":2470},{"style":1073},[2471],{"type":55,"value":2223},{"type":49,"tag":1060,"props":2473,"children":2474},{"class":1062,"line":1079},[2475],{"type":49,"tag":1060,"props":2476,"children":2477},{"style":1073},[2478],{"type":55,"value":2479},"      secretName: props.dbSecretName,\n",{"type":49,"tag":1060,"props":2481,"children":2482},{"class":1062,"line":1088},[2483,2488,2493],{"type":49,"tag":1060,"props":2484,"children":2485},{"style":1073},[2486],{"type":55,"value":2487},"      description: ",{"type":49,"tag":1060,"props":2489,"children":2490},{"style":2215},[2491],{"type":55,"value":2492},"'secret for rds'",{"type":49,"tag":1060,"props":2494,"children":2495},{"style":1073},[2496],{"type":55,"value":2497},",\n",{"type":49,"tag":1060,"props":2499,"children":2500},{"class":1062,"line":1097},[2501],{"type":49,"tag":1060,"props":2502,"children":2503},{"style":1073},[2504],{"type":55,"value":2505},"      generateSecretString: {\n",{"type":49,"tag":1060,"props":2507,"children":2508},{"class":1062,"line":1111},[2509,2514,2519,2523,2528,2533,2538],{"type":49,"tag":1060,"props":2510,"children":2511},{"style":1073},[2512],{"type":55,"value":2513},"        secretStringTemplate: ",{"type":49,"tag":1060,"props":2515,"children":2516},{"style":2188},[2517],{"type":55,"value":2518},"JSON",{"type":49,"tag":1060,"props":2520,"children":2521},{"style":1073},[2522],{"type":55,"value":745},{"type":49,"tag":1060,"props":2524,"children":2525},{"style":1067},[2526],{"type":55,"value":2527},"stringify",{"type":49,"tag":1060,"props":2529,"children":2530},{"style":1073},[2531],{"type":55,"value":2532},"({ username: ",{"type":49,"tag":1060,"props":2534,"children":2535},{"style":2215},[2536],{"type":55,"value":2537},"'postgres'",{"type":49,"tag":1060,"props":2539,"children":2540},{"style":1073},[2541],{"type":55,"value":2542}," }),\n",{"type":49,"tag":1060,"props":2544,"children":2545},{"class":1062,"line":1120},[2546,2551,2556],{"type":49,"tag":1060,"props":2547,"children":2548},{"style":1073},[2549],{"type":55,"value":2550},"        generateStringKey: ",{"type":49,"tag":1060,"props":2552,"children":2553},{"style":2215},[2554],{"type":55,"value":2555},"'password'",{"type":49,"tag":1060,"props":2557,"children":2558},{"style":1073},[2559],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2561,"children":2562},{"class":1062,"line":1128},[2563,2568,2573],{"type":49,"tag":1060,"props":2564,"children":2565},{"style":1073},[2566],{"type":55,"value":2567},"        excludePunctuation: ",{"type":49,"tag":1060,"props":2569,"children":2570},{"style":2287},[2571],{"type":55,"value":2572},"true",{"type":49,"tag":1060,"props":2574,"children":2575},{"style":1073},[2576],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2578,"children":2579},{"class":1062,"line":1141},[2580,2585,2590],{"type":49,"tag":1060,"props":2581,"children":2582},{"style":1073},[2583],{"type":55,"value":2584},"        includeSpace: ",{"type":49,"tag":1060,"props":2586,"children":2587},{"style":2287},[2588],{"type":55,"value":2589},"false",{"type":49,"tag":1060,"props":2591,"children":2592},{"style":1073},[2593],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2595,"children":2596},{"class":1062,"line":1150},[2597],{"type":49,"tag":1060,"props":2598,"children":2599},{"style":1073},[2600],{"type":55,"value":2601},"      },\n",{"type":49,"tag":1060,"props":2603,"children":2604},{"class":1062,"line":1158},[2605],{"type":49,"tag":1060,"props":2606,"children":2607},{"style":1073},[2608],{"type":55,"value":2239},{"type":49,"tag":58,"props":2610,"children":2611},{},[2612,2614,2620],{"type":55,"value":2613},"In the ",{"type":49,"tag":326,"props":2615,"children":2617},{"className":2616},[],[2618],{"type":55,"value":2619},"DatabaseInstance",{"type":55,"value":2621}," props we can then use this secret like so:",{"type":49,"tag":1050,"props":2623,"children":2625},{"code":2624},"    credentials: Credentials.fromSecret(secret),\n",[2626],{"type":49,"tag":326,"props":2627,"children":2628},{"__ignoreMap":8},[2629],{"type":55,"value":2624},{"type":49,"tag":58,"props":2631,"children":2632},{},[2633,2635,2641],{"type":55,"value":2634},"In the application deployed with CDK, I use a Django settings module package that uses a package called ",{"type":49,"tag":326,"props":2636,"children":2638},{"className":2637},[],[2639],{"type":55,"value":2640},"aws_secretsmanager_caching",{"type":55,"value":2642}," to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable.",{"type":49,"tag":58,"props":2644,"children":2645},{},[2646,2648,2654,2656,2667,2668,2679],{"type":55,"value":2647},"The Terraform and Pulumi database instance arguments simply accept a ",{"type":49,"tag":326,"props":2649,"children":2651},{"className":2650},[],[2652],{"type":55,"value":2653},"password",{"type":55,"value":2655}," field. This will be another item for the backlog for Terraform and Pulumi. The ",{"type":49,"tag":80,"props":2657,"children":2660},{"href":2658,"rel":2659},"https://www.pulumi.com/registry/packages/random/api-docs/randompassword/",[84],[2661],{"type":49,"tag":326,"props":2662,"children":2664},{"className":2663},[],[2665],{"type":55,"value":2666},"randompassword",{"type":55,"value":715},{"type":49,"tag":80,"props":2669,"children":2672},{"href":2670,"rel":2671},"https://www.pulumi.com/registry/packages/aws/api-docs/secretsmanager/secretversion/",[84],[2673],{"type":49,"tag":326,"props":2674,"children":2676},{"className":2675},[],[2677],{"type":55,"value":2678},"secretversion",{"type":55,"value":2680}," components can be used to do this.",{"type":49,"tag":430,"props":2682,"children":2684},{"id":2683},"bastion-host",[2685],{"type":55,"value":2032},{"type":49,"tag":58,"props":2687,"children":2688},{},[2689],{"type":55,"value":2690},"There are two main use cases for the bastion host in ad-hoc environments.",{"type":49,"tag":64,"props":2692,"children":2693},{},[2694,2707],{"type":49,"tag":68,"props":2695,"children":2696},{},[2697,2699,2705],{"type":55,"value":2698},"When creating a new ad hoc app environment, the bastion host is used to create a new database called ",{"type":49,"tag":326,"props":2700,"children":2702},{"className":2701},[],[2703],{"type":55,"value":2704},"{ad-hoc-env-name}-db",{"type":55,"value":2706}," that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now).",{"type":49,"tag":68,"props":2708,"children":2709},{},[2710,2712,2718],{"type":55,"value":2711},"If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to ",{"type":49,"tag":326,"props":2713,"children":2715},{"className":2714},[],[2716],{"type":55,"value":2717},"localhost:5432",{"type":55,"value":2719}," on your local machine.",{"type":49,"tag":58,"props":2721,"children":2722},{},[2723],{"type":55,"value":2724},"You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:",{"type":49,"tag":1050,"props":2726,"children":2730},{"code":2727,"language":2728,"meta":8,"className":2729,"style":8},"aws ssm start-session --target $INSTANCE_ID\n","bash","language-bash shiki shiki-themes github-light github-dark monokai",[2731],{"type":49,"tag":326,"props":2732,"children":2733},{"__ignoreMap":8},[2734],{"type":49,"tag":1060,"props":2735,"children":2736},{"class":1062,"line":1063},[2737,2741,2746,2751,2756],{"type":49,"tag":1060,"props":2738,"children":2739},{"style":1067},[2740],{"type":55,"value":20},{"type":49,"tag":1060,"props":2742,"children":2743},{"style":2215},[2744],{"type":55,"value":2745}," ssm",{"type":49,"tag":1060,"props":2747,"children":2748},{"style":2215},[2749],{"type":55,"value":2750}," start-session",{"type":49,"tag":1060,"props":2752,"children":2753},{"style":2287},[2754],{"type":55,"value":2755}," --target",{"type":49,"tag":1060,"props":2757,"children":2758},{"style":1073},[2759],{"type":55,"value":2760}," $INSTANCE_ID\n",{"type":49,"tag":430,"props":2762,"children":2764},{"id":2763},"outputs",[2765],{"type":55,"value":2766},"Outputs",{"type":49,"tag":58,"props":2768,"children":2769},{},[2770],{"type":55,"value":2771},"Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:",{"type":49,"tag":64,"props":2773,"children":2774},{},[2775,2780,2785,2790,2795,2800,2805,2810,2815,2820],{"type":49,"tag":68,"props":2776,"children":2777},{},[2778],{"type":55,"value":2779},"vpc_id",{"type":49,"tag":68,"props":2781,"children":2782},{},[2783],{"type":55,"value":2784},"assets_bucket_name",{"type":49,"tag":68,"props":2786,"children":2787},{},[2788],{"type":55,"value":2789},"private_subnet_ids",{"type":49,"tag":68,"props":2791,"children":2792},{},[2793],{"type":55,"value":2794},"app_sg_id",{"type":49,"tag":68,"props":2796,"children":2797},{},[2798],{"type":55,"value":2799},"alb_sg_id",{"type":49,"tag":68,"props":2801,"children":2802},{},[2803],{"type":55,"value":2804},"listener_arn",{"type":49,"tag":68,"props":2806,"children":2807},{},[2808],{"type":55,"value":2809},"alb_dns_name",{"type":49,"tag":68,"props":2811,"children":2812},{},[2813],{"type":55,"value":2814},"task_role_arn",{"type":49,"tag":68,"props":2816,"children":2817},{},[2818],{"type":55,"value":2819},"execution_role_arn",{"type":49,"tag":68,"props":2821,"children":2822},{},[2823],{"type":55,"value":2824},"rds_address",{"type":49,"tag":58,"props":2826,"children":2827},{},[2828,2830,2836,2837,2843,2845,2850],{"type":55,"value":2829},"In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like ",{"type":49,"tag":326,"props":2831,"children":2833},{"className":2832},[],[2834],{"type":55,"value":2835},"Vpc",{"type":55,"value":715},{"type":49,"tag":326,"props":2838,"children":2840},{"className":2839},[],[2841],{"type":55,"value":2842},"RdsInstance",{"type":55,"value":2844},". More on this later in the following section ",{"type":49,"tag":72,"props":2846,"children":2847},{},[2848],{"type":55,"value":2849},"Passing data between stacks",{"type":55,"value":745},{"type":49,"tag":50,"props":2852,"children":2854},{"id":2853},"ad-hoc-app-overview",[2855],{"type":55,"value":2856},"Ad hoc app overview",{"type":49,"tag":58,"props":2858,"children":2859},{},[2860],{"type":55,"value":2861},"The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc.",{"type":49,"tag":58,"props":2863,"children":2864},{},[2865],{"type":55,"value":2866},"This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console.",{"type":49,"tag":58,"props":2868,"children":2869},{},[2870],{"type":49,"tag":1601,"props":2871,"children":2874},{"alt":2872,"src":2873},"Graph view of ad hoc app infrastructure","/static/pulumi_ad_hoc_app_dep_graph.png",[],{"type":49,"tag":430,"props":2876,"children":2878},{"id":2877},"ecs-cluster",[2879],{"type":55,"value":2880},"ECS Cluster",{"type":49,"tag":64,"props":2882,"children":2883},{},[2884,2889],{"type":49,"tag":68,"props":2885,"children":2886},{},[2887],{"type":55,"value":2888},"This is a small component that defines both ECS Cluster and the default capacity providers",{"type":49,"tag":68,"props":2890,"children":2891},{},[2892,2894,2900,2902,2907],{"type":55,"value":2893},"It defaults to not using ",{"type":49,"tag":326,"props":2895,"children":2897},{"className":2896},[],[2898],{"type":55,"value":2899},"FARGATE_SPOT",{"type":55,"value":2901},"; ad hoc environments do use ",{"type":49,"tag":326,"props":2903,"children":2905},{"className":2904},[],[2906],{"type":55,"value":2899},{"type":55,"value":2908}," for cost savings",{"type":49,"tag":2910,"props":2911,"children":2912},"blockquote",{},[2913],{"type":49,"tag":58,"props":2914,"children":2915},{},[2916,2918,2925],{"type":55,"value":2917},"NOTE: defaultCapacityProviderStrategy on cluster not currently supported. (",{"type":49,"tag":80,"props":2919,"children":2922},{"href":2920,"rel":2921},"https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ecs.CapacityProviderStrategy.html",[84],[2923],{"type":55,"value":2924},"link",{"type":55,"value":616},{"type":49,"tag":430,"props":2927,"children":2929},{"id":2928},"shared-environment-variables",[2930],{"type":55,"value":2931},"Shared environment variables",{"type":49,"tag":58,"props":2933,"children":2934},{},[2935,2937,2942],{"type":55,"value":2936},"The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource ",{"type":49,"tag":326,"props":2938,"children":2940},{"className":2939},[],[2941],{"type":55,"value":457},{"type":55,"value":2943},"s.",{"type":49,"tag":64,"props":2945,"children":2946},{},[2947,2975,2986,2997,3009],{"type":49,"tag":68,"props":2948,"children":2949},{},[2950,2952,2958,2960,2966,2968,2974],{"type":55,"value":2951},"I struggled to get this right in pulumi. A lot of Pulumi examples used ",{"type":49,"tag":326,"props":2953,"children":2955},{"className":2954},[],[2956],{"type":55,"value":2957},"JSON.stringify",{"type":55,"value":2959}," for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use ",{"type":49,"tag":326,"props":2961,"children":2963},{"className":2962},[],[2964],{"type":55,"value":2965},"pulumi.jsonStringify",{"type":55,"value":2967}," which was added in a relatively recent version of ",{"type":49,"tag":326,"props":2969,"children":2971},{"className":2970},[],[2972],{"type":55,"value":2973},"pulumi/pulumi",{"type":55,"value":745},{"type":49,"tag":68,"props":2976,"children":2977},{},[2978,2980],{"type":55,"value":2979},"CDK allows you to declare environment variables for a containerDefinition like ",{"type":49,"tag":326,"props":2981,"children":2983},{"className":2982},[],[2984],{"type":55,"value":2985},"{ FOO: \"bar\" }",{"type":49,"tag":68,"props":2987,"children":2988},{},[2989,2991],{"type":55,"value":2990},"Pulumi and Terraform require that values are passed like ",{"type":49,"tag":326,"props":2992,"children":2994},{"className":2993},[],[2995],{"type":55,"value":2996},"{ name: \"FOO\", value: \"bar\"}",{"type":49,"tag":68,"props":2998,"children":2999},{},[3000,3002,3007],{"type":55,"value":3001},"You could transform ",{"type":49,"tag":326,"props":3003,"children":3005},{"className":3004},[],[3006],{"type":55,"value":2985},{"type":55,"value":3008}," into the name/value format, but I didn't bother to do this",{"type":49,"tag":68,"props":3010,"children":3011},{},[3012,3014,3020],{"type":55,"value":3013},"extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the ",{"type":49,"tag":326,"props":3015,"children":3017},{"className":3016},[],[3018],{"type":55,"value":3019},"concat",{"type":55,"value":3021}," function to add these to the list of default environment variables.",{"type":49,"tag":58,"props":3023,"children":3024},{},[3025],{"type":55,"value":3026},"Here's what the code looks like for joining extra environment variables to the default environment variables:",{"type":49,"tag":1050,"props":3028,"children":3030},{"code":3029,"language":2171,"meta":8,"className":2172,"style":8},"    // CDK\n    if (extraEnvVars) {\n      environmentVariables = { ...extraEnvVars, ...environmentVariables };\n    }\n",[3031],{"type":49,"tag":326,"props":3032,"children":3033},{"__ignoreMap":8},[3034,3043,3056,3093],{"type":49,"tag":1060,"props":3035,"children":3036},{"class":1062,"line":1063},[3037],{"type":49,"tag":1060,"props":3038,"children":3040},{"style":3039},"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F",[3041],{"type":55,"value":3042},"    // CDK\n",{"type":49,"tag":1060,"props":3044,"children":3045},{"class":1062,"line":1079},[3046,3051],{"type":49,"tag":1060,"props":3047,"children":3048},{"style":2194},[3049],{"type":55,"value":3050},"    if",{"type":49,"tag":1060,"props":3052,"children":3053},{"style":1073},[3054],{"type":55,"value":3055}," (extraEnvVars) {\n",{"type":49,"tag":1060,"props":3057,"children":3058},{"class":1062,"line":1088},[3059,3064,3069,3074,3079,3084,3088],{"type":49,"tag":1060,"props":3060,"children":3061},{"style":1073},[3062],{"type":55,"value":3063},"      environmentVariables ",{"type":49,"tag":1060,"props":3065,"children":3066},{"style":2194},[3067],{"type":55,"value":3068},"=",{"type":49,"tag":1060,"props":3070,"children":3071},{"style":1073},[3072],{"type":55,"value":3073}," { ",{"type":49,"tag":1060,"props":3075,"children":3076},{"style":2194},[3077],{"type":55,"value":3078},"...",{"type":49,"tag":1060,"props":3080,"children":3081},{"style":1073},[3082],{"type":55,"value":3083},"extraEnvVars, ",{"type":49,"tag":1060,"props":3085,"children":3086},{"style":2194},[3087],{"type":55,"value":3078},{"type":49,"tag":1060,"props":3089,"children":3090},{"style":1073},[3091],{"type":55,"value":3092},"environmentVariables };\n",{"type":49,"tag":1060,"props":3094,"children":3095},{"class":1062,"line":1097},[3096],{"type":49,"tag":1060,"props":3097,"children":3098},{"style":1073},[3099],{"type":55,"value":3100},"    }\n",{"type":49,"tag":1050,"props":3102,"children":3104},{"code":3103},"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n",[3105],{"type":49,"tag":326,"props":3106,"children":3107},{"__ignoreMap":8},[3108],{"type":55,"value":3103},{"type":49,"tag":1050,"props":3110,"children":3112},{"code":3111},"    // Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x => x.concat(extraEnvVars!))\n    }\n",[3113],{"type":49,"tag":326,"props":3114,"children":3115},{"__ignoreMap":8},[3116],{"type":55,"value":3111},{"type":49,"tag":430,"props":3118,"children":3120},{"id":3119},"route53-record",[3121],{"type":55,"value":3122},"Route53 Record",{"type":49,"tag":58,"props":3124,"children":3125},{},[3126],{"type":55,"value":3127},"This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns.",{"type":49,"tag":58,"props":3129,"children":3130},{},[3131,3133,3139,3141,3147],{"type":55,"value":3132},"This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching ",{"type":49,"tag":326,"props":3134,"children":3136},{"className":3135},[],[3137],{"type":55,"value":3138},"example.com/api/*",{"type":55,"value":3140}," are routed to the backend API and all other requests matching ",{"type":49,"tag":326,"props":3142,"children":3144},{"className":3143},[],[3145],{"type":55,"value":3146},"example.com/*",{"type":55,"value":3148}," are routed to the frontend service.",{"type":49,"tag":430,"props":3150,"children":3152},{"id":3151},"redis",[3153],{"type":55,"value":3154},"Redis",{"type":49,"tag":58,"props":3156,"children":3157},{},[3158],{"type":55,"value":3159},"I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis.",{"type":49,"tag":58,"props":3161,"children":3162},{},[3163],{"type":55,"value":3164},"I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable.",{"type":49,"tag":430,"props":3166,"children":3168},{"id":3167},"web-service",[3169],{"type":55,"value":3170},"Web Service",{"type":49,"tag":58,"props":3172,"children":3173},{},[3174,3176,3181,3183,3189,3191,3197,3198,3204,3206,3212],{"type":55,"value":3175},"The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This ",{"type":49,"tag":326,"props":3177,"children":3179},{"className":3178},[],[3180],{"type":55,"value":457},{"type":55,"value":3182}," has an input parameter called ",{"type":49,"tag":326,"props":3184,"children":3186},{"className":3185},[],[3187],{"type":55,"value":3188},"pathPatterns",{"type":55,"value":3190}," which determines which paths it serves. For example, the API container may serve traffic for ",{"type":49,"tag":326,"props":3192,"children":3194},{"className":3193},[],[3195],{"type":55,"value":3196},"/api/*",{"type":55,"value":715},{"type":49,"tag":326,"props":3199,"children":3201},{"className":3200},[],[3202],{"type":55,"value":3203},"/admin/*",{"type":55,"value":3205}," only, or it may want to serve all traffic (",{"type":49,"tag":326,"props":3207,"children":3209},{"className":3208},[],[3210],{"type":55,"value":3211},"/*",{"type":55,"value":3213},").",{"type":49,"tag":58,"props":3215,"children":3216},{},[3217],{"type":55,"value":3218},"The way I use these components in ad hoc and prod environments is heavily opinionated in that:",{"type":49,"tag":64,"props":3220,"children":3221},{},[3222],{"type":49,"tag":68,"props":3223,"children":3224},{},[3225,3227,3232,3234,3239,3240,3245,3246,3252],{"type":55,"value":3226},"it assumes that the frontend SPA/SSR site should have a lower priority rule than the backend service and should route request paths matching ",{"type":49,"tag":326,"props":3228,"children":3230},{"className":3229},[],[3231],{"type":55,"value":3211},{"type":55,"value":3233},", while the backend service routes requests for a specific list of path patterns (",{"type":49,"tag":326,"props":3235,"children":3237},{"className":3236},[],[3238],{"type":55,"value":3196},{"type":55,"value":873},{"type":49,"tag":326,"props":3241,"children":3243},{"className":3242},[],[3244],{"type":55,"value":3203},{"type":55,"value":873},{"type":49,"tag":326,"props":3247,"children":3249},{"className":3248},[],[3250],{"type":55,"value":3251},"/graphql/*",{"type":55,"value":3253},", etc.).",{"type":49,"tag":58,"props":3255,"children":3256},{},[3257],{"type":55,"value":3258},"You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring.",{"type":49,"tag":430,"props":3260,"children":3262},{"id":3261},"celery",[3263],{"type":55,"value":3264},"Celery",{"type":49,"tag":64,"props":3266,"children":3267},{},[3268,3273],{"type":49,"tag":68,"props":3269,"children":3270},{},[3271],{"type":55,"value":3272},"The reason for having a celery service is to be able to have potentially multiple workers that scale independently",{"type":49,"tag":68,"props":3274,"children":3275},{},[3276],{"type":55,"value":3277},"I use the same Pulumi component for both works and schedulers",{"type":49,"tag":58,"props":3279,"children":3280},{},[3281,3283,3289,3291,3296],{"type":55,"value":3282},"The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like ",{"type":49,"tag":326,"props":3284,"children":3286},{"className":3285},[],[3287],{"type":55,"value":3288},"AsyncWorker",{"type":55,"value":3290}," across the board rather than using the term ",{"type":49,"tag":326,"props":3292,"children":3294},{"className":3293},[],[3295],{"type":55,"value":3261},{"type":55,"value":745},{"type":49,"tag":430,"props":3298,"children":3300},{"id":3299},"management-command",[3301],{"type":55,"value":3302},"Management Command",{"type":49,"tag":64,"props":3304,"children":3305},{},[3306,3324],{"type":49,"tag":68,"props":3307,"children":3308},{},[3309,3311,3317,3318],{"type":55,"value":3310},"Defines a task that can be used to run commands like ",{"type":49,"tag":326,"props":3312,"children":3314},{"className":3313},[],[3315],{"type":55,"value":3316},"collectstatic",{"type":55,"value":715},{"type":49,"tag":326,"props":3319,"children":3321},{"className":3320},[],[3322],{"type":55,"value":3323},"migrate",{"type":49,"tag":68,"props":3325,"children":3326},{},[3327,3329,3334],{"type":55,"value":3328},"These tasks are ran both after the initial ",{"type":49,"tag":326,"props":3330,"children":3332},{"className":3331},[],[3333],{"type":55,"value":1375},{"type":55,"value":3335}," stack deployment and before rolling application upgrades",{"type":49,"tag":58,"props":3337,"children":3338},{},[3339,3341,3346,3347,3352],{"type":55,"value":3340},"In my Django app I have a single management command that calls ",{"type":49,"tag":326,"props":3342,"children":3344},{"className":3343},[],[3345],{"type":55,"value":3323},{"type":55,"value":715},{"type":49,"tag":326,"props":3348,"children":3350},{"className":3349},[],[3351],{"type":55,"value":3316},{"type":55,"value":3353}," and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc.",{"type":49,"tag":58,"props":3355,"children":3356},{},[3357,3359,3364],{"type":55,"value":3358},"One other thing to note about this ",{"type":49,"tag":326,"props":3360,"children":3362},{"className":3361},[],[3363],{"type":55,"value":457},{"type":55,"value":3365}," is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:",{"type":49,"tag":64,"props":3367,"children":3368},{},[3369,3382,3387,3392,3403],{"type":49,"tag":68,"props":3370,"children":3371},{},[3372,3374,3380],{"type":55,"value":3373},"saves the ",{"type":49,"tag":326,"props":3375,"children":3377},{"className":3376},[],[3378],{"type":55,"value":3379},"START",{"type":55,"value":3381}," timestamp",{"type":49,"tag":68,"props":3383,"children":3384},{},[3385],{"type":55,"value":3386},"runs the task with the required settings",{"type":49,"tag":68,"props":3388,"children":3389},{},[3390],{"type":55,"value":3391},"waits for the task to complete",{"type":49,"tag":68,"props":3393,"children":3394},{},[3395,3396,3402],{"type":55,"value":3373},{"type":49,"tag":326,"props":3397,"children":3399},{"className":3398},[],[3400],{"type":55,"value":3401},"END",{"type":55,"value":3381},{"type":49,"tag":68,"props":3404,"children":3405},{},[3406,3408,3413,3414,3419,3421],{"type":55,"value":3407},"collects the logs for the task between ",{"type":49,"tag":326,"props":3409,"children":3411},{"className":3410},[],[3412],{"type":55,"value":3379},{"type":55,"value":715},{"type":49,"tag":326,"props":3415,"children":3417},{"className":3416},[],[3418],{"type":55,"value":3401},{"type":55,"value":3420}," and prints them to ",{"type":49,"tag":326,"props":3422,"children":3424},{"className":3423},[],[3425],{"type":55,"value":3426},"stdout",{"type":49,"tag":58,"props":3428,"children":3429},{},[3430],{"type":55,"value":3431},"Here's an example of what the script looks like in Pulumi:",{"type":49,"tag":1050,"props":3433,"children":3435},{"code":3434,"language":2171,"meta":8,"className":2172,"style":8},"    const executionScript = pulumi.interpolate`#!/bin/bash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster ${props.ecsClusterId} --task-definition ${taskDefinition.arn} --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[${props.privateSubnetIds.apply(x => x.join(\",\"))}],securityGroups=[${props.appSgId}],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster ${props.ecsClusterId}\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name ${cwLoggingResources.cwLogGroupName} --log-stream-name ${props.name}/${props.name}/\\${TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n`;\n    this.executionScript = executionScript;\n",[3436],{"type":49,"tag":326,"props":3437,"children":3438},{"__ignoreMap":8},[3439,3470,3478,3647,3676,3684,3779,3792],{"type":49,"tag":1060,"props":3440,"children":3441},{"class":1062,"line":1063},[3442,3446,3451,3455,3460,3465],{"type":49,"tag":1060,"props":3443,"children":3444},{"style":2182},[3445],{"type":55,"value":2185},{"type":49,"tag":1060,"props":3447,"children":3448},{"style":2188},[3449],{"type":55,"value":3450}," executionScript",{"type":49,"tag":1060,"props":3452,"children":3453},{"style":2194},[3454],{"type":55,"value":2197},{"type":49,"tag":1060,"props":3456,"children":3457},{"style":1073},[3458],{"type":55,"value":3459}," pulumi.",{"type":49,"tag":1060,"props":3461,"children":3462},{"style":1067},[3463],{"type":55,"value":3464},"interpolate",{"type":49,"tag":1060,"props":3466,"children":3467},{"style":2215},[3468],{"type":55,"value":3469},"`#!/bin/bash\n",{"type":49,"tag":1060,"props":3471,"children":3472},{"class":1062,"line":1079},[3473],{"type":49,"tag":1060,"props":3474,"children":3475},{"style":2215},[3476],{"type":55,"value":3477},"START_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3479,"children":3480},{"class":1062,"line":1088},[3481,3486,3492,3497,3502,3507,3512,3517,3521,3526,3530,3535,3539,3544,3548,3552,3556,3561,3565,3569,3573,3579,3584,3589,3593,3598,3602,3607,3612,3616,3621,3625,3629,3633,3638,3642],{"type":49,"tag":1060,"props":3482,"children":3483},{"style":2215},[3484],{"type":55,"value":3485},"TASK_ID=$(aws ecs run-task --cluster ",{"type":49,"tag":1060,"props":3487,"children":3489},{"style":3488},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672",[3490],{"type":55,"value":3491},"${",{"type":49,"tag":1060,"props":3493,"children":3494},{"style":1073},[3495],{"type":55,"value":3496},"props",{"type":49,"tag":1060,"props":3498,"children":3500},{"style":3499},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2",[3501],{"type":55,"value":745},{"type":49,"tag":1060,"props":3503,"children":3504},{"style":1073},[3505],{"type":55,"value":3506},"ecsClusterId",{"type":49,"tag":1060,"props":3508,"children":3509},{"style":3488},[3510],{"type":55,"value":3511},"}",{"type":49,"tag":1060,"props":3513,"children":3514},{"style":2215},[3515],{"type":55,"value":3516}," --task-definition ",{"type":49,"tag":1060,"props":3518,"children":3519},{"style":3488},[3520],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3522,"children":3523},{"style":1073},[3524],{"type":55,"value":3525},"taskDefinition",{"type":49,"tag":1060,"props":3527,"children":3528},{"style":3499},[3529],{"type":55,"value":745},{"type":49,"tag":1060,"props":3531,"children":3532},{"style":1073},[3533],{"type":55,"value":3534},"arn",{"type":49,"tag":1060,"props":3536,"children":3537},{"style":3488},[3538],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3540,"children":3541},{"style":2215},[3542],{"type":55,"value":3543}," --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":3545,"children":3546},{"style":3488},[3547],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3549,"children":3550},{"style":1073},[3551],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3553,"children":3554},{"style":3499},[3555],{"type":55,"value":745},{"type":49,"tag":1060,"props":3557,"children":3558},{"style":1073},[3559],{"type":55,"value":3560},"privateSubnetIds",{"type":49,"tag":1060,"props":3562,"children":3563},{"style":3499},[3564],{"type":55,"value":745},{"type":49,"tag":1060,"props":3566,"children":3567},{"style":1067},[3568],{"type":55,"value":472},{"type":49,"tag":1060,"props":3570,"children":3571},{"style":3499},[3572],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3574,"children":3576},{"style":3575},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[3577],{"type":55,"value":3578},"x",{"type":49,"tag":1060,"props":3580,"children":3581},{"style":2182},[3582],{"type":55,"value":3583}," =>",{"type":49,"tag":1060,"props":3585,"children":3586},{"style":1073},[3587],{"type":55,"value":3588}," x",{"type":49,"tag":1060,"props":3590,"children":3591},{"style":3499},[3592],{"type":55,"value":745},{"type":49,"tag":1060,"props":3594,"children":3595},{"style":1067},[3596],{"type":55,"value":3597},"join",{"type":49,"tag":1060,"props":3599,"children":3600},{"style":3499},[3601],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3603,"children":3604},{"style":2215},[3605],{"type":55,"value":3606},"\",\"",{"type":49,"tag":1060,"props":3608,"children":3609},{"style":3499},[3610],{"type":55,"value":3611},"))",{"type":49,"tag":1060,"props":3613,"children":3614},{"style":3488},[3615],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3617,"children":3618},{"style":2215},[3619],{"type":55,"value":3620},"],securityGroups=[",{"type":49,"tag":1060,"props":3622,"children":3623},{"style":3488},[3624],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3626,"children":3627},{"style":1073},[3628],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3630,"children":3631},{"style":3499},[3632],{"type":55,"value":745},{"type":49,"tag":1060,"props":3634,"children":3635},{"style":1073},[3636],{"type":55,"value":3637},"appSgId",{"type":49,"tag":1060,"props":3639,"children":3640},{"style":3488},[3641],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3643,"children":3644},{"style":2215},[3645],{"type":55,"value":3646},"],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\n",{"type":49,"tag":1060,"props":3648,"children":3649},{"class":1062,"line":1097},[3650,3655,3659,3663,3667,3671],{"type":49,"tag":1060,"props":3651,"children":3652},{"style":2215},[3653],{"type":55,"value":3654},"aws ecs wait tasks-stopped --tasks $TASK_ID --cluster ",{"type":49,"tag":1060,"props":3656,"children":3657},{"style":3488},[3658],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3660,"children":3661},{"style":1073},[3662],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3664,"children":3665},{"style":3499},[3666],{"type":55,"value":745},{"type":49,"tag":1060,"props":3668,"children":3669},{"style":1073},[3670],{"type":55,"value":3506},{"type":49,"tag":1060,"props":3672,"children":3673},{"style":3488},[3674],{"type":55,"value":3675},"}\n",{"type":49,"tag":1060,"props":3677,"children":3678},{"class":1062,"line":1111},[3679],{"type":49,"tag":1060,"props":3680,"children":3681},{"style":2215},[3682],{"type":55,"value":3683},"END_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3685,"children":3686},{"class":1062,"line":1120},[3687,3692,3696,3701,3705,3710,3714,3719,3723,3727,3731,3736,3740,3745,3749,3753,3757,3761,3765,3769,3774],{"type":49,"tag":1060,"props":3688,"children":3689},{"style":2215},[3690],{"type":55,"value":3691},"aws logs get-log-events --log-group-name ",{"type":49,"tag":1060,"props":3693,"children":3694},{"style":3488},[3695],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3697,"children":3698},{"style":1073},[3699],{"type":55,"value":3700},"cwLoggingResources",{"type":49,"tag":1060,"props":3702,"children":3703},{"style":3499},[3704],{"type":55,"value":745},{"type":49,"tag":1060,"props":3706,"children":3707},{"style":1073},[3708],{"type":55,"value":3709},"cwLogGroupName",{"type":49,"tag":1060,"props":3711,"children":3712},{"style":3488},[3713],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3715,"children":3716},{"style":2215},[3717],{"type":55,"value":3718}," --log-stream-name ",{"type":49,"tag":1060,"props":3720,"children":3721},{"style":3488},[3722],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3724,"children":3725},{"style":1073},[3726],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3728,"children":3729},{"style":3499},[3730],{"type":55,"value":745},{"type":49,"tag":1060,"props":3732,"children":3733},{"style":1073},[3734],{"type":55,"value":3735},"name",{"type":49,"tag":1060,"props":3737,"children":3738},{"style":3488},[3739],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3741,"children":3742},{"style":2215},[3743],{"type":55,"value":3744},"/",{"type":49,"tag":1060,"props":3746,"children":3747},{"style":3488},[3748],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3750,"children":3751},{"style":1073},[3752],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3754,"children":3755},{"style":3499},[3756],{"type":55,"value":745},{"type":49,"tag":1060,"props":3758,"children":3759},{"style":1073},[3760],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3762,"children":3763},{"style":3488},[3764],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3766,"children":3767},{"style":2215},[3768],{"type":55,"value":3744},{"type":49,"tag":1060,"props":3770,"children":3771},{"style":2287},[3772],{"type":55,"value":3773},"\\$",{"type":49,"tag":1060,"props":3775,"children":3776},{"style":2215},[3777],{"type":55,"value":3778},"{TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n",{"type":49,"tag":1060,"props":3780,"children":3781},{"class":1062,"line":1128},[3782,3787],{"type":49,"tag":1060,"props":3783,"children":3784},{"style":2215},[3785],{"type":55,"value":3786},"`",{"type":49,"tag":1060,"props":3788,"children":3789},{"style":1073},[3790],{"type":55,"value":3791},";\n",{"type":49,"tag":1060,"props":3793,"children":3794},{"class":1062,"line":1141},[3795,3801,3806,3810],{"type":49,"tag":1060,"props":3796,"children":3798},{"style":3797},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[3799],{"type":55,"value":3800},"    this",{"type":49,"tag":1060,"props":3802,"children":3803},{"style":1073},[3804],{"type":55,"value":3805},".executionScript ",{"type":49,"tag":1060,"props":3807,"children":3808},{"style":2194},[3809],{"type":55,"value":3068},{"type":49,"tag":1060,"props":3811,"children":3812},{"style":1073},[3813],{"type":55,"value":3814}," executionScript;\n",{"type":49,"tag":58,"props":3816,"children":3817},{},[3818],{"type":55,"value":3819},"In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:",{"type":49,"tag":1050,"props":3821,"children":3825},{"code":3822,"language":3823,"meta":8,"className":3824,"style":8},"      - name: \"Run backend update command\"\n        id: run_backend_update\n        run: |\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          ./backend_update_command.sh\n","yaml","language-yaml shiki shiki-themes github-light github-dark monokai",[3826],{"type":49,"tag":326,"props":3827,"children":3828},{"__ignoreMap":8},[3829,3851,3868,3885,3893,3901,3909,3917,3925,3932,3940,3948,3956],{"type":49,"tag":1060,"props":3830,"children":3831},{"class":1062,"line":1063},[3832,3837,3842,3846],{"type":49,"tag":1060,"props":3833,"children":3834},{"style":1073},[3835],{"type":55,"value":3836},"      - ",{"type":49,"tag":1060,"props":3838,"children":3840},{"style":3839},"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[3841],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3843,"children":3844},{"style":1073},[3845],{"type":55,"value":78},{"type":49,"tag":1060,"props":3847,"children":3848},{"style":2215},[3849],{"type":55,"value":3850},"\"Run backend update command\"\n",{"type":49,"tag":1060,"props":3852,"children":3853},{"class":1062,"line":1079},[3854,3859,3863],{"type":49,"tag":1060,"props":3855,"children":3856},{"style":3839},[3857],{"type":55,"value":3858},"        id",{"type":49,"tag":1060,"props":3860,"children":3861},{"style":1073},[3862],{"type":55,"value":78},{"type":49,"tag":1060,"props":3864,"children":3865},{"style":2215},[3866],{"type":55,"value":3867},"run_backend_update\n",{"type":49,"tag":1060,"props":3869,"children":3870},{"class":1062,"line":1088},[3871,3876,3880],{"type":49,"tag":1060,"props":3872,"children":3873},{"style":3839},[3874],{"type":55,"value":3875},"        run",{"type":49,"tag":1060,"props":3877,"children":3878},{"style":1073},[3879],{"type":55,"value":78},{"type":49,"tag":1060,"props":3881,"children":3882},{"style":2194},[3883],{"type":55,"value":3884},"|\n",{"type":49,"tag":1060,"props":3886,"children":3887},{"class":1062,"line":1097},[3888],{"type":49,"tag":1060,"props":3889,"children":3890},{"style":2215},[3891],{"type":55,"value":3892},"          # get the script from the stack output with an output key that contains the string `backendUpdate`\n",{"type":49,"tag":1060,"props":3894,"children":3895},{"class":1062,"line":1111},[3896],{"type":49,"tag":1060,"props":3897,"children":3898},{"style":2215},[3899],{"type":55,"value":3900},"          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n",{"type":49,"tag":1060,"props":3902,"children":3903},{"class":1062,"line":1120},[3904],{"type":49,"tag":1060,"props":3905,"children":3906},{"style":2215},[3907],{"type":55,"value":3908},"            --stack-name $AD_HOC_APP_NAME \\\n",{"type":49,"tag":1060,"props":3910,"children":3911},{"class":1062,"line":1128},[3912],{"type":49,"tag":1060,"props":3913,"children":3914},{"style":2215},[3915],{"type":55,"value":3916},"            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n",{"type":49,"tag":1060,"props":3918,"children":3919},{"class":1062,"line":1141},[3920],{"type":49,"tag":1060,"props":3921,"children":3922},{"style":2215},[3923],{"type":55,"value":3924},"          )\n",{"type":49,"tag":1060,"props":3926,"children":3927},{"class":1062,"line":1150},[3928],{"type":49,"tag":1060,"props":3929,"children":3930},{"emptyLinePlaceholder":44},[3931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":3933,"children":3934},{"class":1062,"line":1158},[3935],{"type":49,"tag":1060,"props":3936,"children":3937},{"style":2215},[3938],{"type":55,"value":3939},"          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n",{"type":49,"tag":1060,"props":3941,"children":3942},{"class":1062,"line":1171},[3943],{"type":49,"tag":1060,"props":3944,"children":3945},{"style":2215},[3946],{"type":55,"value":3947},"          cat backend_update_command.sh\n",{"type":49,"tag":1060,"props":3949,"children":3950},{"class":1062,"line":1180},[3951],{"type":49,"tag":1060,"props":3952,"children":3953},{"style":2215},[3954],{"type":55,"value":3955},"          sudo chmod +x backend_update_command.sh\n",{"type":49,"tag":1060,"props":3957,"children":3958},{"class":1062,"line":1188},[3959],{"type":49,"tag":1060,"props":3960,"children":3961},{"style":2215},[3962],{"type":55,"value":3963},"          ./backend_update_command.sh\n",{"type":49,"tag":430,"props":3965,"children":3967},{"id":3966},"passing-data-between-stacks",[3968],{"type":55,"value":2849},{"type":49,"tag":58,"props":3970,"children":3971},{},[3972],{"type":55,"value":3973},"Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References.",{"type":49,"tag":58,"props":3975,"children":3976},{},[3977],{"type":55,"value":3978},"Here's what this looks like in Terraform",{"type":49,"tag":1050,"props":3980,"children":3983},{"code":3981,"language":16,"meta":8,"className":3982,"style":8},"data \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"../base/terraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"../../../modules/ad-hoc/app\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n","language-terraform shiki shiki-themes github-light github-dark monokai",[3984],{"type":49,"tag":326,"props":3985,"children":3986},{"__ignoreMap":8},[3987,4011,4028,4035,4051,4068,4076,4083,4090,4107,4124,4131,4183,4233,4282,4332,4381,4431,4480,4529,4579,4629,4680,4707],{"type":49,"tag":1060,"props":3988,"children":3989},{"class":1062,"line":1063},[3990,3996,4001,4006],{"type":49,"tag":1060,"props":3991,"children":3993},{"style":3992},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[3994],{"type":55,"value":3995},"data",{"type":49,"tag":1060,"props":3997,"children":3998},{"style":2188},[3999],{"type":55,"value":4000}," \"terraform_remote_state\"",{"type":49,"tag":1060,"props":4002,"children":4003},{"style":2188},[4004],{"type":55,"value":4005}," \"this\"",{"type":49,"tag":1060,"props":4007,"children":4008},{"style":1073},[4009],{"type":55,"value":4010}," {\n",{"type":49,"tag":1060,"props":4012,"children":4013},{"class":1062,"line":1079},[4014,4019,4023],{"type":49,"tag":1060,"props":4015,"children":4016},{"style":1073},[4017],{"type":55,"value":4018},"  backend",{"type":49,"tag":1060,"props":4020,"children":4021},{"style":2194},[4022],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4024,"children":4025},{"style":2215},[4026],{"type":55,"value":4027}," \"local\"\n",{"type":49,"tag":1060,"props":4029,"children":4030},{"class":1062,"line":1088},[4031],{"type":49,"tag":1060,"props":4032,"children":4033},{"emptyLinePlaceholder":44},[4034],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4036,"children":4037},{"class":1062,"line":1097},[4038,4043,4047],{"type":49,"tag":1060,"props":4039,"children":4040},{"style":1073},[4041],{"type":55,"value":4042},"  config",{"type":49,"tag":1060,"props":4044,"children":4045},{"style":2194},[4046],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4048,"children":4049},{"style":1073},[4050],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4052,"children":4053},{"class":1062,"line":1111},[4054,4059,4063],{"type":49,"tag":1060,"props":4055,"children":4056},{"style":1073},[4057],{"type":55,"value":4058},"    path ",{"type":49,"tag":1060,"props":4060,"children":4061},{"style":2194},[4062],{"type":55,"value":3068},{"type":49,"tag":1060,"props":4064,"children":4065},{"style":2215},[4066],{"type":55,"value":4067}," \"../base/terraform.tfstate\"\n",{"type":49,"tag":1060,"props":4069,"children":4070},{"class":1062,"line":1120},[4071],{"type":49,"tag":1060,"props":4072,"children":4073},{"style":1073},[4074],{"type":55,"value":4075},"  }\n",{"type":49,"tag":1060,"props":4077,"children":4078},{"class":1062,"line":1128},[4079],{"type":49,"tag":1060,"props":4080,"children":4081},{"style":1073},[4082],{"type":55,"value":3675},{"type":49,"tag":1060,"props":4084,"children":4085},{"class":1062,"line":1141},[4086],{"type":49,"tag":1060,"props":4087,"children":4088},{"emptyLinePlaceholder":44},[4089],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4091,"children":4092},{"class":1062,"line":1150},[4093,4098,4103],{"type":49,"tag":1060,"props":4094,"children":4095},{"style":3992},[4096],{"type":55,"value":4097},"module",{"type":49,"tag":1060,"props":4099,"children":4100},{"style":2188},[4101],{"type":55,"value":4102}," \"main\"",{"type":49,"tag":1060,"props":4104,"children":4105},{"style":1073},[4106],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4108,"children":4109},{"class":1062,"line":1158},[4110,4115,4119],{"type":49,"tag":1060,"props":4111,"children":4112},{"style":1073},[4113],{"type":55,"value":4114},"  source",{"type":49,"tag":1060,"props":4116,"children":4117},{"style":2194},[4118],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4120,"children":4121},{"style":2215},[4122],{"type":55,"value":4123}," \"../../../modules/ad-hoc/app\"\n",{"type":49,"tag":1060,"props":4125,"children":4126},{"class":1062,"line":1171},[4127],{"type":49,"tag":1060,"props":4128,"children":4129},{"emptyLinePlaceholder":44},[4130],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4132,"children":4133},{"class":1062,"line":1180},[4134,4139,4144,4149,4153,4157,4161,4166,4170,4174,4178],{"type":49,"tag":1060,"props":4135,"children":4136},{"style":1073},[4137],{"type":55,"value":4138},"  vpc_id",{"type":49,"tag":1060,"props":4140,"children":4141},{"style":2194},[4142],{"type":55,"value":4143},"                         =",{"type":49,"tag":1060,"props":4145,"children":4146},{"style":1073},[4147],{"type":55,"value":4148}," data",{"type":49,"tag":1060,"props":4150,"children":4151},{"style":2194},[4152],{"type":55,"value":745},{"type":49,"tag":1060,"props":4154,"children":4155},{"style":1073},[4156],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4158,"children":4159},{"style":2194},[4160],{"type":55,"value":745},{"type":49,"tag":1060,"props":4162,"children":4163},{"style":1073},[4164],{"type":55,"value":4165},"this",{"type":49,"tag":1060,"props":4167,"children":4168},{"style":2194},[4169],{"type":55,"value":745},{"type":49,"tag":1060,"props":4171,"children":4172},{"style":1073},[4173],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4175,"children":4176},{"style":2194},[4177],{"type":55,"value":745},{"type":49,"tag":1060,"props":4179,"children":4180},{"style":1073},[4181],{"type":55,"value":4182},"vpc_id\n",{"type":49,"tag":1060,"props":4184,"children":4185},{"class":1062,"line":1188},[4186,4191,4196,4200,4204,4208,4212,4216,4220,4224,4228],{"type":49,"tag":1060,"props":4187,"children":4188},{"style":1073},[4189],{"type":55,"value":4190},"  assets_bucket_name",{"type":49,"tag":1060,"props":4192,"children":4193},{"style":2194},[4194],{"type":55,"value":4195},"             =",{"type":49,"tag":1060,"props":4197,"children":4198},{"style":1073},[4199],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4201,"children":4202},{"style":2194},[4203],{"type":55,"value":745},{"type":49,"tag":1060,"props":4205,"children":4206},{"style":1073},[4207],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4209,"children":4210},{"style":2194},[4211],{"type":55,"value":745},{"type":49,"tag":1060,"props":4213,"children":4214},{"style":1073},[4215],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4217,"children":4218},{"style":2194},[4219],{"type":55,"value":745},{"type":49,"tag":1060,"props":4221,"children":4222},{"style":1073},[4223],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4225,"children":4226},{"style":2194},[4227],{"type":55,"value":745},{"type":49,"tag":1060,"props":4229,"children":4230},{"style":1073},[4231],{"type":55,"value":4232},"assets_bucket_name\n",{"type":49,"tag":1060,"props":4234,"children":4235},{"class":1062,"line":1201},[4236,4241,4245,4249,4253,4257,4261,4265,4269,4273,4277],{"type":49,"tag":1060,"props":4237,"children":4238},{"style":1073},[4239],{"type":55,"value":4240},"  private_subnet_ids",{"type":49,"tag":1060,"props":4242,"children":4243},{"style":2194},[4244],{"type":55,"value":4195},{"type":49,"tag":1060,"props":4246,"children":4247},{"style":1073},[4248],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4250,"children":4251},{"style":2194},[4252],{"type":55,"value":745},{"type":49,"tag":1060,"props":4254,"children":4255},{"style":1073},[4256],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4258,"children":4259},{"style":2194},[4260],{"type":55,"value":745},{"type":49,"tag":1060,"props":4262,"children":4263},{"style":1073},[4264],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4266,"children":4267},{"style":2194},[4268],{"type":55,"value":745},{"type":49,"tag":1060,"props":4270,"children":4271},{"style":1073},[4272],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4274,"children":4275},{"style":2194},[4276],{"type":55,"value":745},{"type":49,"tag":1060,"props":4278,"children":4279},{"style":1073},[4280],{"type":55,"value":4281},"private_subnet_ids\n",{"type":49,"tag":1060,"props":4283,"children":4284},{"class":1062,"line":1210},[4285,4290,4295,4299,4303,4307,4311,4315,4319,4323,4327],{"type":49,"tag":1060,"props":4286,"children":4287},{"style":1073},[4288],{"type":55,"value":4289},"  app_sg_id",{"type":49,"tag":1060,"props":4291,"children":4292},{"style":2194},[4293],{"type":55,"value":4294},"                      =",{"type":49,"tag":1060,"props":4296,"children":4297},{"style":1073},[4298],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4300,"children":4301},{"style":2194},[4302],{"type":55,"value":745},{"type":49,"tag":1060,"props":4304,"children":4305},{"style":1073},[4306],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4308,"children":4309},{"style":2194},[4310],{"type":55,"value":745},{"type":49,"tag":1060,"props":4312,"children":4313},{"style":1073},[4314],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4316,"children":4317},{"style":2194},[4318],{"type":55,"value":745},{"type":49,"tag":1060,"props":4320,"children":4321},{"style":1073},[4322],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4324,"children":4325},{"style":2194},[4326],{"type":55,"value":745},{"type":49,"tag":1060,"props":4328,"children":4329},{"style":1073},[4330],{"type":55,"value":4331},"app_sg_id\n",{"type":49,"tag":1060,"props":4333,"children":4334},{"class":1062,"line":1218},[4335,4340,4344,4348,4352,4356,4360,4364,4368,4372,4376],{"type":49,"tag":1060,"props":4336,"children":4337},{"style":1073},[4338],{"type":55,"value":4339},"  alb_sg_id",{"type":49,"tag":1060,"props":4341,"children":4342},{"style":2194},[4343],{"type":55,"value":4294},{"type":49,"tag":1060,"props":4345,"children":4346},{"style":1073},[4347],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4349,"children":4350},{"style":2194},[4351],{"type":55,"value":745},{"type":49,"tag":1060,"props":4353,"children":4354},{"style":1073},[4355],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4357,"children":4358},{"style":2194},[4359],{"type":55,"value":745},{"type":49,"tag":1060,"props":4361,"children":4362},{"style":1073},[4363],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4365,"children":4366},{"style":2194},[4367],{"type":55,"value":745},{"type":49,"tag":1060,"props":4369,"children":4370},{"style":1073},[4371],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4373,"children":4374},{"style":2194},[4375],{"type":55,"value":745},{"type":49,"tag":1060,"props":4377,"children":4378},{"style":1073},[4379],{"type":55,"value":4380},"alb_sg_id\n",{"type":49,"tag":1060,"props":4382,"children":4383},{"class":1062,"line":1232},[4384,4389,4394,4398,4402,4406,4410,4414,4418,4422,4426],{"type":49,"tag":1060,"props":4385,"children":4386},{"style":1073},[4387],{"type":55,"value":4388},"  listener_arn",{"type":49,"tag":1060,"props":4390,"children":4391},{"style":2194},[4392],{"type":55,"value":4393},"                   =",{"type":49,"tag":1060,"props":4395,"children":4396},{"style":1073},[4397],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4399,"children":4400},{"style":2194},[4401],{"type":55,"value":745},{"type":49,"tag":1060,"props":4403,"children":4404},{"style":1073},[4405],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4407,"children":4408},{"style":2194},[4409],{"type":55,"value":745},{"type":49,"tag":1060,"props":4411,"children":4412},{"style":1073},[4413],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4415,"children":4416},{"style":2194},[4417],{"type":55,"value":745},{"type":49,"tag":1060,"props":4419,"children":4420},{"style":1073},[4421],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4423,"children":4424},{"style":2194},[4425],{"type":55,"value":745},{"type":49,"tag":1060,"props":4427,"children":4428},{"style":1073},[4429],{"type":55,"value":4430},"listener_arn\n",{"type":49,"tag":1060,"props":4432,"children":4433},{"class":1062,"line":1241},[4434,4439,4443,4447,4451,4455,4459,4463,4467,4471,4475],{"type":49,"tag":1060,"props":4435,"children":4436},{"style":1073},[4437],{"type":55,"value":4438},"  alb_dns_name",{"type":49,"tag":1060,"props":4440,"children":4441},{"style":2194},[4442],{"type":55,"value":4393},{"type":49,"tag":1060,"props":4444,"children":4445},{"style":1073},[4446],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4448,"children":4449},{"style":2194},[4450],{"type":55,"value":745},{"type":49,"tag":1060,"props":4452,"children":4453},{"style":1073},[4454],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4456,"children":4457},{"style":2194},[4458],{"type":55,"value":745},{"type":49,"tag":1060,"props":4460,"children":4461},{"style":1073},[4462],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4464,"children":4465},{"style":2194},[4466],{"type":55,"value":745},{"type":49,"tag":1060,"props":4468,"children":4469},{"style":1073},[4470],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4472,"children":4473},{"style":2194},[4474],{"type":55,"value":745},{"type":49,"tag":1060,"props":4476,"children":4477},{"style":1073},[4478],{"type":55,"value":4479},"alb_dns_name\n",{"type":49,"tag":1060,"props":4481,"children":4482},{"class":1062,"line":1249},[4483,4488,4492,4496,4500,4504,4508,4512,4516,4520,4524],{"type":49,"tag":1060,"props":4484,"children":4485},{"style":1073},[4486],{"type":55,"value":4487},"  service_discovery_namespace_id",{"type":49,"tag":1060,"props":4489,"children":4490},{"style":2194},[4491],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4493,"children":4494},{"style":1073},[4495],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4497,"children":4498},{"style":2194},[4499],{"type":55,"value":745},{"type":49,"tag":1060,"props":4501,"children":4502},{"style":1073},[4503],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4505,"children":4506},{"style":2194},[4507],{"type":55,"value":745},{"type":49,"tag":1060,"props":4509,"children":4510},{"style":1073},[4511],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4513,"children":4514},{"style":2194},[4515],{"type":55,"value":745},{"type":49,"tag":1060,"props":4517,"children":4518},{"style":1073},[4519],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4521,"children":4522},{"style":2194},[4523],{"type":55,"value":745},{"type":49,"tag":1060,"props":4525,"children":4526},{"style":1073},[4527],{"type":55,"value":4528},"service_discovery_namespace_id\n",{"type":49,"tag":1060,"props":4530,"children":4531},{"class":1062,"line":1262},[4532,4537,4542,4546,4550,4554,4558,4562,4566,4570,4574],{"type":49,"tag":1060,"props":4533,"children":4534},{"style":1073},[4535],{"type":55,"value":4536},"  rds_address",{"type":49,"tag":1060,"props":4538,"children":4539},{"style":2194},[4540],{"type":55,"value":4541},"                    =",{"type":49,"tag":1060,"props":4543,"children":4544},{"style":1073},[4545],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4547,"children":4548},{"style":2194},[4549],{"type":55,"value":745},{"type":49,"tag":1060,"props":4551,"children":4552},{"style":1073},[4553],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4555,"children":4556},{"style":2194},[4557],{"type":55,"value":745},{"type":49,"tag":1060,"props":4559,"children":4560},{"style":1073},[4561],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4563,"children":4564},{"style":2194},[4565],{"type":55,"value":745},{"type":49,"tag":1060,"props":4567,"children":4568},{"style":1073},[4569],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4571,"children":4572},{"style":2194},[4573],{"type":55,"value":745},{"type":49,"tag":1060,"props":4575,"children":4576},{"style":1073},[4577],{"type":55,"value":4578},"rds_address\n",{"type":49,"tag":1060,"props":4580,"children":4582},{"class":1062,"line":4581},21,[4583,4588,4592,4596,4600,4604,4608,4612,4616,4620,4624],{"type":49,"tag":1060,"props":4584,"children":4585},{"style":1073},[4586],{"type":55,"value":4587},"  domain_name",{"type":49,"tag":1060,"props":4589,"children":4590},{"style":2194},[4591],{"type":55,"value":4541},{"type":49,"tag":1060,"props":4593,"children":4594},{"style":1073},[4595],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4597,"children":4598},{"style":2194},[4599],{"type":55,"value":745},{"type":49,"tag":1060,"props":4601,"children":4602},{"style":1073},[4603],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4605,"children":4606},{"style":2194},[4607],{"type":55,"value":745},{"type":49,"tag":1060,"props":4609,"children":4610},{"style":1073},[4611],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4613,"children":4614},{"style":2194},[4615],{"type":55,"value":745},{"type":49,"tag":1060,"props":4617,"children":4618},{"style":1073},[4619],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4621,"children":4622},{"style":2194},[4623],{"type":55,"value":745},{"type":49,"tag":1060,"props":4625,"children":4626},{"style":1073},[4627],{"type":55,"value":4628},"domain_name\n",{"type":49,"tag":1060,"props":4630,"children":4632},{"class":1062,"line":4631},22,[4633,4638,4643,4647,4651,4655,4659,4663,4667,4671,4675],{"type":49,"tag":1060,"props":4634,"children":4635},{"style":1073},[4636],{"type":55,"value":4637},"  base_stack_name",{"type":49,"tag":1060,"props":4639,"children":4640},{"style":2194},[4641],{"type":55,"value":4642},"                =",{"type":49,"tag":1060,"props":4644,"children":4645},{"style":1073},[4646],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4648,"children":4649},{"style":2194},[4650],{"type":55,"value":745},{"type":49,"tag":1060,"props":4652,"children":4653},{"style":1073},[4654],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4656,"children":4657},{"style":2194},[4658],{"type":55,"value":745},{"type":49,"tag":1060,"props":4660,"children":4661},{"style":1073},[4662],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4664,"children":4665},{"style":2194},[4666],{"type":55,"value":745},{"type":49,"tag":1060,"props":4668,"children":4669},{"style":1073},[4670],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4672,"children":4673},{"style":2194},[4674],{"type":55,"value":745},{"type":49,"tag":1060,"props":4676,"children":4677},{"style":1073},[4678],{"type":55,"value":4679},"base_stack_name\n",{"type":49,"tag":1060,"props":4681,"children":4683},{"class":1062,"line":4682},23,[4684,4689,4693,4698,4702],{"type":49,"tag":1060,"props":4685,"children":4686},{"style":1073},[4687],{"type":55,"value":4688},"  region",{"type":49,"tag":1060,"props":4690,"children":4691},{"style":2194},[4692],{"type":55,"value":4143},{"type":49,"tag":1060,"props":4694,"children":4695},{"style":1073},[4696],{"type":55,"value":4697}," var",{"type":49,"tag":1060,"props":4699,"children":4700},{"style":2194},[4701],{"type":55,"value":745},{"type":49,"tag":1060,"props":4703,"children":4704},{"style":1073},[4705],{"type":55,"value":4706},"region\n",{"type":49,"tag":1060,"props":4708,"children":4710},{"class":1062,"line":4709},24,[4711],{"type":49,"tag":1060,"props":4712,"children":4713},{"style":1073},[4714],{"type":55,"value":3675},{"type":49,"tag":58,"props":4716,"children":4717},{},[4718],{"type":55,"value":4719},"In CDK:",{"type":49,"tag":1050,"props":4721,"children":4723},{"code":4722,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n\nconst adHocBase = new AdHocBase(baseStack, 'AdHocBase', { certificateArn, domainName });\n\nconst addHocApp = new AdHocApp(appStack, 'AdHocApp', {\n  baseStackName: adHocBaseEnvName,\n  vpc: adHocBase.vpc,\n  alb: adHocBase.alb,\n  appSecurityGroup: adHocBase.appSecurityGroup,\n  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n  rdsInstance: adHocBase.databaseInstance,\n  assetsBucket: adHocBase.assetsBucket,\n  domainName: adHocBase.domainName,\n  listener: adHocBase.listener,\n});\n",[4724],{"type":49,"tag":326,"props":4725,"children":4726},{"__ignoreMap":8},[4727,4768,4795,4802,4840,4865,4872,4912,4919,4958,4966,4974,4982,4990,4998,5006,5014,5022,5030],{"type":49,"tag":1060,"props":4728,"children":4729},{"class":1062,"line":1063},[4730,4735,4740,4744,4748,4753,4758,4763],{"type":49,"tag":1060,"props":4731,"children":4732},{"style":2182},[4733],{"type":55,"value":4734},"const",{"type":49,"tag":1060,"props":4736,"children":4737},{"style":2188},[4738],{"type":55,"value":4739}," baseStack",{"type":49,"tag":1060,"props":4741,"children":4742},{"style":2194},[4743],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4745,"children":4746},{"style":2194},[4747],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4749,"children":4750},{"style":1067},[4751],{"type":55,"value":4752}," Stack",{"type":49,"tag":1060,"props":4754,"children":4755},{"style":1073},[4756],{"type":55,"value":4757},"(app, ",{"type":49,"tag":1060,"props":4759,"children":4760},{"style":2215},[4761],{"type":55,"value":4762},"'ExampleAdHocBaseStack'",{"type":49,"tag":1060,"props":4764,"children":4765},{"style":1073},[4766],{"type":55,"value":4767},", { env, stackName: adHocBaseEnvName });\n",{"type":49,"tag":1060,"props":4769,"children":4770},{"class":1062,"line":1079},[4771,4776,4781,4785,4790],{"type":49,"tag":1060,"props":4772,"children":4773},{"style":1073},[4774],{"type":55,"value":4775},"baseStack.node.",{"type":49,"tag":1060,"props":4777,"children":4778},{"style":1067},[4779],{"type":55,"value":4780},"setContext",{"type":49,"tag":1060,"props":4782,"children":4783},{"style":1073},[4784],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4786,"children":4787},{"style":2215},[4788],{"type":55,"value":4789},"'config'",{"type":49,"tag":1060,"props":4791,"children":4792},{"style":1073},[4793],{"type":55,"value":4794},", adHocBaseEnvConfig);\n",{"type":49,"tag":1060,"props":4796,"children":4797},{"class":1062,"line":1088},[4798],{"type":49,"tag":1060,"props":4799,"children":4800},{"emptyLinePlaceholder":44},[4801],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4803,"children":4804},{"class":1062,"line":1097},[4805,4809,4814,4818,4822,4826,4830,4835],{"type":49,"tag":1060,"props":4806,"children":4807},{"style":2182},[4808],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4810,"children":4811},{"style":2188},[4812],{"type":55,"value":4813}," appStack",{"type":49,"tag":1060,"props":4815,"children":4816},{"style":2194},[4817],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4819,"children":4820},{"style":2194},[4821],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4823,"children":4824},{"style":1067},[4825],{"type":55,"value":4752},{"type":49,"tag":1060,"props":4827,"children":4828},{"style":1073},[4829],{"type":55,"value":4757},{"type":49,"tag":1060,"props":4831,"children":4832},{"style":2215},[4833],{"type":55,"value":4834},"'ExampleAdHocAppStack'",{"type":49,"tag":1060,"props":4836,"children":4837},{"style":1073},[4838],{"type":55,"value":4839},", { env, stackName: adHocAppEnvName });\n",{"type":49,"tag":1060,"props":4841,"children":4842},{"class":1062,"line":1111},[4843,4848,4852,4856,4860],{"type":49,"tag":1060,"props":4844,"children":4845},{"style":1073},[4846],{"type":55,"value":4847},"appStack.node.",{"type":49,"tag":1060,"props":4849,"children":4850},{"style":1067},[4851],{"type":55,"value":4780},{"type":49,"tag":1060,"props":4853,"children":4854},{"style":1073},[4855],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4857,"children":4858},{"style":2215},[4859],{"type":55,"value":4789},{"type":49,"tag":1060,"props":4861,"children":4862},{"style":1073},[4863],{"type":55,"value":4864},", adHocAppEnvConfig);\n",{"type":49,"tag":1060,"props":4866,"children":4867},{"class":1062,"line":1120},[4868],{"type":49,"tag":1060,"props":4869,"children":4870},{"emptyLinePlaceholder":44},[4871],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4873,"children":4874},{"class":1062,"line":1128},[4875,4879,4884,4888,4892,4897,4902,4907],{"type":49,"tag":1060,"props":4876,"children":4877},{"style":2182},[4878],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4880,"children":4881},{"style":2188},[4882],{"type":55,"value":4883}," adHocBase",{"type":49,"tag":1060,"props":4885,"children":4886},{"style":2194},[4887],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4889,"children":4890},{"style":2194},[4891],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4893,"children":4894},{"style":1067},[4895],{"type":55,"value":4896}," AdHocBase",{"type":49,"tag":1060,"props":4898,"children":4899},{"style":1073},[4900],{"type":55,"value":4901},"(baseStack, ",{"type":49,"tag":1060,"props":4903,"children":4904},{"style":2215},[4905],{"type":55,"value":4906},"'AdHocBase'",{"type":49,"tag":1060,"props":4908,"children":4909},{"style":1073},[4910],{"type":55,"value":4911},", { certificateArn, domainName });\n",{"type":49,"tag":1060,"props":4913,"children":4914},{"class":1062,"line":1141},[4915],{"type":49,"tag":1060,"props":4916,"children":4917},{"emptyLinePlaceholder":44},[4918],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4920,"children":4921},{"class":1062,"line":1150},[4922,4926,4931,4935,4939,4944,4949,4954],{"type":49,"tag":1060,"props":4923,"children":4924},{"style":2182},[4925],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4927,"children":4928},{"style":2188},[4929],{"type":55,"value":4930}," addHocApp",{"type":49,"tag":1060,"props":4932,"children":4933},{"style":2194},[4934],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4936,"children":4937},{"style":2194},[4938],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4940,"children":4941},{"style":1067},[4942],{"type":55,"value":4943}," AdHocApp",{"type":49,"tag":1060,"props":4945,"children":4946},{"style":1073},[4947],{"type":55,"value":4948},"(appStack, ",{"type":49,"tag":1060,"props":4950,"children":4951},{"style":2215},[4952],{"type":55,"value":4953},"'AdHocApp'",{"type":49,"tag":1060,"props":4955,"children":4956},{"style":1073},[4957],{"type":55,"value":2223},{"type":49,"tag":1060,"props":4959,"children":4960},{"class":1062,"line":1158},[4961],{"type":49,"tag":1060,"props":4962,"children":4963},{"style":1073},[4964],{"type":55,"value":4965},"  baseStackName: adHocBaseEnvName,\n",{"type":49,"tag":1060,"props":4967,"children":4968},{"class":1062,"line":1171},[4969],{"type":49,"tag":1060,"props":4970,"children":4971},{"style":1073},[4972],{"type":55,"value":4973},"  vpc: adHocBase.vpc,\n",{"type":49,"tag":1060,"props":4975,"children":4976},{"class":1062,"line":1180},[4977],{"type":49,"tag":1060,"props":4978,"children":4979},{"style":1073},[4980],{"type":55,"value":4981},"  alb: adHocBase.alb,\n",{"type":49,"tag":1060,"props":4983,"children":4984},{"class":1062,"line":1188},[4985],{"type":49,"tag":1060,"props":4986,"children":4987},{"style":1073},[4988],{"type":55,"value":4989},"  appSecurityGroup: adHocBase.appSecurityGroup,\n",{"type":49,"tag":1060,"props":4991,"children":4992},{"class":1062,"line":1201},[4993],{"type":49,"tag":1060,"props":4994,"children":4995},{"style":1073},[4996],{"type":55,"value":4997},"  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n",{"type":49,"tag":1060,"props":4999,"children":5000},{"class":1062,"line":1210},[5001],{"type":49,"tag":1060,"props":5002,"children":5003},{"style":1073},[5004],{"type":55,"value":5005},"  rdsInstance: adHocBase.databaseInstance,\n",{"type":49,"tag":1060,"props":5007,"children":5008},{"class":1062,"line":1218},[5009],{"type":49,"tag":1060,"props":5010,"children":5011},{"style":1073},[5012],{"type":55,"value":5013},"  assetsBucket: adHocBase.assetsBucket,\n",{"type":49,"tag":1060,"props":5015,"children":5016},{"class":1062,"line":1232},[5017],{"type":49,"tag":1060,"props":5018,"children":5019},{"style":1073},[5020],{"type":55,"value":5021},"  domainName: adHocBase.domainName,\n",{"type":49,"tag":1060,"props":5023,"children":5024},{"class":1062,"line":1241},[5025],{"type":49,"tag":1060,"props":5026,"children":5027},{"style":1073},[5028],{"type":55,"value":5029},"  listener: adHocBase.listener,\n",{"type":49,"tag":1060,"props":5031,"children":5032},{"class":1062,"line":1249},[5033],{"type":49,"tag":1060,"props":5034,"children":5035},{"style":1073},[5036],{"type":55,"value":5037},"});\n",{"type":49,"tag":58,"props":5039,"children":5040},{},[5041],{"type":55,"value":5042},"and in Pulumi:",{"type":49,"tag":1050,"props":5044,"children":5046},{"code":5045,"language":2171,"meta":8,"className":2172,"style":8},"const stackReference = new pulumi.StackReference(`${org}/ad-hoc-base/${environment}`)\n\nconst vpcId = stackReference.getOutput(\"vpcId\") as pulumi.Output\u003Cstring>;\nconst assetsBucketName = stackReference.getOutput(\"assetsBucketName\") as pulumi.Output\u003Cstring>;\nconst privateSubnets = stackReference.getOutput(\"privateSubnetIds\") as pulumi.Output\u003Cstring[]>;\nconst appSgId = stackReference.getOutput(\"appSgId\") as pulumi.Output\u003Cstring>;\nconst albSgId = stackReference.getOutput(\"albSgId\") as pulumi.Output\u003Cstring>;\nconst listenerArn = stackReference.getOutput(\"listenerArn\") as pulumi.Output\u003Cstring>;\nconst albDnsName = stackReference.getOutput(\"albDnsName\") as pulumi.Output\u003Cstring>;\nconst serviceDiscoveryNamespaceId = stackReference.getOutput(\"serviceDiscoveryNamespaceId\") as pulumi.Output\u003Cstring>;\nconst rdsAddress = stackReference.getOutput(\"rdsAddress\") as pulumi.Output\u003Cstring>;\nconst domainName = stackReference.getOutput(\"domainName\") as pulumi.Output\u003Cstring>;\nconst baseStackName = stackReference.getOutput(\"baseStackName\") as pulumi.Output\u003Cstring>;\n\n// ad hoc app env\nconst adHocAppComponent = new AdHocAppComponent(\"AdHocAppComponent\", {\n  vpcId,\n  assetsBucketName,\n  privateSubnets,\n  appSgId,\n  albSgId,\n  listenerArn,\n  albDnsName,\n  serviceDiscoveryNamespaceId,\n  rdsAddress,\n  domainName,\n  baseStackName\n});\n",[5047],{"type":49,"tag":326,"props":5048,"children":5049},{"__ignoreMap":8},[5050,5127,5134,5209,5274,5340,5405,5470,5535,5600,5665,5730,5795,5860,5867,5875,5913,5921,5929,5937,5945,5953,5961,5969,5977,5986,5995,6004],{"type":49,"tag":1060,"props":5051,"children":5052},{"class":1062,"line":1063},[5053,5057,5062,5066,5070,5074,5079,5083,5087,5091,5096,5100,5105,5109,5114,5118,5122],{"type":49,"tag":1060,"props":5054,"children":5055},{"style":2182},[5056],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5058,"children":5059},{"style":2188},[5060],{"type":55,"value":5061}," stackReference",{"type":49,"tag":1060,"props":5063,"children":5064},{"style":2194},[5065],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5067,"children":5068},{"style":2194},[5069],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5071,"children":5072},{"style":1073},[5073],{"type":55,"value":3459},{"type":49,"tag":1060,"props":5075,"children":5076},{"style":1067},[5077],{"type":55,"value":5078},"StackReference",{"type":49,"tag":1060,"props":5080,"children":5081},{"style":1073},[5082],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5084,"children":5085},{"style":2215},[5086],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5088,"children":5089},{"style":3488},[5090],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5092,"children":5093},{"style":1073},[5094],{"type":55,"value":5095},"org",{"type":49,"tag":1060,"props":5097,"children":5098},{"style":3488},[5099],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5101,"children":5102},{"style":2215},[5103],{"type":55,"value":5104},"/ad-hoc-base/",{"type":49,"tag":1060,"props":5106,"children":5107},{"style":3488},[5108],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5110,"children":5111},{"style":1073},[5112],{"type":55,"value":5113},"environment",{"type":49,"tag":1060,"props":5115,"children":5116},{"style":3488},[5117],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5119,"children":5120},{"style":2215},[5121],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5123,"children":5124},{"style":1073},[5125],{"type":55,"value":5126},")\n",{"type":49,"tag":1060,"props":5128,"children":5129},{"class":1062,"line":1079},[5130],{"type":49,"tag":1060,"props":5131,"children":5132},{"emptyLinePlaceholder":44},[5133],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5135,"children":5136},{"class":1062,"line":1088},[5137,5141,5146,5150,5155,5160,5164,5169,5174,5179,5184,5188,5193,5198,5204],{"type":49,"tag":1060,"props":5138,"children":5139},{"style":2182},[5140],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5142,"children":5143},{"style":2188},[5144],{"type":55,"value":5145}," vpcId",{"type":49,"tag":1060,"props":5147,"children":5148},{"style":2194},[5149],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5151,"children":5152},{"style":1073},[5153],{"type":55,"value":5154}," stackReference.",{"type":49,"tag":1060,"props":5156,"children":5157},{"style":1067},[5158],{"type":55,"value":5159},"getOutput",{"type":49,"tag":1060,"props":5161,"children":5162},{"style":1073},[5163],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5165,"children":5166},{"style":2215},[5167],{"type":55,"value":5168},"\"vpcId\"",{"type":49,"tag":1060,"props":5170,"children":5171},{"style":1073},[5172],{"type":55,"value":5173},") ",{"type":49,"tag":1060,"props":5175,"children":5176},{"style":2194},[5177],{"type":55,"value":5178},"as",{"type":49,"tag":1060,"props":5180,"children":5181},{"style":3992},[5182],{"type":55,"value":5183}," pulumi",{"type":49,"tag":1060,"props":5185,"children":5186},{"style":1073},[5187],{"type":55,"value":745},{"type":49,"tag":1060,"props":5189,"children":5190},{"style":3992},[5191],{"type":55,"value":5192},"Output",{"type":49,"tag":1060,"props":5194,"children":5195},{"style":1073},[5196],{"type":55,"value":5197},"\u003C",{"type":49,"tag":1060,"props":5199,"children":5201},{"style":5200},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[5202],{"type":55,"value":5203},"string",{"type":49,"tag":1060,"props":5205,"children":5206},{"style":1073},[5207],{"type":55,"value":5208},">;\n",{"type":49,"tag":1060,"props":5210,"children":5211},{"class":1062,"line":1097},[5212,5216,5221,5225,5229,5233,5237,5242,5246,5250,5254,5258,5262,5266,5270],{"type":49,"tag":1060,"props":5213,"children":5214},{"style":2182},[5215],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5217,"children":5218},{"style":2188},[5219],{"type":55,"value":5220}," assetsBucketName",{"type":49,"tag":1060,"props":5222,"children":5223},{"style":2194},[5224],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5226,"children":5227},{"style":1073},[5228],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5230,"children":5231},{"style":1067},[5232],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5234,"children":5235},{"style":1073},[5236],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5238,"children":5239},{"style":2215},[5240],{"type":55,"value":5241},"\"assetsBucketName\"",{"type":49,"tag":1060,"props":5243,"children":5244},{"style":1073},[5245],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5247,"children":5248},{"style":2194},[5249],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5251,"children":5252},{"style":3992},[5253],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5255,"children":5256},{"style":1073},[5257],{"type":55,"value":745},{"type":49,"tag":1060,"props":5259,"children":5260},{"style":3992},[5261],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5263,"children":5264},{"style":1073},[5265],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5267,"children":5268},{"style":5200},[5269],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5271,"children":5272},{"style":1073},[5273],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5275,"children":5276},{"class":1062,"line":1111},[5277,5281,5286,5290,5294,5298,5302,5307,5311,5315,5319,5323,5327,5331,5335],{"type":49,"tag":1060,"props":5278,"children":5279},{"style":2182},[5280],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5282,"children":5283},{"style":2188},[5284],{"type":55,"value":5285}," privateSubnets",{"type":49,"tag":1060,"props":5287,"children":5288},{"style":2194},[5289],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5291,"children":5292},{"style":1073},[5293],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5295,"children":5296},{"style":1067},[5297],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5299,"children":5300},{"style":1073},[5301],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5303,"children":5304},{"style":2215},[5305],{"type":55,"value":5306},"\"privateSubnetIds\"",{"type":49,"tag":1060,"props":5308,"children":5309},{"style":1073},[5310],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5312,"children":5313},{"style":2194},[5314],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5316,"children":5317},{"style":3992},[5318],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5320,"children":5321},{"style":1073},[5322],{"type":55,"value":745},{"type":49,"tag":1060,"props":5324,"children":5325},{"style":3992},[5326],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5328,"children":5329},{"style":1073},[5330],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5332,"children":5333},{"style":5200},[5334],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5336,"children":5337},{"style":1073},[5338],{"type":55,"value":5339},"[]>;\n",{"type":49,"tag":1060,"props":5341,"children":5342},{"class":1062,"line":1120},[5343,5347,5352,5356,5360,5364,5368,5373,5377,5381,5385,5389,5393,5397,5401],{"type":49,"tag":1060,"props":5344,"children":5345},{"style":2182},[5346],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5348,"children":5349},{"style":2188},[5350],{"type":55,"value":5351}," appSgId",{"type":49,"tag":1060,"props":5353,"children":5354},{"style":2194},[5355],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5357,"children":5358},{"style":1073},[5359],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5361,"children":5362},{"style":1067},[5363],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5365,"children":5366},{"style":1073},[5367],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5369,"children":5370},{"style":2215},[5371],{"type":55,"value":5372},"\"appSgId\"",{"type":49,"tag":1060,"props":5374,"children":5375},{"style":1073},[5376],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5378,"children":5379},{"style":2194},[5380],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5382,"children":5383},{"style":3992},[5384],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5386,"children":5387},{"style":1073},[5388],{"type":55,"value":745},{"type":49,"tag":1060,"props":5390,"children":5391},{"style":3992},[5392],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5394,"children":5395},{"style":1073},[5396],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5398,"children":5399},{"style":5200},[5400],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5402,"children":5403},{"style":1073},[5404],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5406,"children":5407},{"class":1062,"line":1128},[5408,5412,5417,5421,5425,5429,5433,5438,5442,5446,5450,5454,5458,5462,5466],{"type":49,"tag":1060,"props":5409,"children":5410},{"style":2182},[5411],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5413,"children":5414},{"style":2188},[5415],{"type":55,"value":5416}," albSgId",{"type":49,"tag":1060,"props":5418,"children":5419},{"style":2194},[5420],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5422,"children":5423},{"style":1073},[5424],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5426,"children":5427},{"style":1067},[5428],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5430,"children":5431},{"style":1073},[5432],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5434,"children":5435},{"style":2215},[5436],{"type":55,"value":5437},"\"albSgId\"",{"type":49,"tag":1060,"props":5439,"children":5440},{"style":1073},[5441],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5443,"children":5444},{"style":2194},[5445],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5447,"children":5448},{"style":3992},[5449],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5451,"children":5452},{"style":1073},[5453],{"type":55,"value":745},{"type":49,"tag":1060,"props":5455,"children":5456},{"style":3992},[5457],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5459,"children":5460},{"style":1073},[5461],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5463,"children":5464},{"style":5200},[5465],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5467,"children":5468},{"style":1073},[5469],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5471,"children":5472},{"class":1062,"line":1141},[5473,5477,5482,5486,5490,5494,5498,5503,5507,5511,5515,5519,5523,5527,5531],{"type":49,"tag":1060,"props":5474,"children":5475},{"style":2182},[5476],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5478,"children":5479},{"style":2188},[5480],{"type":55,"value":5481}," listenerArn",{"type":49,"tag":1060,"props":5483,"children":5484},{"style":2194},[5485],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5487,"children":5488},{"style":1073},[5489],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5491,"children":5492},{"style":1067},[5493],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5495,"children":5496},{"style":1073},[5497],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5499,"children":5500},{"style":2215},[5501],{"type":55,"value":5502},"\"listenerArn\"",{"type":49,"tag":1060,"props":5504,"children":5505},{"style":1073},[5506],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5508,"children":5509},{"style":2194},[5510],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5512,"children":5513},{"style":3992},[5514],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5516,"children":5517},{"style":1073},[5518],{"type":55,"value":745},{"type":49,"tag":1060,"props":5520,"children":5521},{"style":3992},[5522],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5524,"children":5525},{"style":1073},[5526],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5528,"children":5529},{"style":5200},[5530],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5532,"children":5533},{"style":1073},[5534],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5536,"children":5537},{"class":1062,"line":1150},[5538,5542,5547,5551,5555,5559,5563,5568,5572,5576,5580,5584,5588,5592,5596],{"type":49,"tag":1060,"props":5539,"children":5540},{"style":2182},[5541],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5543,"children":5544},{"style":2188},[5545],{"type":55,"value":5546}," albDnsName",{"type":49,"tag":1060,"props":5548,"children":5549},{"style":2194},[5550],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5552,"children":5553},{"style":1073},[5554],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5556,"children":5557},{"style":1067},[5558],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5560,"children":5561},{"style":1073},[5562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5564,"children":5565},{"style":2215},[5566],{"type":55,"value":5567},"\"albDnsName\"",{"type":49,"tag":1060,"props":5569,"children":5570},{"style":1073},[5571],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5573,"children":5574},{"style":2194},[5575],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5577,"children":5578},{"style":3992},[5579],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5581,"children":5582},{"style":1073},[5583],{"type":55,"value":745},{"type":49,"tag":1060,"props":5585,"children":5586},{"style":3992},[5587],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5589,"children":5590},{"style":1073},[5591],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5593,"children":5594},{"style":5200},[5595],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5597,"children":5598},{"style":1073},[5599],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5601,"children":5602},{"class":1062,"line":1158},[5603,5607,5612,5616,5620,5624,5628,5633,5637,5641,5645,5649,5653,5657,5661],{"type":49,"tag":1060,"props":5604,"children":5605},{"style":2182},[5606],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5608,"children":5609},{"style":2188},[5610],{"type":55,"value":5611}," serviceDiscoveryNamespaceId",{"type":49,"tag":1060,"props":5613,"children":5614},{"style":2194},[5615],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5617,"children":5618},{"style":1073},[5619],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5621,"children":5622},{"style":1067},[5623],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5625,"children":5626},{"style":1073},[5627],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5629,"children":5630},{"style":2215},[5631],{"type":55,"value":5632},"\"serviceDiscoveryNamespaceId\"",{"type":49,"tag":1060,"props":5634,"children":5635},{"style":1073},[5636],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5638,"children":5639},{"style":2194},[5640],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5642,"children":5643},{"style":3992},[5644],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5646,"children":5647},{"style":1073},[5648],{"type":55,"value":745},{"type":49,"tag":1060,"props":5650,"children":5651},{"style":3992},[5652],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5654,"children":5655},{"style":1073},[5656],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5658,"children":5659},{"style":5200},[5660],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5662,"children":5663},{"style":1073},[5664],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5666,"children":5667},{"class":1062,"line":1171},[5668,5672,5677,5681,5685,5689,5693,5698,5702,5706,5710,5714,5718,5722,5726],{"type":49,"tag":1060,"props":5669,"children":5670},{"style":2182},[5671],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5673,"children":5674},{"style":2188},[5675],{"type":55,"value":5676}," rdsAddress",{"type":49,"tag":1060,"props":5678,"children":5679},{"style":2194},[5680],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5682,"children":5683},{"style":1073},[5684],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5686,"children":5687},{"style":1067},[5688],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5690,"children":5691},{"style":1073},[5692],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5694,"children":5695},{"style":2215},[5696],{"type":55,"value":5697},"\"rdsAddress\"",{"type":49,"tag":1060,"props":5699,"children":5700},{"style":1073},[5701],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5703,"children":5704},{"style":2194},[5705],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5707,"children":5708},{"style":3992},[5709],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5711,"children":5712},{"style":1073},[5713],{"type":55,"value":745},{"type":49,"tag":1060,"props":5715,"children":5716},{"style":3992},[5717],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5719,"children":5720},{"style":1073},[5721],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5723,"children":5724},{"style":5200},[5725],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5727,"children":5728},{"style":1073},[5729],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5731,"children":5732},{"class":1062,"line":1180},[5733,5737,5742,5746,5750,5754,5758,5763,5767,5771,5775,5779,5783,5787,5791],{"type":49,"tag":1060,"props":5734,"children":5735},{"style":2182},[5736],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5738,"children":5739},{"style":2188},[5740],{"type":55,"value":5741}," domainName",{"type":49,"tag":1060,"props":5743,"children":5744},{"style":2194},[5745],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5747,"children":5748},{"style":1073},[5749],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5751,"children":5752},{"style":1067},[5753],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5755,"children":5756},{"style":1073},[5757],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5759,"children":5760},{"style":2215},[5761],{"type":55,"value":5762},"\"domainName\"",{"type":49,"tag":1060,"props":5764,"children":5765},{"style":1073},[5766],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5768,"children":5769},{"style":2194},[5770],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5772,"children":5773},{"style":3992},[5774],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5776,"children":5777},{"style":1073},[5778],{"type":55,"value":745},{"type":49,"tag":1060,"props":5780,"children":5781},{"style":3992},[5782],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5784,"children":5785},{"style":1073},[5786],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5788,"children":5789},{"style":5200},[5790],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5792,"children":5793},{"style":1073},[5794],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5796,"children":5797},{"class":1062,"line":1188},[5798,5802,5807,5811,5815,5819,5823,5828,5832,5836,5840,5844,5848,5852,5856],{"type":49,"tag":1060,"props":5799,"children":5800},{"style":2182},[5801],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5803,"children":5804},{"style":2188},[5805],{"type":55,"value":5806}," baseStackName",{"type":49,"tag":1060,"props":5808,"children":5809},{"style":2194},[5810],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5812,"children":5813},{"style":1073},[5814],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5816,"children":5817},{"style":1067},[5818],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5820,"children":5821},{"style":1073},[5822],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5824,"children":5825},{"style":2215},[5826],{"type":55,"value":5827},"\"baseStackName\"",{"type":49,"tag":1060,"props":5829,"children":5830},{"style":1073},[5831],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5833,"children":5834},{"style":2194},[5835],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5837,"children":5838},{"style":3992},[5839],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5841,"children":5842},{"style":1073},[5843],{"type":55,"value":745},{"type":49,"tag":1060,"props":5845,"children":5846},{"style":3992},[5847],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5849,"children":5850},{"style":1073},[5851],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5853,"children":5854},{"style":5200},[5855],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5857,"children":5858},{"style":1073},[5859],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5861,"children":5862},{"class":1062,"line":1201},[5863],{"type":49,"tag":1060,"props":5864,"children":5865},{"emptyLinePlaceholder":44},[5866],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5868,"children":5869},{"class":1062,"line":1210},[5870],{"type":49,"tag":1060,"props":5871,"children":5872},{"style":3039},[5873],{"type":55,"value":5874},"// ad hoc app env\n",{"type":49,"tag":1060,"props":5876,"children":5877},{"class":1062,"line":1218},[5878,5882,5887,5891,5895,5900,5904,5909],{"type":49,"tag":1060,"props":5879,"children":5880},{"style":2182},[5881],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5883,"children":5884},{"style":2188},[5885],{"type":55,"value":5886}," adHocAppComponent",{"type":49,"tag":1060,"props":5888,"children":5889},{"style":2194},[5890],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5892,"children":5893},{"style":2194},[5894],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5896,"children":5897},{"style":1067},[5898],{"type":55,"value":5899}," AdHocAppComponent",{"type":49,"tag":1060,"props":5901,"children":5902},{"style":1073},[5903],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5905,"children":5906},{"style":2215},[5907],{"type":55,"value":5908},"\"AdHocAppComponent\"",{"type":49,"tag":1060,"props":5910,"children":5911},{"style":1073},[5912],{"type":55,"value":2223},{"type":49,"tag":1060,"props":5914,"children":5915},{"class":1062,"line":1232},[5916],{"type":49,"tag":1060,"props":5917,"children":5918},{"style":1073},[5919],{"type":55,"value":5920},"  vpcId,\n",{"type":49,"tag":1060,"props":5922,"children":5923},{"class":1062,"line":1241},[5924],{"type":49,"tag":1060,"props":5925,"children":5926},{"style":1073},[5927],{"type":55,"value":5928},"  assetsBucketName,\n",{"type":49,"tag":1060,"props":5930,"children":5931},{"class":1062,"line":1249},[5932],{"type":49,"tag":1060,"props":5933,"children":5934},{"style":1073},[5935],{"type":55,"value":5936},"  privateSubnets,\n",{"type":49,"tag":1060,"props":5938,"children":5939},{"class":1062,"line":1262},[5940],{"type":49,"tag":1060,"props":5941,"children":5942},{"style":1073},[5943],{"type":55,"value":5944},"  appSgId,\n",{"type":49,"tag":1060,"props":5946,"children":5947},{"class":1062,"line":4581},[5948],{"type":49,"tag":1060,"props":5949,"children":5950},{"style":1073},[5951],{"type":55,"value":5952},"  albSgId,\n",{"type":49,"tag":1060,"props":5954,"children":5955},{"class":1062,"line":4631},[5956],{"type":49,"tag":1060,"props":5957,"children":5958},{"style":1073},[5959],{"type":55,"value":5960},"  listenerArn,\n",{"type":49,"tag":1060,"props":5962,"children":5963},{"class":1062,"line":4682},[5964],{"type":49,"tag":1060,"props":5965,"children":5966},{"style":1073},[5967],{"type":55,"value":5968},"  albDnsName,\n",{"type":49,"tag":1060,"props":5970,"children":5971},{"class":1062,"line":4709},[5972],{"type":49,"tag":1060,"props":5973,"children":5974},{"style":1073},[5975],{"type":55,"value":5976},"  serviceDiscoveryNamespaceId,\n",{"type":49,"tag":1060,"props":5978,"children":5980},{"class":1062,"line":5979},25,[5981],{"type":49,"tag":1060,"props":5982,"children":5983},{"style":1073},[5984],{"type":55,"value":5985},"  rdsAddress,\n",{"type":49,"tag":1060,"props":5987,"children":5989},{"class":1062,"line":5988},26,[5990],{"type":49,"tag":1060,"props":5991,"children":5992},{"style":1073},[5993],{"type":55,"value":5994},"  domainName,\n",{"type":49,"tag":1060,"props":5996,"children":5998},{"class":1062,"line":5997},27,[5999],{"type":49,"tag":1060,"props":6000,"children":6001},{"style":1073},[6002],{"type":55,"value":6003},"  baseStackName\n",{"type":49,"tag":1060,"props":6005,"children":6007},{"class":1062,"line":6006},28,[6008],{"type":49,"tag":1060,"props":6009,"children":6010},{"style":1073},[6011],{"type":55,"value":5037},{"type":49,"tag":50,"props":6013,"children":6015},{"id":6014},"cli-scaffolding",[6016],{"type":55,"value":6017},"CLI scaffolding",{"type":49,"tag":58,"props":6019,"children":6020},{},[6021],{"type":55,"value":6022},"CDK and Pulumi have some good options for how to scaffold a project.",{"type":49,"tag":64,"props":6024,"children":6025},{},[6026,6054,6066,6084],{"type":49,"tag":68,"props":6027,"children":6028},{},[6029,6031,6037,6039,6045,6047,6052],{"type":55,"value":6030},"Pulumi has ",{"type":49,"tag":326,"props":6032,"children":6034},{"className":6033},[],[6035],{"type":55,"value":6036},"pulumi new aws-typescript",{"type":55,"value":6038}," among lots of other options (run ",{"type":49,"tag":326,"props":6040,"children":6042},{"className":6041},[],[6043],{"type":55,"value":6044},"pulumi new -l",{"type":55,"value":6046}," to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in ",{"type":49,"tag":326,"props":6048,"children":6050},{"className":6049},[],[6051],{"type":55,"value":1627},{"type":55,"value":6053}," that consume the library.",{"type":49,"tag":68,"props":6055,"children":6056},{},[6057,6059,6064],{"type":55,"value":6058},"CDK has ",{"type":49,"tag":326,"props":6060,"children":6062},{"className":6061},[],[6063],{"type":55,"value":855},{"type":55,"value":6065}," CLI commands which can help set up either library code or project code",{"type":49,"tag":68,"props":6067,"children":6068},{},[6069,6071,6076,6077,6082],{"type":55,"value":6070},"The major benefits of these tools is setting up ",{"type":49,"tag":326,"props":6072,"children":6074},{"className":6073},[],[6075],{"type":55,"value":871},{"type":55,"value":715},{"type":49,"tag":326,"props":6078,"children":6080},{"className":6079},[],[6081],{"type":55,"value":824},{"type":55,"value":6083}," correctly",{"type":49,"tag":68,"props":6085,"children":6086},{},[6087],{"type":55,"value":6088},"Terraform is so simple that it doesn't really need tooling for scaffolding",{"type":49,"tag":50,"props":6090,"children":6092},{"id":6091},"best-practices",[6093],{"type":55,"value":6094},"Best practices",{"type":49,"tag":58,"props":6096,"children":6097},{},[6098,6100,6105,6107,6114],{"type":55,"value":6099},"For ",{"type":49,"tag":326,"props":6101,"children":6103},{"className":6102},[],[6104],{"type":55,"value":684},{"type":55,"value":6106},", I tried to follow the recommendations from ",{"type":49,"tag":80,"props":6108,"children":6111},{"href":6109,"rel":6110},"https://www.terraform-best-practices.com/",[84],[6112],{"type":55,"value":6113},"terraform-best-practices.com",{"type":55,"value":6115}," which helped me a lot with things like consistent naming patterns and directory structures. For example:",{"type":49,"tag":64,"props":6117,"children":6118},{},[6119],{"type":49,"tag":68,"props":6120,"children":6121},{},[6122,6124,6129],{"type":55,"value":6123},"use the name ",{"type":49,"tag":326,"props":6125,"children":6127},{"className":6126},[],[6128],{"type":55,"value":4165},{"type":55,"value":6130}," for resources in a module where that resource is the only resource of its type",{"type":49,"tag":58,"props":6132,"children":6133},{},[6134],{"type":55,"value":6135},"CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi.",{"type":49,"tag":58,"props":6137,"children":6138},{},[6139,6141,6146,6147,6152,6153,6159,6160,6166,6167,6173,6175,6181,6182,6188],{"type":55,"value":6140},"For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of ",{"type":49,"tag":326,"props":6142,"children":6144},{"className":6143},[],[6145],{"type":55,"value":2065},{"type":55,"value":873},{"type":49,"tag":326,"props":6148,"children":6150},{"className":6149},[],[6151],{"type":55,"value":2766},{"type":55,"value":873},{"type":49,"tag":326,"props":6154,"children":6156},{"className":6155},[],[6157],{"type":55,"value":6158},"pulumi.interpolate",{"type":55,"value":873},{"type":49,"tag":326,"props":6161,"children":6163},{"className":6162},[],[6164],{"type":55,"value":6165},"apply()",{"type":55,"value":873},{"type":49,"tag":326,"props":6168,"children":6170},{"className":6169},[],[6171],{"type":55,"value":6172},"all()",{"type":55,"value":6174}," and the differences between ",{"type":49,"tag":326,"props":6176,"children":6178},{"className":6177},[],[6179],{"type":55,"value":6180},"getX",{"type":55,"value":715},{"type":49,"tag":326,"props":6183,"children":6185},{"className":6184},[],[6186],{"type":55,"value":6187},"getXOutput",{"type":55,"value":6189},". There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way.",{"type":49,"tag":50,"props":6191,"children":6193},{"id":6192},"environment-configuration",[6194],{"type":55,"value":6195},"Environment configuration",{"type":49,"tag":58,"props":6197,"children":6198},{},[6199],{"type":55,"value":6200},"Environment configuration allows for either a base or app stack to be configured with non-default values. For example:",{"type":49,"tag":64,"props":6202,"children":6203},{},[6204,6209],{"type":49,"tag":68,"props":6205,"children":6206},{},[6207],{"type":55,"value":6208},"you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration",{"type":49,"tag":68,"props":6210,"children":6211},{},[6212],{"type":55,"value":6213},"You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config.",{"type":49,"tag":58,"props":6215,"children":6216},{},[6217],{"type":55,"value":6218},"In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values.",{"type":49,"tag":64,"props":6220,"children":6221},{},[6222,6243,6256],{"type":49,"tag":68,"props":6223,"children":6224},{},[6225,6227,6233,6235,6242],{"type":55,"value":6226},"Pulumi defines environment-specific config in files called ",{"type":49,"tag":326,"props":6228,"children":6230},{"className":6229},[],[6231],{"type":55,"value":6232},"Pulumi.{env}.yaml",{"type":55,"value":6234}," (",{"type":49,"tag":80,"props":6236,"children":6239},{"href":6237,"rel":6238},"https://www.pulumi.com/docs/intro/concepts/config/",[84],[6240],{"type":55,"value":6241},"Pulumi article on configuration",{"type":55,"value":616},{"type":49,"tag":68,"props":6244,"children":6245},{},[6246,6248,6254],{"type":55,"value":6247},"Terraform uses ",{"type":49,"tag":326,"props":6249,"children":6251},{"className":6250},[],[6252],{"type":55,"value":6253},"{env}.tfvars",{"type":55,"value":6255}," for this type of configuration",{"type":49,"tag":68,"props":6257,"children":6258},{},[6259,6261,6267],{"type":55,"value":6260},"CDK has several options for this type of configuration (",{"type":49,"tag":326,"props":6262,"children":6264},{"className":6263},[],[6265],{"type":55,"value":6266},"cdk.context.json",{"type":55,"value":6268},", extending stack props, etc.)",{"type":49,"tag":58,"props":6270,"children":6271},{},[6272,6274,6279,6281,6287],{"type":55,"value":6273},"For CDK I have been using ",{"type":49,"tag":326,"props":6275,"children":6277},{"className":6276},[],[6278],{"type":55,"value":4780},{"type":55,"value":6280}," and the ",{"type":49,"tag":326,"props":6282,"children":6284},{"className":6283},[],[6285],{"type":55,"value":6286},"tryGetContext",{"type":55,"value":6288}," method:",{"type":49,"tag":58,"props":6290,"children":6291},{},[6292,6297],{"type":49,"tag":326,"props":6293,"children":6295},{"className":6294},[],[6296],{"type":55,"value":4780},{"type":55,"value":6298}," needs to be set on the node before any child nodes are added:",{"type":49,"tag":1050,"props":6300,"children":6302},{"code":6301,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n",[6303],{"type":49,"tag":326,"props":6304,"children":6305},{"__ignoreMap":8},[6306,6341,6364,6371,6406],{"type":49,"tag":1060,"props":6307,"children":6308},{"class":1062,"line":1063},[6309,6313,6317,6321,6325,6329,6333,6337],{"type":49,"tag":1060,"props":6310,"children":6311},{"style":2182},[6312],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6314,"children":6315},{"style":2188},[6316],{"type":55,"value":4739},{"type":49,"tag":1060,"props":6318,"children":6319},{"style":2194},[6320],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6322,"children":6323},{"style":2194},[6324],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6326,"children":6327},{"style":1067},[6328],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6330,"children":6331},{"style":1073},[6332],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6334,"children":6335},{"style":2215},[6336],{"type":55,"value":4762},{"type":49,"tag":1060,"props":6338,"children":6339},{"style":1073},[6340],{"type":55,"value":4767},{"type":49,"tag":1060,"props":6342,"children":6343},{"class":1062,"line":1079},[6344,6348,6352,6356,6360],{"type":49,"tag":1060,"props":6345,"children":6346},{"style":1073},[6347],{"type":55,"value":4775},{"type":49,"tag":1060,"props":6349,"children":6350},{"style":1067},[6351],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6353,"children":6354},{"style":1073},[6355],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6357,"children":6358},{"style":2215},[6359],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6361,"children":6362},{"style":1073},[6363],{"type":55,"value":4794},{"type":49,"tag":1060,"props":6365,"children":6366},{"class":1062,"line":1088},[6367],{"type":49,"tag":1060,"props":6368,"children":6369},{"emptyLinePlaceholder":44},[6370],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6372,"children":6373},{"class":1062,"line":1097},[6374,6378,6382,6386,6390,6394,6398,6402],{"type":49,"tag":1060,"props":6375,"children":6376},{"style":2182},[6377],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6379,"children":6380},{"style":2188},[6381],{"type":55,"value":4813},{"type":49,"tag":1060,"props":6383,"children":6384},{"style":2194},[6385],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6387,"children":6388},{"style":2194},[6389],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6391,"children":6392},{"style":1067},[6393],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6395,"children":6396},{"style":1073},[6397],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6399,"children":6400},{"style":2215},[6401],{"type":55,"value":4834},{"type":49,"tag":1060,"props":6403,"children":6404},{"style":1073},[6405],{"type":55,"value":4839},{"type":49,"tag":1060,"props":6407,"children":6408},{"class":1062,"line":1111},[6409,6413,6417,6421,6425],{"type":49,"tag":1060,"props":6410,"children":6411},{"style":1073},[6412],{"type":55,"value":4847},{"type":49,"tag":1060,"props":6414,"children":6415},{"style":1067},[6416],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6418,"children":6419},{"style":1073},[6420],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6422,"children":6423},{"style":2215},[6424],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6426,"children":6427},{"style":1073},[6428],{"type":55,"value":4864},{"type":49,"tag":58,"props":6430,"children":6431},{},[6432],{"type":55,"value":6433},"And the config objects are read from JSON files like this:",{"type":49,"tag":1050,"props":6435,"children":6437},{"code":6436,"language":2171,"meta":8,"className":2172,"style":8},"var adHocBaseEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/base/config/${adHocBaseEnvName}.json`, 'utf8'));\nvar adHocAppEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/app/config/${adHocAppEnvName}.json`, 'utf8'));\n",[6438],{"type":49,"tag":326,"props":6439,"children":6440},{"__ignoreMap":8},[6441,6523],{"type":49,"tag":1060,"props":6442,"children":6443},{"class":1062,"line":1063},[6444,6449,6454,6458,6463,6467,6472,6477,6482,6486,6491,6495,6500,6504,6509,6513,6518],{"type":49,"tag":1060,"props":6445,"children":6446},{"style":2182},[6447],{"type":55,"value":6448},"var",{"type":49,"tag":1060,"props":6450,"children":6451},{"style":1073},[6452],{"type":55,"value":6453}," adHocBaseEnvConfig ",{"type":49,"tag":1060,"props":6455,"children":6456},{"style":2194},[6457],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6459,"children":6460},{"style":2188},[6461],{"type":55,"value":6462}," JSON",{"type":49,"tag":1060,"props":6464,"children":6465},{"style":1073},[6466],{"type":55,"value":745},{"type":49,"tag":1060,"props":6468,"children":6469},{"style":1067},[6470],{"type":55,"value":6471},"parse",{"type":49,"tag":1060,"props":6473,"children":6474},{"style":1073},[6475],{"type":55,"value":6476},"(fs.",{"type":49,"tag":1060,"props":6478,"children":6479},{"style":1067},[6480],{"type":55,"value":6481},"readFileSync",{"type":49,"tag":1060,"props":6483,"children":6484},{"style":1073},[6485],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6487,"children":6488},{"style":2215},[6489],{"type":55,"value":6490},"`src/examples/ad-hoc/base/config/",{"type":49,"tag":1060,"props":6492,"children":6493},{"style":3488},[6494],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6496,"children":6497},{"style":1073},[6498],{"type":55,"value":6499},"adHocBaseEnvName",{"type":49,"tag":1060,"props":6501,"children":6502},{"style":3488},[6503],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6505,"children":6506},{"style":2215},[6507],{"type":55,"value":6508},".json`",{"type":49,"tag":1060,"props":6510,"children":6511},{"style":1073},[6512],{"type":55,"value":873},{"type":49,"tag":1060,"props":6514,"children":6515},{"style":2215},[6516],{"type":55,"value":6517},"'utf8'",{"type":49,"tag":1060,"props":6519,"children":6520},{"style":1073},[6521],{"type":55,"value":6522},"));\n",{"type":49,"tag":1060,"props":6524,"children":6525},{"class":1062,"line":1079},[6526,6530,6535,6539,6543,6547,6551,6555,6559,6563,6568,6572,6577,6581,6585,6589,6593],{"type":49,"tag":1060,"props":6527,"children":6528},{"style":2182},[6529],{"type":55,"value":6448},{"type":49,"tag":1060,"props":6531,"children":6532},{"style":1073},[6533],{"type":55,"value":6534}," adHocAppEnvConfig ",{"type":49,"tag":1060,"props":6536,"children":6537},{"style":2194},[6538],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6540,"children":6541},{"style":2188},[6542],{"type":55,"value":6462},{"type":49,"tag":1060,"props":6544,"children":6545},{"style":1073},[6546],{"type":55,"value":745},{"type":49,"tag":1060,"props":6548,"children":6549},{"style":1067},[6550],{"type":55,"value":6471},{"type":49,"tag":1060,"props":6552,"children":6553},{"style":1073},[6554],{"type":55,"value":6476},{"type":49,"tag":1060,"props":6556,"children":6557},{"style":1067},[6558],{"type":55,"value":6481},{"type":49,"tag":1060,"props":6560,"children":6561},{"style":1073},[6562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6564,"children":6565},{"style":2215},[6566],{"type":55,"value":6567},"`src/examples/ad-hoc/app/config/",{"type":49,"tag":1060,"props":6569,"children":6570},{"style":3488},[6571],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6573,"children":6574},{"style":1073},[6575],{"type":55,"value":6576},"adHocAppEnvName",{"type":49,"tag":1060,"props":6578,"children":6579},{"style":3488},[6580],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6582,"children":6583},{"style":2215},[6584],{"type":55,"value":6508},{"type":49,"tag":1060,"props":6586,"children":6587},{"style":1073},[6588],{"type":55,"value":873},{"type":49,"tag":1060,"props":6590,"children":6591},{"style":2215},[6592],{"type":55,"value":6517},{"type":49,"tag":1060,"props":6594,"children":6595},{"style":1073},[6596],{"type":55,"value":6522},{"type":49,"tag":58,"props":6598,"children":6599},{},[6600],{"type":55,"value":6601},"The context can be used in constructs like this:",{"type":49,"tag":1050,"props":6603,"children":6605},{"code":6604,"language":2171,"meta":8,"className":2172,"style":8},"    const extraEnvVars = this.node.tryGetContext('config').extraEnvVars;\n",[6606],{"type":49,"tag":326,"props":6607,"children":6608},{"__ignoreMap":8},[6609],{"type":49,"tag":1060,"props":6610,"children":6611},{"class":1062,"line":1063},[6612,6616,6621,6625,6630,6635,6639,6643,6647],{"type":49,"tag":1060,"props":6613,"children":6614},{"style":2182},[6615],{"type":55,"value":2185},{"type":49,"tag":1060,"props":6617,"children":6618},{"style":2188},[6619],{"type":55,"value":6620}," extraEnvVars",{"type":49,"tag":1060,"props":6622,"children":6623},{"style":2194},[6624],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6626,"children":6627},{"style":3797},[6628],{"type":55,"value":6629}," this",{"type":49,"tag":1060,"props":6631,"children":6632},{"style":1073},[6633],{"type":55,"value":6634},".node.",{"type":49,"tag":1060,"props":6636,"children":6637},{"style":1067},[6638],{"type":55,"value":6286},{"type":49,"tag":1060,"props":6640,"children":6641},{"style":1073},[6642],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6644,"children":6645},{"style":2215},[6646],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6648,"children":6649},{"style":1073},[6650],{"type":55,"value":6651},").extraEnvVars;\n",{"type":49,"tag":58,"props":6653,"children":6654},{},[6655],{"type":55,"value":6656},"Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:",{"type":49,"tag":1050,"props":6658,"children":6660},{"code":6659,"language":2171,"meta":8,"className":2172,"style":8},"    interface EnvVar {\n      name: string;\n      value: string;\n    }\n\n    let config = new pulumi.Config();\n    let extraEnvVars = config.getObject\u003CEnvVar[]>(\"extraEnvVars\");\n",[6661],{"type":49,"tag":326,"props":6662,"children":6663},{"__ignoreMap":8},[6664,6681,6704,6724,6731,6738,6773],{"type":49,"tag":1060,"props":6665,"children":6666},{"class":1062,"line":1063},[6667,6672,6677],{"type":49,"tag":1060,"props":6668,"children":6669},{"style":2182},[6670],{"type":55,"value":6671},"    interface",{"type":49,"tag":1060,"props":6673,"children":6674},{"style":3992},[6675],{"type":55,"value":6676}," EnvVar",{"type":49,"tag":1060,"props":6678,"children":6679},{"style":1073},[6680],{"type":55,"value":4010},{"type":49,"tag":1060,"props":6682,"children":6683},{"class":1062,"line":1079},[6684,6690,6695,6700],{"type":49,"tag":1060,"props":6685,"children":6687},{"style":6686},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2",[6688],{"type":55,"value":6689},"      name",{"type":49,"tag":1060,"props":6691,"children":6692},{"style":2194},[6693],{"type":55,"value":6694},":",{"type":49,"tag":1060,"props":6696,"children":6697},{"style":5200},[6698],{"type":55,"value":6699}," string",{"type":49,"tag":1060,"props":6701,"children":6702},{"style":1073},[6703],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6705,"children":6706},{"class":1062,"line":1088},[6707,6712,6716,6720],{"type":49,"tag":1060,"props":6708,"children":6709},{"style":6686},[6710],{"type":55,"value":6711},"      value",{"type":49,"tag":1060,"props":6713,"children":6714},{"style":2194},[6715],{"type":55,"value":6694},{"type":49,"tag":1060,"props":6717,"children":6718},{"style":5200},[6719],{"type":55,"value":6699},{"type":49,"tag":1060,"props":6721,"children":6722},{"style":1073},[6723],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6725,"children":6726},{"class":1062,"line":1097},[6727],{"type":49,"tag":1060,"props":6728,"children":6729},{"style":1073},[6730],{"type":55,"value":3100},{"type":49,"tag":1060,"props":6732,"children":6733},{"class":1062,"line":1111},[6734],{"type":49,"tag":1060,"props":6735,"children":6736},{"emptyLinePlaceholder":44},[6737],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6739,"children":6740},{"class":1062,"line":1120},[6741,6746,6751,6755,6759,6763,6768],{"type":49,"tag":1060,"props":6742,"children":6743},{"style":2182},[6744],{"type":55,"value":6745},"    let",{"type":49,"tag":1060,"props":6747,"children":6748},{"style":1073},[6749],{"type":55,"value":6750}," config ",{"type":49,"tag":1060,"props":6752,"children":6753},{"style":2194},[6754],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6756,"children":6757},{"style":2194},[6758],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6760,"children":6761},{"style":1073},[6762],{"type":55,"value":3459},{"type":49,"tag":1060,"props":6764,"children":6765},{"style":1067},[6766],{"type":55,"value":6767},"Config",{"type":49,"tag":1060,"props":6769,"children":6770},{"style":1073},[6771],{"type":55,"value":6772},"();\n",{"type":49,"tag":1060,"props":6774,"children":6775},{"class":1062,"line":1128},[6776,6780,6785,6789,6794,6799,6803,6808,6813,6818],{"type":49,"tag":1060,"props":6777,"children":6778},{"style":2182},[6779],{"type":55,"value":6745},{"type":49,"tag":1060,"props":6781,"children":6782},{"style":1073},[6783],{"type":55,"value":6784}," extraEnvVars ",{"type":49,"tag":1060,"props":6786,"children":6787},{"style":2194},[6788],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6790,"children":6791},{"style":1073},[6792],{"type":55,"value":6793}," config.",{"type":49,"tag":1060,"props":6795,"children":6796},{"style":1067},[6797],{"type":55,"value":6798},"getObject",{"type":49,"tag":1060,"props":6800,"children":6801},{"style":1073},[6802],{"type":55,"value":5197},{"type":49,"tag":1060,"props":6804,"children":6805},{"style":3992},[6806],{"type":55,"value":6807},"EnvVar",{"type":49,"tag":1060,"props":6809,"children":6810},{"style":1073},[6811],{"type":55,"value":6812},"[]>(",{"type":49,"tag":1060,"props":6814,"children":6815},{"style":2215},[6816],{"type":55,"value":6817},"\"extraEnvVars\"",{"type":49,"tag":1060,"props":6819,"children":6820},{"style":1073},[6821],{"type":55,"value":2305},{"type":49,"tag":58,"props":6823,"children":6824},{},[6825,6827,6833,6835,6841],{"type":55,"value":6826},"In my ",{"type":49,"tag":326,"props":6828,"children":6830},{"className":6829},[],[6831],{"type":55,"value":6832},"Pulumi.alpha.yaml",{"type":55,"value":6834}," file I have the ",{"type":49,"tag":326,"props":6836,"children":6838},{"className":6837},[],[6839],{"type":55,"value":6840},"extraEnvVars",{"type":55,"value":6842}," set like this:",{"type":49,"tag":1050,"props":6844,"children":6846},{"code":6845,"language":3823,"meta":8,"className":3824,"style":8},"config:\n  aws:region: us-east-1\n  extraEnvVars:\n    - name: FOO\n      value: BAR\n    - name: BIZ\n      value: BUZ\n",[6847],{"type":49,"tag":326,"props":6848,"children":6849},{"__ignoreMap":8},[6850,6863,6880,6892,6913,6929,6949],{"type":49,"tag":1060,"props":6851,"children":6852},{"class":1062,"line":1063},[6853,6858],{"type":49,"tag":1060,"props":6854,"children":6855},{"style":3839},[6856],{"type":55,"value":6857},"config",{"type":49,"tag":1060,"props":6859,"children":6860},{"style":1073},[6861],{"type":55,"value":6862},":\n",{"type":49,"tag":1060,"props":6864,"children":6865},{"class":1062,"line":1079},[6866,6871,6875],{"type":49,"tag":1060,"props":6867,"children":6868},{"style":3839},[6869],{"type":55,"value":6870},"  aws:region",{"type":49,"tag":1060,"props":6872,"children":6873},{"style":1073},[6874],{"type":55,"value":78},{"type":49,"tag":1060,"props":6876,"children":6877},{"style":2215},[6878],{"type":55,"value":6879},"us-east-1\n",{"type":49,"tag":1060,"props":6881,"children":6882},{"class":1062,"line":1088},[6883,6888],{"type":49,"tag":1060,"props":6884,"children":6885},{"style":3839},[6886],{"type":55,"value":6887},"  extraEnvVars",{"type":49,"tag":1060,"props":6889,"children":6890},{"style":1073},[6891],{"type":55,"value":6862},{"type":49,"tag":1060,"props":6893,"children":6894},{"class":1062,"line":1097},[6895,6900,6904,6908],{"type":49,"tag":1060,"props":6896,"children":6897},{"style":1073},[6898],{"type":55,"value":6899},"    - ",{"type":49,"tag":1060,"props":6901,"children":6902},{"style":3839},[6903],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6905,"children":6906},{"style":1073},[6907],{"type":55,"value":78},{"type":49,"tag":1060,"props":6909,"children":6910},{"style":2215},[6911],{"type":55,"value":6912},"FOO\n",{"type":49,"tag":1060,"props":6914,"children":6915},{"class":1062,"line":1111},[6916,6920,6924],{"type":49,"tag":1060,"props":6917,"children":6918},{"style":3839},[6919],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6921,"children":6922},{"style":1073},[6923],{"type":55,"value":78},{"type":49,"tag":1060,"props":6925,"children":6926},{"style":2215},[6927],{"type":55,"value":6928},"BAR\n",{"type":49,"tag":1060,"props":6930,"children":6931},{"class":1062,"line":1120},[6932,6936,6940,6944],{"type":49,"tag":1060,"props":6933,"children":6934},{"style":1073},[6935],{"type":55,"value":6899},{"type":49,"tag":1060,"props":6937,"children":6938},{"style":3839},[6939],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6941,"children":6942},{"style":1073},[6943],{"type":55,"value":78},{"type":49,"tag":1060,"props":6945,"children":6946},{"style":2215},[6947],{"type":55,"value":6948},"BIZ\n",{"type":49,"tag":1060,"props":6950,"children":6951},{"class":1062,"line":1128},[6952,6956,6960],{"type":49,"tag":1060,"props":6953,"children":6954},{"style":3839},[6955],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6957,"children":6958},{"style":1073},[6959],{"type":55,"value":78},{"type":49,"tag":1060,"props":6961,"children":6962},{"style":2215},[6963],{"type":55,"value":6964},"BUZ\n",{"type":49,"tag":58,"props":6966,"children":6967},{},[6968],{"type":55,"value":6969},"I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)",{"type":49,"tag":50,"props":6971,"children":6973},{"id":6972},"local-development",[6974],{"type":55,"value":6975},"Local development",{"type":49,"tag":58,"props":6977,"children":6978},{},[6979,6981,6986],{"type":55,"value":6980},"Using the Makefile targets in each library repo, my process for developing ",{"type":49,"tag":326,"props":6982,"children":6984},{"className":6983},[],[6985],{"type":55,"value":457},{"type":55,"value":6987},"s involves making code changes followed by Makefile targets that preview/plan/diff against my AWS account, then running deploy/apply/up and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services.",{"type":49,"tag":58,"props":6989,"children":6990},{},[6991],{"type":55,"value":6992},"Here are some sample times for deploying ad hoc stacks with CDK.",{"type":49,"tag":1050,"props":6994,"children":6996},{"code":6995},"# CDK ad hoc base deployment time\n\n ✅  ExampleAdHocBaseStack (dev)\n\n✨  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ✅  ExampleAdHocAppStack (alpha)\n\n✨  Deployment time: 126.62s\n",[6997],{"type":49,"tag":326,"props":6998,"children":6999},{"__ignoreMap":8},[7000],{"type":55,"value":6995},{"type":49,"tag":58,"props":7002,"children":7003},{},[7004,7006,7011],{"type":55,"value":7005},"Here is an example of what the ",{"type":49,"tag":326,"props":7007,"children":7009},{"className":7008},[],[7010],{"type":55,"value":572},{"type":55,"value":7012}," commands shows for the ad-hoc base stack:",{"type":49,"tag":1050,"props":7014,"children":7016},{"code":7015},"# Pulumi preview\n~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview\nPreviewing update (dev)\n\nView Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   └─ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ├─ pulumi-contrib:components:AlbResources            AlbResources                create\n +      │  ├─ aws:alb:TargetGroup                            DefaultTg                   create\n +      │  ├─ aws:alb:LoadBalancer                           LoadBalancer                create\n +      │  ├─ aws:alb:Listener                               HttpListener                create\n +      │  └─ aws:alb:Listener                               HttpsListener               create\n +      ├─ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      │  ├─ aws:iam:Role                                   BastionHostRole             create\n +      │  ├─ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      │  ├─ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      │  └─ aws:ec2:Instance                               BastionHostInstance         create\n +      ├─ pulumi-contrib:components:RdsResources            RdsResources                create\n +      │  ├─ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      │  ├─ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      │  └─ aws:rds:Instance                               DbInstance                  create\n +      ├─ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      │  ├─ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      │  └─ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ├─ aws:s3:Bucket                                     assetsBucket                create\n +      ├─ awsx:ec2:Vpc                                      dev                         create\n +      │  └─ aws:ec2:Vpc                                    dev                         create\n +      │     ├─ aws:ec2:InternetGateway                     dev                         create\n +      │     ├─ aws:ec2:Subnet                              dev-private-1               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-1               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      │     │     └─ aws:ec2:Route                         dev-private-1               create\n +      │     ├─ aws:ec2:Subnet                              dev-private-2               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-2               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      │     │     └─ aws:ec2:Route                         dev-private-2               create\n +      │     ├─ aws:ec2:Subnet                              dev-public-1                create\n +      │     │  ├─ aws:ec2:RouteTable                       dev-public-1                create\n +      │     │  │  ├─ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      │     │  │  └─ aws:ec2:Route                         dev-public-1                create\n +      │     │  ├─ aws:ec2:Eip                              dev-1                       create\n +      │     │  └─ aws:ec2:NatGateway                       dev-1                       create\n +      │     └─ aws:ec2:Subnet                              dev-public-2                create\n +      │        ├─ aws:ec2:RouteTable                       dev-public-2                create\n +      │        │  ├─ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      │        │  └─ aws:ec2:Route                         dev-public-2                create\n +      │        ├─ aws:ec2:Eip                              dev-2                       create\n +      │        └─ aws:ec2:NatGateway                       dev-2                       create\n +      └─ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output\u003Cstring>\n    albSgId                    : output\u003Cstring>\n    appSgId                    : output\u003Cstring>\n    assetsBucketName           : output\u003Cstring>\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output\u003Cstring>\n    domainName                 : \"example.com\"\n    listenerArn                : output\u003Cstring>\n    privateSubnetIds           : output\u003Cstring>\n    rdsAddress                 : output\u003Cstring>\n    serviceDiscoveryNamespaceId: output\u003Cstring>\n    vpcId                      : output\u003Cstring>\n\nResources:\n    + 44 to create\n",[7017],{"type":49,"tag":326,"props":7018,"children":7019},{"__ignoreMap":8},[7020],{"type":55,"value":7015},{"type":49,"tag":50,"props":7022,"children":7024},{"id":7023},"running-infrastructure-pipelines-in-github-actions",[7025],{"type":55,"value":7026},"Running infrastructure pipelines in GitHub Actions",{"type":49,"tag":58,"props":7028,"children":7029},{},[7030],{"type":49,"tag":126,"props":7031,"children":7032},{},[7033],{"type":55,"value":7034},"I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!",{"type":49,"tag":58,"props":7036,"children":7037},{},[7038,7039,7045,7047,7052,7054,7060],{"type":55,"value":2613},{"type":49,"tag":326,"props":7040,"children":7042},{"className":7041},[],[7043],{"type":55,"value":7044},".github/workflows",{"type":55,"value":7046}," directory of the ",{"type":49,"tag":326,"props":7048,"children":7050},{"className":7049},[],[7051],{"type":55,"value":1627},{"type":55,"value":7053}," repo, I will have the following ",{"type":49,"tag":326,"props":7055,"children":7057},{"className":7056},[],[7058],{"type":55,"value":7059},"2 * 2 * 2 * 3 = 24",{"type":55,"value":7061}," pipelines for running infrastructure as code pipelines:",{"type":49,"tag":1050,"props":7063,"children":7065},{"code":7064,"language":2728,"meta":8,"className":2729,"style":8},"{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n",[7066],{"type":49,"tag":326,"props":7067,"children":7068},{"__ignoreMap":8},[7069],{"type":49,"tag":1060,"props":7070,"children":7071},{"class":1062,"line":1063},[7072],{"type":49,"tag":1060,"props":7073,"children":7074},{"style":1073},[7075],{"type":55,"value":7064},{"type":49,"tag":64,"props":7077,"children":7078},{},[7079,7084,7089],{"type":49,"tag":68,"props":7080,"children":7081},{},[7082],{"type":55,"value":7083},"For CDK I'm using CDK CLI commands",{"type":49,"tag":68,"props":7085,"children":7086},{},[7087],{"type":55,"value":7088},"For Terraform I'm also using terraform CLI commands",{"type":49,"tag":68,"props":7090,"children":7091},{},[7092],{"type":55,"value":7093},"For Pulumi I'm using the official Pulumi GitHub Action",{"type":49,"tag":58,"props":7095,"children":7096},{},[7097,7098,7105],{"type":55,"value":6030},{"type":49,"tag":80,"props":7099,"children":7102},{"href":7100,"rel":7101},"https://www.pulumi.com/docs/guides/continuous-delivery/github-actions/",[84],[7103],{"type":55,"value":7104},"a great article",{"type":55,"value":7106}," about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags.",{"type":49,"tag":58,"props":7108,"children":7109},{},[7110],{"type":55,"value":7111},"The general pattern that all of these pipelines use is:",{"type":49,"tag":64,"props":7113,"children":7114},{},[7115,7120,7125],{"type":49,"tag":68,"props":7116,"children":7117},{},[7118],{"type":55,"value":7119},"Do a synth/plan/preview, and upload the synth/plan/preview file to an artifact",{"type":49,"tag":68,"props":7121,"children":7122},{},[7123],{"type":55,"value":7124},"Pause and wait on manual review of the planned changes",{"type":49,"tag":68,"props":7126,"children":7127},{},[7128],{"type":55,"value":7129},"download the artifact and run deploy/apply/up against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected.",{"type":49,"tag":58,"props":7131,"children":7132},{},[7133],{"type":55,"value":7134},"I do this by having two jobs in each GitHub Action: one for synth/plan/preview and one for deploy/apply/up.",{"type":49,"tag":58,"props":7136,"children":7137},{},[7138,7140,7145],{"type":55,"value":7139},"The job for deploy/apply/up includes an ",{"type":49,"tag":326,"props":7141,"children":7143},{"className":7142},[],[7144],{"type":55,"value":5113},{"type":55,"value":7146}," that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job.",{"type":49,"tag":50,"props":7148,"children":7150},{"id":7149},"application-deployments",[7151],{"type":55,"value":7152},"Application deployments",{"type":49,"tag":64,"props":7154,"children":7155},{},[7156,7161,7173],{"type":49,"tag":68,"props":7157,"children":7158},{},[7159],{"type":55,"value":7160},"There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)",{"type":49,"tag":68,"props":7162,"children":7163},{},[7164,7166,7171],{"type":55,"value":7165},"The backend deployment script runs database migrations, the ",{"type":49,"tag":326,"props":7167,"children":7169},{"className":7168},[],[7170],{"type":55,"value":3316},{"type":55,"value":7172}," command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)",{"type":49,"tag":68,"props":7174,"children":7175},{},[7176],{"type":55,"value":7177},"What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks.",{"type":49,"tag":50,"props":7179,"children":7181},{"id":7180},"interacting-with-aws-via-iac",[7182],{"type":55,"value":7183},"Interacting with AWS via IaC",{"type":49,"tag":64,"props":7185,"children":7186},{},[7187,7201,7226],{"type":49,"tag":68,"props":7188,"children":7189},{},[7190,7192,7199],{"type":55,"value":7191},"CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides ",{"type":49,"tag":80,"props":7193,"children":7196},{"href":7194,"rel":7195},"https://docs.aws.amazon.com/cdk/v2/guide/constructs.html",[84],[7197],{"type":55,"value":7198},"L1, L2 and L3 constructs",{"type":55,"value":7200}," which offer different levels of abstraction over CloudFormation.",{"type":49,"tag":68,"props":7202,"children":7203},{},[7204,7206,7213,7214,7225],{"type":55,"value":7205},"Terraform has the ",{"type":49,"tag":80,"props":7207,"children":7210},{"href":7208,"rel":7209},"https://registry.terraform.io/providers/hashicorp/aws/latest/docs",[84],[7211],{"type":55,"value":7212},"AWS Provider",{"type":55,"value":6280},{"type":49,"tag":80,"props":7215,"children":7218},{"href":7216,"rel":7217},"https://registry.terraform.io/namespaces/terraform-aws-modules",[84],[7219],{"type":49,"tag":326,"props":7220,"children":7222},{"className":7221},[],[7223],{"type":55,"value":7224},"terraform-aws-modules",{"type":55,"value":745},{"type":49,"tag":68,"props":7227,"children":7228},{},[7229,7231,7236,7237,7242,7243,7249,7250,7257,7258,7263,7264,7270,7271,7275],{"type":55,"value":7230},"Pulumi has AWS Classic (",{"type":49,"tag":326,"props":7232,"children":7234},{"className":7233},[],[7235],{"type":55,"value":496},{"type":55,"value":5173},{"type":49,"tag":72,"props":7238,"children":7239},{},[7240],{"type":55,"value":7241},"provider",{"type":55,"value":715},{"type":49,"tag":326,"props":7244,"children":7246},{"className":7245},[],[7247],{"type":55,"value":7248},"AWSx",{"type":55,"value":6234},{"type":49,"tag":80,"props":7251,"children":7254},{"href":7252,"rel":7253},"https://www.pulumi.com/registry/packages/awsx/",[84],[7255],{"type":55,"value":7256},"Crosswalk for Pulumi",{"type":55,"value":5173},{"type":49,"tag":72,"props":7259,"children":7260},{},[7261],{"type":55,"value":7262},"library",{"type":55,"value":715},{"type":49,"tag":326,"props":7265,"children":7267},{"className":7266},[],[7268],{"type":55,"value":7269},"aws_native",{"type":55,"value":1909},{"type":49,"tag":72,"props":7272,"children":7273},{},[7274],{"type":55,"value":7241},{"type":55,"value":745},{"type":49,"tag":2910,"props":7277,"children":7278},{},[7279],{"type":49,"tag":58,"props":7280,"children":7281},{},[7282,7287],{"type":49,"tag":326,"props":7283,"children":7285},{"className":7284},[],[7286],{"type":55,"value":7269},{"type":55,"value":7288}," \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\"",{"type":49,"tag":58,"props":7290,"children":7291},{},[7292,7297],{"type":49,"tag":326,"props":7293,"children":7295},{"className":7294},[],[7296],{"type":55,"value":7269},{"type":55,"value":7298}," looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider.",{"type":49,"tag":58,"props":7300,"children":7301},{},[7302],{"type":55,"value":7303},"For CDK I use mostly L2 constructs and some L1 constructs.",{"type":49,"tag":58,"props":7305,"children":7306},{},[7307,7309,7314],{"type":55,"value":7308},"Fot Terraform I use the VPC from the ",{"type":49,"tag":326,"props":7310,"children":7312},{"className":7311},[],[7313],{"type":55,"value":7224},{"type":55,"value":7315},", and everything else uses the AWS Terraform Provider.",{"type":49,"tag":50,"props":7317,"children":7319},{"id":7318},"what-i-did-not-put-in-iac",[7320],{"type":55,"value":7321},"What I did not put in IaC",{"type":49,"tag":64,"props":7323,"children":7324},{},[7325,7330,7335],{"type":49,"tag":68,"props":7326,"children":7327},{},[7328],{"type":55,"value":7329},"ECR (Elastic Container Registry)",{"type":49,"tag":68,"props":7331,"children":7332},{},[7333],{"type":55,"value":7334},"ACM (Amazon Certificate Manager)",{"type":49,"tag":68,"props":7336,"children":7337},{},[7338],{"type":55,"value":7339},"(Roles used for deployments)",{"type":49,"tag":58,"props":7341,"children":7342},{},[7343,7345,7350,7351,7356,7358,7364],{"type":55,"value":7344},"I created the Elastic Container Registry ",{"type":49,"tag":326,"props":7346,"children":7348},{"className":7347},[],[7349],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":7352,"children":7354},{"className":7353},[],[7355],{"type":55,"value":1958},{"type":55,"value":7357}," repos manually in the AWS Console. I also manually requested an ACM certificate for ",{"type":49,"tag":326,"props":7359,"children":7361},{"className":7360},[],[7362],{"type":55,"value":7363},"*.mydomain.com",{"type":55,"value":7365}," for the domain that I use for testing that I purchased through Route53 domains.",{"type":49,"tag":58,"props":7367,"children":7368},{},[7369],{"type":55,"value":7370},"I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog.",{"type":49,"tag":50,"props":7372,"children":7374},{"id":7373},"tagging",[7375],{"type":55,"value":7376},"Tagging",{"type":49,"tag":64,"props":7378,"children":7379},{},[7380,7385,7390,7399,7408,7413],{"type":49,"tag":68,"props":7381,"children":7382},{},[7383],{"type":55,"value":7384},"Terraform and CDK both make it easy to automatically tag all resources in a stack",{"type":49,"tag":68,"props":7386,"children":7387},{},[7388],{"type":55,"value":7389},"It is possible to do this in Pulumi, but you need to write a little bit of code.",{"type":49,"tag":68,"props":7391,"children":7392},{},[7393],{"type":49,"tag":80,"props":7394,"children":7397},{"href":7395,"rel":7396},"https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/",[84],[7398],{"type":55,"value":7395},{"type":49,"tag":68,"props":7400,"children":7401},{},[7402],{"type":49,"tag":80,"props":7403,"children":7406},{"href":7404,"rel":7405},"https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts",[84],[7407],{"type":55,"value":7404},{"type":49,"tag":68,"props":7409,"children":7410},{},[7411],{"type":55,"value":7412},"Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)",{"type":49,"tag":68,"props":7414,"children":7415},{},[7416,7418,7425],{"type":55,"value":7417},"Automatically tagging resources works through ",{"type":49,"tag":80,"props":7419,"children":7422},{"href":7420,"rel":7421},"https://www.pulumi.com/docs/intro/vs/terraform/",[84],[7423],{"type":55,"value":7424},"stack transformations",{"type":55,"value":7426}," are unique to Pulumi",{"type":49,"tag":50,"props":7428,"children":7430},{"id":7429},"smoke-checking-application-environments",[7431],{"type":55,"value":7432},"Smoke checking application environments",{"type":49,"tag":58,"props":7434,"children":7435},{},[7436],{"type":55,"value":7437},"Here's the list of things I check when standing up an application environment:",{"type":49,"tag":64,"props":7439,"children":7442},{"className":7440},[7441],"contains-task-list",[7443,7455,7471,7487,7503,7519,7535,7551,7560,7569,7578,7587,7596,7605],{"type":49,"tag":68,"props":7444,"children":7447},{"className":7445},[7446],"task-list-item",[7448,7453],{"type":49,"tag":7449,"props":7450,"children":7452},"input",{"checked":44,"disabled":44,"type":7451},"checkbox",[],{"type":55,"value":7454}," Run the init/tsc, synth/plan/preview and deploy/apply/up commands successfully",{"type":49,"tag":68,"props":7456,"children":7458},{"className":7457},[7446],[7459,7462,7464,7470],{"type":49,"tag":7449,"props":7460,"children":7461},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7463}," Access the bastion host (",{"type":49,"tag":326,"props":7465,"children":7467},{"className":7466},[],[7468],{"type":55,"value":7469},"make aws-ssm-start-session",{"type":55,"value":616},{"type":49,"tag":68,"props":7472,"children":7474},{"className":7473},[7446],[7475,7478,7480,7486],{"type":49,"tag":7449,"props":7476,"children":7477},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7479}," Run ECSExec to access a shell in a backend container (",{"type":49,"tag":326,"props":7481,"children":7483},{"className":7482},[],[7484],{"type":55,"value":7485},"make aws-ecs-exec",{"type":55,"value":616},{"type":49,"tag":68,"props":7488,"children":7490},{"className":7489},[7446],[7491,7494,7496,7502],{"type":49,"tag":7449,"props":7492,"children":7493},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7495}," Test database connectivity (",{"type":49,"tag":326,"props":7497,"children":7499},{"className":7498},[],[7500],{"type":55,"value":7501},"python manage.py showmigrations",{"type":55,"value":616},{"type":49,"tag":68,"props":7504,"children":7506},{"className":7505},[7446],[7507,7510,7512,7518],{"type":49,"tag":7449,"props":7508,"children":7509},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7511}," Run the migrations (",{"type":49,"tag":326,"props":7513,"children":7515},{"className":7514},[],[7516],{"type":55,"value":7517},"python manage.py migrate",{"type":55,"value":616},{"type":49,"tag":68,"props":7520,"children":7522},{"className":7521},[7446],[7523,7526,7528,7534],{"type":49,"tag":7449,"props":7524,"children":7525},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7527}," Run collectstatic (",{"type":49,"tag":326,"props":7529,"children":7531},{"className":7530},[],[7532],{"type":55,"value":7533},"python manage.py collectstatic",{"type":55,"value":616},{"type":49,"tag":68,"props":7536,"children":7538},{"className":7537},[7446],[7539,7542,7544,7550],{"type":49,"tag":7449,"props":7540,"children":7541},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7543}," Visit the site (",{"type":49,"tag":326,"props":7545,"children":7547},{"className":7546},[],[7548],{"type":55,"value":7549},"alpha.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":7552,"children":7554},{"className":7553},[7446],[7555,7558],{"type":49,"tag":7449,"props":7556,"children":7557},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7559}," Publish a blog post",{"type":49,"tag":68,"props":7561,"children":7563},{"className":7562},[7446],[7564,7567],{"type":49,"tag":7449,"props":7565,"children":7566},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7568}," Publish a blog post with an image",{"type":49,"tag":68,"props":7570,"children":7572},{"className":7571},[7446],[7573,7576],{"type":49,"tag":7449,"props":7574,"children":7575},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7577}," Check celery worker logs for successfully complete scheduled tasks",{"type":49,"tag":68,"props":7579,"children":7581},{"className":7580},[7446],[7582,7585],{"type":49,"tag":7449,"props":7583,"children":7584},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7586}," Trigger an autoscaling event by running k6 load tests against an environment",{"type":49,"tag":68,"props":7588,"children":7590},{"className":7589},[7446],[7591,7594],{"type":49,"tag":7449,"props":7592,"children":7593},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7595}," Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates",{"type":49,"tag":68,"props":7597,"children":7599},{"className":7598},[7446],[7600,7603],{"type":49,"tag":7449,"props":7601,"children":7602},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7604}," Destroy the app stack",{"type":49,"tag":68,"props":7606,"children":7608},{"className":7607},[7446],[7609,7612],{"type":49,"tag":7449,"props":7610,"children":7611},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7613}," Destroy the base stack",{"type":49,"tag":50,"props":7615,"children":7617},{"id":7616},"backlog-and-next-steps",[7618],{"type":55,"value":7619},"Backlog and next steps",{"type":49,"tag":58,"props":7621,"children":7622},{},[7623],{"type":55,"value":7624},"Here are some of the next things I'll be working on in these project, roughly in order of importance:",{"type":49,"tag":64,"props":7626,"children":7628},{"className":7627},[7441],[7629,7638,7643,7648,7660,7665,7678,7683,7688,7693,7698,7703,7708,7713,7718],{"type":49,"tag":68,"props":7630,"children":7632},{"className":7631},[7446],[7633,7636],{"type":49,"tag":7449,"props":7634,"children":7635},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7637}," Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines",{"type":49,"tag":68,"props":7639,"children":7640},{},[7641],{"type":55,"value":7642},"Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub",{"type":49,"tag":68,"props":7644,"children":7645},{},[7646],{"type":55,"value":7647},"Show how to do account isolation (different accounts for prod vs pre-prod environments)",{"type":49,"tag":68,"props":7649,"children":7650},{},[7651,7653,7658],{"type":55,"value":7652},"GitHub Actions deployment pipeline for publishing ",{"type":49,"tag":326,"props":7654,"children":7656},{"className":7655},[],[7657],{"type":55,"value":699},{"type":55,"value":7659}," package",{"type":49,"tag":68,"props":7661,"children":7662},{},[7663],{"type":55,"value":7664},"Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)",{"type":49,"tag":68,"props":7666,"children":7667},{},[7668,7670,7676],{"type":55,"value":7669},"For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the ",{"type":49,"tag":326,"props":7671,"children":7673},{"className":7672},[],[7674],{"type":55,"value":7675},"random",{"type":55,"value":7677}," functions to do this",{"type":49,"tag":68,"props":7679,"children":7680},{},[7681],{"type":55,"value":7682},"Refactor GitHub Actions and make them reusable across different projects",{"type":49,"tag":68,"props":7684,"children":7685},{},[7686],{"type":55,"value":7687},"Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules",{"type":49,"tag":68,"props":7689,"children":7690},{},[7691],{"type":55,"value":7692},"Use graviton instances and have the option to select between different architectures",{"type":49,"tag":68,"props":7694,"children":7695},{},[7696],{"type":55,"value":7697},"Standardize all resources names across CDK, Terraform and Pulumi",{"type":49,"tag":68,"props":7699,"children":7700},{},[7701],{"type":55,"value":7702},"The Pulumi components that define the resources associated with each ECS service are not very dry",{"type":49,"tag":68,"props":7704,"children":7705},{},[7706],{"type":55,"value":7707},"Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)",{"type":49,"tag":68,"props":7709,"children":7710},{},[7711],{"type":55,"value":7712},"Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is.",{"type":49,"tag":68,"props":7714,"children":7715},{},[7716],{"type":55,"value":7717},"Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional",{"type":49,"tag":68,"props":7719,"children":7720},{},[7721],{"type":55,"value":7722},"experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site",{"type":49,"tag":58,"props":7724,"children":7725},{},[7726],{"type":55,"value":7727},"If you want to get involved or help with any of the above, please let me know!",{"type":49,"tag":50,"props":7729,"children":7731},{"id":7730},"conclusion",[7732],{"type":55,"value":7733},"Conclusion",{"type":49,"tag":58,"props":7735,"children":7736},{},[7737,7739,7746],{"type":55,"value":7738},"I first started out with IaC following this project ",{"type":49,"tag":80,"props":7740,"children":7743},{"href":7741,"rel":7742},"https://github.com/aws-samples/ecs-refarch-cloudformation",[84],[7744],{"type":55,"value":7745},"aws-samples/ecs-refarch-cloudformation",{"type":55,"value":7747}," (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform.",{"type":49,"tag":7749,"props":7750,"children":7751},"style",{},[7752],{"type":55,"value":7753},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":8,"searchDepth":1079,"depth":1079,"links":7755},[7756,7757,7758,7759,7764,7772,7773,7776,7777,7787,7797,7798,7799,7800,7801,7802,7803,7804,7805,7806,7807,7808],{"id":52,"depth":1079,"text":56},{"id":151,"depth":1079,"text":151},{"id":185,"depth":1079,"text":188},{"id":425,"depth":1079,"text":428,"children":7760},[7761,7762,7763],{"id":432,"depth":1088,"text":435},{"id":477,"depth":1088,"text":480},{"id":501,"depth":1088,"text":501},{"id":643,"depth":1079,"text":646,"children":7765},[7766,7767,7768,7769,7770,7771],{"id":702,"depth":1088,"text":705},{"id":776,"depth":1088,"text":779},{"id":909,"depth":1088,"text":912},{"id":1288,"depth":1088,"text":1291},{"id":1334,"depth":1088,"text":1337},{"id":1470,"depth":1088,"text":1473},{"id":1545,"depth":1079,"text":1548},{"id":1589,"depth":1079,"text":1589,"children":7774},[7775],{"id":1613,"depth":1088,"text":1616},{"id":1820,"depth":1079,"text":1823},{"id":1981,"depth":1079,"text":1984,"children":7778},[7779,7780,7781,7782,7783,7784,7785,7786],{"id":2035,"depth":1088,"text":2038},{"id":2062,"depth":1088,"text":2065},{"id":2091,"depth":1088,"text":2094},{"id":2160,"depth":1088,"text":2017},{"id":2357,"depth":1088,"text":2360},{"id":2401,"depth":1088,"text":2404},{"id":2683,"depth":1088,"text":2032},{"id":2763,"depth":1088,"text":2766},{"id":2853,"depth":1079,"text":2856,"children":7788},[7789,7790,7791,7792,7793,7794,7795,7796],{"id":2877,"depth":1088,"text":2880},{"id":2928,"depth":1088,"text":2931},{"id":3119,"depth":1088,"text":3122},{"id":3151,"depth":1088,"text":3154},{"id":3167,"depth":1088,"text":3170},{"id":3261,"depth":1088,"text":3264},{"id":3299,"depth":1088,"text":3302},{"id":3966,"depth":1088,"text":2849},{"id":6014,"depth":1079,"text":6017},{"id":6091,"depth":1079,"text":6094},{"id":6192,"depth":1079,"text":6195},{"id":6972,"depth":1079,"text":6975},{"id":7023,"depth":1079,"text":7026},{"id":7149,"depth":1079,"text":7152},{"id":7180,"depth":1079,"text":7183},{"id":7318,"depth":1079,"text":7321},{"id":7373,"depth":1079,"text":7376},{"id":7429,"depth":1079,"text":7432},{"id":7616,"depth":1079,"text":7619},{"id":7730,"depth":1079,"text":7733},"markdown","content:2023:01:07:i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","content","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","md",{"_path":7816,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":7818,"description":7819,"date":7820,"image":7821,"tags":7822,"external":7823,"comments":44,"body":7841,"_type":7809,"_id":13919,"_source":7811,"_file":13920,"_stem":13921,"_extension":7814},"/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","27","Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions","This article will show how software development teams can build on-demand environments for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete instances of a web application.","2022-06-11","/static/adhoc.png",[14,16,19,20,21,23,24],[7824,7826,7828,7830,7832,7833,7836,7838],{"link":7825,"site":28},"https://news.ycombinator.com/item?id=31704417",{"link":7827,"site":31},"https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/",{"link":7829,"site":34},"https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh",{"link":7831,"site":37},"https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539",{"link":39,"site":40},{"link":7834,"site":7835},"https://twitter.com/briancaffey/status/1535683865330831360","twitter",{"link":7837,"site":43},"https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments",{"link":7839,"site":7840},"https://hackernoon.com/ad-hoc-environments-for-django-applications-with-ecs-terraform-and-github-actions","hackernoon",{"type":46,"children":7842,"toc":13848},[7843,7847,7860,7866,7871,7985,7991,7996,8034,8039,8097,8103,8108,8114,8119,8152,8157,8163,8168,8211,8223,8228,8233,8340,8345,8351,8356,8374,8379,8408,8420,8425,8431,8436,8454,8459,8464,8469,8474,8487,8492,8497,8503,8508,8534,8578,8584,8589,8607,8612,8617,8622,8643,8676,8682,8687,8692,8728,8733,8787,8792,8842,8853,8881,8898,8904,8921,8928,8934,8947,8952,8957,8962,8967,8972,8977,8982,8987,8993,9066,9072,9077,9085,9089,9102,9108,9113,9126,9131,9139,9143,9148,9181,9187,9192,9198,9203,9208,9229,9234,9238,9243,9249,9254,9258,9263,9269,9274,9279,9306,9311,9328,9334,9339,9345,9385,9411,9416,9436,9462,9468,9480,9488,9500,9539,9545,9589,9602,9610,9649,9669,9675,9686,9707,9719,9725,9730,9816,9821,9828,9833,9838,12707,12727,12741,12797,12858,12864,12876,12933,12939,12944,12950,12955,12969,12982,12988,13015,13021,13026,13032,13037,13043,13048,13054,13059,13190,13195,13201,13237,13243,13286,13292,13304,13341,13353,13359,13379,13565,13570,13578,13584,13610,13616,13634,13639,13645,13651,13656,13662,13667,13672,13677,13682,13688,13711,13717,13722,13728,13733,13739,13744,13750,13755,13761,13780,13786,13791,13797,13802,13830,13835,13839,13844],{"type":49,"tag":50,"props":7844,"children":7845},{"id":52},[7846],{"type":55,"value":56},{"type":49,"tag":58,"props":7848,"children":7849},{},[7850,7852,7858],{"type":55,"value":7851},"This article will show how software development teams can build on-demand instances of a web application project for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete environments. It will focus on the technical implementation of building ad hoc environments using a specific set of tools (including AWS ECS, Terraform and GitHub Actions). I will also be giving context on high-level implementation decisions based on what I think are best practices guided by the ",{"type":49,"tag":80,"props":7853,"children":7855},{"href":402,"rel":7854},[84],[7856],{"type":55,"value":7857},"12-Factor Application methodology",{"type":55,"value":7859},". If any of this interests you, please have a read and let me know what you think in the comments on the outlets where I'll be sharing this article (links at the end).",{"type":49,"tag":50,"props":7861,"children":7863},{"id":7862},"github-links",[7864],{"type":55,"value":7865},"GitHub Links",{"type":49,"tag":58,"props":7867,"children":7868},{},[7869],{"type":55,"value":7870},"This article references three open-source code repositories on GitHub.",{"type":49,"tag":64,"props":7872,"children":7873},{},[7874,7905,7945],{"type":49,"tag":68,"props":7875,"children":7876},{},[7877,7882],{"type":49,"tag":80,"props":7878,"children":7880},{"href":144,"rel":7879},[84],[7881],{"type":55,"value":1627},{"type":49,"tag":64,"props":7883,"children":7884},{},[7885,7890,7895,7900],{"type":49,"tag":68,"props":7886,"children":7887},{},[7888],{"type":55,"value":7889},"this repo contains an example microblogging application called μblog built with Django",{"type":49,"tag":68,"props":7891,"children":7892},{},[7893],{"type":55,"value":7894},"the same application is implemented as a traditional Model Template View (MTV) site, a decoupled REST API and Javascript web application and a GraphQL API",{"type":49,"tag":68,"props":7896,"children":7897},{},[7898],{"type":55,"value":7899},"it is a monorepo that also includes a frontend Vue.js application, CI/CD pipelines, a VuePress documentation site as well as tooling and instructions for settings up a local development environments (both with and without docker)",{"type":49,"tag":68,"props":7901,"children":7902},{},[7903],{"type":55,"value":7904},"it includes a complete set of GitHub Action examples for automating the processes of creating, updating and destroying ad hoc environments that will be an important part of what is covered in this article",{"type":49,"tag":68,"props":7906,"children":7907},{},[7908,7913],{"type":49,"tag":80,"props":7909,"children":7911},{"href":99,"rel":7910},[84],[7912],{"type":55,"value":684},{"type":49,"tag":64,"props":7914,"children":7915},{},[7916,7921,7926],{"type":49,"tag":68,"props":7917,"children":7918},{},[7919],{"type":55,"value":7920},"a collection of modules for running Django applications on AWS using Terraform",{"type":49,"tag":68,"props":7922,"children":7923},{},[7924],{"type":55,"value":7925},"one of the submodules can be used for creating ad hoc environments which will be what we use to create ad hoc environments",{"type":49,"tag":68,"props":7927,"children":7928},{},[7929,7931,7937,7938,7943],{"type":55,"value":7930},"this module has been published to Terraform Registry and is used in the ",{"type":49,"tag":326,"props":7932,"children":7934},{"className":7933},[],[7935],{"type":55,"value":7936},"terraform/live/ad-hoc",{"type":55,"value":7046},{"type":49,"tag":326,"props":7939,"children":7941},{"className":7940},[],[7942],{"type":55,"value":1627},{"type":55,"value":7944}," repo",{"type":49,"tag":68,"props":7946,"children":7947},{},[7948,7955],{"type":49,"tag":80,"props":7949,"children":7952},{"href":7950,"rel":7951},"https://github.com/briancaffey/terraform-aws-ad-hoc-environments",[84],[7953],{"type":55,"value":7954},"terraform-aws-ad-hoc-environments",{"type":49,"tag":64,"props":7956,"children":7957},{},[7958,7963,7973],{"type":49,"tag":68,"props":7959,"children":7960},{},[7961],{"type":55,"value":7962},"a Terraform module that provides shared infrastructure used by ad hoc environments (including VPC, RDS instance, bastion host, security groups and IAM roles, etc.)",{"type":49,"tag":68,"props":7964,"children":7965},{},[7966,7968],{"type":55,"value":7967},"this module has also been published to Terraform Registry and is also used in ",{"type":49,"tag":326,"props":7969,"children":7971},{"className":7970},[],[7972],{"type":55,"value":1627},{"type":49,"tag":68,"props":7974,"children":7975},{},[7976,7978,7983],{"type":55,"value":7977},"this module is designed to be used with the ",{"type":49,"tag":326,"props":7979,"children":7981},{"className":7980},[],[7982],{"type":55,"value":684},{"type":55,"value":7984}," Terraform module",{"type":49,"tag":50,"props":7986,"children":7988},{"id":7987},"assumptions",[7989],{"type":55,"value":7990},"Assumptions",{"type":49,"tag":58,"props":7992,"children":7993},{},[7994],{"type":55,"value":7995},"There are all sorts of applications, and all sort of engineering teams. For some context on what I'm describing in this article, here are some basic assumptions that I'm making about the type of engineering team and software application product that would be a good fit for this type of development workflow.",{"type":49,"tag":64,"props":7997,"children":7998},{},[7999,8004,8009,8014,8019,8024,8029],{"type":49,"tag":68,"props":8000,"children":8001},{},[8002],{"type":55,"value":8003},"engineering team is composed of a backend team, a frontend team, a devops team and works closely with a product team",{"type":49,"tag":68,"props":8005,"children":8006},{},[8007],{"type":55,"value":8008},"backend team primarily develops a REST API",{"type":49,"tag":68,"props":8010,"children":8011},{},[8012],{"type":55,"value":8013},"frontend team develops a JavaScript SPA (frontend website)",{"type":49,"tag":68,"props":8015,"children":8016},{},[8017],{"type":55,"value":8018},"SPA consumes backend REST API",{"type":49,"tag":68,"props":8020,"children":8021},{},[8022],{"type":55,"value":8023},"product team frequently needs to demo applications to prospective clients",{"type":49,"tag":68,"props":8025,"children":8026},{},[8027],{"type":55,"value":8028},"development teams don't have deep expertise in infrastructure, containers, CI/CD or automation",{"type":49,"tag":68,"props":8030,"children":8031},{},[8032],{"type":55,"value":8033},"devops team has been tasked with building automation that will allow anyone on the team to quickly spin up a complete environment for testing and demoing purposes within minutes",{"type":49,"tag":58,"props":8035,"children":8036},{},[8037],{"type":55,"value":8038},"Here are assumptions about specific tools and technologies used at the company:",{"type":49,"tag":64,"props":8040,"children":8041},{},[8042,8047,8052,8057,8062,8067,8072,8077,8082,8087,8092],{"type":49,"tag":68,"props":8043,"children":8044},{},[8045],{"type":55,"value":8046},"backend is a REST API developed with Django and a Postgres database",{"type":49,"tag":68,"props":8048,"children":8049},{},[8050],{"type":55,"value":8051},"backend is packaged into a docker container",{"type":49,"tag":68,"props":8053,"children":8054},{},[8055],{"type":55,"value":8056},"frontend is also packaged into a docker container using multi-stage builds and NGINX",{"type":49,"tag":68,"props":8058,"children":8059},{},[8060],{"type":55,"value":8061},"frontend does not require any build-time configuration (all configuration needed by frontend is fetched from backend)",{"type":49,"tag":68,"props":8063,"children":8064},{},[8065],{"type":55,"value":8066},"backend application's configuration is driven by plain-text environment variables at run-time",{"type":49,"tag":68,"props":8068,"children":8069},{},[8070],{"type":55,"value":8071},"engineering team uses AWS",{"type":49,"tag":68,"props":8073,"children":8074},{},[8075],{"type":55,"value":8076},"automation pipeline exists for building, tagging and pushing backend and frontend container images to an ECR repository",{"type":49,"tag":68,"props":8078,"children":8079},{},[8080],{"type":55,"value":8081},"devops team uses AWS ECS for running containerized workloads",{"type":49,"tag":68,"props":8083,"children":8084},{},[8085],{"type":55,"value":8086},"devops team uses Terraform for provisioning infrastructure",{"type":49,"tag":68,"props":8088,"children":8089},{},[8090],{"type":55,"value":8091},"devops team uses GitHub Actions for building automation pipelines",{"type":49,"tag":68,"props":8093,"children":8094},{},[8095],{"type":55,"value":8096},"team is somewhat cost-conscious",{"type":49,"tag":50,"props":8098,"children":8100},{"id":8099},"what-are-ad-hoc-environments",[8101],{"type":55,"value":8102},"What are ad hoc environments?",{"type":49,"tag":58,"props":8104,"children":8105},{},[8106],{"type":55,"value":8107},"Ad hoc environments are short-lived environments that are designed to be used for testing a specific set of features or for demoing a specific application configuration in an isolated environment. It is intended to be a functional duplicate of the main production environment. An ad hoc environment is the first cloud environment that the application code will be deployed to after a developer has been working on it in a local development environment.",{"type":49,"tag":50,"props":8109,"children":8111},{"id":8110},"trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation",[8112],{"type":55,"value":8113},"Trade-offs to make when designing ad hoc environment infrastructure and automation",{"type":49,"tag":58,"props":8115,"children":8116},{},[8117],{"type":55,"value":8118},"Now that we have a sense of what we are building and the team we are working with, let's think about the high-level trade-offs that we will face as we build a solution for providing on-demand ad hoc environments. When building infrastructure and workflows for ad hoc environments, there are a few things to solve for:",{"type":49,"tag":64,"props":8120,"children":8121},{},[8122,8127,8132,8137,8142,8147],{"type":49,"tag":68,"props":8123,"children":8124},{},[8125],{"type":55,"value":8126},"simplicity of the end-user interface and process for requesting an ad hoc environment",{"type":49,"tag":68,"props":8128,"children":8129},{},[8130],{"type":55,"value":8131},"startup speed",{"type":49,"tag":68,"props":8133,"children":8134},{},[8135],{"type":55,"value":8136},"total cost of ownership",{"type":49,"tag":68,"props":8138,"children":8139},{},[8140],{"type":55,"value":8141},"degree of similarity to production environments",{"type":49,"tag":68,"props":8143,"children":8144},{},[8145],{"type":55,"value":8146},"shared vs isolated resources",{"type":49,"tag":68,"props":8148,"children":8149},{},[8150],{"type":55,"value":8151},"automation complexity",{"type":49,"tag":58,"props":8153,"children":8154},{},[8155],{"type":55,"value":8156},"Let's look at these items by considering how we can set up the main infrastructure components that will be used to run our ad hoc application environments.",{"type":49,"tag":430,"props":8158,"children":8160},{"id":8159},"relational-databases",[8161],{"type":55,"value":8162},"Relational Databases",{"type":49,"tag":58,"props":8164,"children":8165},{},[8166],{"type":55,"value":8167},"Startup speed can be measured by the time between when an environment is requested and when that environment can be used by whoever requested it. In this period of time, an automation pipeline may do some of the following:",{"type":49,"tag":64,"props":8169,"children":8170},{},[8171,8196,8201,8206],{"type":49,"tag":68,"props":8172,"children":8173},{},[8174,8176,8182,8183,8188,8189,8194],{"type":55,"value":8175},"run ",{"type":49,"tag":326,"props":8177,"children":8179},{"className":8178},[],[8180],{"type":55,"value":8181},"terraform init",{"type":55,"value":873},{"type":49,"tag":326,"props":8184,"children":8186},{"className":8185},[],[8187],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":8190,"children":8192},{"className":8191},[],[8193],{"type":55,"value":559},{"type":55,"value":8195}," to build infrastructure",{"type":49,"tag":68,"props":8197,"children":8198},{},[8199],{"type":55,"value":8200},"run scripts to prepare the application such as database migrations",{"type":49,"tag":68,"props":8202,"children":8203},{},[8204],{"type":55,"value":8205},"seeding initial sample data with a script or database dump",{"type":49,"tag":68,"props":8207,"children":8208},{},[8209],{"type":55,"value":8210},"message the user with information about the environment (URLs, commands for accessing an interactive shell, etc.)",{"type":49,"tag":58,"props":8212,"children":8213},{},[8214,8216,8221],{"type":55,"value":8215},"RDS instances can take a long time to create relative to other AWS resources such as S3 buckets and IAM roles. RDS instances are also more costly than other resources. We could use a single, shared RDS instance placed in a private subnet of a shared VPC. Each ad hoc environment could use a different named database in the RDS instance in the form ",{"type":49,"tag":326,"props":8217,"children":8219},{"className":8218},[],[8220],{"type":55,"value":2704},{"type":55,"value":8222},". Using one RDS instance per ad hoc environment would be slow to startup and tear down and also costly if there are many developers using ad hoc environments simultaneously.",{"type":49,"tag":58,"props":8224,"children":8225},{},[8226],{"type":55,"value":8227},"If we choose to isolate the application's relational database at the database level (and not the RDS instance level), then we will need our automation workflow to create a database per ad hoc environment.",{"type":49,"tag":58,"props":8229,"children":8230},{},[8231],{"type":55,"value":8232},"Let's spin up a simple example to illustrate how this would would work.",{"type":49,"tag":64,"props":8234,"children":8235},{},[8236,8249,8260,8271,8292,8297,8309,8321],{"type":49,"tag":68,"props":8237,"children":8238},{},[8239,8241,8247],{"type":55,"value":8240},"A developer is working on ",{"type":49,"tag":326,"props":8242,"children":8244},{"className":8243},[],[8245],{"type":55,"value":8246},"feature-abc",{"type":55,"value":8248}," that involves a significant refactor of the data model.",{"type":49,"tag":68,"props":8250,"children":8251},{},[8252,8254,8259],{"type":55,"value":8253},"The developer decides to spin up an ad hoc environment called ",{"type":49,"tag":326,"props":8255,"children":8257},{"className":8256},[],[8258],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8261,"children":8262},{},[8263,8265,8270],{"type":55,"value":8264},"Our automation will need to create a database in the RDS instance called ",{"type":49,"tag":326,"props":8266,"children":8268},{"className":8267},[],[8269],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8272,"children":8273},{},[8274,8276,8282,8284,8290],{"type":55,"value":8275},"We can configure a bastion host with ",{"type":49,"tag":326,"props":8277,"children":8279},{"className":8278},[],[8280],{"type":55,"value":8281},"psql",{"type":55,"value":8283}," installed that has network and security group access to our RDS instance, and we can give our GitHub Actions an SSH key that can be used to run ",{"type":49,"tag":326,"props":8285,"children":8287},{"className":8286},[],[8288],{"type":55,"value":8289},"createdb",{"type":55,"value":8291}," over SSH.",{"type":49,"tag":68,"props":8293,"children":8294},{},[8295],{"type":55,"value":8296},"The automation also runs database migrations once the application has started, and we can view the logs of the database migration to check for any irregularities or other issues.",{"type":49,"tag":68,"props":8298,"children":8299},{},[8300,8302,8307],{"type":55,"value":8301},"This will give the developer and the rest of team confidence that the promoting ",{"type":49,"tag":326,"props":8303,"children":8305},{"className":8304},[],[8306],{"type":55,"value":8246},{"type":55,"value":8308}," to the next pre-production environments will not have any errors.",{"type":49,"tag":68,"props":8310,"children":8311},{},[8312,8314,8319],{"type":55,"value":8313},"The developer may even choose to load a SQL dump of the next pre-production environment into their ",{"type":49,"tag":326,"props":8315,"children":8317},{"className":8316},[],[8318],{"type":55,"value":8246},{"type":55,"value":8320}," database get even more confidence that there will be no data integrity errors.",{"type":49,"tag":68,"props":8322,"children":8323},{},[8324,8326,8331,8333,8338],{"type":55,"value":8325},"When the developer's PR is merged and approved, the ad hoc environment ",{"type":49,"tag":326,"props":8327,"children":8329},{"className":8328},[],[8330],{"type":55,"value":8246},{"type":55,"value":8332}," can be destroyed, including the ",{"type":49,"tag":326,"props":8334,"children":8336},{"className":8335},[],[8337],{"type":55,"value":8246},{"type":55,"value":8339}," database in the shared RDS instance.",{"type":49,"tag":58,"props":8341,"children":8342},{},[8343],{"type":55,"value":8344},"With this approach we won't incur the costs of multiple RDS instances. Ad hoc environments will start up faster because an RDS instance per environment is not required. We do have slightly less resource isolation, and we need to introduce a bastion host, but I consider this an acceptable trade-off.",{"type":49,"tag":430,"props":8346,"children":8348},{"id":8347},"redis-key-value-database",[8349],{"type":55,"value":8350},"Redis (key-value database)",{"type":49,"tag":58,"props":8352,"children":8353},{},[8354],{"type":55,"value":8355},"Redis is another database used in the application and it plays a few different roles:",{"type":49,"tag":64,"props":8357,"children":8358},{},[8359,8364,8369],{"type":49,"tag":68,"props":8360,"children":8361},{},[8362],{"type":55,"value":8363},"primarily, it is a caching layer that can cache request responses to reduce load on the database and speed up our application",{"type":49,"tag":68,"props":8365,"children":8366},{},[8367],{"type":55,"value":8368},"it is a message broker for our async task workers (celery)",{"type":49,"tag":68,"props":8370,"children":8371},{},[8372],{"type":55,"value":8373},"it can be used as a backend for other 3rd party Django apps that our main application may need to use (such as django-constance, cache-ops, django-channels, etc.)",{"type":49,"tag":58,"props":8375,"children":8376},{},[8377],{"type":55,"value":8378},"AWS offers a managed Redis service called ElastiCache. Redis running on an ElastiCache instance can do database isolation similar to how Postgres running on RDS can do database isolation as we discussed previously, but there are some key differences:",{"type":49,"tag":64,"props":8380,"children":8381},{},[8382,8387],{"type":49,"tag":68,"props":8383,"children":8384},{},[8385],{"type":55,"value":8386},"redis databases are numbered, not named",{"type":49,"tag":68,"props":8388,"children":8389},{},[8390,8392,8398,8400,8406],{"type":55,"value":8391},"the backend application uses isolated numbered databases for the different 3rd party apps that I just mentioned (for example: celery can use database ",{"type":49,"tag":326,"props":8393,"children":8395},{"className":8394},[],[8396],{"type":55,"value":8397},"0",{"type":55,"value":8399},",  API caching layer can use database ",{"type":49,"tag":326,"props":8401,"children":8403},{"className":8402},[],[8404],{"type":55,"value":8405},"1",{"type":55,"value":8407},", etc.)",{"type":49,"tag":58,"props":8409,"children":8410},{},[8411,8413,8418],{"type":55,"value":8412},"This makes it difficult to use a single ElastiCache instance for our ad hoc environments since we would need to figure out which numbered database to assign to a specific role for each ad hoc environment (e.g. how do we know which numbered database to use for the API caching for the ",{"type":49,"tag":326,"props":8414,"children":8416},{"className":8415},[],[8417],{"type":55,"value":8246},{"type":55,"value":8419}," ad hoc environment).",{"type":49,"tag":58,"props":8421,"children":8422},{},[8423],{"type":55,"value":8424},"So how can we approach providing isolated redis instances for multiple ad hoc environments? Spoiler: my solution is to run redis as a stateful service in ECS. Before we dig into how to do this, we need to talk about another important part of our application: compute.",{"type":49,"tag":430,"props":8426,"children":8428},{"id":8427},"compute",[8429],{"type":55,"value":8430},"Compute",{"type":49,"tag":58,"props":8432,"children":8433},{},[8434],{"type":55,"value":8435},"Our backend application is composed of a few different services that all share the same code base. In other words, our backend's services uses the same docker image but run different processes for each component:",{"type":49,"tag":64,"props":8437,"children":8438},{},[8439,8444,8449],{"type":49,"tag":68,"props":8440,"children":8441},{},[8442],{"type":55,"value":8443},"gunicorn for the core API",{"type":49,"tag":68,"props":8445,"children":8446},{},[8447],{"type":55,"value":8448},"celery for the task workers",{"type":49,"tag":68,"props":8450,"children":8451},{},[8452],{"type":55,"value":8453},"celerybeat for task scheduling",{"type":49,"tag":58,"props":8455,"children":8456},{},[8457],{"type":55,"value":8458},"If our application used websockets, we could have another service that runs an asgi server process (like daphne or uvicorn).",{"type":49,"tag":58,"props":8460,"children":8461},{},[8462],{"type":55,"value":8463},"Since our backend application is packaged into a container and we are using AWS as our cloud provider, ECS is a great choice for running our backend services. ECS is a container orchestration tool that I usually describe as a nice middle ground between docker swarm and Kubernetes. Simply put, it is a flexible option for running our containerized services that make up our backend application.",{"type":49,"tag":58,"props":8465,"children":8466},{},[8467],{"type":55,"value":8468},"With ECS you can choose to run containers directly on EC2 instances that you manage, or you can run containers using Fargate. Fargate is a serverless compute option that takes care of managing both the underlying \"computer\" and operating system that run our application's containers. All of our backend dependencies are defined in our Dockerfile, so we do not to maintain or update the underlying operating system that runs our containers -- AWS handles all of this for us. To use Fargate, we simply tell AWS which containers to run and how much CPU and memory to use in the ECS Task that runs the containers. To scale our app horizontally, the ECS service that managed ECS tasks simply increases the number of tasks that run.",{"type":49,"tag":58,"props":8470,"children":8471},{},[8472],{"type":55,"value":8473},"Since we are going to use the Fargate launch type for our ECS Tasks, let's talk about the ergonomics of these serverless compute instances compared to running our services directly on an EC2 instances.",{"type":49,"tag":64,"props":8475,"children":8476},{},[8477,8482],{"type":49,"tag":68,"props":8478,"children":8479},{},[8480],{"type":55,"value":8481},"We can't SSH into Fargate compute instances. We can instead use AWS Systems Manager and EcsExec to open an interactive shell in a running backend container. This can be useful for developers who might need to run a management command or access an interactive Django shell to verify behavior in their ad hoc environment.",{"type":49,"tag":68,"props":8483,"children":8484},{},[8485],{"type":55,"value":8486},"We can't simply change code on the server and restart services. This can sometimes be a useful pattern for debugging something that can only be tested on a cloud environment (e.g. something that can't easily be reproduced on your local machine), so this requires that developers push new images to their backend services for every change they want to see reflected on their ad hoc environment. Later on I'll discuss how we can provide tooling for developers to quickly update the image used in their backend services.",{"type":49,"tag":58,"props":8488,"children":8489},{},[8490],{"type":55,"value":8491},"With AWS Fargate, you will pay more than you would for a comparable amount of CPU and memory on EC2 instances. Similar to EC2 spot instances, Fargate offers interruptable instances called Fargate Spot which costs significantly less than regular Fargate instances. Fargate spot is appropriate for our ad hoc environments since ad hoc environments are non-critical workloads. In the event that a Fargate spot instance is interrupted, the ECS service will automatically launch another Fargate task to replace the task that was stopped.",{"type":49,"tag":58,"props":8493,"children":8494},{},[8495],{"type":55,"value":8496},"In my opinion, ECS with Fargate is ideal for running the stateless services that make up our backend application. In terms of parity with our production environment, we can keep almost everything the same, except use regular Fargate instances instead of Fargate spot instances.",{"type":49,"tag":430,"props":8498,"children":8500},{"id":8499},"redis-revisited",[8501],{"type":55,"value":8502},"Redis, revisited",{"type":49,"tag":58,"props":8504,"children":8505},{},[8506],{"type":55,"value":8507},"We can run redis as an ECS service instead of using ElastiCache. In order to do this, we will need our backend services (gunicorn, celery and celerybeat) to be able to communicate with a fourth ECS service that will be running redis (using an official redis image from Docker Hub, or a redis image that we define in ECR).",{"type":49,"tag":58,"props":8509,"children":8510},{},[8511,8513,8518,8520,8525,8527,8532],{"type":55,"value":8512},"By default, ",{"type":49,"tag":72,"props":8514,"children":8515},{},[8516],{"type":55,"value":8517},"there is no way for our backend services to know how to communicate with any other service in our ECS cluster",{"type":55,"value":8519},". If you have used docker-compose, you may know that you can use the service name ",{"type":49,"tag":326,"props":8521,"children":8523},{"className":8522},[],[8524],{"type":55,"value":3151},{"type":55,"value":8526}," in a backend service to easily communicate with a redis service called ",{"type":49,"tag":326,"props":8528,"children":8530},{"className":8529},[],[8531],{"type":55,"value":3151},{"type":55,"value":8533},". This networking convenience is not available to use out of the box with ECS. To achieve this in AWS, we need some way to manage a unique ad hoc environment-specific Route 53 DNS record that points to the private IP of the Fargate task that is running redis in an ECS cluster for a given ad hoc environment. Such a service exists in AWS and it is called Cloud Map. Cloud Map offers service discovery so that our backend services can make network calls to a static DNS address that will reliably point to the correct private IP of the ECS task running the redis container.",{"type":49,"tag":58,"props":8535,"children":8536},{},[8537,8539,8544,8546,8552,8554,8560,8562,8568,8570,8576],{"type":55,"value":8538},"We can define a service discovery namespace (which will essentially be a top level domain, or TLD) that all of our ad hoc environments can share. Let's assume this namespace is called ",{"type":49,"tag":326,"props":8540,"children":8542},{"className":8541},[],[8543],{"type":55,"value":1353},{"type":55,"value":8545},". Each ad hoc environment can then define a service discovery service in the shared namespace for redis that is called ",{"type":49,"tag":326,"props":8547,"children":8549},{"className":8548},[],[8550],{"type":55,"value":8551},"{ad-hoc-env-name}-redis",{"type":55,"value":8553},". This way, we can have a reliable address that we can configure as an environment for our backend that will look like this: ",{"type":49,"tag":326,"props":8555,"children":8557},{"className":8556},[],[8558],{"type":55,"value":8559},"redis://{ad-hoc-env-name}-redis.ad-hoc:6379/0",{"type":55,"value":8561},". ",{"type":49,"tag":326,"props":8563,"children":8565},{"className":8564},[],[8566],{"type":55,"value":8567},"{ad-hoc-env-name-redis}.ad-hoc",{"type":55,"value":8569}," will be the hostname of the redis service, and Route 53 will create records that point to ",{"type":49,"tag":326,"props":8571,"children":8573},{"className":8572},[],[8574],{"type":55,"value":8575},"{ad-hoc-env-name}-redis.ad-hoc",{"type":55,"value":8577}," to the private IP of the redis Fargate task for each ad hoc environment.",{"type":49,"tag":430,"props":8579,"children":8581},{"id":8580},"load-balancing",[8582],{"type":55,"value":8583},"Load Balancing",{"type":49,"tag":58,"props":8585,"children":8586},{},[8587],{"type":55,"value":8588},"We now have our backend services (gunicorn, celery and celerybeat) running on Fargate spot instances, and these services can communicate with the redis service in our ad hoc environment's ECS cluster using service discovery that we configured with Cloud Map. We still need to think about a few things:",{"type":49,"tag":64,"props":8590,"children":8591},{},[8592,8597,8602],{"type":49,"tag":68,"props":8593,"children":8594},{},[8595],{"type":55,"value":8596},"how will we expose our API service to the public (or private) internet",{"type":49,"tag":68,"props":8598,"children":8599},{},[8600],{"type":55,"value":8601},"how will we expose our frontend application to the public (or private) internet",{"type":49,"tag":68,"props":8603,"children":8604},{},[8605],{"type":55,"value":8606},"how will we make sure that requests go the correct ECS services",{"type":49,"tag":58,"props":8608,"children":8609},{},[8610],{"type":55,"value":8611},"Application load balancers (ALBs) are a great way to expose web app traffic to the internet. We could either have one application load balancer per ad hoc environment, or one application load balancer shared between all ad hoc environments. ALBs are somewhat slow to create and they also incur a significant monthly cost. They are also highly scalable, so using a shared ALB for all ad hoc environments would work.",{"type":49,"tag":58,"props":8613,"children":8614},{},[8615],{"type":55,"value":8616},"Individual ad hoc environments can then create target groups and listener rules for a shared ALB for each service that needs to serve requests from the internet (the backend and the frontend). In our case this is the backend API server and the frontend server that serves our static frontend site using NGINX.",{"type":49,"tag":58,"props":8618,"children":8619},{},[8620],{"type":55,"value":8621},"ECS services that need to be exposed to the internet can specify the target group, port and container to use for load balancing. A target group is created that defines the health check and other settings, and a load balancer listener rule is created on the shared load balancer that will forward traffic matching certain conditions to the target group for our service.",{"type":49,"tag":58,"props":8623,"children":8624},{},[8625,8627,8633,8635,8641],{"type":55,"value":8626},"For a given ad hoc environment, we need to specify that only traffic with certain paths should be sent to the backend service, and all other traffic should be sent to the frontend service. For example, we may only want to send traffic that starts with the path ",{"type":49,"tag":326,"props":8628,"children":8630},{"className":8629},[],[8631],{"type":55,"value":8632},"/api",{"type":55,"value":8634}," or ",{"type":49,"tag":326,"props":8636,"children":8638},{"className":8637},[],[8639],{"type":55,"value":8640},"/admin",{"type":55,"value":8642}," to the backend target group, and all other traffic should be sent to the frontend target group. We can do this by setting conditions on the listener rules that forward traffic do the frontend and backend target groups based on the hostname and path.",{"type":49,"tag":58,"props":8644,"children":8645},{},[8646,8648,8653,8654,8659,8661,8666,8668,8674],{"type":55,"value":8647},"We want our listener rule logic to forward ",{"type":49,"tag":326,"props":8649,"children":8651},{"className":8650},[],[8652],{"type":55,"value":8632},{"type":55,"value":873},{"type":49,"tag":326,"props":8655,"children":8657},{"className":8656},[],[8658],{"type":55,"value":8640},{"type":55,"value":8660}," and any other backend traffic to the backend target group, and forward all other traffic (",{"type":49,"tag":326,"props":8662,"children":8664},{"className":8663},[],[8665],{"type":55,"value":3211},{"type":55,"value":8667},") to the frontend target group. In order to do this, we need the backend listener rule to have a higher priority than the frontend listener rule for each ad hoc environment. Since we are using the same load balancer for all ad hoc environments, the priority values for each listener rule need to be unique. If we don't set the priority explicitly, then the priority will be set automatically to the next available value in ascending order. In order to make sure that the backend listener rule has a higher priority than the frontend listener rule for each ad hoc environment, we need to tell Terraform that the frontend module ",{"type":49,"tag":326,"props":8669,"children":8671},{"className":8670},[],[8672],{"type":55,"value":8673},"depends_on",{"type":55,"value":8675}," the backend module. This way the backend listener rule will have a higher priority (e.g. priority of 1) because it will be created first, and the frontend listener rule will have a lower priority (e.g. priority of 2).",{"type":49,"tag":50,"props":8677,"children":8679},{"id":8678},"more-on-shared-resources-vs-per-environment-resources",[8680],{"type":55,"value":8681},"More on shared resources vs per-environment resources",{"type":49,"tag":58,"props":8683,"children":8684},{},[8685],{"type":55,"value":8686},"Up until now we have discussed infrastructure design decisions at a high level, but we have not yet talked about how to organize our infrastructure as code. At a basic level, components of our ad hoc environment either fall into shared infrastructure or infrastructure that is specific to an individual ad hoc environment. Here's a list of the resources that are shared and the resources that are specific to each ad hoc environment.",{"type":49,"tag":58,"props":8688,"children":8689},{},[8690],{"type":55,"value":8691},"Shared resources include:",{"type":49,"tag":64,"props":8693,"children":8694},{},[8695,8699,8704,8709,8714,8719,8723],{"type":49,"tag":68,"props":8696,"children":8697},{},[8698],{"type":55,"value":2094},{"type":49,"tag":68,"props":8700,"children":8701},{},[8702],{"type":55,"value":8703},"IAM policies",{"type":49,"tag":68,"props":8705,"children":8706},{},[8707],{"type":55,"value":8708},"Security groups",{"type":49,"tag":68,"props":8710,"children":8711},{},[8712],{"type":55,"value":8713},"RDS instance",{"type":49,"tag":68,"props":8715,"children":8716},{},[8717],{"type":55,"value":8718},"Service Discovery namespace",{"type":49,"tag":68,"props":8720,"children":8721},{},[8722],{"type":55,"value":2373},{"type":49,"tag":68,"props":8724,"children":8725},{},[8726],{"type":55,"value":8727},"Bastion host",{"type":49,"tag":58,"props":8729,"children":8730},{},[8731],{"type":55,"value":8732},"Ad hoc environment resources include:",{"type":49,"tag":64,"props":8734,"children":8735},{},[8736,8740,8745,8750,8755,8760,8765,8777,8782],{"type":49,"tag":68,"props":8737,"children":8738},{},[8739],{"type":55,"value":2880},{"type":49,"tag":68,"props":8741,"children":8742},{},[8743],{"type":55,"value":8744},"ECS Tasks and Services (for backend and frontend applications)",{"type":49,"tag":68,"props":8746,"children":8747},{},[8748],{"type":55,"value":8749},"ECS Tasks for running management commands (such as migrate)",{"type":49,"tag":68,"props":8751,"children":8752},{},[8753],{"type":55,"value":8754},"CloudWatch logging groups for containers defined in ECS Tasks",{"type":49,"tag":68,"props":8756,"children":8757},{},[8758],{"type":55,"value":8759},"ALB Target groups",{"type":49,"tag":68,"props":8761,"children":8762},{},[8763],{"type":55,"value":8764},"ALB listener rules",{"type":49,"tag":68,"props":8766,"children":8767},{},[8768,8770,8776],{"type":55,"value":8769},"Route 53 record that points to the load balancer (e.g. ",{"type":49,"tag":326,"props":8771,"children":8773},{"className":8772},[],[8774],{"type":55,"value":8775},"ad-hoc-env-name.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":8778,"children":8779},{},[8780],{"type":55,"value":8781},"S3 bucket for static and media assets",{"type":49,"tag":68,"props":8783,"children":8784},{},[8785],{"type":55,"value":8786},"Service Discovery Service for redis service in ECS cluster",{"type":49,"tag":58,"props":8788,"children":8789},{},[8790],{"type":55,"value":8791},"Shared resources can be defined in one terraform configuration and deployed once. These resources will be long-lived as long as the application is under active development and the team requires on-demand provisioning of ad hoc environments.",{"type":49,"tag":58,"props":8793,"children":8794},{},[8795,8797,8802,8804,8810,8812,8818,8819,8825,8826,8832,8834,8840],{"type":55,"value":8796},"Ad hoc environment resources can be defined in another terraform configuration that references outputs from the shared resource configuration using ",{"type":49,"tag":326,"props":8798,"children":8800},{"className":8799},[],[8801],{"type":55,"value":1842},{"type":55,"value":8803},". Each ad hoc environment can be defined by a ",{"type":49,"tag":326,"props":8805,"children":8807},{"className":8806},[],[8808],{"type":55,"value":8809},"\u003Cname>.tfvars",{"type":55,"value":8811}," file that contains the name of the ad hoc environment (such as ",{"type":49,"tag":326,"props":8813,"children":8815},{"className":8814},[],[8816],{"type":55,"value":8817},"brian",{"type":55,"value":873},{"type":49,"tag":326,"props":8820,"children":8822},{"className":8821},[],[8823],{"type":55,"value":8824},"brian2",{"type":55,"value":873},{"type":49,"tag":326,"props":8827,"children":8829},{"className":8828},[],[8830],{"type":55,"value":8831},"demo-feature-abc",{"type":55,"value":8833},", etc.). This ",{"type":49,"tag":326,"props":8835,"children":8837},{"className":8836},[],[8838],{"type":55,"value":8839},"\u003Cname>",{"type":55,"value":8841}," value will also be the name of the Terraform workspace and will be used to name and tag AWS resources associated with the corresponding ad hoc environment.",{"type":49,"tag":58,"props":8843,"children":8844},{},[8845,8846,8851],{"type":55,"value":413},{"type":49,"tag":326,"props":8847,"children":8849},{"className":8848},[],[8850],{"type":55,"value":8809},{"type":55,"value":8852}," file will allow developers to use a simple, standard file interface for defining application specific values, such as the version of the backend and frontend. This brings developers into the concepts and practices of \"infrastructure as code\" and \"configuration as code\" and also helps the entire team keep track of how different environments are configured.",{"type":49,"tag":58,"props":8854,"children":8855},{},[8856,8858,8863,8865,8871,8873,8880],{"type":55,"value":8857},"Ad hoc environment ",{"type":49,"tag":326,"props":8859,"children":8861},{"className":8860},[],[8862],{"type":55,"value":8809},{"type":55,"value":8864}," files are stored in a directory of a special git repository that also defines the ad hoc environment terraform configuration. Currently, the ",{"type":49,"tag":326,"props":8866,"children":8868},{"className":8867},[],[8869],{"type":55,"value":8870},"tfvars",{"type":55,"value":8872}," files are stored ",{"type":49,"tag":80,"props":8874,"children":8877},{"href":8875,"rel":8876},"https://github.com/briancaffey/django-step-by-step/tree/main/terraform/live/ad-hoc/envs",[84],[8878],{"type":55,"value":8879},"here",{"type":55,"value":745},{"type":49,"tag":58,"props":8882,"children":8883},{},[8884,8886,8891,8892,8897],{"type":55,"value":8885},"Now let's look at the two terraform configurations used for defining ",{"type":49,"tag":72,"props":8887,"children":8888},{},[8889],{"type":55,"value":8890},"shared resources",{"type":55,"value":715},{"type":49,"tag":72,"props":8893,"children":8894},{},[8895],{"type":55,"value":8896},"ad hoc environment resources",{"type":55,"value":745},{"type":49,"tag":50,"props":8899,"children":8901},{"id":8900},"ad-hoc-environment-diagram",[8902],{"type":55,"value":8903},"Ad Hoc Environment Diagram",{"type":49,"tag":58,"props":8905,"children":8906},{},[8907,8909,8914,8915,8920],{"type":55,"value":8908},"Here's an overview of the resources used for the ad hoc environments. The ",{"type":49,"tag":72,"props":8910,"children":8911},{},[8912],{"type":55,"value":8913},"letters represent shared resources",{"type":55,"value":6280},{"type":49,"tag":72,"props":8916,"children":8917},{},[8918],{"type":55,"value":8919},"numbers represent per-environment resources",{"type":55,"value":745},{"type":49,"tag":58,"props":8922,"children":8923},{},[8924],{"type":49,"tag":1601,"props":8925,"children":8927},{"alt":8926,"src":7821},"png",[],{"type":49,"tag":430,"props":8929,"children":8931},{"id":8930},"shared-architecture",[8932],{"type":55,"value":8933},"Shared architecture",{"type":49,"tag":58,"props":8935,"children":8936},{},[8937,8939,8946],{"type":55,"value":8938},"A. VPC (created using the ",{"type":49,"tag":80,"props":8940,"children":8943},{"href":8941,"rel":8942},"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest",[84],[8944],{"type":55,"value":8945},"official AWS VPC Module",{"type":55,"value":616},{"type":49,"tag":58,"props":8948,"children":8949},{},[8950],{"type":55,"value":8951},"B. Public subnets for bastion host, NAT Gateways and Load Balancer",{"type":49,"tag":58,"props":8953,"children":8954},{},[8955],{"type":55,"value":8956},"C. Private subnets for application workloads and RDS",{"type":49,"tag":58,"props":8958,"children":8959},{},[8960],{"type":55,"value":8961},"D. Application Load Balancer that is shared between all ad hoc environments. A pre-provisioned wildcard ACM certificate is attached to the load balancer that is used to secure traffic for load-balanced ECS services",{"type":49,"tag":58,"props":8963,"children":8964},{},[8965],{"type":55,"value":8966},"E. Service discovery namespace that provides a namespace for application workloads to access the redis service running in ECS",{"type":49,"tag":58,"props":8968,"children":8969},{},[8970],{"type":55,"value":8971},"F. IAM roles needed for ECS tasks to access AWS services",{"type":49,"tag":58,"props":8973,"children":8974},{},[8975],{"type":55,"value":8976},"G. RDS instance using postgres engine that is shared between all ad hoc environments",{"type":49,"tag":58,"props":8978,"children":8979},{},[8980],{"type":55,"value":8981},"H. Bastion host used to access RDS from GitHub Actions (needed for creating per-environment databases)",{"type":49,"tag":58,"props":8983,"children":8984},{},[8985],{"type":55,"value":8986},"I. NAT Gateway used to give traffic in private subnets a route to the public internet",{"type":49,"tag":430,"props":8988,"children":8990},{"id":8989},"environment-specific-architecture",[8991],{"type":55,"value":8992},"Environment-specific architecture",{"type":49,"tag":8994,"props":8995,"children":8996},"ol",{},[8997,9002,9007,9012,9017,9022,9027,9032,9037,9047,9056,9061],{"type":49,"tag":68,"props":8998,"children":8999},{},[9000],{"type":55,"value":9001},"ECS Cluster that groups all ECS tasks for a single ad hoc environment",{"type":49,"tag":68,"props":9003,"children":9004},{},[9005],{"type":55,"value":9006},"Listener rules and target groups that direct traffic from the load balancer to the ECS services for an ad hoc environment.",{"type":49,"tag":68,"props":9008,"children":9009},{},[9010],{"type":55,"value":9011},"Redis service running in ECS that provides caching and serves as a task broker for celery",{"type":49,"tag":68,"props":9013,"children":9014},{},[9015],{"type":55,"value":9016},"Route53 records that point to the load balancer",{"type":49,"tag":68,"props":9018,"children":9019},{},[9020],{"type":55,"value":9021},"Frontend service that serves the Vue.js application over NGINX",{"type":49,"tag":68,"props":9023,"children":9024},{},[9025],{"type":55,"value":9026},"API service that serves the backend with Gunicorn",{"type":49,"tag":68,"props":9028,"children":9029},{},[9030],{"type":55,"value":9031},"Celery worker that process jobs in the default queue",{"type":49,"tag":68,"props":9033,"children":9034},{},[9035],{"type":55,"value":9036},"Celery beat that schedules celery tasks",{"type":49,"tag":68,"props":9038,"children":9039},{},[9040,9045],{"type":49,"tag":326,"props":9041,"children":9043},{"className":9042},[],[9044],{"type":55,"value":3316},{"type":55,"value":9046}," task",{"type":49,"tag":68,"props":9048,"children":9049},{},[9050,9055],{"type":49,"tag":326,"props":9051,"children":9053},{"className":9052},[],[9054],{"type":55,"value":3323},{"type":55,"value":9046},{"type":49,"tag":68,"props":9057,"children":9058},{},[9059],{"type":55,"value":9060},"CloudWatch log groups are created for each ECS task in an ad hoc environment",{"type":49,"tag":68,"props":9062,"children":9063},{},[9064],{"type":55,"value":9065},"Each ad hoc environment gets a database in the shared RDS instance",{"type":49,"tag":50,"props":9067,"children":9069},{"id":9068},"shared-resources-terraform-configuration",[9070],{"type":55,"value":9071},"Shared resources terraform configuration",{"type":49,"tag":58,"props":9073,"children":9074},{},[9075],{"type":55,"value":9076},"Let's have a detailed look at the terraform configuration for shared resources that will support ad hoc environments.",{"type":49,"tag":58,"props":9078,"children":9079},{},[9080],{"type":49,"tag":1601,"props":9081,"children":9084},{"alt":9082,"src":9083},"Shared AWS resources for ad hoc environment","/image/shared-resources.png",[],{"type":49,"tag":430,"props":9086,"children":9087},{"id":2091},[9088],{"type":55,"value":2094},{"type":49,"tag":58,"props":9090,"children":9091},{},[9092,9094,9100],{"type":55,"value":9093},"We can use the ",{"type":49,"tag":80,"props":9095,"children":9097},{"href":8941,"rel":9096},[84],[9098],{"type":55,"value":9099},"AWS VPC module",{"type":55,"value":9101}," for creating the shared VPC with Terraform. This module provides a high level interface that will provision lots of the components that are needed for a VPC following best practices, and it is less code for the DevOps team to manage compared to defining each component of a VPC (route tables, subnets, internet gateways, etc.).",{"type":49,"tag":430,"props":9103,"children":9105},{"id":9104},"cloud-map-service-discovery-namespace",[9106],{"type":55,"value":9107},"Cloud Map Service Discovery Namespace",{"type":49,"tag":58,"props":9109,"children":9110},{},[9111],{"type":55,"value":9112},"Cloud Map is used in order to allow services in our ECS cluster to communicate with each other. The only reason that Cloud Map is needed is so that the backend services (API, celery workers, beat) can communicate with Redis, which will be an important service for our application, providing caching and also serving as a broker for celery. If we were to use Django Channels for websockets, the Redis service would also function as the backend for Django Channels.",{"type":49,"tag":58,"props":9114,"children":9115},{},[9116,9118,9124],{"type":55,"value":9117},"We will only need to specify ",{"type":49,"tag":326,"props":9119,"children":9121},{"className":9120},[],[9122],{"type":55,"value":9123},"service_registries",{"type":55,"value":9125}," on the redis service in our ECS cluster. What this will do is provide an address that our other services can use to communicate with redis. This address is created in the form of a Route 53 record, and it points to the private IP address of the redis service. If the private IP of the redis service is updated, the Route 53 record record for our redis service will be updated as well.",{"type":49,"tag":58,"props":9127,"children":9128},{},[9129],{"type":55,"value":9130},"In order for service discovery to work in the VPC that we created, we need to add the following options to the terraform AWS VPC module:",{"type":49,"tag":1050,"props":9132,"children":9134},{"code":9133},"# DNS settings\nenable_dns_hostnames = true\nenable_dns_support   = true\n",[9135],{"type":49,"tag":326,"props":9136,"children":9137},{"__ignoreMap":8},[9138],{"type":55,"value":9133},{"type":49,"tag":430,"props":9140,"children":9141},{"id":2160},[9142],{"type":55,"value":2017},{"type":49,"tag":58,"props":9144,"children":9145},{},[9146],{"type":55,"value":9147},"There are two important security groups that we will set up as part of the shared infrastructure layer to be used by each ad hoc environment: one security group for the load balancer, and one security group where all of our ECS services will run.",{"type":49,"tag":58,"props":9149,"children":9150},{},[9151,9153,9158,9159,9164,9166,9172,9173,9179],{"type":55,"value":9152},"The load balancer security group will allow all traffic on port ",{"type":49,"tag":326,"props":9154,"children":9156},{"className":9155},[],[9157],{"type":55,"value":2341},{"type":55,"value":715},{"type":49,"tag":326,"props":9160,"children":9162},{"className":9161},[],[9163],{"type":55,"value":2290},{"type":55,"value":9165}," for ",{"type":49,"tag":326,"props":9167,"children":9169},{"className":9168},[],[9170],{"type":55,"value":9171},"HTTP",{"type":55,"value":715},{"type":49,"tag":326,"props":9174,"children":9176},{"className":9175},[],[9177],{"type":55,"value":9178},"HTTPS",{"type":55,"value":9180}," traffic. The ECS security group will only allow inbound traffic from the application load balancer security group. It will also allow for traffic from port 6379 for redis traffic.",{"type":49,"tag":430,"props":9182,"children":9184},{"id":9183},"iam-roles",[9185],{"type":55,"value":9186},"IAM Roles",{"type":49,"tag":58,"props":9188,"children":9189},{},[9190],{"type":55,"value":9191},"There are two important IAM roles that we will need for our ECS tasks. We need a task execution role that our ECS tasks will use to interact with other AWS services, such as S3, Secrets Manager, etc.",{"type":49,"tag":430,"props":9193,"children":9195},{"id":9194},"rds-instance",[9196],{"type":55,"value":9197},"RDS Instance",{"type":49,"tag":58,"props":9199,"children":9200},{},[9201],{"type":55,"value":9202},"We will create one RDS instance in one of the private subnets in our VPC. This RDS instance will have one Postgres database per ad hoc environment. This RDS instance has a security group that allows all traffic from our ECS security group.",{"type":49,"tag":430,"props":9204,"children":9206},{"id":9205},"load-balancer",[9207],{"type":55,"value":2022},{"type":49,"tag":58,"props":9209,"children":9210},{},[9211,9213,9219,9221,9227],{"type":55,"value":9212},"We will use one load balancer for all ad hoc environments. This load balancer will have a wildcard ACM certificate attached to it (",{"type":49,"tag":326,"props":9214,"children":9216},{"className":9215},[],[9217],{"type":55,"value":9218},"*.dev.example.com",{"type":55,"value":9220},", for example). Each ad hoc environment will create a Route 53 record that will point to this load balancer's public DNS name. For example, ",{"type":49,"tag":326,"props":9222,"children":9224},{"className":9223},[],[9225],{"type":55,"value":9226},"brian.dev.example.com",{"type":55,"value":9228}," will be the address of my ad hoc environment. Requests to this address will then be routed to either the frontend ECS service or the backend ECS service depending on request header values and request path values that will be set on the listener rules.",{"type":49,"tag":58,"props":9230,"children":9231},{},[9232],{"type":55,"value":9233},"By default, a load balancer supports up to 50 listener rules, so we can create plenty of ad hoc environments before we need to increase the default quota. There will be a discussion at the end of this article about AWS service quotas.",{"type":49,"tag":430,"props":9235,"children":9236},{"id":2683},[9237],{"type":55,"value":2032},{"type":49,"tag":58,"props":9239,"children":9240},{},[9241],{"type":55,"value":9242},"The bastion host will be created in one of the VPC's public subnets. This will primarily be used for connecting to RDS to create new databases for new ad hoc environments, or for manually manipulating data in an ad hoc environment for debugging.",{"type":49,"tag":50,"props":9244,"children":9246},{"id":9245},"ad-hoc-environment-resources",[9247],{"type":55,"value":9248},"Ad hoc environment resources",{"type":49,"tag":58,"props":9250,"children":9251},{},[9252],{"type":55,"value":9253},"Now that we have defined a shared set of infrastructure that our ad hoc environments will use, let's have a look at the resources that will be specific to ad hoc environments that will be added on top of the shared resources.",{"type":49,"tag":430,"props":9255,"children":9256},{"id":2877},[9257],{"type":55,"value":2880},{"type":49,"tag":58,"props":9259,"children":9260},{},[9261],{"type":55,"value":9262},"The ECS Cluster is a simple grouping of ECS tasks and services.",{"type":49,"tag":430,"props":9264,"children":9266},{"id":9265},"ecs-tasks-and-services",[9267],{"type":55,"value":9268},"ECS Tasks and Services",{"type":49,"tag":58,"props":9270,"children":9271},{},[9272],{"type":55,"value":9273},"Each environment will have a set of ECS tasks and services that will be used to run the application.",{"type":49,"tag":58,"props":9275,"children":9276},{},[9277],{"type":55,"value":9278},"There are four important ECS services in our application that are used to run \"long-running\" ECS tasks. Long-running tasks are tasks that start processes that run indefinitely, rather than running until completion. The long-running tasks in our application include:",{"type":49,"tag":64,"props":9280,"children":9281},{},[9282,9287,9292,9297,9302],{"type":49,"tag":68,"props":9283,"children":9284},{},[9285],{"type":55,"value":9286},"backend web application (gunciron web server)",{"type":49,"tag":68,"props":9288,"children":9289},{},[9290],{"type":55,"value":9291},"backend celery worker",{"type":49,"tag":68,"props":9293,"children":9294},{},[9295],{"type":55,"value":9296},"backend celery beat",{"type":49,"tag":68,"props":9298,"children":9299},{},[9300],{"type":55,"value":9301},"frontend web site (nginx web server)",{"type":49,"tag":68,"props":9303,"children":9304},{},[9305],{"type":55,"value":3151},{"type":49,"tag":58,"props":9307,"children":9308},{},[9309],{"type":55,"value":9310},"The infrastructure code also defines some tasks that are not long-running but rather short lived tasks that run until completion and do not start again. These tasks include:",{"type":49,"tag":64,"props":9312,"children":9313},{},[9314,9318,9323],{"type":49,"tag":68,"props":9315,"children":9316},{},[9317],{"type":55,"value":3316},{"type":49,"tag":68,"props":9319,"children":9320},{},[9321],{"type":55,"value":9322},"database migrations",{"type":49,"tag":68,"props":9324,"children":9325},{},[9326],{"type":55,"value":9327},"any other ad-hoc task that we want to run, usually wrapped in a Django management command",{"type":49,"tag":50,"props":9329,"children":9331},{"id":9330},"how-to-setup-an-ad-hoc-environment",[9332],{"type":55,"value":9333},"How to setup an ad hoc environment",{"type":49,"tag":58,"props":9335,"children":9336},{},[9337],{"type":55,"value":9338},"Now that we have been over the resources that will be created to support our ad hoc environments, let's talk about how we can enable individuals on our team to create and update ad hoc environments.",{"type":49,"tag":430,"props":9340,"children":9342},{"id":9341},"design-decisions",[9343],{"type":55,"value":9344},"Design decisions",{"type":49,"tag":58,"props":9346,"children":9347},{},[9348,9350,9356,9358,9363,9364,9369,9371,9376,9378,9383],{"type":55,"value":9349},"The devops team will decide on the interface that will be used for creating an ad hoc environment. Since we are using Terraform, this interface will be a Terraform configuration. The minimum amount of information that our ad hoc environment configuration needs is image tags for the frontend and backend images to use. Other configurations will be provided by default values set in ",{"type":49,"tag":326,"props":9351,"children":9353},{"className":9352},[],[9354],{"type":55,"value":9355},"variables.tf",{"type":55,"value":9357},", and these defaults can easily be overridden by passing values to ",{"type":49,"tag":326,"props":9359,"children":9361},{"className":9360},[],[9362],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9365,"children":9367},{"className":9366},[],[9368],{"type":55,"value":559},{"type":55,"value":9370},". I'm choosing to use ",{"type":49,"tag":326,"props":9372,"children":9374},{"className":9373},[],[9375],{"type":55,"value":8809},{"type":55,"value":9377}," as the way to pass configuration values to our ad hoc environments where ",{"type":49,"tag":326,"props":9379,"children":9381},{"className":9380},[],[9382],{"type":55,"value":8839},{"type":55,"value":9384}," is the name of the ad hoc environment being created. This will give us the following benefits:",{"type":49,"tag":64,"props":9386,"children":9387},{},[9388,9400],{"type":49,"tag":68,"props":9389,"children":9390},{},[9391,9393,9398],{"type":55,"value":9392},"all ad hoc environments will be visible to the entire team in git since each ad hoc environment will have a ",{"type":49,"tag":326,"props":9394,"children":9396},{"className":9395},[],[9397],{"type":55,"value":8809},{"type":55,"value":9399}," file associated with it",{"type":49,"tag":68,"props":9401,"children":9402},{},[9403,9405],{"type":55,"value":9404},"adding additional customization to an ad hoc environment does not add additional complexity to our automation pipeline since all customization is added through a single file that will be referenced by ",{"type":49,"tag":326,"props":9406,"children":9408},{"className":9407},[],[9409],{"type":55,"value":9410},"$WORKSPACE.tfvars",{"type":49,"tag":58,"props":9412,"children":9413},{},[9414],{"type":55,"value":9415},"The downsides of this approach are:",{"type":49,"tag":64,"props":9417,"children":9418},{},[9419,9424],{"type":49,"tag":68,"props":9420,"children":9421},{},[9422],{"type":55,"value":9423},"creating ad hoc environments requires knowledge of git, so non-technical product team members might need help from the engineering team when setting up an ad hoc environment",{"type":49,"tag":68,"props":9425,"children":9426},{},[9427,9429,9434],{"type":55,"value":9428},"there is an additional \"manual\" step of creating a ",{"type":49,"tag":326,"props":9430,"children":9432},{"className":9431},[],[9433],{"type":55,"value":8809},{"type":55,"value":9435}," file that must be done before running a pipeline to create an ad hoc environment",{"type":49,"tag":58,"props":9437,"children":9438},{},[9439,9441,9446,9448,9453,9455,9460],{"type":55,"value":9440},"Provided that a ",{"type":49,"tag":326,"props":9442,"children":9444},{"className":9443},[],[9445],{"type":55,"value":8809},{"type":55,"value":9447}," file has been created and pushed to the repo, creating or updating an ad hoc environment will be as simple as running a pipeline in GitHub Actions that specifies the ",{"type":49,"tag":326,"props":9449,"children":9451},{"className":9450},[],[9452],{"type":55,"value":8839},{"type":55,"value":9454}," of our ad hoc environment. If no such ",{"type":49,"tag":326,"props":9456,"children":9458},{"className":9457},[],[9459],{"type":55,"value":8809},{"type":55,"value":9461}," file exists, our pipeline will fail.",{"type":49,"tag":430,"props":9463,"children":9465},{"id":9464},"github-action",[9466],{"type":55,"value":9467},"GitHub Action",{"type":49,"tag":58,"props":9469,"children":9470},{},[9471,9473,9479],{"type":55,"value":9472},"Creating ad hoc environments will involve manually triggering a GitHub Action that runs on ",{"type":49,"tag":326,"props":9474,"children":9476},{"className":9475},[],[9477],{"type":55,"value":9478},"workflow_dispatch",{"type":55,"value":6694},{"type":49,"tag":1050,"props":9481,"children":9483},{"code":9482},"on:\n  workflow_dispatch:\n    inputs:\n      workspace:\n        description: 'Name of terraform workspace to use'\n        required: true\n        default: 'dev'\n        type: string\n",[9484],{"type":49,"tag":326,"props":9485,"children":9486},{"__ignoreMap":8},[9487],{"type":55,"value":9482},{"type":49,"tag":58,"props":9489,"children":9490},{},[9491,9493,9498],{"type":55,"value":9492},"We only have to enter the name of the ad hoc environment we want to create or update. The ad hoc environment name is used as the Terraform workspace name. This name is also the name of the ",{"type":49,"tag":326,"props":9494,"children":9496},{"className":9495},[],[9497],{"type":55,"value":8809},{"type":55,"value":9499}," file that must be created per environment.",{"type":49,"tag":58,"props":9501,"children":9502},{},[9503,9505,9510,9511,9516,9517,9522,9524,9529,9531,9537],{"type":55,"value":9504},"This workflow will do ",{"type":49,"tag":326,"props":9506,"children":9508},{"className":9507},[],[9509],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9512,"children":9514},{"className":9513},[],[9515],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9518,"children":9520},{"className":9519},[],[9521],{"type":55,"value":559},{"type":55,"value":9523}," using the ",{"type":49,"tag":326,"props":9525,"children":9527},{"className":9526},[],[9528],{"type":55,"value":8809},{"type":55,"value":9530}," file. When everything has been created, we will use the AWS CLI to prepare the environment so that it can be used. We will use the ",{"type":49,"tag":326,"props":9532,"children":9534},{"className":9533},[],[9535],{"type":55,"value":9536},"aws ecs run-task",{"type":55,"value":9538}," command to run database migrations needed so that the application code can make database queries.",{"type":49,"tag":50,"props":9540,"children":9542},{"id":9541},"how-to-update-code-in-an-existing-ad-hoc-environment",[9543],{"type":55,"value":9544},"How to update code in an existing ad hoc environment",{"type":49,"tag":58,"props":9546,"children":9547},{},[9548,9550,9555,9557,9563,9565,9571,9573,9579,9581,9587],{"type":55,"value":9549},"Assuming that we have deployed an ad hoc environment called ",{"type":49,"tag":326,"props":9551,"children":9553},{"className":9552},[],[9554],{"type":55,"value":8817},{"type":55,"value":9556}," with version ",{"type":49,"tag":326,"props":9558,"children":9560},{"className":9559},[],[9561],{"type":55,"value":9562},"v1.0.0",{"type":55,"value":9564}," of the backend application and ",{"type":49,"tag":326,"props":9566,"children":9568},{"className":9567},[],[9569],{"type":55,"value":9570},"v2.0.0",{"type":55,"value":9572}," of the frontend application, let's think about the process of updating the application to ",{"type":49,"tag":326,"props":9574,"children":9576},{"className":9575},[],[9577],{"type":55,"value":9578},"v1.1.0",{"type":55,"value":9580}," of the backend and ",{"type":49,"tag":326,"props":9582,"children":9584},{"className":9583},[],[9585],{"type":55,"value":9586},"v2.1.0",{"type":55,"value":9588}," of the frontend.",{"type":49,"tag":58,"props":9590,"children":9591},{},[9592,9594,9600],{"type":55,"value":9593},"The simplest approach to updating the application would be edit the ",{"type":49,"tag":326,"props":9595,"children":9597},{"className":9596},[],[9598],{"type":55,"value":9599},"brian.tfvars",{"type":55,"value":9601}," file with the new versions:",{"type":49,"tag":1050,"props":9603,"children":9605},{"code":9604},"# brian.tfvars\nbe_image_tag = \"v1.1.0\"\nfe_image_tag = \"v2.1.0\"\n",[9606],{"type":49,"tag":326,"props":9607,"children":9608},{"__ignoreMap":8},[9609],{"type":55,"value":9604},{"type":49,"tag":58,"props":9611,"children":9612},{},[9613,9615,9620,9621,9626,9627,9632,9634,9639,9641,9648],{"type":55,"value":9614},"If we run the same pipeline that we initially used to deploy ad hoc environment (with ",{"type":49,"tag":326,"props":9616,"children":9618},{"className":9617},[],[9619],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9622,"children":9624},{"className":9623},[],[9625],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9628,"children":9630},{"className":9629},[],[9631],{"type":55,"value":559},{"type":55,"value":9633},") against the updated ",{"type":49,"tag":326,"props":9635,"children":9637},{"className":9636},[],[9638],{"type":55,"value":9599},{"type":55,"value":9640}," file, this will result in a rolling update of the frontend and backend services (",{"type":49,"tag":80,"props":9642,"children":9645},{"href":9643,"rel":9644},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html",[84],[9646],{"type":55,"value":9647},"more on rolling updates here",{"type":55,"value":3213},{"type":49,"tag":58,"props":9650,"children":9651},{},[9652,9654,9659,9661,9667],{"type":55,"value":9653},"If there are database migrations included in the new version of the code that is going out, we need to run database migrations after the ",{"type":49,"tag":326,"props":9655,"children":9657},{"className":9656},[],[9658],{"type":55,"value":559},{"type":55,"value":9660}," completes. We use a top level output from the ad hov environment terraform configuration that is a ",{"type":49,"tag":326,"props":9662,"children":9664},{"className":9663},[],[9665],{"type":55,"value":9666},"run-task",{"type":55,"value":9668}," command with all appropriate arguments that will run database migrations when called from GitHub Actions.",{"type":49,"tag":430,"props":9670,"children":9672},{"id":9671},"order-of-operations",[9673],{"type":55,"value":9674},"Order of Operations",{"type":49,"tag":58,"props":9676,"children":9677},{},[9678,9680,9685],{"type":55,"value":9679},"For ad hoc environments, it is probably fine to update the services and then run the database migrations. Ad hoc environments may only have a single \"user\" -- the developer, so ",{"type":49,"tag":72,"props":9681,"children":9682},{},[9683],{"type":55,"value":9684},"we don't need to worry about any errors that may occur if requests are made against the new version of code before database migrations have been applied",{"type":55,"value":745},{"type":49,"tag":58,"props":9687,"children":9688},{},[9689,9691,9697,9699,9705],{"type":55,"value":9690},"Let's consider a simple example to illustrate what can go wrong here. If we add a ",{"type":49,"tag":326,"props":9692,"children":9694},{"className":9693},[],[9695],{"type":55,"value":9696},"total_views",{"type":55,"value":9698}," to our blog post model to track the total number of page views a post has, we would add a field to the model, generate migration file with ",{"type":49,"tag":326,"props":9700,"children":9702},{"className":9701},[],[9703],{"type":55,"value":9704},"makemigrations",{"type":55,"value":9706},", and then update our views and model serializers to make use of this new field. In the time between updating our service and running the database migrations, any requests to endpoints that access the new database field will fail since the table does not yet exist.",{"type":49,"tag":58,"props":9708,"children":9709},{},[9710,9712,9717],{"type":55,"value":9711},"If we first run database migrations ",{"type":49,"tag":72,"props":9713,"children":9714},{},[9715],{"type":55,"value":9716},"and then",{"type":55,"value":9718}," update application code (ECS services), then we can avoid errors about fields not existing. In our production application, we want to aim for fewer errors, so we should be using this \"order of operations\": first run new database migrations and then update application code.",{"type":49,"tag":430,"props":9720,"children":9722},{"id":9721},"github-action-for-application-updates",[9723],{"type":55,"value":9724},"GitHub Action for application updates",{"type":49,"tag":58,"props":9726,"children":9727},{},[9728],{"type":55,"value":9729},"We need a GitHub Action that can do the following:",{"type":49,"tag":64,"props":9731,"children":9732},{},[9733,9745,9757,9769,9780,9792,9804],{"type":49,"tag":68,"props":9734,"children":9735},{},[9736,9738,9744],{"type":55,"value":9737},"fetch the current container definition JSON files for each backend tasks (",{"type":49,"tag":326,"props":9739,"children":9741},{"className":9740},[],[9742],{"type":55,"value":9743},"aws ecs describe-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9746,"children":9747},{},[9748,9750,9756],{"type":55,"value":9749},"write new container definitions JSON with the new backend image tag (using ",{"type":49,"tag":326,"props":9751,"children":9753},{"className":9752},[],[9754],{"type":55,"value":9755},"jq",{"type":55,"value":616},{"type":49,"tag":68,"props":9758,"children":9759},{},[9760,9762,9768],{"type":55,"value":9761},"register new task definitions with the new container definition JSON files for each task (",{"type":49,"tag":326,"props":9763,"children":9765},{"className":9764},[],[9766],{"type":55,"value":9767},"aws ecs register-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9770,"children":9771},{},[9772,9774,9779],{"type":55,"value":9773},"call run-task with the newly updated migration ECS task (",{"type":49,"tag":326,"props":9775,"children":9777},{"className":9776},[],[9778],{"type":55,"value":9536},{"type":55,"value":616},{"type":49,"tag":68,"props":9781,"children":9782},{},[9783,9785,9791],{"type":55,"value":9784},"wait for the task to exit and display the logs (",{"type":49,"tag":326,"props":9786,"children":9788},{"className":9787},[],[9789],{"type":55,"value":9790},"aws ecs wait tasks-stopped",{"type":55,"value":616},{"type":49,"tag":68,"props":9793,"children":9794},{},[9795,9797,9803],{"type":55,"value":9796},"update the backend services (gunicorn, celery, celery beat) (",{"type":49,"tag":326,"props":9798,"children":9800},{"className":9799},[],[9801],{"type":55,"value":9802},"aws ecs update-service",{"type":55,"value":616},{"type":49,"tag":68,"props":9805,"children":9806},{},[9807,9809,9815],{"type":55,"value":9808},"wait for the new backend services to be stable (",{"type":49,"tag":326,"props":9810,"children":9812},{"className":9811},[],[9813],{"type":55,"value":9814},"aws ecs wait services-stable",{"type":55,"value":616},{"type":49,"tag":58,"props":9817,"children":9818},{},[9819],{"type":55,"value":9820},"Here's a visual representation of the backend update process:",{"type":49,"tag":58,"props":9822,"children":9823},{},[9824],{"type":49,"tag":1601,"props":9825,"children":9827},{"alt":8926,"src":9826},"/static/adhoc/ad_hoc.backend_update.drawio.png",[],{"type":49,"tag":58,"props":9829,"children":9830},{},[9831],{"type":55,"value":9832},"In order have the correct arguments for all of the AWS CLI calls used in the above workflow, we can use the AWS CLI to fetch resource names by tag.",{"type":49,"tag":58,"props":9834,"children":9835},{},[9836],{"type":55,"value":9837},"Here is what I'm using for the script. There lots of comments, so please refer to those comments for an explanation of what the script is doing.",{"type":49,"tag":1050,"props":9839,"children":9841},{"code":9840,"language":2728,"meta":8,"className":2729,"style":8},"#!/bin/bash\n\n# This script will be called to update an ad hoc environment backend\n# with a new image tag. It will first run pre-update tasks (such as migrations)\n# and then do a rolling update of the backend services.\n\n# It is called from the ad_hock_backend_update.yml GitHub Actions file\n\n# Required environment variables that need to be exported before running this script:\n\n# WORKSPACE - ad hoc environment workspace\n# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n\necho \"Updating backend services...\"\n\n# first define a variable containing the new image URI\nNEW_BACKEND_IMAGE_URI=\"$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/backend:$BACKEND_IMAGE_TAG\"\n\n\n# register new task definitions\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\nfor TASK in \"migrate\" \"gunicorn\" \"default\" \"beat\"\ndo\n  echo \"Updating $TASK task definition...\"\n\n  # in Terraform we name our tasks based on the ad hoc environment name\n  # (also the Terraform workspace name) and the name of the task\n  # (e.g. migrate, gunicorn, default, beat)\n  TASK_FAMILY=$WORKSPACE-$TASK\n\n  # save the task definition JSON to a variable\n  TASK_DESCRIPTION=$(aws ecs describe-task-definition \\\n    --task-definition $TASK_FAMILY \\\n  )\n\n  # save container definitions to a file for each task\n  echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.containerDefinitions \\\n    > /tmp/$TASK_FAMILY.json\n\n  # write new container definition JSON with updated image\n  echo \"Writing new $TASK_FAMILY container definitions JSON...\"\n\n  # replace old image URI with new image URI in a new container definitions JSON\n  cat /tmp/$TASK_FAMILY.json \\\n    | jq \\\n    --arg IMAGE \"$NEW_BACKEND_IMAGE_URI\" '.[0].image |= $IMAGE' \\\n    > /tmp/$TASK_FAMILY-new.json\n\n  # Get the existing configuration for the task definition (memory, cpu, etc.)\n  # from the variable that we saved the task definition JSON to earlier\n  echo \"Getting existing configuration for $TASK_FAMILY...\"\n\n  MEMORY=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.memory \\\n  )\n\n  CPU=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.cpu \\\n  )\n\n  ECS_EXECUTION_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.executionRoleArn \\\n  )\n\n  ECS_TASK_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.taskRoleArn \\\n  )\n\n  # check the content of the new container definition JSON\n  cat /tmp/$TASK_FAMILY-new.json\n\n  # register new task definition using the new container definitions\n  # and the values that we read off of the existing task definitions\n  echo \"Registering new $TASK_FAMILY task definition...\"\n\n  aws ecs register-task-definition \\\n    --family $TASK_FAMILY \\\n    --container-definitions file:///tmp/$TASK_FAMILY-new.json \\\n    --memory $MEMORY \\\n    --cpu $CPU \\\n    --network-mode awsvpc \\\n    --execution-role-arn $ECS_EXECUTION_ROLE_ARN \\\n    --task-role-arn $ECS_TASK_ROLE_ARN \\\n    --requires-compatibilities \"FARGATE\"\n\ndone\n\n# Now we need to run migrate, collectstatic and any other commands that need to be run\n# before doing a rolling update of the backend services\n\n# We will use the new task definitions we just created to run these commands\n\n# get the ARN of the most recent revision of the migrate task definition\nTASK_DEFINITION=$( \\\n  aws ecs describe-task-definition \\\n    --task-definition $WORKSPACE-migrate \\\n    | jq -r \\\n    .taskDefinition.taskDefinitionArn \\\n)\n\n# get private subnets as space separated string from shared resources VPC\nSUBNETS=$( \\\n  aws ec2 describe-subnets \\\n    --filters \"Name=tag:env,Values=$SHARED_RESOURCES_WORKSPACE\" \"Name=tag:Name,Values=*private*\" \\\n    --query 'Subnets[*].SubnetId' \\\n    --output text \\\n)\n\n# replace spaces with commas using tr\nSUBNET_IDS=$(echo $SUBNETS | tr ' ' ',')\n\n# https://github.com/aws/aws-cli/issues/5348\n# get ecs_sg_id - just a single value\nECS_SG_ID=$( \\\n  aws ec2 describe-security-groups \\\n    --filters \"Name=tag:Name,Values=$SHARED_RESOURCES_WORKSPACE-ecs-sg\" \\\n    --query 'SecurityGroups[*].GroupId' \\\n    --output text \\\n)\n\necho \"Running database migrations...\"\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nSTART_TIME=$(date +%s000)\n\n# run the migration task and capture the taskArn into a variable called TASK_ID\nTASK_ID=$( \\\n  aws ecs run-task \\\n    --cluster $WORKSPACE-cluster \\\n    --task-definition $TASK_DEFINITION \\\n    --network-configuration \"awsvpcConfiguration={subnets=[$SUBNET_IDS],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}\" \\\n    | jq -r '.tasks[0].taskArn' \\\n  )\n\necho \"Task ID is $TASK_ID\"\n\n# wait for the migrate task to exit\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n# > It will poll every 6 seconds until a successful state has been reached.\n# > This will exit with a return code of 255 after 100 failed checks.\naws ecs wait tasks-stopped \\\n  --tasks $TASK_ID \\\n  --cluster $WORKSPACE-cluster\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nEND_TIME=$(date +%s000)\n\n# print the CloudWatch log events to STDOUT\naws logs get-log-events \\\n  --log-group-name \"/ecs/$WORKSPACE/migrate\" \\\n  --log-stream-name \"migrate/migrate/${TASK_ID##*/}\" \\\n  --start-time $START_TIME \\\n  --end-time $END_TIME \\\n  | jq -r '.events[].message'\n\necho \"Migrations complete. Starting rolling update for backend services...\"\n\n# update backend services\nfor TASK in \"gunicorn\" \"default\" \"beat\"\ndo\n\n  # get taskDefinitionArn for each service to be used in update-service command\n  # this will get the most recent revision of each task (the one that was just created)\n  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n  TASK_DEFINITION=$( \\\n    aws ecs describe-task-definition \\\n      --task-definition $WORKSPACE-$TASK \\\n      | jq -r \\\n      .taskDefinition.taskDefinitionArn \\\n  )\n\n  # update each service with new task definintion\n  aws ecs update-service \\\n    --cluster $WORKSPACE-cluster \\\n    --service $WORKSPACE-$TASK \\\n    --task-definition $TASK_DEFINITION \\\n    --no-cli-pager\n\ndone\n\necho \"Services updated. Waiting for services to become stable...\"\n\n# wait for all service to be stable (runningCount == desiredCount for each service)\naws ecs wait services-stable \\\n  --cluster $WORKSPACE-cluster \\\n  --services $WORKSPACE-gunicorn $WORKSPACE-default $WORKSPACE-beat\n\necho \"Services are now stable. Backend services are now up to date with $BACKEND_IMAGE_TAG.\"\n\necho \"Backend update is now complete!\"\n",[9842],{"type":49,"tag":326,"props":9843,"children":9844},{"__ignoreMap":8},[9845,9853,9860,9868,9876,9884,9891,9899,9906,9914,9921,9929,9937,9945,9953,9960,9974,9981,9989,10026,10033,10040,10048,10056,10094,10102,10125,10132,10140,10149,10158,10186,10194,10203,10240,10259,10268,10276,10285,10317,10330,10354,10362,10371,10393,10401,10410,10436,10453,10490,10511,10519,10528,10537,10559,10567,10609,10622,10630,10638,10679,10692,10700,10708,10749,10762,10770,10778,10819,10832,10840,10848,10857,10877,10885,10894,10903,10924,10932,10954,10971,10998,11016,11034,11052,11070,11088,11102,11110,11119,11127,11136,11145,11153,11162,11170,11179,11200,11220,11242,11262,11275,11283,11291,11300,11321,11343,11375,11393,11411,11419,11427,11436,11485,11493,11502,11511,11532,11553,11579,11596,11612,11620,11628,11641,11649,11658,11689,11697,11706,11727,11748,11770,11787,11824,11849,11857,11865,11887,11895,11904,11913,11922,11931,11957,11975,11993,12001,12009,12038,12046,12055,12077,12104,12136,12154,12172,12194,12202,12215,12223,12232,12260,12268,12276,12285,12294,12303,12324,12345,12371,12392,12405,12413,12421,12430,12451,12471,12496,12512,12521,12529,12537,12545,12558,12566,12575,12600,12620,12656,12664,12686,12694],{"type":49,"tag":1060,"props":9846,"children":9847},{"class":1062,"line":1063},[9848],{"type":49,"tag":1060,"props":9849,"children":9850},{"style":3039},[9851],{"type":55,"value":9852},"#!/bin/bash\n",{"type":49,"tag":1060,"props":9854,"children":9855},{"class":1062,"line":1079},[9856],{"type":49,"tag":1060,"props":9857,"children":9858},{"emptyLinePlaceholder":44},[9859],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9861,"children":9862},{"class":1062,"line":1088},[9863],{"type":49,"tag":1060,"props":9864,"children":9865},{"style":3039},[9866],{"type":55,"value":9867},"# This script will be called to update an ad hoc environment backend\n",{"type":49,"tag":1060,"props":9869,"children":9870},{"class":1062,"line":1097},[9871],{"type":49,"tag":1060,"props":9872,"children":9873},{"style":3039},[9874],{"type":55,"value":9875},"# with a new image tag. It will first run pre-update tasks (such as migrations)\n",{"type":49,"tag":1060,"props":9877,"children":9878},{"class":1062,"line":1111},[9879],{"type":49,"tag":1060,"props":9880,"children":9881},{"style":3039},[9882],{"type":55,"value":9883},"# and then do a rolling update of the backend services.\n",{"type":49,"tag":1060,"props":9885,"children":9886},{"class":1062,"line":1120},[9887],{"type":49,"tag":1060,"props":9888,"children":9889},{"emptyLinePlaceholder":44},[9890],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9892,"children":9893},{"class":1062,"line":1128},[9894],{"type":49,"tag":1060,"props":9895,"children":9896},{"style":3039},[9897],{"type":55,"value":9898},"# It is called from the ad_hock_backend_update.yml GitHub Actions file\n",{"type":49,"tag":1060,"props":9900,"children":9901},{"class":1062,"line":1141},[9902],{"type":49,"tag":1060,"props":9903,"children":9904},{"emptyLinePlaceholder":44},[9905],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9907,"children":9908},{"class":1062,"line":1150},[9909],{"type":49,"tag":1060,"props":9910,"children":9911},{"style":3039},[9912],{"type":55,"value":9913},"# Required environment variables that need to be exported before running this script:\n",{"type":49,"tag":1060,"props":9915,"children":9916},{"class":1062,"line":1158},[9917],{"type":49,"tag":1060,"props":9918,"children":9919},{"emptyLinePlaceholder":44},[9920],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9922,"children":9923},{"class":1062,"line":1171},[9924],{"type":49,"tag":1060,"props":9925,"children":9926},{"style":3039},[9927],{"type":55,"value":9928},"# WORKSPACE - ad hoc environment workspace\n",{"type":49,"tag":1060,"props":9930,"children":9931},{"class":1062,"line":1180},[9932],{"type":49,"tag":1060,"props":9933,"children":9934},{"style":3039},[9935],{"type":55,"value":9936},"# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n",{"type":49,"tag":1060,"props":9938,"children":9939},{"class":1062,"line":1188},[9940],{"type":49,"tag":1060,"props":9941,"children":9942},{"style":3039},[9943],{"type":55,"value":9944},"# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n",{"type":49,"tag":1060,"props":9946,"children":9947},{"class":1062,"line":1201},[9948],{"type":49,"tag":1060,"props":9949,"children":9950},{"style":3039},[9951],{"type":55,"value":9952},"# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n",{"type":49,"tag":1060,"props":9954,"children":9955},{"class":1062,"line":1210},[9956],{"type":49,"tag":1060,"props":9957,"children":9958},{"emptyLinePlaceholder":44},[9959],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9961,"children":9962},{"class":1062,"line":1218},[9963,9969],{"type":49,"tag":1060,"props":9964,"children":9966},{"style":9965},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[9967],{"type":55,"value":9968},"echo",{"type":49,"tag":1060,"props":9970,"children":9971},{"style":2215},[9972],{"type":55,"value":9973}," \"Updating backend services...\"\n",{"type":49,"tag":1060,"props":9975,"children":9976},{"class":1062,"line":1232},[9977],{"type":49,"tag":1060,"props":9978,"children":9979},{"emptyLinePlaceholder":44},[9980],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9982,"children":9983},{"class":1062,"line":1241},[9984],{"type":49,"tag":1060,"props":9985,"children":9986},{"style":3039},[9987],{"type":55,"value":9988},"# first define a variable containing the new image URI\n",{"type":49,"tag":1060,"props":9990,"children":9991},{"class":1062,"line":1249},[9992,9997,10001,10006,10011,10016,10021],{"type":49,"tag":1060,"props":9993,"children":9994},{"style":1073},[9995],{"type":55,"value":9996},"NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":9998,"children":9999},{"style":2194},[10000],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10002,"children":10003},{"style":2215},[10004],{"type":55,"value":10005},"\"",{"type":49,"tag":1060,"props":10007,"children":10008},{"style":1073},[10009],{"type":55,"value":10010},"$AWS_ACCOUNT_ID",{"type":49,"tag":1060,"props":10012,"children":10013},{"style":2215},[10014],{"type":55,"value":10015},".dkr.ecr.us-east-1.amazonaws.com/backend:",{"type":49,"tag":1060,"props":10017,"children":10018},{"style":1073},[10019],{"type":55,"value":10020},"$BACKEND_IMAGE_TAG",{"type":49,"tag":1060,"props":10022,"children":10023},{"style":2215},[10024],{"type":55,"value":10025},"\"\n",{"type":49,"tag":1060,"props":10027,"children":10028},{"class":1062,"line":1262},[10029],{"type":49,"tag":1060,"props":10030,"children":10031},{"emptyLinePlaceholder":44},[10032],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10034,"children":10035},{"class":1062,"line":4581},[10036],{"type":49,"tag":1060,"props":10037,"children":10038},{"emptyLinePlaceholder":44},[10039],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10041,"children":10042},{"class":1062,"line":4631},[10043],{"type":49,"tag":1060,"props":10044,"children":10045},{"style":3039},[10046],{"type":55,"value":10047},"# register new task definitions\n",{"type":49,"tag":1060,"props":10049,"children":10050},{"class":1062,"line":4682},[10051],{"type":49,"tag":1060,"props":10052,"children":10053},{"style":3039},[10054],{"type":55,"value":10055},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":10057,"children":10058},{"class":1062,"line":4709},[10059,10064,10069,10074,10079,10084,10089],{"type":49,"tag":1060,"props":10060,"children":10061},{"style":2194},[10062],{"type":55,"value":10063},"for",{"type":49,"tag":1060,"props":10065,"children":10066},{"style":1073},[10067],{"type":55,"value":10068}," TASK ",{"type":49,"tag":1060,"props":10070,"children":10071},{"style":2194},[10072],{"type":55,"value":10073},"in",{"type":49,"tag":1060,"props":10075,"children":10076},{"style":2215},[10077],{"type":55,"value":10078}," \"migrate\"",{"type":49,"tag":1060,"props":10080,"children":10081},{"style":2215},[10082],{"type":55,"value":10083}," \"gunicorn\"",{"type":49,"tag":1060,"props":10085,"children":10086},{"style":2215},[10087],{"type":55,"value":10088}," \"default\"",{"type":49,"tag":1060,"props":10090,"children":10091},{"style":2215},[10092],{"type":55,"value":10093}," \"beat\"\n",{"type":49,"tag":1060,"props":10095,"children":10096},{"class":1062,"line":5979},[10097],{"type":49,"tag":1060,"props":10098,"children":10099},{"style":2194},[10100],{"type":55,"value":10101},"do\n",{"type":49,"tag":1060,"props":10103,"children":10104},{"class":1062,"line":5988},[10105,10110,10115,10120],{"type":49,"tag":1060,"props":10106,"children":10107},{"style":9965},[10108],{"type":55,"value":10109},"  echo",{"type":49,"tag":1060,"props":10111,"children":10112},{"style":2215},[10113],{"type":55,"value":10114}," \"Updating ",{"type":49,"tag":1060,"props":10116,"children":10117},{"style":1073},[10118],{"type":55,"value":10119},"$TASK",{"type":49,"tag":1060,"props":10121,"children":10122},{"style":2215},[10123],{"type":55,"value":10124}," task definition...\"\n",{"type":49,"tag":1060,"props":10126,"children":10127},{"class":1062,"line":5997},[10128],{"type":49,"tag":1060,"props":10129,"children":10130},{"emptyLinePlaceholder":44},[10131],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10133,"children":10134},{"class":1062,"line":6006},[10135],{"type":49,"tag":1060,"props":10136,"children":10137},{"style":3039},[10138],{"type":55,"value":10139},"  # in Terraform we name our tasks based on the ad hoc environment name\n",{"type":49,"tag":1060,"props":10141,"children":10143},{"class":1062,"line":10142},29,[10144],{"type":49,"tag":1060,"props":10145,"children":10146},{"style":3039},[10147],{"type":55,"value":10148},"  # (also the Terraform workspace name) and the name of the task\n",{"type":49,"tag":1060,"props":10150,"children":10152},{"class":1062,"line":10151},30,[10153],{"type":49,"tag":1060,"props":10154,"children":10155},{"style":3039},[10156],{"type":55,"value":10157},"  # (e.g. migrate, gunicorn, default, beat)\n",{"type":49,"tag":1060,"props":10159,"children":10161},{"class":1062,"line":10160},31,[10162,10167,10171,10176,10181],{"type":49,"tag":1060,"props":10163,"children":10164},{"style":1073},[10165],{"type":55,"value":10166},"  TASK_FAMILY",{"type":49,"tag":1060,"props":10168,"children":10169},{"style":2194},[10170],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10172,"children":10173},{"style":1073},[10174],{"type":55,"value":10175},"$WORKSPACE",{"type":49,"tag":1060,"props":10177,"children":10178},{"style":2215},[10179],{"type":55,"value":10180},"-",{"type":49,"tag":1060,"props":10182,"children":10183},{"style":1073},[10184],{"type":55,"value":10185},"$TASK\n",{"type":49,"tag":1060,"props":10187,"children":10189},{"class":1062,"line":10188},32,[10190],{"type":49,"tag":1060,"props":10191,"children":10192},{"emptyLinePlaceholder":44},[10193],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10195,"children":10197},{"class":1062,"line":10196},33,[10198],{"type":49,"tag":1060,"props":10199,"children":10200},{"style":3039},[10201],{"type":55,"value":10202},"  # save the task definition JSON to a variable\n",{"type":49,"tag":1060,"props":10204,"children":10206},{"class":1062,"line":10205},34,[10207,10212,10216,10221,10225,10230,10235],{"type":49,"tag":1060,"props":10208,"children":10209},{"style":1073},[10210],{"type":55,"value":10211},"  TASK_DESCRIPTION",{"type":49,"tag":1060,"props":10213,"children":10214},{"style":2194},[10215],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10217,"children":10218},{"style":1073},[10219],{"type":55,"value":10220},"$(",{"type":49,"tag":1060,"props":10222,"children":10223},{"style":1067},[10224],{"type":55,"value":20},{"type":49,"tag":1060,"props":10226,"children":10227},{"style":2215},[10228],{"type":55,"value":10229}," ecs",{"type":49,"tag":1060,"props":10231,"children":10232},{"style":2215},[10233],{"type":55,"value":10234}," describe-task-definition",{"type":49,"tag":1060,"props":10236,"children":10237},{"style":2287},[10238],{"type":55,"value":10239}," \\\n",{"type":49,"tag":1060,"props":10241,"children":10243},{"class":1062,"line":10242},35,[10244,10249,10254],{"type":49,"tag":1060,"props":10245,"children":10246},{"style":2287},[10247],{"type":55,"value":10248},"    --task-definition",{"type":49,"tag":1060,"props":10250,"children":10251},{"style":1073},[10252],{"type":55,"value":10253}," $TASK_FAMILY ",{"type":49,"tag":1060,"props":10255,"children":10256},{"style":2287},[10257],{"type":55,"value":10258},"\\\n",{"type":49,"tag":1060,"props":10260,"children":10262},{"class":1062,"line":10261},36,[10263],{"type":49,"tag":1060,"props":10264,"children":10265},{"style":1073},[10266],{"type":55,"value":10267},"  )\n",{"type":49,"tag":1060,"props":10269,"children":10271},{"class":1062,"line":10270},37,[10272],{"type":49,"tag":1060,"props":10273,"children":10274},{"emptyLinePlaceholder":44},[10275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10277,"children":10279},{"class":1062,"line":10278},38,[10280],{"type":49,"tag":1060,"props":10281,"children":10282},{"style":3039},[10283],{"type":55,"value":10284},"  # save container definitions to a file for each task\n",{"type":49,"tag":1060,"props":10286,"children":10288},{"class":1062,"line":10287},39,[10289,10293,10298,10303,10308,10313],{"type":49,"tag":1060,"props":10290,"children":10291},{"style":9965},[10292],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10294,"children":10295},{"style":1073},[10296],{"type":55,"value":10297}," $TASK_DESCRIPTION ",{"type":49,"tag":1060,"props":10299,"children":10300},{"style":2194},[10301],{"type":55,"value":10302},"|",{"type":49,"tag":1060,"props":10304,"children":10305},{"style":1067},[10306],{"type":55,"value":10307}," jq",{"type":49,"tag":1060,"props":10309,"children":10310},{"style":2287},[10311],{"type":55,"value":10312}," -r",{"type":49,"tag":1060,"props":10314,"children":10315},{"style":2287},[10316],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10318,"children":10320},{"class":1062,"line":10319},40,[10321,10326],{"type":49,"tag":1060,"props":10322,"children":10323},{"style":2215},[10324],{"type":55,"value":10325},"    .taskDefinition.containerDefinitions",{"type":49,"tag":1060,"props":10327,"children":10328},{"style":2287},[10329],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10331,"children":10333},{"class":1062,"line":10332},41,[10334,10339,10344,10349],{"type":49,"tag":1060,"props":10335,"children":10336},{"style":2194},[10337],{"type":55,"value":10338},"    >",{"type":49,"tag":1060,"props":10340,"children":10341},{"style":2215},[10342],{"type":55,"value":10343}," /tmp/",{"type":49,"tag":1060,"props":10345,"children":10346},{"style":1073},[10347],{"type":55,"value":10348},"$TASK_FAMILY",{"type":49,"tag":1060,"props":10350,"children":10351},{"style":2215},[10352],{"type":55,"value":10353},".json\n",{"type":49,"tag":1060,"props":10355,"children":10357},{"class":1062,"line":10356},42,[10358],{"type":49,"tag":1060,"props":10359,"children":10360},{"emptyLinePlaceholder":44},[10361],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10363,"children":10365},{"class":1062,"line":10364},43,[10366],{"type":49,"tag":1060,"props":10367,"children":10368},{"style":3039},[10369],{"type":55,"value":10370},"  # write new container definition JSON with updated image\n",{"type":49,"tag":1060,"props":10372,"children":10374},{"class":1062,"line":10373},44,[10375,10379,10384,10388],{"type":49,"tag":1060,"props":10376,"children":10377},{"style":9965},[10378],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10380,"children":10381},{"style":2215},[10382],{"type":55,"value":10383}," \"Writing new ",{"type":49,"tag":1060,"props":10385,"children":10386},{"style":1073},[10387],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10389,"children":10390},{"style":2215},[10391],{"type":55,"value":10392}," container definitions JSON...\"\n",{"type":49,"tag":1060,"props":10394,"children":10396},{"class":1062,"line":10395},45,[10397],{"type":49,"tag":1060,"props":10398,"children":10399},{"emptyLinePlaceholder":44},[10400],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10402,"children":10404},{"class":1062,"line":10403},46,[10405],{"type":49,"tag":1060,"props":10406,"children":10407},{"style":3039},[10408],{"type":55,"value":10409},"  # replace old image URI with new image URI in a new container definitions JSON\n",{"type":49,"tag":1060,"props":10411,"children":10413},{"class":1062,"line":10412},47,[10414,10419,10423,10427,10432],{"type":49,"tag":1060,"props":10415,"children":10416},{"style":1067},[10417],{"type":55,"value":10418},"  cat",{"type":49,"tag":1060,"props":10420,"children":10421},{"style":2215},[10422],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10424,"children":10425},{"style":1073},[10426],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10428,"children":10429},{"style":2215},[10430],{"type":55,"value":10431},".json",{"type":49,"tag":1060,"props":10433,"children":10434},{"style":2287},[10435],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10437,"children":10439},{"class":1062,"line":10438},48,[10440,10445,10449],{"type":49,"tag":1060,"props":10441,"children":10442},{"style":2194},[10443],{"type":55,"value":10444},"    |",{"type":49,"tag":1060,"props":10446,"children":10447},{"style":1067},[10448],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10450,"children":10451},{"style":2287},[10452],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10454,"children":10456},{"class":1062,"line":10455},49,[10457,10462,10467,10472,10477,10481,10486],{"type":49,"tag":1060,"props":10458,"children":10459},{"style":2287},[10460],{"type":55,"value":10461},"    --arg",{"type":49,"tag":1060,"props":10463,"children":10464},{"style":2215},[10465],{"type":55,"value":10466}," IMAGE",{"type":49,"tag":1060,"props":10468,"children":10469},{"style":2215},[10470],{"type":55,"value":10471}," \"",{"type":49,"tag":1060,"props":10473,"children":10474},{"style":1073},[10475],{"type":55,"value":10476},"$NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":10478,"children":10479},{"style":2215},[10480],{"type":55,"value":10005},{"type":49,"tag":1060,"props":10482,"children":10483},{"style":2215},[10484],{"type":55,"value":10485}," '.[0].image |= $IMAGE'",{"type":49,"tag":1060,"props":10487,"children":10488},{"style":2287},[10489],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10491,"children":10493},{"class":1062,"line":10492},50,[10494,10498,10502,10506],{"type":49,"tag":1060,"props":10495,"children":10496},{"style":2194},[10497],{"type":55,"value":10338},{"type":49,"tag":1060,"props":10499,"children":10500},{"style":2215},[10501],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10503,"children":10504},{"style":1073},[10505],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10507,"children":10508},{"style":2215},[10509],{"type":55,"value":10510},"-new.json\n",{"type":49,"tag":1060,"props":10512,"children":10514},{"class":1062,"line":10513},51,[10515],{"type":49,"tag":1060,"props":10516,"children":10517},{"emptyLinePlaceholder":44},[10518],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10520,"children":10522},{"class":1062,"line":10521},52,[10523],{"type":49,"tag":1060,"props":10524,"children":10525},{"style":3039},[10526],{"type":55,"value":10527},"  # Get the existing configuration for the task definition (memory, cpu, etc.)\n",{"type":49,"tag":1060,"props":10529,"children":10531},{"class":1062,"line":10530},53,[10532],{"type":49,"tag":1060,"props":10533,"children":10534},{"style":3039},[10535],{"type":55,"value":10536},"  # from the variable that we saved the task definition JSON to earlier\n",{"type":49,"tag":1060,"props":10538,"children":10540},{"class":1062,"line":10539},54,[10541,10545,10550,10554],{"type":49,"tag":1060,"props":10542,"children":10543},{"style":9965},[10544],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10546,"children":10547},{"style":2215},[10548],{"type":55,"value":10549}," \"Getting existing configuration for ",{"type":49,"tag":1060,"props":10551,"children":10552},{"style":1073},[10553],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10555,"children":10556},{"style":2215},[10557],{"type":55,"value":10558},"...\"\n",{"type":49,"tag":1060,"props":10560,"children":10562},{"class":1062,"line":10561},55,[10563],{"type":49,"tag":1060,"props":10564,"children":10565},{"emptyLinePlaceholder":44},[10566],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10568,"children":10570},{"class":1062,"line":10569},56,[10571,10576,10580,10585,10589,10593,10597,10601,10605],{"type":49,"tag":1060,"props":10572,"children":10573},{"style":1073},[10574],{"type":55,"value":10575},"  MEMORY",{"type":49,"tag":1060,"props":10577,"children":10578},{"style":2194},[10579],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10581,"children":10582},{"style":1073},[10583],{"type":55,"value":10584},"$( ",{"type":49,"tag":1060,"props":10586,"children":10587},{"style":9965},[10588],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10590,"children":10591},{"style":1073},[10592],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10594,"children":10595},{"style":2194},[10596],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10598,"children":10599},{"style":1067},[10600],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10602,"children":10603},{"style":2287},[10604],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10606,"children":10607},{"style":2287},[10608],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10610,"children":10612},{"class":1062,"line":10611},57,[10613,10618],{"type":49,"tag":1060,"props":10614,"children":10615},{"style":2215},[10616],{"type":55,"value":10617},"    .taskDefinition.memory",{"type":49,"tag":1060,"props":10619,"children":10620},{"style":2287},[10621],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10623,"children":10625},{"class":1062,"line":10624},58,[10626],{"type":49,"tag":1060,"props":10627,"children":10628},{"style":1073},[10629],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10631,"children":10633},{"class":1062,"line":10632},59,[10634],{"type":49,"tag":1060,"props":10635,"children":10636},{"emptyLinePlaceholder":44},[10637],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10639,"children":10641},{"class":1062,"line":10640},60,[10642,10647,10651,10655,10659,10663,10667,10671,10675],{"type":49,"tag":1060,"props":10643,"children":10644},{"style":1073},[10645],{"type":55,"value":10646},"  CPU",{"type":49,"tag":1060,"props":10648,"children":10649},{"style":2194},[10650],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10652,"children":10653},{"style":1073},[10654],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10656,"children":10657},{"style":9965},[10658],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10660,"children":10661},{"style":1073},[10662],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10664,"children":10665},{"style":2194},[10666],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10668,"children":10669},{"style":1067},[10670],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10672,"children":10673},{"style":2287},[10674],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10676,"children":10677},{"style":2287},[10678],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10680,"children":10682},{"class":1062,"line":10681},61,[10683,10688],{"type":49,"tag":1060,"props":10684,"children":10685},{"style":2215},[10686],{"type":55,"value":10687},"    .taskDefinition.cpu",{"type":49,"tag":1060,"props":10689,"children":10690},{"style":2287},[10691],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10693,"children":10695},{"class":1062,"line":10694},62,[10696],{"type":49,"tag":1060,"props":10697,"children":10698},{"style":1073},[10699],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10701,"children":10703},{"class":1062,"line":10702},63,[10704],{"type":49,"tag":1060,"props":10705,"children":10706},{"emptyLinePlaceholder":44},[10707],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10709,"children":10711},{"class":1062,"line":10710},64,[10712,10717,10721,10725,10729,10733,10737,10741,10745],{"type":49,"tag":1060,"props":10713,"children":10714},{"style":1073},[10715],{"type":55,"value":10716},"  ECS_EXECUTION_ROLE_ARN",{"type":49,"tag":1060,"props":10718,"children":10719},{"style":2194},[10720],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10722,"children":10723},{"style":1073},[10724],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10726,"children":10727},{"style":9965},[10728],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10730,"children":10731},{"style":1073},[10732],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10734,"children":10735},{"style":2194},[10736],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10738,"children":10739},{"style":1067},[10740],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10742,"children":10743},{"style":2287},[10744],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10746,"children":10747},{"style":2287},[10748],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10750,"children":10752},{"class":1062,"line":10751},65,[10753,10758],{"type":49,"tag":1060,"props":10754,"children":10755},{"style":2215},[10756],{"type":55,"value":10757},"    .taskDefinition.executionRoleArn",{"type":49,"tag":1060,"props":10759,"children":10760},{"style":2287},[10761],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10763,"children":10765},{"class":1062,"line":10764},66,[10766],{"type":49,"tag":1060,"props":10767,"children":10768},{"style":1073},[10769],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10771,"children":10773},{"class":1062,"line":10772},67,[10774],{"type":49,"tag":1060,"props":10775,"children":10776},{"emptyLinePlaceholder":44},[10777],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10779,"children":10781},{"class":1062,"line":10780},68,[10782,10787,10791,10795,10799,10803,10807,10811,10815],{"type":49,"tag":1060,"props":10783,"children":10784},{"style":1073},[10785],{"type":55,"value":10786},"  ECS_TASK_ROLE_ARN",{"type":49,"tag":1060,"props":10788,"children":10789},{"style":2194},[10790],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10792,"children":10793},{"style":1073},[10794],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10796,"children":10797},{"style":9965},[10798],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10800,"children":10801},{"style":1073},[10802],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10804,"children":10805},{"style":2194},[10806],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10808,"children":10809},{"style":1067},[10810],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10812,"children":10813},{"style":2287},[10814],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10816,"children":10817},{"style":2287},[10818],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10820,"children":10822},{"class":1062,"line":10821},69,[10823,10828],{"type":49,"tag":1060,"props":10824,"children":10825},{"style":2215},[10826],{"type":55,"value":10827},"    .taskDefinition.taskRoleArn",{"type":49,"tag":1060,"props":10829,"children":10830},{"style":2287},[10831],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10833,"children":10835},{"class":1062,"line":10834},70,[10836],{"type":49,"tag":1060,"props":10837,"children":10838},{"style":1073},[10839],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10841,"children":10843},{"class":1062,"line":10842},71,[10844],{"type":49,"tag":1060,"props":10845,"children":10846},{"emptyLinePlaceholder":44},[10847],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10849,"children":10851},{"class":1062,"line":10850},72,[10852],{"type":49,"tag":1060,"props":10853,"children":10854},{"style":3039},[10855],{"type":55,"value":10856},"  # check the content of the new container definition JSON\n",{"type":49,"tag":1060,"props":10858,"children":10860},{"class":1062,"line":10859},73,[10861,10865,10869,10873],{"type":49,"tag":1060,"props":10862,"children":10863},{"style":1067},[10864],{"type":55,"value":10418},{"type":49,"tag":1060,"props":10866,"children":10867},{"style":2215},[10868],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10870,"children":10871},{"style":1073},[10872],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10874,"children":10875},{"style":2215},[10876],{"type":55,"value":10510},{"type":49,"tag":1060,"props":10878,"children":10880},{"class":1062,"line":10879},74,[10881],{"type":49,"tag":1060,"props":10882,"children":10883},{"emptyLinePlaceholder":44},[10884],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10886,"children":10888},{"class":1062,"line":10887},75,[10889],{"type":49,"tag":1060,"props":10890,"children":10891},{"style":3039},[10892],{"type":55,"value":10893},"  # register new task definition using the new container definitions\n",{"type":49,"tag":1060,"props":10895,"children":10897},{"class":1062,"line":10896},76,[10898],{"type":49,"tag":1060,"props":10899,"children":10900},{"style":3039},[10901],{"type":55,"value":10902},"  # and the values that we read off of the existing task definitions\n",{"type":49,"tag":1060,"props":10904,"children":10906},{"class":1062,"line":10905},77,[10907,10911,10916,10920],{"type":49,"tag":1060,"props":10908,"children":10909},{"style":9965},[10910],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10912,"children":10913},{"style":2215},[10914],{"type":55,"value":10915}," \"Registering new ",{"type":49,"tag":1060,"props":10917,"children":10918},{"style":1073},[10919],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10921,"children":10922},{"style":2215},[10923],{"type":55,"value":10124},{"type":49,"tag":1060,"props":10925,"children":10927},{"class":1062,"line":10926},78,[10928],{"type":49,"tag":1060,"props":10929,"children":10930},{"emptyLinePlaceholder":44},[10931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10933,"children":10935},{"class":1062,"line":10934},79,[10936,10941,10945,10950],{"type":49,"tag":1060,"props":10937,"children":10938},{"style":1067},[10939],{"type":55,"value":10940},"  aws",{"type":49,"tag":1060,"props":10942,"children":10943},{"style":2215},[10944],{"type":55,"value":10229},{"type":49,"tag":1060,"props":10946,"children":10947},{"style":2215},[10948],{"type":55,"value":10949}," register-task-definition",{"type":49,"tag":1060,"props":10951,"children":10952},{"style":2287},[10953],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10955,"children":10957},{"class":1062,"line":10956},80,[10958,10963,10967],{"type":49,"tag":1060,"props":10959,"children":10960},{"style":2287},[10961],{"type":55,"value":10962},"    --family",{"type":49,"tag":1060,"props":10964,"children":10965},{"style":1073},[10966],{"type":55,"value":10253},{"type":49,"tag":1060,"props":10968,"children":10969},{"style":2287},[10970],{"type":55,"value":10258},{"type":49,"tag":1060,"props":10972,"children":10974},{"class":1062,"line":10973},81,[10975,10980,10985,10989,10994],{"type":49,"tag":1060,"props":10976,"children":10977},{"style":2287},[10978],{"type":55,"value":10979},"    --container-definitions",{"type":49,"tag":1060,"props":10981,"children":10982},{"style":2215},[10983],{"type":55,"value":10984}," file:///tmp/",{"type":49,"tag":1060,"props":10986,"children":10987},{"style":1073},[10988],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10990,"children":10991},{"style":2215},[10992],{"type":55,"value":10993},"-new.json",{"type":49,"tag":1060,"props":10995,"children":10996},{"style":2287},[10997],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10999,"children":11001},{"class":1062,"line":11000},82,[11002,11007,11012],{"type":49,"tag":1060,"props":11003,"children":11004},{"style":2287},[11005],{"type":55,"value":11006},"    --memory",{"type":49,"tag":1060,"props":11008,"children":11009},{"style":1073},[11010],{"type":55,"value":11011}," $MEMORY ",{"type":49,"tag":1060,"props":11013,"children":11014},{"style":2287},[11015],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11017,"children":11019},{"class":1062,"line":11018},83,[11020,11025,11030],{"type":49,"tag":1060,"props":11021,"children":11022},{"style":2287},[11023],{"type":55,"value":11024},"    --cpu",{"type":49,"tag":1060,"props":11026,"children":11027},{"style":1073},[11028],{"type":55,"value":11029}," $CPU ",{"type":49,"tag":1060,"props":11031,"children":11032},{"style":2287},[11033],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11035,"children":11037},{"class":1062,"line":11036},84,[11038,11043,11048],{"type":49,"tag":1060,"props":11039,"children":11040},{"style":2287},[11041],{"type":55,"value":11042},"    --network-mode",{"type":49,"tag":1060,"props":11044,"children":11045},{"style":2215},[11046],{"type":55,"value":11047}," awsvpc",{"type":49,"tag":1060,"props":11049,"children":11050},{"style":2287},[11051],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11053,"children":11055},{"class":1062,"line":11054},85,[11056,11061,11066],{"type":49,"tag":1060,"props":11057,"children":11058},{"style":2287},[11059],{"type":55,"value":11060},"    --execution-role-arn",{"type":49,"tag":1060,"props":11062,"children":11063},{"style":1073},[11064],{"type":55,"value":11065}," $ECS_EXECUTION_ROLE_ARN ",{"type":49,"tag":1060,"props":11067,"children":11068},{"style":2287},[11069],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11071,"children":11073},{"class":1062,"line":11072},86,[11074,11079,11084],{"type":49,"tag":1060,"props":11075,"children":11076},{"style":2287},[11077],{"type":55,"value":11078},"    --task-role-arn",{"type":49,"tag":1060,"props":11080,"children":11081},{"style":1073},[11082],{"type":55,"value":11083}," $ECS_TASK_ROLE_ARN ",{"type":49,"tag":1060,"props":11085,"children":11086},{"style":2287},[11087],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11089,"children":11091},{"class":1062,"line":11090},87,[11092,11097],{"type":49,"tag":1060,"props":11093,"children":11094},{"style":2287},[11095],{"type":55,"value":11096},"    --requires-compatibilities",{"type":49,"tag":1060,"props":11098,"children":11099},{"style":2215},[11100],{"type":55,"value":11101}," \"FARGATE\"\n",{"type":49,"tag":1060,"props":11103,"children":11105},{"class":1062,"line":11104},88,[11106],{"type":49,"tag":1060,"props":11107,"children":11108},{"emptyLinePlaceholder":44},[11109],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11111,"children":11113},{"class":1062,"line":11112},89,[11114],{"type":49,"tag":1060,"props":11115,"children":11116},{"style":2194},[11117],{"type":55,"value":11118},"done\n",{"type":49,"tag":1060,"props":11120,"children":11122},{"class":1062,"line":11121},90,[11123],{"type":49,"tag":1060,"props":11124,"children":11125},{"emptyLinePlaceholder":44},[11126],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11128,"children":11130},{"class":1062,"line":11129},91,[11131],{"type":49,"tag":1060,"props":11132,"children":11133},{"style":3039},[11134],{"type":55,"value":11135},"# Now we need to run migrate, collectstatic and any other commands that need to be run\n",{"type":49,"tag":1060,"props":11137,"children":11139},{"class":1062,"line":11138},92,[11140],{"type":49,"tag":1060,"props":11141,"children":11142},{"style":3039},[11143],{"type":55,"value":11144},"# before doing a rolling update of the backend services\n",{"type":49,"tag":1060,"props":11146,"children":11148},{"class":1062,"line":11147},93,[11149],{"type":49,"tag":1060,"props":11150,"children":11151},{"emptyLinePlaceholder":44},[11152],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11154,"children":11156},{"class":1062,"line":11155},94,[11157],{"type":49,"tag":1060,"props":11158,"children":11159},{"style":3039},[11160],{"type":55,"value":11161},"# We will use the new task definitions we just created to run these commands\n",{"type":49,"tag":1060,"props":11163,"children":11165},{"class":1062,"line":11164},95,[11166],{"type":49,"tag":1060,"props":11167,"children":11168},{"emptyLinePlaceholder":44},[11169],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11171,"children":11173},{"class":1062,"line":11172},96,[11174],{"type":49,"tag":1060,"props":11175,"children":11176},{"style":3039},[11177],{"type":55,"value":11178},"# get the ARN of the most recent revision of the migrate task definition\n",{"type":49,"tag":1060,"props":11180,"children":11182},{"class":1062,"line":11181},97,[11183,11188,11192,11196],{"type":49,"tag":1060,"props":11184,"children":11185},{"style":1073},[11186],{"type":55,"value":11187},"TASK_DEFINITION",{"type":49,"tag":1060,"props":11189,"children":11190},{"style":2194},[11191],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11193,"children":11194},{"style":1073},[11195],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11197,"children":11198},{"style":2287},[11199],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11201,"children":11203},{"class":1062,"line":11202},98,[11204,11208,11212,11216],{"type":49,"tag":1060,"props":11205,"children":11206},{"style":1067},[11207],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11209,"children":11210},{"style":2215},[11211],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11213,"children":11214},{"style":2215},[11215],{"type":55,"value":10234},{"type":49,"tag":1060,"props":11217,"children":11218},{"style":2287},[11219],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11221,"children":11223},{"class":1062,"line":11222},99,[11224,11228,11233,11238],{"type":49,"tag":1060,"props":11225,"children":11226},{"style":2287},[11227],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11229,"children":11230},{"style":1073},[11231],{"type":55,"value":11232}," $WORKSPACE",{"type":49,"tag":1060,"props":11234,"children":11235},{"style":2215},[11236],{"type":55,"value":11237},"-migrate",{"type":49,"tag":1060,"props":11239,"children":11240},{"style":2287},[11241],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11243,"children":11245},{"class":1062,"line":11244},100,[11246,11250,11254,11258],{"type":49,"tag":1060,"props":11247,"children":11248},{"style":2194},[11249],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11251,"children":11252},{"style":1067},[11253],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11255,"children":11256},{"style":2287},[11257],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11259,"children":11260},{"style":2287},[11261],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11263,"children":11265},{"class":1062,"line":11264},101,[11266,11271],{"type":49,"tag":1060,"props":11267,"children":11268},{"style":2215},[11269],{"type":55,"value":11270},"    .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":11272,"children":11273},{"style":2287},[11274],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11276,"children":11278},{"class":1062,"line":11277},102,[11279],{"type":49,"tag":1060,"props":11280,"children":11281},{"style":1073},[11282],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11284,"children":11286},{"class":1062,"line":11285},103,[11287],{"type":49,"tag":1060,"props":11288,"children":11289},{"emptyLinePlaceholder":44},[11290],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11292,"children":11294},{"class":1062,"line":11293},104,[11295],{"type":49,"tag":1060,"props":11296,"children":11297},{"style":3039},[11298],{"type":55,"value":11299},"# get private subnets as space separated string from shared resources VPC\n",{"type":49,"tag":1060,"props":11301,"children":11303},{"class":1062,"line":11302},105,[11304,11309,11313,11317],{"type":49,"tag":1060,"props":11305,"children":11306},{"style":1073},[11307],{"type":55,"value":11308},"SUBNETS",{"type":49,"tag":1060,"props":11310,"children":11311},{"style":2194},[11312],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11314,"children":11315},{"style":1073},[11316],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11318,"children":11319},{"style":2287},[11320],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11322,"children":11324},{"class":1062,"line":11323},106,[11325,11329,11334,11339],{"type":49,"tag":1060,"props":11326,"children":11327},{"style":1067},[11328],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11330,"children":11331},{"style":2215},[11332],{"type":55,"value":11333}," ec2",{"type":49,"tag":1060,"props":11335,"children":11336},{"style":2215},[11337],{"type":55,"value":11338}," describe-subnets",{"type":49,"tag":1060,"props":11340,"children":11341},{"style":2287},[11342],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11344,"children":11346},{"class":1062,"line":11345},107,[11347,11352,11357,11362,11366,11371],{"type":49,"tag":1060,"props":11348,"children":11349},{"style":2287},[11350],{"type":55,"value":11351},"    --filters",{"type":49,"tag":1060,"props":11353,"children":11354},{"style":2215},[11355],{"type":55,"value":11356}," \"Name=tag:env,Values=",{"type":49,"tag":1060,"props":11358,"children":11359},{"style":1073},[11360],{"type":55,"value":11361},"$SHARED_RESOURCES_WORKSPACE",{"type":49,"tag":1060,"props":11363,"children":11364},{"style":2215},[11365],{"type":55,"value":10005},{"type":49,"tag":1060,"props":11367,"children":11368},{"style":2215},[11369],{"type":55,"value":11370}," \"Name=tag:Name,Values=*private*\"",{"type":49,"tag":1060,"props":11372,"children":11373},{"style":2287},[11374],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11376,"children":11378},{"class":1062,"line":11377},108,[11379,11384,11389],{"type":49,"tag":1060,"props":11380,"children":11381},{"style":2287},[11382],{"type":55,"value":11383},"    --query",{"type":49,"tag":1060,"props":11385,"children":11386},{"style":2215},[11387],{"type":55,"value":11388}," 'Subnets[*].SubnetId'",{"type":49,"tag":1060,"props":11390,"children":11391},{"style":2287},[11392],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11394,"children":11396},{"class":1062,"line":11395},109,[11397,11402,11407],{"type":49,"tag":1060,"props":11398,"children":11399},{"style":2287},[11400],{"type":55,"value":11401},"    --output",{"type":49,"tag":1060,"props":11403,"children":11404},{"style":2215},[11405],{"type":55,"value":11406}," text",{"type":49,"tag":1060,"props":11408,"children":11409},{"style":2287},[11410],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11412,"children":11414},{"class":1062,"line":11413},110,[11415],{"type":49,"tag":1060,"props":11416,"children":11417},{"style":1073},[11418],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11420,"children":11422},{"class":1062,"line":11421},111,[11423],{"type":49,"tag":1060,"props":11424,"children":11425},{"emptyLinePlaceholder":44},[11426],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11428,"children":11430},{"class":1062,"line":11429},112,[11431],{"type":49,"tag":1060,"props":11432,"children":11433},{"style":3039},[11434],{"type":55,"value":11435},"# replace spaces with commas using tr\n",{"type":49,"tag":1060,"props":11437,"children":11439},{"class":1062,"line":11438},113,[11440,11445,11449,11453,11457,11462,11466,11471,11476,11481],{"type":49,"tag":1060,"props":11441,"children":11442},{"style":1073},[11443],{"type":55,"value":11444},"SUBNET_IDS",{"type":49,"tag":1060,"props":11446,"children":11447},{"style":2194},[11448],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11450,"children":11451},{"style":1073},[11452],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11454,"children":11455},{"style":9965},[11456],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11458,"children":11459},{"style":1073},[11460],{"type":55,"value":11461}," $SUBNETS ",{"type":49,"tag":1060,"props":11463,"children":11464},{"style":2194},[11465],{"type":55,"value":10302},{"type":49,"tag":1060,"props":11467,"children":11468},{"style":1067},[11469],{"type":55,"value":11470}," tr",{"type":49,"tag":1060,"props":11472,"children":11473},{"style":2215},[11474],{"type":55,"value":11475}," ' '",{"type":49,"tag":1060,"props":11477,"children":11478},{"style":2215},[11479],{"type":55,"value":11480}," ','",{"type":49,"tag":1060,"props":11482,"children":11483},{"style":1073},[11484],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11486,"children":11488},{"class":1062,"line":11487},114,[11489],{"type":49,"tag":1060,"props":11490,"children":11491},{"emptyLinePlaceholder":44},[11492],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11494,"children":11496},{"class":1062,"line":11495},115,[11497],{"type":49,"tag":1060,"props":11498,"children":11499},{"style":3039},[11500],{"type":55,"value":11501},"# https://github.com/aws/aws-cli/issues/5348\n",{"type":49,"tag":1060,"props":11503,"children":11505},{"class":1062,"line":11504},116,[11506],{"type":49,"tag":1060,"props":11507,"children":11508},{"style":3039},[11509],{"type":55,"value":11510},"# get ecs_sg_id - just a single value\n",{"type":49,"tag":1060,"props":11512,"children":11514},{"class":1062,"line":11513},117,[11515,11520,11524,11528],{"type":49,"tag":1060,"props":11516,"children":11517},{"style":1073},[11518],{"type":55,"value":11519},"ECS_SG_ID",{"type":49,"tag":1060,"props":11521,"children":11522},{"style":2194},[11523],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11525,"children":11526},{"style":1073},[11527],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11529,"children":11530},{"style":2287},[11531],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11533,"children":11535},{"class":1062,"line":11534},118,[11536,11540,11544,11549],{"type":49,"tag":1060,"props":11537,"children":11538},{"style":1067},[11539],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11541,"children":11542},{"style":2215},[11543],{"type":55,"value":11333},{"type":49,"tag":1060,"props":11545,"children":11546},{"style":2215},[11547],{"type":55,"value":11548}," describe-security-groups",{"type":49,"tag":1060,"props":11550,"children":11551},{"style":2287},[11552],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11554,"children":11556},{"class":1062,"line":11555},119,[11557,11561,11566,11570,11575],{"type":49,"tag":1060,"props":11558,"children":11559},{"style":2287},[11560],{"type":55,"value":11351},{"type":49,"tag":1060,"props":11562,"children":11563},{"style":2215},[11564],{"type":55,"value":11565}," \"Name=tag:Name,Values=",{"type":49,"tag":1060,"props":11567,"children":11568},{"style":1073},[11569],{"type":55,"value":11361},{"type":49,"tag":1060,"props":11571,"children":11572},{"style":2215},[11573],{"type":55,"value":11574},"-ecs-sg\"",{"type":49,"tag":1060,"props":11576,"children":11577},{"style":2287},[11578],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11580,"children":11582},{"class":1062,"line":11581},120,[11583,11587,11592],{"type":49,"tag":1060,"props":11584,"children":11585},{"style":2287},[11586],{"type":55,"value":11383},{"type":49,"tag":1060,"props":11588,"children":11589},{"style":2215},[11590],{"type":55,"value":11591}," 'SecurityGroups[*].GroupId'",{"type":49,"tag":1060,"props":11593,"children":11594},{"style":2287},[11595],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11597,"children":11599},{"class":1062,"line":11598},121,[11600,11604,11608],{"type":49,"tag":1060,"props":11601,"children":11602},{"style":2287},[11603],{"type":55,"value":11401},{"type":49,"tag":1060,"props":11605,"children":11606},{"style":2215},[11607],{"type":55,"value":11406},{"type":49,"tag":1060,"props":11609,"children":11610},{"style":2287},[11611],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11613,"children":11615},{"class":1062,"line":11614},122,[11616],{"type":49,"tag":1060,"props":11617,"children":11618},{"style":1073},[11619],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11621,"children":11623},{"class":1062,"line":11622},123,[11624],{"type":49,"tag":1060,"props":11625,"children":11626},{"emptyLinePlaceholder":44},[11627],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11629,"children":11631},{"class":1062,"line":11630},124,[11632,11636],{"type":49,"tag":1060,"props":11633,"children":11634},{"style":9965},[11635],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11637,"children":11638},{"style":2215},[11639],{"type":55,"value":11640}," \"Running database migrations...\"\n",{"type":49,"tag":1060,"props":11642,"children":11644},{"class":1062,"line":11643},125,[11645],{"type":49,"tag":1060,"props":11646,"children":11647},{"emptyLinePlaceholder":44},[11648],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11650,"children":11652},{"class":1062,"line":11651},126,[11653],{"type":49,"tag":1060,"props":11654,"children":11655},{"style":3039},[11656],{"type":55,"value":11657},"# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\n",{"type":49,"tag":1060,"props":11659,"children":11661},{"class":1062,"line":11660},127,[11662,11667,11671,11675,11680,11685],{"type":49,"tag":1060,"props":11663,"children":11664},{"style":1073},[11665],{"type":55,"value":11666},"START_TIME",{"type":49,"tag":1060,"props":11668,"children":11669},{"style":2194},[11670],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11672,"children":11673},{"style":1073},[11674],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11676,"children":11677},{"style":1067},[11678],{"type":55,"value":11679},"date",{"type":49,"tag":1060,"props":11681,"children":11682},{"style":2215},[11683],{"type":55,"value":11684}," +%s000",{"type":49,"tag":1060,"props":11686,"children":11687},{"style":1073},[11688],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11690,"children":11692},{"class":1062,"line":11691},128,[11693],{"type":49,"tag":1060,"props":11694,"children":11695},{"emptyLinePlaceholder":44},[11696],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11698,"children":11700},{"class":1062,"line":11699},129,[11701],{"type":49,"tag":1060,"props":11702,"children":11703},{"style":3039},[11704],{"type":55,"value":11705},"# run the migration task and capture the taskArn into a variable called TASK_ID\n",{"type":49,"tag":1060,"props":11707,"children":11709},{"class":1062,"line":11708},130,[11710,11715,11719,11723],{"type":49,"tag":1060,"props":11711,"children":11712},{"style":1073},[11713],{"type":55,"value":11714},"TASK_ID",{"type":49,"tag":1060,"props":11716,"children":11717},{"style":2194},[11718],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11720,"children":11721},{"style":1073},[11722],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11724,"children":11725},{"style":2287},[11726],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11728,"children":11730},{"class":1062,"line":11729},131,[11731,11735,11739,11744],{"type":49,"tag":1060,"props":11732,"children":11733},{"style":1067},[11734],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11736,"children":11737},{"style":2215},[11738],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11740,"children":11741},{"style":2215},[11742],{"type":55,"value":11743}," run-task",{"type":49,"tag":1060,"props":11745,"children":11746},{"style":2287},[11747],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11749,"children":11751},{"class":1062,"line":11750},132,[11752,11757,11761,11766],{"type":49,"tag":1060,"props":11753,"children":11754},{"style":2287},[11755],{"type":55,"value":11756},"    --cluster",{"type":49,"tag":1060,"props":11758,"children":11759},{"style":1073},[11760],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11762,"children":11763},{"style":2215},[11764],{"type":55,"value":11765},"-cluster",{"type":49,"tag":1060,"props":11767,"children":11768},{"style":2287},[11769],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11771,"children":11773},{"class":1062,"line":11772},133,[11774,11778,11783],{"type":49,"tag":1060,"props":11775,"children":11776},{"style":2287},[11777],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11779,"children":11780},{"style":1073},[11781],{"type":55,"value":11782}," $TASK_DEFINITION ",{"type":49,"tag":1060,"props":11784,"children":11785},{"style":2287},[11786],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11788,"children":11790},{"class":1062,"line":11789},134,[11791,11796,11801,11806,11810,11815,11820],{"type":49,"tag":1060,"props":11792,"children":11793},{"style":2287},[11794],{"type":55,"value":11795},"    --network-configuration",{"type":49,"tag":1060,"props":11797,"children":11798},{"style":2215},[11799],{"type":55,"value":11800}," \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":11802,"children":11803},{"style":1073},[11804],{"type":55,"value":11805},"$SUBNET_IDS",{"type":49,"tag":1060,"props":11807,"children":11808},{"style":2215},[11809],{"type":55,"value":3620},{"type":49,"tag":1060,"props":11811,"children":11812},{"style":1073},[11813],{"type":55,"value":11814},"$ECS_SG_ID",{"type":49,"tag":1060,"props":11816,"children":11817},{"style":2215},[11818],{"type":55,"value":11819},"],assignPublicIp=ENABLED}\"",{"type":49,"tag":1060,"props":11821,"children":11822},{"style":2287},[11823],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11825,"children":11827},{"class":1062,"line":11826},135,[11828,11832,11836,11840,11845],{"type":49,"tag":1060,"props":11829,"children":11830},{"style":2194},[11831],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11833,"children":11834},{"style":1067},[11835],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11837,"children":11838},{"style":2287},[11839],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11841,"children":11842},{"style":2215},[11843],{"type":55,"value":11844}," '.tasks[0].taskArn'",{"type":49,"tag":1060,"props":11846,"children":11847},{"style":2287},[11848],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11850,"children":11852},{"class":1062,"line":11851},136,[11853],{"type":49,"tag":1060,"props":11854,"children":11855},{"style":1073},[11856],{"type":55,"value":10267},{"type":49,"tag":1060,"props":11858,"children":11860},{"class":1062,"line":11859},137,[11861],{"type":49,"tag":1060,"props":11862,"children":11863},{"emptyLinePlaceholder":44},[11864],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11866,"children":11868},{"class":1062,"line":11867},138,[11869,11873,11878,11883],{"type":49,"tag":1060,"props":11870,"children":11871},{"style":9965},[11872],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11874,"children":11875},{"style":2215},[11876],{"type":55,"value":11877}," \"Task ID is ",{"type":49,"tag":1060,"props":11879,"children":11880},{"style":1073},[11881],{"type":55,"value":11882},"$TASK_ID",{"type":49,"tag":1060,"props":11884,"children":11885},{"style":2215},[11886],{"type":55,"value":10025},{"type":49,"tag":1060,"props":11888,"children":11890},{"class":1062,"line":11889},139,[11891],{"type":49,"tag":1060,"props":11892,"children":11893},{"emptyLinePlaceholder":44},[11894],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11896,"children":11898},{"class":1062,"line":11897},140,[11899],{"type":49,"tag":1060,"props":11900,"children":11901},{"style":3039},[11902],{"type":55,"value":11903},"# wait for the migrate task to exit\n",{"type":49,"tag":1060,"props":11905,"children":11907},{"class":1062,"line":11906},141,[11908],{"type":49,"tag":1060,"props":11909,"children":11910},{"style":3039},[11911],{"type":55,"value":11912},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n",{"type":49,"tag":1060,"props":11914,"children":11916},{"class":1062,"line":11915},142,[11917],{"type":49,"tag":1060,"props":11918,"children":11919},{"style":3039},[11920],{"type":55,"value":11921},"# > It will poll every 6 seconds until a successful state has been reached.\n",{"type":49,"tag":1060,"props":11923,"children":11925},{"class":1062,"line":11924},143,[11926],{"type":49,"tag":1060,"props":11927,"children":11928},{"style":3039},[11929],{"type":55,"value":11930},"# > This will exit with a return code of 255 after 100 failed checks.\n",{"type":49,"tag":1060,"props":11932,"children":11934},{"class":1062,"line":11933},144,[11935,11939,11943,11948,11953],{"type":49,"tag":1060,"props":11936,"children":11937},{"style":1067},[11938],{"type":55,"value":20},{"type":49,"tag":1060,"props":11940,"children":11941},{"style":2215},[11942],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11944,"children":11945},{"style":2215},[11946],{"type":55,"value":11947}," wait",{"type":49,"tag":1060,"props":11949,"children":11950},{"style":2215},[11951],{"type":55,"value":11952}," tasks-stopped",{"type":49,"tag":1060,"props":11954,"children":11955},{"style":2287},[11956],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11958,"children":11960},{"class":1062,"line":11959},145,[11961,11966,11971],{"type":49,"tag":1060,"props":11962,"children":11963},{"style":2287},[11964],{"type":55,"value":11965},"  --tasks",{"type":49,"tag":1060,"props":11967,"children":11968},{"style":1073},[11969],{"type":55,"value":11970}," $TASK_ID ",{"type":49,"tag":1060,"props":11972,"children":11973},{"style":2287},[11974],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11976,"children":11978},{"class":1062,"line":11977},146,[11979,11984,11988],{"type":49,"tag":1060,"props":11980,"children":11981},{"style":2287},[11982],{"type":55,"value":11983},"  --cluster",{"type":49,"tag":1060,"props":11985,"children":11986},{"style":1073},[11987],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11989,"children":11990},{"style":2215},[11991],{"type":55,"value":11992},"-cluster\n",{"type":49,"tag":1060,"props":11994,"children":11996},{"class":1062,"line":11995},147,[11997],{"type":49,"tag":1060,"props":11998,"children":11999},{"emptyLinePlaceholder":44},[12000],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12002,"children":12004},{"class":1062,"line":12003},148,[12005],{"type":49,"tag":1060,"props":12006,"children":12007},{"style":3039},[12008],{"type":55,"value":11657},{"type":49,"tag":1060,"props":12010,"children":12012},{"class":1062,"line":12011},149,[12013,12018,12022,12026,12030,12034],{"type":49,"tag":1060,"props":12014,"children":12015},{"style":1073},[12016],{"type":55,"value":12017},"END_TIME",{"type":49,"tag":1060,"props":12019,"children":12020},{"style":2194},[12021],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12023,"children":12024},{"style":1073},[12025],{"type":55,"value":10220},{"type":49,"tag":1060,"props":12027,"children":12028},{"style":1067},[12029],{"type":55,"value":11679},{"type":49,"tag":1060,"props":12031,"children":12032},{"style":2215},[12033],{"type":55,"value":11684},{"type":49,"tag":1060,"props":12035,"children":12036},{"style":1073},[12037],{"type":55,"value":5126},{"type":49,"tag":1060,"props":12039,"children":12041},{"class":1062,"line":12040},150,[12042],{"type":49,"tag":1060,"props":12043,"children":12044},{"emptyLinePlaceholder":44},[12045],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12047,"children":12049},{"class":1062,"line":12048},151,[12050],{"type":49,"tag":1060,"props":12051,"children":12052},{"style":3039},[12053],{"type":55,"value":12054},"# print the CloudWatch log events to STDOUT\n",{"type":49,"tag":1060,"props":12056,"children":12058},{"class":1062,"line":12057},152,[12059,12063,12068,12073],{"type":49,"tag":1060,"props":12060,"children":12061},{"style":1067},[12062],{"type":55,"value":20},{"type":49,"tag":1060,"props":12064,"children":12065},{"style":2215},[12066],{"type":55,"value":12067}," logs",{"type":49,"tag":1060,"props":12069,"children":12070},{"style":2215},[12071],{"type":55,"value":12072}," get-log-events",{"type":49,"tag":1060,"props":12074,"children":12075},{"style":2287},[12076],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12078,"children":12080},{"class":1062,"line":12079},153,[12081,12086,12091,12095,12100],{"type":49,"tag":1060,"props":12082,"children":12083},{"style":2287},[12084],{"type":55,"value":12085},"  --log-group-name",{"type":49,"tag":1060,"props":12087,"children":12088},{"style":2215},[12089],{"type":55,"value":12090}," \"/ecs/",{"type":49,"tag":1060,"props":12092,"children":12093},{"style":1073},[12094],{"type":55,"value":10175},{"type":49,"tag":1060,"props":12096,"children":12097},{"style":2215},[12098],{"type":55,"value":12099},"/migrate\"",{"type":49,"tag":1060,"props":12101,"children":12102},{"style":2287},[12103],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12105,"children":12107},{"class":1062,"line":12106},154,[12108,12113,12118,12122,12127,12132],{"type":49,"tag":1060,"props":12109,"children":12110},{"style":2287},[12111],{"type":55,"value":12112},"  --log-stream-name",{"type":49,"tag":1060,"props":12114,"children":12115},{"style":2215},[12116],{"type":55,"value":12117}," \"migrate/migrate/${",{"type":49,"tag":1060,"props":12119,"children":12120},{"style":1073},[12121],{"type":55,"value":11714},{"type":49,"tag":1060,"props":12123,"children":12124},{"style":2194},[12125],{"type":55,"value":12126},"##*/",{"type":49,"tag":1060,"props":12128,"children":12129},{"style":2215},[12130],{"type":55,"value":12131},"}\"",{"type":49,"tag":1060,"props":12133,"children":12134},{"style":2287},[12135],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12137,"children":12139},{"class":1062,"line":12138},155,[12140,12145,12150],{"type":49,"tag":1060,"props":12141,"children":12142},{"style":2287},[12143],{"type":55,"value":12144},"  --start-time",{"type":49,"tag":1060,"props":12146,"children":12147},{"style":1073},[12148],{"type":55,"value":12149}," $START_TIME ",{"type":49,"tag":1060,"props":12151,"children":12152},{"style":2287},[12153],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12155,"children":12157},{"class":1062,"line":12156},156,[12158,12163,12168],{"type":49,"tag":1060,"props":12159,"children":12160},{"style":2287},[12161],{"type":55,"value":12162},"  --end-time",{"type":49,"tag":1060,"props":12164,"children":12165},{"style":1073},[12166],{"type":55,"value":12167}," $END_TIME ",{"type":49,"tag":1060,"props":12169,"children":12170},{"style":2287},[12171],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12173,"children":12175},{"class":1062,"line":12174},157,[12176,12181,12185,12189],{"type":49,"tag":1060,"props":12177,"children":12178},{"style":2194},[12179],{"type":55,"value":12180},"  |",{"type":49,"tag":1060,"props":12182,"children":12183},{"style":1067},[12184],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12186,"children":12187},{"style":2287},[12188],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12190,"children":12191},{"style":2215},[12192],{"type":55,"value":12193}," '.events[].message'\n",{"type":49,"tag":1060,"props":12195,"children":12197},{"class":1062,"line":12196},158,[12198],{"type":49,"tag":1060,"props":12199,"children":12200},{"emptyLinePlaceholder":44},[12201],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12203,"children":12205},{"class":1062,"line":12204},159,[12206,12210],{"type":49,"tag":1060,"props":12207,"children":12208},{"style":9965},[12209],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12211,"children":12212},{"style":2215},[12213],{"type":55,"value":12214}," \"Migrations complete. Starting rolling update for backend services...\"\n",{"type":49,"tag":1060,"props":12216,"children":12218},{"class":1062,"line":12217},160,[12219],{"type":49,"tag":1060,"props":12220,"children":12221},{"emptyLinePlaceholder":44},[12222],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12224,"children":12226},{"class":1062,"line":12225},161,[12227],{"type":49,"tag":1060,"props":12228,"children":12229},{"style":3039},[12230],{"type":55,"value":12231},"# update backend services\n",{"type":49,"tag":1060,"props":12233,"children":12235},{"class":1062,"line":12234},162,[12236,12240,12244,12248,12252,12256],{"type":49,"tag":1060,"props":12237,"children":12238},{"style":2194},[12239],{"type":55,"value":10063},{"type":49,"tag":1060,"props":12241,"children":12242},{"style":1073},[12243],{"type":55,"value":10068},{"type":49,"tag":1060,"props":12245,"children":12246},{"style":2194},[12247],{"type":55,"value":10073},{"type":49,"tag":1060,"props":12249,"children":12250},{"style":2215},[12251],{"type":55,"value":10083},{"type":49,"tag":1060,"props":12253,"children":12254},{"style":2215},[12255],{"type":55,"value":10088},{"type":49,"tag":1060,"props":12257,"children":12258},{"style":2215},[12259],{"type":55,"value":10093},{"type":49,"tag":1060,"props":12261,"children":12263},{"class":1062,"line":12262},163,[12264],{"type":49,"tag":1060,"props":12265,"children":12266},{"style":2194},[12267],{"type":55,"value":10101},{"type":49,"tag":1060,"props":12269,"children":12271},{"class":1062,"line":12270},164,[12272],{"type":49,"tag":1060,"props":12273,"children":12274},{"emptyLinePlaceholder":44},[12275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12277,"children":12279},{"class":1062,"line":12278},165,[12280],{"type":49,"tag":1060,"props":12281,"children":12282},{"style":3039},[12283],{"type":55,"value":12284},"  # get taskDefinitionArn for each service to be used in update-service command\n",{"type":49,"tag":1060,"props":12286,"children":12288},{"class":1062,"line":12287},166,[12289],{"type":49,"tag":1060,"props":12290,"children":12291},{"style":3039},[12292],{"type":55,"value":12293},"  # this will get the most recent revision of each task (the one that was just created)\n",{"type":49,"tag":1060,"props":12295,"children":12297},{"class":1062,"line":12296},167,[12298],{"type":49,"tag":1060,"props":12299,"children":12300},{"style":3039},[12301],{"type":55,"value":12302},"  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":12304,"children":12306},{"class":1062,"line":12305},168,[12307,12312,12316,12320],{"type":49,"tag":1060,"props":12308,"children":12309},{"style":1073},[12310],{"type":55,"value":12311},"  TASK_DEFINITION",{"type":49,"tag":1060,"props":12313,"children":12314},{"style":2194},[12315],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12317,"children":12318},{"style":1073},[12319],{"type":55,"value":10584},{"type":49,"tag":1060,"props":12321,"children":12322},{"style":2287},[12323],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12325,"children":12327},{"class":1062,"line":12326},169,[12328,12333,12337,12341],{"type":49,"tag":1060,"props":12329,"children":12330},{"style":1067},[12331],{"type":55,"value":12332},"    aws",{"type":49,"tag":1060,"props":12334,"children":12335},{"style":2215},[12336],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12338,"children":12339},{"style":2215},[12340],{"type":55,"value":10234},{"type":49,"tag":1060,"props":12342,"children":12343},{"style":2287},[12344],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12346,"children":12348},{"class":1062,"line":12347},170,[12349,12354,12358,12362,12367],{"type":49,"tag":1060,"props":12350,"children":12351},{"style":2287},[12352],{"type":55,"value":12353},"      --task-definition",{"type":49,"tag":1060,"props":12355,"children":12356},{"style":1073},[12357],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12359,"children":12360},{"style":2215},[12361],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12363,"children":12364},{"style":1073},[12365],{"type":55,"value":12366},"$TASK ",{"type":49,"tag":1060,"props":12368,"children":12369},{"style":2287},[12370],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12372,"children":12374},{"class":1062,"line":12373},171,[12375,12380,12384,12388],{"type":49,"tag":1060,"props":12376,"children":12377},{"style":2194},[12378],{"type":55,"value":12379},"      |",{"type":49,"tag":1060,"props":12381,"children":12382},{"style":1067},[12383],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12385,"children":12386},{"style":2287},[12387],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12389,"children":12390},{"style":2287},[12391],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12393,"children":12395},{"class":1062,"line":12394},172,[12396,12401],{"type":49,"tag":1060,"props":12397,"children":12398},{"style":2215},[12399],{"type":55,"value":12400},"      .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":12402,"children":12403},{"style":2287},[12404],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12406,"children":12408},{"class":1062,"line":12407},173,[12409],{"type":49,"tag":1060,"props":12410,"children":12411},{"style":1073},[12412],{"type":55,"value":10267},{"type":49,"tag":1060,"props":12414,"children":12416},{"class":1062,"line":12415},174,[12417],{"type":49,"tag":1060,"props":12418,"children":12419},{"emptyLinePlaceholder":44},[12420],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12422,"children":12424},{"class":1062,"line":12423},175,[12425],{"type":49,"tag":1060,"props":12426,"children":12427},{"style":3039},[12428],{"type":55,"value":12429},"  # update each service with new task definintion\n",{"type":49,"tag":1060,"props":12431,"children":12433},{"class":1062,"line":12432},176,[12434,12438,12442,12447],{"type":49,"tag":1060,"props":12435,"children":12436},{"style":1067},[12437],{"type":55,"value":10940},{"type":49,"tag":1060,"props":12439,"children":12440},{"style":2215},[12441],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12443,"children":12444},{"style":2215},[12445],{"type":55,"value":12446}," update-service",{"type":49,"tag":1060,"props":12448,"children":12449},{"style":2287},[12450],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12452,"children":12454},{"class":1062,"line":12453},177,[12455,12459,12463,12467],{"type":49,"tag":1060,"props":12456,"children":12457},{"style":2287},[12458],{"type":55,"value":11756},{"type":49,"tag":1060,"props":12460,"children":12461},{"style":1073},[12462],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12464,"children":12465},{"style":2215},[12466],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12468,"children":12469},{"style":2287},[12470],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12472,"children":12474},{"class":1062,"line":12473},178,[12475,12480,12484,12488,12492],{"type":49,"tag":1060,"props":12476,"children":12477},{"style":2287},[12478],{"type":55,"value":12479},"    --service",{"type":49,"tag":1060,"props":12481,"children":12482},{"style":1073},[12483],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12485,"children":12486},{"style":2215},[12487],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12489,"children":12490},{"style":1073},[12491],{"type":55,"value":12366},{"type":49,"tag":1060,"props":12493,"children":12494},{"style":2287},[12495],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12497,"children":12499},{"class":1062,"line":12498},179,[12500,12504,12508],{"type":49,"tag":1060,"props":12501,"children":12502},{"style":2287},[12503],{"type":55,"value":10248},{"type":49,"tag":1060,"props":12505,"children":12506},{"style":1073},[12507],{"type":55,"value":11782},{"type":49,"tag":1060,"props":12509,"children":12510},{"style":2287},[12511],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12513,"children":12515},{"class":1062,"line":12514},180,[12516],{"type":49,"tag":1060,"props":12517,"children":12518},{"style":2287},[12519],{"type":55,"value":12520},"    --no-cli-pager\n",{"type":49,"tag":1060,"props":12522,"children":12524},{"class":1062,"line":12523},181,[12525],{"type":49,"tag":1060,"props":12526,"children":12527},{"emptyLinePlaceholder":44},[12528],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12530,"children":12532},{"class":1062,"line":12531},182,[12533],{"type":49,"tag":1060,"props":12534,"children":12535},{"style":2194},[12536],{"type":55,"value":11118},{"type":49,"tag":1060,"props":12538,"children":12540},{"class":1062,"line":12539},183,[12541],{"type":49,"tag":1060,"props":12542,"children":12543},{"emptyLinePlaceholder":44},[12544],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12546,"children":12548},{"class":1062,"line":12547},184,[12549,12553],{"type":49,"tag":1060,"props":12550,"children":12551},{"style":9965},[12552],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12554,"children":12555},{"style":2215},[12556],{"type":55,"value":12557}," \"Services updated. Waiting for services to become stable...\"\n",{"type":49,"tag":1060,"props":12559,"children":12561},{"class":1062,"line":12560},185,[12562],{"type":49,"tag":1060,"props":12563,"children":12564},{"emptyLinePlaceholder":44},[12565],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12567,"children":12569},{"class":1062,"line":12568},186,[12570],{"type":49,"tag":1060,"props":12571,"children":12572},{"style":3039},[12573],{"type":55,"value":12574},"# wait for all service to be stable (runningCount == desiredCount for each service)\n",{"type":49,"tag":1060,"props":12576,"children":12578},{"class":1062,"line":12577},187,[12579,12583,12587,12591,12596],{"type":49,"tag":1060,"props":12580,"children":12581},{"style":1067},[12582],{"type":55,"value":20},{"type":49,"tag":1060,"props":12584,"children":12585},{"style":2215},[12586],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12588,"children":12589},{"style":2215},[12590],{"type":55,"value":11947},{"type":49,"tag":1060,"props":12592,"children":12593},{"style":2215},[12594],{"type":55,"value":12595}," services-stable",{"type":49,"tag":1060,"props":12597,"children":12598},{"style":2287},[12599],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12601,"children":12603},{"class":1062,"line":12602},188,[12604,12608,12612,12616],{"type":49,"tag":1060,"props":12605,"children":12606},{"style":2287},[12607],{"type":55,"value":11983},{"type":49,"tag":1060,"props":12609,"children":12610},{"style":1073},[12611],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12613,"children":12614},{"style":2215},[12615],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12617,"children":12618},{"style":2287},[12619],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12621,"children":12623},{"class":1062,"line":12622},189,[12624,12629,12633,12638,12642,12647,12651],{"type":49,"tag":1060,"props":12625,"children":12626},{"style":2287},[12627],{"type":55,"value":12628},"  --services",{"type":49,"tag":1060,"props":12630,"children":12631},{"style":1073},[12632],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12634,"children":12635},{"style":2215},[12636],{"type":55,"value":12637},"-gunicorn",{"type":49,"tag":1060,"props":12639,"children":12640},{"style":1073},[12641],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12643,"children":12644},{"style":2215},[12645],{"type":55,"value":12646},"-default",{"type":49,"tag":1060,"props":12648,"children":12649},{"style":1073},[12650],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12652,"children":12653},{"style":2215},[12654],{"type":55,"value":12655},"-beat\n",{"type":49,"tag":1060,"props":12657,"children":12659},{"class":1062,"line":12658},190,[12660],{"type":49,"tag":1060,"props":12661,"children":12662},{"emptyLinePlaceholder":44},[12663],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12665,"children":12667},{"class":1062,"line":12666},191,[12668,12672,12677,12681],{"type":49,"tag":1060,"props":12669,"children":12670},{"style":9965},[12671],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12673,"children":12674},{"style":2215},[12675],{"type":55,"value":12676}," \"Services are now stable. Backend services are now up to date with ",{"type":49,"tag":1060,"props":12678,"children":12679},{"style":1073},[12680],{"type":55,"value":10020},{"type":49,"tag":1060,"props":12682,"children":12683},{"style":2215},[12684],{"type":55,"value":12685},".\"\n",{"type":49,"tag":1060,"props":12687,"children":12689},{"class":1062,"line":12688},192,[12690],{"type":49,"tag":1060,"props":12691,"children":12692},{"emptyLinePlaceholder":44},[12693],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12695,"children":12697},{"class":1062,"line":12696},193,[12698,12702],{"type":49,"tag":1060,"props":12699,"children":12700},{"style":9965},[12701],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12703,"children":12704},{"style":2215},[12705],{"type":55,"value":12706}," \"Backend update is now complete!\"\n",{"type":49,"tag":58,"props":12708,"children":12709},{},[12710,12712,12718,12720,12725],{"type":55,"value":12711},"With this GitHub Actions workflow, a developer can now easily change the version of backend code that is running in their ad hoc environments without needing to involve Terraform. Using the ",{"type":49,"tag":326,"props":12713,"children":12715},{"className":12714},[],[12716],{"type":55,"value":12717},"ad_hoc_backend_update.yml",{"type":55,"value":12719}," GitHub Actions workflow, a developer only needs to enter the name of the workspace and the version of the backend code they want to use. The workflow will then run the ",{"type":49,"tag":326,"props":12721,"children":12723},{"className":12722},[],[12724],{"type":55,"value":3323},{"type":55,"value":12726}," task and update the backend services.",{"type":49,"tag":430,"props":12728,"children":12730},{"id":12729},"using-ignore_changes-in-the-definitions",[12731,12733,12739],{"type":55,"value":12732},"Using ",{"type":49,"tag":326,"props":12734,"children":12736},{"className":12735},[],[12737],{"type":55,"value":12738},"ignore_changes",{"type":55,"value":12740}," in the definitions",{"type":49,"tag":58,"props":12742,"children":12743},{},[12744,12746,12751,12753,12759,12761,12767,12769,12781,12783,12788,12790,12795],{"type":55,"value":12745},"There is one more important point to make about Terraform before we conclude this discussion on updating backend code for existing ad hoc environments. Consider the scenario where a developer has launched an ad hoc environment with backend version ",{"type":49,"tag":326,"props":12747,"children":12749},{"className":12748},[],[12750],{"type":55,"value":9562},{"type":55,"value":12752},". They make a small change to the backend code and push version ",{"type":49,"tag":326,"props":12754,"children":12756},{"className":12755},[],[12757],{"type":55,"value":12758},"v1.0.1",{"type":55,"value":12760},". Next, the developer remembers that a backend environment variable needs to be changed. This can be done by updating their ",{"type":49,"tag":326,"props":12762,"children":12764},{"className":12763},[],[12765],{"type":55,"value":12766},"*.tfvars",{"type":55,"value":12768}," file. If they now re-run the ad hoc environment update pipeline ",{"type":49,"tag":72,"props":12770,"children":12771},{},[12772,12774,12779],{"type":55,"value":12773},"without also updating the backend version in their ",{"type":49,"tag":326,"props":12775,"children":12777},{"className":12776},[],[12778],{"type":55,"value":12766},{"type":55,"value":12780}," file",{"type":55,"value":12782},", then their code will be reverted from ",{"type":49,"tag":326,"props":12784,"children":12786},{"className":12785},[],[12787],{"type":55,"value":12758},{"type":55,"value":12789}," to ",{"type":49,"tag":326,"props":12791,"children":12793},{"className":12792},[],[12794],{"type":55,"value":9562},{"type":55,"value":12796},". We would need to coordinate version changes between updating the backend with the pipelines that use Terraform commands and the pipelines that use the AWS CLI commands.",{"type":49,"tag":58,"props":12798,"children":12799},{},[12800,12802,12808,12810,12820,12822,12828,12830,12835,12837,12842,12844,12849,12851,12856],{"type":55,"value":12801},"There is a setting on the ",{"type":49,"tag":326,"props":12803,"children":12805},{"className":12804},[],[12806],{"type":55,"value":12807},"aws_ecs_service",{"type":55,"value":12809}," resource in Terraform we can can use to prevent this from happening. This setting is called ",{"type":49,"tag":80,"props":12811,"children":12814},{"href":12812,"rel":12813},"https://www.terraform.io/language/meta-arguments/lifecycle",[84],[12815],{"type":49,"tag":326,"props":12816,"children":12818},{"className":12817},[],[12819],{"type":55,"value":12738},{"type":55,"value":12821}," and is defined under the resource's ",{"type":49,"tag":326,"props":12823,"children":12825},{"className":12824},[],[12826],{"type":55,"value":12827},"lifecycle",{"type":55,"value":12829}," configuration block. With this setting, when we update the ",{"type":49,"tag":326,"props":12831,"children":12833},{"className":12832},[],[12834],{"type":55,"value":12766},{"type":55,"value":12836}," file with our new environment variable value, we will create another recent task definition with the same ",{"type":49,"tag":326,"props":12838,"children":12840},{"className":12839},[],[12841],{"type":55,"value":9562},{"type":55,"value":12843}," image, but the ECS service will not update in response to this change (that's what the ",{"type":49,"tag":326,"props":12845,"children":12847},{"className":12846},[],[12848],{"type":55,"value":12738},{"type":55,"value":12850}," is for). Once we make the ",{"type":49,"tag":326,"props":12852,"children":12854},{"className":12853},[],[12855],{"type":55,"value":12766},{"type":55,"value":12857}," file update and redeploy using the Terraform pipeline, nothing on our ad hoc changes, but we did get a new task definitions defined in our AWS account for each backend service. When we go to make the backend update with the pipeline that uses AWS CLI commands, the most recent task revision is used to create the new task definition, so it will include the environment variable change that we added earlier.",{"type":49,"tag":430,"props":12859,"children":12861},{"id":12860},"frontend-updates",[12862],{"type":55,"value":12863},"Frontend updates",{"type":49,"tag":58,"props":12865,"children":12866},{},[12867,12869,12874],{"type":55,"value":12868},"The process described above is needed for updating the backend application. Updating the frontend application involves a similar process to the backend update. The main difference is that no task (such as the ",{"type":49,"tag":326,"props":12870,"children":12872},{"className":12871},[],[12873],{"type":55,"value":3323},{"type":55,"value":12875}," command on the backend) needs to run before the service is updated. Here's an overview of the frontend update process:",{"type":49,"tag":64,"props":12877,"children":12878},{},[12879,12890,12901,12912,12923],{"type":49,"tag":68,"props":12880,"children":12881},{},[12882,12884,12889],{"type":55,"value":12883},"fetch the container definition JSON for the frontend tasks (",{"type":49,"tag":326,"props":12885,"children":12887},{"className":12886},[],[12888],{"type":55,"value":9743},{"type":55,"value":616},{"type":49,"tag":68,"props":12891,"children":12892},{},[12893,12895,12900],{"type":55,"value":12894},"write new container definition JSON with the new frontend image tag (using ",{"type":49,"tag":326,"props":12896,"children":12898},{"className":12897},[],[12899],{"type":55,"value":9755},{"type":55,"value":616},{"type":49,"tag":68,"props":12902,"children":12903},{},[12904,12906,12911],{"type":55,"value":12905},"register new task definitions with the new container definition JSON file for the frontend task (",{"type":49,"tag":326,"props":12907,"children":12909},{"className":12908},[],[12910],{"type":55,"value":9767},{"type":55,"value":616},{"type":49,"tag":68,"props":12913,"children":12914},{},[12915,12917,12922],{"type":55,"value":12916},"update the frontend service (",{"type":49,"tag":326,"props":12918,"children":12920},{"className":12919},[],[12921],{"type":55,"value":9802},{"type":55,"value":616},{"type":49,"tag":68,"props":12924,"children":12925},{},[12926,12927,12932],{"type":55,"value":9808},{"type":49,"tag":326,"props":12928,"children":12930},{"className":12929},[],[12931],{"type":55,"value":9814},{"type":55,"value":616},{"type":49,"tag":50,"props":12934,"children":12936},{"id":12935},"setting-up-everything-from-a-new-aws-account-and-github-actions",[12937],{"type":55,"value":12938},"Setting up everything from a new AWS account and GitHub Actions",{"type":49,"tag":58,"props":12940,"children":12941},{},[12942],{"type":55,"value":12943},"Here's a quick overview of initial setup steps that are needed in order to use the automation defined in the GitHub Actions for ad hoc environments.",{"type":49,"tag":430,"props":12945,"children":12947},{"id":12946},"configure-aws-credentials-locally",[12948],{"type":55,"value":12949},"Configure AWS credentials locally",{"type":49,"tag":58,"props":12951,"children":12952},{},[12953],{"type":55,"value":12954},"There is one Terraform command that we will run on our local machine to setup a remote backend for storing our Terraform state. In order to run this, we need to configure AWS credentials locally.",{"type":49,"tag":430,"props":12956,"children":12958},{"id":12957},"run-the-make-tf-bootstrap-command",[12959,12961,12967],{"type":55,"value":12960},"Run the ",{"type":49,"tag":326,"props":12962,"children":12964},{"className":12963},[],[12965],{"type":55,"value":12966},"make tf-bootstrap",{"type":55,"value":12968}," command",{"type":49,"tag":58,"props":12970,"children":12971},{},[12972,12974,12980],{"type":55,"value":12973},"This command will setup an S3 bucket and DynamoDB table for storing Terraform state. Running this command will also require that a ",{"type":49,"tag":326,"props":12975,"children":12977},{"className":12976},[],[12978],{"type":55,"value":12979},"bootstrap.tfvars",{"type":55,"value":12981}," file has been created from the template. This will define the AWS region and name to be used for creating resources.",{"type":49,"tag":430,"props":12983,"children":12985},{"id":12984},"build-and-push-a-backend-and-frontend-image",[12986],{"type":55,"value":12987},"Build and push a backend and frontend image",{"type":49,"tag":58,"props":12989,"children":12990},{},[12991,12992,12998,13000,13006,13007,13013],{"type":55,"value":413},{"type":49,"tag":326,"props":12993,"children":12995},{"className":12994},[],[12996],{"type":55,"value":12997},"tf-bootstrap",{"type":55,"value":12999}," command also creates ECR repositories for the backend and frontend images. We can use the ",{"type":49,"tag":326,"props":13001,"children":13003},{"className":13002},[],[13004],{"type":55,"value":13005},"ecr_backend.yml",{"type":55,"value":715},{"type":49,"tag":326,"props":13008,"children":13010},{"className":13009},[],[13011],{"type":55,"value":13012},"ecr_frontend.yml",{"type":55,"value":13014}," GitHub Actions workflows to build and push the backend and frontend images to the ECR repositories. These pipelines accept a single parameter which is a git tag that must exist in the repo. This git tag will then be used as the image tag for the backend and frontend images.",{"type":49,"tag":430,"props":13016,"children":13018},{"id":13017},"purchase-a-domain-name-in-route-53",[13019],{"type":55,"value":13020},"Purchase a domain name in Route 53",{"type":49,"tag":58,"props":13022,"children":13023},{},[13024],{"type":55,"value":13025},"I use Route 53 to manage DNS records, and have purchased a domain name that I use for testing and debugging in this and other projects.",{"type":49,"tag":430,"props":13027,"children":13029},{"id":13028},"create-a-wildcard-acm-certificate",[13030],{"type":55,"value":13031},"Create a wildcard ACM certificate",{"type":49,"tag":58,"props":13033,"children":13034},{},[13035],{"type":55,"value":13036},"I chose to create this certificate outside of Terraform and import it via ARN. We need a wildcard certificate so that multiple ad hoc environments can be hosted on subdomains of the same domain.",{"type":49,"tag":430,"props":13038,"children":13040},{"id":13039},"create-a-new-ec2-key-pair",[13041],{"type":55,"value":13042},"Create a new EC2 key pair",{"type":49,"tag":58,"props":13044,"children":13045},{},[13046],{"type":55,"value":13047},"The key pair should be created manually and it needs to be added to GitHub repository secrets so that it can be used in the ad hoc environment pipelines.",{"type":49,"tag":430,"props":13049,"children":13051},{"id":13050},"add-secrets-to-github",[13052],{"type":55,"value":13053},"Add secrets to GitHub",{"type":49,"tag":58,"props":13055,"children":13056},{},[13057],{"type":55,"value":13058},"The following secrets are needed for GitHub Actions to run. Add these as repository secrets:",{"type":49,"tag":64,"props":13060,"children":13061},{},[13062,13073,13084,13095,13113,13124,13135,13146,13157,13168,13179],{"type":49,"tag":68,"props":13063,"children":13064},{},[13065,13071],{"type":49,"tag":326,"props":13066,"children":13068},{"className":13067},[],[13069],{"type":55,"value":13070},"ACM_CERTIFICATE_ARN",{"type":55,"value":13072}," - ARN of the wildcard ACM certificate",{"type":49,"tag":68,"props":13074,"children":13075},{},[13076,13082],{"type":49,"tag":326,"props":13077,"children":13079},{"className":13078},[],[13080],{"type":55,"value":13081},"AWS_ACCESS_KEY_ID",{"type":55,"value":13083}," - AWS access key ID",{"type":49,"tag":68,"props":13085,"children":13086},{},[13087,13093],{"type":49,"tag":326,"props":13088,"children":13090},{"className":13089},[],[13091],{"type":55,"value":13092},"AWS_ACCOUNT_ID",{"type":55,"value":13094}," - AWS account ID",{"type":49,"tag":68,"props":13096,"children":13097},{},[13098,13104,13106,13112],{"type":49,"tag":326,"props":13099,"children":13101},{"className":13100},[],[13102],{"type":55,"value":13103},"AWS_DEFAULT_REGION",{"type":55,"value":13105}," - AWS default region (I use ",{"type":49,"tag":326,"props":13107,"children":13109},{"className":13108},[],[13110],{"type":55,"value":13111},"us-east-1",{"type":55,"value":616},{"type":49,"tag":68,"props":13114,"children":13115},{},[13116,13122],{"type":49,"tag":326,"props":13117,"children":13119},{"className":13118},[],[13120],{"type":55,"value":13121},"AWS_SECRET_ACCESS_KEY",{"type":55,"value":13123}," - AWS secret access key",{"type":49,"tag":68,"props":13125,"children":13126},{},[13127,13133],{"type":49,"tag":326,"props":13128,"children":13130},{"className":13129},[],[13131],{"type":55,"value":13132},"DOMAIN_NAME",{"type":55,"value":13134}," - domain name for the ad hoc environment (e.g. example.com)",{"type":49,"tag":68,"props":13136,"children":13137},{},[13138,13144],{"type":49,"tag":326,"props":13139,"children":13141},{"className":13140},[],[13142],{"type":55,"value":13143},"KEY_NAME",{"type":55,"value":13145}," - name of the EC2 key pair",{"type":49,"tag":68,"props":13147,"children":13148},{},[13149,13155],{"type":49,"tag":326,"props":13150,"children":13152},{"className":13151},[],[13153],{"type":55,"value":13154},"SSH_PRIVATE_KEY",{"type":55,"value":13156}," - private key for the EC2 key pair",{"type":49,"tag":68,"props":13158,"children":13159},{},[13160,13166],{"type":49,"tag":326,"props":13161,"children":13163},{"className":13162},[],[13164],{"type":55,"value":13165},"TF_BACKEND_BUCKET",{"type":55,"value":13167}," - name of the S3 bucket used for storing Terraform state",{"type":49,"tag":68,"props":13169,"children":13170},{},[13171,13177],{"type":49,"tag":326,"props":13172,"children":13174},{"className":13173},[],[13175],{"type":55,"value":13176},"TF_BACKEND_DYNAMODB_TABLE",{"type":55,"value":13178}," - name of the DynamoDB table used for locking the Terraform state file",{"type":49,"tag":68,"props":13180,"children":13181},{},[13182,13188],{"type":49,"tag":326,"props":13183,"children":13185},{"className":13184},[],[13186],{"type":55,"value":13187},"TF_BACKEND_REGION",{"type":55,"value":13189}," - AWS region for the S3 bucket and DynamoDB table",{"type":49,"tag":58,"props":13191,"children":13192},{},[13193],{"type":55,"value":13194},"These secrets are referenced in the GitHub Actions workflows.",{"type":49,"tag":430,"props":13196,"children":13198},{"id":13197},"create-shared-resources",[13199],{"type":55,"value":13200},"Create shared resources",{"type":49,"tag":58,"props":13202,"children":13203},{},[13204,13206,13212,13214,13219,13221,13227,13229,13235],{"type":55,"value":13205},"Now that we have GitHub secrets configured, we can run the ",{"type":49,"tag":326,"props":13207,"children":13209},{"className":13208},[],[13210],{"type":55,"value":13211},"shared_resources_create_update.yml",{"type":55,"value":13213}," GitHub Actions workflow. This will create  shared resources environment in which we can build our ad hoc environments. This workflow requires a name (e.g. ",{"type":49,"tag":326,"props":13215,"children":13217},{"className":13216},[],[13218],{"type":55,"value":34},{"type":55,"value":13220},"). This require that we create a ",{"type":49,"tag":326,"props":13222,"children":13224},{"className":13223},[],[13225],{"type":55,"value":13226},"dev.tfvars",{"type":55,"value":13228}," file in ",{"type":49,"tag":326,"props":13230,"children":13232},{"className":13231},[],[13233],{"type":55,"value":13234},"terraform/live/shared-resources",{"type":55,"value":13236}," directory. This usually takes between 5 and 7 minutes to complete since it needs to create an RDS instance which takes a few minutes to provision.",{"type":49,"tag":430,"props":13238,"children":13240},{"id":13239},"create-an-ad-hoc-environment",[13241],{"type":55,"value":13242},"Create an ad hoc environment",{"type":49,"tag":58,"props":13244,"children":13245},{},[13246,13248,13253,13255,13261,13263,13268,13270,13276,13278,13284],{"type":55,"value":13247},"We can now create an ad hoc environment. This requires the name of the shared resources environment (e.g. ",{"type":49,"tag":326,"props":13249,"children":13251},{"className":13250},[],[13252],{"type":55,"value":34},{"type":55,"value":13254},") and the name of the ad hoc environment (e.g. ",{"type":49,"tag":326,"props":13256,"children":13258},{"className":13257},[],[13259],{"type":55,"value":13260},"brian-test",{"type":55,"value":13262},"). The only thing we need to do before creating the ",{"type":49,"tag":326,"props":13264,"children":13266},{"className":13265},[],[13267],{"type":55,"value":13260},{"type":55,"value":13269}," ad hoc environment is to create the ",{"type":49,"tag":326,"props":13271,"children":13273},{"className":13272},[],[13274],{"type":55,"value":13275},"brian-test.tfvars",{"type":55,"value":13277}," file in the ",{"type":49,"tag":326,"props":13279,"children":13281},{"className":13280},[],[13282],{"type":55,"value":13283},"terraform/live/ad-hoc/envs",{"type":55,"value":13285}," directory. This will define the versions of the application and any other environment configuration that is needed. This pipeline usually takes about 3 minutes to finish.",{"type":49,"tag":430,"props":13287,"children":13289},{"id":13288},"update-the-backend-version-in-an-ad-hoc-environment",[13290],{"type":55,"value":13291},"Update the backend version in an ad hoc environment",{"type":49,"tag":58,"props":13293,"children":13294},{},[13295,13297,13302],{"type":55,"value":13296},"Now that the backend is up and running and usable, we can update the backend version used in our ad hoc environment. This can be done by running the ",{"type":49,"tag":326,"props":13298,"children":13300},{"className":13299},[],[13301],{"type":55,"value":12717},{"type":55,"value":13303}," GitHub Actions workflow. To run this workflow you must specify:",{"type":49,"tag":64,"props":13305,"children":13306},{},[13307,13318,13329],{"type":49,"tag":68,"props":13308,"children":13309},{},[13310,13312,13317],{"type":55,"value":13311},"the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13313,"children":13315},{"className":13314},[],[13316],{"type":55,"value":34},{"type":55,"value":616},{"type":49,"tag":68,"props":13319,"children":13320},{},[13321,13323,13328],{"type":55,"value":13322},"the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13324,"children":13326},{"className":13325},[],[13327],{"type":55,"value":13260},{"type":55,"value":616},{"type":49,"tag":68,"props":13330,"children":13331},{},[13332,13334,13340],{"type":55,"value":13333},"the new version of the backend to be used (e.g. ",{"type":49,"tag":326,"props":13335,"children":13337},{"className":13336},[],[13338],{"type":55,"value":13339},"v1.0.2",{"type":55,"value":616},{"type":49,"tag":58,"props":13342,"children":13343},{},[13344,13346,13351],{"type":55,"value":13345},"The backend version should already have been built and pushed to the ECR repository using the ",{"type":49,"tag":326,"props":13347,"children":13349},{"className":13348},[],[13350],{"type":55,"value":13005},{"type":55,"value":13352}," GitHub Actions workflow.",{"type":49,"tag":430,"props":13354,"children":13356},{"id":13355},"use-ecs-exec-to-access-a-django-shell-in-a-running-container",[13357],{"type":55,"value":13358},"Use ECS Exec to access a Django shell in a running container",{"type":49,"tag":58,"props":13360,"children":13361},{},[13362,13364,13370,13372,13377],{"type":55,"value":13363},"Instead of SSHing into the container, we can use the ",{"type":49,"tag":326,"props":13365,"children":13367},{"className":13366},[],[13368],{"type":55,"value":13369},"ecs-exec",{"type":55,"value":13371}," command to access a shell in the container. This is useful for debugging and testing. One of the outputs of the ad hoc environment terraform configuration contains the script needed to run the ",{"type":49,"tag":326,"props":13373,"children":13375},{"className":13374},[],[13376],{"type":55,"value":13369},{"type":55,"value":13378}," command:",{"type":49,"tag":1050,"props":13380,"children":13382},{"code":13381,"language":2728,"meta":8,"className":2729,"style":8},"TASK_ARN=$(aws ecs list-tasks \\\n  --cluster alpha-cluster \\\n  --service-name  alpha-gunicorn | jq -r '.taskArns | .[0]' \\\n)\naws ecs execute-command --cluster alpha-cluster \\\n    --task $TASK_ARN \\\n    --container gunicorn \\\n    --interactive \\\n    --command \"/bin/bash\"\n",[13383],{"type":49,"tag":326,"props":13384,"children":13385},{"__ignoreMap":8},[13386,13419,13435,13470,13477,13506,13523,13540,13552],{"type":49,"tag":1060,"props":13387,"children":13388},{"class":1062,"line":1063},[13389,13394,13398,13402,13406,13410,13415],{"type":49,"tag":1060,"props":13390,"children":13391},{"style":1073},[13392],{"type":55,"value":13393},"TASK_ARN",{"type":49,"tag":1060,"props":13395,"children":13396},{"style":2194},[13397],{"type":55,"value":3068},{"type":49,"tag":1060,"props":13399,"children":13400},{"style":1073},[13401],{"type":55,"value":10220},{"type":49,"tag":1060,"props":13403,"children":13404},{"style":1067},[13405],{"type":55,"value":20},{"type":49,"tag":1060,"props":13407,"children":13408},{"style":2215},[13409],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13411,"children":13412},{"style":2215},[13413],{"type":55,"value":13414}," list-tasks",{"type":49,"tag":1060,"props":13416,"children":13417},{"style":2287},[13418],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13420,"children":13421},{"class":1062,"line":1079},[13422,13426,13431],{"type":49,"tag":1060,"props":13423,"children":13424},{"style":2287},[13425],{"type":55,"value":11983},{"type":49,"tag":1060,"props":13427,"children":13428},{"style":2215},[13429],{"type":55,"value":13430}," alpha-cluster",{"type":49,"tag":1060,"props":13432,"children":13433},{"style":2287},[13434],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13436,"children":13437},{"class":1062,"line":1088},[13438,13443,13448,13453,13457,13461,13466],{"type":49,"tag":1060,"props":13439,"children":13440},{"style":2287},[13441],{"type":55,"value":13442},"  --service-name",{"type":49,"tag":1060,"props":13444,"children":13445},{"style":2215},[13446],{"type":55,"value":13447},"  alpha-gunicorn",{"type":49,"tag":1060,"props":13449,"children":13450},{"style":2194},[13451],{"type":55,"value":13452}," |",{"type":49,"tag":1060,"props":13454,"children":13455},{"style":1067},[13456],{"type":55,"value":10307},{"type":49,"tag":1060,"props":13458,"children":13459},{"style":2287},[13460],{"type":55,"value":10312},{"type":49,"tag":1060,"props":13462,"children":13463},{"style":2215},[13464],{"type":55,"value":13465}," '.taskArns | .[0]'",{"type":49,"tag":1060,"props":13467,"children":13468},{"style":2287},[13469],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13471,"children":13472},{"class":1062,"line":1097},[13473],{"type":49,"tag":1060,"props":13474,"children":13475},{"style":1073},[13476],{"type":55,"value":5126},{"type":49,"tag":1060,"props":13478,"children":13479},{"class":1062,"line":1111},[13480,13484,13488,13493,13498,13502],{"type":49,"tag":1060,"props":13481,"children":13482},{"style":1067},[13483],{"type":55,"value":20},{"type":49,"tag":1060,"props":13485,"children":13486},{"style":2215},[13487],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13489,"children":13490},{"style":2215},[13491],{"type":55,"value":13492}," execute-command",{"type":49,"tag":1060,"props":13494,"children":13495},{"style":2287},[13496],{"type":55,"value":13497}," --cluster",{"type":49,"tag":1060,"props":13499,"children":13500},{"style":2215},[13501],{"type":55,"value":13430},{"type":49,"tag":1060,"props":13503,"children":13504},{"style":2287},[13505],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13507,"children":13508},{"class":1062,"line":1120},[13509,13514,13519],{"type":49,"tag":1060,"props":13510,"children":13511},{"style":2287},[13512],{"type":55,"value":13513},"    --task",{"type":49,"tag":1060,"props":13515,"children":13516},{"style":1073},[13517],{"type":55,"value":13518}," $TASK_ARN ",{"type":49,"tag":1060,"props":13520,"children":13521},{"style":2287},[13522],{"type":55,"value":10258},{"type":49,"tag":1060,"props":13524,"children":13525},{"class":1062,"line":1128},[13526,13531,13536],{"type":49,"tag":1060,"props":13527,"children":13528},{"style":2287},[13529],{"type":55,"value":13530},"    --container",{"type":49,"tag":1060,"props":13532,"children":13533},{"style":2215},[13534],{"type":55,"value":13535}," gunicorn",{"type":49,"tag":1060,"props":13537,"children":13538},{"style":2287},[13539],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13541,"children":13542},{"class":1062,"line":1141},[13543,13548],{"type":49,"tag":1060,"props":13544,"children":13545},{"style":2287},[13546],{"type":55,"value":13547},"    --interactive",{"type":49,"tag":1060,"props":13549,"children":13550},{"style":2287},[13551],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13553,"children":13554},{"class":1062,"line":1150},[13555,13560],{"type":49,"tag":1060,"props":13556,"children":13557},{"style":2287},[13558],{"type":55,"value":13559},"    --command",{"type":49,"tag":1060,"props":13561,"children":13562},{"style":2215},[13563],{"type":55,"value":13564}," \"/bin/bash\"\n",{"type":49,"tag":58,"props":13566,"children":13567},{},[13568],{"type":55,"value":13569},"You will then have a shell in the container:",{"type":49,"tag":1050,"props":13571,"children":13573},{"code":13572},"The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.\n\n\nStarting session with SessionId: ecs-execute-command-073d1947fa71c058c\nroot@ip-10-0-2-167:/code# python manage.py shell\nPython 3.9.9 (main, Dec 21 2021, 10:03:34)\n[GCC 10.2.1 20210110] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>>\n",[13574],{"type":49,"tag":326,"props":13575,"children":13576},{"__ignoreMap":8},[13577],{"type":55,"value":13572},{"type":49,"tag":430,"props":13579,"children":13581},{"id":13580},"destroy-an-ad-hoc-environment",[13582],{"type":55,"value":13583},"Destroy an ad hoc environment",{"type":49,"tag":58,"props":13585,"children":13586},{},[13587,13589,13595,13597,13602,13604,13609],{"type":55,"value":13588},"Use the ",{"type":49,"tag":326,"props":13590,"children":13592},{"className":13591},[],[13593],{"type":55,"value":13594},"ad_hoc_env_destroy.yml",{"type":55,"value":13596}," GitHub Actions workflow to destroy an ad hoc environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13598,"children":13600},{"className":13599},[],[13601],{"type":55,"value":34},{"type":55,"value":13603},") and the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13605,"children":13607},{"className":13606},[],[13608],{"type":55,"value":13260},{"type":55,"value":3213},{"type":49,"tag":430,"props":13611,"children":13613},{"id":13612},"destroy-the-shared-resources-environment",[13614],{"type":55,"value":13615},"Destroy the shared resources environment",{"type":49,"tag":58,"props":13617,"children":13618},{},[13619,13620,13626,13628,13633],{"type":55,"value":13588},{"type":49,"tag":326,"props":13621,"children":13623},{"className":13622},[],[13624],{"type":55,"value":13625},"shared_resources_destroy.yml",{"type":55,"value":13627}," GitHub Actions workflow to destroy the shared resources environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13629,"children":13631},{"className":13630},[],[13632],{"type":55,"value":34},{"type":55,"value":3213},{"type":49,"tag":58,"props":13635,"children":13636},{},[13637],{"type":55,"value":13638},"This defines the full lifecycle of creating and destroying ad hoc environments.",{"type":49,"tag":50,"props":13640,"children":13642},{"id":13641},"future-improvements-open-questions-and-next-steps",[13643],{"type":55,"value":13644},"Future improvements, open questions and next steps",{"type":49,"tag":430,"props":13646,"children":13648},{"id":13647},"enhanced-security",[13649],{"type":55,"value":13650},"Enhanced Security",{"type":49,"tag":58,"props":13652,"children":13653},{},[13654],{"type":55,"value":13655},"The low hanging fruit here is to use least privilege (for roles used in automation) and to define all roles with IaC. Currently I am using Admin roles for the credentials I store in GitHub which is a shortcut to using IaC and is not a best practice.",{"type":49,"tag":430,"props":13657,"children":13659},{"id":13658},"keeping-track-of-ad-hoc-environments",[13660],{"type":55,"value":13661},"Keeping track of ad hoc environments",{"type":49,"tag":58,"props":13663,"children":13664},{},[13665],{"type":55,"value":13666},"We need to think about how we can keep track of our active ad hoc environments. Active environments will incur additional AWS costs, and we do not want developers or the product team to create lots of environments and then leave them running without actively using them.",{"type":49,"tag":58,"props":13668,"children":13669},{},[13670],{"type":55,"value":13671},"We may decide to have some long-lived ad hoc environments, but those would be managed primarily by the DevOps team and respective owners (e.g. QA, product team, etc.).",{"type":49,"tag":58,"props":13673,"children":13674},{},[13675],{"type":55,"value":13676},"One way to check the active ad hoc environments would be to use the AWS CLI. We could list the ECS clusters in our development account, and this would show the number of ad hoc environments running. We could go farther and list the ad hoc environments by when they were last updated. We could then request developers or team members to remove ad hoc environments that are not in use.",{"type":49,"tag":58,"props":13678,"children":13679},{},[13680],{"type":55,"value":13681},"Or we could have a policy that all ad-hoc environments are deleted automatically at the end of each week.",{"type":49,"tag":430,"props":13683,"children":13685},{"id":13684},"terraform-tooling",[13686],{"type":55,"value":13687},"Terraform Tooling",{"type":49,"tag":64,"props":13689,"children":13690},{},[13691,13696,13701,13706],{"type":49,"tag":68,"props":13692,"children":13693},{},[13694],{"type":55,"value":13695},"Testing Terraform Code",{"type":49,"tag":68,"props":13697,"children":13698},{},[13699],{"type":55,"value":13700},"Testing GitHub Actions",{"type":49,"tag":68,"props":13702,"children":13703},{},[13704],{"type":55,"value":13705},"Using advanced Terraform frameworks like Terragrunt",{"type":49,"tag":68,"props":13707,"children":13708},{},[13709],{"type":55,"value":13710},"Using Terraform Cloud for more advanced Terraform features",{"type":49,"tag":430,"props":13712,"children":13714},{"id":13713},"more-secure-way-of-defining-rds-username-and-password",[13715],{"type":55,"value":13716},"More secure way of defining RDS username and password",{"type":49,"tag":58,"props":13718,"children":13719},{},[13720],{"type":55,"value":13721},"Currently the postgres database does not have a secure password. It is both hardcoded in the module as a default value and it will also be saved in plaintext in the Terraform state file.",{"type":49,"tag":430,"props":13723,"children":13725},{"id":13724},"backend-application-update-script",[13726],{"type":55,"value":13727},"Backend application update script",{"type":49,"tag":58,"props":13729,"children":13730},{},[13731],{"type":55,"value":13732},"The script used for updating the backend application could be improved or broken up into multiple scripts to better handle errors and failures that happen during the pipeline. The script runs several different commands and could potentially fail at any step, so it would be nice to improve the error messages so that both developers and DevOps teams can more quickly diagnose pipeline failures.",{"type":49,"tag":430,"props":13734,"children":13736},{"id":13735},"limiting-traffic-to-ad-hoc-environments-to-a-vpn",[13737],{"type":55,"value":13738},"Limiting traffic to ad hoc environments to a VPN",{"type":49,"tag":58,"props":13740,"children":13741},{},[13742],{"type":55,"value":13743},"Another good next step would be to show how we can limit traffic to ad hoc environments to a VPN.",{"type":49,"tag":430,"props":13745,"children":13747},{"id":13746},"figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas",[13748],{"type":55,"value":13749},"Figure out how many ad hoc environments we can create with the default quotas",{"type":49,"tag":58,"props":13751,"children":13752},{},[13753],{"type":55,"value":13754},"AWS accounts limit the number of resources you can create, but for most of this quota limits you can request an increase per account. I need to figure out how many ad hoc environments I can create with the default quotas.",{"type":49,"tag":430,"props":13756,"children":13758},{"id":13757},"code-repo-organization",[13759],{"type":55,"value":13760},"Code Repo Organization",{"type":49,"tag":58,"props":13762,"children":13763},{},[13764,13766,13771,13773,13778],{"type":55,"value":13765},"One minor improvement would be to move the ",{"type":49,"tag":326,"props":13767,"children":13769},{"className":13768},[],[13770],{"type":55,"value":16},{"type":55,"value":13772}," directory out of the ",{"type":49,"tag":326,"props":13774,"children":13776},{"className":13775},[],[13777],{"type":55,"value":1627},{"type":55,"value":13779}," monorepo into a dedicated repo. We may also want to move GitHub Actions for creating, updating and destroying environments to this new repo. For early stage development, using a single repository that stores both application code and Terraform configuration works, but it would be better to keep these separate at the repository level as the project grows.",{"type":49,"tag":430,"props":13781,"children":13783},{"id":13782},"multiple-aws-accounts",[13784],{"type":55,"value":13785},"Multiple AWS Accounts",{"type":49,"tag":58,"props":13787,"children":13788},{},[13789],{"type":55,"value":13790},"Everything shown here uses a single AWS account: ECR images, Terraform remote state storage, all shared resource environments and all ad hoc environments. Using one account keeps things simple for a demonstration of this workflow, but in practice it would be beneficial to use multiple AWS accounts for different purposes. This would also involve more carefully planned IAM roles for cross-account resource access.",{"type":49,"tag":430,"props":13792,"children":13794},{"id":13793},"modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments",[13795],{"type":55,"value":13796},"Modules for stable environments to be used for long-lived pre-production and production environments",{"type":49,"tag":58,"props":13798,"children":13799},{},[13800],{"type":55,"value":13801},"This article looked at how to make tradeoffs between costs, speed of deployment and production parity in ad hoc environments. I'm interested in building a new set of modules that can be used to set up environments that:",{"type":49,"tag":64,"props":13803,"children":13804},{},[13805,13810,13815,13820,13825],{"type":49,"tag":68,"props":13806,"children":13807},{},[13808],{"type":55,"value":13809},"are more stable and more long-lived",{"type":49,"tag":68,"props":13811,"children":13812},{},[13813],{"type":55,"value":13814},"have less resource sharing (dedicated RDS and ElastiCache resources)",{"type":49,"tag":68,"props":13816,"children":13817},{},[13818],{"type":55,"value":13819},"implement autoscaling for load-testing (or maybe implement autoscaling for ad hoc environments)",{"type":49,"tag":68,"props":13821,"children":13822},{},[13823],{"type":55,"value":13824},"can be used to perform load testing",{"type":49,"tag":68,"props":13826,"children":13827},{},[13828],{"type":55,"value":13829},"have enhanced observability tooling",{"type":49,"tag":58,"props":13831,"children":13832},{},[13833],{"type":55,"value":13834},"These environments might be used as part of a QA process that does a final sign-off on a new set of features scheduled for deployment to production environments, for example.",{"type":49,"tag":50,"props":13836,"children":13837},{"id":7730},[13838],{"type":55,"value":7733},{"type":49,"tag":58,"props":13840,"children":13841},{},[13842],{"type":55,"value":13843},"This wraps up the tour of my ad hoc environment infrastructure automation. Thank you for having a read through my article. If you have a similar (or different) approach to building ad hoc environments, I would love to hear about it.",{"type":49,"tag":7749,"props":13845,"children":13846},{},[13847],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":13849},[13850,13851,13852,13853,13854,13861,13862,13866,13875,13879,13883,13890,13906,13918],{"id":52,"depth":1079,"text":56},{"id":7862,"depth":1079,"text":7865},{"id":7987,"depth":1079,"text":7990},{"id":8099,"depth":1079,"text":8102},{"id":8110,"depth":1079,"text":8113,"children":13855},[13856,13857,13858,13859,13860],{"id":8159,"depth":1088,"text":8162},{"id":8347,"depth":1088,"text":8350},{"id":8427,"depth":1088,"text":8430},{"id":8499,"depth":1088,"text":8502},{"id":8580,"depth":1088,"text":8583},{"id":8678,"depth":1079,"text":8681},{"id":8900,"depth":1079,"text":8903,"children":13863},[13864,13865],{"id":8930,"depth":1088,"text":8933},{"id":8989,"depth":1088,"text":8992},{"id":9068,"depth":1079,"text":9071,"children":13867},[13868,13869,13870,13871,13872,13873,13874],{"id":2091,"depth":1088,"text":2094},{"id":9104,"depth":1088,"text":9107},{"id":2160,"depth":1088,"text":2017},{"id":9183,"depth":1088,"text":9186},{"id":9194,"depth":1088,"text":9197},{"id":9205,"depth":1088,"text":2022},{"id":2683,"depth":1088,"text":2032},{"id":9245,"depth":1079,"text":9248,"children":13876},[13877,13878],{"id":2877,"depth":1088,"text":2880},{"id":9265,"depth":1088,"text":9268},{"id":9330,"depth":1079,"text":9333,"children":13880},[13881,13882],{"id":9341,"depth":1088,"text":9344},{"id":9464,"depth":1088,"text":9467},{"id":9541,"depth":1079,"text":9544,"children":13884},[13885,13886,13887,13889],{"id":9671,"depth":1088,"text":9674},{"id":9721,"depth":1088,"text":9724},{"id":12729,"depth":1088,"text":13888},"Using ignore_changes in the definitions",{"id":12860,"depth":1088,"text":12863},{"id":12935,"depth":1079,"text":12938,"children":13891},[13892,13893,13895,13896,13897,13898,13899,13900,13901,13902,13903,13904,13905],{"id":12946,"depth":1088,"text":12949},{"id":12957,"depth":1088,"text":13894},"Run the make tf-bootstrap command",{"id":12984,"depth":1088,"text":12987},{"id":13017,"depth":1088,"text":13020},{"id":13028,"depth":1088,"text":13031},{"id":13039,"depth":1088,"text":13042},{"id":13050,"depth":1088,"text":13053},{"id":13197,"depth":1088,"text":13200},{"id":13239,"depth":1088,"text":13242},{"id":13288,"depth":1088,"text":13291},{"id":13355,"depth":1088,"text":13358},{"id":13580,"depth":1088,"text":13583},{"id":13612,"depth":1088,"text":13615},{"id":13641,"depth":1079,"text":13644,"children":13907},[13908,13909,13910,13911,13912,13913,13914,13915,13916,13917],{"id":13647,"depth":1088,"text":13650},{"id":13658,"depth":1088,"text":13661},{"id":13684,"depth":1088,"text":13687},{"id":13713,"depth":1088,"text":13716},{"id":13724,"depth":1088,"text":13727},{"id":13735,"depth":1088,"text":13738},{"id":13746,"depth":1088,"text":13749},{"id":13757,"depth":1088,"text":13760},{"id":13782,"depth":1088,"text":13785},{"id":13793,"depth":1088,"text":13796},{"id":7730,"depth":1079,"text":7733},"content:2022:03:27:ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",{"_path":13923,"_dir":13924,"_draft":7,"_partial":7,"_locale":8,"title":13925,"description":8,"layout":13926,"date":13927,"comments":44,"image":13928,"tags":13929,"body":13932,"_type":7809,"_id":18907,"_source":7811,"_file":18908,"_stem":18909,"_extension":7814},"/2020/08/01/django-and-lambda-with-cdk-and-api-gateway","01","Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern","post","2020-08-01T00:00:00.000Z","/static/djambda.png",[13930,14,20,13931,15],"serverless","lambda",{"type":46,"children":13933,"toc":18892},[13934,13938,13943,13949,13954,13960,13965,13979,13984,13996,14010,14016,14054,14239,14253,14303,14580,14605,14609,14622,14709,14766,14771,14784,14789,14865,14870,15094,15099,15523,15617,15633,15652,15732,15766,16005,16010,16015,16020,16385,16398,16436,16448,16855,16860,16939,16945,16976,16981,17272,17277,17308,17313,17615,17628,17636,17673,17707,17730,17779,17785,17798,17849,17869,17881,17887,17899,17907,17933,17962,17997,18027,18033,18038,18051,18057,18070,18082,18090,18135,18148,18156,18169,18177,18182,18190,18202,18215,18223,18236,18243,18248,18273,18281,18287,18292,18505,18518,18750,18763,18769,18774,18883,18888],{"type":49,"tag":50,"props":13935,"children":13936},{"id":52},[13937],{"type":55,"value":56},{"type":49,"tag":58,"props":13939,"children":13940},{},[13941],{"type":55,"value":13942},"One way to deploy Django apps to AWS on a budget is to use the Lambda proxy pattern. The main idea is this: web requests are made to API Gateway that calls a Lambda outside of our VPC (proxy Lambda), which then invokes a second lambda (Django Lambda) inside of our VPC so that it can access VPC resources, namely RDS. The handler for the Django Lambda translates the API Gateway event into a WSGI-compatible request, processes the request and returns the response to the user back through the proxy Lambda. The big caveat is that you can't easily access the internet in Django's request/response cycle without network address translation (NAT) services which add additional costs. One other caveat is that there is high latency associated with the initial request. There are three cold starts to wait for: the cold start for the proxy Lambda, the cold start for the Django Lambda and the cold start for the Aurora Postgres Serverless database. Here's an architecture diagram:",{"type":49,"tag":58,"props":13944,"children":13945},{},[13946],{"type":49,"tag":1601,"props":13947,"children":13948},{"alt":8926,"src":13928},[],{"type":49,"tag":58,"props":13950,"children":13951},{},[13952],{"type":55,"value":13953},"Route53 and CloudFront (1 and 2), discuessed later on, are optional. Starting with 5, API Gateway requests are passed to a proxy lambda (6) which calls a Lambda in a VPC that contains our Django code and special Django handler (7). This function can access RDS (8) and S3 (4) via a VPC Gateway Endpoint (9), but it cannot access the internet.",{"type":49,"tag":50,"props":13955,"children":13957},{"id":13956},"why",[13958],{"type":55,"value":13959},"Why?",{"type":49,"tag":58,"props":13961,"children":13962},{},[13963],{"type":55,"value":13964},"There are a few different reasons for why I put this project together. Before I get into these reasons, here is a little bit of background on how I typically deploy web apps and the motivations for this project.",{"type":49,"tag":58,"props":13966,"children":13967},{},[13968,13970,13977],{"type":55,"value":13969},"Django is my web framework of choice, and I'm most comfortable working with Django in docker containers. I previously wrote an article about ",{"type":49,"tag":80,"props":13971,"children":13974},{"href":13972,"rel":13973},"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html",[84],[13975],{"type":55,"value":13976},"deploying Django applications with AWS Fargate",{"type":55,"value":13978},". This approach technically is \"serverless\", but it requires the use of \"always on\" services: an Application Load Balancer, NAT Gateways and long-running Fargate tasks to run gunicorn processes for our Django application. Even if you choose to run workloads in public subnets and don't use NAT Gateways or NAT instances, the costs are prohbitively high for many types of Django projects: personal projects, proof-of-concept projects, internal projects, toy projects, etc.",{"type":49,"tag":58,"props":13980,"children":13981},{},[13982],{"type":55,"value":13983},"The other serverless compute platform on AWS is Lambda. There is a popular framework for deploying serverless Django applications on Lambda called Zappa. I have been meaning to try out Zappa for a while now, and I still haven't used it, but it provided a good reference for how to do \"serverless Django\". I'll come back to Zappa in more detail later, but the main reason I didn't want to use it for my serverless Django project is because I already have a great deployment and Infrastructure as Code tool: CDK.",{"type":49,"tag":58,"props":13985,"children":13986},{},[13987,13989,13995],{"type":55,"value":13988},"CDK, or Cloud Development Kit, is a tool that allows you define and deploy AWS infrastructure using any popular programming language, Python in my case. It uses CloudFormation in the background, and it has great support for lots of AWS services. If you are looking for an introuction to CDK, check out ",{"type":49,"tag":80,"props":13990,"children":13993},{"href":13991,"rel":13992},"https://cdkworkshop.com/",[84],[13994],{"type":55,"value":13991},{"type":55,"value":745},{"type":49,"tag":58,"props":13997,"children":13998},{},[13999,14001,14008],{"type":55,"value":14000},"Zappa makes it really easy to deploy serveless Django applications with Django, but it requires that you ",{"type":49,"tag":80,"props":14002,"children":14005},{"href":14003,"rel":14004},"https://github.com/Miserlou/Zappa#running-tasks-in-a-vpc",[84],[14006],{"type":55,"value":14007},"setup NAT and other VPC resources before using it with RDS",{"type":55,"value":14009},". Since CDK is really good at setting up these kinds of resources, as well as the resources that Zappa creates (including Lambda functions and API Gateway), I wanted to know how far I could get in setting up a servless Django application only using CDK. I also didn't want everything abstracted away by a high level framework; I'm interested in a lower level view to get more familiar with how serverless technologies work. It's important to note that the biggest motivation of all is to learn try something out of my comfort zone, make mistakes and get feedback.",{"type":49,"tag":50,"props":14011,"children":14013},{"id":14012},"django-lambda-djambda",[14014],{"type":55,"value":14015},"Django + Lambda = djambda",{"type":49,"tag":58,"props":14017,"children":14018},{},[14019,14021,14028,14030,14037,14038,14044,14046,14052],{"type":55,"value":14020},"The name for this project came pretty easily. I created ",{"type":49,"tag":80,"props":14022,"children":14025},{"href":14023,"rel":14024},"https://gitlab.com/briancaffey/djambda",[84],[14026],{"type":55,"value":14027},"a repo on GitLab called djambda",{"type":55,"value":14029}," and then discovered ",{"type":49,"tag":80,"props":14031,"children":14034},{"href":14032,"rel":14033},"https://github.com/netsome/djambda",[84],[14035],{"type":55,"value":14036},"a similar project by the same name on GitHub: netsome/djambda",{"type":55,"value":1931},{"type":49,"tag":326,"props":14039,"children":14041},{"className":14040},[],[14042],{"type":55,"value":14043},"netsome/djambda",{"type":55,"value":14045}," project uses Terraform, and I encourage you to check it out and leave it a GitHub star. Before I came across this project, I hacked together a very basic djambda protoype using some code from Zappa's handler. A ",{"type":49,"tag":326,"props":14047,"children":14049},{"className":14048},[],[14050],{"type":55,"value":14051},"handler",{"type":55,"value":14053}," is the name for the function that is called in your Lambda function's code when the Lambda function is invoked. Here's some pseudo code that shows how Zappa's handler works:",{"type":49,"tag":1050,"props":14055,"children":14059},{"code":14056,"language":14057,"meta":8,"className":14058,"style":8},"from werkzeug.wrappers import Response\n\ndef handler(event, context):\n    with Response.from_app(wsgi_app, wsgi_request(event)) as response:\n        zappa_returndict = dict()\n        zappa_returndict['body'] = response.data\n        zappa_returndict['statusCode'] = response.status_code\n        return zappa_returndict\n","py","language-py shiki shiki-themes github-light github-dark monokai",[14060],{"type":49,"tag":326,"props":14061,"children":14062},{"__ignoreMap":8},[14063,14086,14093,14130,14152,14174,14201,14226],{"type":49,"tag":1060,"props":14064,"children":14065},{"class":1062,"line":1063},[14066,14071,14076,14081],{"type":49,"tag":1060,"props":14067,"children":14068},{"style":2194},[14069],{"type":55,"value":14070},"from",{"type":49,"tag":1060,"props":14072,"children":14073},{"style":1073},[14074],{"type":55,"value":14075}," werkzeug.wrappers ",{"type":49,"tag":1060,"props":14077,"children":14078},{"style":2194},[14079],{"type":55,"value":14080},"import",{"type":49,"tag":1060,"props":14082,"children":14083},{"style":1073},[14084],{"type":55,"value":14085}," Response\n",{"type":49,"tag":1060,"props":14087,"children":14088},{"class":1062,"line":1079},[14089],{"type":49,"tag":1060,"props":14090,"children":14091},{"emptyLinePlaceholder":44},[14092],{"type":55,"value":1094},{"type":49,"tag":1060,"props":14094,"children":14095},{"class":1062,"line":1088},[14096,14101,14106,14110,14116,14120,14125],{"type":49,"tag":1060,"props":14097,"children":14098},{"style":2182},[14099],{"type":55,"value":14100},"def",{"type":49,"tag":1060,"props":14102,"children":14103},{"style":1067},[14104],{"type":55,"value":14105}," handler",{"type":49,"tag":1060,"props":14107,"children":14108},{"style":1073},[14109],{"type":55,"value":2284},{"type":49,"tag":1060,"props":14111,"children":14113},{"style":14112},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[14114],{"type":55,"value":14115},"event",{"type":49,"tag":1060,"props":14117,"children":14118},{"style":1073},[14119],{"type":55,"value":873},{"type":49,"tag":1060,"props":14121,"children":14122},{"style":14112},[14123],{"type":55,"value":14124},"context",{"type":49,"tag":1060,"props":14126,"children":14127},{"style":1073},[14128],{"type":55,"value":14129},"):\n",{"type":49,"tag":1060,"props":14131,"children":14132},{"class":1062,"line":1097},[14133,14138,14143,14147],{"type":49,"tag":1060,"props":14134,"children":14135},{"style":2194},[14136],{"type":55,"value":14137},"    with",{"type":49,"tag":1060,"props":14139,"children":14140},{"style":1073},[14141],{"type":55,"value":14142}," Response.from_app(wsgi_app, wsgi_request(event)) ",{"type":49,"tag":1060,"props":14144,"children":14145},{"style":2194},[14146],{"type":55,"value":5178},{"type":49,"tag":1060,"props":14148,"children":14149},{"style":1073},[14150],{"type":55,"value":14151}," response:\n",{"type":49,"tag":1060,"props":14153,"children":14154},{"class":1062,"line":1111},[14155,14160,14164,14169],{"type":49,"tag":1060,"props":14156,"children":14157},{"style":1073},[14158],{"type":55,"value":14159},"        zappa_returndict ",{"type":49,"tag":1060,"props":14161,"children":14162},{"style":2194},[14163],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14165,"children":14166},{"style":5200},[14167],{"type":55,"value":14168}," dict",{"type":49,"tag":1060,"props":14170,"children":14171},{"style":1073},[14172],{"type":55,"value":14173},"()\n",{"type":49,"tag":1060,"props":14175,"children":14176},{"class":1062,"line":1120},[14177,14182,14187,14192,14196],{"type":49,"tag":1060,"props":14178,"children":14179},{"style":1073},[14180],{"type":55,"value":14181},"        zappa_returndict[",{"type":49,"tag":1060,"props":14183,"children":14184},{"style":2215},[14185],{"type":55,"value":14186},"'body'",{"type":49,"tag":1060,"props":14188,"children":14189},{"style":1073},[14190],{"type":55,"value":14191},"] ",{"type":49,"tag":1060,"props":14193,"children":14194},{"style":2194},[14195],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14197,"children":14198},{"style":1073},[14199],{"type":55,"value":14200}," response.data\n",{"type":49,"tag":1060,"props":14202,"children":14203},{"class":1062,"line":1128},[14204,14208,14213,14217,14221],{"type":49,"tag":1060,"props":14205,"children":14206},{"style":1073},[14207],{"type":55,"value":14181},{"type":49,"tag":1060,"props":14209,"children":14210},{"style":2215},[14211],{"type":55,"value":14212},"'statusCode'",{"type":49,"tag":1060,"props":14214,"children":14215},{"style":1073},[14216],{"type":55,"value":14191},{"type":49,"tag":1060,"props":14218,"children":14219},{"style":2194},[14220],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14222,"children":14223},{"style":1073},[14224],{"type":55,"value":14225}," response.status_code\n",{"type":49,"tag":1060,"props":14227,"children":14228},{"class":1062,"line":1141},[14229,14234],{"type":49,"tag":1060,"props":14230,"children":14231},{"style":2194},[14232],{"type":55,"value":14233},"        return",{"type":49,"tag":1060,"props":14235,"children":14236},{"style":1073},[14237],{"type":55,"value":14238}," zappa_returndict\n",{"type":49,"tag":58,"props":14240,"children":14241},{},[14242,14244,14251],{"type":55,"value":14243},"For reference, ",{"type":49,"tag":80,"props":14245,"children":14248},{"href":14246,"rel":14247},"https://github.com/Miserlou/Zappa/blob/master/zappa/handler.py#L540",[84],[14249],{"type":55,"value":14250},"here is the link to the line in Zappa's source code that starts processing API Gateway requests",{"type":55,"value":14252}," on which the above psuedo code is loosly based.",{"type":49,"tag":58,"props":14254,"children":14255},{},[14256,14257,14262,14264,14271,14273,14279,14281,14287,14289,14294,14296,14301],{"type":55,"value":413},{"type":49,"tag":326,"props":14258,"children":14260},{"className":14259},[],[14261],{"type":55,"value":14043},{"type":55,"value":14263}," project makes use of a package called ",{"type":49,"tag":80,"props":14265,"children":14268},{"href":14266,"rel":14267},"https://github.com/slank/awsgi",[84],[14269],{"type":55,"value":14270},"awsgi",{"type":55,"value":14272}," that has active contributions from people at AWS. Similar to djambda, it is a mashup of words (acronyms): (",{"type":49,"tag":326,"props":14274,"children":14276},{"className":14275},[],[14277],{"type":55,"value":14278},"AWS",{"type":55,"value":14280}," + ",{"type":49,"tag":326,"props":14282,"children":14284},{"className":14283},[],[14285],{"type":55,"value":14286},"wsgi",{"type":55,"value":14288}," = ",{"type":49,"tag":326,"props":14290,"children":14292},{"className":14291},[],[14293],{"type":55,"value":14270},{"type":55,"value":14295},"). It does most of the work that Zappa's handler does, so I replaced the adapted Zappa handler code with a very elagant handler (borrowed from ",{"type":49,"tag":326,"props":14297,"children":14299},{"className":14298},[],[14300],{"type":55,"value":14043},{"type":55,"value":14302},"):",{"type":49,"tag":1050,"props":14304,"children":14306},{"code":14305,"language":14057,"meta":8,"className":14058,"style":8},"# djambda/src/djambda/awsgi.py\nimport io\n\nimport awsgi\nfrom django.core import management\n\nfrom .wsgi import application\n\n\ndef lambda_handler(event, context):\n    if \"manage\" in event:\n        output = io.StringIO()\n        management.call_command(*event[\"manage\"].split(\" \"), stdout=output)\n        return {\"output\": output.getvalue()}\n    else:\n        return awsgi.response(application, event, context)\n",[14307],{"type":49,"tag":326,"props":14308,"children":14309},{"__ignoreMap":8},[14310,14318,14330,14337,14349,14370,14377,14398,14405,14412,14444,14466,14483,14534,14556,14568],{"type":49,"tag":1060,"props":14311,"children":14312},{"class":1062,"line":1063},[14313],{"type":49,"tag":1060,"props":14314,"children":14315},{"style":3039},[14316],{"type":55,"value":14317},"# djambda/src/djambda/awsgi.py\n",{"type":49,"tag":1060,"props":14319,"children":14320},{"class":1062,"line":1079},[14321,14325],{"type":49,"tag":1060,"props":14322,"children":14323},{"style":2194},[14324],{"type":55,"value":14080},{"type":49,"tag":1060,"props":14326,"children":14327},{"style":1073},[14328],{"type":55,"value":14329}," io\n",{"type":49,"tag":1060,"props":14331,"children":14332},{"class":1062,"line":1088},[14333],{"type":49,"tag":1060,"props":14334,"children":14335},{"emptyLinePlaceholder":44},[14336],{"type":55,"value":1094},{"type":49,"tag":1060,"props":14338,"children":14339},{"class":1062,"line":1097},[14340,14344],{"type":49,"tag":1060,"props":14341,"children":14342},{"style":2194},[14343],{"type":55,"value":14080},{"type":49,"tag":1060,"props":14345,"children":14346},{"style":1073},[14347],{"type":55,"value":14348}," awsgi\n",{"type":49,"tag":1060,"props":14350,"children":14351},{"class":1062,"line":1111},[14352,14356,14361,14365],{"type":49,"tag":1060,"props":14353,"children":14354},{"style":2194},[14355],{"type":55,"value":14070},{"type":49,"tag":1060,"props":14357,"children":14358},{"style":1073},[14359],{"type":55,"value":14360}," django.core ",{"type":49,"tag":1060,"props":14362,"children":14363},{"style":2194},[14364],{"type":55,"value":14080},{"type":49,"tag":1060,"props":14366,"children":14367},{"style":1073},[14368],{"type":55,"value":14369}," management\n",{"type":49,"tag":1060,"props":14371,"children":14372},{"class":1062,"line":1120},[14373],{"type":49,"tag":1060,"props":14374,"children":14375},{"emptyLinePlaceholder":44},[14376],{"type":55,"value":1094},{"type":49,"tag":1060,"props":14378,"children":14379},{"class":1062,"line":1128},[14380,14384,14389,14393],{"type":49,"tag":1060,"props":14381,"children":14382},{"style":2194},[14383],{"type":55,"value":14070},{"type":49,"tag":1060,"props":14385,"children":14386},{"style":1073},[14387],{"type":55,"value":14388}," .wsgi ",{"type":49,"tag":1060,"props":14390,"children":14391},{"style":2194},[14392],{"type":55,"value":14080},{"type":49,"tag":1060,"props":14394,"children":14395},{"style":1073},[14396],{"type":55,"value":14397}," application\n",{"type":49,"tag":1060,"props":14399,"children":14400},{"class":1062,"line":1141},[14401],{"type":49,"tag":1060,"props":14402,"children":14403},{"emptyLinePlaceholder":44},[14404],{"type":55,"value":1094},{"type":49,"tag":1060,"props":14406,"children":14407},{"class":1062,"line":1150},[14408],{"type":49,"tag":1060,"props":14409,"children":14410},{"emptyLinePlaceholder":44},[14411],{"type":55,"value":1094},{"type":49,"tag":1060,"props":14413,"children":14414},{"class":1062,"line":1158},[14415,14419,14424,14428,14432,14436,14440],{"type":49,"tag":1060,"props":14416,"children":14417},{"style":2182},[14418],{"type":55,"value":14100},{"type":49,"tag":1060,"props":14420,"children":14421},{"style":1067},[14422],{"type":55,"value":14423}," lambda_handler",{"type":49,"tag":1060,"props":14425,"children":14426},{"style":1073},[14427],{"type":55,"value":2284},{"type":49,"tag":1060,"props":14429,"children":14430},{"style":14112},[14431],{"type":55,"value":14115},{"type":49,"tag":1060,"props":14433,"children":14434},{"style":1073},[14435],{"type":55,"value":873},{"type":49,"tag":1060,"props":14437,"children":14438},{"style":14112},[14439],{"type":55,"value":14124},{"type":49,"tag":1060,"props":14441,"children":14442},{"style":1073},[14443],{"type":55,"value":14129},{"type":49,"tag":1060,"props":14445,"children":14446},{"class":1062,"line":1171},[14447,14451,14456,14461],{"type":49,"tag":1060,"props":14448,"children":14449},{"style":2194},[14450],{"type":55,"value":3050},{"type":49,"tag":1060,"props":14452,"children":14453},{"style":2215},[14454],{"type":55,"value":14455}," \"manage\"",{"type":49,"tag":1060,"props":14457,"children":14458},{"style":2194},[14459],{"type":55,"value":14460}," in",{"type":49,"tag":1060,"props":14462,"children":14463},{"style":1073},[14464],{"type":55,"value":14465}," event:\n",{"type":49,"tag":1060,"props":14467,"children":14468},{"class":1062,"line":1180},[14469,14474,14478],{"type":49,"tag":1060,"props":14470,"children":14471},{"style":1073},[14472],{"type":55,"value":14473},"        output ",{"type":49,"tag":1060,"props":14475,"children":14476},{"style":2194},[14477],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14479,"children":14480},{"style":1073},[14481],{"type":55,"value":14482}," io.StringIO()\n",{"type":49,"tag":1060,"props":14484,"children":14485},{"class":1062,"line":1188},[14486,14491,14496,14501,14506,14511,14516,14520,14525,14529],{"type":49,"tag":1060,"props":14487,"children":14488},{"style":1073},[14489],{"type":55,"value":14490},"        management.call_command(",{"type":49,"tag":1060,"props":14492,"children":14493},{"style":2194},[14494],{"type":55,"value":14495},"*",{"type":49,"tag":1060,"props":14497,"children":14498},{"style":1073},[14499],{"type":55,"value":14500},"event[",{"type":49,"tag":1060,"props":14502,"children":14503},{"style":2215},[14504],{"type":55,"value":14505},"\"manage\"",{"type":49,"tag":1060,"props":14507,"children":14508},{"style":1073},[14509],{"type":55,"value":14510},"].split(",{"type":49,"tag":1060,"props":14512,"children":14513},{"style":2215},[14514],{"type":55,"value":14515},"\" \"",{"type":49,"tag":1060,"props":14517,"children":14518},{"style":1073},[14519],{"type":55,"value":2295},{"type":49,"tag":1060,"props":14521,"children":14523},{"style":14522},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[14524],{"type":55,"value":3426},{"type":49,"tag":1060,"props":14526,"children":14527},{"style":2194},[14528],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14530,"children":14531},{"style":1073},[14532],{"type":55,"value":14533},"output)\n",{"type":49,"tag":1060,"props":14535,"children":14536},{"class":1062,"line":1201},[14537,14541,14546,14551],{"type":49,"tag":1060,"props":14538,"children":14539},{"style":2194},[14540],{"type":55,"value":14233},{"type":49,"tag":1060,"props":14542,"children":14543},{"style":1073},[14544],{"type":55,"value":14545}," {",{"type":49,"tag":1060,"props":14547,"children":14548},{"style":2215},[14549],{"type":55,"value":14550},"\"output\"",{"type":49,"tag":1060,"props":14552,"children":14553},{"style":1073},[14554],{"type":55,"value":14555},": output.getvalue()}\n",{"type":49,"tag":1060,"props":14557,"children":14558},{"class":1062,"line":1210},[14559,14564],{"type":49,"tag":1060,"props":14560,"children":14561},{"style":2194},[14562],{"type":55,"value":14563},"    else",{"type":49,"tag":1060,"props":14565,"children":14566},{"style":1073},[14567],{"type":55,"value":6862},{"type":49,"tag":1060,"props":14569,"children":14570},{"class":1062,"line":1218},[14571,14575],{"type":49,"tag":1060,"props":14572,"children":14573},{"style":2194},[14574],{"type":55,"value":14233},{"type":49,"tag":1060,"props":14576,"children":14577},{"style":1073},[14578],{"type":55,"value":14579}," awsgi.response(application, event, context)\n",{"type":49,"tag":58,"props":14581,"children":14582},{},[14583,14585,14590,14591,14597,14598,14603],{"type":55,"value":14584},"This handler can takes care of translating API Gateway requests to WSGI requests as well as management commands such as ",{"type":49,"tag":326,"props":14586,"children":14588},{"className":14587},[],[14589],{"type":55,"value":3323},{"type":55,"value":873},{"type":49,"tag":326,"props":14592,"children":14594},{"className":14593},[],[14595],{"type":55,"value":14596},"createsuperuser",{"type":55,"value":873},{"type":49,"tag":326,"props":14599,"children":14601},{"className":14600},[],[14602],{"type":55,"value":3316},{"type":55,"value":14604}," and other custom management commands. Let's talk about the management commands first as they relate to the two main AWS services that our Django application uses: RDS and S3. Then we will talk about API Gateway, the proxy Lambda and how the Lambda proxy pattern works.",{"type":49,"tag":50,"props":14606,"children":14607},{"id":1929},[14608],{"type":55,"value":2027},{"type":49,"tag":58,"props":14610,"children":14611},{},[14612,14614,14620],{"type":55,"value":14613},"To run the management commands for our application, we can use the AWS CLI to invoke the Lambda function with a payload that will trigger the ",{"type":49,"tag":326,"props":14615,"children":14617},{"className":14616},[],[14618],{"type":55,"value":14619},"if \"manage\" in event:",{"type":55,"value":14621}," code block from the above handler:",{"type":49,"tag":1050,"props":14623,"children":14625},{"code":14624,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name my-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"migrate --no-input\"}' \\\n    resp.json\n",[14626],{"type":49,"tag":326,"props":14627,"children":14628},{"__ignoreMap":8},[14629,14650,14667,14684,14701],{"type":49,"tag":1060,"props":14630,"children":14631},{"class":1062,"line":1063},[14632,14636,14641,14646],{"type":49,"tag":1060,"props":14633,"children":14634},{"style":1067},[14635],{"type":55,"value":20},{"type":49,"tag":1060,"props":14637,"children":14638},{"style":2215},[14639],{"type":55,"value":14640}," lambda",{"type":49,"tag":1060,"props":14642,"children":14643},{"style":2215},[14644],{"type":55,"value":14645}," invoke",{"type":49,"tag":1060,"props":14647,"children":14648},{"style":2287},[14649],{"type":55,"value":10239},{"type":49,"tag":1060,"props":14651,"children":14652},{"class":1062,"line":1079},[14653,14658,14663],{"type":49,"tag":1060,"props":14654,"children":14655},{"style":2287},[14656],{"type":55,"value":14657},"    --function-name",{"type":49,"tag":1060,"props":14659,"children":14660},{"style":2215},[14661],{"type":55,"value":14662}," my-djambda-lambda",{"type":49,"tag":1060,"props":14664,"children":14665},{"style":2287},[14666],{"type":55,"value":10239},{"type":49,"tag":1060,"props":14668,"children":14669},{"class":1062,"line":1088},[14670,14675,14680],{"type":49,"tag":1060,"props":14671,"children":14672},{"style":2287},[14673],{"type":55,"value":14674},"    --invocation-type",{"type":49,"tag":1060,"props":14676,"children":14677},{"style":2215},[14678],{"type":55,"value":14679}," RequestResponse",{"type":49,"tag":1060,"props":14681,"children":14682},{"style":2287},[14683],{"type":55,"value":10239},{"type":49,"tag":1060,"props":14685,"children":14686},{"class":1062,"line":1097},[14687,14692,14697],{"type":49,"tag":1060,"props":14688,"children":14689},{"style":2287},[14690],{"type":55,"value":14691},"    --payload",{"type":49,"tag":1060,"props":14693,"children":14694},{"style":2215},[14695],{"type":55,"value":14696}," '{\"manage\": \"migrate --no-input\"}'",{"type":49,"tag":1060,"props":14698,"children":14699},{"style":2287},[14700],{"type":55,"value":10239},{"type":49,"tag":1060,"props":14702,"children":14703},{"class":1062,"line":1111},[14704],{"type":49,"tag":1060,"props":14705,"children":14706},{"style":2215},[14707],{"type":55,"value":14708},"    resp.json\n",{"type":49,"tag":58,"props":14710,"children":14711},{},[14712,14714,14719,14721,14727,14729,14735,14737,14743,14745,14750,14751,14757,14759,14764],{"type":55,"value":14713},"This will run the ",{"type":49,"tag":326,"props":14715,"children":14717},{"className":14716},[],[14718],{"type":55,"value":3323},{"type":55,"value":14720}," command by connecting to RDS from our Django application with a special version of ",{"type":49,"tag":326,"props":14722,"children":14724},{"className":14723},[],[14725],{"type":55,"value":14726},"psycopg2",{"type":55,"value":14728}," called ",{"type":49,"tag":326,"props":14730,"children":14732},{"className":14731},[],[14733],{"type":55,"value":14734},"aws-psycopg2",{"type":55,"value":14736}," (check ",{"type":49,"tag":326,"props":14738,"children":14740},{"className":14739},[],[14741],{"type":55,"value":14742},"django/requirements.txt",{"type":55,"value":14744}," for this dependency). ",{"type":49,"tag":326,"props":14746,"children":14748},{"className":14747},[],[14749],{"type":55,"value":14726},{"type":55,"value":715},{"type":49,"tag":326,"props":14752,"children":14754},{"className":14753},[],[14755],{"type":55,"value":14756},"psycopg2-binary",{"type":55,"value":14758}," both gave error messages when trying to access the database, but the ",{"type":49,"tag":326,"props":14760,"children":14762},{"className":14761},[],[14763],{"type":55,"value":14734},{"type":55,"value":14765}," package had no issues.",{"type":49,"tag":58,"props":14767,"children":14768},{},[14769],{"type":55,"value":14770},"RDS can sometimes be the most expensive part of a project on AWS. To reduce costs, we are using Aurora Postgres Serverless. This AWS service is ideal for small, infrequently-used projects that are in development. The database \"goes to sleep\" after a period of inactivity (5 minutes, I think). When new requests to the database are made, it can take up to 30 seconds for the database to wake up. For this reason, we need the timeout of the Django Lambda to be able to clear the wakeup period of the Aurora Postgres Serverless database.",{"type":49,"tag":58,"props":14772,"children":14773},{},[14774,14776,14782],{"type":55,"value":14775},"Since our Lambda function is in public subnet of our VPC and our RDS Aurora database cluster is in an isolated VPC, we need to make sure that the Lambda function can talk to the RDS cluster. CDK makes this really easy. I'll highlight a few important permission related parts of ",{"type":49,"tag":326,"props":14777,"children":14779},{"className":14778},[],[14780],{"type":55,"value":14781},"awscdk/vpc.py",{"type":55,"value":14783},", the code that defines the nested CloudFormation stack where we define our VPC and resources related to our application (including API Gateway, which is technically not located in our VPC).",{"type":49,"tag":58,"props":14785,"children":14786},{},[14787],{"type":55,"value":14788},"First, we define a new security group for our Django Lambda:",{"type":49,"tag":1050,"props":14790,"children":14792},{"code":14791,"language":14057,"meta":8,"className":14058,"style":8},"        self.lambda_security_group = ec2.SecurityGroup(\n            self, \"LambdaSecurityGroup\", vpc=self.vpc\n        )\n",[14793],{"type":49,"tag":326,"props":14794,"children":14795},{"__ignoreMap":8},[14796,14818,14857],{"type":49,"tag":1060,"props":14797,"children":14798},{"class":1062,"line":1063},[14799,14804,14809,14813],{"type":49,"tag":1060,"props":14800,"children":14801},{"style":3797},[14802],{"type":55,"value":14803},"        self",{"type":49,"tag":1060,"props":14805,"children":14806},{"style":1073},[14807],{"type":55,"value":14808},".lambda_security_group ",{"type":49,"tag":1060,"props":14810,"children":14811},{"style":2194},[14812],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14814,"children":14815},{"style":1073},[14816],{"type":55,"value":14817}," ec2.SecurityGroup(\n",{"type":49,"tag":1060,"props":14819,"children":14820},{"class":1062,"line":1079},[14821,14826,14830,14835,14839,14843,14847,14852],{"type":49,"tag":1060,"props":14822,"children":14823},{"style":3797},[14824],{"type":55,"value":14825},"            self",{"type":49,"tag":1060,"props":14827,"children":14828},{"style":1073},[14829],{"type":55,"value":873},{"type":49,"tag":1060,"props":14831,"children":14832},{"style":2215},[14833],{"type":55,"value":14834},"\"LambdaSecurityGroup\"",{"type":49,"tag":1060,"props":14836,"children":14837},{"style":1073},[14838],{"type":55,"value":873},{"type":49,"tag":1060,"props":14840,"children":14841},{"style":14522},[14842],{"type":55,"value":2091},{"type":49,"tag":1060,"props":14844,"children":14845},{"style":2194},[14846],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14848,"children":14849},{"style":3797},[14850],{"type":55,"value":14851},"self",{"type":49,"tag":1060,"props":14853,"children":14854},{"style":1073},[14855],{"type":55,"value":14856},".vpc\n",{"type":49,"tag":1060,"props":14858,"children":14859},{"class":1062,"line":1088},[14860],{"type":49,"tag":1060,"props":14861,"children":14862},{"style":1073},[14863],{"type":55,"value":14864},"        )\n",{"type":49,"tag":58,"props":14866,"children":14867},{},[14868],{"type":55,"value":14869},"Then, we reference this security group in the list of security group ingresses for our database cluster's security group:",{"type":49,"tag":1050,"props":14871,"children":14873},{"code":14872,"language":14057,"meta":8,"className":14058,"style":8},"        self.db_security_group = ec2.CfnSecurityGroup(\n            self,\n            \"DBSecurityGroup\",\n            vpc_id=self.vpc.vpc_id,\n            group_description=\"DBSecurityGroup\",\n            security_group_ingress=[\n                ec2.CfnSecurityGroup.IngressProperty(\n                    ip_protocol=\"tcp\",\n                    to_port=5432,\n                    from_port=5432,\n                    source_security_group_id=self.lambda_security_group.security_group_id,\n                )\n            ],\n        )\n",[14874],{"type":49,"tag":326,"props":14875,"children":14876},{"__ignoreMap":8},[14877,14898,14909,14921,14942,14963,14980,14988,15009,15030,15050,15071,15079,15087],{"type":49,"tag":1060,"props":14878,"children":14879},{"class":1062,"line":1063},[14880,14884,14889,14893],{"type":49,"tag":1060,"props":14881,"children":14882},{"style":3797},[14883],{"type":55,"value":14803},{"type":49,"tag":1060,"props":14885,"children":14886},{"style":1073},[14887],{"type":55,"value":14888},".db_security_group ",{"type":49,"tag":1060,"props":14890,"children":14891},{"style":2194},[14892],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14894,"children":14895},{"style":1073},[14896],{"type":55,"value":14897}," ec2.CfnSecurityGroup(\n",{"type":49,"tag":1060,"props":14899,"children":14900},{"class":1062,"line":1079},[14901,14905],{"type":49,"tag":1060,"props":14902,"children":14903},{"style":3797},[14904],{"type":55,"value":14825},{"type":49,"tag":1060,"props":14906,"children":14907},{"style":1073},[14908],{"type":55,"value":2497},{"type":49,"tag":1060,"props":14910,"children":14911},{"class":1062,"line":1088},[14912,14917],{"type":49,"tag":1060,"props":14913,"children":14914},{"style":2215},[14915],{"type":55,"value":14916},"            \"DBSecurityGroup\"",{"type":49,"tag":1060,"props":14918,"children":14919},{"style":1073},[14920],{"type":55,"value":2497},{"type":49,"tag":1060,"props":14922,"children":14923},{"class":1062,"line":1097},[14924,14929,14933,14937],{"type":49,"tag":1060,"props":14925,"children":14926},{"style":14522},[14927],{"type":55,"value":14928},"            vpc_id",{"type":49,"tag":1060,"props":14930,"children":14931},{"style":2194},[14932],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14934,"children":14935},{"style":3797},[14936],{"type":55,"value":14851},{"type":49,"tag":1060,"props":14938,"children":14939},{"style":1073},[14940],{"type":55,"value":14941},".vpc.vpc_id,\n",{"type":49,"tag":1060,"props":14943,"children":14944},{"class":1062,"line":1111},[14945,14950,14954,14959],{"type":49,"tag":1060,"props":14946,"children":14947},{"style":14522},[14948],{"type":55,"value":14949},"            group_description",{"type":49,"tag":1060,"props":14951,"children":14952},{"style":2194},[14953],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14955,"children":14956},{"style":2215},[14957],{"type":55,"value":14958},"\"DBSecurityGroup\"",{"type":49,"tag":1060,"props":14960,"children":14961},{"style":1073},[14962],{"type":55,"value":2497},{"type":49,"tag":1060,"props":14964,"children":14965},{"class":1062,"line":1120},[14966,14971,14975],{"type":49,"tag":1060,"props":14967,"children":14968},{"style":14522},[14969],{"type":55,"value":14970},"            security_group_ingress",{"type":49,"tag":1060,"props":14972,"children":14973},{"style":2194},[14974],{"type":55,"value":3068},{"type":49,"tag":1060,"props":14976,"children":14977},{"style":1073},[14978],{"type":55,"value":14979},"[\n",{"type":49,"tag":1060,"props":14981,"children":14982},{"class":1062,"line":1128},[14983],{"type":49,"tag":1060,"props":14984,"children":14985},{"style":1073},[14986],{"type":55,"value":14987},"                ec2.CfnSecurityGroup.IngressProperty(\n",{"type":49,"tag":1060,"props":14989,"children":14990},{"class":1062,"line":1141},[14991,14996,15000,15005],{"type":49,"tag":1060,"props":14992,"children":14993},{"style":14522},[14994],{"type":55,"value":14995},"                    ip_protocol",{"type":49,"tag":1060,"props":14997,"children":14998},{"style":2194},[14999],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15001,"children":15002},{"style":2215},[15003],{"type":55,"value":15004},"\"tcp\"",{"type":49,"tag":1060,"props":15006,"children":15007},{"style":1073},[15008],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15010,"children":15011},{"class":1062,"line":1150},[15012,15017,15021,15026],{"type":49,"tag":1060,"props":15013,"children":15014},{"style":14522},[15015],{"type":55,"value":15016},"                    to_port",{"type":49,"tag":1060,"props":15018,"children":15019},{"style":2194},[15020],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15022,"children":15023},{"style":2287},[15024],{"type":55,"value":15025},"5432",{"type":49,"tag":1060,"props":15027,"children":15028},{"style":1073},[15029],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15031,"children":15032},{"class":1062,"line":1158},[15033,15038,15042,15046],{"type":49,"tag":1060,"props":15034,"children":15035},{"style":14522},[15036],{"type":55,"value":15037},"                    from_port",{"type":49,"tag":1060,"props":15039,"children":15040},{"style":2194},[15041],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15043,"children":15044},{"style":2287},[15045],{"type":55,"value":15025},{"type":49,"tag":1060,"props":15047,"children":15048},{"style":1073},[15049],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15051,"children":15052},{"class":1062,"line":1171},[15053,15058,15062,15066],{"type":49,"tag":1060,"props":15054,"children":15055},{"style":14522},[15056],{"type":55,"value":15057},"                    source_security_group_id",{"type":49,"tag":1060,"props":15059,"children":15060},{"style":2194},[15061],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15063,"children":15064},{"style":3797},[15065],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15067,"children":15068},{"style":1073},[15069],{"type":55,"value":15070},".lambda_security_group.security_group_id,\n",{"type":49,"tag":1060,"props":15072,"children":15073},{"class":1062,"line":1180},[15074],{"type":49,"tag":1060,"props":15075,"children":15076},{"style":1073},[15077],{"type":55,"value":15078},"                )\n",{"type":49,"tag":1060,"props":15080,"children":15081},{"class":1062,"line":1188},[15082],{"type":49,"tag":1060,"props":15083,"children":15084},{"style":1073},[15085],{"type":55,"value":15086},"            ],\n",{"type":49,"tag":1060,"props":15088,"children":15089},{"class":1062,"line":1201},[15090],{"type":49,"tag":1060,"props":15091,"children":15092},{"style":1073},[15093],{"type":55,"value":14864},{"type":49,"tag":58,"props":15095,"children":15096},{},[15097],{"type":55,"value":15098},"Now let's take a look at the code for the Django lambda itself:",{"type":49,"tag":1050,"props":15100,"children":15102},{"code":15101,"language":14057,"meta":8,"className":14058,"style":8},"        self.djambda_lambda = _lambda.Function(\n            self,\n            \"DjambdaLambda\",\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            code=_lambda.AssetCode('./django'),\n            function_name=f\"{scope.full_app_name}-djambda-lambda\",\n            handler=\"djambda.awsgi.lambda_handler\",\n            layers=[self.djambda_layer],\n            timeout=core.Duration.seconds(60),\n            vpc=self.vpc,\n            vpc_subnets=ec2.SubnetSelection(subnets=self.vpc.isolated_subnets),\n            environment={**self.env_vars},\n            security_groups=[self.lambda_security_group],\n        )\n\n        # Use raw override because Lambda's can't be placed in\n        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n        self.djambda_lambda.node.default_child.add_override(\n            \"Properties.VpcConfig.SubnetIds\",\n            [subnet.subnet_id for subnet in self.vpc.public_subnets],\n        )\n",[15103],{"type":49,"tag":326,"props":15104,"children":15105},{"__ignoreMap":8},[15106,15127,15138,15150,15176,15203,15247,15268,15294,15320,15341,15376,15406,15431,15438,15445,15453,15461,15473,15485,15516],{"type":49,"tag":1060,"props":15107,"children":15108},{"class":1062,"line":1063},[15109,15113,15118,15122],{"type":49,"tag":1060,"props":15110,"children":15111},{"style":3797},[15112],{"type":55,"value":14803},{"type":49,"tag":1060,"props":15114,"children":15115},{"style":1073},[15116],{"type":55,"value":15117},".djambda_lambda ",{"type":49,"tag":1060,"props":15119,"children":15120},{"style":2194},[15121],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15123,"children":15124},{"style":1073},[15125],{"type":55,"value":15126}," _lambda.Function(\n",{"type":49,"tag":1060,"props":15128,"children":15129},{"class":1062,"line":1079},[15130,15134],{"type":49,"tag":1060,"props":15131,"children":15132},{"style":3797},[15133],{"type":55,"value":14825},{"type":49,"tag":1060,"props":15135,"children":15136},{"style":1073},[15137],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15139,"children":15140},{"class":1062,"line":1088},[15141,15146],{"type":49,"tag":1060,"props":15142,"children":15143},{"style":2215},[15144],{"type":55,"value":15145},"            \"DjambdaLambda\"",{"type":49,"tag":1060,"props":15147,"children":15148},{"style":1073},[15149],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15151,"children":15152},{"class":1062,"line":1097},[15153,15158,15162,15167,15172],{"type":49,"tag":1060,"props":15154,"children":15155},{"style":14522},[15156],{"type":55,"value":15157},"            runtime",{"type":49,"tag":1060,"props":15159,"children":15160},{"style":2194},[15161],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15163,"children":15164},{"style":1073},[15165],{"type":55,"value":15166},"_lambda.Runtime.",{"type":49,"tag":1060,"props":15168,"children":15169},{"style":2287},[15170],{"type":55,"value":15171},"PYTHON_3_8",{"type":49,"tag":1060,"props":15173,"children":15174},{"style":1073},[15175],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15177,"children":15178},{"class":1062,"line":1111},[15179,15184,15188,15193,15198],{"type":49,"tag":1060,"props":15180,"children":15181},{"style":14522},[15182],{"type":55,"value":15183},"            code",{"type":49,"tag":1060,"props":15185,"children":15186},{"style":2194},[15187],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15189,"children":15190},{"style":1073},[15191],{"type":55,"value":15192},"_lambda.AssetCode(",{"type":49,"tag":1060,"props":15194,"children":15195},{"style":2215},[15196],{"type":55,"value":15197},"'./django'",{"type":49,"tag":1060,"props":15199,"children":15200},{"style":1073},[15201],{"type":55,"value":15202},"),\n",{"type":49,"tag":1060,"props":15204,"children":15205},{"class":1062,"line":1120},[15206,15211,15215,15220,15224,15229,15234,15238,15243],{"type":49,"tag":1060,"props":15207,"children":15208},{"style":14522},[15209],{"type":55,"value":15210},"            function_name",{"type":49,"tag":1060,"props":15212,"children":15213},{"style":2194},[15214],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15216,"children":15217},{"style":2182},[15218],{"type":55,"value":15219},"f",{"type":49,"tag":1060,"props":15221,"children":15222},{"style":2215},[15223],{"type":55,"value":10005},{"type":49,"tag":1060,"props":15225,"children":15226},{"style":2287},[15227],{"type":55,"value":15228},"{",{"type":49,"tag":1060,"props":15230,"children":15231},{"style":1073},[15232],{"type":55,"value":15233},"scope.full_app_name",{"type":49,"tag":1060,"props":15235,"children":15236},{"style":2287},[15237],{"type":55,"value":3511},{"type":49,"tag":1060,"props":15239,"children":15240},{"style":2215},[15241],{"type":55,"value":15242},"-djambda-lambda\"",{"type":49,"tag":1060,"props":15244,"children":15245},{"style":1073},[15246],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15248,"children":15249},{"class":1062,"line":1128},[15250,15255,15259,15264],{"type":49,"tag":1060,"props":15251,"children":15252},{"style":14522},[15253],{"type":55,"value":15254},"            handler",{"type":49,"tag":1060,"props":15256,"children":15257},{"style":2194},[15258],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15260,"children":15261},{"style":2215},[15262],{"type":55,"value":15263},"\"djambda.awsgi.lambda_handler\"",{"type":49,"tag":1060,"props":15265,"children":15266},{"style":1073},[15267],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15269,"children":15270},{"class":1062,"line":1141},[15271,15276,15280,15285,15289],{"type":49,"tag":1060,"props":15272,"children":15273},{"style":14522},[15274],{"type":55,"value":15275},"            layers",{"type":49,"tag":1060,"props":15277,"children":15278},{"style":2194},[15279],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15281,"children":15282},{"style":1073},[15283],{"type":55,"value":15284},"[",{"type":49,"tag":1060,"props":15286,"children":15287},{"style":3797},[15288],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15290,"children":15291},{"style":1073},[15292],{"type":55,"value":15293},".djambda_layer],\n",{"type":49,"tag":1060,"props":15295,"children":15296},{"class":1062,"line":1150},[15297,15302,15306,15311,15316],{"type":49,"tag":1060,"props":15298,"children":15299},{"style":14522},[15300],{"type":55,"value":15301},"            timeout",{"type":49,"tag":1060,"props":15303,"children":15304},{"style":2194},[15305],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15307,"children":15308},{"style":1073},[15309],{"type":55,"value":15310},"core.Duration.seconds(",{"type":49,"tag":1060,"props":15312,"children":15313},{"style":2287},[15314],{"type":55,"value":15315},"60",{"type":49,"tag":1060,"props":15317,"children":15318},{"style":1073},[15319],{"type":55,"value":15202},{"type":49,"tag":1060,"props":15321,"children":15322},{"class":1062,"line":1158},[15323,15328,15332,15336],{"type":49,"tag":1060,"props":15324,"children":15325},{"style":14522},[15326],{"type":55,"value":15327},"            vpc",{"type":49,"tag":1060,"props":15329,"children":15330},{"style":2194},[15331],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15333,"children":15334},{"style":3797},[15335],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15337,"children":15338},{"style":1073},[15339],{"type":55,"value":15340},".vpc,\n",{"type":49,"tag":1060,"props":15342,"children":15343},{"class":1062,"line":1171},[15344,15349,15353,15358,15363,15367,15371],{"type":49,"tag":1060,"props":15345,"children":15346},{"style":14522},[15347],{"type":55,"value":15348},"            vpc_subnets",{"type":49,"tag":1060,"props":15350,"children":15351},{"style":2194},[15352],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15354,"children":15355},{"style":1073},[15356],{"type":55,"value":15357},"ec2.SubnetSelection(",{"type":49,"tag":1060,"props":15359,"children":15360},{"style":14522},[15361],{"type":55,"value":15362},"subnets",{"type":49,"tag":1060,"props":15364,"children":15365},{"style":2194},[15366],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15368,"children":15369},{"style":3797},[15370],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15372,"children":15373},{"style":1073},[15374],{"type":55,"value":15375},".vpc.isolated_subnets),\n",{"type":49,"tag":1060,"props":15377,"children":15378},{"class":1062,"line":1180},[15379,15384,15388,15392,15397,15401],{"type":49,"tag":1060,"props":15380,"children":15381},{"style":14522},[15382],{"type":55,"value":15383},"            environment",{"type":49,"tag":1060,"props":15385,"children":15386},{"style":2194},[15387],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15389,"children":15390},{"style":1073},[15391],{"type":55,"value":15228},{"type":49,"tag":1060,"props":15393,"children":15394},{"style":2194},[15395],{"type":55,"value":15396},"**",{"type":49,"tag":1060,"props":15398,"children":15399},{"style":3797},[15400],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15402,"children":15403},{"style":1073},[15404],{"type":55,"value":15405},".env_vars},\n",{"type":49,"tag":1060,"props":15407,"children":15408},{"class":1062,"line":1188},[15409,15414,15418,15422,15426],{"type":49,"tag":1060,"props":15410,"children":15411},{"style":14522},[15412],{"type":55,"value":15413},"            security_groups",{"type":49,"tag":1060,"props":15415,"children":15416},{"style":2194},[15417],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15419,"children":15420},{"style":1073},[15421],{"type":55,"value":15284},{"type":49,"tag":1060,"props":15423,"children":15424},{"style":3797},[15425],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15427,"children":15428},{"style":1073},[15429],{"type":55,"value":15430},".lambda_security_group],\n",{"type":49,"tag":1060,"props":15432,"children":15433},{"class":1062,"line":1201},[15434],{"type":49,"tag":1060,"props":15435,"children":15436},{"style":1073},[15437],{"type":55,"value":14864},{"type":49,"tag":1060,"props":15439,"children":15440},{"class":1062,"line":1210},[15441],{"type":49,"tag":1060,"props":15442,"children":15443},{"emptyLinePlaceholder":44},[15444],{"type":55,"value":1094},{"type":49,"tag":1060,"props":15446,"children":15447},{"class":1062,"line":1218},[15448],{"type":49,"tag":1060,"props":15449,"children":15450},{"style":3039},[15451],{"type":55,"value":15452},"        # Use raw override because Lambda's can't be placed in\n",{"type":49,"tag":1060,"props":15454,"children":15455},{"class":1062,"line":1232},[15456],{"type":49,"tag":1060,"props":15457,"children":15458},{"style":3039},[15459],{"type":55,"value":15460},"        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n",{"type":49,"tag":1060,"props":15462,"children":15463},{"class":1062,"line":1241},[15464,15468],{"type":49,"tag":1060,"props":15465,"children":15466},{"style":3797},[15467],{"type":55,"value":14803},{"type":49,"tag":1060,"props":15469,"children":15470},{"style":1073},[15471],{"type":55,"value":15472},".djambda_lambda.node.default_child.add_override(\n",{"type":49,"tag":1060,"props":15474,"children":15475},{"class":1062,"line":1249},[15476,15481],{"type":49,"tag":1060,"props":15477,"children":15478},{"style":2215},[15479],{"type":55,"value":15480},"            \"Properties.VpcConfig.SubnetIds\"",{"type":49,"tag":1060,"props":15482,"children":15483},{"style":1073},[15484],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15486,"children":15487},{"class":1062,"line":1262},[15488,15493,15497,15502,15506,15511],{"type":49,"tag":1060,"props":15489,"children":15490},{"style":1073},[15491],{"type":55,"value":15492},"            [subnet.subnet_id ",{"type":49,"tag":1060,"props":15494,"children":15495},{"style":2194},[15496],{"type":55,"value":10063},{"type":49,"tag":1060,"props":15498,"children":15499},{"style":1073},[15500],{"type":55,"value":15501}," subnet ",{"type":49,"tag":1060,"props":15503,"children":15504},{"style":2194},[15505],{"type":55,"value":10073},{"type":49,"tag":1060,"props":15507,"children":15508},{"style":3797},[15509],{"type":55,"value":15510}," self",{"type":49,"tag":1060,"props":15512,"children":15513},{"style":1073},[15514],{"type":55,"value":15515},".vpc.public_subnets],\n",{"type":49,"tag":1060,"props":15517,"children":15518},{"class":1062,"line":4581},[15519],{"type":49,"tag":1060,"props":15520,"children":15521},{"style":1073},[15522],{"type":55,"value":14864},{"type":49,"tag":58,"props":15524,"children":15525},{},[15526,15531,15533,15538,15539,15545,15547,15553,15555,15561,15563,15568,15570,15576,15578,15584,15586,15592,15594,15600,15601,15607,15609,15615],{"type":49,"tag":326,"props":15527,"children":15529},{"className":15528},[],[15530],{"type":55,"value":13931},{"type":55,"value":15532}," is a reserved word in Python, so we import ",{"type":49,"tag":326,"props":15534,"children":15536},{"className":15535},[],[15537],{"type":55,"value":13931},{"type":55,"value":452},{"type":49,"tag":326,"props":15540,"children":15542},{"className":15541},[],[15543],{"type":55,"value":15544},"_lambda",{"type":55,"value":15546}," from ",{"type":49,"tag":326,"props":15548,"children":15550},{"className":15549},[],[15551],{"type":55,"value":15552},"aws_cdk",{"type":55,"value":15554},". Note that we have a reference to the ",{"type":49,"tag":326,"props":15556,"children":15558},{"className":15557},[],[15559],{"type":55,"value":15560},"awsgi.py",{"type":55,"value":15562}," handler function in the ",{"type":49,"tag":326,"props":15564,"children":15566},{"className":15565},[],[15567],{"type":55,"value":14051},{"type":55,"value":15569}," parameter of ",{"type":49,"tag":326,"props":15571,"children":15573},{"className":15572},[],[15574],{"type":55,"value":15575},"self.djambda_lambda",{"type":55,"value":15577},". I initially put the lambda in ",{"type":49,"tag":326,"props":15579,"children":15581},{"className":15580},[],[15582],{"type":55,"value":15583},"isolated_subnets",{"type":55,"value":15585}," because CDK won't let you define a ",{"type":49,"tag":326,"props":15587,"children":15589},{"className":15588},[],[15590],{"type":55,"value":15591},"_lambda.Function",{"type":55,"value":15593}," with ",{"type":49,"tag":326,"props":15595,"children":15597},{"className":15596},[],[15598],{"type":55,"value":15599},"public_subnets",{"type":55,"value":9165},{"type":49,"tag":326,"props":15602,"children":15604},{"className":15603},[],[15605],{"type":55,"value":15606},"vpc_subnets",{"type":55,"value":15608},". We can override this using ",{"type":49,"tag":326,"props":15610,"children":15612},{"className":15611},[],[15613],{"type":55,"value":15614},"add_override",{"type":55,"value":15616}," below the Lambda definition to place it in a public subnet instead.",{"type":49,"tag":2910,"props":15618,"children":15619},{},[15620],{"type":49,"tag":58,"props":15621,"children":15622},{},[15623,15625,15631],{"type":55,"value":15624},"I'm not sure if this is necessary, or if this is recommended. Things get a little bit confusing for me here so I would love some insight if anyone knows what would be best to do here. The VPC construct for CDK doesn't allow you to have private subnets when ",{"type":49,"tag":326,"props":15626,"children":15628},{"className":15627},[],[15629],{"type":55,"value":15630},"nat_gateways=0",{"type":55,"value":15632},". Would I be better off placing the lambda in the isolated subnet with the RDS cluster? Would I still be able to access S3 via the VPC Gateway Endpoint from an isolated subnet?",{"type":49,"tag":58,"props":15634,"children":15635},{},[15636,15638,15643,15645,15650],{"type":55,"value":15637},"Putting aside my uncertainties about the correct way to configure our Lambdas functions in a VPC, let's continue! Here's the Lambda invocation for ",{"type":49,"tag":326,"props":15639,"children":15641},{"className":15640},[],[15642],{"type":55,"value":14596},{"type":55,"value":15644}," that we can run once we have successfully invoked the ",{"type":49,"tag":326,"props":15646,"children":15648},{"className":15647},[],[15649],{"type":55,"value":3323},{"type":55,"value":15651}," command.",{"type":49,"tag":1050,"props":15653,"children":15655},{"code":15654,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}' \\\n    resp.json\n",[15656],{"type":49,"tag":326,"props":15657,"children":15658},{"__ignoreMap":8},[15659,15678,15694,15709,15725],{"type":49,"tag":1060,"props":15660,"children":15661},{"class":1062,"line":1063},[15662,15666,15670,15674],{"type":49,"tag":1060,"props":15663,"children":15664},{"style":1067},[15665],{"type":55,"value":20},{"type":49,"tag":1060,"props":15667,"children":15668},{"style":2215},[15669],{"type":55,"value":14640},{"type":49,"tag":1060,"props":15671,"children":15672},{"style":2215},[15673],{"type":55,"value":14645},{"type":49,"tag":1060,"props":15675,"children":15676},{"style":2287},[15677],{"type":55,"value":10239},{"type":49,"tag":1060,"props":15679,"children":15680},{"class":1062,"line":1079},[15681,15685,15690],{"type":49,"tag":1060,"props":15682,"children":15683},{"style":2287},[15684],{"type":55,"value":14657},{"type":49,"tag":1060,"props":15686,"children":15687},{"style":2215},[15688],{"type":55,"value":15689}," dev-mysite-com-djambda-lambda",{"type":49,"tag":1060,"props":15691,"children":15692},{"style":2287},[15693],{"type":55,"value":10239},{"type":49,"tag":1060,"props":15695,"children":15696},{"class":1062,"line":1088},[15697,15701,15705],{"type":49,"tag":1060,"props":15698,"children":15699},{"style":2287},[15700],{"type":55,"value":14674},{"type":49,"tag":1060,"props":15702,"children":15703},{"style":2215},[15704],{"type":55,"value":14679},{"type":49,"tag":1060,"props":15706,"children":15707},{"style":2287},[15708],{"type":55,"value":10239},{"type":49,"tag":1060,"props":15710,"children":15711},{"class":1062,"line":1097},[15712,15716,15721],{"type":49,"tag":1060,"props":15713,"children":15714},{"style":2287},[15715],{"type":55,"value":14691},{"type":49,"tag":1060,"props":15717,"children":15718},{"style":2215},[15719],{"type":55,"value":15720}," '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}'",{"type":49,"tag":1060,"props":15722,"children":15723},{"style":2287},[15724],{"type":55,"value":10239},{"type":49,"tag":1060,"props":15726,"children":15727},{"class":1062,"line":1111},[15728],{"type":49,"tag":1060,"props":15729,"children":15730},{"style":2215},[15731],{"type":55,"value":14708},{"type":49,"tag":58,"props":15733,"children":15734},{},[15735,15737,15742,15744,15750,15751,15757,15759,15765],{"type":55,"value":15736},"This assumes that there is an environment variable defined in our Lambda's ",{"type":49,"tag":326,"props":15738,"children":15740},{"className":15739},[],[15741],{"type":55,"value":5113},{"type":55,"value":15743}," variables that we passed in ",{"type":49,"tag":326,"props":15745,"children":15747},{"className":15746},[],[15748],{"type":55,"value":15749},"{**self.env_vars}",{"type":55,"value":9165},{"type":49,"tag":326,"props":15752,"children":15754},{"className":15753},[],[15755],{"type":55,"value":15756},"DJANGO_SUPERUSER_USERNAME",{"type":55,"value":15758},". Here's what we have in ",{"type":49,"tag":326,"props":15760,"children":15762},{"className":15761},[],[15763],{"type":55,"value":15764},"env_vars",{"type":55,"value":6694},{"type":49,"tag":1050,"props":15767,"children":15769},{"code":15768,"language":14057,"meta":8,"className":14058,"style":8},"        self.env_vars = {\n            \"POSTGRES_SERVICE_HOST\": self.rds_cluster.get_att(\n                \"Endpoint.Address\"\n            ).to_string(),\n            \"POSTGRES_PASSWORD\": os.environ.get(\"DB_PASSWORD\", \"db-password\"),\n            \"AWS_STORAGE_BUCKET_NAME\": f\"{scope.full_app_name}-assets\",\n            \"DEBUG\": \"\",\n            \"DJANGO_SUPERUSER_PASSWORD\": os.environ.get(\n                \"DJANGO_SUPERUSER_PASSWORD\", \"Mypassword1!\"\n            ),\n            \"DJANGO_SUPERUSER_USERNAME\": os.environ.get(\n                \"DJANGO_SUPERUSER_USERNAME\", \"admin\"\n            ),\n        }\n",[15770],{"type":49,"tag":326,"props":15771,"children":15772},{"__ignoreMap":8},[15773,15793,15814,15822,15830,15861,15902,15923,15936,15953,15961,15973,15990,15997],{"type":49,"tag":1060,"props":15774,"children":15775},{"class":1062,"line":1063},[15776,15780,15785,15789],{"type":49,"tag":1060,"props":15777,"children":15778},{"style":3797},[15779],{"type":55,"value":14803},{"type":49,"tag":1060,"props":15781,"children":15782},{"style":1073},[15783],{"type":55,"value":15784},".env_vars ",{"type":49,"tag":1060,"props":15786,"children":15787},{"style":2194},[15788],{"type":55,"value":3068},{"type":49,"tag":1060,"props":15790,"children":15791},{"style":1073},[15792],{"type":55,"value":4010},{"type":49,"tag":1060,"props":15794,"children":15795},{"class":1062,"line":1079},[15796,15801,15805,15809],{"type":49,"tag":1060,"props":15797,"children":15798},{"style":2215},[15799],{"type":55,"value":15800},"            \"POSTGRES_SERVICE_HOST\"",{"type":49,"tag":1060,"props":15802,"children":15803},{"style":1073},[15804],{"type":55,"value":78},{"type":49,"tag":1060,"props":15806,"children":15807},{"style":3797},[15808],{"type":55,"value":14851},{"type":49,"tag":1060,"props":15810,"children":15811},{"style":1073},[15812],{"type":55,"value":15813},".rds_cluster.get_att(\n",{"type":49,"tag":1060,"props":15815,"children":15816},{"class":1062,"line":1088},[15817],{"type":49,"tag":1060,"props":15818,"children":15819},{"style":2215},[15820],{"type":55,"value":15821},"                \"Endpoint.Address\"\n",{"type":49,"tag":1060,"props":15823,"children":15824},{"class":1062,"line":1097},[15825],{"type":49,"tag":1060,"props":15826,"children":15827},{"style":1073},[15828],{"type":55,"value":15829},"            ).to_string(),\n",{"type":49,"tag":1060,"props":15831,"children":15832},{"class":1062,"line":1111},[15833,15838,15843,15848,15852,15857],{"type":49,"tag":1060,"props":15834,"children":15835},{"style":2215},[15836],{"type":55,"value":15837},"            \"POSTGRES_PASSWORD\"",{"type":49,"tag":1060,"props":15839,"children":15840},{"style":1073},[15841],{"type":55,"value":15842},": os.environ.get(",{"type":49,"tag":1060,"props":15844,"children":15845},{"style":2215},[15846],{"type":55,"value":15847},"\"DB_PASSWORD\"",{"type":49,"tag":1060,"props":15849,"children":15850},{"style":1073},[15851],{"type":55,"value":873},{"type":49,"tag":1060,"props":15853,"children":15854},{"style":2215},[15855],{"type":55,"value":15856},"\"db-password\"",{"type":49,"tag":1060,"props":15858,"children":15859},{"style":1073},[15860],{"type":55,"value":15202},{"type":49,"tag":1060,"props":15862,"children":15863},{"class":1062,"line":1120},[15864,15869,15873,15877,15881,15885,15889,15893,15898],{"type":49,"tag":1060,"props":15865,"children":15866},{"style":2215},[15867],{"type":55,"value":15868},"            \"AWS_STORAGE_BUCKET_NAME\"",{"type":49,"tag":1060,"props":15870,"children":15871},{"style":1073},[15872],{"type":55,"value":78},{"type":49,"tag":1060,"props":15874,"children":15875},{"style":2182},[15876],{"type":55,"value":15219},{"type":49,"tag":1060,"props":15878,"children":15879},{"style":2215},[15880],{"type":55,"value":10005},{"type":49,"tag":1060,"props":15882,"children":15883},{"style":2287},[15884],{"type":55,"value":15228},{"type":49,"tag":1060,"props":15886,"children":15887},{"style":1073},[15888],{"type":55,"value":15233},{"type":49,"tag":1060,"props":15890,"children":15891},{"style":2287},[15892],{"type":55,"value":3511},{"type":49,"tag":1060,"props":15894,"children":15895},{"style":2215},[15896],{"type":55,"value":15897},"-assets\"",{"type":49,"tag":1060,"props":15899,"children":15900},{"style":1073},[15901],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15903,"children":15904},{"class":1062,"line":1128},[15905,15910,15914,15919],{"type":49,"tag":1060,"props":15906,"children":15907},{"style":2215},[15908],{"type":55,"value":15909},"            \"DEBUG\"",{"type":49,"tag":1060,"props":15911,"children":15912},{"style":1073},[15913],{"type":55,"value":78},{"type":49,"tag":1060,"props":15915,"children":15916},{"style":2215},[15917],{"type":55,"value":15918},"\"\"",{"type":49,"tag":1060,"props":15920,"children":15921},{"style":1073},[15922],{"type":55,"value":2497},{"type":49,"tag":1060,"props":15924,"children":15925},{"class":1062,"line":1141},[15926,15931],{"type":49,"tag":1060,"props":15927,"children":15928},{"style":2215},[15929],{"type":55,"value":15930},"            \"DJANGO_SUPERUSER_PASSWORD\"",{"type":49,"tag":1060,"props":15932,"children":15933},{"style":1073},[15934],{"type":55,"value":15935},": os.environ.get(\n",{"type":49,"tag":1060,"props":15937,"children":15938},{"class":1062,"line":1150},[15939,15944,15948],{"type":49,"tag":1060,"props":15940,"children":15941},{"style":2215},[15942],{"type":55,"value":15943},"                \"DJANGO_SUPERUSER_PASSWORD\"",{"type":49,"tag":1060,"props":15945,"children":15946},{"style":1073},[15947],{"type":55,"value":873},{"type":49,"tag":1060,"props":15949,"children":15950},{"style":2215},[15951],{"type":55,"value":15952},"\"Mypassword1!\"\n",{"type":49,"tag":1060,"props":15954,"children":15955},{"class":1062,"line":1158},[15956],{"type":49,"tag":1060,"props":15957,"children":15958},{"style":1073},[15959],{"type":55,"value":15960},"            ),\n",{"type":49,"tag":1060,"props":15962,"children":15963},{"class":1062,"line":1171},[15964,15969],{"type":49,"tag":1060,"props":15965,"children":15966},{"style":2215},[15967],{"type":55,"value":15968},"            \"DJANGO_SUPERUSER_USERNAME\"",{"type":49,"tag":1060,"props":15970,"children":15971},{"style":1073},[15972],{"type":55,"value":15935},{"type":49,"tag":1060,"props":15974,"children":15975},{"class":1062,"line":1180},[15976,15981,15985],{"type":49,"tag":1060,"props":15977,"children":15978},{"style":2215},[15979],{"type":55,"value":15980},"                \"DJANGO_SUPERUSER_USERNAME\"",{"type":49,"tag":1060,"props":15982,"children":15983},{"style":1073},[15984],{"type":55,"value":873},{"type":49,"tag":1060,"props":15986,"children":15987},{"style":2215},[15988],{"type":55,"value":15989},"\"admin\"\n",{"type":49,"tag":1060,"props":15991,"children":15992},{"class":1062,"line":1188},[15993],{"type":49,"tag":1060,"props":15994,"children":15995},{"style":1073},[15996],{"type":55,"value":15960},{"type":49,"tag":1060,"props":15998,"children":15999},{"class":1062,"line":1201},[16000],{"type":49,"tag":1060,"props":16001,"children":16002},{"style":1073},[16003],{"type":55,"value":16004},"        }\n",{"type":49,"tag":58,"props":16006,"children":16007},{},[16008],{"type":55,"value":16009},"We can use environment variables to set an initial password for our superuser. We also define additionl environment variables that we will use for our datbase connection, and the S3 bucket that we will use for Django's static and media assets.",{"type":49,"tag":50,"props":16011,"children":16013},{"id":16012},"s3",[16014],{"type":55,"value":2012},{"type":49,"tag":58,"props":16016,"children":16017},{},[16018],{"type":55,"value":16019},"To access S3 from our Lambda function in a VPC, we need to use a VPC Gateway Endpoint for S3. This is a free service that enables us to access S3 directly from our VPC without going through the internet, and instead using a private connection . This again has to do with the fact that our Django Lambda can't access the internet because the network interfaces created by Lambda only have private IP addresses and would require NAT in order to connect to resources on the internet. Here's how we define the VPC as well as the VPC Gateway Endpoint using CDK:",{"type":49,"tag":1050,"props":16021,"children":16023},{"code":16022,"language":14057,"meta":8,"className":14058,"style":8},"        self.vpc = ec2.Vpc(\n            self,\n            \"Vpc\",\n            max_azs=2,\n            cidr=\"10.0.0.0/16\",\n            nat_gateways=0,\n            subnet_configuration=[\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.PUBLIC,\n                    name=\"Public\",\n                    cidr_mask=24,\n                ),\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.ISOLATED,\n                    name=\"Isolated\",\n                    cidr_mask=24,\n                ),\n            ],\n        )\n\n        self.vpc.add_gateway_endpoint(\n            \"S3Gateway\", service=ec2.GatewayVpcEndpointAwsService('s3')\n        )\n",[16024],{"type":49,"tag":326,"props":16025,"children":16026},{"__ignoreMap":8},[16027,16048,16059,16071,16092,16113,16133,16149,16157,16183,16204,16225,16233,16240,16264,16284,16303,16310,16317,16324,16331,16343,16378],{"type":49,"tag":1060,"props":16028,"children":16029},{"class":1062,"line":1063},[16030,16034,16039,16043],{"type":49,"tag":1060,"props":16031,"children":16032},{"style":3797},[16033],{"type":55,"value":14803},{"type":49,"tag":1060,"props":16035,"children":16036},{"style":1073},[16037],{"type":55,"value":16038},".vpc ",{"type":49,"tag":1060,"props":16040,"children":16041},{"style":2194},[16042],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16044,"children":16045},{"style":1073},[16046],{"type":55,"value":16047}," ec2.Vpc(\n",{"type":49,"tag":1060,"props":16049,"children":16050},{"class":1062,"line":1079},[16051,16055],{"type":49,"tag":1060,"props":16052,"children":16053},{"style":3797},[16054],{"type":55,"value":14825},{"type":49,"tag":1060,"props":16056,"children":16057},{"style":1073},[16058],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16060,"children":16061},{"class":1062,"line":1088},[16062,16067],{"type":49,"tag":1060,"props":16063,"children":16064},{"style":2215},[16065],{"type":55,"value":16066},"            \"Vpc\"",{"type":49,"tag":1060,"props":16068,"children":16069},{"style":1073},[16070],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16072,"children":16073},{"class":1062,"line":1097},[16074,16079,16083,16088],{"type":49,"tag":1060,"props":16075,"children":16076},{"style":14522},[16077],{"type":55,"value":16078},"            max_azs",{"type":49,"tag":1060,"props":16080,"children":16081},{"style":2194},[16082],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16084,"children":16085},{"style":2287},[16086],{"type":55,"value":16087},"2",{"type":49,"tag":1060,"props":16089,"children":16090},{"style":1073},[16091],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16093,"children":16094},{"class":1062,"line":1111},[16095,16100,16104,16109],{"type":49,"tag":1060,"props":16096,"children":16097},{"style":14522},[16098],{"type":55,"value":16099},"            cidr",{"type":49,"tag":1060,"props":16101,"children":16102},{"style":2194},[16103],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16105,"children":16106},{"style":2215},[16107],{"type":55,"value":16108},"\"10.0.0.0/16\"",{"type":49,"tag":1060,"props":16110,"children":16111},{"style":1073},[16112],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16114,"children":16115},{"class":1062,"line":1120},[16116,16121,16125,16129],{"type":49,"tag":1060,"props":16117,"children":16118},{"style":14522},[16119],{"type":55,"value":16120},"            nat_gateways",{"type":49,"tag":1060,"props":16122,"children":16123},{"style":2194},[16124],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16126,"children":16127},{"style":2287},[16128],{"type":55,"value":8397},{"type":49,"tag":1060,"props":16130,"children":16131},{"style":1073},[16132],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16134,"children":16135},{"class":1062,"line":1128},[16136,16141,16145],{"type":49,"tag":1060,"props":16137,"children":16138},{"style":14522},[16139],{"type":55,"value":16140},"            subnet_configuration",{"type":49,"tag":1060,"props":16142,"children":16143},{"style":2194},[16144],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16146,"children":16147},{"style":1073},[16148],{"type":55,"value":14979},{"type":49,"tag":1060,"props":16150,"children":16151},{"class":1062,"line":1141},[16152],{"type":49,"tag":1060,"props":16153,"children":16154},{"style":1073},[16155],{"type":55,"value":16156},"                ec2.SubnetConfiguration(\n",{"type":49,"tag":1060,"props":16158,"children":16159},{"class":1062,"line":1150},[16160,16165,16169,16174,16179],{"type":49,"tag":1060,"props":16161,"children":16162},{"style":14522},[16163],{"type":55,"value":16164},"                    subnet_type",{"type":49,"tag":1060,"props":16166,"children":16167},{"style":2194},[16168],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16170,"children":16171},{"style":1073},[16172],{"type":55,"value":16173},"ec2.SubnetType.",{"type":49,"tag":1060,"props":16175,"children":16176},{"style":2287},[16177],{"type":55,"value":16178},"PUBLIC",{"type":49,"tag":1060,"props":16180,"children":16181},{"style":1073},[16182],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16184,"children":16185},{"class":1062,"line":1158},[16186,16191,16195,16200],{"type":49,"tag":1060,"props":16187,"children":16188},{"style":14522},[16189],{"type":55,"value":16190},"                    name",{"type":49,"tag":1060,"props":16192,"children":16193},{"style":2194},[16194],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16196,"children":16197},{"style":2215},[16198],{"type":55,"value":16199},"\"Public\"",{"type":49,"tag":1060,"props":16201,"children":16202},{"style":1073},[16203],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16205,"children":16206},{"class":1062,"line":1171},[16207,16212,16216,16221],{"type":49,"tag":1060,"props":16208,"children":16209},{"style":14522},[16210],{"type":55,"value":16211},"                    cidr_mask",{"type":49,"tag":1060,"props":16213,"children":16214},{"style":2194},[16215],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16217,"children":16218},{"style":2287},[16219],{"type":55,"value":16220},"24",{"type":49,"tag":1060,"props":16222,"children":16223},{"style":1073},[16224],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16226,"children":16227},{"class":1062,"line":1180},[16228],{"type":49,"tag":1060,"props":16229,"children":16230},{"style":1073},[16231],{"type":55,"value":16232},"                ),\n",{"type":49,"tag":1060,"props":16234,"children":16235},{"class":1062,"line":1188},[16236],{"type":49,"tag":1060,"props":16237,"children":16238},{"style":1073},[16239],{"type":55,"value":16156},{"type":49,"tag":1060,"props":16241,"children":16242},{"class":1062,"line":1201},[16243,16247,16251,16255,16260],{"type":49,"tag":1060,"props":16244,"children":16245},{"style":14522},[16246],{"type":55,"value":16164},{"type":49,"tag":1060,"props":16248,"children":16249},{"style":2194},[16250],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16252,"children":16253},{"style":1073},[16254],{"type":55,"value":16173},{"type":49,"tag":1060,"props":16256,"children":16257},{"style":2287},[16258],{"type":55,"value":16259},"ISOLATED",{"type":49,"tag":1060,"props":16261,"children":16262},{"style":1073},[16263],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16265,"children":16266},{"class":1062,"line":1210},[16267,16271,16275,16280],{"type":49,"tag":1060,"props":16268,"children":16269},{"style":14522},[16270],{"type":55,"value":16190},{"type":49,"tag":1060,"props":16272,"children":16273},{"style":2194},[16274],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16276,"children":16277},{"style":2215},[16278],{"type":55,"value":16279},"\"Isolated\"",{"type":49,"tag":1060,"props":16281,"children":16282},{"style":1073},[16283],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16285,"children":16286},{"class":1062,"line":1218},[16287,16291,16295,16299],{"type":49,"tag":1060,"props":16288,"children":16289},{"style":14522},[16290],{"type":55,"value":16211},{"type":49,"tag":1060,"props":16292,"children":16293},{"style":2194},[16294],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16296,"children":16297},{"style":2287},[16298],{"type":55,"value":16220},{"type":49,"tag":1060,"props":16300,"children":16301},{"style":1073},[16302],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16304,"children":16305},{"class":1062,"line":1232},[16306],{"type":49,"tag":1060,"props":16307,"children":16308},{"style":1073},[16309],{"type":55,"value":16232},{"type":49,"tag":1060,"props":16311,"children":16312},{"class":1062,"line":1241},[16313],{"type":49,"tag":1060,"props":16314,"children":16315},{"style":1073},[16316],{"type":55,"value":15086},{"type":49,"tag":1060,"props":16318,"children":16319},{"class":1062,"line":1249},[16320],{"type":49,"tag":1060,"props":16321,"children":16322},{"style":1073},[16323],{"type":55,"value":14864},{"type":49,"tag":1060,"props":16325,"children":16326},{"class":1062,"line":1262},[16327],{"type":49,"tag":1060,"props":16328,"children":16329},{"emptyLinePlaceholder":44},[16330],{"type":55,"value":1094},{"type":49,"tag":1060,"props":16332,"children":16333},{"class":1062,"line":4581},[16334,16338],{"type":49,"tag":1060,"props":16335,"children":16336},{"style":3797},[16337],{"type":55,"value":14803},{"type":49,"tag":1060,"props":16339,"children":16340},{"style":1073},[16341],{"type":55,"value":16342},".vpc.add_gateway_endpoint(\n",{"type":49,"tag":1060,"props":16344,"children":16345},{"class":1062,"line":4631},[16346,16351,16355,16360,16364,16369,16374],{"type":49,"tag":1060,"props":16347,"children":16348},{"style":2215},[16349],{"type":55,"value":16350},"            \"S3Gateway\"",{"type":49,"tag":1060,"props":16352,"children":16353},{"style":1073},[16354],{"type":55,"value":873},{"type":49,"tag":1060,"props":16356,"children":16357},{"style":14522},[16358],{"type":55,"value":16359},"service",{"type":49,"tag":1060,"props":16361,"children":16362},{"style":2194},[16363],{"type":55,"value":3068},{"type":49,"tag":1060,"props":16365,"children":16366},{"style":1073},[16367],{"type":55,"value":16368},"ec2.GatewayVpcEndpointAwsService(",{"type":49,"tag":1060,"props":16370,"children":16371},{"style":2215},[16372],{"type":55,"value":16373},"'s3'",{"type":49,"tag":1060,"props":16375,"children":16376},{"style":1073},[16377],{"type":55,"value":5126},{"type":49,"tag":1060,"props":16379,"children":16380},{"class":1062,"line":4682},[16381],{"type":49,"tag":1060,"props":16382,"children":16383},{"style":1073},[16384],{"type":55,"value":14864},{"type":49,"tag":58,"props":16386,"children":16387},{},[16388,16390,16396],{"type":55,"value":16389},"With this VPC endpoint in place, we are almost ready to run our collectstatic command, but it won't work yet. This is because we haven't given our Lambda function access to write files to the S3 assets bucket for our Django application's static and media files. We can grant this permission with the following snippet from ",{"type":49,"tag":326,"props":16391,"children":16393},{"className":16392},[],[16394],{"type":55,"value":16395},"awscdk/app_stack.py",{"type":55,"value":16397},", the file that defines the root CloudFormation stack for our application:",{"type":49,"tag":1050,"props":16399,"children":16401},{"code":16400,"language":14057,"meta":8,"className":14058,"style":8},"        self.backend_assets_bucket.grant_read_write(\n            self.vpc_stack.djambda_lambda\n        )\n",[16402],{"type":49,"tag":326,"props":16403,"children":16404},{"__ignoreMap":8},[16405,16417,16429],{"type":49,"tag":1060,"props":16406,"children":16407},{"class":1062,"line":1063},[16408,16412],{"type":49,"tag":1060,"props":16409,"children":16410},{"style":3797},[16411],{"type":55,"value":14803},{"type":49,"tag":1060,"props":16413,"children":16414},{"style":1073},[16415],{"type":55,"value":16416},".backend_assets_bucket.grant_read_write(\n",{"type":49,"tag":1060,"props":16418,"children":16419},{"class":1062,"line":1079},[16420,16424],{"type":49,"tag":1060,"props":16421,"children":16422},{"style":3797},[16423],{"type":55,"value":14825},{"type":49,"tag":1060,"props":16425,"children":16426},{"style":1073},[16427],{"type":55,"value":16428},".vpc_stack.djambda_lambda\n",{"type":49,"tag":1060,"props":16430,"children":16431},{"class":1062,"line":1088},[16432],{"type":49,"tag":1060,"props":16433,"children":16434},{"style":1073},[16435],{"type":55,"value":14864},{"type":49,"tag":58,"props":16437,"children":16438},{},[16439,16441,16447],{"type":55,"value":16440},"Finally, we need to add the following settings to ",{"type":49,"tag":326,"props":16442,"children":16444},{"className":16443},[],[16445],{"type":55,"value":16446},"settings.py",{"type":55,"value":6694},{"type":49,"tag":1050,"props":16449,"children":16451},{"code":16450,"language":14057,"meta":8,"className":14058,"style":8},"STATIC_URL = '/static/'\nSTATIC_ROOT = os.path.join(BASE_DIR, 'static')\nSTATICFILES_STORAGE = \"djambda.storage_backends.StaticStorage\"\n\nAWS_DEFAULT_ACL = None\nAWS_STORAGE_BUCKET_NAME = os.environ.get(\n    \"AWS_STORAGE_BUCKET_NAME\", \"bucketname\"\n)\nAWS_S3_OBJECT_PARAMETERS = {\n    \"CacheControl\": \"max-age=86400\",\n}\nAWS_PRIVATE_MEDIA_LOCATION = \"media/private\"\nAWS_STATIC_LOCATION = \"static\"\nPRIVATE_FILE_STORAGE = \"backend.storage_backends.PrivateMediaStorage\"\nAWS_S3_CUSTOM_DOMAIN = f\"{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com\"\n\nif not DEBUG:\n    MEDIA_ROOT = \"media\"\n    MEDIA_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{MEDIA_ROOT}/\"\n    STATIC_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{AWS_STATIC_LOCATION}/\"\n    FORCE_SCRIPT_NAME = \"/prod\"\n",[16452],{"type":49,"tag":326,"props":16453,"children":16454},{"__ignoreMap":8},[16455,16472,16507,16524,16531,16548,16565,16582,16589,16605,16626,16633,16650,16667,16684,16715,16722,16744,16761,16801,16838],{"type":49,"tag":1060,"props":16456,"children":16457},{"class":1062,"line":1063},[16458,16463,16467],{"type":49,"tag":1060,"props":16459,"children":16460},{"style":2287},[16461],{"type":55,"value":16462},"STATIC_URL",{"type":49,"tag":1060,"props":16464,"children":16465},{"style":2194},[16466],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16468,"children":16469},{"style":2215},[16470],{"type":55,"value":16471}," '/static/'\n",{"type":49,"tag":1060,"props":16473,"children":16474},{"class":1062,"line":1079},[16475,16480,16484,16489,16494,16498,16503],{"type":49,"tag":1060,"props":16476,"children":16477},{"style":2287},[16478],{"type":55,"value":16479},"STATIC_ROOT",{"type":49,"tag":1060,"props":16481,"children":16482},{"style":2194},[16483],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16485,"children":16486},{"style":1073},[16487],{"type":55,"value":16488}," os.path.join(",{"type":49,"tag":1060,"props":16490,"children":16491},{"style":2287},[16492],{"type":55,"value":16493},"BASE_DIR",{"type":49,"tag":1060,"props":16495,"children":16496},{"style":1073},[16497],{"type":55,"value":873},{"type":49,"tag":1060,"props":16499,"children":16500},{"style":2215},[16501],{"type":55,"value":16502},"'static'",{"type":49,"tag":1060,"props":16504,"children":16505},{"style":1073},[16506],{"type":55,"value":5126},{"type":49,"tag":1060,"props":16508,"children":16509},{"class":1062,"line":1088},[16510,16515,16519],{"type":49,"tag":1060,"props":16511,"children":16512},{"style":2287},[16513],{"type":55,"value":16514},"STATICFILES_STORAGE",{"type":49,"tag":1060,"props":16516,"children":16517},{"style":2194},[16518],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16520,"children":16521},{"style":2215},[16522],{"type":55,"value":16523}," \"djambda.storage_backends.StaticStorage\"\n",{"type":49,"tag":1060,"props":16525,"children":16526},{"class":1062,"line":1097},[16527],{"type":49,"tag":1060,"props":16528,"children":16529},{"emptyLinePlaceholder":44},[16530],{"type":55,"value":1094},{"type":49,"tag":1060,"props":16532,"children":16533},{"class":1062,"line":1111},[16534,16539,16543],{"type":49,"tag":1060,"props":16535,"children":16536},{"style":2287},[16537],{"type":55,"value":16538},"AWS_DEFAULT_ACL",{"type":49,"tag":1060,"props":16540,"children":16541},{"style":2194},[16542],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16544,"children":16545},{"style":2287},[16546],{"type":55,"value":16547}," None\n",{"type":49,"tag":1060,"props":16549,"children":16550},{"class":1062,"line":1120},[16551,16556,16560],{"type":49,"tag":1060,"props":16552,"children":16553},{"style":2287},[16554],{"type":55,"value":16555},"AWS_STORAGE_BUCKET_NAME",{"type":49,"tag":1060,"props":16557,"children":16558},{"style":2194},[16559],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16561,"children":16562},{"style":1073},[16563],{"type":55,"value":16564}," os.environ.get(\n",{"type":49,"tag":1060,"props":16566,"children":16567},{"class":1062,"line":1128},[16568,16573,16577],{"type":49,"tag":1060,"props":16569,"children":16570},{"style":2215},[16571],{"type":55,"value":16572},"    \"AWS_STORAGE_BUCKET_NAME\"",{"type":49,"tag":1060,"props":16574,"children":16575},{"style":1073},[16576],{"type":55,"value":873},{"type":49,"tag":1060,"props":16578,"children":16579},{"style":2215},[16580],{"type":55,"value":16581},"\"bucketname\"\n",{"type":49,"tag":1060,"props":16583,"children":16584},{"class":1062,"line":1141},[16585],{"type":49,"tag":1060,"props":16586,"children":16587},{"style":1073},[16588],{"type":55,"value":5126},{"type":49,"tag":1060,"props":16590,"children":16591},{"class":1062,"line":1150},[16592,16597,16601],{"type":49,"tag":1060,"props":16593,"children":16594},{"style":2287},[16595],{"type":55,"value":16596},"AWS_S3_OBJECT_PARAMETERS",{"type":49,"tag":1060,"props":16598,"children":16599},{"style":2194},[16600],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16602,"children":16603},{"style":1073},[16604],{"type":55,"value":4010},{"type":49,"tag":1060,"props":16606,"children":16607},{"class":1062,"line":1158},[16608,16613,16617,16622],{"type":49,"tag":1060,"props":16609,"children":16610},{"style":2215},[16611],{"type":55,"value":16612},"    \"CacheControl\"",{"type":49,"tag":1060,"props":16614,"children":16615},{"style":1073},[16616],{"type":55,"value":78},{"type":49,"tag":1060,"props":16618,"children":16619},{"style":2215},[16620],{"type":55,"value":16621},"\"max-age=86400\"",{"type":49,"tag":1060,"props":16623,"children":16624},{"style":1073},[16625],{"type":55,"value":2497},{"type":49,"tag":1060,"props":16627,"children":16628},{"class":1062,"line":1171},[16629],{"type":49,"tag":1060,"props":16630,"children":16631},{"style":1073},[16632],{"type":55,"value":3675},{"type":49,"tag":1060,"props":16634,"children":16635},{"class":1062,"line":1180},[16636,16641,16645],{"type":49,"tag":1060,"props":16637,"children":16638},{"style":2287},[16639],{"type":55,"value":16640},"AWS_PRIVATE_MEDIA_LOCATION",{"type":49,"tag":1060,"props":16642,"children":16643},{"style":2194},[16644],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16646,"children":16647},{"style":2215},[16648],{"type":55,"value":16649}," \"media/private\"\n",{"type":49,"tag":1060,"props":16651,"children":16652},{"class":1062,"line":1188},[16653,16658,16662],{"type":49,"tag":1060,"props":16654,"children":16655},{"style":2287},[16656],{"type":55,"value":16657},"AWS_STATIC_LOCATION",{"type":49,"tag":1060,"props":16659,"children":16660},{"style":2194},[16661],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16663,"children":16664},{"style":2215},[16665],{"type":55,"value":16666}," \"static\"\n",{"type":49,"tag":1060,"props":16668,"children":16669},{"class":1062,"line":1201},[16670,16675,16679],{"type":49,"tag":1060,"props":16671,"children":16672},{"style":2287},[16673],{"type":55,"value":16674},"PRIVATE_FILE_STORAGE",{"type":49,"tag":1060,"props":16676,"children":16677},{"style":2194},[16678],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16680,"children":16681},{"style":2215},[16682],{"type":55,"value":16683}," \"backend.storage_backends.PrivateMediaStorage\"\n",{"type":49,"tag":1060,"props":16685,"children":16686},{"class":1062,"line":1210},[16687,16692,16696,16701,16705,16710],{"type":49,"tag":1060,"props":16688,"children":16689},{"style":2287},[16690],{"type":55,"value":16691},"AWS_S3_CUSTOM_DOMAIN",{"type":49,"tag":1060,"props":16693,"children":16694},{"style":2194},[16695],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16697,"children":16698},{"style":2182},[16699],{"type":55,"value":16700}," f",{"type":49,"tag":1060,"props":16702,"children":16703},{"style":2215},[16704],{"type":55,"value":10005},{"type":49,"tag":1060,"props":16706,"children":16707},{"style":2287},[16708],{"type":55,"value":16709},"{AWS_STORAGE_BUCKET_NAME}",{"type":49,"tag":1060,"props":16711,"children":16712},{"style":2215},[16713],{"type":55,"value":16714},".s3.amazonaws.com\"\n",{"type":49,"tag":1060,"props":16716,"children":16717},{"class":1062,"line":1218},[16718],{"type":49,"tag":1060,"props":16719,"children":16720},{"emptyLinePlaceholder":44},[16721],{"type":55,"value":1094},{"type":49,"tag":1060,"props":16723,"children":16724},{"class":1062,"line":1232},[16725,16730,16735,16740],{"type":49,"tag":1060,"props":16726,"children":16727},{"style":2194},[16728],{"type":55,"value":16729},"if",{"type":49,"tag":1060,"props":16731,"children":16732},{"style":2194},[16733],{"type":55,"value":16734}," not",{"type":49,"tag":1060,"props":16736,"children":16737},{"style":2287},[16738],{"type":55,"value":16739}," DEBUG",{"type":49,"tag":1060,"props":16741,"children":16742},{"style":1073},[16743],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16745,"children":16746},{"class":1062,"line":1241},[16747,16752,16756],{"type":49,"tag":1060,"props":16748,"children":16749},{"style":2287},[16750],{"type":55,"value":16751},"    MEDIA_ROOT",{"type":49,"tag":1060,"props":16753,"children":16754},{"style":2194},[16755],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16757,"children":16758},{"style":2215},[16759],{"type":55,"value":16760}," \"media\"\n",{"type":49,"tag":1060,"props":16762,"children":16763},{"class":1062,"line":1249},[16764,16769,16773,16777,16782,16787,16791,16796],{"type":49,"tag":1060,"props":16765,"children":16766},{"style":2287},[16767],{"type":55,"value":16768},"    MEDIA_URL",{"type":49,"tag":1060,"props":16770,"children":16771},{"style":2194},[16772],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16774,"children":16775},{"style":2182},[16776],{"type":55,"value":16700},{"type":49,"tag":1060,"props":16778,"children":16779},{"style":2215},[16780],{"type":55,"value":16781},"\"https://",{"type":49,"tag":1060,"props":16783,"children":16784},{"style":2287},[16785],{"type":55,"value":16786},"{AWS_S3_CUSTOM_DOMAIN}",{"type":49,"tag":1060,"props":16788,"children":16789},{"style":2215},[16790],{"type":55,"value":3744},{"type":49,"tag":1060,"props":16792,"children":16793},{"style":2287},[16794],{"type":55,"value":16795},"{MEDIA_ROOT}",{"type":49,"tag":1060,"props":16797,"children":16798},{"style":2215},[16799],{"type":55,"value":16800},"/\"\n",{"type":49,"tag":1060,"props":16802,"children":16803},{"class":1062,"line":1262},[16804,16809,16813,16817,16821,16825,16829,16834],{"type":49,"tag":1060,"props":16805,"children":16806},{"style":2287},[16807],{"type":55,"value":16808},"    STATIC_URL",{"type":49,"tag":1060,"props":16810,"children":16811},{"style":2194},[16812],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16814,"children":16815},{"style":2182},[16816],{"type":55,"value":16700},{"type":49,"tag":1060,"props":16818,"children":16819},{"style":2215},[16820],{"type":55,"value":16781},{"type":49,"tag":1060,"props":16822,"children":16823},{"style":2287},[16824],{"type":55,"value":16786},{"type":49,"tag":1060,"props":16826,"children":16827},{"style":2215},[16828],{"type":55,"value":3744},{"type":49,"tag":1060,"props":16830,"children":16831},{"style":2287},[16832],{"type":55,"value":16833},"{AWS_STATIC_LOCATION}",{"type":49,"tag":1060,"props":16835,"children":16836},{"style":2215},[16837],{"type":55,"value":16800},{"type":49,"tag":1060,"props":16839,"children":16840},{"class":1062,"line":4581},[16841,16846,16850],{"type":49,"tag":1060,"props":16842,"children":16843},{"style":2287},[16844],{"type":55,"value":16845},"    FORCE_SCRIPT_NAME",{"type":49,"tag":1060,"props":16847,"children":16848},{"style":2194},[16849],{"type":55,"value":2197},{"type":49,"tag":1060,"props":16851,"children":16852},{"style":2215},[16853],{"type":55,"value":16854}," \"/prod\"\n",{"type":49,"tag":58,"props":16856,"children":16857},{},[16858],{"type":55,"value":16859},"We can run the collectstatic command with the following Lambda invocation:",{"type":49,"tag":1050,"props":16861,"children":16863},{"code":16862,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"collectstatic --no-input\"}' \\\n    resp.json\n",[16864],{"type":49,"tag":326,"props":16865,"children":16866},{"__ignoreMap":8},[16867,16886,16901,16916,16932],{"type":49,"tag":1060,"props":16868,"children":16869},{"class":1062,"line":1063},[16870,16874,16878,16882],{"type":49,"tag":1060,"props":16871,"children":16872},{"style":1067},[16873],{"type":55,"value":20},{"type":49,"tag":1060,"props":16875,"children":16876},{"style":2215},[16877],{"type":55,"value":14640},{"type":49,"tag":1060,"props":16879,"children":16880},{"style":2215},[16881],{"type":55,"value":14645},{"type":49,"tag":1060,"props":16883,"children":16884},{"style":2287},[16885],{"type":55,"value":10239},{"type":49,"tag":1060,"props":16887,"children":16888},{"class":1062,"line":1079},[16889,16893,16897],{"type":49,"tag":1060,"props":16890,"children":16891},{"style":2287},[16892],{"type":55,"value":14657},{"type":49,"tag":1060,"props":16894,"children":16895},{"style":2215},[16896],{"type":55,"value":15689},{"type":49,"tag":1060,"props":16898,"children":16899},{"style":2287},[16900],{"type":55,"value":10239},{"type":49,"tag":1060,"props":16902,"children":16903},{"class":1062,"line":1088},[16904,16908,16912],{"type":49,"tag":1060,"props":16905,"children":16906},{"style":2287},[16907],{"type":55,"value":14674},{"type":49,"tag":1060,"props":16909,"children":16910},{"style":2215},[16911],{"type":55,"value":14679},{"type":49,"tag":1060,"props":16913,"children":16914},{"style":2287},[16915],{"type":55,"value":10239},{"type":49,"tag":1060,"props":16917,"children":16918},{"class":1062,"line":1097},[16919,16923,16928],{"type":49,"tag":1060,"props":16920,"children":16921},{"style":2287},[16922],{"type":55,"value":14691},{"type":49,"tag":1060,"props":16924,"children":16925},{"style":2215},[16926],{"type":55,"value":16927}," '{\"manage\": \"collectstatic --no-input\"}'",{"type":49,"tag":1060,"props":16929,"children":16930},{"style":2287},[16931],{"type":55,"value":10239},{"type":49,"tag":1060,"props":16933,"children":16934},{"class":1062,"line":1111},[16935],{"type":49,"tag":1060,"props":16936,"children":16937},{"style":2215},[16938],{"type":55,"value":14708},{"type":49,"tag":50,"props":16940,"children":16942},{"id":16941},"api-gateway-and-the-lambda-proxy-pattern",[16943],{"type":55,"value":16944},"API Gateway and the Lambda proxy pattern",{"type":49,"tag":58,"props":16946,"children":16947},{},[16948,16950,16957,16959,16965,16967,16974],{"type":55,"value":16949},"I first read about the Lambda proxy pattern in an article titled ",{"type":49,"tag":80,"props":16951,"children":16954},{"href":16952,"rel":16953},"https://serverlessfirst.com/lambda-vpc-internet-access-no-nat-gateway/",[84],[16955],{"type":55,"value":16956},"How to access VPC and internet resources from Lambda without paying for a NAT Gateway",{"type":55,"value":16958}," on Paul Swail's website ",{"type":49,"tag":80,"props":16960,"children":16963},{"href":16961,"rel":16962},"https://serverlessfirst.com/",[84],[16964],{"type":55,"value":16961},{"type":55,"value":16966},". This site has tons of great serverless content, check out the ",{"type":49,"tag":80,"props":16968,"children":16971},{"href":16969,"rel":16970},"https://serverlessfirst.com/articles/",[84],[16972],{"type":55,"value":16973},"list of articles",{"type":55,"value":16975},". Thank you Paul for putting out great serverless resources!",{"type":49,"tag":58,"props":16977,"children":16978},{},[16979],{"type":55,"value":16980},"Let's take a look at the Proxy Lambda function next. The function itself is pretty straightforward:",{"type":49,"tag":1050,"props":16982,"children":16984},{"code":16983,"language":14057,"meta":8,"className":14058,"style":8},"import json\nimport os\nimport boto3\n\nlambda_client = boto3.client('lambda', region_name='us-east-1')\n\n\ndef handler(event, context):\n    invoke_response = lambda_client.invoke(\n        FunctionName=os.environ.get(\"FUNCTION_NAME\", None),\n        InvocationType='RequestResponse',\n        Payload=json.dumps(event),\n    )\n\n    data = invoke_response['Payload'].read()\n\n    return data\n",[16985],{"type":49,"tag":326,"props":16986,"children":16987},{"__ignoreMap":8},[16988,17000,17012,17024,17031,17075,17082,17089,17120,17137,17172,17193,17210,17218,17225,17252,17259],{"type":49,"tag":1060,"props":16989,"children":16990},{"class":1062,"line":1063},[16991,16995],{"type":49,"tag":1060,"props":16992,"children":16993},{"style":2194},[16994],{"type":55,"value":14080},{"type":49,"tag":1060,"props":16996,"children":16997},{"style":1073},[16998],{"type":55,"value":16999}," json\n",{"type":49,"tag":1060,"props":17001,"children":17002},{"class":1062,"line":1079},[17003,17007],{"type":49,"tag":1060,"props":17004,"children":17005},{"style":2194},[17006],{"type":55,"value":14080},{"type":49,"tag":1060,"props":17008,"children":17009},{"style":1073},[17010],{"type":55,"value":17011}," os\n",{"type":49,"tag":1060,"props":17013,"children":17014},{"class":1062,"line":1088},[17015,17019],{"type":49,"tag":1060,"props":17016,"children":17017},{"style":2194},[17018],{"type":55,"value":14080},{"type":49,"tag":1060,"props":17020,"children":17021},{"style":1073},[17022],{"type":55,"value":17023}," boto3\n",{"type":49,"tag":1060,"props":17025,"children":17026},{"class":1062,"line":1097},[17027],{"type":49,"tag":1060,"props":17028,"children":17029},{"emptyLinePlaceholder":44},[17030],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17032,"children":17033},{"class":1062,"line":1111},[17034,17039,17043,17048,17053,17057,17062,17066,17071],{"type":49,"tag":1060,"props":17035,"children":17036},{"style":1073},[17037],{"type":55,"value":17038},"lambda_client ",{"type":49,"tag":1060,"props":17040,"children":17041},{"style":2194},[17042],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17044,"children":17045},{"style":1073},[17046],{"type":55,"value":17047}," boto3.client(",{"type":49,"tag":1060,"props":17049,"children":17050},{"style":2215},[17051],{"type":55,"value":17052},"'lambda'",{"type":49,"tag":1060,"props":17054,"children":17055},{"style":1073},[17056],{"type":55,"value":873},{"type":49,"tag":1060,"props":17058,"children":17059},{"style":14522},[17060],{"type":55,"value":17061},"region_name",{"type":49,"tag":1060,"props":17063,"children":17064},{"style":2194},[17065],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17067,"children":17068},{"style":2215},[17069],{"type":55,"value":17070},"'us-east-1'",{"type":49,"tag":1060,"props":17072,"children":17073},{"style":1073},[17074],{"type":55,"value":5126},{"type":49,"tag":1060,"props":17076,"children":17077},{"class":1062,"line":1120},[17078],{"type":49,"tag":1060,"props":17079,"children":17080},{"emptyLinePlaceholder":44},[17081],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17083,"children":17084},{"class":1062,"line":1128},[17085],{"type":49,"tag":1060,"props":17086,"children":17087},{"emptyLinePlaceholder":44},[17088],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17090,"children":17091},{"class":1062,"line":1141},[17092,17096,17100,17104,17108,17112,17116],{"type":49,"tag":1060,"props":17093,"children":17094},{"style":2182},[17095],{"type":55,"value":14100},{"type":49,"tag":1060,"props":17097,"children":17098},{"style":1067},[17099],{"type":55,"value":14105},{"type":49,"tag":1060,"props":17101,"children":17102},{"style":1073},[17103],{"type":55,"value":2284},{"type":49,"tag":1060,"props":17105,"children":17106},{"style":14112},[17107],{"type":55,"value":14115},{"type":49,"tag":1060,"props":17109,"children":17110},{"style":1073},[17111],{"type":55,"value":873},{"type":49,"tag":1060,"props":17113,"children":17114},{"style":14112},[17115],{"type":55,"value":14124},{"type":49,"tag":1060,"props":17117,"children":17118},{"style":1073},[17119],{"type":55,"value":14129},{"type":49,"tag":1060,"props":17121,"children":17122},{"class":1062,"line":1150},[17123,17128,17132],{"type":49,"tag":1060,"props":17124,"children":17125},{"style":1073},[17126],{"type":55,"value":17127},"    invoke_response ",{"type":49,"tag":1060,"props":17129,"children":17130},{"style":2194},[17131],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17133,"children":17134},{"style":1073},[17135],{"type":55,"value":17136}," lambda_client.invoke(\n",{"type":49,"tag":1060,"props":17138,"children":17139},{"class":1062,"line":1158},[17140,17145,17149,17154,17159,17163,17168],{"type":49,"tag":1060,"props":17141,"children":17142},{"style":14522},[17143],{"type":55,"value":17144},"        FunctionName",{"type":49,"tag":1060,"props":17146,"children":17147},{"style":2194},[17148],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17150,"children":17151},{"style":1073},[17152],{"type":55,"value":17153},"os.environ.get(",{"type":49,"tag":1060,"props":17155,"children":17156},{"style":2215},[17157],{"type":55,"value":17158},"\"FUNCTION_NAME\"",{"type":49,"tag":1060,"props":17160,"children":17161},{"style":1073},[17162],{"type":55,"value":873},{"type":49,"tag":1060,"props":17164,"children":17165},{"style":2287},[17166],{"type":55,"value":17167},"None",{"type":49,"tag":1060,"props":17169,"children":17170},{"style":1073},[17171],{"type":55,"value":15202},{"type":49,"tag":1060,"props":17173,"children":17174},{"class":1062,"line":1171},[17175,17180,17184,17189],{"type":49,"tag":1060,"props":17176,"children":17177},{"style":14522},[17178],{"type":55,"value":17179},"        InvocationType",{"type":49,"tag":1060,"props":17181,"children":17182},{"style":2194},[17183],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17185,"children":17186},{"style":2215},[17187],{"type":55,"value":17188},"'RequestResponse'",{"type":49,"tag":1060,"props":17190,"children":17191},{"style":1073},[17192],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17194,"children":17195},{"class":1062,"line":1180},[17196,17201,17205],{"type":49,"tag":1060,"props":17197,"children":17198},{"style":14522},[17199],{"type":55,"value":17200},"        Payload",{"type":49,"tag":1060,"props":17202,"children":17203},{"style":2194},[17204],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17206,"children":17207},{"style":1073},[17208],{"type":55,"value":17209},"json.dumps(event),\n",{"type":49,"tag":1060,"props":17211,"children":17212},{"class":1062,"line":1188},[17213],{"type":49,"tag":1060,"props":17214,"children":17215},{"style":1073},[17216],{"type":55,"value":17217},"    )\n",{"type":49,"tag":1060,"props":17219,"children":17220},{"class":1062,"line":1201},[17221],{"type":49,"tag":1060,"props":17222,"children":17223},{"emptyLinePlaceholder":44},[17224],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17226,"children":17227},{"class":1062,"line":1210},[17228,17233,17237,17242,17247],{"type":49,"tag":1060,"props":17229,"children":17230},{"style":1073},[17231],{"type":55,"value":17232},"    data ",{"type":49,"tag":1060,"props":17234,"children":17235},{"style":2194},[17236],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17238,"children":17239},{"style":1073},[17240],{"type":55,"value":17241}," invoke_response[",{"type":49,"tag":1060,"props":17243,"children":17244},{"style":2215},[17245],{"type":55,"value":17246},"'Payload'",{"type":49,"tag":1060,"props":17248,"children":17249},{"style":1073},[17250],{"type":55,"value":17251},"].read()\n",{"type":49,"tag":1060,"props":17253,"children":17254},{"class":1062,"line":1218},[17255],{"type":49,"tag":1060,"props":17256,"children":17257},{"emptyLinePlaceholder":44},[17258],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17260,"children":17261},{"class":1062,"line":1232},[17262,17267],{"type":49,"tag":1060,"props":17263,"children":17264},{"style":2194},[17265],{"type":55,"value":17266},"    return",{"type":49,"tag":1060,"props":17268,"children":17269},{"style":1073},[17270],{"type":55,"value":17271}," data\n",{"type":49,"tag":58,"props":17273,"children":17274},{},[17275],{"type":55,"value":17276},"There are just a few things to setup in our CDK code to make the proxy pattern work:",{"type":49,"tag":8994,"props":17278,"children":17279},{},[17280,17285,17290],{"type":49,"tag":68,"props":17281,"children":17282},{},[17283],{"type":55,"value":17284},"Define the Lambda function",{"type":49,"tag":68,"props":17286,"children":17287},{},[17288],{"type":55,"value":17289},"Give the proxy Lambda permission to invoke the Django Lambda",{"type":49,"tag":68,"props":17291,"children":17292},{},[17293,17295,17301,17303],{"type":55,"value":17294},"Define a ",{"type":49,"tag":326,"props":17296,"children":17298},{"className":17297},[],[17299],{"type":55,"value":17300},"LambdaRestApi",{"type":55,"value":17302}," construct with the Proxy Lambda as the ",{"type":49,"tag":326,"props":17304,"children":17306},{"className":17305},[],[17307],{"type":55,"value":14051},{"type":49,"tag":58,"props":17309,"children":17310},{},[17311],{"type":55,"value":17312},"Here's what that code looks like:",{"type":49,"tag":1050,"props":17314,"children":17316},{"code":17315,"language":14057,"meta":8,"className":14058,"style":8},"        self.proxy_lambda = _lambda.Function(\n            self,\n            \"ProxyLambda\",\n            code=_lambda.AssetCode(\"./awslambda\"),\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            layers=[self.djambda_layer],\n            handler=\"proxy_lambda.handler\",\n            timeout=core.Duration.seconds(60),\n            environment={\"FUNCTION_NAME\": self.djambda_lambda.function_name},\n        )\n\n        self.djambda_lambda.grant_invoke(self.proxy_lambda)\n\n        self.apigw = apigw.LambdaRestApi(\n            self, 'DjambdaEndpoint', handler=self.proxy_lambda,\n        )\n",[17317],{"type":49,"tag":326,"props":17318,"children":17319},{"__ignoreMap":8},[17320,17340,17351,17363,17387,17410,17433,17453,17476,17508,17515,17522,17543,17550,17571,17608],{"type":49,"tag":1060,"props":17321,"children":17322},{"class":1062,"line":1063},[17323,17327,17332,17336],{"type":49,"tag":1060,"props":17324,"children":17325},{"style":3797},[17326],{"type":55,"value":14803},{"type":49,"tag":1060,"props":17328,"children":17329},{"style":1073},[17330],{"type":55,"value":17331},".proxy_lambda ",{"type":49,"tag":1060,"props":17333,"children":17334},{"style":2194},[17335],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17337,"children":17338},{"style":1073},[17339],{"type":55,"value":15126},{"type":49,"tag":1060,"props":17341,"children":17342},{"class":1062,"line":1079},[17343,17347],{"type":49,"tag":1060,"props":17344,"children":17345},{"style":3797},[17346],{"type":55,"value":14825},{"type":49,"tag":1060,"props":17348,"children":17349},{"style":1073},[17350],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17352,"children":17353},{"class":1062,"line":1088},[17354,17359],{"type":49,"tag":1060,"props":17355,"children":17356},{"style":2215},[17357],{"type":55,"value":17358},"            \"ProxyLambda\"",{"type":49,"tag":1060,"props":17360,"children":17361},{"style":1073},[17362],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17364,"children":17365},{"class":1062,"line":1097},[17366,17370,17374,17378,17383],{"type":49,"tag":1060,"props":17367,"children":17368},{"style":14522},[17369],{"type":55,"value":15183},{"type":49,"tag":1060,"props":17371,"children":17372},{"style":2194},[17373],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17375,"children":17376},{"style":1073},[17377],{"type":55,"value":15192},{"type":49,"tag":1060,"props":17379,"children":17380},{"style":2215},[17381],{"type":55,"value":17382},"\"./awslambda\"",{"type":49,"tag":1060,"props":17384,"children":17385},{"style":1073},[17386],{"type":55,"value":15202},{"type":49,"tag":1060,"props":17388,"children":17389},{"class":1062,"line":1111},[17390,17394,17398,17402,17406],{"type":49,"tag":1060,"props":17391,"children":17392},{"style":14522},[17393],{"type":55,"value":15157},{"type":49,"tag":1060,"props":17395,"children":17396},{"style":2194},[17397],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17399,"children":17400},{"style":1073},[17401],{"type":55,"value":15166},{"type":49,"tag":1060,"props":17403,"children":17404},{"style":2287},[17405],{"type":55,"value":15171},{"type":49,"tag":1060,"props":17407,"children":17408},{"style":1073},[17409],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17411,"children":17412},{"class":1062,"line":1120},[17413,17417,17421,17425,17429],{"type":49,"tag":1060,"props":17414,"children":17415},{"style":14522},[17416],{"type":55,"value":15275},{"type":49,"tag":1060,"props":17418,"children":17419},{"style":2194},[17420],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17422,"children":17423},{"style":1073},[17424],{"type":55,"value":15284},{"type":49,"tag":1060,"props":17426,"children":17427},{"style":3797},[17428],{"type":55,"value":14851},{"type":49,"tag":1060,"props":17430,"children":17431},{"style":1073},[17432],{"type":55,"value":15293},{"type":49,"tag":1060,"props":17434,"children":17435},{"class":1062,"line":1128},[17436,17440,17444,17449],{"type":49,"tag":1060,"props":17437,"children":17438},{"style":14522},[17439],{"type":55,"value":15254},{"type":49,"tag":1060,"props":17441,"children":17442},{"style":2194},[17443],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17445,"children":17446},{"style":2215},[17447],{"type":55,"value":17448},"\"proxy_lambda.handler\"",{"type":49,"tag":1060,"props":17450,"children":17451},{"style":1073},[17452],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17454,"children":17455},{"class":1062,"line":1141},[17456,17460,17464,17468,17472],{"type":49,"tag":1060,"props":17457,"children":17458},{"style":14522},[17459],{"type":55,"value":15301},{"type":49,"tag":1060,"props":17461,"children":17462},{"style":2194},[17463],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17465,"children":17466},{"style":1073},[17467],{"type":55,"value":15310},{"type":49,"tag":1060,"props":17469,"children":17470},{"style":2287},[17471],{"type":55,"value":15315},{"type":49,"tag":1060,"props":17473,"children":17474},{"style":1073},[17475],{"type":55,"value":15202},{"type":49,"tag":1060,"props":17477,"children":17478},{"class":1062,"line":1150},[17479,17483,17487,17491,17495,17499,17503],{"type":49,"tag":1060,"props":17480,"children":17481},{"style":14522},[17482],{"type":55,"value":15383},{"type":49,"tag":1060,"props":17484,"children":17485},{"style":2194},[17486],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17488,"children":17489},{"style":1073},[17490],{"type":55,"value":15228},{"type":49,"tag":1060,"props":17492,"children":17493},{"style":2215},[17494],{"type":55,"value":17158},{"type":49,"tag":1060,"props":17496,"children":17497},{"style":1073},[17498],{"type":55,"value":78},{"type":49,"tag":1060,"props":17500,"children":17501},{"style":3797},[17502],{"type":55,"value":14851},{"type":49,"tag":1060,"props":17504,"children":17505},{"style":1073},[17506],{"type":55,"value":17507},".djambda_lambda.function_name},\n",{"type":49,"tag":1060,"props":17509,"children":17510},{"class":1062,"line":1158},[17511],{"type":49,"tag":1060,"props":17512,"children":17513},{"style":1073},[17514],{"type":55,"value":14864},{"type":49,"tag":1060,"props":17516,"children":17517},{"class":1062,"line":1171},[17518],{"type":49,"tag":1060,"props":17519,"children":17520},{"emptyLinePlaceholder":44},[17521],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17523,"children":17524},{"class":1062,"line":1180},[17525,17529,17534,17538],{"type":49,"tag":1060,"props":17526,"children":17527},{"style":3797},[17528],{"type":55,"value":14803},{"type":49,"tag":1060,"props":17530,"children":17531},{"style":1073},[17532],{"type":55,"value":17533},".djambda_lambda.grant_invoke(",{"type":49,"tag":1060,"props":17535,"children":17536},{"style":3797},[17537],{"type":55,"value":14851},{"type":49,"tag":1060,"props":17539,"children":17540},{"style":1073},[17541],{"type":55,"value":17542},".proxy_lambda)\n",{"type":49,"tag":1060,"props":17544,"children":17545},{"class":1062,"line":1188},[17546],{"type":49,"tag":1060,"props":17547,"children":17548},{"emptyLinePlaceholder":44},[17549],{"type":55,"value":1094},{"type":49,"tag":1060,"props":17551,"children":17552},{"class":1062,"line":1201},[17553,17557,17562,17566],{"type":49,"tag":1060,"props":17554,"children":17555},{"style":3797},[17556],{"type":55,"value":14803},{"type":49,"tag":1060,"props":17558,"children":17559},{"style":1073},[17560],{"type":55,"value":17561},".apigw ",{"type":49,"tag":1060,"props":17563,"children":17564},{"style":2194},[17565],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17567,"children":17568},{"style":1073},[17569],{"type":55,"value":17570}," apigw.LambdaRestApi(\n",{"type":49,"tag":1060,"props":17572,"children":17573},{"class":1062,"line":1210},[17574,17578,17582,17587,17591,17595,17599,17603],{"type":49,"tag":1060,"props":17575,"children":17576},{"style":3797},[17577],{"type":55,"value":14825},{"type":49,"tag":1060,"props":17579,"children":17580},{"style":1073},[17581],{"type":55,"value":873},{"type":49,"tag":1060,"props":17583,"children":17584},{"style":2215},[17585],{"type":55,"value":17586},"'DjambdaEndpoint'",{"type":49,"tag":1060,"props":17588,"children":17589},{"style":1073},[17590],{"type":55,"value":873},{"type":49,"tag":1060,"props":17592,"children":17593},{"style":14522},[17594],{"type":55,"value":14051},{"type":49,"tag":1060,"props":17596,"children":17597},{"style":2194},[17598],{"type":55,"value":3068},{"type":49,"tag":1060,"props":17600,"children":17601},{"style":3797},[17602],{"type":55,"value":14851},{"type":49,"tag":1060,"props":17604,"children":17605},{"style":1073},[17606],{"type":55,"value":17607},".proxy_lambda,\n",{"type":49,"tag":1060,"props":17609,"children":17610},{"class":1062,"line":1218},[17611],{"type":49,"tag":1060,"props":17612,"children":17613},{"style":1073},[17614],{"type":55,"value":14864},{"type":49,"tag":58,"props":17616,"children":17617},{},[17618,17620,17626],{"type":55,"value":17619},"That's it! We can now access our Django project at the API Gateway ",{"type":49,"tag":326,"props":17621,"children":17623},{"className":17622},[],[17624],{"type":55,"value":17625},"execute-api",{"type":55,"value":17627}," endpoint. This is a special URL that has the format:",{"type":49,"tag":1050,"props":17629,"children":17631},{"code":17630},"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n",[17632],{"type":49,"tag":326,"props":17633,"children":17634},{"__ignoreMap":8},[17635],{"type":55,"value":17630},{"type":49,"tag":64,"props":17637,"children":17638},{},[17639,17650,17662],{"type":49,"tag":68,"props":17640,"children":17641},{},[17642,17648],{"type":49,"tag":326,"props":17643,"children":17645},{"className":17644},[],[17646],{"type":55,"value":17647},"abc123",{"type":55,"value":17649}," is the id of the API Gateway that we created (you can find the value of this id in the API Gateway section of the AWS management console)]",{"type":49,"tag":68,"props":17651,"children":17652},{},[17653,17655,17660],{"type":55,"value":17654},"The region ",{"type":49,"tag":326,"props":17656,"children":17658},{"className":17657},[],[17659],{"type":55,"value":13111},{"type":55,"value":17661}," is the region where you deployed the API Gateway",{"type":49,"tag":68,"props":17663,"children":17664},{},[17665,17671],{"type":49,"tag":326,"props":17666,"children":17668},{"className":17667},[],[17669],{"type":55,"value":17670},"/prod",{"type":55,"value":17672}," is the stage name",{"type":49,"tag":58,"props":17674,"children":17675},{},[17676,17678,17683,17685,17690,17692,17697,17699,17705],{"type":55,"value":17677},"The stage name part is a little confusing for me. It is meant to be a URL suffix that indicates production, staging, etc., but I typically separate environments at the level of the CloudFormation stack, so all of my environments use the ",{"type":49,"tag":326,"props":17679,"children":17681},{"className":17680},[],[17682],{"type":55,"value":17670},{"type":55,"value":17684}," suffix. In order for Django to work properly, we need to tell it that our site will be served at this ",{"type":49,"tag":326,"props":17686,"children":17688},{"className":17687},[],[17689],{"type":55,"value":17670},{"type":55,"value":17691}," path (for example ",{"type":49,"tag":326,"props":17693,"children":17695},{"className":17694},[],[17696],{"type":55,"value":8640},{"type":55,"value":17698}," will now be served at ",{"type":49,"tag":326,"props":17700,"children":17702},{"className":17701},[],[17703],{"type":55,"value":17704},"/prod/admin",{"type":55,"value":17706},") by setting a special value in our settings module:",{"type":49,"tag":1050,"props":17708,"children":17710},{"code":17709,"language":14057,"meta":8,"className":14058,"style":8},"FORCE_SCRIPT_NAME = \"/prod\"\n",[17711],{"type":49,"tag":326,"props":17712,"children":17713},{"__ignoreMap":8},[17714],{"type":49,"tag":1060,"props":17715,"children":17716},{"class":1062,"line":1063},[17717,17722,17726],{"type":49,"tag":1060,"props":17718,"children":17719},{"style":2287},[17720],{"type":55,"value":17721},"FORCE_SCRIPT_NAME",{"type":49,"tag":1060,"props":17723,"children":17724},{"style":2194},[17725],{"type":55,"value":2197},{"type":49,"tag":1060,"props":17727,"children":17728},{"style":2215},[17729],{"type":55,"value":16854},{"type":49,"tag":58,"props":17731,"children":17732},{},[17733,17735,17741,17743,17748,17750,17755,17757,17762,17764,17770,17772,17777],{"type":55,"value":17734},"This will make dealing with URLs easier, mostly because we don't actually have to change anything in our ",{"type":49,"tag":326,"props":17736,"children":17738},{"className":17737},[],[17739],{"type":55,"value":17740},"urls.py",{"type":55,"value":17742},". I tried adding ",{"type":49,"tag":326,"props":17744,"children":17746},{"className":17745},[],[17747],{"type":55,"value":17670},{"type":55,"value":17749}," to my URL paths in ",{"type":49,"tag":326,"props":17751,"children":17753},{"className":17752},[],[17754],{"type":55,"value":17740},{"type":55,"value":17756},", but the Django admin doesn't work properly because going to ",{"type":49,"tag":326,"props":17758,"children":17760},{"className":17759},[],[17761],{"type":55,"value":17704},{"type":55,"value":17763}," will redirect you to ",{"type":49,"tag":326,"props":17765,"children":17767},{"className":17766},[],[17768],{"type":55,"value":17769},"/admin/login",{"type":55,"value":17771}," which will thrown an error with API Gateway since our application must be on the ",{"type":49,"tag":326,"props":17773,"children":17775},{"className":17774},[],[17776],{"type":55,"value":17670},{"type":55,"value":17778}," subpath.",{"type":49,"tag":50,"props":17780,"children":17782},{"id":17781},"setting-a-custom-url-for-api-gateway",[17783],{"type":55,"value":17784},"Setting a custom URL for API Gateway",{"type":49,"tag":58,"props":17786,"children":17787},{},[17788,17790,17796],{"type":55,"value":17789},"If you don't mind having a URL in the form of ",{"type":49,"tag":326,"props":17791,"children":17793},{"className":17792},[],[17794],{"type":55,"value":17795},"https://abc123.execute-api.us-east-1.amazonaws.com/prod",{"type":55,"value":17797},", then everything should be good to go. If you do want a custom URL for API Gateway, there are only two things you need to do:",{"type":49,"tag":8994,"props":17799,"children":17800},{},[17801,17806,17825,17830],{"type":49,"tag":68,"props":17802,"children":17803},{},[17804],{"type":55,"value":17805},"Get a domain and hosted zone set up in Route53 (this typically costs about $12/year)",{"type":49,"tag":68,"props":17807,"children":17808},{},[17809,17811,17816,17817,17823],{"type":55,"value":17810},"Add the ",{"type":49,"tag":326,"props":17812,"children":17814},{"className":17813},[],[17815],{"type":55,"value":13132},{"type":55,"value":6280},{"type":49,"tag":326,"props":17818,"children":17820},{"className":17819},[],[17821],{"type":55,"value":17822},"HOSTED_ZONE_ID",{"type":55,"value":17824}," to environment variables (see below for how to do this)",{"type":49,"tag":68,"props":17826,"children":17827},{},[17828],{"type":55,"value":17829},"Define an ACM certificate in our CDK code and",{"type":49,"tag":68,"props":17831,"children":17832},{},[17833,17834,17839,17841,17847],{"type":55,"value":13588},{"type":49,"tag":326,"props":17835,"children":17837},{"className":17836},[],[17838],{"type":55,"value":17300},{"type":55,"value":17840},"'s ",{"type":49,"tag":326,"props":17842,"children":17844},{"className":17843},[],[17845],{"type":55,"value":17846},"add_domain_name",{"type":55,"value":17848}," method to add the domain name and certificate to the API Gateway endpoint.",{"type":49,"tag":58,"props":17850,"children":17851},{},[17852,17854,17861,17863,17868],{"type":55,"value":17853},"Here's a ",{"type":49,"tag":80,"props":17855,"children":17858},{"href":17856,"rel":17857},"https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_apigateway/LambdaRestApi.html#aws_cdk.aws_apigateway.LambdaRestApi.add_domain_name",[84],[17859],{"type":55,"value":17860},"link to the CDK Python documentation",{"type":55,"value":17862}," on ",{"type":49,"tag":326,"props":17864,"children":17866},{"className":17865},[],[17867],{"type":55,"value":17846},{"type":55,"value":745},{"type":49,"tag":58,"props":17870,"children":17871},{},[17872,17874,17879],{"type":55,"value":17873},"When you configure a custom domain name, you don't need to set the ",{"type":49,"tag":326,"props":17875,"children":17877},{"className":17876},[],[17878],{"type":55,"value":17721},{"type":55,"value":17880}," setting in Django settings.",{"type":49,"tag":50,"props":17882,"children":17884},{"id":17883},"project-directory-structure",[17885],{"type":55,"value":17886},"Project directory structure",{"type":49,"tag":58,"props":17888,"children":17889},{},[17890,17892,17898],{"type":55,"value":17891},"Let's take a quick look at the structure of the project using ",{"type":49,"tag":326,"props":17893,"children":17895},{"className":17894},[],[17896],{"type":55,"value":17897},"tree",{"type":55,"value":6694},{"type":49,"tag":1050,"props":17900,"children":17902},{"code":17901},"tree -L 3 .\n.\n├── awscdk\n│   ├── app.py\n│   ├── awscdk\n│   │   ├── app_stack.py  \u003C----------------- CDK application overview\n│   │   ├── backend_assets.py\n│   │   ├── cert.py\n│   │   ├── cloudfront.py\n│   │   ├── hosted_zone.py\n│   │   ├── __init__.py\n│   │   ├── static_site_bucket.py\n│   │   └── vpc.py \u003C------------------------ VPC, Lambdas, API Gateway and more\n│   ├── cdk.json                             defined here\n│   ├── README.md\n│   ├── requirements.txt\n│   ├── setup.py\n│   └── source.bat\n├── awslambda\n│   └── proxy_lambda.py \u003C------------------- Proxy Lambda\n├── django\n│   ├── core \u003C------------------------------ A sample Django app\n│   │   ├── admin.py\n│   │   ├── apps.py\n│   │   ├── __init__.py\n│   │   ├── migrations\n│   │   ├── models.py\n│   │   ├── tests.py\n│   │   ├── urls.py\n│   │   └── views.py\n│   ├── djambda\n│   │   ├── asgi.py\n│   │   ├── awsgi.py \u003C---------------------- Django Lambda handler\n│   │   ├── __init__.py\n│   │   ├── settings.py \u003C------------------- Django settings (RDS connections, S3 static/media)\n│   │   ├── storage_backends.py\n│   │   ├── urls.py\n│   │   └── wsgi.py\n│   ├── manage.py\n│   └── requirements.txt\n├── layers \u003C-------------------------------- Lambda Layers (python dependencies)\n│   └── django                               Note: This folder is not committed to git\n│       └── python\n├── ARTICLE.md \u003C---------------------------- This article\n├── gitlab-ci.yml\n├── .variables \u003C---------------------------- Environment variables needed for deployment\n└── README.md\n",[17903],{"type":49,"tag":326,"props":17904,"children":17905},{"__ignoreMap":8},[17906],{"type":55,"value":17901},{"type":49,"tag":58,"props":17908,"children":17909},{},[17910,17912,17918,17919,17925,17926,17931],{"type":55,"value":17911},"The three top level folders are ",{"type":49,"tag":326,"props":17913,"children":17915},{"className":17914},[],[17916],{"type":55,"value":17917},"awscdk",{"type":55,"value":873},{"type":49,"tag":326,"props":17920,"children":17922},{"className":17921},[],[17923],{"type":55,"value":17924},"awslambda",{"type":55,"value":715},{"type":49,"tag":326,"props":17927,"children":17929},{"className":17928},[],[17930],{"type":55,"value":14},{"type":55,"value":17932},". To deploy our CDK code, we run the following command from the root of the project:",{"type":49,"tag":1050,"props":17934,"children":17936},{"code":17935,"language":2728,"meta":8,"className":2729,"style":8},"cdk deploy --app awscdk/app.py\n",[17937],{"type":49,"tag":326,"props":17938,"children":17939},{"__ignoreMap":8},[17940],{"type":49,"tag":1060,"props":17941,"children":17942},{"class":1062,"line":1063},[17943,17947,17952,17957],{"type":49,"tag":1060,"props":17944,"children":17945},{"style":1067},[17946],{"type":55,"value":15},{"type":49,"tag":1060,"props":17948,"children":17949},{"style":2215},[17950],{"type":55,"value":17951}," deploy",{"type":49,"tag":1060,"props":17953,"children":17954},{"style":2287},[17955],{"type":55,"value":17956}," --app",{"type":49,"tag":1060,"props":17958,"children":17959},{"style":2215},[17960],{"type":55,"value":17961}," awscdk/app.py\n",{"type":49,"tag":58,"props":17963,"children":17964},{},[17965,17967,17973,17975,17981,17983,17989,17990,17995],{"type":55,"value":17966},"We can also run ",{"type":49,"tag":326,"props":17968,"children":17970},{"className":17969},[],[17971],{"type":55,"value":17972},"cdk synth --app awscdk/app.py",{"type":55,"value":17974}," to preview changes to our CDK code by reviewing the CloudFormation templates generated by ",{"type":49,"tag":326,"props":17976,"children":17978},{"className":17977},[],[17979],{"type":55,"value":17980},"cdk synth",{"type":55,"value":17982},". Running the ",{"type":49,"tag":326,"props":17984,"children":17986},{"className":17985},[],[17987],{"type":55,"value":17988},"cdk deploy",{"type":55,"value":715},{"type":49,"tag":326,"props":17991,"children":17993},{"className":17992},[],[17994],{"type":55,"value":17980},{"type":55,"value":17996}," commands at root of the project means that we need to specificy lambda code assets from the root of the project as well. This is why the Django application's Lambda function references the code with:",{"type":49,"tag":1050,"props":17998,"children":18000},{"code":17999,"language":14057,"meta":8,"className":14058,"style":8},"code=_lambda.AssetCode('./django'),\n",[18001],{"type":49,"tag":326,"props":18002,"children":18003},{"__ignoreMap":8},[18004],{"type":49,"tag":1060,"props":18005,"children":18006},{"class":1062,"line":1063},[18007,18011,18015,18019,18023],{"type":49,"tag":1060,"props":18008,"children":18009},{"style":1073},[18010],{"type":55,"value":326},{"type":49,"tag":1060,"props":18012,"children":18013},{"style":2194},[18014],{"type":55,"value":3068},{"type":49,"tag":1060,"props":18016,"children":18017},{"style":1073},[18018],{"type":55,"value":15192},{"type":49,"tag":1060,"props":18020,"children":18021},{"style":2215},[18022],{"type":55,"value":15197},{"type":49,"tag":1060,"props":18024,"children":18025},{"style":1073},[18026],{"type":55,"value":15202},{"type":49,"tag":50,"props":18028,"children":18030},{"id":18029},"deploying",[18031],{"type":55,"value":18032},"Deploying",{"type":49,"tag":58,"props":18034,"children":18035},{},[18036],{"type":55,"value":18037},"CDK is easy to use both locally and in a CI/CD tool such as GitLab CI, my CI/CD tool of choice. There are a few things to coordinate when deploying in both of these environments:",{"type":49,"tag":8994,"props":18039,"children":18040},{},[18041,18046],{"type":49,"tag":68,"props":18042,"children":18043},{},[18044],{"type":55,"value":18045},"Environment variables",{"type":49,"tag":68,"props":18047,"children":18048},{},[18049],{"type":55,"value":18050},"Dependencies",{"type":49,"tag":430,"props":18052,"children":18054},{"id":18053},"deploying-from-a-terminal",[18055],{"type":55,"value":18056},"Deploying from a terminal",{"type":49,"tag":58,"props":18058,"children":18059},{},[18060,18062,18068],{"type":55,"value":18061},"If you are new to CDK, you will need to make sure that you have ran the ",{"type":49,"tag":326,"props":18063,"children":18065},{"className":18064},[],[18066],{"type":55,"value":18067},"cdk bootstrap",{"type":55,"value":18069}," command at least once on your account. This command sets up a CloudFormation stack that CDK uses internally to manage deployments.",{"type":49,"tag":58,"props":18071,"children":18072},{},[18073,18075,18081],{"type":55,"value":18074},"The environment variables needed for deployment are defined in ",{"type":49,"tag":326,"props":18076,"children":18078},{"className":18077},[],[18079],{"type":55,"value":18080},".variables.template",{"type":55,"value":6694},{"type":49,"tag":1050,"props":18083,"children":18085},{"code":18084},"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n",[18086],{"type":49,"tag":326,"props":18087,"children":18088},{"__ignoreMap":8},[18089],{"type":55,"value":18084},{"type":49,"tag":64,"props":18091,"children":18092},{},[18093,18119],{"type":49,"tag":68,"props":18094,"children":18095},{},[18096,18102,18104,18110,18112,18117],{"type":49,"tag":326,"props":18097,"children":18099},{"className":18098},[],[18100],{"type":55,"value":18101},"APP_NAME",{"type":55,"value":18103}," should be a URL compatible name, such as ",{"type":49,"tag":326,"props":18105,"children":18107},{"className":18106},[],[18108],{"type":55,"value":18109},"my-app",{"type":55,"value":18111}," (don't put ",{"type":49,"tag":326,"props":18113,"children":18115},{"className":18114},[],[18116],{"type":55,"value":745},{"type":55,"value":18118}," in this variable)",{"type":49,"tag":68,"props":18120,"children":18121},{},[18122,18127,18128,18133],{"type":49,"tag":326,"props":18123,"children":18125},{"className":18124},[],[18126],{"type":55,"value":13132},{"type":55,"value":715},{"type":49,"tag":326,"props":18129,"children":18131},{"className":18130},[],[18132],{"type":55,"value":17822},{"type":55,"value":18134}," are needed for adding a custom domain name to API Gateway",{"type":49,"tag":58,"props":18136,"children":18137},{},[18138,18140,18146],{"type":55,"value":18139},"Copy this template into a file in the root of the project called ",{"type":49,"tag":326,"props":18141,"children":18143},{"className":18142},[],[18144],{"type":55,"value":18145},".variables",{"type":55,"value":18147}," and set these environment variables with the following command:",{"type":49,"tag":1050,"props":18149,"children":18151},{"code":18150},". .variables\n",[18152],{"type":49,"tag":326,"props":18153,"children":18154},{"__ignoreMap":8},[18155],{"type":55,"value":18150},{"type":49,"tag":58,"props":18157,"children":18158},{},[18159,18161,18167],{"type":55,"value":18160},"Next, we need to install our Python dependencies locally with the ",{"type":49,"tag":326,"props":18162,"children":18164},{"className":18163},[],[18165],{"type":55,"value":18166},"-t",{"type":55,"value":18168}," target flag so that the Lambda layers we define in CDK can find the files needed to be packaged into our Lambda layer and made available to our Lambda function at runtime. Install dependencies to the target directory by running the following command from the root of the project:",{"type":49,"tag":1050,"props":18170,"children":18172},{"code":18171},"pip install -r django/requirements.txt -t layers/django/python\n",[18173],{"type":49,"tag":326,"props":18174,"children":18175},{"__ignoreMap":8},[18176],{"type":55,"value":18171},{"type":49,"tag":58,"props":18178,"children":18179},{},[18180],{"type":55,"value":18181},"Now we can deploy our serverless application to AWS using CDK. First, activate the CDK Python virtual environment with:",{"type":49,"tag":1050,"props":18183,"children":18185},{"code":18184},"source awscdk/.env/bin/activate\n",[18186],{"type":49,"tag":326,"props":18187,"children":18188},{"__ignoreMap":8},[18189],{"type":55,"value":18184},{"type":49,"tag":58,"props":18191,"children":18192},{},[18193,18195,18201],{"type":55,"value":18194},"Also make sure that you are using a version of Node.js greater or equal to 10. I do this with ",{"type":49,"tag":326,"props":18196,"children":18198},{"className":18197},[],[18199],{"type":55,"value":18200},"nvm use 13",{"type":55,"value":745},{"type":49,"tag":58,"props":18203,"children":18204},{},[18205,18207,18213],{"type":55,"value":18206},"Make sure that all of the dependencies defined in ",{"type":49,"tag":326,"props":18208,"children":18210},{"className":18209},[],[18211],{"type":55,"value":18212},"awscdk/setup.py",{"type":55,"value":18214}," are up-to-date. Make sure that there are no issues witht the CDK code by running:",{"type":49,"tag":1050,"props":18216,"children":18218},{"code":18217},"cdk synth --app awscdk/app.py\n",[18219],{"type":49,"tag":326,"props":18220,"children":18221},{"__ignoreMap":8},[18222],{"type":55,"value":18217},{"type":49,"tag":58,"props":18224,"children":18225},{},[18226,18228,18234],{"type":55,"value":18227},"Inspect the contents of ",{"type":49,"tag":326,"props":18229,"children":18231},{"className":18230},[],[18232],{"type":55,"value":18233},"cdk.out",{"type":55,"value":18235},"; these are the CloudFormation templates generated by CDK that will be used to deploy all of our resources. If everything looks good to go, deploy with the following command:",{"type":49,"tag":1050,"props":18237,"children":18238},{"code":18217},[18239],{"type":49,"tag":326,"props":18240,"children":18241},{"__ignoreMap":8},[18242],{"type":55,"value":18217},{"type":49,"tag":58,"props":18244,"children":18245},{},[18246],{"type":55,"value":18247},"Follow the output of this command and ensure that it completes successfully. You can also follow along in the CloudFormation section of the AWS management console to make sure that things are deploying properly.",{"type":49,"tag":58,"props":18249,"children":18250},{},[18251,18253,18258,18259,18264,18265,18271],{"type":55,"value":18252},"Once everything has finished deploying, you will need to run ",{"type":49,"tag":326,"props":18254,"children":18256},{"className":18255},[],[18257],{"type":55,"value":3323},{"type":55,"value":873},{"type":49,"tag":326,"props":18260,"children":18262},{"className":18261},[],[18263],{"type":55,"value":14596},{"type":55,"value":715},{"type":49,"tag":326,"props":18266,"children":18268},{"className":18267},[],[18269],{"type":55,"value":18270},"collecstatic",{"type":55,"value":18272}," after the first deployment.",{"type":49,"tag":2910,"props":18274,"children":18275},{},[18276],{"type":49,"tag":58,"props":18277,"children":18278},{},[18279],{"type":55,"value":18280},"TODO: consolidate these steps with a Makefile or bash script",{"type":49,"tag":430,"props":18282,"children":18284},{"id":18283},"deploying-with-gitlab-ci",[18285],{"type":55,"value":18286},"Deploying with GitLab CI",{"type":49,"tag":58,"props":18288,"children":18289},{},[18290],{"type":55,"value":18291},"Deploying locally is fine, but it is better to run CDK commands from a CI/CD process so we can keep track of the commits, pipeline results, commit messages, etc. The process is very similar to everything we do locally, but you will need to add environment variables to the GitLab project's Settings > CI/CD > Variables. I have broken out dependency installation into a separate stage. This is not entirely necessary, but it helps keep things easy to follow:",{"type":49,"tag":1050,"props":18293,"children":18295},{"code":18294,"language":3823,"meta":8,"className":3824,"style":8},"pip_install:\n  stage: build\n  artifacts:\n    paths:\n      - layers/django/python\n  script:\n    - pip install -r django/requirements.txt -t layers/django/python\n\ncdk_deploy:\n  stage: deploy\n  before_script:\n    - apt-get -qq update && apt-get -y install nodejs npm\n    - npm i -g aws-cdk\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n",[18296],{"type":49,"tag":326,"props":18297,"children":18298},{"__ignoreMap":8},[18299,18311,18328,18340,18352,18364,18376,18387,18394,18406,18422,18434,18446,18458,18470,18481,18493],{"type":49,"tag":1060,"props":18300,"children":18301},{"class":1062,"line":1063},[18302,18307],{"type":49,"tag":1060,"props":18303,"children":18304},{"style":3839},[18305],{"type":55,"value":18306},"pip_install",{"type":49,"tag":1060,"props":18308,"children":18309},{"style":1073},[18310],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18312,"children":18313},{"class":1062,"line":1079},[18314,18319,18323],{"type":49,"tag":1060,"props":18315,"children":18316},{"style":3839},[18317],{"type":55,"value":18318},"  stage",{"type":49,"tag":1060,"props":18320,"children":18321},{"style":1073},[18322],{"type":55,"value":78},{"type":49,"tag":1060,"props":18324,"children":18325},{"style":2215},[18326],{"type":55,"value":18327},"build\n",{"type":49,"tag":1060,"props":18329,"children":18330},{"class":1062,"line":1088},[18331,18336],{"type":49,"tag":1060,"props":18332,"children":18333},{"style":3839},[18334],{"type":55,"value":18335},"  artifacts",{"type":49,"tag":1060,"props":18337,"children":18338},{"style":1073},[18339],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18341,"children":18342},{"class":1062,"line":1097},[18343,18348],{"type":49,"tag":1060,"props":18344,"children":18345},{"style":3839},[18346],{"type":55,"value":18347},"    paths",{"type":49,"tag":1060,"props":18349,"children":18350},{"style":1073},[18351],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18353,"children":18354},{"class":1062,"line":1111},[18355,18359],{"type":49,"tag":1060,"props":18356,"children":18357},{"style":1073},[18358],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18360,"children":18361},{"style":2215},[18362],{"type":55,"value":18363},"layers/django/python\n",{"type":49,"tag":1060,"props":18365,"children":18366},{"class":1062,"line":1120},[18367,18372],{"type":49,"tag":1060,"props":18368,"children":18369},{"style":3839},[18370],{"type":55,"value":18371},"  script",{"type":49,"tag":1060,"props":18373,"children":18374},{"style":1073},[18375],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18377,"children":18378},{"class":1062,"line":1128},[18379,18383],{"type":49,"tag":1060,"props":18380,"children":18381},{"style":1073},[18382],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18384,"children":18385},{"style":2215},[18386],{"type":55,"value":18171},{"type":49,"tag":1060,"props":18388,"children":18389},{"class":1062,"line":1141},[18390],{"type":49,"tag":1060,"props":18391,"children":18392},{"emptyLinePlaceholder":44},[18393],{"type":55,"value":1094},{"type":49,"tag":1060,"props":18395,"children":18396},{"class":1062,"line":1150},[18397,18402],{"type":49,"tag":1060,"props":18398,"children":18399},{"style":3839},[18400],{"type":55,"value":18401},"cdk_deploy",{"type":49,"tag":1060,"props":18403,"children":18404},{"style":1073},[18405],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18407,"children":18408},{"class":1062,"line":1158},[18409,18413,18417],{"type":49,"tag":1060,"props":18410,"children":18411},{"style":3839},[18412],{"type":55,"value":18318},{"type":49,"tag":1060,"props":18414,"children":18415},{"style":1073},[18416],{"type":55,"value":78},{"type":49,"tag":1060,"props":18418,"children":18419},{"style":2215},[18420],{"type":55,"value":18421},"deploy\n",{"type":49,"tag":1060,"props":18423,"children":18424},{"class":1062,"line":1171},[18425,18430],{"type":49,"tag":1060,"props":18426,"children":18427},{"style":3839},[18428],{"type":55,"value":18429},"  before_script",{"type":49,"tag":1060,"props":18431,"children":18432},{"style":1073},[18433],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18435,"children":18436},{"class":1062,"line":1180},[18437,18441],{"type":49,"tag":1060,"props":18438,"children":18439},{"style":1073},[18440],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18442,"children":18443},{"style":2215},[18444],{"type":55,"value":18445},"apt-get -qq update && apt-get -y install nodejs npm\n",{"type":49,"tag":1060,"props":18447,"children":18448},{"class":1062,"line":1188},[18449,18453],{"type":49,"tag":1060,"props":18450,"children":18451},{"style":1073},[18452],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18454,"children":18455},{"style":2215},[18456],{"type":55,"value":18457},"npm i -g aws-cdk\n",{"type":49,"tag":1060,"props":18459,"children":18460},{"class":1062,"line":1201},[18461,18465],{"type":49,"tag":1060,"props":18462,"children":18463},{"style":1073},[18464],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18466,"children":18467},{"style":2215},[18468],{"type":55,"value":18469},"pip3 install -e awscdk\n",{"type":49,"tag":1060,"props":18471,"children":18472},{"class":1062,"line":1210},[18473,18477],{"type":49,"tag":1060,"props":18474,"children":18475},{"style":3839},[18476],{"type":55,"value":18371},{"type":49,"tag":1060,"props":18478,"children":18479},{"style":1073},[18480],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18482,"children":18483},{"class":1062,"line":1218},[18484,18488],{"type":49,"tag":1060,"props":18485,"children":18486},{"style":1073},[18487],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18489,"children":18490},{"style":2215},[18491],{"type":55,"value":18492},"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n",{"type":49,"tag":1060,"props":18494,"children":18495},{"class":1062,"line":1232},[18496,18500],{"type":49,"tag":1060,"props":18497,"children":18498},{"style":1073},[18499],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18501,"children":18502},{"style":2215},[18503],{"type":55,"value":18504},"cdk deploy --app awscdk/app.py --require-approval never\n",{"type":49,"tag":58,"props":18506,"children":18507},{},[18508,18510,18516],{"type":55,"value":18509},"For management commands, we use a ",{"type":49,"tag":326,"props":18511,"children":18513},{"className":18512},[],[18514],{"type":55,"value":18515},".base_task",{"type":55,"value":18517}," template and reuse this for each command:",{"type":49,"tag":1050,"props":18519,"children":18521},{"code":18520,"language":3823,"meta":8,"className":3824,"style":8},".base_task: &task\n  image: python:3.8\n  stage: deploy\n  rules:\n    - when: manual\n  before_script:\n    - pip install awscli\n  after_script:\n    - cat invoke_response.json\n\nmigrate:\n  \u003C\u003C: *task\n  script:\n    - |\n      aws lambda invoke \\\n        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n        --payload '{\"manage\": \"migrate --no-input\"}' \\\n        invoke_response.json\n",[18522],{"type":49,"tag":326,"props":18523,"children":18524},{"__ignoreMap":8},[18525,18546,18563,18578,18590,18611,18622,18634,18646,18658,18665,18676,18696,18707,18718,18726,18734,18742],{"type":49,"tag":1060,"props":18526,"children":18527},{"class":1062,"line":1063},[18528,18532,18536,18541],{"type":49,"tag":1060,"props":18529,"children":18530},{"style":3839},[18531],{"type":55,"value":18515},{"type":49,"tag":1060,"props":18533,"children":18534},{"style":1073},[18535],{"type":55,"value":78},{"type":49,"tag":1060,"props":18537,"children":18538},{"style":2194},[18539],{"type":55,"value":18540},"&",{"type":49,"tag":1060,"props":18542,"children":18543},{"style":3992},[18544],{"type":55,"value":18545},"task\n",{"type":49,"tag":1060,"props":18547,"children":18548},{"class":1062,"line":1079},[18549,18554,18558],{"type":49,"tag":1060,"props":18550,"children":18551},{"style":3839},[18552],{"type":55,"value":18553},"  image",{"type":49,"tag":1060,"props":18555,"children":18556},{"style":1073},[18557],{"type":55,"value":78},{"type":49,"tag":1060,"props":18559,"children":18560},{"style":2215},[18561],{"type":55,"value":18562},"python:3.8\n",{"type":49,"tag":1060,"props":18564,"children":18565},{"class":1062,"line":1088},[18566,18570,18574],{"type":49,"tag":1060,"props":18567,"children":18568},{"style":3839},[18569],{"type":55,"value":18318},{"type":49,"tag":1060,"props":18571,"children":18572},{"style":1073},[18573],{"type":55,"value":78},{"type":49,"tag":1060,"props":18575,"children":18576},{"style":2215},[18577],{"type":55,"value":18421},{"type":49,"tag":1060,"props":18579,"children":18580},{"class":1062,"line":1097},[18581,18586],{"type":49,"tag":1060,"props":18582,"children":18583},{"style":3839},[18584],{"type":55,"value":18585},"  rules",{"type":49,"tag":1060,"props":18587,"children":18588},{"style":1073},[18589],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18591,"children":18592},{"class":1062,"line":1111},[18593,18597,18602,18606],{"type":49,"tag":1060,"props":18594,"children":18595},{"style":1073},[18596],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18598,"children":18599},{"style":3839},[18600],{"type":55,"value":18601},"when",{"type":49,"tag":1060,"props":18603,"children":18604},{"style":1073},[18605],{"type":55,"value":78},{"type":49,"tag":1060,"props":18607,"children":18608},{"style":2215},[18609],{"type":55,"value":18610},"manual\n",{"type":49,"tag":1060,"props":18612,"children":18613},{"class":1062,"line":1120},[18614,18618],{"type":49,"tag":1060,"props":18615,"children":18616},{"style":3839},[18617],{"type":55,"value":18429},{"type":49,"tag":1060,"props":18619,"children":18620},{"style":1073},[18621],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18623,"children":18624},{"class":1062,"line":1128},[18625,18629],{"type":49,"tag":1060,"props":18626,"children":18627},{"style":1073},[18628],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18630,"children":18631},{"style":2215},[18632],{"type":55,"value":18633},"pip install awscli\n",{"type":49,"tag":1060,"props":18635,"children":18636},{"class":1062,"line":1141},[18637,18642],{"type":49,"tag":1060,"props":18638,"children":18639},{"style":3839},[18640],{"type":55,"value":18641},"  after_script",{"type":49,"tag":1060,"props":18643,"children":18644},{"style":1073},[18645],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18647,"children":18648},{"class":1062,"line":1150},[18649,18653],{"type":49,"tag":1060,"props":18650,"children":18651},{"style":1073},[18652],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18654,"children":18655},{"style":2215},[18656],{"type":55,"value":18657},"cat invoke_response.json\n",{"type":49,"tag":1060,"props":18659,"children":18660},{"class":1062,"line":1158},[18661],{"type":49,"tag":1060,"props":18662,"children":18663},{"emptyLinePlaceholder":44},[18664],{"type":55,"value":1094},{"type":49,"tag":1060,"props":18666,"children":18667},{"class":1062,"line":1171},[18668,18672],{"type":49,"tag":1060,"props":18669,"children":18670},{"style":3839},[18671],{"type":55,"value":3323},{"type":49,"tag":1060,"props":18673,"children":18674},{"style":1073},[18675],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18677,"children":18678},{"class":1062,"line":1180},[18679,18684,18688,18692],{"type":49,"tag":1060,"props":18680,"children":18681},{"style":2287},[18682],{"type":55,"value":18683},"  \u003C\u003C",{"type":49,"tag":1060,"props":18685,"children":18686},{"style":1073},[18687],{"type":55,"value":78},{"type":49,"tag":1060,"props":18689,"children":18690},{"style":2194},[18691],{"type":55,"value":14495},{"type":49,"tag":1060,"props":18693,"children":18694},{"style":1073},[18695],{"type":55,"value":18545},{"type":49,"tag":1060,"props":18697,"children":18698},{"class":1062,"line":1188},[18699,18703],{"type":49,"tag":1060,"props":18700,"children":18701},{"style":3839},[18702],{"type":55,"value":18371},{"type":49,"tag":1060,"props":18704,"children":18705},{"style":1073},[18706],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18708,"children":18709},{"class":1062,"line":1201},[18710,18714],{"type":49,"tag":1060,"props":18711,"children":18712},{"style":1073},[18713],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18715,"children":18716},{"style":2194},[18717],{"type":55,"value":3884},{"type":49,"tag":1060,"props":18719,"children":18720},{"class":1062,"line":1210},[18721],{"type":49,"tag":1060,"props":18722,"children":18723},{"style":2215},[18724],{"type":55,"value":18725},"      aws lambda invoke \\\n",{"type":49,"tag":1060,"props":18727,"children":18728},{"class":1062,"line":1218},[18729],{"type":49,"tag":1060,"props":18730,"children":18731},{"style":2215},[18732],{"type":55,"value":18733},"        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n",{"type":49,"tag":1060,"props":18735,"children":18736},{"class":1062,"line":1232},[18737],{"type":49,"tag":1060,"props":18738,"children":18739},{"style":2215},[18740],{"type":55,"value":18741},"        --payload '{\"manage\": \"migrate --no-input\"}' \\\n",{"type":49,"tag":1060,"props":18743,"children":18744},{"class":1062,"line":1241},[18745],{"type":49,"tag":1060,"props":18746,"children":18747},{"style":2215},[18748],{"type":55,"value":18749},"        invoke_response.json\n",{"type":49,"tag":58,"props":18751,"children":18752},{},[18753,18755,18761],{"type":55,"value":18754},"These are ",{"type":49,"tag":326,"props":18756,"children":18758},{"className":18757},[],[18759],{"type":55,"value":18760},"manual",{"type":55,"value":18762}," commands, and can be started through the GitLab CI interface by pressing the \"Play\" button on the pipeline.",{"type":49,"tag":50,"props":18764,"children":18766},{"id":18765},"next-steps",[18767],{"type":55,"value":18768},"Next Steps",{"type":49,"tag":58,"props":18770,"children":18771},{},[18772],{"type":55,"value":18773},"I still have lots of ideas and things to try out with this Django/Lambda architecture. Here are a few things that would be good to try:",{"type":49,"tag":64,"props":18775,"children":18776},{},[18777,18797,18810,18823,18844,18872],{"type":49,"tag":68,"props":18778,"children":18779},{},[18780,18782,18788,18789,18795],{"type":55,"value":18781},"Using another Lambda function that proxies web requests to a Lambda outside of the VPC for basic network requests using either ",{"type":49,"tag":326,"props":18783,"children":18785},{"className":18784},[],[18786],{"type":55,"value":18787},"urllib.request",{"type":55,"value":8634},{"type":49,"tag":326,"props":18790,"children":18792},{"className":18791},[],[18793],{"type":55,"value":18794},"requests",{"type":55,"value":18796},". This would be the easiest way to add simple internet access without needing a NAT Gateway",{"type":49,"tag":68,"props":18798,"children":18799},{},[18800,18802,18808],{"type":55,"value":18801},"Use a NAT provider to add a cheap NAT instance using a ",{"type":49,"tag":326,"props":18803,"children":18805},{"className":18804},[],[18806],{"type":55,"value":18807},"t3a.nano",{"type":55,"value":18809}," instance ( about $5.00/month) to allow for internet access in the Django request/response cycle",{"type":49,"tag":68,"props":18811,"children":18812},{},[18813,18815,18821],{"type":55,"value":18814},"Figure out a good solution for async processing. Zappa has a ",{"type":49,"tag":326,"props":18816,"children":18818},{"className":18817},[],[18819],{"type":55,"value":18820},"@task",{"type":55,"value":18822}," wrapper that allows you to run tasks asynchronously in separate Lambda functions. It would be interesting to experiment with direct invocation of async tasks as well as task queueing with SQS. Using SQS would involve a VPC Endpoint which does cost extra, or we could setup a dedicated SQS proxy function to do this in a way similar to how we would handle requests.",{"type":49,"tag":68,"props":18824,"children":18825},{},[18826,18828,18833,18835,18842],{"type":55,"value":18827},"Lambda tuning. I'm pretty new to using Lambda and I would like to better understand how to fine-tune Lambda settings. There are lots of options in the ",{"type":49,"tag":326,"props":18829,"children":18831},{"className":18830},[],[18832],{"type":55,"value":15591},{"type":55,"value":18834}," construct, which would be a good place to start. This would be especially important for async tasks that require high memeory. From the ",{"type":49,"tag":80,"props":18836,"children":18839},{"href":18837,"rel":18838},"https://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf",[84],[18840],{"type":55,"value":18841},"Lambda Developer Guide",{"type":55,"value":18843}," it looks like memory can be configured from 128 MB to 3,008 MB in 64 MB increments.",{"type":49,"tag":68,"props":18845,"children":18846},{},[18847,18849,18854,18856,18862,18864,18870],{"type":55,"value":18848},"I typically setup Vue.js frontends with S3/CloudFront and use Django only for the admin and API with Django REST Framework. From what I understand, API Gateway uses CloudFront in the backround to do custom domains, but you don't have access to this CloudFront distribution. You can add the ",{"type":49,"tag":326,"props":18850,"children":18852},{"className":18851},[],[18853],{"type":55,"value":17625},{"type":55,"value":18855}," URL as a Custom Origin for a single CloudFront distribution, or keep a CloudFront distribution separate from the API Gateway custom domain and serve these on different subdomains, such as ",{"type":49,"tag":326,"props":18857,"children":18859},{"className":18858},[],[18860],{"type":55,"value":18861},"api.mysite.com",{"type":55,"value":18863}," for the API Gateway domain name and ",{"type":49,"tag":326,"props":18865,"children":18867},{"className":18866},[],[18868],{"type":55,"value":18869},"mysite.com",{"type":55,"value":18871}," for the CloudFront distribution serving Vue.js files.",{"type":49,"tag":68,"props":18873,"children":18874},{},[18875,18877],{"type":55,"value":18876},"Pricing. I'm still unsure about exactly how much this setup costs. The only major costs should be Aurora Postgres Serverless if it is used heavily, but I'm still not sure about how the pricing for this service works. Here's an in-depth article from Jeremy Daly that has more information on Aurora Serverless: ",{"type":49,"tag":80,"props":18878,"children":18881},{"href":18879,"rel":18880},"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/",[84],[18882],{"type":55,"value":18879},{"type":49,"tag":58,"props":18884,"children":18885},{},[18886],{"type":55,"value":18887},"Thanks for reading!",{"type":49,"tag":7749,"props":18889,"children":18890},{},[18891],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":18893},[18894,18895,18896,18897,18898,18899,18900,18901,18902,18906],{"id":52,"depth":1079,"text":56},{"id":13956,"depth":1079,"text":13959},{"id":14012,"depth":1079,"text":14015},{"id":1929,"depth":1079,"text":2027},{"id":16012,"depth":1079,"text":2012},{"id":16941,"depth":1079,"text":16944},{"id":17781,"depth":1079,"text":17784},{"id":17883,"depth":1079,"text":17886},{"id":18029,"depth":1079,"text":18032,"children":18903},[18904,18905],{"id":18053,"depth":1088,"text":18056},{"id":18283,"depth":1088,"text":18286},{"id":18765,"depth":1079,"text":18768},"content:2020:08:01:django-and-lambda-with-cdk-and-api-gateway.md","2020/08/01/django-and-lambda-with-cdk-and-api-gateway.md","2020/08/01/django-and-lambda-with-cdk-and-api-gateway",1723329681989]