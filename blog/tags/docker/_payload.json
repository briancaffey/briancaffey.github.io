[{"data":1,"prerenderedAt":26764},["ShallowReactive",2],{"/blog/tags/docker/":3},[4,7815,13922,14531,14762,19224,19327,20819,22145,22443,26148],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"date":11,"image":12,"tags":13,"draft":7,"external":25,"comments":44,"body":45,"_type":7809,"_id":7810,"_source":7811,"_file":7812,"_stem":7813,"_extension":7814},"/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","07",false,"","My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi","Three reusable infrastructure as code libraries for abstracting containerized web app architecture on AWS ECS","2023-01-07","/static/iac_rosetta_stone_og_image.png",[14,15,16,17,18,19,20,21,22,23,24],"django","cdk","terraform","pulumi","cloudformation","github-actions","aws","ecs","fargate","containers","docker",[26,29,32,35,38,41],{"link":27,"site":28},"https://news.ycombinator.com/item?id=34291336","hn",{"link":30,"site":31},"https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/","reddit",{"link":33,"site":34},"https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4","dev",{"link":36,"site":37},"https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a","medium",{"link":39,"site":40},"https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions","hashnode",{"link":42,"site":43},"https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta","substack",true,{"type":46,"children":47,"toc":7754},"root",[48,57,63,149,154,159,164,183,189,197,210,218,236,244,262,270,302,317,339,347,365,373,386,394,423,429,436,441,475,481,486,499,504,525,562,583,588,641,647,652,700,706,746,760,774,780,835,881,895,907,913,918,1037,1049,1269,1281,1286,1292,1332,1338,1343,1377,1404,1412,1420,1428,1436,1444,1452,1460,1468,1474,1486,1497,1505,1516,1524,1535,1543,1549,1554,1587,1592,1597,1606,1611,1617,1630,1670,1675,1718,1723,1756,1763,1775,1806,1818,1824,1829,1867,1872,1877,1891,1961,1966,1979,1985,1990,2033,2039,2052,2060,2066,2071,2084,2089,2095,2107,2137,2158,2163,2168,2355,2361,2366,2389,2394,2399,2405,2417,2422,2427,2609,2622,2630,2643,2681,2686,2691,2720,2725,2761,2767,2772,2825,2851,2857,2862,2867,2875,2881,2909,2926,2932,2944,3022,3027,3101,3109,3117,3123,3128,3149,3155,3160,3165,3171,3214,3219,3254,3259,3265,3278,3297,3303,3336,3354,3366,3427,3432,3815,3820,3964,3969,3974,3979,4715,4720,5038,5043,6012,6018,6023,6089,6095,6116,6131,6136,6190,6196,6201,6214,6219,6269,6289,6299,6429,6434,6597,6602,6652,6657,6822,6843,6965,6970,6976,6988,6993,7001,7013,7021,7027,7035,7062,7076,7094,7107,7112,7130,7135,7147,7153,7178,7184,7276,7289,7299,7304,7316,7322,7340,7366,7371,7377,7427,7433,7438,7614,7620,7625,7723,7728,7734,7748],{"type":49,"tag":50,"props":51,"children":53},"element","h2",{"id":52},"tldr",[54],{"type":55,"value":56},"text","tl;dr",{"type":49,"tag":58,"props":59,"children":60},"p",{},[61],{"type":55,"value":62},"I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions.",{"type":49,"tag":64,"props":65,"children":66},"ul",{},[67,88,104,120],{"type":49,"tag":68,"props":69,"children":70},"li",{},[71,77,79],{"type":49,"tag":72,"props":73,"children":74},"strong",{},[75],{"type":55,"value":76},"CDK Construct Library",{"type":55,"value":78},": ",{"type":49,"tag":80,"props":81,"children":85},"a",{"href":82,"rel":83},"https://github.com/briancaffey/cdk-django",[84],"nofollow",[86],{"type":55,"value":87},"github.com/briancaffey/cdk-django",{"type":49,"tag":68,"props":89,"children":90},{},[91,96,97],{"type":49,"tag":72,"props":92,"children":93},{},[94],{"type":55,"value":95},"Terraform Modules",{"type":55,"value":78},{"type":49,"tag":80,"props":98,"children":101},{"href":99,"rel":100},"https://github.com/briancaffey/terraform-aws-django",[84],[102],{"type":55,"value":103},"github.com/briancaffey/terraform-aws-django",{"type":49,"tag":68,"props":105,"children":106},{},[107,112,113],{"type":49,"tag":72,"props":108,"children":109},{},[110],{"type":55,"value":111},"Pulumi Component Library",{"type":55,"value":78},{"type":49,"tag":80,"props":114,"children":117},{"href":115,"rel":116},"https://github.com/briancaffey/pulumi-aws-django",[84],[118],{"type":55,"value":119},"github.com/briancaffey/pulumi-aws-django",{"type":49,"tag":68,"props":121,"children":122},{},[123,125,131,133,140,142],{"type":55,"value":124},"Mono repo with a sample Django micro blogging app (μblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that ",{"type":49,"tag":126,"props":127,"children":128},"em",{},[129],{"type":55,"value":130},"consumes",{"type":55,"value":132}," each of the libraries listed above, ",{"type":49,"tag":80,"props":134,"children":137},{"href":135,"rel":136},"https://briancaffey.github.io/django-step-by-step/",[84],[138],{"type":55,"value":139},"VuePress documentation site",{"type":55,"value":141}," and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): ",{"type":49,"tag":80,"props":143,"children":146},{"href":144,"rel":145},"https://github.com/briancaffey/django-step-by-step",[84],[147],{"type":55,"value":148},"github.com/briancaffey/django-step-by-step",{"type":49,"tag":50,"props":150,"children":152},{"id":151},"eli5",[153],{"type":55,"value":151},{"type":49,"tag":58,"props":155,"children":156},{},[157],{"type":55,"value":158},"Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use.",{"type":49,"tag":58,"props":160,"children":161},{},[162],{"type":55,"value":163},"Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers.",{"type":49,"tag":58,"props":165,"children":166},{},[167,169,174,176,181],{"type":55,"value":168},"The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos ",{"type":49,"tag":126,"props":170,"children":171},{},[172],{"type":55,"value":173},"to YouTube",{"type":55,"value":175},", but the code I'm writing allows you to upload any type of website (even site YouTube) ",{"type":49,"tag":126,"props":177,"children":178},{},[179],{"type":55,"value":180},"to the internet",{"type":55,"value":182},". When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach.",{"type":49,"tag":50,"props":184,"children":186},{"id":185},"why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi",[187],{"type":55,"value":188},"Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi",{"type":49,"tag":58,"props":190,"children":191},{},[192],{"type":49,"tag":72,"props":193,"children":194},{},[195],{"type":55,"value":196},"To push me to learn more about AWS, IaC, CI/CD, automation, and Platform Engineering",{"type":49,"tag":64,"props":198,"children":199},{},[200,205],{"type":49,"tag":68,"props":201,"children":202},{},[203],{"type":55,"value":204},"Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate).",{"type":49,"tag":68,"props":206,"children":207},{},[208],{"type":55,"value":209},"Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward",{"type":49,"tag":58,"props":211,"children":212},{},[213],{"type":49,"tag":72,"props":214,"children":215},{},[216],{"type":55,"value":217},"To fail as many times as possible",{"type":49,"tag":64,"props":219,"children":220},{},[221,226,231],{"type":49,"tag":68,"props":222,"children":223},{},[224],{"type":55,"value":225},"Every time I fail when I think I have things right, I learn something new",{"type":49,"tag":68,"props":227,"children":228},{},[229],{"type":55,"value":230},"Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production",{"type":49,"tag":68,"props":232,"children":233},{},[234],{"type":55,"value":235},"You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important",{"type":49,"tag":58,"props":237,"children":238},{},[239],{"type":49,"tag":72,"props":240,"children":241},{},[242],{"type":55,"value":243},"To take an application-first approach to DevOps",{"type":49,"tag":64,"props":245,"children":246},{},[247,252,257],{"type":49,"tag":68,"props":248,"children":249},{},[250],{"type":55,"value":251},"Application developers are increasingly being tasked with operational duties",{"type":49,"tag":68,"props":253,"children":254},{},[255],{"type":55,"value":256},"While learning about IaC, I had a hard time finding in-depth materials covering application development, CI/CD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image",{"type":49,"tag":68,"props":258,"children":259},{},[260],{"type":55,"value":261},"You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind",{"type":49,"tag":58,"props":263,"children":264},{},[265],{"type":49,"tag":72,"props":266,"children":267},{},[268],{"type":55,"value":269},"To develop a project I can reference when helping myself and others",{"type":49,"tag":64,"props":271,"children":272},{},[273,278,290],{"type":49,"tag":68,"props":274,"children":275},{},[276],{"type":55,"value":277},"companies and projects that do IaC and CI/CD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor",{"type":49,"tag":68,"props":279,"children":280},{},[281,283,288],{"type":55,"value":282},"Hopefully, the sample application, IaC, and CI/CD pipelines ",{"type":49,"tag":126,"props":284,"children":285},{},[286],{"type":55,"value":287},"aren't overly complex",{"type":55,"value":289},". There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on",{"type":49,"tag":68,"props":291,"children":292},{},[293,295,300],{"type":55,"value":294},"People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to ",{"type":49,"tag":72,"props":296,"children":297},{},[298],{"type":55,"value":299},"show",{"type":55,"value":301}," people how it can be done",{"type":49,"tag":58,"props":303,"children":304},{},[305],{"type":49,"tag":72,"props":306,"children":307},{},[308,310,315],{"type":55,"value":309},"To encourage others (specifically Developer Advocates / Developer Relations / Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software ",{"type":49,"tag":72,"props":311,"children":312},{},[313],{"type":55,"value":314},"in use",{"type":55,"value":316}," with an actual application.",{"type":49,"tag":64,"props":318,"children":319},{},[320,334],{"type":49,"tag":68,"props":321,"children":322},{},[323,325,332],{"type":55,"value":324},"There are many ways one could create an \"IaC Rosetta Stone\" (",{"type":49,"tag":326,"props":327,"children":329},"code",{"className":328},[],[330],{"type":55,"value":331},"public cloud providers x CI/CD providers x IaC tools",{"type":55,"value":333}," is a big number)",{"type":49,"tag":68,"props":335,"children":336},{},[337],{"type":55,"value":338},"This takes a lot of effort and time",{"type":49,"tag":58,"props":340,"children":341},{},[342],{"type":49,"tag":72,"props":343,"children":344},{},[345],{"type":55,"value":346},"I have nothing to sell you",{"type":49,"tag":64,"props":348,"children":349},{},[350,355,360],{"type":49,"tag":68,"props":351,"children":352},{},[353],{"type":55,"value":354},"So many articles about Cloud/DevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here",{"type":49,"tag":68,"props":356,"children":357},{},[358],{"type":55,"value":359},"I'm also not trying to sell anyone on using my IaC packages",{"type":49,"tag":68,"props":361,"children":362},{},[363],{"type":55,"value":364},"Hopefully, my IaC packages can serve as a helpful reference or starting point",{"type":49,"tag":58,"props":366,"children":367},{},[368],{"type":49,"tag":72,"props":369,"children":370},{},[371],{"type":55,"value":372},"Walk before running",{"type":49,"tag":64,"props":374,"children":375},{},[376,381],{"type":49,"tag":68,"props":377,"children":378},{},[379],{"type":55,"value":380},"I want to build up confidence with vanilla use cases before getting too fancy",{"type":49,"tag":68,"props":382,"children":383},{},[384],{"type":55,"value":385},"With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)",{"type":49,"tag":58,"props":387,"children":388},{},[389],{"type":49,"tag":72,"props":390,"children":391},{},[392],{"type":55,"value":393},"12 Factor App, DevOps, and Platform Engineering",{"type":49,"tag":64,"props":395,"children":396},{},[397,409],{"type":49,"tag":68,"props":398,"children":399},{},[400,407],{"type":49,"tag":80,"props":401,"children":404},{"href":402,"rel":403},"https://12factor.net/",[84],[405],{"type":55,"value":406},"12 Factor App",{"type":55,"value":408}," is great and has guided how I approach both Django application development and IaC library development",{"type":49,"tag":68,"props":410,"children":411},{},[412,414,421],{"type":55,"value":413},"The ",{"type":49,"tag":80,"props":415,"children":418},{"href":416,"rel":417},"https://platformengineering.org/",[84],[419],{"type":55,"value":420},"platformengineering.org",{"type":55,"value":422}," community has some good guiding principles",{"type":49,"tag":50,"props":424,"children":426},{"id":425},"cdkterraformpulumi-terminology",[427],{"type":55,"value":428},"CDK/Terraform/Pulumi terminology",{"type":49,"tag":430,"props":431,"children":433},"h3",{"id":432},"constructs-modules-and-components",[434],{"type":55,"value":435},"constructs, modules and components",{"type":49,"tag":58,"props":437,"children":438},{},[439],{"type":55,"value":440},"A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources.",{"type":49,"tag":58,"props":442,"children":443},{},[444,446,451,453,458,460,465,467,473],{"type":55,"value":445},"In this article I will refer to ",{"type":49,"tag":72,"props":447,"children":448},{},[449],{"type":55,"value":450},"constructs/modules/components",{"type":55,"value":452}," as ",{"type":49,"tag":72,"props":454,"children":455},{},[456],{"type":55,"value":457},"c/m/c",{"type":55,"value":459}," for short, and the term ",{"type":49,"tag":72,"props":461,"children":462},{},[463],{"type":55,"value":464},"stack",{"type":55,"value":466}," can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had ",{"type":49,"tag":326,"props":468,"children":470},{"className":469},[],[471],{"type":55,"value":472},"apply",{"type":55,"value":474}," ran against it.",{"type":49,"tag":430,"props":476,"children":478},{"id":477},"what-is-a-stack",[479],{"type":55,"value":480},"what is a stack?",{"type":49,"tag":58,"props":482,"children":483},{},[484],{"type":55,"value":485},"AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module.",{"type":49,"tag":58,"props":487,"children":488},{},[489,491,497],{"type":55,"value":490},"CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the ",{"type":49,"tag":326,"props":492,"children":494},{"className":493},[],[495],{"type":55,"value":496},"@pulumi/aws",{"type":55,"value":498}," package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses).",{"type":49,"tag":430,"props":500,"children":502},{"id":501},"verbs",[503],{"type":55,"value":501},{"type":49,"tag":58,"props":505,"children":506},{},[507,509,515,517,523],{"type":55,"value":508},"In CDK you ",{"type":49,"tag":326,"props":510,"children":512},{"className":511},[],[513],{"type":55,"value":514},"synth",{"type":55,"value":516}," CDK code to generate CloudFormation templates. You can also run ",{"type":49,"tag":326,"props":518,"children":520},{"className":519},[],[521],{"type":55,"value":522},"diff",{"type":55,"value":524}," to see what changes would be applied during a stack update.",{"type":49,"tag":58,"props":526,"children":527},{},[528,530,536,538,544,546,552,554,560],{"type":55,"value":529},"In Terraform you ",{"type":49,"tag":326,"props":531,"children":533},{"className":532},[],[534],{"type":55,"value":535},"init",{"type":55,"value":537}," to download all providers and modules. This is sort of like running ",{"type":49,"tag":326,"props":539,"children":541},{"className":540},[],[542],{"type":55,"value":543},"npm install",{"type":55,"value":545}," in CDK and Pulumi. You then run ",{"type":49,"tag":326,"props":547,"children":549},{"className":548},[],[550],{"type":55,"value":551},"terraform plan",{"type":55,"value":553}," to see the changes that would result. ",{"type":49,"tag":326,"props":555,"children":557},{"className":556},[],[558],{"type":55,"value":559},"terraform apply",{"type":55,"value":561}," does CRUD operations on your cloud resources.",{"type":49,"tag":58,"props":563,"children":564},{},[565,567,573,575,581],{"type":55,"value":566},"In Pulumi you run ",{"type":49,"tag":326,"props":568,"children":570},{"className":569},[],[571],{"type":55,"value":572},"pulumi preview",{"type":55,"value":574}," to see what changes would be made to a stack. You can use the ",{"type":49,"tag":326,"props":576,"children":578},{"className":577},[],[579],{"type":55,"value":580},"--diff",{"type":55,"value":582}," flag to see the specifics of what would change.",{"type":49,"tag":58,"props":584,"children":585},{},[586],{"type":55,"value":587},"To summarize:",{"type":49,"tag":64,"props":589,"children":590},{},[591,596,617,630],{"type":49,"tag":68,"props":592,"children":593},{},[594],{"type":55,"value":595},"In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time",{"type":49,"tag":68,"props":597,"children":598},{},[599,601,606,608,615],{"type":55,"value":600},"In Terraform you plan a configuration made up of modules, and then run ",{"type":49,"tag":326,"props":602,"children":604},{"className":603},[],[605],{"type":55,"value":559},{"type":55,"value":607}," to build the configuration/stack (",{"type":49,"tag":80,"props":609,"children":612},{"href":610,"rel":611},"https://discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",[84],[613],{"type":55,"value":614},"discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",{"type":55,"value":616},")",{"type":49,"tag":68,"props":618,"children":619},{},[620,622,628],{"type":55,"value":621},"Pulumi: You preview a Pulumi stack made up of components, and then run ",{"type":49,"tag":326,"props":623,"children":625},{"className":624},[],[626],{"type":55,"value":627},"pulumi up",{"type":55,"value":629}," to build the resources",{"type":49,"tag":68,"props":631,"children":632},{},[633,635],{"type":55,"value":634},"To tear down a stack in all three tools, you run ",{"type":49,"tag":326,"props":636,"children":638},{"className":637},[],[639],{"type":55,"value":640},"destroy",{"type":49,"tag":50,"props":642,"children":644},{"id":643},"infrastructure-as-code-library-repos",[645],{"type":55,"value":646},"Infrastructure as Code library repos",{"type":49,"tag":58,"props":648,"children":649},{},[650],{"type":55,"value":651},"Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate.",{"type":49,"tag":64,"props":653,"children":654},{},[655,670,685],{"type":49,"tag":68,"props":656,"children":657},{},[658,660],{"type":55,"value":659},"CDK: ",{"type":49,"tag":80,"props":661,"children":663},{"href":82,"rel":662},[84],[664],{"type":49,"tag":326,"props":665,"children":667},{"className":666},[],[668],{"type":55,"value":669},"cdk-django",{"type":49,"tag":68,"props":671,"children":672},{},[673,675],{"type":55,"value":674},"Terraform: ",{"type":49,"tag":80,"props":676,"children":678},{"href":99,"rel":677},[84],[679],{"type":49,"tag":326,"props":680,"children":682},{"className":681},[],[683],{"type":55,"value":684},"terraform-aws-django",{"type":49,"tag":68,"props":686,"children":687},{},[688,690],{"type":55,"value":689},"Pulumi: ",{"type":49,"tag":80,"props":691,"children":693},{"href":115,"rel":692},[84],[694],{"type":49,"tag":326,"props":695,"children":697},{"className":696},[],[698],{"type":55,"value":699},"pulumi-aws-django",{"type":49,"tag":430,"props":701,"children":703},{"id":702},"language",[704],{"type":55,"value":705},"Language",{"type":49,"tag":58,"props":707,"children":708},{},[709,714,716,721,723,728,730,735,737,744],{"type":49,"tag":326,"props":710,"children":712},{"className":711},[],[713],{"type":55,"value":669},{"type":55,"value":715}," and ",{"type":49,"tag":326,"props":717,"children":719},{"className":718},[],[720],{"type":55,"value":699},{"type":55,"value":722}," are both written in TypeScript. ",{"type":49,"tag":326,"props":724,"children":726},{"className":725},[],[727],{"type":55,"value":684},{"type":55,"value":729}," is written in HCL, a domain specific language created by HashiCorp. The ",{"type":49,"tag":326,"props":731,"children":733},{"className":732},[],[734],{"type":55,"value":669},{"type":55,"value":736}," is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using ",{"type":49,"tag":80,"props":738,"children":741},{"href":739,"rel":740},"https://github.com/aws/jsii",[84],[742],{"type":55,"value":743},"jsii",{"type":55,"value":745},".",{"type":49,"tag":58,"props":747,"children":748},{},[749,751,758],{"type":55,"value":750},"My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See ",{"type":49,"tag":80,"props":752,"children":755},{"href":753,"rel":754},"https://github.com/pulumi/pulumi-component-provider-ts-boilerplate",[84],[756],{"type":55,"value":757},"this GitHub repo",{"type":55,"value":759}," for more information on this.",{"type":49,"tag":58,"props":761,"children":762},{},[763,765,772],{"type":55,"value":764},"The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called ",{"type":49,"tag":80,"props":766,"children":769},{"href":767,"rel":768},"https://developer.hashicorp.com/terraform/cdktf",[84],[770],{"type":55,"value":771},"CDKTF",{"type":55,"value":773}," which allows you to write HCL Terraform in TypeScript, but I haven't used it yet.",{"type":49,"tag":430,"props":775,"children":777},{"id":776},"release-management-versioning-and-publishing",[778],{"type":55,"value":779},"Release management, versioning and publishing",{"type":49,"tag":58,"props":781,"children":782},{},[783,788,789,794,796,802,804,809,811,817,819,825,827,833],{"type":49,"tag":326,"props":784,"children":786},{"className":785},[],[787],{"type":55,"value":699},{"type":55,"value":715},{"type":49,"tag":326,"props":790,"children":792},{"className":791},[],[793],{"type":55,"value":684},{"type":55,"value":795}," both use ",{"type":49,"tag":326,"props":797,"children":799},{"className":798},[],[800],{"type":55,"value":801},"release-please",{"type":55,"value":803}," for automatically generating a changelog file and bumping versions. ",{"type":49,"tag":326,"props":805,"children":807},{"className":806},[],[808],{"type":55,"value":801},{"type":55,"value":810}," is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to ",{"type":49,"tag":326,"props":812,"children":814},{"className":813},[],[815],{"type":55,"value":816},"main",{"type":55,"value":818},", a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in ",{"type":49,"tag":326,"props":820,"children":822},{"className":821},[],[823],{"type":55,"value":824},"package.json",{"type":55,"value":826}," and adds a new git tag (e.g. ",{"type":49,"tag":326,"props":828,"children":830},{"className":829},[],[831],{"type":55,"value":832},"v1.2.3",{"type":55,"value":834},") based on commit messages.",{"type":49,"tag":58,"props":836,"children":837},{},[838,843,845,856,858,864,866,872,874,879],{"type":49,"tag":326,"props":839,"children":841},{"className":840},[],[842],{"type":55,"value":669},{"type":55,"value":844}," uses ",{"type":49,"tag":80,"props":846,"children":849},{"href":847,"rel":848},"https://github.com/projen/projen",[84],[850],{"type":49,"tag":326,"props":851,"children":853},{"className":852},[],[854],{"type":55,"value":855},"projen",{"type":55,"value":857}," for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file (",{"type":49,"tag":326,"props":859,"children":861},{"className":860},[],[862],{"type":55,"value":863},".projenrc.ts",{"type":55,"value":865},") to configure your entire repo, including files like ",{"type":49,"tag":326,"props":867,"children":869},{"className":868},[],[870],{"type":55,"value":871},"tsconfig.json",{"type":55,"value":873},", ",{"type":49,"tag":326,"props":875,"children":877},{"className":876},[],[878],{"type":55,"value":824},{"type":55,"value":880},", and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action.",{"type":49,"tag":58,"props":882,"children":883},{},[884,886,893],{"type":55,"value":885},"These tools are both based on ",{"type":49,"tag":80,"props":887,"children":890},{"href":888,"rel":889},"https://www.conventionalcommits.org/en/v1.0.0/",[84],[891],{"type":55,"value":892},"conventional commits",{"type":55,"value":894}," to automatically update the Changelog file.",{"type":49,"tag":58,"props":896,"children":897},{},[898,900,905],{"type":55,"value":899},"I'm still manually publishing my ",{"type":49,"tag":326,"props":901,"children":903},{"className":902},[],[904],{"type":55,"value":699},{"type":55,"value":906}," package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!",{"type":49,"tag":430,"props":908,"children":910},{"id":909},"makefile-examples-and-local-development",[911],{"type":55,"value":912},"Makefile, examples and local development",{"type":49,"tag":58,"props":914,"children":915},{},[916],{"type":55,"value":917},"Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:",{"type":49,"tag":64,"props":919,"children":920},{},[921,933,943,953,971,987,998,1008,1027],{"type":49,"tag":68,"props":922,"children":923},{},[924,926,931],{"type":55,"value":925},"synthesizing CDK to CloudFormation / running ",{"type":49,"tag":326,"props":927,"children":929},{"className":928},[],[930],{"type":55,"value":551},{"type":55,"value":932}," / previewing pulumi up for both the base and app stacks",{"type":49,"tag":68,"props":934,"children":935},{},[936,938],{"type":55,"value":937},"creating/updating an ad hoc base stack called ",{"type":49,"tag":326,"props":939,"children":941},{"className":940},[],[942],{"type":55,"value":34},{"type":49,"tag":68,"props":944,"children":945},{},[946,948],{"type":55,"value":947},"destroying resources in the ad-hoc base stack called ",{"type":49,"tag":326,"props":949,"children":951},{"className":950},[],[952],{"type":55,"value":34},{"type":49,"tag":68,"props":954,"children":955},{},[956,958,964,966],{"type":55,"value":957},"creating an ad hoc app stack called ",{"type":49,"tag":326,"props":959,"children":961},{"className":960},[],[962],{"type":55,"value":963},"alpha",{"type":55,"value":965}," that uses resources from ",{"type":49,"tag":326,"props":967,"children":969},{"className":968},[],[970],{"type":55,"value":34},{"type":49,"tag":68,"props":972,"children":973},{},[974,976,981,982],{"type":55,"value":975},"destroying an ad hoc app stack called ",{"type":49,"tag":326,"props":977,"children":979},{"className":978},[],[980],{"type":55,"value":963},{"type":55,"value":965},{"type":49,"tag":326,"props":983,"children":985},{"className":984},[],[986],{"type":55,"value":34},{"type":49,"tag":68,"props":988,"children":989},{},[990,992],{"type":55,"value":991},"creating/updating a prod base stack called ",{"type":49,"tag":326,"props":993,"children":995},{"className":994},[],[996],{"type":55,"value":997},"stage",{"type":49,"tag":68,"props":999,"children":1000},{},[1001,1003],{"type":55,"value":1002},"destroying resources in the prod base stack called ",{"type":49,"tag":326,"props":1004,"children":1006},{"className":1005},[],[1007],{"type":55,"value":997},{"type":49,"tag":68,"props":1009,"children":1010},{},[1011,1013,1018,1020,1025],{"type":55,"value":1012},"creating a prod app stack using called ",{"type":49,"tag":326,"props":1014,"children":1016},{"className":1015},[],[1017],{"type":55,"value":997},{"type":55,"value":1019}," that uses resources from the ",{"type":49,"tag":326,"props":1021,"children":1023},{"className":1022},[],[1024],{"type":55,"value":997},{"type":55,"value":1026}," base stack",{"type":49,"tag":68,"props":1028,"children":1029},{},[1030,1032],{"type":55,"value":1031},"destroying resources in the prod app stack called ",{"type":49,"tag":326,"props":1033,"children":1035},{"className":1034},[],[1036],{"type":55,"value":997},{"type":49,"tag":58,"props":1038,"children":1039},{},[1040,1042,1047],{"type":55,"value":1041},"Here's an example of what these commands look like in ",{"type":49,"tag":326,"props":1043,"children":1045},{"className":1044},[],[1046],{"type":55,"value":699},{"type":55,"value":1048}," for prod infrastructure base and app stacks:",{"type":49,"tag":1050,"props":1051,"children":1055},"pre",{"code":1052,"language":1053,"meta":8,"className":1054,"style":8},"prod-base-preview:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive preview\n\nprod-base-up:   build\n    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n\nprod-base-destroy:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n\nprod-app-preview:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview\n\nprod-app-preview-diff:  build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n\nprod-app-up:    build\n    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n\nprod-app-destroy:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n","make","language-make shiki shiki-themes github-light github-dark monokai",[1056],{"type":49,"tag":326,"props":1057,"children":1058},{"__ignoreMap":8},[1059,1077,1086,1095,1109,1118,1126,1139,1148,1156,1169,1178,1186,1199,1208,1216,1230,1239,1247,1260],{"type":49,"tag":1060,"props":1061,"children":1064},"span",{"class":1062,"line":1063},"line",1,[1065,1071],{"type":49,"tag":1060,"props":1066,"children":1068},{"style":1067},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1069],{"type":55,"value":1070},"prod-base-preview",{"type":49,"tag":1060,"props":1072,"children":1074},{"style":1073},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[1075],{"type":55,"value":1076},":  build\n",{"type":49,"tag":1060,"props":1078,"children":1080},{"class":1062,"line":1079},2,[1081],{"type":49,"tag":1060,"props":1082,"children":1083},{"style":1073},[1084],{"type":55,"value":1085},"    pulumi -C examples/prod/base --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1087,"children":1089},{"class":1062,"line":1088},3,[1090],{"type":49,"tag":1060,"props":1091,"children":1092},{"emptyLinePlaceholder":44},[1093],{"type":55,"value":1094},"\n",{"type":49,"tag":1060,"props":1096,"children":1098},{"class":1062,"line":1097},4,[1099,1104],{"type":49,"tag":1060,"props":1100,"children":1101},{"style":1067},[1102],{"type":55,"value":1103},"prod-base-up",{"type":49,"tag":1060,"props":1105,"children":1106},{"style":1073},[1107],{"type":55,"value":1108},":   build\n",{"type":49,"tag":1060,"props":1110,"children":1112},{"class":1062,"line":1111},5,[1113],{"type":49,"tag":1060,"props":1114,"children":1115},{"style":1073},[1116],{"type":55,"value":1117},"    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1119,"children":1121},{"class":1062,"line":1120},6,[1122],{"type":49,"tag":1060,"props":1123,"children":1124},{"emptyLinePlaceholder":44},[1125],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1127,"children":1129},{"class":1062,"line":1128},7,[1130,1135],{"type":49,"tag":1060,"props":1131,"children":1132},{"style":1067},[1133],{"type":55,"value":1134},"prod-base-destroy",{"type":49,"tag":1060,"props":1136,"children":1137},{"style":1073},[1138],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1140,"children":1142},{"class":1062,"line":1141},8,[1143],{"type":49,"tag":1060,"props":1144,"children":1145},{"style":1073},[1146],{"type":55,"value":1147},"    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":1060,"props":1149,"children":1151},{"class":1062,"line":1150},9,[1152],{"type":49,"tag":1060,"props":1153,"children":1154},{"emptyLinePlaceholder":44},[1155],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1157,"children":1159},{"class":1062,"line":1158},10,[1160,1165],{"type":49,"tag":1060,"props":1161,"children":1162},{"style":1067},[1163],{"type":55,"value":1164},"prod-app-preview",{"type":49,"tag":1060,"props":1166,"children":1167},{"style":1073},[1168],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1170,"children":1172},{"class":1062,"line":1171},11,[1173],{"type":49,"tag":1060,"props":1174,"children":1175},{"style":1073},[1176],{"type":55,"value":1177},"    pulumi -C examples/prod/app --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1179,"children":1181},{"class":1062,"line":1180},12,[1182],{"type":49,"tag":1060,"props":1183,"children":1184},{"emptyLinePlaceholder":44},[1185],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1187,"children":1189},{"class":1062,"line":1188},13,[1190,1195],{"type":49,"tag":1060,"props":1191,"children":1192},{"style":1067},[1193],{"type":55,"value":1194},"prod-app-preview-diff",{"type":49,"tag":1060,"props":1196,"children":1197},{"style":1073},[1198],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1200,"children":1202},{"class":1062,"line":1201},14,[1203],{"type":49,"tag":1060,"props":1204,"children":1205},{"style":1073},[1206],{"type":55,"value":1207},"    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n",{"type":49,"tag":1060,"props":1209,"children":1211},{"class":1062,"line":1210},15,[1212],{"type":49,"tag":1060,"props":1213,"children":1214},{"emptyLinePlaceholder":44},[1215],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1217,"children":1219},{"class":1062,"line":1218},16,[1220,1225],{"type":49,"tag":1060,"props":1221,"children":1222},{"style":1067},[1223],{"type":55,"value":1224},"prod-app-up",{"type":49,"tag":1060,"props":1226,"children":1227},{"style":1073},[1228],{"type":55,"value":1229},":    build\n",{"type":49,"tag":1060,"props":1231,"children":1233},{"class":1062,"line":1232},17,[1234],{"type":49,"tag":1060,"props":1235,"children":1236},{"style":1073},[1237],{"type":55,"value":1238},"    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1240,"children":1242},{"class":1062,"line":1241},18,[1243],{"type":49,"tag":1060,"props":1244,"children":1245},{"emptyLinePlaceholder":44},[1246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1248,"children":1250},{"class":1062,"line":1249},19,[1251,1256],{"type":49,"tag":1060,"props":1252,"children":1253},{"style":1067},[1254],{"type":55,"value":1255},"prod-app-destroy",{"type":49,"tag":1060,"props":1257,"children":1258},{"style":1073},[1259],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1261,"children":1263},{"class":1062,"line":1262},20,[1264],{"type":49,"tag":1060,"props":1265,"children":1266},{"style":1073},[1267],{"type":55,"value":1268},"    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":58,"props":1270,"children":1271},{},[1272,1274,1279],{"type":55,"value":1273},"I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the ",{"type":49,"tag":326,"props":1275,"children":1277},{"className":1276},[],[1278],{"type":55,"value":457},{"type":55,"value":1280},"s to create environments and smoke check the environments to make sure everything works correctly.",{"type":49,"tag":58,"props":1282,"children":1283},{},[1284],{"type":55,"value":1285},"Adding unit tests is another item for the backlog.",{"type":49,"tag":430,"props":1287,"children":1289},{"id":1288},"ad-hoc-vs-prod",[1290],{"type":55,"value":1291},"ad-hoc vs prod",{"type":49,"tag":64,"props":1293,"children":1294},{},[1295,1307,1312,1317,1322,1327],{"type":49,"tag":68,"props":1296,"children":1297},{},[1298,1305],{"type":49,"tag":80,"props":1299,"children":1302},{"href":1300,"rel":1301},"https://briancaffey.github.io/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",[84],[1303],{"type":55,"value":1304},"the last article I wrote was about ad hoc environments",{"type":55,"value":1306},". Also known as \"on-demand\" environments or \"preview\" environments.",{"type":49,"tag":68,"props":1308,"children":1309},{},[1310],{"type":55,"value":1311},"the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)",{"type":49,"tag":68,"props":1313,"children":1314},{},[1315],{"type":55,"value":1316},"you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)",{"type":49,"tag":68,"props":1318,"children":1319},{},[1320],{"type":55,"value":1321},"prod can be used for a production environment and any number of pre-production environments",{"type":49,"tag":68,"props":1323,"children":1324},{},[1325],{"type":55,"value":1326},"multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)",{"type":49,"tag":68,"props":1328,"children":1329},{},[1330],{"type":55,"value":1331},"the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment",{"type":49,"tag":430,"props":1333,"children":1335},{"id":1334},"directory-structure",[1336],{"type":55,"value":1337},"Directory structure",{"type":49,"tag":58,"props":1339,"children":1340},{},[1341],{"type":55,"value":1342},"The directory structures for each repo are all similar with some minor differences.",{"type":49,"tag":58,"props":1344,"children":1345},{},[1346,1348,1354,1355,1361,1363,1369,1370,1376],{"type":55,"value":1347},"There are two types of environments: ",{"type":49,"tag":326,"props":1349,"children":1351},{"className":1350},[],[1352],{"type":55,"value":1353},"ad-hoc",{"type":55,"value":715},{"type":49,"tag":326,"props":1356,"children":1358},{"className":1357},[],[1359],{"type":55,"value":1360},"prod",{"type":55,"value":1362},". Within ad-hoc and production, there are two directories ",{"type":49,"tag":326,"props":1364,"children":1366},{"className":1365},[],[1367],{"type":55,"value":1368},"base",{"type":55,"value":715},{"type":49,"tag":326,"props":1371,"children":1373},{"className":1372},[],[1374],{"type":55,"value":1375},"app",{"type":55,"value":745},{"type":49,"tag":58,"props":1378,"children":1379},{},[1380,1382,1388,1390,1395,1397,1402],{"type":55,"value":1381},"Each repo has a directory called ",{"type":49,"tag":326,"props":1383,"children":1385},{"className":1384},[],[1386],{"type":55,"value":1387},"internal",{"type":55,"value":1389}," which contain building blocks used by the ",{"type":49,"tag":326,"props":1391,"children":1393},{"className":1392},[],[1394],{"type":55,"value":457},{"type":55,"value":1396},"s that are exposed. The contents of the ",{"type":49,"tag":326,"props":1398,"children":1400},{"className":1399},[],[1401],{"type":55,"value":1387},{"type":55,"value":1403}," directories are not intended to be used by anyone who is using the libraries.",{"type":49,"tag":58,"props":1405,"children":1406},{},[1407],{"type":49,"tag":72,"props":1408,"children":1409},{},[1410],{"type":55,"value":1411},"CDK construct library repo structure",{"type":49,"tag":1050,"props":1413,"children":1415},{"code":1414},"~/git/github/cdk-django$ tree -L 4 -d src/\nsrc/\n├── constructs\n│   ├── ad-hoc\n│   │   ├── app\n│   │   └── base\n│   ├── internal\n│   │   ├── alb\n│   │   ├── bastion\n│   │   ├── customResources\n│   │   │   └── highestPriorityRule\n│   │   ├── ecs\n│   │   │   ├── iam\n│   │   │   ├── management-command\n│   │   │   ├── redis\n│   │   │   ├── scheduler\n│   │   │   ├── web\n│   │   │   └── worker\n│   │   ├── rds\n│   │   ├── sg\n│   │   └── vpc\n│   └── prod\n│       ├── app\n│       └── base\n└── examples\n    └── ad-hoc\n        ├── app\n        │   └── config\n        └── base\n            └── config\n",[1416],{"type":49,"tag":326,"props":1417,"children":1418},{"__ignoreMap":8},[1419],{"type":55,"value":1414},{"type":49,"tag":58,"props":1421,"children":1422},{},[1423],{"type":49,"tag":72,"props":1424,"children":1425},{},[1426],{"type":55,"value":1427},"Terraform module library repo structure",{"type":49,"tag":1050,"props":1429,"children":1431},{"code":1430},"~/git/github/terraform-aws-django$ tree -L 4 -d modules\nmodules\n├── ad-hoc\n│   ├── app\n│   └── base\n├── internal\n│   ├── alb\n│   ├── autoscaling\n│   ├── bastion\n│   ├── ecs\n│   │   ├── ad-hoc\n│   │   │   ├── celery_beat\n│   │   │   ├── celery_worker\n│   │   │   ├── cluster\n│   │   │   ├── management_command\n│   │   │   ├── redis\n│   │   │   └── web\n│   │   └── prod\n│   │       ├── celery_beat\n│   │       ├── celery_worker\n│   │       ├── cluster\n│   │       ├── management_command\n│   │       └── web\n│   ├── elasticache\n│   ├── iam\n│   ├── rds\n│   ├── route53\n│   ├── s3\n│   ├── sd\n│   └── sg\n└── prod\n    ├── app\n    └── base\n",[1432],{"type":49,"tag":326,"props":1433,"children":1434},{"__ignoreMap":8},[1435],{"type":55,"value":1430},{"type":49,"tag":58,"props":1437,"children":1438},{},[1439],{"type":49,"tag":72,"props":1440,"children":1441},{},[1442],{"type":55,"value":1443},"Pulumi component library repo structure",{"type":49,"tag":1050,"props":1445,"children":1447},{"code":1446},"~/git/github/pulumi-aws-django$ tree -L 3 src/\nsrc/\n├── components\n│   ├── ad-hoc\n│   │   ├── README.md\n│   │   ├── app\n│   │   └── base\n│   └── internal\n│       ├── README.md\n│       ├── alb\n│       ├── bastion\n│       ├── cw\n│       ├── ecs\n│       ├── iam\n│       ├── rds\n│       └── sg\n└── util\n    ├── index.ts\n    └── taggable.ts\n",[1448],{"type":49,"tag":326,"props":1449,"children":1450},{"__ignoreMap":8},[1451],{"type":55,"value":1446},{"type":49,"tag":58,"props":1453,"children":1454},{},[1455],{"type":49,"tag":72,"props":1456,"children":1457},{},[1458],{"type":55,"value":1459},"Pulumi examples directory",{"type":49,"tag":1050,"props":1461,"children":1463},{"code":1462},"~/git/github/pulumi-aws-django$ tree -L 3 examples/\nexamples/\n└── ad-hoc\n    ├── app\n    │   ├── Pulumi.alpha.yaml\n    │   ├── Pulumi.yaml\n    │   ├── index.ts\n    │   ├── node_modules\n    │   ├── package-lock.json\n    │   ├── package.json\n    │   └── tsconfig.json\n    └── base\n        ├── Pulumi.yaml\n        ├── bin\n        ├── index.ts\n        ├── package-lock.json\n        ├── package.json\n        └── tsconfig.json\n",[1464],{"type":49,"tag":326,"props":1465,"children":1466},{"__ignoreMap":8},[1467],{"type":55,"value":1462},{"type":49,"tag":430,"props":1469,"children":1471},{"id":1470},"cloc",[1472],{"type":55,"value":1473},"CLOC",{"type":49,"tag":58,"props":1475,"children":1476},{},[1477,1479,1484],{"type":55,"value":1478},"Let's use CLOC (count lines of code) to compare the lines of code used in the ",{"type":49,"tag":326,"props":1480,"children":1482},{"className":1481},[],[1483],{"type":55,"value":457},{"type":55,"value":1485}," of CDK/CloudFormation/Terraform/Pulumi.",{"type":49,"tag":58,"props":1487,"children":1488},{},[1489],{"type":49,"tag":72,"props":1490,"children":1491},{},[1492],{"type":49,"tag":326,"props":1493,"children":1495},{"className":1494},[],[1496],{"type":55,"value":669},{"type":49,"tag":1050,"props":1498,"children":1500},{"code":1499},"~/git/github/cdk-django$ cloc src/constructs/\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n",[1501],{"type":49,"tag":326,"props":1502,"children":1503},{"__ignoreMap":8},[1504],{"type":55,"value":1499},{"type":49,"tag":58,"props":1506,"children":1507},{},[1508],{"type":49,"tag":72,"props":1509,"children":1510},{},[1511],{"type":49,"tag":326,"props":1512,"children":1514},{"className":1513},[],[1515],{"type":55,"value":684},{"type":49,"tag":1050,"props":1517,"children":1519},{"code":1518},"~/git/github/terraform-aws-django$ cloc modules/\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n",[1520],{"type":49,"tag":326,"props":1521,"children":1522},{"__ignoreMap":8},[1523],{"type":55,"value":1518},{"type":49,"tag":58,"props":1525,"children":1526},{},[1527],{"type":49,"tag":72,"props":1528,"children":1529},{},[1530],{"type":49,"tag":326,"props":1531,"children":1533},{"className":1532},[],[1534],{"type":55,"value":699},{"type":49,"tag":1050,"props":1536,"children":1538},{"code":1537},"~/git/github/pulumi-aws-django$ cloc src/components/\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n",[1539],{"type":49,"tag":326,"props":1540,"children":1541},{"__ignoreMap":8},[1542],{"type":55,"value":1537},{"type":49,"tag":50,"props":1544,"children":1546},{"id":1545},"communities",[1547],{"type":55,"value":1548},"Communities",{"type":49,"tag":58,"props":1550,"children":1551},{},[1552],{"type":55,"value":1553},"The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!",{"type":49,"tag":64,"props":1555,"children":1556},{},[1557,1567,1577],{"type":49,"tag":68,"props":1558,"children":1559},{},[1560],{"type":49,"tag":80,"props":1561,"children":1564},{"href":1562,"rel":1563},"https://cdk.dev/",[84],[1565],{"type":55,"value":1566},"cdk.dev",{"type":49,"tag":68,"props":1568,"children":1569},{},[1570],{"type":49,"tag":80,"props":1571,"children":1574},{"href":1572,"rel":1573},"https://discuss.hashicorp.com/c/terraform-core/27",[84],[1575],{"type":55,"value":1576},"Terraform Section of HashiCorp Discuss Forum",{"type":49,"tag":68,"props":1578,"children":1579},{},[1580],{"type":49,"tag":80,"props":1581,"children":1584},{"href":1582,"rel":1583},"https://slack.pulumi.com/",[84],[1585],{"type":55,"value":1586},"Pulumi Slack",{"type":49,"tag":50,"props":1588,"children":1590},{"id":1589},"μblog",[1591],{"type":55,"value":1589},{"type":49,"tag":58,"props":1593,"children":1594},{},[1595],{"type":55,"value":1596},"μblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:",{"type":49,"tag":58,"props":1598,"children":1599},{},[1600],{"type":49,"tag":1601,"props":1602,"children":1605},"img",{"alt":1603,"src":1604},"ublog","/static/ublog_screenshot.png",[],{"type":49,"tag":58,"props":1607,"children":1608},{},[1609],{"type":55,"value":1610},"It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts.",{"type":49,"tag":430,"props":1612,"children":1614},{"id":1613},"mono-repo-structure",[1615],{"type":55,"value":1616},"Mono-repo structure",{"type":49,"tag":58,"props":1618,"children":1619},{},[1620,1622,1628],{"type":55,"value":1621},"It lives in a GitHub mono repo called ",{"type":49,"tag":326,"props":1623,"children":1625},{"className":1624},[],[1626],{"type":55,"value":1627},"django-step-by-step",{"type":55,"value":1629},". This mono repo contains a few different things:",{"type":49,"tag":64,"props":1631,"children":1632},{},[1633,1638,1643,1665],{"type":49,"tag":68,"props":1634,"children":1635},{},[1636],{"type":55,"value":1637},"backend Django application",{"type":49,"tag":68,"props":1639,"children":1640},{},[1641],{"type":55,"value":1642},"frontend Vue.js application",{"type":49,"tag":68,"props":1644,"children":1645},{},[1646,1648,1653,1654,1659,1660],{"type":55,"value":1647},"IaC code that uses c/m/c from ",{"type":49,"tag":326,"props":1649,"children":1651},{"className":1650},[],[1652],{"type":55,"value":669},{"type":55,"value":873},{"type":49,"tag":326,"props":1655,"children":1657},{"className":1656},[],[1658],{"type":55,"value":684},{"type":55,"value":715},{"type":49,"tag":326,"props":1661,"children":1663},{"className":1662},[],[1664],{"type":55,"value":699},{"type":49,"tag":68,"props":1666,"children":1667},{},[1668],{"type":55,"value":1669},"GitHub Actions workflows for both Infrastructure deployments and application deployments",{"type":49,"tag":58,"props":1671,"children":1672},{},[1673],{"type":55,"value":1674},"μblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. μblog is meant to represent a generic 12 Factor application that uses:",{"type":49,"tag":64,"props":1676,"children":1677},{},[1678,1683,1688,1693,1698,1703,1708,1713],{"type":49,"tag":68,"props":1679,"children":1680},{},[1681],{"type":55,"value":1682},"gunicorn for a backend API",{"type":49,"tag":68,"props":1684,"children":1685},{},[1686],{"type":55,"value":1687},"Vue.js for a client that consumes the backend API",{"type":49,"tag":68,"props":1689,"children":1690},{},[1691],{"type":55,"value":1692},"celery for async task processing",{"type":49,"tag":68,"props":1694,"children":1695},{},[1696],{"type":55,"value":1697},"celery beat for scheduling tasks",{"type":49,"tag":68,"props":1699,"children":1700},{},[1701],{"type":55,"value":1702},"Postgres for relational data",{"type":49,"tag":68,"props":1704,"children":1705},{},[1706],{"type":55,"value":1707},"Redis for caching and message brokering",{"type":49,"tag":68,"props":1709,"children":1710},{},[1711],{"type":55,"value":1712},"S3 for object storage",{"type":49,"tag":68,"props":1714,"children":1715},{},[1716],{"type":55,"value":1717},"Django admin for a simple admin interface",{"type":49,"tag":58,"props":1719,"children":1720},{},[1721],{"type":55,"value":1722},"There is a lot more I could add on μblog. For now I'll just mention that it:",{"type":49,"tag":64,"props":1724,"children":1725},{},[1726,1731,1736,1741,1746],{"type":49,"tag":68,"props":1727,"children":1728},{},[1729],{"type":55,"value":1730},"has a great local development environment (supports both docker-compose and virtual environments)",{"type":49,"tag":68,"props":1732,"children":1733},{},[1734],{"type":55,"value":1735},"demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL.",{"type":49,"tag":68,"props":1737,"children":1738},{},[1739],{"type":55,"value":1740},"GitHub Actions for running unit tests",{"type":49,"tag":68,"props":1742,"children":1743},{},[1744],{"type":55,"value":1745},"k6 for load testing",{"type":49,"tag":68,"props":1747,"children":1748},{},[1749,1751],{"type":55,"value":1750},"contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: ",{"type":49,"tag":80,"props":1752,"children":1754},{"href":135,"rel":1753},[84],[1755],{"type":55,"value":135},{"type":49,"tag":1757,"props":1758,"children":1760},"h1",{"id":1759},"infrastructure-deep-dive",[1761],{"type":55,"value":1762},"Infrastructure Deep Dive",{"type":49,"tag":58,"props":1764,"children":1765},{},[1766,1768,1773],{"type":55,"value":1767},"Let's go through each of the ",{"type":49,"tag":326,"props":1769,"children":1771},{"className":1770},[],[1772],{"type":55,"value":457},{"type":55,"value":1774},"s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi.",{"type":49,"tag":58,"props":1776,"children":1777},{},[1778,1780,1785,1786,1791,1793,1798,1799,1804],{"type":55,"value":1779},"I'll first talk about the two stacks used in ad hoc environments: ",{"type":49,"tag":326,"props":1781,"children":1783},{"className":1782},[],[1784],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1787,"children":1789},{"className":1788},[],[1790],{"type":55,"value":1375},{"type":55,"value":1792},". Then I'll talk about the prod environments which are also composed of ",{"type":49,"tag":326,"props":1794,"children":1796},{"className":1795},[],[1797],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1800,"children":1802},{"className":1801},[],[1803],{"type":55,"value":1375},{"type":55,"value":1805}," stacks.",{"type":49,"tag":58,"props":1807,"children":1808},{},[1809,1811,1816],{"type":55,"value":1810},"Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, ",{"type":49,"tag":72,"props":1812,"children":1813},{},[1814],{"type":55,"value":1815},"especially with Terraform",{"type":55,"value":1817},". In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried).",{"type":49,"tag":50,"props":1819,"children":1821},{"id":1820},"splitting-up-the-stacks",[1822],{"type":55,"value":1823},"Splitting up the stacks",{"type":49,"tag":58,"props":1825,"children":1826},{},[1827],{"type":55,"value":1828},"While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so.",{"type":49,"tag":64,"props":1830,"children":1831},{},[1832,1843,1855],{"type":49,"tag":68,"props":1833,"children":1834},{},[1835,1837],{"type":55,"value":1836},"Terraform enables this with outputs and ",{"type":49,"tag":326,"props":1838,"children":1840},{"className":1839},[],[1841],{"type":55,"value":1842},"terraform_remote_state",{"type":49,"tag":68,"props":1844,"children":1845},{},[1846,1848],{"type":55,"value":1847},"Pulumi encourages the use of ",{"type":49,"tag":80,"props":1849,"children":1852},{"href":1850,"rel":1851},"https://www.pulumi.com/docs/guides/organizing-projects-stacks/",[84],[1853],{"type":55,"value":1854},"micro stacks",{"type":49,"tag":68,"props":1856,"children":1857},{},[1858,1860],{"type":55,"value":1859},"CDK has an article on how to ",{"type":49,"tag":80,"props":1861,"children":1864},{"href":1862,"rel":1863},"https://docs.aws.amazon.com/cdk/v2/guide/stack_how_to_create_multiple_stacks.html",[84],[1865],{"type":55,"value":1866},"create an app with multiple stacks",{"type":49,"tag":58,"props":1868,"children":1869},{},[1870],{"type":55,"value":1871},"My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack.",{"type":49,"tag":58,"props":1873,"children":1874},{},[1875],{"type":55,"value":1876},"Also, on-demand environments really lends itself to stacks that are split up.",{"type":49,"tag":58,"props":1878,"children":1879},{},[1880,1882,1889],{"type":55,"value":1881},"In the section ",{"type":49,"tag":80,"props":1883,"children":1886},{"href":1884,"rel":1885},"https://docs.aws.amazon.com/cdk/v2/guide/resources.html",[84],[1887],{"type":55,"value":1888},"\"Passing unique identifiers\"",{"type":55,"value":1890},", the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app.",{"type":49,"tag":58,"props":1892,"children":1893},{},[1894,1896,1901,1903,1908,1910,1915,1917,1923,1924,1930,1932,1937,1939,1945,1946,1952,1953,1959],{"type":55,"value":1895},"There is a balance to be found between single stacks vs micro stacks. Both the base and app ",{"type":49,"tag":326,"props":1897,"children":1899},{"className":1898},[],[1900],{"type":55,"value":457},{"type":55,"value":1902},"s could be split out further. For example, the ",{"type":49,"tag":326,"props":1904,"children":1906},{"className":1905},[],[1907],{"type":55,"value":1368},{"type":55,"value":1909}," ",{"type":49,"tag":326,"props":1911,"children":1913},{"className":1912},[],[1914],{"type":55,"value":457},{"type":55,"value":1916},"s could be split into ",{"type":49,"tag":326,"props":1918,"children":1920},{"className":1919},[],[1921],{"type":55,"value":1922},"networking",{"type":55,"value":715},{"type":49,"tag":326,"props":1925,"children":1927},{"className":1926},[],[1928],{"type":55,"value":1929},"rds",{"type":55,"value":1931},". The ",{"type":49,"tag":326,"props":1933,"children":1935},{"className":1934},[],[1936],{"type":55,"value":1375},{"type":55,"value":1938}," stack could be split into different ECS services so that their infrastructure can be deployed independently, like ",{"type":49,"tag":326,"props":1940,"children":1942},{"className":1941},[],[1943],{"type":55,"value":1944},"cluster",{"type":55,"value":873},{"type":49,"tag":326,"props":1947,"children":1949},{"className":1948},[],[1950],{"type":55,"value":1951},"backend",{"type":55,"value":715},{"type":49,"tag":326,"props":1954,"children":1956},{"className":1955},[],[1957],{"type":55,"value":1958},"frontend",{"type":55,"value":1960},". The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article.",{"type":49,"tag":58,"props":1962,"children":1963},{},[1964],{"type":55,"value":1965},"My rules of thumbs are:",{"type":49,"tag":64,"props":1967,"children":1968},{},[1969,1974],{"type":49,"tag":68,"props":1970,"children":1971},{},[1972],{"type":55,"value":1973},"single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change",{"type":49,"tag":68,"props":1975,"children":1976},{},[1977],{"type":55,"value":1978},"Lots of small stacks can cause overhead and make things more complex than they need to be",{"type":49,"tag":50,"props":1980,"children":1982},{"id":1981},"ad-hoc-base-overview",[1983],{"type":55,"value":1984},"Ad hoc base overview",{"type":49,"tag":58,"props":1986,"children":1987},{},[1988],{"type":55,"value":1989},"Here's an overview of the resources used in an ad hoc base environment.",{"type":49,"tag":64,"props":1991,"children":1992},{},[1993,1998,2003,2008,2013,2018,2023,2028],{"type":49,"tag":68,"props":1994,"children":1995},{},[1996],{"type":55,"value":1997},"(Inputs)",{"type":49,"tag":68,"props":1999,"children":2000},{},[2001],{"type":55,"value":2002},"(Optional environment configs)",{"type":49,"tag":68,"props":2004,"children":2005},{},[2006],{"type":55,"value":2007},"VPC and Service Discovery",{"type":49,"tag":68,"props":2009,"children":2010},{},[2011],{"type":55,"value":2012},"S3",{"type":49,"tag":68,"props":2014,"children":2015},{},[2016],{"type":55,"value":2017},"Security Groups",{"type":49,"tag":68,"props":2019,"children":2020},{},[2021],{"type":55,"value":2022},"Load Balancer",{"type":49,"tag":68,"props":2024,"children":2025},{},[2026],{"type":55,"value":2027},"RDS",{"type":49,"tag":68,"props":2029,"children":2030},{},[2031],{"type":55,"value":2032},"Bastion Host",{"type":49,"tag":430,"props":2034,"children":2036},{"id":2035},"visualization",[2037],{"type":55,"value":2038},"Visualization",{"type":49,"tag":58,"props":2040,"children":2041},{},[2042,2044,2050],{"type":55,"value":2043},"Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the ",{"type":49,"tag":326,"props":2045,"children":2047},{"className":2046},[],[2048],{"type":55,"value":2049},"Resources",{"type":55,"value":2051}," tab of the ad hoc base stack in the Pulumi console.",{"type":49,"tag":58,"props":2053,"children":2054},{},[2055],{"type":49,"tag":1601,"props":2056,"children":2059},{"alt":2057,"src":2058},"Graph view of ad hoc base infrastructure","/static/pulumi_ad_hoc_base_dep_graph.png",[],{"type":49,"tag":430,"props":2061,"children":2063},{"id":2062},"inputs",[2064],{"type":55,"value":2065},"Inputs",{"type":49,"tag":58,"props":2067,"children":2068},{},[2069],{"type":55,"value":2070},"There are only two required inputs for the ad hoc base stack",{"type":49,"tag":64,"props":2072,"children":2073},{},[2074,2079],{"type":49,"tag":68,"props":2075,"children":2076},{},[2077],{"type":55,"value":2078},"ACM certificate ARN",{"type":49,"tag":68,"props":2080,"children":2081},{},[2082],{"type":55,"value":2083},"Domain Name",{"type":49,"tag":58,"props":2085,"children":2086},{},[2087],{"type":55,"value":2088},"I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy/apply/up or synth/plan/preview.",{"type":49,"tag":430,"props":2090,"children":2092},{"id":2091},"vpc",[2093],{"type":55,"value":2094},"VPC",{"type":49,"tag":58,"props":2096,"children":2097},{},[2098,2100,2105],{"type":55,"value":2099},"The VPC is the first resource that is created as part of the ",{"type":49,"tag":326,"props":2101,"children":2103},{"className":2102},[],[2104],{"type":55,"value":1368},{"type":55,"value":2106}," stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources.",{"type":49,"tag":64,"props":2108,"children":2109},{},[2110,2121,2132],{"type":49,"tag":68,"props":2111,"children":2112},{},[2113,2119],{"type":49,"tag":326,"props":2114,"children":2116},{"className":2115},[],[2117],{"type":55,"value":2118},"awsx",{"type":55,"value":2120}," has a VPC module",{"type":49,"tag":68,"props":2122,"children":2123},{},[2124,2130],{"type":49,"tag":326,"props":2125,"children":2127},{"className":2126},[],[2128],{"type":55,"value":2129},"terraform-aws-vpc",{"type":55,"value":2131}," module",{"type":49,"tag":68,"props":2133,"children":2134},{},[2135],{"type":55,"value":2136},"L2 VPC Construct in CDK",{"type":49,"tag":58,"props":2138,"children":2139},{},[2140,2142,2148,2150,2156],{"type":55,"value":2141},"The setting in the Terraform VPC module ",{"type":49,"tag":326,"props":2143,"children":2145},{"className":2144},[],[2146],{"type":55,"value":2147},"one_nat_gateway_per_az = false",{"type":55,"value":2149}," doesn't seem to exist on the ",{"type":49,"tag":326,"props":2151,"children":2153},{"className":2152},[],[2154],{"type":55,"value":2155},"awsx.ec2.Vpc",{"type":55,"value":2157}," module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3.",{"type":49,"tag":430,"props":2159,"children":2161},{"id":2160},"security-groups",[2162],{"type":55,"value":2017},{"type":49,"tag":58,"props":2164,"children":2165},{},[2166],{"type":55,"value":2167},"Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups.",{"type":49,"tag":1050,"props":2169,"children":2173},{"code":2170,"language":2171,"meta":8,"className":2172,"style":8},"    const albSecurityGroup = new SecurityGroup(scope, 'AlbSecurityGroup', {\n      vpc: props.vpc,\n    });\n\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(443), 'HTTPS');\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(80), 'HTTP');\n","ts","language-ts shiki shiki-themes github-light github-dark monokai",[2174],{"type":49,"tag":326,"props":2175,"children":2176},{"__ignoreMap":8},[2177,2224,2232,2240,2247,2306],{"type":49,"tag":1060,"props":2178,"children":2179},{"class":1062,"line":1063},[2180,2186,2192,2198,2203,2208,2213,2219],{"type":49,"tag":1060,"props":2181,"children":2183},{"style":2182},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[2184],{"type":55,"value":2185},"    const",{"type":49,"tag":1060,"props":2187,"children":2189},{"style":2188},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[2190],{"type":55,"value":2191}," albSecurityGroup",{"type":49,"tag":1060,"props":2193,"children":2195},{"style":2194},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[2196],{"type":55,"value":2197}," =",{"type":49,"tag":1060,"props":2199,"children":2200},{"style":2194},[2201],{"type":55,"value":2202}," new",{"type":49,"tag":1060,"props":2204,"children":2205},{"style":1067},[2206],{"type":55,"value":2207}," SecurityGroup",{"type":49,"tag":1060,"props":2209,"children":2210},{"style":1073},[2211],{"type":55,"value":2212},"(scope, ",{"type":49,"tag":1060,"props":2214,"children":2216},{"style":2215},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[2217],{"type":55,"value":2218},"'AlbSecurityGroup'",{"type":49,"tag":1060,"props":2220,"children":2221},{"style":1073},[2222],{"type":55,"value":2223},", {\n",{"type":49,"tag":1060,"props":2225,"children":2226},{"class":1062,"line":1079},[2227],{"type":49,"tag":1060,"props":2228,"children":2229},{"style":1073},[2230],{"type":55,"value":2231},"      vpc: props.vpc,\n",{"type":49,"tag":1060,"props":2233,"children":2234},{"class":1062,"line":1088},[2235],{"type":49,"tag":1060,"props":2236,"children":2237},{"style":1073},[2238],{"type":55,"value":2239},"    });\n",{"type":49,"tag":1060,"props":2241,"children":2242},{"class":1062,"line":1097},[2243],{"type":49,"tag":1060,"props":2244,"children":2245},{"emptyLinePlaceholder":44},[2246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":2248,"children":2249},{"class":1062,"line":1111},[2250,2255,2260,2265,2270,2275,2280,2285,2291,2296,2301],{"type":49,"tag":1060,"props":2251,"children":2252},{"style":1073},[2253],{"type":55,"value":2254},"    albSecurityGroup.",{"type":49,"tag":1060,"props":2256,"children":2257},{"style":1067},[2258],{"type":55,"value":2259},"addIngressRule",{"type":49,"tag":1060,"props":2261,"children":2262},{"style":1073},[2263],{"type":55,"value":2264},"(Peer.",{"type":49,"tag":1060,"props":2266,"children":2267},{"style":1067},[2268],{"type":55,"value":2269},"anyIpv4",{"type":49,"tag":1060,"props":2271,"children":2272},{"style":1073},[2273],{"type":55,"value":2274},"(), Port.",{"type":49,"tag":1060,"props":2276,"children":2277},{"style":1067},[2278],{"type":55,"value":2279},"tcp",{"type":49,"tag":1060,"props":2281,"children":2282},{"style":1073},[2283],{"type":55,"value":2284},"(",{"type":49,"tag":1060,"props":2286,"children":2288},{"style":2287},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2289],{"type":55,"value":2290},"443",{"type":49,"tag":1060,"props":2292,"children":2293},{"style":1073},[2294],{"type":55,"value":2295},"), ",{"type":49,"tag":1060,"props":2297,"children":2298},{"style":2215},[2299],{"type":55,"value":2300},"'HTTPS'",{"type":49,"tag":1060,"props":2302,"children":2303},{"style":1073},[2304],{"type":55,"value":2305},");\n",{"type":49,"tag":1060,"props":2307,"children":2308},{"class":1062,"line":1120},[2309,2313,2317,2321,2325,2329,2333,2337,2342,2346,2351],{"type":49,"tag":1060,"props":2310,"children":2311},{"style":1073},[2312],{"type":55,"value":2254},{"type":49,"tag":1060,"props":2314,"children":2315},{"style":1067},[2316],{"type":55,"value":2259},{"type":49,"tag":1060,"props":2318,"children":2319},{"style":1073},[2320],{"type":55,"value":2264},{"type":49,"tag":1060,"props":2322,"children":2323},{"style":1067},[2324],{"type":55,"value":2269},{"type":49,"tag":1060,"props":2326,"children":2327},{"style":1073},[2328],{"type":55,"value":2274},{"type":49,"tag":1060,"props":2330,"children":2331},{"style":1067},[2332],{"type":55,"value":2279},{"type":49,"tag":1060,"props":2334,"children":2335},{"style":1073},[2336],{"type":55,"value":2284},{"type":49,"tag":1060,"props":2338,"children":2339},{"style":2287},[2340],{"type":55,"value":2341},"80",{"type":49,"tag":1060,"props":2343,"children":2344},{"style":1073},[2345],{"type":55,"value":2295},{"type":49,"tag":1060,"props":2347,"children":2348},{"style":2215},[2349],{"type":55,"value":2350},"'HTTP'",{"type":49,"tag":1060,"props":2352,"children":2353},{"style":1073},[2354],{"type":55,"value":2305},{"type":49,"tag":430,"props":2356,"children":2358},{"id":2357},"load-balancer-resources",[2359],{"type":55,"value":2360},"Load Balancer Resources",{"type":49,"tag":58,"props":2362,"children":2363},{},[2364],{"type":55,"value":2365},"There's not much to comment on here. In each library I have resource group that defines the following:",{"type":49,"tag":64,"props":2367,"children":2368},{},[2369,2374,2379,2384],{"type":49,"tag":68,"props":2370,"children":2371},{},[2372],{"type":55,"value":2373},"Application Load Balancer",{"type":49,"tag":68,"props":2375,"children":2376},{},[2377],{"type":55,"value":2378},"A default target group",{"type":49,"tag":68,"props":2380,"children":2381},{},[2382],{"type":55,"value":2383},"An HTTP listener that redirects to HTTPS",{"type":49,"tag":68,"props":2385,"children":2386},{},[2387],{"type":55,"value":2388},"An HTTPS listener with a default \"fixed-response\" action",{"type":49,"tag":58,"props":2390,"children":2391},{},[2392],{"type":55,"value":2393},"Properties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services.",{"type":49,"tag":58,"props":2395,"children":2396},{},[2397],{"type":55,"value":2398},"Ad hoc app environments all share a common load balancer from the base stack that they use.",{"type":49,"tag":430,"props":2400,"children":2402},{"id":2401},"rds-resources",[2403],{"type":55,"value":2404},"RDS Resources",{"type":49,"tag":58,"props":2406,"children":2407},{},[2408,2410,2415],{"type":55,"value":2409},"All three libraries have the RDS security group and Subnet Group in the same ",{"type":49,"tag":326,"props":2411,"children":2413},{"className":2412},[],[2414],{"type":55,"value":457},{"type":55,"value":2416}," as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources.",{"type":49,"tag":58,"props":2418,"children":2419},{},[2420],{"type":55,"value":2421},"Currently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment.",{"type":49,"tag":58,"props":2423,"children":2424},{},[2425],{"type":55,"value":2426},"The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential.",{"type":49,"tag":1050,"props":2428,"children":2430},{"code":2429,"language":2171,"meta":8,"className":2172,"style":8},"    const secret = new Secret(scope, 'dbSecret', {\n      secretName: props.dbSecretName,\n      description: 'secret for rds',\n      generateSecretString: {\n        secretStringTemplate: JSON.stringify({ username: 'postgres' }),\n        generateStringKey: 'password',\n        excludePunctuation: true,\n        includeSpace: false,\n      },\n    });\n",[2431],{"type":49,"tag":326,"props":2432,"children":2433},{"__ignoreMap":8},[2434,2472,2480,2498,2506,2543,2560,2577,2594,2602],{"type":49,"tag":1060,"props":2435,"children":2436},{"class":1062,"line":1063},[2437,2441,2446,2450,2454,2459,2463,2468],{"type":49,"tag":1060,"props":2438,"children":2439},{"style":2182},[2440],{"type":55,"value":2185},{"type":49,"tag":1060,"props":2442,"children":2443},{"style":2188},[2444],{"type":55,"value":2445}," secret",{"type":49,"tag":1060,"props":2447,"children":2448},{"style":2194},[2449],{"type":55,"value":2197},{"type":49,"tag":1060,"props":2451,"children":2452},{"style":2194},[2453],{"type":55,"value":2202},{"type":49,"tag":1060,"props":2455,"children":2456},{"style":1067},[2457],{"type":55,"value":2458}," Secret",{"type":49,"tag":1060,"props":2460,"children":2461},{"style":1073},[2462],{"type":55,"value":2212},{"type":49,"tag":1060,"props":2464,"children":2465},{"style":2215},[2466],{"type":55,"value":2467},"'dbSecret'",{"type":49,"tag":1060,"props":2469,"children":2470},{"style":1073},[2471],{"type":55,"value":2223},{"type":49,"tag":1060,"props":2473,"children":2474},{"class":1062,"line":1079},[2475],{"type":49,"tag":1060,"props":2476,"children":2477},{"style":1073},[2478],{"type":55,"value":2479},"      secretName: props.dbSecretName,\n",{"type":49,"tag":1060,"props":2481,"children":2482},{"class":1062,"line":1088},[2483,2488,2493],{"type":49,"tag":1060,"props":2484,"children":2485},{"style":1073},[2486],{"type":55,"value":2487},"      description: ",{"type":49,"tag":1060,"props":2489,"children":2490},{"style":2215},[2491],{"type":55,"value":2492},"'secret for rds'",{"type":49,"tag":1060,"props":2494,"children":2495},{"style":1073},[2496],{"type":55,"value":2497},",\n",{"type":49,"tag":1060,"props":2499,"children":2500},{"class":1062,"line":1097},[2501],{"type":49,"tag":1060,"props":2502,"children":2503},{"style":1073},[2504],{"type":55,"value":2505},"      generateSecretString: {\n",{"type":49,"tag":1060,"props":2507,"children":2508},{"class":1062,"line":1111},[2509,2514,2519,2523,2528,2533,2538],{"type":49,"tag":1060,"props":2510,"children":2511},{"style":1073},[2512],{"type":55,"value":2513},"        secretStringTemplate: ",{"type":49,"tag":1060,"props":2515,"children":2516},{"style":2188},[2517],{"type":55,"value":2518},"JSON",{"type":49,"tag":1060,"props":2520,"children":2521},{"style":1073},[2522],{"type":55,"value":745},{"type":49,"tag":1060,"props":2524,"children":2525},{"style":1067},[2526],{"type":55,"value":2527},"stringify",{"type":49,"tag":1060,"props":2529,"children":2530},{"style":1073},[2531],{"type":55,"value":2532},"({ username: ",{"type":49,"tag":1060,"props":2534,"children":2535},{"style":2215},[2536],{"type":55,"value":2537},"'postgres'",{"type":49,"tag":1060,"props":2539,"children":2540},{"style":1073},[2541],{"type":55,"value":2542}," }),\n",{"type":49,"tag":1060,"props":2544,"children":2545},{"class":1062,"line":1120},[2546,2551,2556],{"type":49,"tag":1060,"props":2547,"children":2548},{"style":1073},[2549],{"type":55,"value":2550},"        generateStringKey: ",{"type":49,"tag":1060,"props":2552,"children":2553},{"style":2215},[2554],{"type":55,"value":2555},"'password'",{"type":49,"tag":1060,"props":2557,"children":2558},{"style":1073},[2559],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2561,"children":2562},{"class":1062,"line":1128},[2563,2568,2573],{"type":49,"tag":1060,"props":2564,"children":2565},{"style":1073},[2566],{"type":55,"value":2567},"        excludePunctuation: ",{"type":49,"tag":1060,"props":2569,"children":2570},{"style":2287},[2571],{"type":55,"value":2572},"true",{"type":49,"tag":1060,"props":2574,"children":2575},{"style":1073},[2576],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2578,"children":2579},{"class":1062,"line":1141},[2580,2585,2590],{"type":49,"tag":1060,"props":2581,"children":2582},{"style":1073},[2583],{"type":55,"value":2584},"        includeSpace: ",{"type":49,"tag":1060,"props":2586,"children":2587},{"style":2287},[2588],{"type":55,"value":2589},"false",{"type":49,"tag":1060,"props":2591,"children":2592},{"style":1073},[2593],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2595,"children":2596},{"class":1062,"line":1150},[2597],{"type":49,"tag":1060,"props":2598,"children":2599},{"style":1073},[2600],{"type":55,"value":2601},"      },\n",{"type":49,"tag":1060,"props":2603,"children":2604},{"class":1062,"line":1158},[2605],{"type":49,"tag":1060,"props":2606,"children":2607},{"style":1073},[2608],{"type":55,"value":2239},{"type":49,"tag":58,"props":2610,"children":2611},{},[2612,2614,2620],{"type":55,"value":2613},"In the ",{"type":49,"tag":326,"props":2615,"children":2617},{"className":2616},[],[2618],{"type":55,"value":2619},"DatabaseInstance",{"type":55,"value":2621}," props we can then use this secret like so:",{"type":49,"tag":1050,"props":2623,"children":2625},{"code":2624},"    credentials: Credentials.fromSecret(secret),\n",[2626],{"type":49,"tag":326,"props":2627,"children":2628},{"__ignoreMap":8},[2629],{"type":55,"value":2624},{"type":49,"tag":58,"props":2631,"children":2632},{},[2633,2635,2641],{"type":55,"value":2634},"In the application deployed with CDK, I use a Django settings module package that uses a package called ",{"type":49,"tag":326,"props":2636,"children":2638},{"className":2637},[],[2639],{"type":55,"value":2640},"aws_secretsmanager_caching",{"type":55,"value":2642}," to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable.",{"type":49,"tag":58,"props":2644,"children":2645},{},[2646,2648,2654,2656,2667,2668,2679],{"type":55,"value":2647},"The Terraform and Pulumi database instance arguments simply accept a ",{"type":49,"tag":326,"props":2649,"children":2651},{"className":2650},[],[2652],{"type":55,"value":2653},"password",{"type":55,"value":2655}," field. This will be another item for the backlog for Terraform and Pulumi. The ",{"type":49,"tag":80,"props":2657,"children":2660},{"href":2658,"rel":2659},"https://www.pulumi.com/registry/packages/random/api-docs/randompassword/",[84],[2661],{"type":49,"tag":326,"props":2662,"children":2664},{"className":2663},[],[2665],{"type":55,"value":2666},"randompassword",{"type":55,"value":715},{"type":49,"tag":80,"props":2669,"children":2672},{"href":2670,"rel":2671},"https://www.pulumi.com/registry/packages/aws/api-docs/secretsmanager/secretversion/",[84],[2673],{"type":49,"tag":326,"props":2674,"children":2676},{"className":2675},[],[2677],{"type":55,"value":2678},"secretversion",{"type":55,"value":2680}," components can be used to do this.",{"type":49,"tag":430,"props":2682,"children":2684},{"id":2683},"bastion-host",[2685],{"type":55,"value":2032},{"type":49,"tag":58,"props":2687,"children":2688},{},[2689],{"type":55,"value":2690},"There are two main use cases for the bastion host in ad-hoc environments.",{"type":49,"tag":64,"props":2692,"children":2693},{},[2694,2707],{"type":49,"tag":68,"props":2695,"children":2696},{},[2697,2699,2705],{"type":55,"value":2698},"When creating a new ad hoc app environment, the bastion host is used to create a new database called ",{"type":49,"tag":326,"props":2700,"children":2702},{"className":2701},[],[2703],{"type":55,"value":2704},"{ad-hoc-env-name}-db",{"type":55,"value":2706}," that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now).",{"type":49,"tag":68,"props":2708,"children":2709},{},[2710,2712,2718],{"type":55,"value":2711},"If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to ",{"type":49,"tag":326,"props":2713,"children":2715},{"className":2714},[],[2716],{"type":55,"value":2717},"localhost:5432",{"type":55,"value":2719}," on your local machine.",{"type":49,"tag":58,"props":2721,"children":2722},{},[2723],{"type":55,"value":2724},"You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:",{"type":49,"tag":1050,"props":2726,"children":2730},{"code":2727,"language":2728,"meta":8,"className":2729,"style":8},"aws ssm start-session --target $INSTANCE_ID\n","bash","language-bash shiki shiki-themes github-light github-dark monokai",[2731],{"type":49,"tag":326,"props":2732,"children":2733},{"__ignoreMap":8},[2734],{"type":49,"tag":1060,"props":2735,"children":2736},{"class":1062,"line":1063},[2737,2741,2746,2751,2756],{"type":49,"tag":1060,"props":2738,"children":2739},{"style":1067},[2740],{"type":55,"value":20},{"type":49,"tag":1060,"props":2742,"children":2743},{"style":2215},[2744],{"type":55,"value":2745}," ssm",{"type":49,"tag":1060,"props":2747,"children":2748},{"style":2215},[2749],{"type":55,"value":2750}," start-session",{"type":49,"tag":1060,"props":2752,"children":2753},{"style":2287},[2754],{"type":55,"value":2755}," --target",{"type":49,"tag":1060,"props":2757,"children":2758},{"style":1073},[2759],{"type":55,"value":2760}," $INSTANCE_ID\n",{"type":49,"tag":430,"props":2762,"children":2764},{"id":2763},"outputs",[2765],{"type":55,"value":2766},"Outputs",{"type":49,"tag":58,"props":2768,"children":2769},{},[2770],{"type":55,"value":2771},"Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:",{"type":49,"tag":64,"props":2773,"children":2774},{},[2775,2780,2785,2790,2795,2800,2805,2810,2815,2820],{"type":49,"tag":68,"props":2776,"children":2777},{},[2778],{"type":55,"value":2779},"vpc_id",{"type":49,"tag":68,"props":2781,"children":2782},{},[2783],{"type":55,"value":2784},"assets_bucket_name",{"type":49,"tag":68,"props":2786,"children":2787},{},[2788],{"type":55,"value":2789},"private_subnet_ids",{"type":49,"tag":68,"props":2791,"children":2792},{},[2793],{"type":55,"value":2794},"app_sg_id",{"type":49,"tag":68,"props":2796,"children":2797},{},[2798],{"type":55,"value":2799},"alb_sg_id",{"type":49,"tag":68,"props":2801,"children":2802},{},[2803],{"type":55,"value":2804},"listener_arn",{"type":49,"tag":68,"props":2806,"children":2807},{},[2808],{"type":55,"value":2809},"alb_dns_name",{"type":49,"tag":68,"props":2811,"children":2812},{},[2813],{"type":55,"value":2814},"task_role_arn",{"type":49,"tag":68,"props":2816,"children":2817},{},[2818],{"type":55,"value":2819},"execution_role_arn",{"type":49,"tag":68,"props":2821,"children":2822},{},[2823],{"type":55,"value":2824},"rds_address",{"type":49,"tag":58,"props":2826,"children":2827},{},[2828,2830,2836,2837,2843,2845,2850],{"type":55,"value":2829},"In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like ",{"type":49,"tag":326,"props":2831,"children":2833},{"className":2832},[],[2834],{"type":55,"value":2835},"Vpc",{"type":55,"value":715},{"type":49,"tag":326,"props":2838,"children":2840},{"className":2839},[],[2841],{"type":55,"value":2842},"RdsInstance",{"type":55,"value":2844},". More on this later in the following section ",{"type":49,"tag":72,"props":2846,"children":2847},{},[2848],{"type":55,"value":2849},"Passing data between stacks",{"type":55,"value":745},{"type":49,"tag":50,"props":2852,"children":2854},{"id":2853},"ad-hoc-app-overview",[2855],{"type":55,"value":2856},"Ad hoc app overview",{"type":49,"tag":58,"props":2858,"children":2859},{},[2860],{"type":55,"value":2861},"The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc.",{"type":49,"tag":58,"props":2863,"children":2864},{},[2865],{"type":55,"value":2866},"This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console.",{"type":49,"tag":58,"props":2868,"children":2869},{},[2870],{"type":49,"tag":1601,"props":2871,"children":2874},{"alt":2872,"src":2873},"Graph view of ad hoc app infrastructure","/static/pulumi_ad_hoc_app_dep_graph.png",[],{"type":49,"tag":430,"props":2876,"children":2878},{"id":2877},"ecs-cluster",[2879],{"type":55,"value":2880},"ECS Cluster",{"type":49,"tag":64,"props":2882,"children":2883},{},[2884,2889],{"type":49,"tag":68,"props":2885,"children":2886},{},[2887],{"type":55,"value":2888},"This is a small component that defines both ECS Cluster and the default capacity providers",{"type":49,"tag":68,"props":2890,"children":2891},{},[2892,2894,2900,2902,2907],{"type":55,"value":2893},"It defaults to not using ",{"type":49,"tag":326,"props":2895,"children":2897},{"className":2896},[],[2898],{"type":55,"value":2899},"FARGATE_SPOT",{"type":55,"value":2901},"; ad hoc environments do use ",{"type":49,"tag":326,"props":2903,"children":2905},{"className":2904},[],[2906],{"type":55,"value":2899},{"type":55,"value":2908}," for cost savings",{"type":49,"tag":2910,"props":2911,"children":2912},"blockquote",{},[2913],{"type":49,"tag":58,"props":2914,"children":2915},{},[2916,2918,2925],{"type":55,"value":2917},"NOTE: defaultCapacityProviderStrategy on cluster not currently supported. (",{"type":49,"tag":80,"props":2919,"children":2922},{"href":2920,"rel":2921},"https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ecs.CapacityProviderStrategy.html",[84],[2923],{"type":55,"value":2924},"link",{"type":55,"value":616},{"type":49,"tag":430,"props":2927,"children":2929},{"id":2928},"shared-environment-variables",[2930],{"type":55,"value":2931},"Shared environment variables",{"type":49,"tag":58,"props":2933,"children":2934},{},[2935,2937,2942],{"type":55,"value":2936},"The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource ",{"type":49,"tag":326,"props":2938,"children":2940},{"className":2939},[],[2941],{"type":55,"value":457},{"type":55,"value":2943},"s.",{"type":49,"tag":64,"props":2945,"children":2946},{},[2947,2975,2986,2997,3009],{"type":49,"tag":68,"props":2948,"children":2949},{},[2950,2952,2958,2960,2966,2968,2974],{"type":55,"value":2951},"I struggled to get this right in pulumi. A lot of Pulumi examples used ",{"type":49,"tag":326,"props":2953,"children":2955},{"className":2954},[],[2956],{"type":55,"value":2957},"JSON.stringify",{"type":55,"value":2959}," for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use ",{"type":49,"tag":326,"props":2961,"children":2963},{"className":2962},[],[2964],{"type":55,"value":2965},"pulumi.jsonStringify",{"type":55,"value":2967}," which was added in a relatively recent version of ",{"type":49,"tag":326,"props":2969,"children":2971},{"className":2970},[],[2972],{"type":55,"value":2973},"pulumi/pulumi",{"type":55,"value":745},{"type":49,"tag":68,"props":2976,"children":2977},{},[2978,2980],{"type":55,"value":2979},"CDK allows you to declare environment variables for a containerDefinition like ",{"type":49,"tag":326,"props":2981,"children":2983},{"className":2982},[],[2984],{"type":55,"value":2985},"{ FOO: \"bar\" }",{"type":49,"tag":68,"props":2987,"children":2988},{},[2989,2991],{"type":55,"value":2990},"Pulumi and Terraform require that values are passed like ",{"type":49,"tag":326,"props":2992,"children":2994},{"className":2993},[],[2995],{"type":55,"value":2996},"{ name: \"FOO\", value: \"bar\"}",{"type":49,"tag":68,"props":2998,"children":2999},{},[3000,3002,3007],{"type":55,"value":3001},"You could transform ",{"type":49,"tag":326,"props":3003,"children":3005},{"className":3004},[],[3006],{"type":55,"value":2985},{"type":55,"value":3008}," into the name/value format, but I didn't bother to do this",{"type":49,"tag":68,"props":3010,"children":3011},{},[3012,3014,3020],{"type":55,"value":3013},"extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the ",{"type":49,"tag":326,"props":3015,"children":3017},{"className":3016},[],[3018],{"type":55,"value":3019},"concat",{"type":55,"value":3021}," function to add these to the list of default environment variables.",{"type":49,"tag":58,"props":3023,"children":3024},{},[3025],{"type":55,"value":3026},"Here's what the code looks like for joining extra environment variables to the default environment variables:",{"type":49,"tag":1050,"props":3028,"children":3030},{"code":3029,"language":2171,"meta":8,"className":2172,"style":8},"    // CDK\n    if (extraEnvVars) {\n      environmentVariables = { ...extraEnvVars, ...environmentVariables };\n    }\n",[3031],{"type":49,"tag":326,"props":3032,"children":3033},{"__ignoreMap":8},[3034,3043,3056,3093],{"type":49,"tag":1060,"props":3035,"children":3036},{"class":1062,"line":1063},[3037],{"type":49,"tag":1060,"props":3038,"children":3040},{"style":3039},"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F",[3041],{"type":55,"value":3042},"    // CDK\n",{"type":49,"tag":1060,"props":3044,"children":3045},{"class":1062,"line":1079},[3046,3051],{"type":49,"tag":1060,"props":3047,"children":3048},{"style":2194},[3049],{"type":55,"value":3050},"    if",{"type":49,"tag":1060,"props":3052,"children":3053},{"style":1073},[3054],{"type":55,"value":3055}," (extraEnvVars) {\n",{"type":49,"tag":1060,"props":3057,"children":3058},{"class":1062,"line":1088},[3059,3064,3069,3074,3079,3084,3088],{"type":49,"tag":1060,"props":3060,"children":3061},{"style":1073},[3062],{"type":55,"value":3063},"      environmentVariables ",{"type":49,"tag":1060,"props":3065,"children":3066},{"style":2194},[3067],{"type":55,"value":3068},"=",{"type":49,"tag":1060,"props":3070,"children":3071},{"style":1073},[3072],{"type":55,"value":3073}," { ",{"type":49,"tag":1060,"props":3075,"children":3076},{"style":2194},[3077],{"type":55,"value":3078},"...",{"type":49,"tag":1060,"props":3080,"children":3081},{"style":1073},[3082],{"type":55,"value":3083},"extraEnvVars, ",{"type":49,"tag":1060,"props":3085,"children":3086},{"style":2194},[3087],{"type":55,"value":3078},{"type":49,"tag":1060,"props":3089,"children":3090},{"style":1073},[3091],{"type":55,"value":3092},"environmentVariables };\n",{"type":49,"tag":1060,"props":3094,"children":3095},{"class":1062,"line":1097},[3096],{"type":49,"tag":1060,"props":3097,"children":3098},{"style":1073},[3099],{"type":55,"value":3100},"    }\n",{"type":49,"tag":1050,"props":3102,"children":3104},{"code":3103},"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n",[3105],{"type":49,"tag":326,"props":3106,"children":3107},{"__ignoreMap":8},[3108],{"type":55,"value":3103},{"type":49,"tag":1050,"props":3110,"children":3112},{"code":3111},"    // Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x => x.concat(extraEnvVars!))\n    }\n",[3113],{"type":49,"tag":326,"props":3114,"children":3115},{"__ignoreMap":8},[3116],{"type":55,"value":3111},{"type":49,"tag":430,"props":3118,"children":3120},{"id":3119},"route53-record",[3121],{"type":55,"value":3122},"Route53 Record",{"type":49,"tag":58,"props":3124,"children":3125},{},[3126],{"type":55,"value":3127},"This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns.",{"type":49,"tag":58,"props":3129,"children":3130},{},[3131,3133,3139,3141,3147],{"type":55,"value":3132},"This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching ",{"type":49,"tag":326,"props":3134,"children":3136},{"className":3135},[],[3137],{"type":55,"value":3138},"example.com/api/*",{"type":55,"value":3140}," are routed to the backend API and all other requests matching ",{"type":49,"tag":326,"props":3142,"children":3144},{"className":3143},[],[3145],{"type":55,"value":3146},"example.com/*",{"type":55,"value":3148}," are routed to the frontend service.",{"type":49,"tag":430,"props":3150,"children":3152},{"id":3151},"redis",[3153],{"type":55,"value":3154},"Redis",{"type":49,"tag":58,"props":3156,"children":3157},{},[3158],{"type":55,"value":3159},"I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis.",{"type":49,"tag":58,"props":3161,"children":3162},{},[3163],{"type":55,"value":3164},"I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable.",{"type":49,"tag":430,"props":3166,"children":3168},{"id":3167},"web-service",[3169],{"type":55,"value":3170},"Web Service",{"type":49,"tag":58,"props":3172,"children":3173},{},[3174,3176,3181,3183,3189,3191,3197,3198,3204,3206,3212],{"type":55,"value":3175},"The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This ",{"type":49,"tag":326,"props":3177,"children":3179},{"className":3178},[],[3180],{"type":55,"value":457},{"type":55,"value":3182}," has an input parameter called ",{"type":49,"tag":326,"props":3184,"children":3186},{"className":3185},[],[3187],{"type":55,"value":3188},"pathPatterns",{"type":55,"value":3190}," which determines which paths it serves. For example, the API container may serve traffic for ",{"type":49,"tag":326,"props":3192,"children":3194},{"className":3193},[],[3195],{"type":55,"value":3196},"/api/*",{"type":55,"value":715},{"type":49,"tag":326,"props":3199,"children":3201},{"className":3200},[],[3202],{"type":55,"value":3203},"/admin/*",{"type":55,"value":3205}," only, or it may want to serve all traffic (",{"type":49,"tag":326,"props":3207,"children":3209},{"className":3208},[],[3210],{"type":55,"value":3211},"/*",{"type":55,"value":3213},").",{"type":49,"tag":58,"props":3215,"children":3216},{},[3217],{"type":55,"value":3218},"The way I use these components in ad hoc and prod environments is heavily opinionated in that:",{"type":49,"tag":64,"props":3220,"children":3221},{},[3222],{"type":49,"tag":68,"props":3223,"children":3224},{},[3225,3227,3232,3234,3239,3240,3245,3246,3252],{"type":55,"value":3226},"it assumes that the frontend SPA/SSR site should have a lower priority rule than the backend service and should route request paths matching ",{"type":49,"tag":326,"props":3228,"children":3230},{"className":3229},[],[3231],{"type":55,"value":3211},{"type":55,"value":3233},", while the backend service routes requests for a specific list of path patterns (",{"type":49,"tag":326,"props":3235,"children":3237},{"className":3236},[],[3238],{"type":55,"value":3196},{"type":55,"value":873},{"type":49,"tag":326,"props":3241,"children":3243},{"className":3242},[],[3244],{"type":55,"value":3203},{"type":55,"value":873},{"type":49,"tag":326,"props":3247,"children":3249},{"className":3248},[],[3250],{"type":55,"value":3251},"/graphql/*",{"type":55,"value":3253},", etc.).",{"type":49,"tag":58,"props":3255,"children":3256},{},[3257],{"type":55,"value":3258},"You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring.",{"type":49,"tag":430,"props":3260,"children":3262},{"id":3261},"celery",[3263],{"type":55,"value":3264},"Celery",{"type":49,"tag":64,"props":3266,"children":3267},{},[3268,3273],{"type":49,"tag":68,"props":3269,"children":3270},{},[3271],{"type":55,"value":3272},"The reason for having a celery service is to be able to have potentially multiple workers that scale independently",{"type":49,"tag":68,"props":3274,"children":3275},{},[3276],{"type":55,"value":3277},"I use the same Pulumi component for both works and schedulers",{"type":49,"tag":58,"props":3279,"children":3280},{},[3281,3283,3289,3291,3296],{"type":55,"value":3282},"The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like ",{"type":49,"tag":326,"props":3284,"children":3286},{"className":3285},[],[3287],{"type":55,"value":3288},"AsyncWorker",{"type":55,"value":3290}," across the board rather than using the term ",{"type":49,"tag":326,"props":3292,"children":3294},{"className":3293},[],[3295],{"type":55,"value":3261},{"type":55,"value":745},{"type":49,"tag":430,"props":3298,"children":3300},{"id":3299},"management-command",[3301],{"type":55,"value":3302},"Management Command",{"type":49,"tag":64,"props":3304,"children":3305},{},[3306,3324],{"type":49,"tag":68,"props":3307,"children":3308},{},[3309,3311,3317,3318],{"type":55,"value":3310},"Defines a task that can be used to run commands like ",{"type":49,"tag":326,"props":3312,"children":3314},{"className":3313},[],[3315],{"type":55,"value":3316},"collectstatic",{"type":55,"value":715},{"type":49,"tag":326,"props":3319,"children":3321},{"className":3320},[],[3322],{"type":55,"value":3323},"migrate",{"type":49,"tag":68,"props":3325,"children":3326},{},[3327,3329,3334],{"type":55,"value":3328},"These tasks are ran both after the initial ",{"type":49,"tag":326,"props":3330,"children":3332},{"className":3331},[],[3333],{"type":55,"value":1375},{"type":55,"value":3335}," stack deployment and before rolling application upgrades",{"type":49,"tag":58,"props":3337,"children":3338},{},[3339,3341,3346,3347,3352],{"type":55,"value":3340},"In my Django app I have a single management command that calls ",{"type":49,"tag":326,"props":3342,"children":3344},{"className":3343},[],[3345],{"type":55,"value":3323},{"type":55,"value":715},{"type":49,"tag":326,"props":3348,"children":3350},{"className":3349},[],[3351],{"type":55,"value":3316},{"type":55,"value":3353}," and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc.",{"type":49,"tag":58,"props":3355,"children":3356},{},[3357,3359,3364],{"type":55,"value":3358},"One other thing to note about this ",{"type":49,"tag":326,"props":3360,"children":3362},{"className":3361},[],[3363],{"type":55,"value":457},{"type":55,"value":3365}," is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:",{"type":49,"tag":64,"props":3367,"children":3368},{},[3369,3382,3387,3392,3403],{"type":49,"tag":68,"props":3370,"children":3371},{},[3372,3374,3380],{"type":55,"value":3373},"saves the ",{"type":49,"tag":326,"props":3375,"children":3377},{"className":3376},[],[3378],{"type":55,"value":3379},"START",{"type":55,"value":3381}," timestamp",{"type":49,"tag":68,"props":3383,"children":3384},{},[3385],{"type":55,"value":3386},"runs the task with the required settings",{"type":49,"tag":68,"props":3388,"children":3389},{},[3390],{"type":55,"value":3391},"waits for the task to complete",{"type":49,"tag":68,"props":3393,"children":3394},{},[3395,3396,3402],{"type":55,"value":3373},{"type":49,"tag":326,"props":3397,"children":3399},{"className":3398},[],[3400],{"type":55,"value":3401},"END",{"type":55,"value":3381},{"type":49,"tag":68,"props":3404,"children":3405},{},[3406,3408,3413,3414,3419,3421],{"type":55,"value":3407},"collects the logs for the task between ",{"type":49,"tag":326,"props":3409,"children":3411},{"className":3410},[],[3412],{"type":55,"value":3379},{"type":55,"value":715},{"type":49,"tag":326,"props":3415,"children":3417},{"className":3416},[],[3418],{"type":55,"value":3401},{"type":55,"value":3420}," and prints them to ",{"type":49,"tag":326,"props":3422,"children":3424},{"className":3423},[],[3425],{"type":55,"value":3426},"stdout",{"type":49,"tag":58,"props":3428,"children":3429},{},[3430],{"type":55,"value":3431},"Here's an example of what the script looks like in Pulumi:",{"type":49,"tag":1050,"props":3433,"children":3435},{"code":3434,"language":2171,"meta":8,"className":2172,"style":8},"    const executionScript = pulumi.interpolate`#!/bin/bash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster ${props.ecsClusterId} --task-definition ${taskDefinition.arn} --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[${props.privateSubnetIds.apply(x => x.join(\",\"))}],securityGroups=[${props.appSgId}],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster ${props.ecsClusterId}\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name ${cwLoggingResources.cwLogGroupName} --log-stream-name ${props.name}/${props.name}/\\${TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n`;\n    this.executionScript = executionScript;\n",[3436],{"type":49,"tag":326,"props":3437,"children":3438},{"__ignoreMap":8},[3439,3470,3478,3647,3676,3684,3779,3792],{"type":49,"tag":1060,"props":3440,"children":3441},{"class":1062,"line":1063},[3442,3446,3451,3455,3460,3465],{"type":49,"tag":1060,"props":3443,"children":3444},{"style":2182},[3445],{"type":55,"value":2185},{"type":49,"tag":1060,"props":3447,"children":3448},{"style":2188},[3449],{"type":55,"value":3450}," executionScript",{"type":49,"tag":1060,"props":3452,"children":3453},{"style":2194},[3454],{"type":55,"value":2197},{"type":49,"tag":1060,"props":3456,"children":3457},{"style":1073},[3458],{"type":55,"value":3459}," pulumi.",{"type":49,"tag":1060,"props":3461,"children":3462},{"style":1067},[3463],{"type":55,"value":3464},"interpolate",{"type":49,"tag":1060,"props":3466,"children":3467},{"style":2215},[3468],{"type":55,"value":3469},"`#!/bin/bash\n",{"type":49,"tag":1060,"props":3471,"children":3472},{"class":1062,"line":1079},[3473],{"type":49,"tag":1060,"props":3474,"children":3475},{"style":2215},[3476],{"type":55,"value":3477},"START_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3479,"children":3480},{"class":1062,"line":1088},[3481,3486,3492,3497,3502,3507,3512,3517,3521,3526,3530,3535,3539,3544,3548,3552,3556,3561,3565,3569,3573,3579,3584,3589,3593,3598,3602,3607,3612,3616,3621,3625,3629,3633,3638,3642],{"type":49,"tag":1060,"props":3482,"children":3483},{"style":2215},[3484],{"type":55,"value":3485},"TASK_ID=$(aws ecs run-task --cluster ",{"type":49,"tag":1060,"props":3487,"children":3489},{"style":3488},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672",[3490],{"type":55,"value":3491},"${",{"type":49,"tag":1060,"props":3493,"children":3494},{"style":1073},[3495],{"type":55,"value":3496},"props",{"type":49,"tag":1060,"props":3498,"children":3500},{"style":3499},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2",[3501],{"type":55,"value":745},{"type":49,"tag":1060,"props":3503,"children":3504},{"style":1073},[3505],{"type":55,"value":3506},"ecsClusterId",{"type":49,"tag":1060,"props":3508,"children":3509},{"style":3488},[3510],{"type":55,"value":3511},"}",{"type":49,"tag":1060,"props":3513,"children":3514},{"style":2215},[3515],{"type":55,"value":3516}," --task-definition ",{"type":49,"tag":1060,"props":3518,"children":3519},{"style":3488},[3520],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3522,"children":3523},{"style":1073},[3524],{"type":55,"value":3525},"taskDefinition",{"type":49,"tag":1060,"props":3527,"children":3528},{"style":3499},[3529],{"type":55,"value":745},{"type":49,"tag":1060,"props":3531,"children":3532},{"style":1073},[3533],{"type":55,"value":3534},"arn",{"type":49,"tag":1060,"props":3536,"children":3537},{"style":3488},[3538],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3540,"children":3541},{"style":2215},[3542],{"type":55,"value":3543}," --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":3545,"children":3546},{"style":3488},[3547],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3549,"children":3550},{"style":1073},[3551],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3553,"children":3554},{"style":3499},[3555],{"type":55,"value":745},{"type":49,"tag":1060,"props":3557,"children":3558},{"style":1073},[3559],{"type":55,"value":3560},"privateSubnetIds",{"type":49,"tag":1060,"props":3562,"children":3563},{"style":3499},[3564],{"type":55,"value":745},{"type":49,"tag":1060,"props":3566,"children":3567},{"style":1067},[3568],{"type":55,"value":472},{"type":49,"tag":1060,"props":3570,"children":3571},{"style":3499},[3572],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3574,"children":3576},{"style":3575},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[3577],{"type":55,"value":3578},"x",{"type":49,"tag":1060,"props":3580,"children":3581},{"style":2182},[3582],{"type":55,"value":3583}," =>",{"type":49,"tag":1060,"props":3585,"children":3586},{"style":1073},[3587],{"type":55,"value":3588}," x",{"type":49,"tag":1060,"props":3590,"children":3591},{"style":3499},[3592],{"type":55,"value":745},{"type":49,"tag":1060,"props":3594,"children":3595},{"style":1067},[3596],{"type":55,"value":3597},"join",{"type":49,"tag":1060,"props":3599,"children":3600},{"style":3499},[3601],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3603,"children":3604},{"style":2215},[3605],{"type":55,"value":3606},"\",\"",{"type":49,"tag":1060,"props":3608,"children":3609},{"style":3499},[3610],{"type":55,"value":3611},"))",{"type":49,"tag":1060,"props":3613,"children":3614},{"style":3488},[3615],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3617,"children":3618},{"style":2215},[3619],{"type":55,"value":3620},"],securityGroups=[",{"type":49,"tag":1060,"props":3622,"children":3623},{"style":3488},[3624],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3626,"children":3627},{"style":1073},[3628],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3630,"children":3631},{"style":3499},[3632],{"type":55,"value":745},{"type":49,"tag":1060,"props":3634,"children":3635},{"style":1073},[3636],{"type":55,"value":3637},"appSgId",{"type":49,"tag":1060,"props":3639,"children":3640},{"style":3488},[3641],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3643,"children":3644},{"style":2215},[3645],{"type":55,"value":3646},"],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\n",{"type":49,"tag":1060,"props":3648,"children":3649},{"class":1062,"line":1097},[3650,3655,3659,3663,3667,3671],{"type":49,"tag":1060,"props":3651,"children":3652},{"style":2215},[3653],{"type":55,"value":3654},"aws ecs wait tasks-stopped --tasks $TASK_ID --cluster ",{"type":49,"tag":1060,"props":3656,"children":3657},{"style":3488},[3658],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3660,"children":3661},{"style":1073},[3662],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3664,"children":3665},{"style":3499},[3666],{"type":55,"value":745},{"type":49,"tag":1060,"props":3668,"children":3669},{"style":1073},[3670],{"type":55,"value":3506},{"type":49,"tag":1060,"props":3672,"children":3673},{"style":3488},[3674],{"type":55,"value":3675},"}\n",{"type":49,"tag":1060,"props":3677,"children":3678},{"class":1062,"line":1111},[3679],{"type":49,"tag":1060,"props":3680,"children":3681},{"style":2215},[3682],{"type":55,"value":3683},"END_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3685,"children":3686},{"class":1062,"line":1120},[3687,3692,3696,3701,3705,3710,3714,3719,3723,3727,3731,3736,3740,3745,3749,3753,3757,3761,3765,3769,3774],{"type":49,"tag":1060,"props":3688,"children":3689},{"style":2215},[3690],{"type":55,"value":3691},"aws logs get-log-events --log-group-name ",{"type":49,"tag":1060,"props":3693,"children":3694},{"style":3488},[3695],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3697,"children":3698},{"style":1073},[3699],{"type":55,"value":3700},"cwLoggingResources",{"type":49,"tag":1060,"props":3702,"children":3703},{"style":3499},[3704],{"type":55,"value":745},{"type":49,"tag":1060,"props":3706,"children":3707},{"style":1073},[3708],{"type":55,"value":3709},"cwLogGroupName",{"type":49,"tag":1060,"props":3711,"children":3712},{"style":3488},[3713],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3715,"children":3716},{"style":2215},[3717],{"type":55,"value":3718}," --log-stream-name ",{"type":49,"tag":1060,"props":3720,"children":3721},{"style":3488},[3722],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3724,"children":3725},{"style":1073},[3726],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3728,"children":3729},{"style":3499},[3730],{"type":55,"value":745},{"type":49,"tag":1060,"props":3732,"children":3733},{"style":1073},[3734],{"type":55,"value":3735},"name",{"type":49,"tag":1060,"props":3737,"children":3738},{"style":3488},[3739],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3741,"children":3742},{"style":2215},[3743],{"type":55,"value":3744},"/",{"type":49,"tag":1060,"props":3746,"children":3747},{"style":3488},[3748],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3750,"children":3751},{"style":1073},[3752],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3754,"children":3755},{"style":3499},[3756],{"type":55,"value":745},{"type":49,"tag":1060,"props":3758,"children":3759},{"style":1073},[3760],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3762,"children":3763},{"style":3488},[3764],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3766,"children":3767},{"style":2215},[3768],{"type":55,"value":3744},{"type":49,"tag":1060,"props":3770,"children":3771},{"style":2287},[3772],{"type":55,"value":3773},"\\$",{"type":49,"tag":1060,"props":3775,"children":3776},{"style":2215},[3777],{"type":55,"value":3778},"{TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n",{"type":49,"tag":1060,"props":3780,"children":3781},{"class":1062,"line":1128},[3782,3787],{"type":49,"tag":1060,"props":3783,"children":3784},{"style":2215},[3785],{"type":55,"value":3786},"`",{"type":49,"tag":1060,"props":3788,"children":3789},{"style":1073},[3790],{"type":55,"value":3791},";\n",{"type":49,"tag":1060,"props":3793,"children":3794},{"class":1062,"line":1141},[3795,3801,3806,3810],{"type":49,"tag":1060,"props":3796,"children":3798},{"style":3797},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[3799],{"type":55,"value":3800},"    this",{"type":49,"tag":1060,"props":3802,"children":3803},{"style":1073},[3804],{"type":55,"value":3805},".executionScript ",{"type":49,"tag":1060,"props":3807,"children":3808},{"style":2194},[3809],{"type":55,"value":3068},{"type":49,"tag":1060,"props":3811,"children":3812},{"style":1073},[3813],{"type":55,"value":3814}," executionScript;\n",{"type":49,"tag":58,"props":3816,"children":3817},{},[3818],{"type":55,"value":3819},"In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:",{"type":49,"tag":1050,"props":3821,"children":3825},{"code":3822,"language":3823,"meta":8,"className":3824,"style":8},"      - name: \"Run backend update command\"\n        id: run_backend_update\n        run: |\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          ./backend_update_command.sh\n","yaml","language-yaml shiki shiki-themes github-light github-dark monokai",[3826],{"type":49,"tag":326,"props":3827,"children":3828},{"__ignoreMap":8},[3829,3851,3868,3885,3893,3901,3909,3917,3925,3932,3940,3948,3956],{"type":49,"tag":1060,"props":3830,"children":3831},{"class":1062,"line":1063},[3832,3837,3842,3846],{"type":49,"tag":1060,"props":3833,"children":3834},{"style":1073},[3835],{"type":55,"value":3836},"      - ",{"type":49,"tag":1060,"props":3838,"children":3840},{"style":3839},"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[3841],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3843,"children":3844},{"style":1073},[3845],{"type":55,"value":78},{"type":49,"tag":1060,"props":3847,"children":3848},{"style":2215},[3849],{"type":55,"value":3850},"\"Run backend update command\"\n",{"type":49,"tag":1060,"props":3852,"children":3853},{"class":1062,"line":1079},[3854,3859,3863],{"type":49,"tag":1060,"props":3855,"children":3856},{"style":3839},[3857],{"type":55,"value":3858},"        id",{"type":49,"tag":1060,"props":3860,"children":3861},{"style":1073},[3862],{"type":55,"value":78},{"type":49,"tag":1060,"props":3864,"children":3865},{"style":2215},[3866],{"type":55,"value":3867},"run_backend_update\n",{"type":49,"tag":1060,"props":3869,"children":3870},{"class":1062,"line":1088},[3871,3876,3880],{"type":49,"tag":1060,"props":3872,"children":3873},{"style":3839},[3874],{"type":55,"value":3875},"        run",{"type":49,"tag":1060,"props":3877,"children":3878},{"style":1073},[3879],{"type":55,"value":78},{"type":49,"tag":1060,"props":3881,"children":3882},{"style":2194},[3883],{"type":55,"value":3884},"|\n",{"type":49,"tag":1060,"props":3886,"children":3887},{"class":1062,"line":1097},[3888],{"type":49,"tag":1060,"props":3889,"children":3890},{"style":2215},[3891],{"type":55,"value":3892},"          # get the script from the stack output with an output key that contains the string `backendUpdate`\n",{"type":49,"tag":1060,"props":3894,"children":3895},{"class":1062,"line":1111},[3896],{"type":49,"tag":1060,"props":3897,"children":3898},{"style":2215},[3899],{"type":55,"value":3900},"          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n",{"type":49,"tag":1060,"props":3902,"children":3903},{"class":1062,"line":1120},[3904],{"type":49,"tag":1060,"props":3905,"children":3906},{"style":2215},[3907],{"type":55,"value":3908},"            --stack-name $AD_HOC_APP_NAME \\\n",{"type":49,"tag":1060,"props":3910,"children":3911},{"class":1062,"line":1128},[3912],{"type":49,"tag":1060,"props":3913,"children":3914},{"style":2215},[3915],{"type":55,"value":3916},"            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n",{"type":49,"tag":1060,"props":3918,"children":3919},{"class":1062,"line":1141},[3920],{"type":49,"tag":1060,"props":3921,"children":3922},{"style":2215},[3923],{"type":55,"value":3924},"          )\n",{"type":49,"tag":1060,"props":3926,"children":3927},{"class":1062,"line":1150},[3928],{"type":49,"tag":1060,"props":3929,"children":3930},{"emptyLinePlaceholder":44},[3931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":3933,"children":3934},{"class":1062,"line":1158},[3935],{"type":49,"tag":1060,"props":3936,"children":3937},{"style":2215},[3938],{"type":55,"value":3939},"          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n",{"type":49,"tag":1060,"props":3941,"children":3942},{"class":1062,"line":1171},[3943],{"type":49,"tag":1060,"props":3944,"children":3945},{"style":2215},[3946],{"type":55,"value":3947},"          cat backend_update_command.sh\n",{"type":49,"tag":1060,"props":3949,"children":3950},{"class":1062,"line":1180},[3951],{"type":49,"tag":1060,"props":3952,"children":3953},{"style":2215},[3954],{"type":55,"value":3955},"          sudo chmod +x backend_update_command.sh\n",{"type":49,"tag":1060,"props":3957,"children":3958},{"class":1062,"line":1188},[3959],{"type":49,"tag":1060,"props":3960,"children":3961},{"style":2215},[3962],{"type":55,"value":3963},"          ./backend_update_command.sh\n",{"type":49,"tag":430,"props":3965,"children":3967},{"id":3966},"passing-data-between-stacks",[3968],{"type":55,"value":2849},{"type":49,"tag":58,"props":3970,"children":3971},{},[3972],{"type":55,"value":3973},"Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References.",{"type":49,"tag":58,"props":3975,"children":3976},{},[3977],{"type":55,"value":3978},"Here's what this looks like in Terraform",{"type":49,"tag":1050,"props":3980,"children":3983},{"code":3981,"language":16,"meta":8,"className":3982,"style":8},"data \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"../base/terraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"../../../modules/ad-hoc/app\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n","language-terraform shiki shiki-themes github-light github-dark monokai",[3984],{"type":49,"tag":326,"props":3985,"children":3986},{"__ignoreMap":8},[3987,4011,4028,4035,4051,4068,4076,4083,4090,4107,4124,4131,4183,4233,4282,4332,4381,4431,4480,4529,4579,4629,4680,4707],{"type":49,"tag":1060,"props":3988,"children":3989},{"class":1062,"line":1063},[3990,3996,4001,4006],{"type":49,"tag":1060,"props":3991,"children":3993},{"style":3992},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[3994],{"type":55,"value":3995},"data",{"type":49,"tag":1060,"props":3997,"children":3998},{"style":2188},[3999],{"type":55,"value":4000}," \"terraform_remote_state\"",{"type":49,"tag":1060,"props":4002,"children":4003},{"style":2188},[4004],{"type":55,"value":4005}," \"this\"",{"type":49,"tag":1060,"props":4007,"children":4008},{"style":1073},[4009],{"type":55,"value":4010}," {\n",{"type":49,"tag":1060,"props":4012,"children":4013},{"class":1062,"line":1079},[4014,4019,4023],{"type":49,"tag":1060,"props":4015,"children":4016},{"style":1073},[4017],{"type":55,"value":4018},"  backend",{"type":49,"tag":1060,"props":4020,"children":4021},{"style":2194},[4022],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4024,"children":4025},{"style":2215},[4026],{"type":55,"value":4027}," \"local\"\n",{"type":49,"tag":1060,"props":4029,"children":4030},{"class":1062,"line":1088},[4031],{"type":49,"tag":1060,"props":4032,"children":4033},{"emptyLinePlaceholder":44},[4034],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4036,"children":4037},{"class":1062,"line":1097},[4038,4043,4047],{"type":49,"tag":1060,"props":4039,"children":4040},{"style":1073},[4041],{"type":55,"value":4042},"  config",{"type":49,"tag":1060,"props":4044,"children":4045},{"style":2194},[4046],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4048,"children":4049},{"style":1073},[4050],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4052,"children":4053},{"class":1062,"line":1111},[4054,4059,4063],{"type":49,"tag":1060,"props":4055,"children":4056},{"style":1073},[4057],{"type":55,"value":4058},"    path ",{"type":49,"tag":1060,"props":4060,"children":4061},{"style":2194},[4062],{"type":55,"value":3068},{"type":49,"tag":1060,"props":4064,"children":4065},{"style":2215},[4066],{"type":55,"value":4067}," \"../base/terraform.tfstate\"\n",{"type":49,"tag":1060,"props":4069,"children":4070},{"class":1062,"line":1120},[4071],{"type":49,"tag":1060,"props":4072,"children":4073},{"style":1073},[4074],{"type":55,"value":4075},"  }\n",{"type":49,"tag":1060,"props":4077,"children":4078},{"class":1062,"line":1128},[4079],{"type":49,"tag":1060,"props":4080,"children":4081},{"style":1073},[4082],{"type":55,"value":3675},{"type":49,"tag":1060,"props":4084,"children":4085},{"class":1062,"line":1141},[4086],{"type":49,"tag":1060,"props":4087,"children":4088},{"emptyLinePlaceholder":44},[4089],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4091,"children":4092},{"class":1062,"line":1150},[4093,4098,4103],{"type":49,"tag":1060,"props":4094,"children":4095},{"style":3992},[4096],{"type":55,"value":4097},"module",{"type":49,"tag":1060,"props":4099,"children":4100},{"style":2188},[4101],{"type":55,"value":4102}," \"main\"",{"type":49,"tag":1060,"props":4104,"children":4105},{"style":1073},[4106],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4108,"children":4109},{"class":1062,"line":1158},[4110,4115,4119],{"type":49,"tag":1060,"props":4111,"children":4112},{"style":1073},[4113],{"type":55,"value":4114},"  source",{"type":49,"tag":1060,"props":4116,"children":4117},{"style":2194},[4118],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4120,"children":4121},{"style":2215},[4122],{"type":55,"value":4123}," \"../../../modules/ad-hoc/app\"\n",{"type":49,"tag":1060,"props":4125,"children":4126},{"class":1062,"line":1171},[4127],{"type":49,"tag":1060,"props":4128,"children":4129},{"emptyLinePlaceholder":44},[4130],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4132,"children":4133},{"class":1062,"line":1180},[4134,4139,4144,4149,4153,4157,4161,4166,4170,4174,4178],{"type":49,"tag":1060,"props":4135,"children":4136},{"style":1073},[4137],{"type":55,"value":4138},"  vpc_id",{"type":49,"tag":1060,"props":4140,"children":4141},{"style":2194},[4142],{"type":55,"value":4143},"                         =",{"type":49,"tag":1060,"props":4145,"children":4146},{"style":1073},[4147],{"type":55,"value":4148}," data",{"type":49,"tag":1060,"props":4150,"children":4151},{"style":2194},[4152],{"type":55,"value":745},{"type":49,"tag":1060,"props":4154,"children":4155},{"style":1073},[4156],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4158,"children":4159},{"style":2194},[4160],{"type":55,"value":745},{"type":49,"tag":1060,"props":4162,"children":4163},{"style":1073},[4164],{"type":55,"value":4165},"this",{"type":49,"tag":1060,"props":4167,"children":4168},{"style":2194},[4169],{"type":55,"value":745},{"type":49,"tag":1060,"props":4171,"children":4172},{"style":1073},[4173],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4175,"children":4176},{"style":2194},[4177],{"type":55,"value":745},{"type":49,"tag":1060,"props":4179,"children":4180},{"style":1073},[4181],{"type":55,"value":4182},"vpc_id\n",{"type":49,"tag":1060,"props":4184,"children":4185},{"class":1062,"line":1188},[4186,4191,4196,4200,4204,4208,4212,4216,4220,4224,4228],{"type":49,"tag":1060,"props":4187,"children":4188},{"style":1073},[4189],{"type":55,"value":4190},"  assets_bucket_name",{"type":49,"tag":1060,"props":4192,"children":4193},{"style":2194},[4194],{"type":55,"value":4195},"             =",{"type":49,"tag":1060,"props":4197,"children":4198},{"style":1073},[4199],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4201,"children":4202},{"style":2194},[4203],{"type":55,"value":745},{"type":49,"tag":1060,"props":4205,"children":4206},{"style":1073},[4207],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4209,"children":4210},{"style":2194},[4211],{"type":55,"value":745},{"type":49,"tag":1060,"props":4213,"children":4214},{"style":1073},[4215],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4217,"children":4218},{"style":2194},[4219],{"type":55,"value":745},{"type":49,"tag":1060,"props":4221,"children":4222},{"style":1073},[4223],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4225,"children":4226},{"style":2194},[4227],{"type":55,"value":745},{"type":49,"tag":1060,"props":4229,"children":4230},{"style":1073},[4231],{"type":55,"value":4232},"assets_bucket_name\n",{"type":49,"tag":1060,"props":4234,"children":4235},{"class":1062,"line":1201},[4236,4241,4245,4249,4253,4257,4261,4265,4269,4273,4277],{"type":49,"tag":1060,"props":4237,"children":4238},{"style":1073},[4239],{"type":55,"value":4240},"  private_subnet_ids",{"type":49,"tag":1060,"props":4242,"children":4243},{"style":2194},[4244],{"type":55,"value":4195},{"type":49,"tag":1060,"props":4246,"children":4247},{"style":1073},[4248],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4250,"children":4251},{"style":2194},[4252],{"type":55,"value":745},{"type":49,"tag":1060,"props":4254,"children":4255},{"style":1073},[4256],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4258,"children":4259},{"style":2194},[4260],{"type":55,"value":745},{"type":49,"tag":1060,"props":4262,"children":4263},{"style":1073},[4264],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4266,"children":4267},{"style":2194},[4268],{"type":55,"value":745},{"type":49,"tag":1060,"props":4270,"children":4271},{"style":1073},[4272],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4274,"children":4275},{"style":2194},[4276],{"type":55,"value":745},{"type":49,"tag":1060,"props":4278,"children":4279},{"style":1073},[4280],{"type":55,"value":4281},"private_subnet_ids\n",{"type":49,"tag":1060,"props":4283,"children":4284},{"class":1062,"line":1210},[4285,4290,4295,4299,4303,4307,4311,4315,4319,4323,4327],{"type":49,"tag":1060,"props":4286,"children":4287},{"style":1073},[4288],{"type":55,"value":4289},"  app_sg_id",{"type":49,"tag":1060,"props":4291,"children":4292},{"style":2194},[4293],{"type":55,"value":4294},"                      =",{"type":49,"tag":1060,"props":4296,"children":4297},{"style":1073},[4298],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4300,"children":4301},{"style":2194},[4302],{"type":55,"value":745},{"type":49,"tag":1060,"props":4304,"children":4305},{"style":1073},[4306],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4308,"children":4309},{"style":2194},[4310],{"type":55,"value":745},{"type":49,"tag":1060,"props":4312,"children":4313},{"style":1073},[4314],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4316,"children":4317},{"style":2194},[4318],{"type":55,"value":745},{"type":49,"tag":1060,"props":4320,"children":4321},{"style":1073},[4322],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4324,"children":4325},{"style":2194},[4326],{"type":55,"value":745},{"type":49,"tag":1060,"props":4328,"children":4329},{"style":1073},[4330],{"type":55,"value":4331},"app_sg_id\n",{"type":49,"tag":1060,"props":4333,"children":4334},{"class":1062,"line":1218},[4335,4340,4344,4348,4352,4356,4360,4364,4368,4372,4376],{"type":49,"tag":1060,"props":4336,"children":4337},{"style":1073},[4338],{"type":55,"value":4339},"  alb_sg_id",{"type":49,"tag":1060,"props":4341,"children":4342},{"style":2194},[4343],{"type":55,"value":4294},{"type":49,"tag":1060,"props":4345,"children":4346},{"style":1073},[4347],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4349,"children":4350},{"style":2194},[4351],{"type":55,"value":745},{"type":49,"tag":1060,"props":4353,"children":4354},{"style":1073},[4355],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4357,"children":4358},{"style":2194},[4359],{"type":55,"value":745},{"type":49,"tag":1060,"props":4361,"children":4362},{"style":1073},[4363],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4365,"children":4366},{"style":2194},[4367],{"type":55,"value":745},{"type":49,"tag":1060,"props":4369,"children":4370},{"style":1073},[4371],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4373,"children":4374},{"style":2194},[4375],{"type":55,"value":745},{"type":49,"tag":1060,"props":4377,"children":4378},{"style":1073},[4379],{"type":55,"value":4380},"alb_sg_id\n",{"type":49,"tag":1060,"props":4382,"children":4383},{"class":1062,"line":1232},[4384,4389,4394,4398,4402,4406,4410,4414,4418,4422,4426],{"type":49,"tag":1060,"props":4385,"children":4386},{"style":1073},[4387],{"type":55,"value":4388},"  listener_arn",{"type":49,"tag":1060,"props":4390,"children":4391},{"style":2194},[4392],{"type":55,"value":4393},"                   =",{"type":49,"tag":1060,"props":4395,"children":4396},{"style":1073},[4397],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4399,"children":4400},{"style":2194},[4401],{"type":55,"value":745},{"type":49,"tag":1060,"props":4403,"children":4404},{"style":1073},[4405],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4407,"children":4408},{"style":2194},[4409],{"type":55,"value":745},{"type":49,"tag":1060,"props":4411,"children":4412},{"style":1073},[4413],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4415,"children":4416},{"style":2194},[4417],{"type":55,"value":745},{"type":49,"tag":1060,"props":4419,"children":4420},{"style":1073},[4421],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4423,"children":4424},{"style":2194},[4425],{"type":55,"value":745},{"type":49,"tag":1060,"props":4427,"children":4428},{"style":1073},[4429],{"type":55,"value":4430},"listener_arn\n",{"type":49,"tag":1060,"props":4432,"children":4433},{"class":1062,"line":1241},[4434,4439,4443,4447,4451,4455,4459,4463,4467,4471,4475],{"type":49,"tag":1060,"props":4435,"children":4436},{"style":1073},[4437],{"type":55,"value":4438},"  alb_dns_name",{"type":49,"tag":1060,"props":4440,"children":4441},{"style":2194},[4442],{"type":55,"value":4393},{"type":49,"tag":1060,"props":4444,"children":4445},{"style":1073},[4446],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4448,"children":4449},{"style":2194},[4450],{"type":55,"value":745},{"type":49,"tag":1060,"props":4452,"children":4453},{"style":1073},[4454],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4456,"children":4457},{"style":2194},[4458],{"type":55,"value":745},{"type":49,"tag":1060,"props":4460,"children":4461},{"style":1073},[4462],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4464,"children":4465},{"style":2194},[4466],{"type":55,"value":745},{"type":49,"tag":1060,"props":4468,"children":4469},{"style":1073},[4470],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4472,"children":4473},{"style":2194},[4474],{"type":55,"value":745},{"type":49,"tag":1060,"props":4476,"children":4477},{"style":1073},[4478],{"type":55,"value":4479},"alb_dns_name\n",{"type":49,"tag":1060,"props":4481,"children":4482},{"class":1062,"line":1249},[4483,4488,4492,4496,4500,4504,4508,4512,4516,4520,4524],{"type":49,"tag":1060,"props":4484,"children":4485},{"style":1073},[4486],{"type":55,"value":4487},"  service_discovery_namespace_id",{"type":49,"tag":1060,"props":4489,"children":4490},{"style":2194},[4491],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4493,"children":4494},{"style":1073},[4495],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4497,"children":4498},{"style":2194},[4499],{"type":55,"value":745},{"type":49,"tag":1060,"props":4501,"children":4502},{"style":1073},[4503],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4505,"children":4506},{"style":2194},[4507],{"type":55,"value":745},{"type":49,"tag":1060,"props":4509,"children":4510},{"style":1073},[4511],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4513,"children":4514},{"style":2194},[4515],{"type":55,"value":745},{"type":49,"tag":1060,"props":4517,"children":4518},{"style":1073},[4519],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4521,"children":4522},{"style":2194},[4523],{"type":55,"value":745},{"type":49,"tag":1060,"props":4525,"children":4526},{"style":1073},[4527],{"type":55,"value":4528},"service_discovery_namespace_id\n",{"type":49,"tag":1060,"props":4530,"children":4531},{"class":1062,"line":1262},[4532,4537,4542,4546,4550,4554,4558,4562,4566,4570,4574],{"type":49,"tag":1060,"props":4533,"children":4534},{"style":1073},[4535],{"type":55,"value":4536},"  rds_address",{"type":49,"tag":1060,"props":4538,"children":4539},{"style":2194},[4540],{"type":55,"value":4541},"                    =",{"type":49,"tag":1060,"props":4543,"children":4544},{"style":1073},[4545],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4547,"children":4548},{"style":2194},[4549],{"type":55,"value":745},{"type":49,"tag":1060,"props":4551,"children":4552},{"style":1073},[4553],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4555,"children":4556},{"style":2194},[4557],{"type":55,"value":745},{"type":49,"tag":1060,"props":4559,"children":4560},{"style":1073},[4561],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4563,"children":4564},{"style":2194},[4565],{"type":55,"value":745},{"type":49,"tag":1060,"props":4567,"children":4568},{"style":1073},[4569],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4571,"children":4572},{"style":2194},[4573],{"type":55,"value":745},{"type":49,"tag":1060,"props":4575,"children":4576},{"style":1073},[4577],{"type":55,"value":4578},"rds_address\n",{"type":49,"tag":1060,"props":4580,"children":4582},{"class":1062,"line":4581},21,[4583,4588,4592,4596,4600,4604,4608,4612,4616,4620,4624],{"type":49,"tag":1060,"props":4584,"children":4585},{"style":1073},[4586],{"type":55,"value":4587},"  domain_name",{"type":49,"tag":1060,"props":4589,"children":4590},{"style":2194},[4591],{"type":55,"value":4541},{"type":49,"tag":1060,"props":4593,"children":4594},{"style":1073},[4595],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4597,"children":4598},{"style":2194},[4599],{"type":55,"value":745},{"type":49,"tag":1060,"props":4601,"children":4602},{"style":1073},[4603],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4605,"children":4606},{"style":2194},[4607],{"type":55,"value":745},{"type":49,"tag":1060,"props":4609,"children":4610},{"style":1073},[4611],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4613,"children":4614},{"style":2194},[4615],{"type":55,"value":745},{"type":49,"tag":1060,"props":4617,"children":4618},{"style":1073},[4619],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4621,"children":4622},{"style":2194},[4623],{"type":55,"value":745},{"type":49,"tag":1060,"props":4625,"children":4626},{"style":1073},[4627],{"type":55,"value":4628},"domain_name\n",{"type":49,"tag":1060,"props":4630,"children":4632},{"class":1062,"line":4631},22,[4633,4638,4643,4647,4651,4655,4659,4663,4667,4671,4675],{"type":49,"tag":1060,"props":4634,"children":4635},{"style":1073},[4636],{"type":55,"value":4637},"  base_stack_name",{"type":49,"tag":1060,"props":4639,"children":4640},{"style":2194},[4641],{"type":55,"value":4642},"                =",{"type":49,"tag":1060,"props":4644,"children":4645},{"style":1073},[4646],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4648,"children":4649},{"style":2194},[4650],{"type":55,"value":745},{"type":49,"tag":1060,"props":4652,"children":4653},{"style":1073},[4654],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4656,"children":4657},{"style":2194},[4658],{"type":55,"value":745},{"type":49,"tag":1060,"props":4660,"children":4661},{"style":1073},[4662],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4664,"children":4665},{"style":2194},[4666],{"type":55,"value":745},{"type":49,"tag":1060,"props":4668,"children":4669},{"style":1073},[4670],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4672,"children":4673},{"style":2194},[4674],{"type":55,"value":745},{"type":49,"tag":1060,"props":4676,"children":4677},{"style":1073},[4678],{"type":55,"value":4679},"base_stack_name\n",{"type":49,"tag":1060,"props":4681,"children":4683},{"class":1062,"line":4682},23,[4684,4689,4693,4698,4702],{"type":49,"tag":1060,"props":4685,"children":4686},{"style":1073},[4687],{"type":55,"value":4688},"  region",{"type":49,"tag":1060,"props":4690,"children":4691},{"style":2194},[4692],{"type":55,"value":4143},{"type":49,"tag":1060,"props":4694,"children":4695},{"style":1073},[4696],{"type":55,"value":4697}," var",{"type":49,"tag":1060,"props":4699,"children":4700},{"style":2194},[4701],{"type":55,"value":745},{"type":49,"tag":1060,"props":4703,"children":4704},{"style":1073},[4705],{"type":55,"value":4706},"region\n",{"type":49,"tag":1060,"props":4708,"children":4710},{"class":1062,"line":4709},24,[4711],{"type":49,"tag":1060,"props":4712,"children":4713},{"style":1073},[4714],{"type":55,"value":3675},{"type":49,"tag":58,"props":4716,"children":4717},{},[4718],{"type":55,"value":4719},"In CDK:",{"type":49,"tag":1050,"props":4721,"children":4723},{"code":4722,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n\nconst adHocBase = new AdHocBase(baseStack, 'AdHocBase', { certificateArn, domainName });\n\nconst addHocApp = new AdHocApp(appStack, 'AdHocApp', {\n  baseStackName: adHocBaseEnvName,\n  vpc: adHocBase.vpc,\n  alb: adHocBase.alb,\n  appSecurityGroup: adHocBase.appSecurityGroup,\n  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n  rdsInstance: adHocBase.databaseInstance,\n  assetsBucket: adHocBase.assetsBucket,\n  domainName: adHocBase.domainName,\n  listener: adHocBase.listener,\n});\n",[4724],{"type":49,"tag":326,"props":4725,"children":4726},{"__ignoreMap":8},[4727,4768,4795,4802,4840,4865,4872,4912,4919,4958,4966,4974,4982,4990,4998,5006,5014,5022,5030],{"type":49,"tag":1060,"props":4728,"children":4729},{"class":1062,"line":1063},[4730,4735,4740,4744,4748,4753,4758,4763],{"type":49,"tag":1060,"props":4731,"children":4732},{"style":2182},[4733],{"type":55,"value":4734},"const",{"type":49,"tag":1060,"props":4736,"children":4737},{"style":2188},[4738],{"type":55,"value":4739}," baseStack",{"type":49,"tag":1060,"props":4741,"children":4742},{"style":2194},[4743],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4745,"children":4746},{"style":2194},[4747],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4749,"children":4750},{"style":1067},[4751],{"type":55,"value":4752}," Stack",{"type":49,"tag":1060,"props":4754,"children":4755},{"style":1073},[4756],{"type":55,"value":4757},"(app, ",{"type":49,"tag":1060,"props":4759,"children":4760},{"style":2215},[4761],{"type":55,"value":4762},"'ExampleAdHocBaseStack'",{"type":49,"tag":1060,"props":4764,"children":4765},{"style":1073},[4766],{"type":55,"value":4767},", { env, stackName: adHocBaseEnvName });\n",{"type":49,"tag":1060,"props":4769,"children":4770},{"class":1062,"line":1079},[4771,4776,4781,4785,4790],{"type":49,"tag":1060,"props":4772,"children":4773},{"style":1073},[4774],{"type":55,"value":4775},"baseStack.node.",{"type":49,"tag":1060,"props":4777,"children":4778},{"style":1067},[4779],{"type":55,"value":4780},"setContext",{"type":49,"tag":1060,"props":4782,"children":4783},{"style":1073},[4784],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4786,"children":4787},{"style":2215},[4788],{"type":55,"value":4789},"'config'",{"type":49,"tag":1060,"props":4791,"children":4792},{"style":1073},[4793],{"type":55,"value":4794},", adHocBaseEnvConfig);\n",{"type":49,"tag":1060,"props":4796,"children":4797},{"class":1062,"line":1088},[4798],{"type":49,"tag":1060,"props":4799,"children":4800},{"emptyLinePlaceholder":44},[4801],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4803,"children":4804},{"class":1062,"line":1097},[4805,4809,4814,4818,4822,4826,4830,4835],{"type":49,"tag":1060,"props":4806,"children":4807},{"style":2182},[4808],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4810,"children":4811},{"style":2188},[4812],{"type":55,"value":4813}," appStack",{"type":49,"tag":1060,"props":4815,"children":4816},{"style":2194},[4817],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4819,"children":4820},{"style":2194},[4821],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4823,"children":4824},{"style":1067},[4825],{"type":55,"value":4752},{"type":49,"tag":1060,"props":4827,"children":4828},{"style":1073},[4829],{"type":55,"value":4757},{"type":49,"tag":1060,"props":4831,"children":4832},{"style":2215},[4833],{"type":55,"value":4834},"'ExampleAdHocAppStack'",{"type":49,"tag":1060,"props":4836,"children":4837},{"style":1073},[4838],{"type":55,"value":4839},", { env, stackName: adHocAppEnvName });\n",{"type":49,"tag":1060,"props":4841,"children":4842},{"class":1062,"line":1111},[4843,4848,4852,4856,4860],{"type":49,"tag":1060,"props":4844,"children":4845},{"style":1073},[4846],{"type":55,"value":4847},"appStack.node.",{"type":49,"tag":1060,"props":4849,"children":4850},{"style":1067},[4851],{"type":55,"value":4780},{"type":49,"tag":1060,"props":4853,"children":4854},{"style":1073},[4855],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4857,"children":4858},{"style":2215},[4859],{"type":55,"value":4789},{"type":49,"tag":1060,"props":4861,"children":4862},{"style":1073},[4863],{"type":55,"value":4864},", adHocAppEnvConfig);\n",{"type":49,"tag":1060,"props":4866,"children":4867},{"class":1062,"line":1120},[4868],{"type":49,"tag":1060,"props":4869,"children":4870},{"emptyLinePlaceholder":44},[4871],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4873,"children":4874},{"class":1062,"line":1128},[4875,4879,4884,4888,4892,4897,4902,4907],{"type":49,"tag":1060,"props":4876,"children":4877},{"style":2182},[4878],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4880,"children":4881},{"style":2188},[4882],{"type":55,"value":4883}," adHocBase",{"type":49,"tag":1060,"props":4885,"children":4886},{"style":2194},[4887],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4889,"children":4890},{"style":2194},[4891],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4893,"children":4894},{"style":1067},[4895],{"type":55,"value":4896}," AdHocBase",{"type":49,"tag":1060,"props":4898,"children":4899},{"style":1073},[4900],{"type":55,"value":4901},"(baseStack, ",{"type":49,"tag":1060,"props":4903,"children":4904},{"style":2215},[4905],{"type":55,"value":4906},"'AdHocBase'",{"type":49,"tag":1060,"props":4908,"children":4909},{"style":1073},[4910],{"type":55,"value":4911},", { certificateArn, domainName });\n",{"type":49,"tag":1060,"props":4913,"children":4914},{"class":1062,"line":1141},[4915],{"type":49,"tag":1060,"props":4916,"children":4917},{"emptyLinePlaceholder":44},[4918],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4920,"children":4921},{"class":1062,"line":1150},[4922,4926,4931,4935,4939,4944,4949,4954],{"type":49,"tag":1060,"props":4923,"children":4924},{"style":2182},[4925],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4927,"children":4928},{"style":2188},[4929],{"type":55,"value":4930}," addHocApp",{"type":49,"tag":1060,"props":4932,"children":4933},{"style":2194},[4934],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4936,"children":4937},{"style":2194},[4938],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4940,"children":4941},{"style":1067},[4942],{"type":55,"value":4943}," AdHocApp",{"type":49,"tag":1060,"props":4945,"children":4946},{"style":1073},[4947],{"type":55,"value":4948},"(appStack, ",{"type":49,"tag":1060,"props":4950,"children":4951},{"style":2215},[4952],{"type":55,"value":4953},"'AdHocApp'",{"type":49,"tag":1060,"props":4955,"children":4956},{"style":1073},[4957],{"type":55,"value":2223},{"type":49,"tag":1060,"props":4959,"children":4960},{"class":1062,"line":1158},[4961],{"type":49,"tag":1060,"props":4962,"children":4963},{"style":1073},[4964],{"type":55,"value":4965},"  baseStackName: adHocBaseEnvName,\n",{"type":49,"tag":1060,"props":4967,"children":4968},{"class":1062,"line":1171},[4969],{"type":49,"tag":1060,"props":4970,"children":4971},{"style":1073},[4972],{"type":55,"value":4973},"  vpc: adHocBase.vpc,\n",{"type":49,"tag":1060,"props":4975,"children":4976},{"class":1062,"line":1180},[4977],{"type":49,"tag":1060,"props":4978,"children":4979},{"style":1073},[4980],{"type":55,"value":4981},"  alb: adHocBase.alb,\n",{"type":49,"tag":1060,"props":4983,"children":4984},{"class":1062,"line":1188},[4985],{"type":49,"tag":1060,"props":4986,"children":4987},{"style":1073},[4988],{"type":55,"value":4989},"  appSecurityGroup: adHocBase.appSecurityGroup,\n",{"type":49,"tag":1060,"props":4991,"children":4992},{"class":1062,"line":1201},[4993],{"type":49,"tag":1060,"props":4994,"children":4995},{"style":1073},[4996],{"type":55,"value":4997},"  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n",{"type":49,"tag":1060,"props":4999,"children":5000},{"class":1062,"line":1210},[5001],{"type":49,"tag":1060,"props":5002,"children":5003},{"style":1073},[5004],{"type":55,"value":5005},"  rdsInstance: adHocBase.databaseInstance,\n",{"type":49,"tag":1060,"props":5007,"children":5008},{"class":1062,"line":1218},[5009],{"type":49,"tag":1060,"props":5010,"children":5011},{"style":1073},[5012],{"type":55,"value":5013},"  assetsBucket: adHocBase.assetsBucket,\n",{"type":49,"tag":1060,"props":5015,"children":5016},{"class":1062,"line":1232},[5017],{"type":49,"tag":1060,"props":5018,"children":5019},{"style":1073},[5020],{"type":55,"value":5021},"  domainName: adHocBase.domainName,\n",{"type":49,"tag":1060,"props":5023,"children":5024},{"class":1062,"line":1241},[5025],{"type":49,"tag":1060,"props":5026,"children":5027},{"style":1073},[5028],{"type":55,"value":5029},"  listener: adHocBase.listener,\n",{"type":49,"tag":1060,"props":5031,"children":5032},{"class":1062,"line":1249},[5033],{"type":49,"tag":1060,"props":5034,"children":5035},{"style":1073},[5036],{"type":55,"value":5037},"});\n",{"type":49,"tag":58,"props":5039,"children":5040},{},[5041],{"type":55,"value":5042},"and in Pulumi:",{"type":49,"tag":1050,"props":5044,"children":5046},{"code":5045,"language":2171,"meta":8,"className":2172,"style":8},"const stackReference = new pulumi.StackReference(`${org}/ad-hoc-base/${environment}`)\n\nconst vpcId = stackReference.getOutput(\"vpcId\") as pulumi.Output\u003Cstring>;\nconst assetsBucketName = stackReference.getOutput(\"assetsBucketName\") as pulumi.Output\u003Cstring>;\nconst privateSubnets = stackReference.getOutput(\"privateSubnetIds\") as pulumi.Output\u003Cstring[]>;\nconst appSgId = stackReference.getOutput(\"appSgId\") as pulumi.Output\u003Cstring>;\nconst albSgId = stackReference.getOutput(\"albSgId\") as pulumi.Output\u003Cstring>;\nconst listenerArn = stackReference.getOutput(\"listenerArn\") as pulumi.Output\u003Cstring>;\nconst albDnsName = stackReference.getOutput(\"albDnsName\") as pulumi.Output\u003Cstring>;\nconst serviceDiscoveryNamespaceId = stackReference.getOutput(\"serviceDiscoveryNamespaceId\") as pulumi.Output\u003Cstring>;\nconst rdsAddress = stackReference.getOutput(\"rdsAddress\") as pulumi.Output\u003Cstring>;\nconst domainName = stackReference.getOutput(\"domainName\") as pulumi.Output\u003Cstring>;\nconst baseStackName = stackReference.getOutput(\"baseStackName\") as pulumi.Output\u003Cstring>;\n\n// ad hoc app env\nconst adHocAppComponent = new AdHocAppComponent(\"AdHocAppComponent\", {\n  vpcId,\n  assetsBucketName,\n  privateSubnets,\n  appSgId,\n  albSgId,\n  listenerArn,\n  albDnsName,\n  serviceDiscoveryNamespaceId,\n  rdsAddress,\n  domainName,\n  baseStackName\n});\n",[5047],{"type":49,"tag":326,"props":5048,"children":5049},{"__ignoreMap":8},[5050,5127,5134,5209,5274,5340,5405,5470,5535,5600,5665,5730,5795,5860,5867,5875,5913,5921,5929,5937,5945,5953,5961,5969,5977,5986,5995,6004],{"type":49,"tag":1060,"props":5051,"children":5052},{"class":1062,"line":1063},[5053,5057,5062,5066,5070,5074,5079,5083,5087,5091,5096,5100,5105,5109,5114,5118,5122],{"type":49,"tag":1060,"props":5054,"children":5055},{"style":2182},[5056],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5058,"children":5059},{"style":2188},[5060],{"type":55,"value":5061}," stackReference",{"type":49,"tag":1060,"props":5063,"children":5064},{"style":2194},[5065],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5067,"children":5068},{"style":2194},[5069],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5071,"children":5072},{"style":1073},[5073],{"type":55,"value":3459},{"type":49,"tag":1060,"props":5075,"children":5076},{"style":1067},[5077],{"type":55,"value":5078},"StackReference",{"type":49,"tag":1060,"props":5080,"children":5081},{"style":1073},[5082],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5084,"children":5085},{"style":2215},[5086],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5088,"children":5089},{"style":3488},[5090],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5092,"children":5093},{"style":1073},[5094],{"type":55,"value":5095},"org",{"type":49,"tag":1060,"props":5097,"children":5098},{"style":3488},[5099],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5101,"children":5102},{"style":2215},[5103],{"type":55,"value":5104},"/ad-hoc-base/",{"type":49,"tag":1060,"props":5106,"children":5107},{"style":3488},[5108],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5110,"children":5111},{"style":1073},[5112],{"type":55,"value":5113},"environment",{"type":49,"tag":1060,"props":5115,"children":5116},{"style":3488},[5117],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5119,"children":5120},{"style":2215},[5121],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5123,"children":5124},{"style":1073},[5125],{"type":55,"value":5126},")\n",{"type":49,"tag":1060,"props":5128,"children":5129},{"class":1062,"line":1079},[5130],{"type":49,"tag":1060,"props":5131,"children":5132},{"emptyLinePlaceholder":44},[5133],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5135,"children":5136},{"class":1062,"line":1088},[5137,5141,5146,5150,5155,5160,5164,5169,5174,5179,5184,5188,5193,5198,5204],{"type":49,"tag":1060,"props":5138,"children":5139},{"style":2182},[5140],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5142,"children":5143},{"style":2188},[5144],{"type":55,"value":5145}," vpcId",{"type":49,"tag":1060,"props":5147,"children":5148},{"style":2194},[5149],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5151,"children":5152},{"style":1073},[5153],{"type":55,"value":5154}," stackReference.",{"type":49,"tag":1060,"props":5156,"children":5157},{"style":1067},[5158],{"type":55,"value":5159},"getOutput",{"type":49,"tag":1060,"props":5161,"children":5162},{"style":1073},[5163],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5165,"children":5166},{"style":2215},[5167],{"type":55,"value":5168},"\"vpcId\"",{"type":49,"tag":1060,"props":5170,"children":5171},{"style":1073},[5172],{"type":55,"value":5173},") ",{"type":49,"tag":1060,"props":5175,"children":5176},{"style":2194},[5177],{"type":55,"value":5178},"as",{"type":49,"tag":1060,"props":5180,"children":5181},{"style":3992},[5182],{"type":55,"value":5183}," pulumi",{"type":49,"tag":1060,"props":5185,"children":5186},{"style":1073},[5187],{"type":55,"value":745},{"type":49,"tag":1060,"props":5189,"children":5190},{"style":3992},[5191],{"type":55,"value":5192},"Output",{"type":49,"tag":1060,"props":5194,"children":5195},{"style":1073},[5196],{"type":55,"value":5197},"\u003C",{"type":49,"tag":1060,"props":5199,"children":5201},{"style":5200},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[5202],{"type":55,"value":5203},"string",{"type":49,"tag":1060,"props":5205,"children":5206},{"style":1073},[5207],{"type":55,"value":5208},">;\n",{"type":49,"tag":1060,"props":5210,"children":5211},{"class":1062,"line":1097},[5212,5216,5221,5225,5229,5233,5237,5242,5246,5250,5254,5258,5262,5266,5270],{"type":49,"tag":1060,"props":5213,"children":5214},{"style":2182},[5215],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5217,"children":5218},{"style":2188},[5219],{"type":55,"value":5220}," assetsBucketName",{"type":49,"tag":1060,"props":5222,"children":5223},{"style":2194},[5224],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5226,"children":5227},{"style":1073},[5228],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5230,"children":5231},{"style":1067},[5232],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5234,"children":5235},{"style":1073},[5236],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5238,"children":5239},{"style":2215},[5240],{"type":55,"value":5241},"\"assetsBucketName\"",{"type":49,"tag":1060,"props":5243,"children":5244},{"style":1073},[5245],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5247,"children":5248},{"style":2194},[5249],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5251,"children":5252},{"style":3992},[5253],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5255,"children":5256},{"style":1073},[5257],{"type":55,"value":745},{"type":49,"tag":1060,"props":5259,"children":5260},{"style":3992},[5261],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5263,"children":5264},{"style":1073},[5265],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5267,"children":5268},{"style":5200},[5269],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5271,"children":5272},{"style":1073},[5273],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5275,"children":5276},{"class":1062,"line":1111},[5277,5281,5286,5290,5294,5298,5302,5307,5311,5315,5319,5323,5327,5331,5335],{"type":49,"tag":1060,"props":5278,"children":5279},{"style":2182},[5280],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5282,"children":5283},{"style":2188},[5284],{"type":55,"value":5285}," privateSubnets",{"type":49,"tag":1060,"props":5287,"children":5288},{"style":2194},[5289],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5291,"children":5292},{"style":1073},[5293],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5295,"children":5296},{"style":1067},[5297],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5299,"children":5300},{"style":1073},[5301],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5303,"children":5304},{"style":2215},[5305],{"type":55,"value":5306},"\"privateSubnetIds\"",{"type":49,"tag":1060,"props":5308,"children":5309},{"style":1073},[5310],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5312,"children":5313},{"style":2194},[5314],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5316,"children":5317},{"style":3992},[5318],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5320,"children":5321},{"style":1073},[5322],{"type":55,"value":745},{"type":49,"tag":1060,"props":5324,"children":5325},{"style":3992},[5326],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5328,"children":5329},{"style":1073},[5330],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5332,"children":5333},{"style":5200},[5334],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5336,"children":5337},{"style":1073},[5338],{"type":55,"value":5339},"[]>;\n",{"type":49,"tag":1060,"props":5341,"children":5342},{"class":1062,"line":1120},[5343,5347,5352,5356,5360,5364,5368,5373,5377,5381,5385,5389,5393,5397,5401],{"type":49,"tag":1060,"props":5344,"children":5345},{"style":2182},[5346],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5348,"children":5349},{"style":2188},[5350],{"type":55,"value":5351}," appSgId",{"type":49,"tag":1060,"props":5353,"children":5354},{"style":2194},[5355],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5357,"children":5358},{"style":1073},[5359],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5361,"children":5362},{"style":1067},[5363],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5365,"children":5366},{"style":1073},[5367],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5369,"children":5370},{"style":2215},[5371],{"type":55,"value":5372},"\"appSgId\"",{"type":49,"tag":1060,"props":5374,"children":5375},{"style":1073},[5376],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5378,"children":5379},{"style":2194},[5380],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5382,"children":5383},{"style":3992},[5384],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5386,"children":5387},{"style":1073},[5388],{"type":55,"value":745},{"type":49,"tag":1060,"props":5390,"children":5391},{"style":3992},[5392],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5394,"children":5395},{"style":1073},[5396],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5398,"children":5399},{"style":5200},[5400],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5402,"children":5403},{"style":1073},[5404],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5406,"children":5407},{"class":1062,"line":1128},[5408,5412,5417,5421,5425,5429,5433,5438,5442,5446,5450,5454,5458,5462,5466],{"type":49,"tag":1060,"props":5409,"children":5410},{"style":2182},[5411],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5413,"children":5414},{"style":2188},[5415],{"type":55,"value":5416}," albSgId",{"type":49,"tag":1060,"props":5418,"children":5419},{"style":2194},[5420],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5422,"children":5423},{"style":1073},[5424],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5426,"children":5427},{"style":1067},[5428],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5430,"children":5431},{"style":1073},[5432],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5434,"children":5435},{"style":2215},[5436],{"type":55,"value":5437},"\"albSgId\"",{"type":49,"tag":1060,"props":5439,"children":5440},{"style":1073},[5441],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5443,"children":5444},{"style":2194},[5445],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5447,"children":5448},{"style":3992},[5449],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5451,"children":5452},{"style":1073},[5453],{"type":55,"value":745},{"type":49,"tag":1060,"props":5455,"children":5456},{"style":3992},[5457],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5459,"children":5460},{"style":1073},[5461],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5463,"children":5464},{"style":5200},[5465],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5467,"children":5468},{"style":1073},[5469],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5471,"children":5472},{"class":1062,"line":1141},[5473,5477,5482,5486,5490,5494,5498,5503,5507,5511,5515,5519,5523,5527,5531],{"type":49,"tag":1060,"props":5474,"children":5475},{"style":2182},[5476],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5478,"children":5479},{"style":2188},[5480],{"type":55,"value":5481}," listenerArn",{"type":49,"tag":1060,"props":5483,"children":5484},{"style":2194},[5485],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5487,"children":5488},{"style":1073},[5489],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5491,"children":5492},{"style":1067},[5493],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5495,"children":5496},{"style":1073},[5497],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5499,"children":5500},{"style":2215},[5501],{"type":55,"value":5502},"\"listenerArn\"",{"type":49,"tag":1060,"props":5504,"children":5505},{"style":1073},[5506],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5508,"children":5509},{"style":2194},[5510],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5512,"children":5513},{"style":3992},[5514],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5516,"children":5517},{"style":1073},[5518],{"type":55,"value":745},{"type":49,"tag":1060,"props":5520,"children":5521},{"style":3992},[5522],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5524,"children":5525},{"style":1073},[5526],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5528,"children":5529},{"style":5200},[5530],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5532,"children":5533},{"style":1073},[5534],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5536,"children":5537},{"class":1062,"line":1150},[5538,5542,5547,5551,5555,5559,5563,5568,5572,5576,5580,5584,5588,5592,5596],{"type":49,"tag":1060,"props":5539,"children":5540},{"style":2182},[5541],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5543,"children":5544},{"style":2188},[5545],{"type":55,"value":5546}," albDnsName",{"type":49,"tag":1060,"props":5548,"children":5549},{"style":2194},[5550],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5552,"children":5553},{"style":1073},[5554],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5556,"children":5557},{"style":1067},[5558],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5560,"children":5561},{"style":1073},[5562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5564,"children":5565},{"style":2215},[5566],{"type":55,"value":5567},"\"albDnsName\"",{"type":49,"tag":1060,"props":5569,"children":5570},{"style":1073},[5571],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5573,"children":5574},{"style":2194},[5575],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5577,"children":5578},{"style":3992},[5579],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5581,"children":5582},{"style":1073},[5583],{"type":55,"value":745},{"type":49,"tag":1060,"props":5585,"children":5586},{"style":3992},[5587],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5589,"children":5590},{"style":1073},[5591],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5593,"children":5594},{"style":5200},[5595],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5597,"children":5598},{"style":1073},[5599],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5601,"children":5602},{"class":1062,"line":1158},[5603,5607,5612,5616,5620,5624,5628,5633,5637,5641,5645,5649,5653,5657,5661],{"type":49,"tag":1060,"props":5604,"children":5605},{"style":2182},[5606],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5608,"children":5609},{"style":2188},[5610],{"type":55,"value":5611}," serviceDiscoveryNamespaceId",{"type":49,"tag":1060,"props":5613,"children":5614},{"style":2194},[5615],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5617,"children":5618},{"style":1073},[5619],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5621,"children":5622},{"style":1067},[5623],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5625,"children":5626},{"style":1073},[5627],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5629,"children":5630},{"style":2215},[5631],{"type":55,"value":5632},"\"serviceDiscoveryNamespaceId\"",{"type":49,"tag":1060,"props":5634,"children":5635},{"style":1073},[5636],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5638,"children":5639},{"style":2194},[5640],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5642,"children":5643},{"style":3992},[5644],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5646,"children":5647},{"style":1073},[5648],{"type":55,"value":745},{"type":49,"tag":1060,"props":5650,"children":5651},{"style":3992},[5652],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5654,"children":5655},{"style":1073},[5656],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5658,"children":5659},{"style":5200},[5660],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5662,"children":5663},{"style":1073},[5664],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5666,"children":5667},{"class":1062,"line":1171},[5668,5672,5677,5681,5685,5689,5693,5698,5702,5706,5710,5714,5718,5722,5726],{"type":49,"tag":1060,"props":5669,"children":5670},{"style":2182},[5671],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5673,"children":5674},{"style":2188},[5675],{"type":55,"value":5676}," rdsAddress",{"type":49,"tag":1060,"props":5678,"children":5679},{"style":2194},[5680],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5682,"children":5683},{"style":1073},[5684],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5686,"children":5687},{"style":1067},[5688],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5690,"children":5691},{"style":1073},[5692],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5694,"children":5695},{"style":2215},[5696],{"type":55,"value":5697},"\"rdsAddress\"",{"type":49,"tag":1060,"props":5699,"children":5700},{"style":1073},[5701],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5703,"children":5704},{"style":2194},[5705],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5707,"children":5708},{"style":3992},[5709],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5711,"children":5712},{"style":1073},[5713],{"type":55,"value":745},{"type":49,"tag":1060,"props":5715,"children":5716},{"style":3992},[5717],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5719,"children":5720},{"style":1073},[5721],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5723,"children":5724},{"style":5200},[5725],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5727,"children":5728},{"style":1073},[5729],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5731,"children":5732},{"class":1062,"line":1180},[5733,5737,5742,5746,5750,5754,5758,5763,5767,5771,5775,5779,5783,5787,5791],{"type":49,"tag":1060,"props":5734,"children":5735},{"style":2182},[5736],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5738,"children":5739},{"style":2188},[5740],{"type":55,"value":5741}," domainName",{"type":49,"tag":1060,"props":5743,"children":5744},{"style":2194},[5745],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5747,"children":5748},{"style":1073},[5749],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5751,"children":5752},{"style":1067},[5753],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5755,"children":5756},{"style":1073},[5757],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5759,"children":5760},{"style":2215},[5761],{"type":55,"value":5762},"\"domainName\"",{"type":49,"tag":1060,"props":5764,"children":5765},{"style":1073},[5766],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5768,"children":5769},{"style":2194},[5770],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5772,"children":5773},{"style":3992},[5774],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5776,"children":5777},{"style":1073},[5778],{"type":55,"value":745},{"type":49,"tag":1060,"props":5780,"children":5781},{"style":3992},[5782],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5784,"children":5785},{"style":1073},[5786],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5788,"children":5789},{"style":5200},[5790],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5792,"children":5793},{"style":1073},[5794],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5796,"children":5797},{"class":1062,"line":1188},[5798,5802,5807,5811,5815,5819,5823,5828,5832,5836,5840,5844,5848,5852,5856],{"type":49,"tag":1060,"props":5799,"children":5800},{"style":2182},[5801],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5803,"children":5804},{"style":2188},[5805],{"type":55,"value":5806}," baseStackName",{"type":49,"tag":1060,"props":5808,"children":5809},{"style":2194},[5810],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5812,"children":5813},{"style":1073},[5814],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5816,"children":5817},{"style":1067},[5818],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5820,"children":5821},{"style":1073},[5822],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5824,"children":5825},{"style":2215},[5826],{"type":55,"value":5827},"\"baseStackName\"",{"type":49,"tag":1060,"props":5829,"children":5830},{"style":1073},[5831],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5833,"children":5834},{"style":2194},[5835],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5837,"children":5838},{"style":3992},[5839],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5841,"children":5842},{"style":1073},[5843],{"type":55,"value":745},{"type":49,"tag":1060,"props":5845,"children":5846},{"style":3992},[5847],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5849,"children":5850},{"style":1073},[5851],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5853,"children":5854},{"style":5200},[5855],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5857,"children":5858},{"style":1073},[5859],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5861,"children":5862},{"class":1062,"line":1201},[5863],{"type":49,"tag":1060,"props":5864,"children":5865},{"emptyLinePlaceholder":44},[5866],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5868,"children":5869},{"class":1062,"line":1210},[5870],{"type":49,"tag":1060,"props":5871,"children":5872},{"style":3039},[5873],{"type":55,"value":5874},"// ad hoc app env\n",{"type":49,"tag":1060,"props":5876,"children":5877},{"class":1062,"line":1218},[5878,5882,5887,5891,5895,5900,5904,5909],{"type":49,"tag":1060,"props":5879,"children":5880},{"style":2182},[5881],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5883,"children":5884},{"style":2188},[5885],{"type":55,"value":5886}," adHocAppComponent",{"type":49,"tag":1060,"props":5888,"children":5889},{"style":2194},[5890],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5892,"children":5893},{"style":2194},[5894],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5896,"children":5897},{"style":1067},[5898],{"type":55,"value":5899}," AdHocAppComponent",{"type":49,"tag":1060,"props":5901,"children":5902},{"style":1073},[5903],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5905,"children":5906},{"style":2215},[5907],{"type":55,"value":5908},"\"AdHocAppComponent\"",{"type":49,"tag":1060,"props":5910,"children":5911},{"style":1073},[5912],{"type":55,"value":2223},{"type":49,"tag":1060,"props":5914,"children":5915},{"class":1062,"line":1232},[5916],{"type":49,"tag":1060,"props":5917,"children":5918},{"style":1073},[5919],{"type":55,"value":5920},"  vpcId,\n",{"type":49,"tag":1060,"props":5922,"children":5923},{"class":1062,"line":1241},[5924],{"type":49,"tag":1060,"props":5925,"children":5926},{"style":1073},[5927],{"type":55,"value":5928},"  assetsBucketName,\n",{"type":49,"tag":1060,"props":5930,"children":5931},{"class":1062,"line":1249},[5932],{"type":49,"tag":1060,"props":5933,"children":5934},{"style":1073},[5935],{"type":55,"value":5936},"  privateSubnets,\n",{"type":49,"tag":1060,"props":5938,"children":5939},{"class":1062,"line":1262},[5940],{"type":49,"tag":1060,"props":5941,"children":5942},{"style":1073},[5943],{"type":55,"value":5944},"  appSgId,\n",{"type":49,"tag":1060,"props":5946,"children":5947},{"class":1062,"line":4581},[5948],{"type":49,"tag":1060,"props":5949,"children":5950},{"style":1073},[5951],{"type":55,"value":5952},"  albSgId,\n",{"type":49,"tag":1060,"props":5954,"children":5955},{"class":1062,"line":4631},[5956],{"type":49,"tag":1060,"props":5957,"children":5958},{"style":1073},[5959],{"type":55,"value":5960},"  listenerArn,\n",{"type":49,"tag":1060,"props":5962,"children":5963},{"class":1062,"line":4682},[5964],{"type":49,"tag":1060,"props":5965,"children":5966},{"style":1073},[5967],{"type":55,"value":5968},"  albDnsName,\n",{"type":49,"tag":1060,"props":5970,"children":5971},{"class":1062,"line":4709},[5972],{"type":49,"tag":1060,"props":5973,"children":5974},{"style":1073},[5975],{"type":55,"value":5976},"  serviceDiscoveryNamespaceId,\n",{"type":49,"tag":1060,"props":5978,"children":5980},{"class":1062,"line":5979},25,[5981],{"type":49,"tag":1060,"props":5982,"children":5983},{"style":1073},[5984],{"type":55,"value":5985},"  rdsAddress,\n",{"type":49,"tag":1060,"props":5987,"children":5989},{"class":1062,"line":5988},26,[5990],{"type":49,"tag":1060,"props":5991,"children":5992},{"style":1073},[5993],{"type":55,"value":5994},"  domainName,\n",{"type":49,"tag":1060,"props":5996,"children":5998},{"class":1062,"line":5997},27,[5999],{"type":49,"tag":1060,"props":6000,"children":6001},{"style":1073},[6002],{"type":55,"value":6003},"  baseStackName\n",{"type":49,"tag":1060,"props":6005,"children":6007},{"class":1062,"line":6006},28,[6008],{"type":49,"tag":1060,"props":6009,"children":6010},{"style":1073},[6011],{"type":55,"value":5037},{"type":49,"tag":50,"props":6013,"children":6015},{"id":6014},"cli-scaffolding",[6016],{"type":55,"value":6017},"CLI scaffolding",{"type":49,"tag":58,"props":6019,"children":6020},{},[6021],{"type":55,"value":6022},"CDK and Pulumi have some good options for how to scaffold a project.",{"type":49,"tag":64,"props":6024,"children":6025},{},[6026,6054,6066,6084],{"type":49,"tag":68,"props":6027,"children":6028},{},[6029,6031,6037,6039,6045,6047,6052],{"type":55,"value":6030},"Pulumi has ",{"type":49,"tag":326,"props":6032,"children":6034},{"className":6033},[],[6035],{"type":55,"value":6036},"pulumi new aws-typescript",{"type":55,"value":6038}," among lots of other options (run ",{"type":49,"tag":326,"props":6040,"children":6042},{"className":6041},[],[6043],{"type":55,"value":6044},"pulumi new -l",{"type":55,"value":6046}," to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in ",{"type":49,"tag":326,"props":6048,"children":6050},{"className":6049},[],[6051],{"type":55,"value":1627},{"type":55,"value":6053}," that consume the library.",{"type":49,"tag":68,"props":6055,"children":6056},{},[6057,6059,6064],{"type":55,"value":6058},"CDK has ",{"type":49,"tag":326,"props":6060,"children":6062},{"className":6061},[],[6063],{"type":55,"value":855},{"type":55,"value":6065}," CLI commands which can help set up either library code or project code",{"type":49,"tag":68,"props":6067,"children":6068},{},[6069,6071,6076,6077,6082],{"type":55,"value":6070},"The major benefits of these tools is setting up ",{"type":49,"tag":326,"props":6072,"children":6074},{"className":6073},[],[6075],{"type":55,"value":871},{"type":55,"value":715},{"type":49,"tag":326,"props":6078,"children":6080},{"className":6079},[],[6081],{"type":55,"value":824},{"type":55,"value":6083}," correctly",{"type":49,"tag":68,"props":6085,"children":6086},{},[6087],{"type":55,"value":6088},"Terraform is so simple that it doesn't really need tooling for scaffolding",{"type":49,"tag":50,"props":6090,"children":6092},{"id":6091},"best-practices",[6093],{"type":55,"value":6094},"Best practices",{"type":49,"tag":58,"props":6096,"children":6097},{},[6098,6100,6105,6107,6114],{"type":55,"value":6099},"For ",{"type":49,"tag":326,"props":6101,"children":6103},{"className":6102},[],[6104],{"type":55,"value":684},{"type":55,"value":6106},", I tried to follow the recommendations from ",{"type":49,"tag":80,"props":6108,"children":6111},{"href":6109,"rel":6110},"https://www.terraform-best-practices.com/",[84],[6112],{"type":55,"value":6113},"terraform-best-practices.com",{"type":55,"value":6115}," which helped me a lot with things like consistent naming patterns and directory structures. For example:",{"type":49,"tag":64,"props":6117,"children":6118},{},[6119],{"type":49,"tag":68,"props":6120,"children":6121},{},[6122,6124,6129],{"type":55,"value":6123},"use the name ",{"type":49,"tag":326,"props":6125,"children":6127},{"className":6126},[],[6128],{"type":55,"value":4165},{"type":55,"value":6130}," for resources in a module where that resource is the only resource of its type",{"type":49,"tag":58,"props":6132,"children":6133},{},[6134],{"type":55,"value":6135},"CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi.",{"type":49,"tag":58,"props":6137,"children":6138},{},[6139,6141,6146,6147,6152,6153,6159,6160,6166,6167,6173,6175,6181,6182,6188],{"type":55,"value":6140},"For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of ",{"type":49,"tag":326,"props":6142,"children":6144},{"className":6143},[],[6145],{"type":55,"value":2065},{"type":55,"value":873},{"type":49,"tag":326,"props":6148,"children":6150},{"className":6149},[],[6151],{"type":55,"value":2766},{"type":55,"value":873},{"type":49,"tag":326,"props":6154,"children":6156},{"className":6155},[],[6157],{"type":55,"value":6158},"pulumi.interpolate",{"type":55,"value":873},{"type":49,"tag":326,"props":6161,"children":6163},{"className":6162},[],[6164],{"type":55,"value":6165},"apply()",{"type":55,"value":873},{"type":49,"tag":326,"props":6168,"children":6170},{"className":6169},[],[6171],{"type":55,"value":6172},"all()",{"type":55,"value":6174}," and the differences between ",{"type":49,"tag":326,"props":6176,"children":6178},{"className":6177},[],[6179],{"type":55,"value":6180},"getX",{"type":55,"value":715},{"type":49,"tag":326,"props":6183,"children":6185},{"className":6184},[],[6186],{"type":55,"value":6187},"getXOutput",{"type":55,"value":6189},". There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way.",{"type":49,"tag":50,"props":6191,"children":6193},{"id":6192},"environment-configuration",[6194],{"type":55,"value":6195},"Environment configuration",{"type":49,"tag":58,"props":6197,"children":6198},{},[6199],{"type":55,"value":6200},"Environment configuration allows for either a base or app stack to be configured with non-default values. For example:",{"type":49,"tag":64,"props":6202,"children":6203},{},[6204,6209],{"type":49,"tag":68,"props":6205,"children":6206},{},[6207],{"type":55,"value":6208},"you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration",{"type":49,"tag":68,"props":6210,"children":6211},{},[6212],{"type":55,"value":6213},"You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config.",{"type":49,"tag":58,"props":6215,"children":6216},{},[6217],{"type":55,"value":6218},"In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values.",{"type":49,"tag":64,"props":6220,"children":6221},{},[6222,6243,6256],{"type":49,"tag":68,"props":6223,"children":6224},{},[6225,6227,6233,6235,6242],{"type":55,"value":6226},"Pulumi defines environment-specific config in files called ",{"type":49,"tag":326,"props":6228,"children":6230},{"className":6229},[],[6231],{"type":55,"value":6232},"Pulumi.{env}.yaml",{"type":55,"value":6234}," (",{"type":49,"tag":80,"props":6236,"children":6239},{"href":6237,"rel":6238},"https://www.pulumi.com/docs/intro/concepts/config/",[84],[6240],{"type":55,"value":6241},"Pulumi article on configuration",{"type":55,"value":616},{"type":49,"tag":68,"props":6244,"children":6245},{},[6246,6248,6254],{"type":55,"value":6247},"Terraform uses ",{"type":49,"tag":326,"props":6249,"children":6251},{"className":6250},[],[6252],{"type":55,"value":6253},"{env}.tfvars",{"type":55,"value":6255}," for this type of configuration",{"type":49,"tag":68,"props":6257,"children":6258},{},[6259,6261,6267],{"type":55,"value":6260},"CDK has several options for this type of configuration (",{"type":49,"tag":326,"props":6262,"children":6264},{"className":6263},[],[6265],{"type":55,"value":6266},"cdk.context.json",{"type":55,"value":6268},", extending stack props, etc.)",{"type":49,"tag":58,"props":6270,"children":6271},{},[6272,6274,6279,6281,6287],{"type":55,"value":6273},"For CDK I have been using ",{"type":49,"tag":326,"props":6275,"children":6277},{"className":6276},[],[6278],{"type":55,"value":4780},{"type":55,"value":6280}," and the ",{"type":49,"tag":326,"props":6282,"children":6284},{"className":6283},[],[6285],{"type":55,"value":6286},"tryGetContext",{"type":55,"value":6288}," method:",{"type":49,"tag":58,"props":6290,"children":6291},{},[6292,6297],{"type":49,"tag":326,"props":6293,"children":6295},{"className":6294},[],[6296],{"type":55,"value":4780},{"type":55,"value":6298}," needs to be set on the node before any child nodes are added:",{"type":49,"tag":1050,"props":6300,"children":6302},{"code":6301,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n",[6303],{"type":49,"tag":326,"props":6304,"children":6305},{"__ignoreMap":8},[6306,6341,6364,6371,6406],{"type":49,"tag":1060,"props":6307,"children":6308},{"class":1062,"line":1063},[6309,6313,6317,6321,6325,6329,6333,6337],{"type":49,"tag":1060,"props":6310,"children":6311},{"style":2182},[6312],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6314,"children":6315},{"style":2188},[6316],{"type":55,"value":4739},{"type":49,"tag":1060,"props":6318,"children":6319},{"style":2194},[6320],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6322,"children":6323},{"style":2194},[6324],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6326,"children":6327},{"style":1067},[6328],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6330,"children":6331},{"style":1073},[6332],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6334,"children":6335},{"style":2215},[6336],{"type":55,"value":4762},{"type":49,"tag":1060,"props":6338,"children":6339},{"style":1073},[6340],{"type":55,"value":4767},{"type":49,"tag":1060,"props":6342,"children":6343},{"class":1062,"line":1079},[6344,6348,6352,6356,6360],{"type":49,"tag":1060,"props":6345,"children":6346},{"style":1073},[6347],{"type":55,"value":4775},{"type":49,"tag":1060,"props":6349,"children":6350},{"style":1067},[6351],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6353,"children":6354},{"style":1073},[6355],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6357,"children":6358},{"style":2215},[6359],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6361,"children":6362},{"style":1073},[6363],{"type":55,"value":4794},{"type":49,"tag":1060,"props":6365,"children":6366},{"class":1062,"line":1088},[6367],{"type":49,"tag":1060,"props":6368,"children":6369},{"emptyLinePlaceholder":44},[6370],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6372,"children":6373},{"class":1062,"line":1097},[6374,6378,6382,6386,6390,6394,6398,6402],{"type":49,"tag":1060,"props":6375,"children":6376},{"style":2182},[6377],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6379,"children":6380},{"style":2188},[6381],{"type":55,"value":4813},{"type":49,"tag":1060,"props":6383,"children":6384},{"style":2194},[6385],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6387,"children":6388},{"style":2194},[6389],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6391,"children":6392},{"style":1067},[6393],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6395,"children":6396},{"style":1073},[6397],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6399,"children":6400},{"style":2215},[6401],{"type":55,"value":4834},{"type":49,"tag":1060,"props":6403,"children":6404},{"style":1073},[6405],{"type":55,"value":4839},{"type":49,"tag":1060,"props":6407,"children":6408},{"class":1062,"line":1111},[6409,6413,6417,6421,6425],{"type":49,"tag":1060,"props":6410,"children":6411},{"style":1073},[6412],{"type":55,"value":4847},{"type":49,"tag":1060,"props":6414,"children":6415},{"style":1067},[6416],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6418,"children":6419},{"style":1073},[6420],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6422,"children":6423},{"style":2215},[6424],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6426,"children":6427},{"style":1073},[6428],{"type":55,"value":4864},{"type":49,"tag":58,"props":6430,"children":6431},{},[6432],{"type":55,"value":6433},"And the config objects are read from JSON files like this:",{"type":49,"tag":1050,"props":6435,"children":6437},{"code":6436,"language":2171,"meta":8,"className":2172,"style":8},"var adHocBaseEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/base/config/${adHocBaseEnvName}.json`, 'utf8'));\nvar adHocAppEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/app/config/${adHocAppEnvName}.json`, 'utf8'));\n",[6438],{"type":49,"tag":326,"props":6439,"children":6440},{"__ignoreMap":8},[6441,6523],{"type":49,"tag":1060,"props":6442,"children":6443},{"class":1062,"line":1063},[6444,6449,6454,6458,6463,6467,6472,6477,6482,6486,6491,6495,6500,6504,6509,6513,6518],{"type":49,"tag":1060,"props":6445,"children":6446},{"style":2182},[6447],{"type":55,"value":6448},"var",{"type":49,"tag":1060,"props":6450,"children":6451},{"style":1073},[6452],{"type":55,"value":6453}," adHocBaseEnvConfig ",{"type":49,"tag":1060,"props":6455,"children":6456},{"style":2194},[6457],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6459,"children":6460},{"style":2188},[6461],{"type":55,"value":6462}," JSON",{"type":49,"tag":1060,"props":6464,"children":6465},{"style":1073},[6466],{"type":55,"value":745},{"type":49,"tag":1060,"props":6468,"children":6469},{"style":1067},[6470],{"type":55,"value":6471},"parse",{"type":49,"tag":1060,"props":6473,"children":6474},{"style":1073},[6475],{"type":55,"value":6476},"(fs.",{"type":49,"tag":1060,"props":6478,"children":6479},{"style":1067},[6480],{"type":55,"value":6481},"readFileSync",{"type":49,"tag":1060,"props":6483,"children":6484},{"style":1073},[6485],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6487,"children":6488},{"style":2215},[6489],{"type":55,"value":6490},"`src/examples/ad-hoc/base/config/",{"type":49,"tag":1060,"props":6492,"children":6493},{"style":3488},[6494],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6496,"children":6497},{"style":1073},[6498],{"type":55,"value":6499},"adHocBaseEnvName",{"type":49,"tag":1060,"props":6501,"children":6502},{"style":3488},[6503],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6505,"children":6506},{"style":2215},[6507],{"type":55,"value":6508},".json`",{"type":49,"tag":1060,"props":6510,"children":6511},{"style":1073},[6512],{"type":55,"value":873},{"type":49,"tag":1060,"props":6514,"children":6515},{"style":2215},[6516],{"type":55,"value":6517},"'utf8'",{"type":49,"tag":1060,"props":6519,"children":6520},{"style":1073},[6521],{"type":55,"value":6522},"));\n",{"type":49,"tag":1060,"props":6524,"children":6525},{"class":1062,"line":1079},[6526,6530,6535,6539,6543,6547,6551,6555,6559,6563,6568,6572,6577,6581,6585,6589,6593],{"type":49,"tag":1060,"props":6527,"children":6528},{"style":2182},[6529],{"type":55,"value":6448},{"type":49,"tag":1060,"props":6531,"children":6532},{"style":1073},[6533],{"type":55,"value":6534}," adHocAppEnvConfig ",{"type":49,"tag":1060,"props":6536,"children":6537},{"style":2194},[6538],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6540,"children":6541},{"style":2188},[6542],{"type":55,"value":6462},{"type":49,"tag":1060,"props":6544,"children":6545},{"style":1073},[6546],{"type":55,"value":745},{"type":49,"tag":1060,"props":6548,"children":6549},{"style":1067},[6550],{"type":55,"value":6471},{"type":49,"tag":1060,"props":6552,"children":6553},{"style":1073},[6554],{"type":55,"value":6476},{"type":49,"tag":1060,"props":6556,"children":6557},{"style":1067},[6558],{"type":55,"value":6481},{"type":49,"tag":1060,"props":6560,"children":6561},{"style":1073},[6562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6564,"children":6565},{"style":2215},[6566],{"type":55,"value":6567},"`src/examples/ad-hoc/app/config/",{"type":49,"tag":1060,"props":6569,"children":6570},{"style":3488},[6571],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6573,"children":6574},{"style":1073},[6575],{"type":55,"value":6576},"adHocAppEnvName",{"type":49,"tag":1060,"props":6578,"children":6579},{"style":3488},[6580],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6582,"children":6583},{"style":2215},[6584],{"type":55,"value":6508},{"type":49,"tag":1060,"props":6586,"children":6587},{"style":1073},[6588],{"type":55,"value":873},{"type":49,"tag":1060,"props":6590,"children":6591},{"style":2215},[6592],{"type":55,"value":6517},{"type":49,"tag":1060,"props":6594,"children":6595},{"style":1073},[6596],{"type":55,"value":6522},{"type":49,"tag":58,"props":6598,"children":6599},{},[6600],{"type":55,"value":6601},"The context can be used in constructs like this:",{"type":49,"tag":1050,"props":6603,"children":6605},{"code":6604,"language":2171,"meta":8,"className":2172,"style":8},"    const extraEnvVars = this.node.tryGetContext('config').extraEnvVars;\n",[6606],{"type":49,"tag":326,"props":6607,"children":6608},{"__ignoreMap":8},[6609],{"type":49,"tag":1060,"props":6610,"children":6611},{"class":1062,"line":1063},[6612,6616,6621,6625,6630,6635,6639,6643,6647],{"type":49,"tag":1060,"props":6613,"children":6614},{"style":2182},[6615],{"type":55,"value":2185},{"type":49,"tag":1060,"props":6617,"children":6618},{"style":2188},[6619],{"type":55,"value":6620}," extraEnvVars",{"type":49,"tag":1060,"props":6622,"children":6623},{"style":2194},[6624],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6626,"children":6627},{"style":3797},[6628],{"type":55,"value":6629}," this",{"type":49,"tag":1060,"props":6631,"children":6632},{"style":1073},[6633],{"type":55,"value":6634},".node.",{"type":49,"tag":1060,"props":6636,"children":6637},{"style":1067},[6638],{"type":55,"value":6286},{"type":49,"tag":1060,"props":6640,"children":6641},{"style":1073},[6642],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6644,"children":6645},{"style":2215},[6646],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6648,"children":6649},{"style":1073},[6650],{"type":55,"value":6651},").extraEnvVars;\n",{"type":49,"tag":58,"props":6653,"children":6654},{},[6655],{"type":55,"value":6656},"Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:",{"type":49,"tag":1050,"props":6658,"children":6660},{"code":6659,"language":2171,"meta":8,"className":2172,"style":8},"    interface EnvVar {\n      name: string;\n      value: string;\n    }\n\n    let config = new pulumi.Config();\n    let extraEnvVars = config.getObject\u003CEnvVar[]>(\"extraEnvVars\");\n",[6661],{"type":49,"tag":326,"props":6662,"children":6663},{"__ignoreMap":8},[6664,6681,6704,6724,6731,6738,6773],{"type":49,"tag":1060,"props":6665,"children":6666},{"class":1062,"line":1063},[6667,6672,6677],{"type":49,"tag":1060,"props":6668,"children":6669},{"style":2182},[6670],{"type":55,"value":6671},"    interface",{"type":49,"tag":1060,"props":6673,"children":6674},{"style":3992},[6675],{"type":55,"value":6676}," EnvVar",{"type":49,"tag":1060,"props":6678,"children":6679},{"style":1073},[6680],{"type":55,"value":4010},{"type":49,"tag":1060,"props":6682,"children":6683},{"class":1062,"line":1079},[6684,6690,6695,6700],{"type":49,"tag":1060,"props":6685,"children":6687},{"style":6686},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2",[6688],{"type":55,"value":6689},"      name",{"type":49,"tag":1060,"props":6691,"children":6692},{"style":2194},[6693],{"type":55,"value":6694},":",{"type":49,"tag":1060,"props":6696,"children":6697},{"style":5200},[6698],{"type":55,"value":6699}," string",{"type":49,"tag":1060,"props":6701,"children":6702},{"style":1073},[6703],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6705,"children":6706},{"class":1062,"line":1088},[6707,6712,6716,6720],{"type":49,"tag":1060,"props":6708,"children":6709},{"style":6686},[6710],{"type":55,"value":6711},"      value",{"type":49,"tag":1060,"props":6713,"children":6714},{"style":2194},[6715],{"type":55,"value":6694},{"type":49,"tag":1060,"props":6717,"children":6718},{"style":5200},[6719],{"type":55,"value":6699},{"type":49,"tag":1060,"props":6721,"children":6722},{"style":1073},[6723],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6725,"children":6726},{"class":1062,"line":1097},[6727],{"type":49,"tag":1060,"props":6728,"children":6729},{"style":1073},[6730],{"type":55,"value":3100},{"type":49,"tag":1060,"props":6732,"children":6733},{"class":1062,"line":1111},[6734],{"type":49,"tag":1060,"props":6735,"children":6736},{"emptyLinePlaceholder":44},[6737],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6739,"children":6740},{"class":1062,"line":1120},[6741,6746,6751,6755,6759,6763,6768],{"type":49,"tag":1060,"props":6742,"children":6743},{"style":2182},[6744],{"type":55,"value":6745},"    let",{"type":49,"tag":1060,"props":6747,"children":6748},{"style":1073},[6749],{"type":55,"value":6750}," config ",{"type":49,"tag":1060,"props":6752,"children":6753},{"style":2194},[6754],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6756,"children":6757},{"style":2194},[6758],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6760,"children":6761},{"style":1073},[6762],{"type":55,"value":3459},{"type":49,"tag":1060,"props":6764,"children":6765},{"style":1067},[6766],{"type":55,"value":6767},"Config",{"type":49,"tag":1060,"props":6769,"children":6770},{"style":1073},[6771],{"type":55,"value":6772},"();\n",{"type":49,"tag":1060,"props":6774,"children":6775},{"class":1062,"line":1128},[6776,6780,6785,6789,6794,6799,6803,6808,6813,6818],{"type":49,"tag":1060,"props":6777,"children":6778},{"style":2182},[6779],{"type":55,"value":6745},{"type":49,"tag":1060,"props":6781,"children":6782},{"style":1073},[6783],{"type":55,"value":6784}," extraEnvVars ",{"type":49,"tag":1060,"props":6786,"children":6787},{"style":2194},[6788],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6790,"children":6791},{"style":1073},[6792],{"type":55,"value":6793}," config.",{"type":49,"tag":1060,"props":6795,"children":6796},{"style":1067},[6797],{"type":55,"value":6798},"getObject",{"type":49,"tag":1060,"props":6800,"children":6801},{"style":1073},[6802],{"type":55,"value":5197},{"type":49,"tag":1060,"props":6804,"children":6805},{"style":3992},[6806],{"type":55,"value":6807},"EnvVar",{"type":49,"tag":1060,"props":6809,"children":6810},{"style":1073},[6811],{"type":55,"value":6812},"[]>(",{"type":49,"tag":1060,"props":6814,"children":6815},{"style":2215},[6816],{"type":55,"value":6817},"\"extraEnvVars\"",{"type":49,"tag":1060,"props":6819,"children":6820},{"style":1073},[6821],{"type":55,"value":2305},{"type":49,"tag":58,"props":6823,"children":6824},{},[6825,6827,6833,6835,6841],{"type":55,"value":6826},"In my ",{"type":49,"tag":326,"props":6828,"children":6830},{"className":6829},[],[6831],{"type":55,"value":6832},"Pulumi.alpha.yaml",{"type":55,"value":6834}," file I have the ",{"type":49,"tag":326,"props":6836,"children":6838},{"className":6837},[],[6839],{"type":55,"value":6840},"extraEnvVars",{"type":55,"value":6842}," set like this:",{"type":49,"tag":1050,"props":6844,"children":6846},{"code":6845,"language":3823,"meta":8,"className":3824,"style":8},"config:\n  aws:region: us-east-1\n  extraEnvVars:\n    - name: FOO\n      value: BAR\n    - name: BIZ\n      value: BUZ\n",[6847],{"type":49,"tag":326,"props":6848,"children":6849},{"__ignoreMap":8},[6850,6863,6880,6892,6913,6929,6949],{"type":49,"tag":1060,"props":6851,"children":6852},{"class":1062,"line":1063},[6853,6858],{"type":49,"tag":1060,"props":6854,"children":6855},{"style":3839},[6856],{"type":55,"value":6857},"config",{"type":49,"tag":1060,"props":6859,"children":6860},{"style":1073},[6861],{"type":55,"value":6862},":\n",{"type":49,"tag":1060,"props":6864,"children":6865},{"class":1062,"line":1079},[6866,6871,6875],{"type":49,"tag":1060,"props":6867,"children":6868},{"style":3839},[6869],{"type":55,"value":6870},"  aws:region",{"type":49,"tag":1060,"props":6872,"children":6873},{"style":1073},[6874],{"type":55,"value":78},{"type":49,"tag":1060,"props":6876,"children":6877},{"style":2215},[6878],{"type":55,"value":6879},"us-east-1\n",{"type":49,"tag":1060,"props":6881,"children":6882},{"class":1062,"line":1088},[6883,6888],{"type":49,"tag":1060,"props":6884,"children":6885},{"style":3839},[6886],{"type":55,"value":6887},"  extraEnvVars",{"type":49,"tag":1060,"props":6889,"children":6890},{"style":1073},[6891],{"type":55,"value":6862},{"type":49,"tag":1060,"props":6893,"children":6894},{"class":1062,"line":1097},[6895,6900,6904,6908],{"type":49,"tag":1060,"props":6896,"children":6897},{"style":1073},[6898],{"type":55,"value":6899},"    - ",{"type":49,"tag":1060,"props":6901,"children":6902},{"style":3839},[6903],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6905,"children":6906},{"style":1073},[6907],{"type":55,"value":78},{"type":49,"tag":1060,"props":6909,"children":6910},{"style":2215},[6911],{"type":55,"value":6912},"FOO\n",{"type":49,"tag":1060,"props":6914,"children":6915},{"class":1062,"line":1111},[6916,6920,6924],{"type":49,"tag":1060,"props":6917,"children":6918},{"style":3839},[6919],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6921,"children":6922},{"style":1073},[6923],{"type":55,"value":78},{"type":49,"tag":1060,"props":6925,"children":6926},{"style":2215},[6927],{"type":55,"value":6928},"BAR\n",{"type":49,"tag":1060,"props":6930,"children":6931},{"class":1062,"line":1120},[6932,6936,6940,6944],{"type":49,"tag":1060,"props":6933,"children":6934},{"style":1073},[6935],{"type":55,"value":6899},{"type":49,"tag":1060,"props":6937,"children":6938},{"style":3839},[6939],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6941,"children":6942},{"style":1073},[6943],{"type":55,"value":78},{"type":49,"tag":1060,"props":6945,"children":6946},{"style":2215},[6947],{"type":55,"value":6948},"BIZ\n",{"type":49,"tag":1060,"props":6950,"children":6951},{"class":1062,"line":1128},[6952,6956,6960],{"type":49,"tag":1060,"props":6953,"children":6954},{"style":3839},[6955],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6957,"children":6958},{"style":1073},[6959],{"type":55,"value":78},{"type":49,"tag":1060,"props":6961,"children":6962},{"style":2215},[6963],{"type":55,"value":6964},"BUZ\n",{"type":49,"tag":58,"props":6966,"children":6967},{},[6968],{"type":55,"value":6969},"I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)",{"type":49,"tag":50,"props":6971,"children":6973},{"id":6972},"local-development",[6974],{"type":55,"value":6975},"Local development",{"type":49,"tag":58,"props":6977,"children":6978},{},[6979,6981,6986],{"type":55,"value":6980},"Using the Makefile targets in each library repo, my process for developing ",{"type":49,"tag":326,"props":6982,"children":6984},{"className":6983},[],[6985],{"type":55,"value":457},{"type":55,"value":6987},"s involves making code changes followed by Makefile targets that preview/plan/diff against my AWS account, then running deploy/apply/up and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services.",{"type":49,"tag":58,"props":6989,"children":6990},{},[6991],{"type":55,"value":6992},"Here are some sample times for deploying ad hoc stacks with CDK.",{"type":49,"tag":1050,"props":6994,"children":6996},{"code":6995},"# CDK ad hoc base deployment time\n\n ✅  ExampleAdHocBaseStack (dev)\n\n✨  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n ✅  ExampleAdHocAppStack (alpha)\n\n✨  Deployment time: 126.62s\n",[6997],{"type":49,"tag":326,"props":6998,"children":6999},{"__ignoreMap":8},[7000],{"type":55,"value":6995},{"type":49,"tag":58,"props":7002,"children":7003},{},[7004,7006,7011],{"type":55,"value":7005},"Here is an example of what the ",{"type":49,"tag":326,"props":7007,"children":7009},{"className":7008},[],[7010],{"type":55,"value":572},{"type":55,"value":7012}," commands shows for the ad-hoc base stack:",{"type":49,"tag":1050,"props":7014,"children":7016},{"code":7015},"# Pulumi preview\n~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview\nPreviewing update (dev)\n\nView Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   └─ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ├─ pulumi-contrib:components:AlbResources            AlbResources                create\n +      │  ├─ aws:alb:TargetGroup                            DefaultTg                   create\n +      │  ├─ aws:alb:LoadBalancer                           LoadBalancer                create\n +      │  ├─ aws:alb:Listener                               HttpListener                create\n +      │  └─ aws:alb:Listener                               HttpsListener               create\n +      ├─ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      │  ├─ aws:iam:Role                                   BastionHostRole             create\n +      │  ├─ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      │  ├─ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      │  └─ aws:ec2:Instance                               BastionHostInstance         create\n +      ├─ pulumi-contrib:components:RdsResources            RdsResources                create\n +      │  ├─ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      │  ├─ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      │  └─ aws:rds:Instance                               DbInstance                  create\n +      ├─ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      │  ├─ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      │  └─ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ├─ aws:s3:Bucket                                     assetsBucket                create\n +      ├─ awsx:ec2:Vpc                                      dev                         create\n +      │  └─ aws:ec2:Vpc                                    dev                         create\n +      │     ├─ aws:ec2:InternetGateway                     dev                         create\n +      │     ├─ aws:ec2:Subnet                              dev-private-1               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-1               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      │     │     └─ aws:ec2:Route                         dev-private-1               create\n +      │     ├─ aws:ec2:Subnet                              dev-private-2               create\n +      │     │  └─ aws:ec2:RouteTable                       dev-private-2               create\n +      │     │     ├─ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      │     │     └─ aws:ec2:Route                         dev-private-2               create\n +      │     ├─ aws:ec2:Subnet                              dev-public-1                create\n +      │     │  ├─ aws:ec2:RouteTable                       dev-public-1                create\n +      │     │  │  ├─ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      │     │  │  └─ aws:ec2:Route                         dev-public-1                create\n +      │     │  ├─ aws:ec2:Eip                              dev-1                       create\n +      │     │  └─ aws:ec2:NatGateway                       dev-1                       create\n +      │     └─ aws:ec2:Subnet                              dev-public-2                create\n +      │        ├─ aws:ec2:RouteTable                       dev-public-2                create\n +      │        │  ├─ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      │        │  └─ aws:ec2:Route                         dev-public-2                create\n +      │        ├─ aws:ec2:Eip                              dev-2                       create\n +      │        └─ aws:ec2:NatGateway                       dev-2                       create\n +      └─ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output\u003Cstring>\n    albSgId                    : output\u003Cstring>\n    appSgId                    : output\u003Cstring>\n    assetsBucketName           : output\u003Cstring>\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output\u003Cstring>\n    domainName                 : \"example.com\"\n    listenerArn                : output\u003Cstring>\n    privateSubnetIds           : output\u003Cstring>\n    rdsAddress                 : output\u003Cstring>\n    serviceDiscoveryNamespaceId: output\u003Cstring>\n    vpcId                      : output\u003Cstring>\n\nResources:\n    + 44 to create\n",[7017],{"type":49,"tag":326,"props":7018,"children":7019},{"__ignoreMap":8},[7020],{"type":55,"value":7015},{"type":49,"tag":50,"props":7022,"children":7024},{"id":7023},"running-infrastructure-pipelines-in-github-actions",[7025],{"type":55,"value":7026},"Running infrastructure pipelines in GitHub Actions",{"type":49,"tag":58,"props":7028,"children":7029},{},[7030],{"type":49,"tag":126,"props":7031,"children":7032},{},[7033],{"type":55,"value":7034},"I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!",{"type":49,"tag":58,"props":7036,"children":7037},{},[7038,7039,7045,7047,7052,7054,7060],{"type":55,"value":2613},{"type":49,"tag":326,"props":7040,"children":7042},{"className":7041},[],[7043],{"type":55,"value":7044},".github/workflows",{"type":55,"value":7046}," directory of the ",{"type":49,"tag":326,"props":7048,"children":7050},{"className":7049},[],[7051],{"type":55,"value":1627},{"type":55,"value":7053}," repo, I will have the following ",{"type":49,"tag":326,"props":7055,"children":7057},{"className":7056},[],[7058],{"type":55,"value":7059},"2 * 2 * 2 * 3 = 24",{"type":55,"value":7061}," pipelines for running infrastructure as code pipelines:",{"type":49,"tag":1050,"props":7063,"children":7065},{"code":7064,"language":2728,"meta":8,"className":2729,"style":8},"{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n",[7066],{"type":49,"tag":326,"props":7067,"children":7068},{"__ignoreMap":8},[7069],{"type":49,"tag":1060,"props":7070,"children":7071},{"class":1062,"line":1063},[7072],{"type":49,"tag":1060,"props":7073,"children":7074},{"style":1073},[7075],{"type":55,"value":7064},{"type":49,"tag":64,"props":7077,"children":7078},{},[7079,7084,7089],{"type":49,"tag":68,"props":7080,"children":7081},{},[7082],{"type":55,"value":7083},"For CDK I'm using CDK CLI commands",{"type":49,"tag":68,"props":7085,"children":7086},{},[7087],{"type":55,"value":7088},"For Terraform I'm also using terraform CLI commands",{"type":49,"tag":68,"props":7090,"children":7091},{},[7092],{"type":55,"value":7093},"For Pulumi I'm using the official Pulumi GitHub Action",{"type":49,"tag":58,"props":7095,"children":7096},{},[7097,7098,7105],{"type":55,"value":6030},{"type":49,"tag":80,"props":7099,"children":7102},{"href":7100,"rel":7101},"https://www.pulumi.com/docs/guides/continuous-delivery/github-actions/",[84],[7103],{"type":55,"value":7104},"a great article",{"type":55,"value":7106}," about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags.",{"type":49,"tag":58,"props":7108,"children":7109},{},[7110],{"type":55,"value":7111},"The general pattern that all of these pipelines use is:",{"type":49,"tag":64,"props":7113,"children":7114},{},[7115,7120,7125],{"type":49,"tag":68,"props":7116,"children":7117},{},[7118],{"type":55,"value":7119},"Do a synth/plan/preview, and upload the synth/plan/preview file to an artifact",{"type":49,"tag":68,"props":7121,"children":7122},{},[7123],{"type":55,"value":7124},"Pause and wait on manual review of the planned changes",{"type":49,"tag":68,"props":7126,"children":7127},{},[7128],{"type":55,"value":7129},"download the artifact and run deploy/apply/up against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected.",{"type":49,"tag":58,"props":7131,"children":7132},{},[7133],{"type":55,"value":7134},"I do this by having two jobs in each GitHub Action: one for synth/plan/preview and one for deploy/apply/up.",{"type":49,"tag":58,"props":7136,"children":7137},{},[7138,7140,7145],{"type":55,"value":7139},"The job for deploy/apply/up includes an ",{"type":49,"tag":326,"props":7141,"children":7143},{"className":7142},[],[7144],{"type":55,"value":5113},{"type":55,"value":7146}," that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job.",{"type":49,"tag":50,"props":7148,"children":7150},{"id":7149},"application-deployments",[7151],{"type":55,"value":7152},"Application deployments",{"type":49,"tag":64,"props":7154,"children":7155},{},[7156,7161,7173],{"type":49,"tag":68,"props":7157,"children":7158},{},[7159],{"type":55,"value":7160},"There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)",{"type":49,"tag":68,"props":7162,"children":7163},{},[7164,7166,7171],{"type":55,"value":7165},"The backend deployment script runs database migrations, the ",{"type":49,"tag":326,"props":7167,"children":7169},{"className":7168},[],[7170],{"type":55,"value":3316},{"type":55,"value":7172}," command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)",{"type":49,"tag":68,"props":7174,"children":7175},{},[7176],{"type":55,"value":7177},"What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks.",{"type":49,"tag":50,"props":7179,"children":7181},{"id":7180},"interacting-with-aws-via-iac",[7182],{"type":55,"value":7183},"Interacting with AWS via IaC",{"type":49,"tag":64,"props":7185,"children":7186},{},[7187,7201,7226],{"type":49,"tag":68,"props":7188,"children":7189},{},[7190,7192,7199],{"type":55,"value":7191},"CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides ",{"type":49,"tag":80,"props":7193,"children":7196},{"href":7194,"rel":7195},"https://docs.aws.amazon.com/cdk/v2/guide/constructs.html",[84],[7197],{"type":55,"value":7198},"L1, L2 and L3 constructs",{"type":55,"value":7200}," which offer different levels of abstraction over CloudFormation.",{"type":49,"tag":68,"props":7202,"children":7203},{},[7204,7206,7213,7214,7225],{"type":55,"value":7205},"Terraform has the ",{"type":49,"tag":80,"props":7207,"children":7210},{"href":7208,"rel":7209},"https://registry.terraform.io/providers/hashicorp/aws/latest/docs",[84],[7211],{"type":55,"value":7212},"AWS Provider",{"type":55,"value":6280},{"type":49,"tag":80,"props":7215,"children":7218},{"href":7216,"rel":7217},"https://registry.terraform.io/namespaces/terraform-aws-modules",[84],[7219],{"type":49,"tag":326,"props":7220,"children":7222},{"className":7221},[],[7223],{"type":55,"value":7224},"terraform-aws-modules",{"type":55,"value":745},{"type":49,"tag":68,"props":7227,"children":7228},{},[7229,7231,7236,7237,7242,7243,7249,7250,7257,7258,7263,7264,7270,7271,7275],{"type":55,"value":7230},"Pulumi has AWS Classic (",{"type":49,"tag":326,"props":7232,"children":7234},{"className":7233},[],[7235],{"type":55,"value":496},{"type":55,"value":5173},{"type":49,"tag":72,"props":7238,"children":7239},{},[7240],{"type":55,"value":7241},"provider",{"type":55,"value":715},{"type":49,"tag":326,"props":7244,"children":7246},{"className":7245},[],[7247],{"type":55,"value":7248},"AWSx",{"type":55,"value":6234},{"type":49,"tag":80,"props":7251,"children":7254},{"href":7252,"rel":7253},"https://www.pulumi.com/registry/packages/awsx/",[84],[7255],{"type":55,"value":7256},"Crosswalk for Pulumi",{"type":55,"value":5173},{"type":49,"tag":72,"props":7259,"children":7260},{},[7261],{"type":55,"value":7262},"library",{"type":55,"value":715},{"type":49,"tag":326,"props":7265,"children":7267},{"className":7266},[],[7268],{"type":55,"value":7269},"aws_native",{"type":55,"value":1909},{"type":49,"tag":72,"props":7272,"children":7273},{},[7274],{"type":55,"value":7241},{"type":55,"value":745},{"type":49,"tag":2910,"props":7277,"children":7278},{},[7279],{"type":49,"tag":58,"props":7280,"children":7281},{},[7282,7287],{"type":49,"tag":326,"props":7283,"children":7285},{"className":7284},[],[7286],{"type":55,"value":7269},{"type":55,"value":7288}," \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\"",{"type":49,"tag":58,"props":7290,"children":7291},{},[7292,7297],{"type":49,"tag":326,"props":7293,"children":7295},{"className":7294},[],[7296],{"type":55,"value":7269},{"type":55,"value":7298}," looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider.",{"type":49,"tag":58,"props":7300,"children":7301},{},[7302],{"type":55,"value":7303},"For CDK I use mostly L2 constructs and some L1 constructs.",{"type":49,"tag":58,"props":7305,"children":7306},{},[7307,7309,7314],{"type":55,"value":7308},"Fot Terraform I use the VPC from the ",{"type":49,"tag":326,"props":7310,"children":7312},{"className":7311},[],[7313],{"type":55,"value":7224},{"type":55,"value":7315},", and everything else uses the AWS Terraform Provider.",{"type":49,"tag":50,"props":7317,"children":7319},{"id":7318},"what-i-did-not-put-in-iac",[7320],{"type":55,"value":7321},"What I did not put in IaC",{"type":49,"tag":64,"props":7323,"children":7324},{},[7325,7330,7335],{"type":49,"tag":68,"props":7326,"children":7327},{},[7328],{"type":55,"value":7329},"ECR (Elastic Container Registry)",{"type":49,"tag":68,"props":7331,"children":7332},{},[7333],{"type":55,"value":7334},"ACM (Amazon Certificate Manager)",{"type":49,"tag":68,"props":7336,"children":7337},{},[7338],{"type":55,"value":7339},"(Roles used for deployments)",{"type":49,"tag":58,"props":7341,"children":7342},{},[7343,7345,7350,7351,7356,7358,7364],{"type":55,"value":7344},"I created the Elastic Container Registry ",{"type":49,"tag":326,"props":7346,"children":7348},{"className":7347},[],[7349],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":7352,"children":7354},{"className":7353},[],[7355],{"type":55,"value":1958},{"type":55,"value":7357}," repos manually in the AWS Console. I also manually requested an ACM certificate for ",{"type":49,"tag":326,"props":7359,"children":7361},{"className":7360},[],[7362],{"type":55,"value":7363},"*.mydomain.com",{"type":55,"value":7365}," for the domain that I use for testing that I purchased through Route53 domains.",{"type":49,"tag":58,"props":7367,"children":7368},{},[7369],{"type":55,"value":7370},"I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog.",{"type":49,"tag":50,"props":7372,"children":7374},{"id":7373},"tagging",[7375],{"type":55,"value":7376},"Tagging",{"type":49,"tag":64,"props":7378,"children":7379},{},[7380,7385,7390,7399,7408,7413],{"type":49,"tag":68,"props":7381,"children":7382},{},[7383],{"type":55,"value":7384},"Terraform and CDK both make it easy to automatically tag all resources in a stack",{"type":49,"tag":68,"props":7386,"children":7387},{},[7388],{"type":55,"value":7389},"It is possible to do this in Pulumi, but you need to write a little bit of code.",{"type":49,"tag":68,"props":7391,"children":7392},{},[7393],{"type":49,"tag":80,"props":7394,"children":7397},{"href":7395,"rel":7396},"https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/",[84],[7398],{"type":55,"value":7395},{"type":49,"tag":68,"props":7400,"children":7401},{},[7402],{"type":49,"tag":80,"props":7403,"children":7406},{"href":7404,"rel":7405},"https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts",[84],[7407],{"type":55,"value":7404},{"type":49,"tag":68,"props":7409,"children":7410},{},[7411],{"type":55,"value":7412},"Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)",{"type":49,"tag":68,"props":7414,"children":7415},{},[7416,7418,7425],{"type":55,"value":7417},"Automatically tagging resources works through ",{"type":49,"tag":80,"props":7419,"children":7422},{"href":7420,"rel":7421},"https://www.pulumi.com/docs/intro/vs/terraform/",[84],[7423],{"type":55,"value":7424},"stack transformations",{"type":55,"value":7426}," are unique to Pulumi",{"type":49,"tag":50,"props":7428,"children":7430},{"id":7429},"smoke-checking-application-environments",[7431],{"type":55,"value":7432},"Smoke checking application environments",{"type":49,"tag":58,"props":7434,"children":7435},{},[7436],{"type":55,"value":7437},"Here's the list of things I check when standing up an application environment:",{"type":49,"tag":64,"props":7439,"children":7442},{"className":7440},[7441],"contains-task-list",[7443,7455,7471,7487,7503,7519,7535,7551,7560,7569,7578,7587,7596,7605],{"type":49,"tag":68,"props":7444,"children":7447},{"className":7445},[7446],"task-list-item",[7448,7453],{"type":49,"tag":7449,"props":7450,"children":7452},"input",{"checked":44,"disabled":44,"type":7451},"checkbox",[],{"type":55,"value":7454}," Run the init/tsc, synth/plan/preview and deploy/apply/up commands successfully",{"type":49,"tag":68,"props":7456,"children":7458},{"className":7457},[7446],[7459,7462,7464,7470],{"type":49,"tag":7449,"props":7460,"children":7461},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7463}," Access the bastion host (",{"type":49,"tag":326,"props":7465,"children":7467},{"className":7466},[],[7468],{"type":55,"value":7469},"make aws-ssm-start-session",{"type":55,"value":616},{"type":49,"tag":68,"props":7472,"children":7474},{"className":7473},[7446],[7475,7478,7480,7486],{"type":49,"tag":7449,"props":7476,"children":7477},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7479}," Run ECSExec to access a shell in a backend container (",{"type":49,"tag":326,"props":7481,"children":7483},{"className":7482},[],[7484],{"type":55,"value":7485},"make aws-ecs-exec",{"type":55,"value":616},{"type":49,"tag":68,"props":7488,"children":7490},{"className":7489},[7446],[7491,7494,7496,7502],{"type":49,"tag":7449,"props":7492,"children":7493},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7495}," Test database connectivity (",{"type":49,"tag":326,"props":7497,"children":7499},{"className":7498},[],[7500],{"type":55,"value":7501},"python manage.py showmigrations",{"type":55,"value":616},{"type":49,"tag":68,"props":7504,"children":7506},{"className":7505},[7446],[7507,7510,7512,7518],{"type":49,"tag":7449,"props":7508,"children":7509},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7511}," Run the migrations (",{"type":49,"tag":326,"props":7513,"children":7515},{"className":7514},[],[7516],{"type":55,"value":7517},"python manage.py migrate",{"type":55,"value":616},{"type":49,"tag":68,"props":7520,"children":7522},{"className":7521},[7446],[7523,7526,7528,7534],{"type":49,"tag":7449,"props":7524,"children":7525},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7527}," Run collectstatic (",{"type":49,"tag":326,"props":7529,"children":7531},{"className":7530},[],[7532],{"type":55,"value":7533},"python manage.py collectstatic",{"type":55,"value":616},{"type":49,"tag":68,"props":7536,"children":7538},{"className":7537},[7446],[7539,7542,7544,7550],{"type":49,"tag":7449,"props":7540,"children":7541},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7543}," Visit the site (",{"type":49,"tag":326,"props":7545,"children":7547},{"className":7546},[],[7548],{"type":55,"value":7549},"alpha.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":7552,"children":7554},{"className":7553},[7446],[7555,7558],{"type":49,"tag":7449,"props":7556,"children":7557},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7559}," Publish a blog post",{"type":49,"tag":68,"props":7561,"children":7563},{"className":7562},[7446],[7564,7567],{"type":49,"tag":7449,"props":7565,"children":7566},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7568}," Publish a blog post with an image",{"type":49,"tag":68,"props":7570,"children":7572},{"className":7571},[7446],[7573,7576],{"type":49,"tag":7449,"props":7574,"children":7575},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7577}," Check celery worker logs for successfully complete scheduled tasks",{"type":49,"tag":68,"props":7579,"children":7581},{"className":7580},[7446],[7582,7585],{"type":49,"tag":7449,"props":7583,"children":7584},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7586}," Trigger an autoscaling event by running k6 load tests against an environment",{"type":49,"tag":68,"props":7588,"children":7590},{"className":7589},[7446],[7591,7594],{"type":49,"tag":7449,"props":7592,"children":7593},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7595}," Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates",{"type":49,"tag":68,"props":7597,"children":7599},{"className":7598},[7446],[7600,7603],{"type":49,"tag":7449,"props":7601,"children":7602},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7604}," Destroy the app stack",{"type":49,"tag":68,"props":7606,"children":7608},{"className":7607},[7446],[7609,7612],{"type":49,"tag":7449,"props":7610,"children":7611},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7613}," Destroy the base stack",{"type":49,"tag":50,"props":7615,"children":7617},{"id":7616},"backlog-and-next-steps",[7618],{"type":55,"value":7619},"Backlog and next steps",{"type":49,"tag":58,"props":7621,"children":7622},{},[7623],{"type":55,"value":7624},"Here are some of the next things I'll be working on in these project, roughly in order of importance:",{"type":49,"tag":64,"props":7626,"children":7628},{"className":7627},[7441],[7629,7638,7643,7648,7660,7665,7678,7683,7688,7693,7698,7703,7708,7713,7718],{"type":49,"tag":68,"props":7630,"children":7632},{"className":7631},[7446],[7633,7636],{"type":49,"tag":7449,"props":7634,"children":7635},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7637}," Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines",{"type":49,"tag":68,"props":7639,"children":7640},{},[7641],{"type":55,"value":7642},"Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub",{"type":49,"tag":68,"props":7644,"children":7645},{},[7646],{"type":55,"value":7647},"Show how to do account isolation (different accounts for prod vs pre-prod environments)",{"type":49,"tag":68,"props":7649,"children":7650},{},[7651,7653,7658],{"type":55,"value":7652},"GitHub Actions deployment pipeline for publishing ",{"type":49,"tag":326,"props":7654,"children":7656},{"className":7655},[],[7657],{"type":55,"value":699},{"type":55,"value":7659}," package",{"type":49,"tag":68,"props":7661,"children":7662},{},[7663],{"type":55,"value":7664},"Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)",{"type":49,"tag":68,"props":7666,"children":7667},{},[7668,7670,7676],{"type":55,"value":7669},"For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the ",{"type":49,"tag":326,"props":7671,"children":7673},{"className":7672},[],[7674],{"type":55,"value":7675},"random",{"type":55,"value":7677}," functions to do this",{"type":49,"tag":68,"props":7679,"children":7680},{},[7681],{"type":55,"value":7682},"Refactor GitHub Actions and make them reusable across different projects",{"type":49,"tag":68,"props":7684,"children":7685},{},[7686],{"type":55,"value":7687},"Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules",{"type":49,"tag":68,"props":7689,"children":7690},{},[7691],{"type":55,"value":7692},"Use graviton instances and have the option to select between different architectures",{"type":49,"tag":68,"props":7694,"children":7695},{},[7696],{"type":55,"value":7697},"Standardize all resources names across CDK, Terraform and Pulumi",{"type":49,"tag":68,"props":7699,"children":7700},{},[7701],{"type":55,"value":7702},"The Pulumi components that define the resources associated with each ECS service are not very dry",{"type":49,"tag":68,"props":7704,"children":7705},{},[7706],{"type":55,"value":7707},"Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)",{"type":49,"tag":68,"props":7709,"children":7710},{},[7711],{"type":55,"value":7712},"Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is.",{"type":49,"tag":68,"props":7714,"children":7715},{},[7716],{"type":55,"value":7717},"Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional",{"type":49,"tag":68,"props":7719,"children":7720},{},[7721],{"type":55,"value":7722},"experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site",{"type":49,"tag":58,"props":7724,"children":7725},{},[7726],{"type":55,"value":7727},"If you want to get involved or help with any of the above, please let me know!",{"type":49,"tag":50,"props":7729,"children":7731},{"id":7730},"conclusion",[7732],{"type":55,"value":7733},"Conclusion",{"type":49,"tag":58,"props":7735,"children":7736},{},[7737,7739,7746],{"type":55,"value":7738},"I first started out with IaC following this project ",{"type":49,"tag":80,"props":7740,"children":7743},{"href":7741,"rel":7742},"https://github.com/aws-samples/ecs-refarch-cloudformation",[84],[7744],{"type":55,"value":7745},"aws-samples/ecs-refarch-cloudformation",{"type":55,"value":7747}," (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform.",{"type":49,"tag":7749,"props":7750,"children":7751},"style",{},[7752],{"type":55,"value":7753},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":8,"searchDepth":1079,"depth":1079,"links":7755},[7756,7757,7758,7759,7764,7772,7773,7776,7777,7787,7797,7798,7799,7800,7801,7802,7803,7804,7805,7806,7807,7808],{"id":52,"depth":1079,"text":56},{"id":151,"depth":1079,"text":151},{"id":185,"depth":1079,"text":188},{"id":425,"depth":1079,"text":428,"children":7760},[7761,7762,7763],{"id":432,"depth":1088,"text":435},{"id":477,"depth":1088,"text":480},{"id":501,"depth":1088,"text":501},{"id":643,"depth":1079,"text":646,"children":7765},[7766,7767,7768,7769,7770,7771],{"id":702,"depth":1088,"text":705},{"id":776,"depth":1088,"text":779},{"id":909,"depth":1088,"text":912},{"id":1288,"depth":1088,"text":1291},{"id":1334,"depth":1088,"text":1337},{"id":1470,"depth":1088,"text":1473},{"id":1545,"depth":1079,"text":1548},{"id":1589,"depth":1079,"text":1589,"children":7774},[7775],{"id":1613,"depth":1088,"text":1616},{"id":1820,"depth":1079,"text":1823},{"id":1981,"depth":1079,"text":1984,"children":7778},[7779,7780,7781,7782,7783,7784,7785,7786],{"id":2035,"depth":1088,"text":2038},{"id":2062,"depth":1088,"text":2065},{"id":2091,"depth":1088,"text":2094},{"id":2160,"depth":1088,"text":2017},{"id":2357,"depth":1088,"text":2360},{"id":2401,"depth":1088,"text":2404},{"id":2683,"depth":1088,"text":2032},{"id":2763,"depth":1088,"text":2766},{"id":2853,"depth":1079,"text":2856,"children":7788},[7789,7790,7791,7792,7793,7794,7795,7796],{"id":2877,"depth":1088,"text":2880},{"id":2928,"depth":1088,"text":2931},{"id":3119,"depth":1088,"text":3122},{"id":3151,"depth":1088,"text":3154},{"id":3167,"depth":1088,"text":3170},{"id":3261,"depth":1088,"text":3264},{"id":3299,"depth":1088,"text":3302},{"id":3966,"depth":1088,"text":2849},{"id":6014,"depth":1079,"text":6017},{"id":6091,"depth":1079,"text":6094},{"id":6192,"depth":1079,"text":6195},{"id":6972,"depth":1079,"text":6975},{"id":7023,"depth":1079,"text":7026},{"id":7149,"depth":1079,"text":7152},{"id":7180,"depth":1079,"text":7183},{"id":7318,"depth":1079,"text":7321},{"id":7373,"depth":1079,"text":7376},{"id":7429,"depth":1079,"text":7432},{"id":7616,"depth":1079,"text":7619},{"id":7730,"depth":1079,"text":7733},"markdown","content:2023:01:07:i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","content","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","md",{"_path":7816,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":7818,"description":7819,"date":7820,"image":7821,"tags":7822,"external":7823,"comments":44,"body":7841,"_type":7809,"_id":13919,"_source":7811,"_file":13920,"_stem":13921,"_extension":7814},"/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","27","Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions","This article will show how software development teams can build on-demand environments for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete instances of a web application.","2022-06-11","/static/adhoc.png",[14,16,19,20,21,23,24],[7824,7826,7828,7830,7832,7833,7836,7838],{"link":7825,"site":28},"https://news.ycombinator.com/item?id=31704417",{"link":7827,"site":31},"https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/",{"link":7829,"site":34},"https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh",{"link":7831,"site":37},"https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539",{"link":39,"site":40},{"link":7834,"site":7835},"https://twitter.com/briancaffey/status/1535683865330831360","twitter",{"link":7837,"site":43},"https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments",{"link":7839,"site":7840},"https://hackernoon.com/ad-hoc-environments-for-django-applications-with-ecs-terraform-and-github-actions","hackernoon",{"type":46,"children":7842,"toc":13848},[7843,7847,7860,7866,7871,7985,7991,7996,8034,8039,8097,8103,8108,8114,8119,8152,8157,8163,8168,8211,8223,8228,8233,8340,8345,8351,8356,8374,8379,8408,8420,8425,8431,8436,8454,8459,8464,8469,8474,8487,8492,8497,8503,8508,8534,8578,8584,8589,8607,8612,8617,8622,8643,8676,8682,8687,8692,8728,8733,8787,8792,8842,8853,8881,8898,8904,8921,8928,8934,8947,8952,8957,8962,8967,8972,8977,8982,8987,8993,9066,9072,9077,9085,9089,9102,9108,9113,9126,9131,9139,9143,9148,9181,9187,9192,9198,9203,9208,9229,9234,9238,9243,9249,9254,9258,9263,9269,9274,9279,9306,9311,9328,9334,9339,9345,9385,9411,9416,9436,9462,9468,9480,9488,9500,9539,9545,9589,9602,9610,9649,9669,9675,9686,9707,9719,9725,9730,9816,9821,9828,9833,9838,12707,12727,12741,12797,12858,12864,12876,12933,12939,12944,12950,12955,12969,12982,12988,13015,13021,13026,13032,13037,13043,13048,13054,13059,13190,13195,13201,13237,13243,13286,13292,13304,13341,13353,13359,13379,13565,13570,13578,13584,13610,13616,13634,13639,13645,13651,13656,13662,13667,13672,13677,13682,13688,13711,13717,13722,13728,13733,13739,13744,13750,13755,13761,13780,13786,13791,13797,13802,13830,13835,13839,13844],{"type":49,"tag":50,"props":7844,"children":7845},{"id":52},[7846],{"type":55,"value":56},{"type":49,"tag":58,"props":7848,"children":7849},{},[7850,7852,7858],{"type":55,"value":7851},"This article will show how software development teams can build on-demand instances of a web application project for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete environments. It will focus on the technical implementation of building ad hoc environments using a specific set of tools (including AWS ECS, Terraform and GitHub Actions). I will also be giving context on high-level implementation decisions based on what I think are best practices guided by the ",{"type":49,"tag":80,"props":7853,"children":7855},{"href":402,"rel":7854},[84],[7856],{"type":55,"value":7857},"12-Factor Application methodology",{"type":55,"value":7859},". If any of this interests you, please have a read and let me know what you think in the comments on the outlets where I'll be sharing this article (links at the end).",{"type":49,"tag":50,"props":7861,"children":7863},{"id":7862},"github-links",[7864],{"type":55,"value":7865},"GitHub Links",{"type":49,"tag":58,"props":7867,"children":7868},{},[7869],{"type":55,"value":7870},"This article references three open-source code repositories on GitHub.",{"type":49,"tag":64,"props":7872,"children":7873},{},[7874,7905,7945],{"type":49,"tag":68,"props":7875,"children":7876},{},[7877,7882],{"type":49,"tag":80,"props":7878,"children":7880},{"href":144,"rel":7879},[84],[7881],{"type":55,"value":1627},{"type":49,"tag":64,"props":7883,"children":7884},{},[7885,7890,7895,7900],{"type":49,"tag":68,"props":7886,"children":7887},{},[7888],{"type":55,"value":7889},"this repo contains an example microblogging application called μblog built with Django",{"type":49,"tag":68,"props":7891,"children":7892},{},[7893],{"type":55,"value":7894},"the same application is implemented as a traditional Model Template View (MTV) site, a decoupled REST API and Javascript web application and a GraphQL API",{"type":49,"tag":68,"props":7896,"children":7897},{},[7898],{"type":55,"value":7899},"it is a monorepo that also includes a frontend Vue.js application, CI/CD pipelines, a VuePress documentation site as well as tooling and instructions for settings up a local development environments (both with and without docker)",{"type":49,"tag":68,"props":7901,"children":7902},{},[7903],{"type":55,"value":7904},"it includes a complete set of GitHub Action examples for automating the processes of creating, updating and destroying ad hoc environments that will be an important part of what is covered in this article",{"type":49,"tag":68,"props":7906,"children":7907},{},[7908,7913],{"type":49,"tag":80,"props":7909,"children":7911},{"href":99,"rel":7910},[84],[7912],{"type":55,"value":684},{"type":49,"tag":64,"props":7914,"children":7915},{},[7916,7921,7926],{"type":49,"tag":68,"props":7917,"children":7918},{},[7919],{"type":55,"value":7920},"a collection of modules for running Django applications on AWS using Terraform",{"type":49,"tag":68,"props":7922,"children":7923},{},[7924],{"type":55,"value":7925},"one of the submodules can be used for creating ad hoc environments which will be what we use to create ad hoc environments",{"type":49,"tag":68,"props":7927,"children":7928},{},[7929,7931,7937,7938,7943],{"type":55,"value":7930},"this module has been published to Terraform Registry and is used in the ",{"type":49,"tag":326,"props":7932,"children":7934},{"className":7933},[],[7935],{"type":55,"value":7936},"terraform/live/ad-hoc",{"type":55,"value":7046},{"type":49,"tag":326,"props":7939,"children":7941},{"className":7940},[],[7942],{"type":55,"value":1627},{"type":55,"value":7944}," repo",{"type":49,"tag":68,"props":7946,"children":7947},{},[7948,7955],{"type":49,"tag":80,"props":7949,"children":7952},{"href":7950,"rel":7951},"https://github.com/briancaffey/terraform-aws-ad-hoc-environments",[84],[7953],{"type":55,"value":7954},"terraform-aws-ad-hoc-environments",{"type":49,"tag":64,"props":7956,"children":7957},{},[7958,7963,7973],{"type":49,"tag":68,"props":7959,"children":7960},{},[7961],{"type":55,"value":7962},"a Terraform module that provides shared infrastructure used by ad hoc environments (including VPC, RDS instance, bastion host, security groups and IAM roles, etc.)",{"type":49,"tag":68,"props":7964,"children":7965},{},[7966,7968],{"type":55,"value":7967},"this module has also been published to Terraform Registry and is also used in ",{"type":49,"tag":326,"props":7969,"children":7971},{"className":7970},[],[7972],{"type":55,"value":1627},{"type":49,"tag":68,"props":7974,"children":7975},{},[7976,7978,7983],{"type":55,"value":7977},"this module is designed to be used with the ",{"type":49,"tag":326,"props":7979,"children":7981},{"className":7980},[],[7982],{"type":55,"value":684},{"type":55,"value":7984}," Terraform module",{"type":49,"tag":50,"props":7986,"children":7988},{"id":7987},"assumptions",[7989],{"type":55,"value":7990},"Assumptions",{"type":49,"tag":58,"props":7992,"children":7993},{},[7994],{"type":55,"value":7995},"There are all sorts of applications, and all sort of engineering teams. For some context on what I'm describing in this article, here are some basic assumptions that I'm making about the type of engineering team and software application product that would be a good fit for this type of development workflow.",{"type":49,"tag":64,"props":7997,"children":7998},{},[7999,8004,8009,8014,8019,8024,8029],{"type":49,"tag":68,"props":8000,"children":8001},{},[8002],{"type":55,"value":8003},"engineering team is composed of a backend team, a frontend team, a devops team and works closely with a product team",{"type":49,"tag":68,"props":8005,"children":8006},{},[8007],{"type":55,"value":8008},"backend team primarily develops a REST API",{"type":49,"tag":68,"props":8010,"children":8011},{},[8012],{"type":55,"value":8013},"frontend team develops a JavaScript SPA (frontend website)",{"type":49,"tag":68,"props":8015,"children":8016},{},[8017],{"type":55,"value":8018},"SPA consumes backend REST API",{"type":49,"tag":68,"props":8020,"children":8021},{},[8022],{"type":55,"value":8023},"product team frequently needs to demo applications to prospective clients",{"type":49,"tag":68,"props":8025,"children":8026},{},[8027],{"type":55,"value":8028},"development teams don't have deep expertise in infrastructure, containers, CI/CD or automation",{"type":49,"tag":68,"props":8030,"children":8031},{},[8032],{"type":55,"value":8033},"devops team has been tasked with building automation that will allow anyone on the team to quickly spin up a complete environment for testing and demoing purposes within minutes",{"type":49,"tag":58,"props":8035,"children":8036},{},[8037],{"type":55,"value":8038},"Here are assumptions about specific tools and technologies used at the company:",{"type":49,"tag":64,"props":8040,"children":8041},{},[8042,8047,8052,8057,8062,8067,8072,8077,8082,8087,8092],{"type":49,"tag":68,"props":8043,"children":8044},{},[8045],{"type":55,"value":8046},"backend is a REST API developed with Django and a Postgres database",{"type":49,"tag":68,"props":8048,"children":8049},{},[8050],{"type":55,"value":8051},"backend is packaged into a docker container",{"type":49,"tag":68,"props":8053,"children":8054},{},[8055],{"type":55,"value":8056},"frontend is also packaged into a docker container using multi-stage builds and NGINX",{"type":49,"tag":68,"props":8058,"children":8059},{},[8060],{"type":55,"value":8061},"frontend does not require any build-time configuration (all configuration needed by frontend is fetched from backend)",{"type":49,"tag":68,"props":8063,"children":8064},{},[8065],{"type":55,"value":8066},"backend application's configuration is driven by plain-text environment variables at run-time",{"type":49,"tag":68,"props":8068,"children":8069},{},[8070],{"type":55,"value":8071},"engineering team uses AWS",{"type":49,"tag":68,"props":8073,"children":8074},{},[8075],{"type":55,"value":8076},"automation pipeline exists for building, tagging and pushing backend and frontend container images to an ECR repository",{"type":49,"tag":68,"props":8078,"children":8079},{},[8080],{"type":55,"value":8081},"devops team uses AWS ECS for running containerized workloads",{"type":49,"tag":68,"props":8083,"children":8084},{},[8085],{"type":55,"value":8086},"devops team uses Terraform for provisioning infrastructure",{"type":49,"tag":68,"props":8088,"children":8089},{},[8090],{"type":55,"value":8091},"devops team uses GitHub Actions for building automation pipelines",{"type":49,"tag":68,"props":8093,"children":8094},{},[8095],{"type":55,"value":8096},"team is somewhat cost-conscious",{"type":49,"tag":50,"props":8098,"children":8100},{"id":8099},"what-are-ad-hoc-environments",[8101],{"type":55,"value":8102},"What are ad hoc environments?",{"type":49,"tag":58,"props":8104,"children":8105},{},[8106],{"type":55,"value":8107},"Ad hoc environments are short-lived environments that are designed to be used for testing a specific set of features or for demoing a specific application configuration in an isolated environment. It is intended to be a functional duplicate of the main production environment. An ad hoc environment is the first cloud environment that the application code will be deployed to after a developer has been working on it in a local development environment.",{"type":49,"tag":50,"props":8109,"children":8111},{"id":8110},"trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation",[8112],{"type":55,"value":8113},"Trade-offs to make when designing ad hoc environment infrastructure and automation",{"type":49,"tag":58,"props":8115,"children":8116},{},[8117],{"type":55,"value":8118},"Now that we have a sense of what we are building and the team we are working with, let's think about the high-level trade-offs that we will face as we build a solution for providing on-demand ad hoc environments. When building infrastructure and workflows for ad hoc environments, there are a few things to solve for:",{"type":49,"tag":64,"props":8120,"children":8121},{},[8122,8127,8132,8137,8142,8147],{"type":49,"tag":68,"props":8123,"children":8124},{},[8125],{"type":55,"value":8126},"simplicity of the end-user interface and process for requesting an ad hoc environment",{"type":49,"tag":68,"props":8128,"children":8129},{},[8130],{"type":55,"value":8131},"startup speed",{"type":49,"tag":68,"props":8133,"children":8134},{},[8135],{"type":55,"value":8136},"total cost of ownership",{"type":49,"tag":68,"props":8138,"children":8139},{},[8140],{"type":55,"value":8141},"degree of similarity to production environments",{"type":49,"tag":68,"props":8143,"children":8144},{},[8145],{"type":55,"value":8146},"shared vs isolated resources",{"type":49,"tag":68,"props":8148,"children":8149},{},[8150],{"type":55,"value":8151},"automation complexity",{"type":49,"tag":58,"props":8153,"children":8154},{},[8155],{"type":55,"value":8156},"Let's look at these items by considering how we can set up the main infrastructure components that will be used to run our ad hoc application environments.",{"type":49,"tag":430,"props":8158,"children":8160},{"id":8159},"relational-databases",[8161],{"type":55,"value":8162},"Relational Databases",{"type":49,"tag":58,"props":8164,"children":8165},{},[8166],{"type":55,"value":8167},"Startup speed can be measured by the time between when an environment is requested and when that environment can be used by whoever requested it. In this period of time, an automation pipeline may do some of the following:",{"type":49,"tag":64,"props":8169,"children":8170},{},[8171,8196,8201,8206],{"type":49,"tag":68,"props":8172,"children":8173},{},[8174,8176,8182,8183,8188,8189,8194],{"type":55,"value":8175},"run ",{"type":49,"tag":326,"props":8177,"children":8179},{"className":8178},[],[8180],{"type":55,"value":8181},"terraform init",{"type":55,"value":873},{"type":49,"tag":326,"props":8184,"children":8186},{"className":8185},[],[8187],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":8190,"children":8192},{"className":8191},[],[8193],{"type":55,"value":559},{"type":55,"value":8195}," to build infrastructure",{"type":49,"tag":68,"props":8197,"children":8198},{},[8199],{"type":55,"value":8200},"run scripts to prepare the application such as database migrations",{"type":49,"tag":68,"props":8202,"children":8203},{},[8204],{"type":55,"value":8205},"seeding initial sample data with a script or database dump",{"type":49,"tag":68,"props":8207,"children":8208},{},[8209],{"type":55,"value":8210},"message the user with information about the environment (URLs, commands for accessing an interactive shell, etc.)",{"type":49,"tag":58,"props":8212,"children":8213},{},[8214,8216,8221],{"type":55,"value":8215},"RDS instances can take a long time to create relative to other AWS resources such as S3 buckets and IAM roles. RDS instances are also more costly than other resources. We could use a single, shared RDS instance placed in a private subnet of a shared VPC. Each ad hoc environment could use a different named database in the RDS instance in the form ",{"type":49,"tag":326,"props":8217,"children":8219},{"className":8218},[],[8220],{"type":55,"value":2704},{"type":55,"value":8222},". Using one RDS instance per ad hoc environment would be slow to startup and tear down and also costly if there are many developers using ad hoc environments simultaneously.",{"type":49,"tag":58,"props":8224,"children":8225},{},[8226],{"type":55,"value":8227},"If we choose to isolate the application's relational database at the database level (and not the RDS instance level), then we will need our automation workflow to create a database per ad hoc environment.",{"type":49,"tag":58,"props":8229,"children":8230},{},[8231],{"type":55,"value":8232},"Let's spin up a simple example to illustrate how this would would work.",{"type":49,"tag":64,"props":8234,"children":8235},{},[8236,8249,8260,8271,8292,8297,8309,8321],{"type":49,"tag":68,"props":8237,"children":8238},{},[8239,8241,8247],{"type":55,"value":8240},"A developer is working on ",{"type":49,"tag":326,"props":8242,"children":8244},{"className":8243},[],[8245],{"type":55,"value":8246},"feature-abc",{"type":55,"value":8248}," that involves a significant refactor of the data model.",{"type":49,"tag":68,"props":8250,"children":8251},{},[8252,8254,8259],{"type":55,"value":8253},"The developer decides to spin up an ad hoc environment called ",{"type":49,"tag":326,"props":8255,"children":8257},{"className":8256},[],[8258],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8261,"children":8262},{},[8263,8265,8270],{"type":55,"value":8264},"Our automation will need to create a database in the RDS instance called ",{"type":49,"tag":326,"props":8266,"children":8268},{"className":8267},[],[8269],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8272,"children":8273},{},[8274,8276,8282,8284,8290],{"type":55,"value":8275},"We can configure a bastion host with ",{"type":49,"tag":326,"props":8277,"children":8279},{"className":8278},[],[8280],{"type":55,"value":8281},"psql",{"type":55,"value":8283}," installed that has network and security group access to our RDS instance, and we can give our GitHub Actions an SSH key that can be used to run ",{"type":49,"tag":326,"props":8285,"children":8287},{"className":8286},[],[8288],{"type":55,"value":8289},"createdb",{"type":55,"value":8291}," over SSH.",{"type":49,"tag":68,"props":8293,"children":8294},{},[8295],{"type":55,"value":8296},"The automation also runs database migrations once the application has started, and we can view the logs of the database migration to check for any irregularities or other issues.",{"type":49,"tag":68,"props":8298,"children":8299},{},[8300,8302,8307],{"type":55,"value":8301},"This will give the developer and the rest of team confidence that the promoting ",{"type":49,"tag":326,"props":8303,"children":8305},{"className":8304},[],[8306],{"type":55,"value":8246},{"type":55,"value":8308}," to the next pre-production environments will not have any errors.",{"type":49,"tag":68,"props":8310,"children":8311},{},[8312,8314,8319],{"type":55,"value":8313},"The developer may even choose to load a SQL dump of the next pre-production environment into their ",{"type":49,"tag":326,"props":8315,"children":8317},{"className":8316},[],[8318],{"type":55,"value":8246},{"type":55,"value":8320}," database get even more confidence that there will be no data integrity errors.",{"type":49,"tag":68,"props":8322,"children":8323},{},[8324,8326,8331,8333,8338],{"type":55,"value":8325},"When the developer's PR is merged and approved, the ad hoc environment ",{"type":49,"tag":326,"props":8327,"children":8329},{"className":8328},[],[8330],{"type":55,"value":8246},{"type":55,"value":8332}," can be destroyed, including the ",{"type":49,"tag":326,"props":8334,"children":8336},{"className":8335},[],[8337],{"type":55,"value":8246},{"type":55,"value":8339}," database in the shared RDS instance.",{"type":49,"tag":58,"props":8341,"children":8342},{},[8343],{"type":55,"value":8344},"With this approach we won't incur the costs of multiple RDS instances. Ad hoc environments will start up faster because an RDS instance per environment is not required. We do have slightly less resource isolation, and we need to introduce a bastion host, but I consider this an acceptable trade-off.",{"type":49,"tag":430,"props":8346,"children":8348},{"id":8347},"redis-key-value-database",[8349],{"type":55,"value":8350},"Redis (key-value database)",{"type":49,"tag":58,"props":8352,"children":8353},{},[8354],{"type":55,"value":8355},"Redis is another database used in the application and it plays a few different roles:",{"type":49,"tag":64,"props":8357,"children":8358},{},[8359,8364,8369],{"type":49,"tag":68,"props":8360,"children":8361},{},[8362],{"type":55,"value":8363},"primarily, it is a caching layer that can cache request responses to reduce load on the database and speed up our application",{"type":49,"tag":68,"props":8365,"children":8366},{},[8367],{"type":55,"value":8368},"it is a message broker for our async task workers (celery)",{"type":49,"tag":68,"props":8370,"children":8371},{},[8372],{"type":55,"value":8373},"it can be used as a backend for other 3rd party Django apps that our main application may need to use (such as django-constance, cache-ops, django-channels, etc.)",{"type":49,"tag":58,"props":8375,"children":8376},{},[8377],{"type":55,"value":8378},"AWS offers a managed Redis service called ElastiCache. Redis running on an ElastiCache instance can do database isolation similar to how Postgres running on RDS can do database isolation as we discussed previously, but there are some key differences:",{"type":49,"tag":64,"props":8380,"children":8381},{},[8382,8387],{"type":49,"tag":68,"props":8383,"children":8384},{},[8385],{"type":55,"value":8386},"redis databases are numbered, not named",{"type":49,"tag":68,"props":8388,"children":8389},{},[8390,8392,8398,8400,8406],{"type":55,"value":8391},"the backend application uses isolated numbered databases for the different 3rd party apps that I just mentioned (for example: celery can use database ",{"type":49,"tag":326,"props":8393,"children":8395},{"className":8394},[],[8396],{"type":55,"value":8397},"0",{"type":55,"value":8399},",  API caching layer can use database ",{"type":49,"tag":326,"props":8401,"children":8403},{"className":8402},[],[8404],{"type":55,"value":8405},"1",{"type":55,"value":8407},", etc.)",{"type":49,"tag":58,"props":8409,"children":8410},{},[8411,8413,8418],{"type":55,"value":8412},"This makes it difficult to use a single ElastiCache instance for our ad hoc environments since we would need to figure out which numbered database to assign to a specific role for each ad hoc environment (e.g. how do we know which numbered database to use for the API caching for the ",{"type":49,"tag":326,"props":8414,"children":8416},{"className":8415},[],[8417],{"type":55,"value":8246},{"type":55,"value":8419}," ad hoc environment).",{"type":49,"tag":58,"props":8421,"children":8422},{},[8423],{"type":55,"value":8424},"So how can we approach providing isolated redis instances for multiple ad hoc environments? Spoiler: my solution is to run redis as a stateful service in ECS. Before we dig into how to do this, we need to talk about another important part of our application: compute.",{"type":49,"tag":430,"props":8426,"children":8428},{"id":8427},"compute",[8429],{"type":55,"value":8430},"Compute",{"type":49,"tag":58,"props":8432,"children":8433},{},[8434],{"type":55,"value":8435},"Our backend application is composed of a few different services that all share the same code base. In other words, our backend's services uses the same docker image but run different processes for each component:",{"type":49,"tag":64,"props":8437,"children":8438},{},[8439,8444,8449],{"type":49,"tag":68,"props":8440,"children":8441},{},[8442],{"type":55,"value":8443},"gunicorn for the core API",{"type":49,"tag":68,"props":8445,"children":8446},{},[8447],{"type":55,"value":8448},"celery for the task workers",{"type":49,"tag":68,"props":8450,"children":8451},{},[8452],{"type":55,"value":8453},"celerybeat for task scheduling",{"type":49,"tag":58,"props":8455,"children":8456},{},[8457],{"type":55,"value":8458},"If our application used websockets, we could have another service that runs an asgi server process (like daphne or uvicorn).",{"type":49,"tag":58,"props":8460,"children":8461},{},[8462],{"type":55,"value":8463},"Since our backend application is packaged into a container and we are using AWS as our cloud provider, ECS is a great choice for running our backend services. ECS is a container orchestration tool that I usually describe as a nice middle ground between docker swarm and Kubernetes. Simply put, it is a flexible option for running our containerized services that make up our backend application.",{"type":49,"tag":58,"props":8465,"children":8466},{},[8467],{"type":55,"value":8468},"With ECS you can choose to run containers directly on EC2 instances that you manage, or you can run containers using Fargate. Fargate is a serverless compute option that takes care of managing both the underlying \"computer\" and operating system that run our application's containers. All of our backend dependencies are defined in our Dockerfile, so we do not to maintain or update the underlying operating system that runs our containers -- AWS handles all of this for us. To use Fargate, we simply tell AWS which containers to run and how much CPU and memory to use in the ECS Task that runs the containers. To scale our app horizontally, the ECS service that managed ECS tasks simply increases the number of tasks that run.",{"type":49,"tag":58,"props":8470,"children":8471},{},[8472],{"type":55,"value":8473},"Since we are going to use the Fargate launch type for our ECS Tasks, let's talk about the ergonomics of these serverless compute instances compared to running our services directly on an EC2 instances.",{"type":49,"tag":64,"props":8475,"children":8476},{},[8477,8482],{"type":49,"tag":68,"props":8478,"children":8479},{},[8480],{"type":55,"value":8481},"We can't SSH into Fargate compute instances. We can instead use AWS Systems Manager and EcsExec to open an interactive shell in a running backend container. This can be useful for developers who might need to run a management command or access an interactive Django shell to verify behavior in their ad hoc environment.",{"type":49,"tag":68,"props":8483,"children":8484},{},[8485],{"type":55,"value":8486},"We can't simply change code on the server and restart services. This can sometimes be a useful pattern for debugging something that can only be tested on a cloud environment (e.g. something that can't easily be reproduced on your local machine), so this requires that developers push new images to their backend services for every change they want to see reflected on their ad hoc environment. Later on I'll discuss how we can provide tooling for developers to quickly update the image used in their backend services.",{"type":49,"tag":58,"props":8488,"children":8489},{},[8490],{"type":55,"value":8491},"With AWS Fargate, you will pay more than you would for a comparable amount of CPU and memory on EC2 instances. Similar to EC2 spot instances, Fargate offers interruptable instances called Fargate Spot which costs significantly less than regular Fargate instances. Fargate spot is appropriate for our ad hoc environments since ad hoc environments are non-critical workloads. In the event that a Fargate spot instance is interrupted, the ECS service will automatically launch another Fargate task to replace the task that was stopped.",{"type":49,"tag":58,"props":8493,"children":8494},{},[8495],{"type":55,"value":8496},"In my opinion, ECS with Fargate is ideal for running the stateless services that make up our backend application. In terms of parity with our production environment, we can keep almost everything the same, except use regular Fargate instances instead of Fargate spot instances.",{"type":49,"tag":430,"props":8498,"children":8500},{"id":8499},"redis-revisited",[8501],{"type":55,"value":8502},"Redis, revisited",{"type":49,"tag":58,"props":8504,"children":8505},{},[8506],{"type":55,"value":8507},"We can run redis as an ECS service instead of using ElastiCache. In order to do this, we will need our backend services (gunicorn, celery and celerybeat) to be able to communicate with a fourth ECS service that will be running redis (using an official redis image from Docker Hub, or a redis image that we define in ECR).",{"type":49,"tag":58,"props":8509,"children":8510},{},[8511,8513,8518,8520,8525,8527,8532],{"type":55,"value":8512},"By default, ",{"type":49,"tag":72,"props":8514,"children":8515},{},[8516],{"type":55,"value":8517},"there is no way for our backend services to know how to communicate with any other service in our ECS cluster",{"type":55,"value":8519},". If you have used docker-compose, you may know that you can use the service name ",{"type":49,"tag":326,"props":8521,"children":8523},{"className":8522},[],[8524],{"type":55,"value":3151},{"type":55,"value":8526}," in a backend service to easily communicate with a redis service called ",{"type":49,"tag":326,"props":8528,"children":8530},{"className":8529},[],[8531],{"type":55,"value":3151},{"type":55,"value":8533},". This networking convenience is not available to use out of the box with ECS. To achieve this in AWS, we need some way to manage a unique ad hoc environment-specific Route 53 DNS record that points to the private IP of the Fargate task that is running redis in an ECS cluster for a given ad hoc environment. Such a service exists in AWS and it is called Cloud Map. Cloud Map offers service discovery so that our backend services can make network calls to a static DNS address that will reliably point to the correct private IP of the ECS task running the redis container.",{"type":49,"tag":58,"props":8535,"children":8536},{},[8537,8539,8544,8546,8552,8554,8560,8562,8568,8570,8576],{"type":55,"value":8538},"We can define a service discovery namespace (which will essentially be a top level domain, or TLD) that all of our ad hoc environments can share. Let's assume this namespace is called ",{"type":49,"tag":326,"props":8540,"children":8542},{"className":8541},[],[8543],{"type":55,"value":1353},{"type":55,"value":8545},". Each ad hoc environment can then define a service discovery service in the shared namespace for redis that is called ",{"type":49,"tag":326,"props":8547,"children":8549},{"className":8548},[],[8550],{"type":55,"value":8551},"{ad-hoc-env-name}-redis",{"type":55,"value":8553},". This way, we can have a reliable address that we can configure as an environment for our backend that will look like this: ",{"type":49,"tag":326,"props":8555,"children":8557},{"className":8556},[],[8558],{"type":55,"value":8559},"redis://{ad-hoc-env-name}-redis.ad-hoc:6379/0",{"type":55,"value":8561},". ",{"type":49,"tag":326,"props":8563,"children":8565},{"className":8564},[],[8566],{"type":55,"value":8567},"{ad-hoc-env-name-redis}.ad-hoc",{"type":55,"value":8569}," will be the hostname of the redis service, and Route 53 will create records that point to ",{"type":49,"tag":326,"props":8571,"children":8573},{"className":8572},[],[8574],{"type":55,"value":8575},"{ad-hoc-env-name}-redis.ad-hoc",{"type":55,"value":8577}," to the private IP of the redis Fargate task for each ad hoc environment.",{"type":49,"tag":430,"props":8579,"children":8581},{"id":8580},"load-balancing",[8582],{"type":55,"value":8583},"Load Balancing",{"type":49,"tag":58,"props":8585,"children":8586},{},[8587],{"type":55,"value":8588},"We now have our backend services (gunicorn, celery and celerybeat) running on Fargate spot instances, and these services can communicate with the redis service in our ad hoc environment's ECS cluster using service discovery that we configured with Cloud Map. We still need to think about a few things:",{"type":49,"tag":64,"props":8590,"children":8591},{},[8592,8597,8602],{"type":49,"tag":68,"props":8593,"children":8594},{},[8595],{"type":55,"value":8596},"how will we expose our API service to the public (or private) internet",{"type":49,"tag":68,"props":8598,"children":8599},{},[8600],{"type":55,"value":8601},"how will we expose our frontend application to the public (or private) internet",{"type":49,"tag":68,"props":8603,"children":8604},{},[8605],{"type":55,"value":8606},"how will we make sure that requests go the correct ECS services",{"type":49,"tag":58,"props":8608,"children":8609},{},[8610],{"type":55,"value":8611},"Application load balancers (ALBs) are a great way to expose web app traffic to the internet. We could either have one application load balancer per ad hoc environment, or one application load balancer shared between all ad hoc environments. ALBs are somewhat slow to create and they also incur a significant monthly cost. They are also highly scalable, so using a shared ALB for all ad hoc environments would work.",{"type":49,"tag":58,"props":8613,"children":8614},{},[8615],{"type":55,"value":8616},"Individual ad hoc environments can then create target groups and listener rules for a shared ALB for each service that needs to serve requests from the internet (the backend and the frontend). In our case this is the backend API server and the frontend server that serves our static frontend site using NGINX.",{"type":49,"tag":58,"props":8618,"children":8619},{},[8620],{"type":55,"value":8621},"ECS services that need to be exposed to the internet can specify the target group, port and container to use for load balancing. A target group is created that defines the health check and other settings, and a load balancer listener rule is created on the shared load balancer that will forward traffic matching certain conditions to the target group for our service.",{"type":49,"tag":58,"props":8623,"children":8624},{},[8625,8627,8633,8635,8641],{"type":55,"value":8626},"For a given ad hoc environment, we need to specify that only traffic with certain paths should be sent to the backend service, and all other traffic should be sent to the frontend service. For example, we may only want to send traffic that starts with the path ",{"type":49,"tag":326,"props":8628,"children":8630},{"className":8629},[],[8631],{"type":55,"value":8632},"/api",{"type":55,"value":8634}," or ",{"type":49,"tag":326,"props":8636,"children":8638},{"className":8637},[],[8639],{"type":55,"value":8640},"/admin",{"type":55,"value":8642}," to the backend target group, and all other traffic should be sent to the frontend target group. We can do this by setting conditions on the listener rules that forward traffic do the frontend and backend target groups based on the hostname and path.",{"type":49,"tag":58,"props":8644,"children":8645},{},[8646,8648,8653,8654,8659,8661,8666,8668,8674],{"type":55,"value":8647},"We want our listener rule logic to forward ",{"type":49,"tag":326,"props":8649,"children":8651},{"className":8650},[],[8652],{"type":55,"value":8632},{"type":55,"value":873},{"type":49,"tag":326,"props":8655,"children":8657},{"className":8656},[],[8658],{"type":55,"value":8640},{"type":55,"value":8660}," and any other backend traffic to the backend target group, and forward all other traffic (",{"type":49,"tag":326,"props":8662,"children":8664},{"className":8663},[],[8665],{"type":55,"value":3211},{"type":55,"value":8667},") to the frontend target group. In order to do this, we need the backend listener rule to have a higher priority than the frontend listener rule for each ad hoc environment. Since we are using the same load balancer for all ad hoc environments, the priority values for each listener rule need to be unique. If we don't set the priority explicitly, then the priority will be set automatically to the next available value in ascending order. In order to make sure that the backend listener rule has a higher priority than the frontend listener rule for each ad hoc environment, we need to tell Terraform that the frontend module ",{"type":49,"tag":326,"props":8669,"children":8671},{"className":8670},[],[8672],{"type":55,"value":8673},"depends_on",{"type":55,"value":8675}," the backend module. This way the backend listener rule will have a higher priority (e.g. priority of 1) because it will be created first, and the frontend listener rule will have a lower priority (e.g. priority of 2).",{"type":49,"tag":50,"props":8677,"children":8679},{"id":8678},"more-on-shared-resources-vs-per-environment-resources",[8680],{"type":55,"value":8681},"More on shared resources vs per-environment resources",{"type":49,"tag":58,"props":8683,"children":8684},{},[8685],{"type":55,"value":8686},"Up until now we have discussed infrastructure design decisions at a high level, but we have not yet talked about how to organize our infrastructure as code. At a basic level, components of our ad hoc environment either fall into shared infrastructure or infrastructure that is specific to an individual ad hoc environment. Here's a list of the resources that are shared and the resources that are specific to each ad hoc environment.",{"type":49,"tag":58,"props":8688,"children":8689},{},[8690],{"type":55,"value":8691},"Shared resources include:",{"type":49,"tag":64,"props":8693,"children":8694},{},[8695,8699,8704,8709,8714,8719,8723],{"type":49,"tag":68,"props":8696,"children":8697},{},[8698],{"type":55,"value":2094},{"type":49,"tag":68,"props":8700,"children":8701},{},[8702],{"type":55,"value":8703},"IAM policies",{"type":49,"tag":68,"props":8705,"children":8706},{},[8707],{"type":55,"value":8708},"Security groups",{"type":49,"tag":68,"props":8710,"children":8711},{},[8712],{"type":55,"value":8713},"RDS instance",{"type":49,"tag":68,"props":8715,"children":8716},{},[8717],{"type":55,"value":8718},"Service Discovery namespace",{"type":49,"tag":68,"props":8720,"children":8721},{},[8722],{"type":55,"value":2373},{"type":49,"tag":68,"props":8724,"children":8725},{},[8726],{"type":55,"value":8727},"Bastion host",{"type":49,"tag":58,"props":8729,"children":8730},{},[8731],{"type":55,"value":8732},"Ad hoc environment resources include:",{"type":49,"tag":64,"props":8734,"children":8735},{},[8736,8740,8745,8750,8755,8760,8765,8777,8782],{"type":49,"tag":68,"props":8737,"children":8738},{},[8739],{"type":55,"value":2880},{"type":49,"tag":68,"props":8741,"children":8742},{},[8743],{"type":55,"value":8744},"ECS Tasks and Services (for backend and frontend applications)",{"type":49,"tag":68,"props":8746,"children":8747},{},[8748],{"type":55,"value":8749},"ECS Tasks for running management commands (such as migrate)",{"type":49,"tag":68,"props":8751,"children":8752},{},[8753],{"type":55,"value":8754},"CloudWatch logging groups for containers defined in ECS Tasks",{"type":49,"tag":68,"props":8756,"children":8757},{},[8758],{"type":55,"value":8759},"ALB Target groups",{"type":49,"tag":68,"props":8761,"children":8762},{},[8763],{"type":55,"value":8764},"ALB listener rules",{"type":49,"tag":68,"props":8766,"children":8767},{},[8768,8770,8776],{"type":55,"value":8769},"Route 53 record that points to the load balancer (e.g. ",{"type":49,"tag":326,"props":8771,"children":8773},{"className":8772},[],[8774],{"type":55,"value":8775},"ad-hoc-env-name.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":8778,"children":8779},{},[8780],{"type":55,"value":8781},"S3 bucket for static and media assets",{"type":49,"tag":68,"props":8783,"children":8784},{},[8785],{"type":55,"value":8786},"Service Discovery Service for redis service in ECS cluster",{"type":49,"tag":58,"props":8788,"children":8789},{},[8790],{"type":55,"value":8791},"Shared resources can be defined in one terraform configuration and deployed once. These resources will be long-lived as long as the application is under active development and the team requires on-demand provisioning of ad hoc environments.",{"type":49,"tag":58,"props":8793,"children":8794},{},[8795,8797,8802,8804,8810,8812,8818,8819,8825,8826,8832,8834,8840],{"type":55,"value":8796},"Ad hoc environment resources can be defined in another terraform configuration that references outputs from the shared resource configuration using ",{"type":49,"tag":326,"props":8798,"children":8800},{"className":8799},[],[8801],{"type":55,"value":1842},{"type":55,"value":8803},". Each ad hoc environment can be defined by a ",{"type":49,"tag":326,"props":8805,"children":8807},{"className":8806},[],[8808],{"type":55,"value":8809},"\u003Cname>.tfvars",{"type":55,"value":8811}," file that contains the name of the ad hoc environment (such as ",{"type":49,"tag":326,"props":8813,"children":8815},{"className":8814},[],[8816],{"type":55,"value":8817},"brian",{"type":55,"value":873},{"type":49,"tag":326,"props":8820,"children":8822},{"className":8821},[],[8823],{"type":55,"value":8824},"brian2",{"type":55,"value":873},{"type":49,"tag":326,"props":8827,"children":8829},{"className":8828},[],[8830],{"type":55,"value":8831},"demo-feature-abc",{"type":55,"value":8833},", etc.). This ",{"type":49,"tag":326,"props":8835,"children":8837},{"className":8836},[],[8838],{"type":55,"value":8839},"\u003Cname>",{"type":55,"value":8841}," value will also be the name of the Terraform workspace and will be used to name and tag AWS resources associated with the corresponding ad hoc environment.",{"type":49,"tag":58,"props":8843,"children":8844},{},[8845,8846,8851],{"type":55,"value":413},{"type":49,"tag":326,"props":8847,"children":8849},{"className":8848},[],[8850],{"type":55,"value":8809},{"type":55,"value":8852}," file will allow developers to use a simple, standard file interface for defining application specific values, such as the version of the backend and frontend. This brings developers into the concepts and practices of \"infrastructure as code\" and \"configuration as code\" and also helps the entire team keep track of how different environments are configured.",{"type":49,"tag":58,"props":8854,"children":8855},{},[8856,8858,8863,8865,8871,8873,8880],{"type":55,"value":8857},"Ad hoc environment ",{"type":49,"tag":326,"props":8859,"children":8861},{"className":8860},[],[8862],{"type":55,"value":8809},{"type":55,"value":8864}," files are stored in a directory of a special git repository that also defines the ad hoc environment terraform configuration. Currently, the ",{"type":49,"tag":326,"props":8866,"children":8868},{"className":8867},[],[8869],{"type":55,"value":8870},"tfvars",{"type":55,"value":8872}," files are stored ",{"type":49,"tag":80,"props":8874,"children":8877},{"href":8875,"rel":8876},"https://github.com/briancaffey/django-step-by-step/tree/main/terraform/live/ad-hoc/envs",[84],[8878],{"type":55,"value":8879},"here",{"type":55,"value":745},{"type":49,"tag":58,"props":8882,"children":8883},{},[8884,8886,8891,8892,8897],{"type":55,"value":8885},"Now let's look at the two terraform configurations used for defining ",{"type":49,"tag":72,"props":8887,"children":8888},{},[8889],{"type":55,"value":8890},"shared resources",{"type":55,"value":715},{"type":49,"tag":72,"props":8893,"children":8894},{},[8895],{"type":55,"value":8896},"ad hoc environment resources",{"type":55,"value":745},{"type":49,"tag":50,"props":8899,"children":8901},{"id":8900},"ad-hoc-environment-diagram",[8902],{"type":55,"value":8903},"Ad Hoc Environment Diagram",{"type":49,"tag":58,"props":8905,"children":8906},{},[8907,8909,8914,8915,8920],{"type":55,"value":8908},"Here's an overview of the resources used for the ad hoc environments. The ",{"type":49,"tag":72,"props":8910,"children":8911},{},[8912],{"type":55,"value":8913},"letters represent shared resources",{"type":55,"value":6280},{"type":49,"tag":72,"props":8916,"children":8917},{},[8918],{"type":55,"value":8919},"numbers represent per-environment resources",{"type":55,"value":745},{"type":49,"tag":58,"props":8922,"children":8923},{},[8924],{"type":49,"tag":1601,"props":8925,"children":8927},{"alt":8926,"src":7821},"png",[],{"type":49,"tag":430,"props":8929,"children":8931},{"id":8930},"shared-architecture",[8932],{"type":55,"value":8933},"Shared architecture",{"type":49,"tag":58,"props":8935,"children":8936},{},[8937,8939,8946],{"type":55,"value":8938},"A. VPC (created using the ",{"type":49,"tag":80,"props":8940,"children":8943},{"href":8941,"rel":8942},"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest",[84],[8944],{"type":55,"value":8945},"official AWS VPC Module",{"type":55,"value":616},{"type":49,"tag":58,"props":8948,"children":8949},{},[8950],{"type":55,"value":8951},"B. Public subnets for bastion host, NAT Gateways and Load Balancer",{"type":49,"tag":58,"props":8953,"children":8954},{},[8955],{"type":55,"value":8956},"C. Private subnets for application workloads and RDS",{"type":49,"tag":58,"props":8958,"children":8959},{},[8960],{"type":55,"value":8961},"D. Application Load Balancer that is shared between all ad hoc environments. A pre-provisioned wildcard ACM certificate is attached to the load balancer that is used to secure traffic for load-balanced ECS services",{"type":49,"tag":58,"props":8963,"children":8964},{},[8965],{"type":55,"value":8966},"E. Service discovery namespace that provides a namespace for application workloads to access the redis service running in ECS",{"type":49,"tag":58,"props":8968,"children":8969},{},[8970],{"type":55,"value":8971},"F. IAM roles needed for ECS tasks to access AWS services",{"type":49,"tag":58,"props":8973,"children":8974},{},[8975],{"type":55,"value":8976},"G. RDS instance using postgres engine that is shared between all ad hoc environments",{"type":49,"tag":58,"props":8978,"children":8979},{},[8980],{"type":55,"value":8981},"H. Bastion host used to access RDS from GitHub Actions (needed for creating per-environment databases)",{"type":49,"tag":58,"props":8983,"children":8984},{},[8985],{"type":55,"value":8986},"I. NAT Gateway used to give traffic in private subnets a route to the public internet",{"type":49,"tag":430,"props":8988,"children":8990},{"id":8989},"environment-specific-architecture",[8991],{"type":55,"value":8992},"Environment-specific architecture",{"type":49,"tag":8994,"props":8995,"children":8996},"ol",{},[8997,9002,9007,9012,9017,9022,9027,9032,9037,9047,9056,9061],{"type":49,"tag":68,"props":8998,"children":8999},{},[9000],{"type":55,"value":9001},"ECS Cluster that groups all ECS tasks for a single ad hoc environment",{"type":49,"tag":68,"props":9003,"children":9004},{},[9005],{"type":55,"value":9006},"Listener rules and target groups that direct traffic from the load balancer to the ECS services for an ad hoc environment.",{"type":49,"tag":68,"props":9008,"children":9009},{},[9010],{"type":55,"value":9011},"Redis service running in ECS that provides caching and serves as a task broker for celery",{"type":49,"tag":68,"props":9013,"children":9014},{},[9015],{"type":55,"value":9016},"Route53 records that point to the load balancer",{"type":49,"tag":68,"props":9018,"children":9019},{},[9020],{"type":55,"value":9021},"Frontend service that serves the Vue.js application over NGINX",{"type":49,"tag":68,"props":9023,"children":9024},{},[9025],{"type":55,"value":9026},"API service that serves the backend with Gunicorn",{"type":49,"tag":68,"props":9028,"children":9029},{},[9030],{"type":55,"value":9031},"Celery worker that process jobs in the default queue",{"type":49,"tag":68,"props":9033,"children":9034},{},[9035],{"type":55,"value":9036},"Celery beat that schedules celery tasks",{"type":49,"tag":68,"props":9038,"children":9039},{},[9040,9045],{"type":49,"tag":326,"props":9041,"children":9043},{"className":9042},[],[9044],{"type":55,"value":3316},{"type":55,"value":9046}," task",{"type":49,"tag":68,"props":9048,"children":9049},{},[9050,9055],{"type":49,"tag":326,"props":9051,"children":9053},{"className":9052},[],[9054],{"type":55,"value":3323},{"type":55,"value":9046},{"type":49,"tag":68,"props":9057,"children":9058},{},[9059],{"type":55,"value":9060},"CloudWatch log groups are created for each ECS task in an ad hoc environment",{"type":49,"tag":68,"props":9062,"children":9063},{},[9064],{"type":55,"value":9065},"Each ad hoc environment gets a database in the shared RDS instance",{"type":49,"tag":50,"props":9067,"children":9069},{"id":9068},"shared-resources-terraform-configuration",[9070],{"type":55,"value":9071},"Shared resources terraform configuration",{"type":49,"tag":58,"props":9073,"children":9074},{},[9075],{"type":55,"value":9076},"Let's have a detailed look at the terraform configuration for shared resources that will support ad hoc environments.",{"type":49,"tag":58,"props":9078,"children":9079},{},[9080],{"type":49,"tag":1601,"props":9081,"children":9084},{"alt":9082,"src":9083},"Shared AWS resources for ad hoc environment","/image/shared-resources.png",[],{"type":49,"tag":430,"props":9086,"children":9087},{"id":2091},[9088],{"type":55,"value":2094},{"type":49,"tag":58,"props":9090,"children":9091},{},[9092,9094,9100],{"type":55,"value":9093},"We can use the ",{"type":49,"tag":80,"props":9095,"children":9097},{"href":8941,"rel":9096},[84],[9098],{"type":55,"value":9099},"AWS VPC module",{"type":55,"value":9101}," for creating the shared VPC with Terraform. This module provides a high level interface that will provision lots of the components that are needed for a VPC following best practices, and it is less code for the DevOps team to manage compared to defining each component of a VPC (route tables, subnets, internet gateways, etc.).",{"type":49,"tag":430,"props":9103,"children":9105},{"id":9104},"cloud-map-service-discovery-namespace",[9106],{"type":55,"value":9107},"Cloud Map Service Discovery Namespace",{"type":49,"tag":58,"props":9109,"children":9110},{},[9111],{"type":55,"value":9112},"Cloud Map is used in order to allow services in our ECS cluster to communicate with each other. The only reason that Cloud Map is needed is so that the backend services (API, celery workers, beat) can communicate with Redis, which will be an important service for our application, providing caching and also serving as a broker for celery. If we were to use Django Channels for websockets, the Redis service would also function as the backend for Django Channels.",{"type":49,"tag":58,"props":9114,"children":9115},{},[9116,9118,9124],{"type":55,"value":9117},"We will only need to specify ",{"type":49,"tag":326,"props":9119,"children":9121},{"className":9120},[],[9122],{"type":55,"value":9123},"service_registries",{"type":55,"value":9125}," on the redis service in our ECS cluster. What this will do is provide an address that our other services can use to communicate with redis. This address is created in the form of a Route 53 record, and it points to the private IP address of the redis service. If the private IP of the redis service is updated, the Route 53 record record for our redis service will be updated as well.",{"type":49,"tag":58,"props":9127,"children":9128},{},[9129],{"type":55,"value":9130},"In order for service discovery to work in the VPC that we created, we need to add the following options to the terraform AWS VPC module:",{"type":49,"tag":1050,"props":9132,"children":9134},{"code":9133},"# DNS settings\nenable_dns_hostnames = true\nenable_dns_support   = true\n",[9135],{"type":49,"tag":326,"props":9136,"children":9137},{"__ignoreMap":8},[9138],{"type":55,"value":9133},{"type":49,"tag":430,"props":9140,"children":9141},{"id":2160},[9142],{"type":55,"value":2017},{"type":49,"tag":58,"props":9144,"children":9145},{},[9146],{"type":55,"value":9147},"There are two important security groups that we will set up as part of the shared infrastructure layer to be used by each ad hoc environment: one security group for the load balancer, and one security group where all of our ECS services will run.",{"type":49,"tag":58,"props":9149,"children":9150},{},[9151,9153,9158,9159,9164,9166,9172,9173,9179],{"type":55,"value":9152},"The load balancer security group will allow all traffic on port ",{"type":49,"tag":326,"props":9154,"children":9156},{"className":9155},[],[9157],{"type":55,"value":2341},{"type":55,"value":715},{"type":49,"tag":326,"props":9160,"children":9162},{"className":9161},[],[9163],{"type":55,"value":2290},{"type":55,"value":9165}," for ",{"type":49,"tag":326,"props":9167,"children":9169},{"className":9168},[],[9170],{"type":55,"value":9171},"HTTP",{"type":55,"value":715},{"type":49,"tag":326,"props":9174,"children":9176},{"className":9175},[],[9177],{"type":55,"value":9178},"HTTPS",{"type":55,"value":9180}," traffic. The ECS security group will only allow inbound traffic from the application load balancer security group. It will also allow for traffic from port 6379 for redis traffic.",{"type":49,"tag":430,"props":9182,"children":9184},{"id":9183},"iam-roles",[9185],{"type":55,"value":9186},"IAM Roles",{"type":49,"tag":58,"props":9188,"children":9189},{},[9190],{"type":55,"value":9191},"There are two important IAM roles that we will need for our ECS tasks. We need a task execution role that our ECS tasks will use to interact with other AWS services, such as S3, Secrets Manager, etc.",{"type":49,"tag":430,"props":9193,"children":9195},{"id":9194},"rds-instance",[9196],{"type":55,"value":9197},"RDS Instance",{"type":49,"tag":58,"props":9199,"children":9200},{},[9201],{"type":55,"value":9202},"We will create one RDS instance in one of the private subnets in our VPC. This RDS instance will have one Postgres database per ad hoc environment. This RDS instance has a security group that allows all traffic from our ECS security group.",{"type":49,"tag":430,"props":9204,"children":9206},{"id":9205},"load-balancer",[9207],{"type":55,"value":2022},{"type":49,"tag":58,"props":9209,"children":9210},{},[9211,9213,9219,9221,9227],{"type":55,"value":9212},"We will use one load balancer for all ad hoc environments. This load balancer will have a wildcard ACM certificate attached to it (",{"type":49,"tag":326,"props":9214,"children":9216},{"className":9215},[],[9217],{"type":55,"value":9218},"*.dev.example.com",{"type":55,"value":9220},", for example). Each ad hoc environment will create a Route 53 record that will point to this load balancer's public DNS name. For example, ",{"type":49,"tag":326,"props":9222,"children":9224},{"className":9223},[],[9225],{"type":55,"value":9226},"brian.dev.example.com",{"type":55,"value":9228}," will be the address of my ad hoc environment. Requests to this address will then be routed to either the frontend ECS service or the backend ECS service depending on request header values and request path values that will be set on the listener rules.",{"type":49,"tag":58,"props":9230,"children":9231},{},[9232],{"type":55,"value":9233},"By default, a load balancer supports up to 50 listener rules, so we can create plenty of ad hoc environments before we need to increase the default quota. There will be a discussion at the end of this article about AWS service quotas.",{"type":49,"tag":430,"props":9235,"children":9236},{"id":2683},[9237],{"type":55,"value":2032},{"type":49,"tag":58,"props":9239,"children":9240},{},[9241],{"type":55,"value":9242},"The bastion host will be created in one of the VPC's public subnets. This will primarily be used for connecting to RDS to create new databases for new ad hoc environments, or for manually manipulating data in an ad hoc environment for debugging.",{"type":49,"tag":50,"props":9244,"children":9246},{"id":9245},"ad-hoc-environment-resources",[9247],{"type":55,"value":9248},"Ad hoc environment resources",{"type":49,"tag":58,"props":9250,"children":9251},{},[9252],{"type":55,"value":9253},"Now that we have defined a shared set of infrastructure that our ad hoc environments will use, let's have a look at the resources that will be specific to ad hoc environments that will be added on top of the shared resources.",{"type":49,"tag":430,"props":9255,"children":9256},{"id":2877},[9257],{"type":55,"value":2880},{"type":49,"tag":58,"props":9259,"children":9260},{},[9261],{"type":55,"value":9262},"The ECS Cluster is a simple grouping of ECS tasks and services.",{"type":49,"tag":430,"props":9264,"children":9266},{"id":9265},"ecs-tasks-and-services",[9267],{"type":55,"value":9268},"ECS Tasks and Services",{"type":49,"tag":58,"props":9270,"children":9271},{},[9272],{"type":55,"value":9273},"Each environment will have a set of ECS tasks and services that will be used to run the application.",{"type":49,"tag":58,"props":9275,"children":9276},{},[9277],{"type":55,"value":9278},"There are four important ECS services in our application that are used to run \"long-running\" ECS tasks. Long-running tasks are tasks that start processes that run indefinitely, rather than running until completion. The long-running tasks in our application include:",{"type":49,"tag":64,"props":9280,"children":9281},{},[9282,9287,9292,9297,9302],{"type":49,"tag":68,"props":9283,"children":9284},{},[9285],{"type":55,"value":9286},"backend web application (gunciron web server)",{"type":49,"tag":68,"props":9288,"children":9289},{},[9290],{"type":55,"value":9291},"backend celery worker",{"type":49,"tag":68,"props":9293,"children":9294},{},[9295],{"type":55,"value":9296},"backend celery beat",{"type":49,"tag":68,"props":9298,"children":9299},{},[9300],{"type":55,"value":9301},"frontend web site (nginx web server)",{"type":49,"tag":68,"props":9303,"children":9304},{},[9305],{"type":55,"value":3151},{"type":49,"tag":58,"props":9307,"children":9308},{},[9309],{"type":55,"value":9310},"The infrastructure code also defines some tasks that are not long-running but rather short lived tasks that run until completion and do not start again. These tasks include:",{"type":49,"tag":64,"props":9312,"children":9313},{},[9314,9318,9323],{"type":49,"tag":68,"props":9315,"children":9316},{},[9317],{"type":55,"value":3316},{"type":49,"tag":68,"props":9319,"children":9320},{},[9321],{"type":55,"value":9322},"database migrations",{"type":49,"tag":68,"props":9324,"children":9325},{},[9326],{"type":55,"value":9327},"any other ad-hoc task that we want to run, usually wrapped in a Django management command",{"type":49,"tag":50,"props":9329,"children":9331},{"id":9330},"how-to-setup-an-ad-hoc-environment",[9332],{"type":55,"value":9333},"How to setup an ad hoc environment",{"type":49,"tag":58,"props":9335,"children":9336},{},[9337],{"type":55,"value":9338},"Now that we have been over the resources that will be created to support our ad hoc environments, let's talk about how we can enable individuals on our team to create and update ad hoc environments.",{"type":49,"tag":430,"props":9340,"children":9342},{"id":9341},"design-decisions",[9343],{"type":55,"value":9344},"Design decisions",{"type":49,"tag":58,"props":9346,"children":9347},{},[9348,9350,9356,9358,9363,9364,9369,9371,9376,9378,9383],{"type":55,"value":9349},"The devops team will decide on the interface that will be used for creating an ad hoc environment. Since we are using Terraform, this interface will be a Terraform configuration. The minimum amount of information that our ad hoc environment configuration needs is image tags for the frontend and backend images to use. Other configurations will be provided by default values set in ",{"type":49,"tag":326,"props":9351,"children":9353},{"className":9352},[],[9354],{"type":55,"value":9355},"variables.tf",{"type":55,"value":9357},", and these defaults can easily be overridden by passing values to ",{"type":49,"tag":326,"props":9359,"children":9361},{"className":9360},[],[9362],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9365,"children":9367},{"className":9366},[],[9368],{"type":55,"value":559},{"type":55,"value":9370},". I'm choosing to use ",{"type":49,"tag":326,"props":9372,"children":9374},{"className":9373},[],[9375],{"type":55,"value":8809},{"type":55,"value":9377}," as the way to pass configuration values to our ad hoc environments where ",{"type":49,"tag":326,"props":9379,"children":9381},{"className":9380},[],[9382],{"type":55,"value":8839},{"type":55,"value":9384}," is the name of the ad hoc environment being created. This will give us the following benefits:",{"type":49,"tag":64,"props":9386,"children":9387},{},[9388,9400],{"type":49,"tag":68,"props":9389,"children":9390},{},[9391,9393,9398],{"type":55,"value":9392},"all ad hoc environments will be visible to the entire team in git since each ad hoc environment will have a ",{"type":49,"tag":326,"props":9394,"children":9396},{"className":9395},[],[9397],{"type":55,"value":8809},{"type":55,"value":9399}," file associated with it",{"type":49,"tag":68,"props":9401,"children":9402},{},[9403,9405],{"type":55,"value":9404},"adding additional customization to an ad hoc environment does not add additional complexity to our automation pipeline since all customization is added through a single file that will be referenced by ",{"type":49,"tag":326,"props":9406,"children":9408},{"className":9407},[],[9409],{"type":55,"value":9410},"$WORKSPACE.tfvars",{"type":49,"tag":58,"props":9412,"children":9413},{},[9414],{"type":55,"value":9415},"The downsides of this approach are:",{"type":49,"tag":64,"props":9417,"children":9418},{},[9419,9424],{"type":49,"tag":68,"props":9420,"children":9421},{},[9422],{"type":55,"value":9423},"creating ad hoc environments requires knowledge of git, so non-technical product team members might need help from the engineering team when setting up an ad hoc environment",{"type":49,"tag":68,"props":9425,"children":9426},{},[9427,9429,9434],{"type":55,"value":9428},"there is an additional \"manual\" step of creating a ",{"type":49,"tag":326,"props":9430,"children":9432},{"className":9431},[],[9433],{"type":55,"value":8809},{"type":55,"value":9435}," file that must be done before running a pipeline to create an ad hoc environment",{"type":49,"tag":58,"props":9437,"children":9438},{},[9439,9441,9446,9448,9453,9455,9460],{"type":55,"value":9440},"Provided that a ",{"type":49,"tag":326,"props":9442,"children":9444},{"className":9443},[],[9445],{"type":55,"value":8809},{"type":55,"value":9447}," file has been created and pushed to the repo, creating or updating an ad hoc environment will be as simple as running a pipeline in GitHub Actions that specifies the ",{"type":49,"tag":326,"props":9449,"children":9451},{"className":9450},[],[9452],{"type":55,"value":8839},{"type":55,"value":9454}," of our ad hoc environment. If no such ",{"type":49,"tag":326,"props":9456,"children":9458},{"className":9457},[],[9459],{"type":55,"value":8809},{"type":55,"value":9461}," file exists, our pipeline will fail.",{"type":49,"tag":430,"props":9463,"children":9465},{"id":9464},"github-action",[9466],{"type":55,"value":9467},"GitHub Action",{"type":49,"tag":58,"props":9469,"children":9470},{},[9471,9473,9479],{"type":55,"value":9472},"Creating ad hoc environments will involve manually triggering a GitHub Action that runs on ",{"type":49,"tag":326,"props":9474,"children":9476},{"className":9475},[],[9477],{"type":55,"value":9478},"workflow_dispatch",{"type":55,"value":6694},{"type":49,"tag":1050,"props":9481,"children":9483},{"code":9482},"on:\n  workflow_dispatch:\n    inputs:\n      workspace:\n        description: 'Name of terraform workspace to use'\n        required: true\n        default: 'dev'\n        type: string\n",[9484],{"type":49,"tag":326,"props":9485,"children":9486},{"__ignoreMap":8},[9487],{"type":55,"value":9482},{"type":49,"tag":58,"props":9489,"children":9490},{},[9491,9493,9498],{"type":55,"value":9492},"We only have to enter the name of the ad hoc environment we want to create or update. The ad hoc environment name is used as the Terraform workspace name. This name is also the name of the ",{"type":49,"tag":326,"props":9494,"children":9496},{"className":9495},[],[9497],{"type":55,"value":8809},{"type":55,"value":9499}," file that must be created per environment.",{"type":49,"tag":58,"props":9501,"children":9502},{},[9503,9505,9510,9511,9516,9517,9522,9524,9529,9531,9537],{"type":55,"value":9504},"This workflow will do ",{"type":49,"tag":326,"props":9506,"children":9508},{"className":9507},[],[9509],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9512,"children":9514},{"className":9513},[],[9515],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9518,"children":9520},{"className":9519},[],[9521],{"type":55,"value":559},{"type":55,"value":9523}," using the ",{"type":49,"tag":326,"props":9525,"children":9527},{"className":9526},[],[9528],{"type":55,"value":8809},{"type":55,"value":9530}," file. When everything has been created, we will use the AWS CLI to prepare the environment so that it can be used. We will use the ",{"type":49,"tag":326,"props":9532,"children":9534},{"className":9533},[],[9535],{"type":55,"value":9536},"aws ecs run-task",{"type":55,"value":9538}," command to run database migrations needed so that the application code can make database queries.",{"type":49,"tag":50,"props":9540,"children":9542},{"id":9541},"how-to-update-code-in-an-existing-ad-hoc-environment",[9543],{"type":55,"value":9544},"How to update code in an existing ad hoc environment",{"type":49,"tag":58,"props":9546,"children":9547},{},[9548,9550,9555,9557,9563,9565,9571,9573,9579,9581,9587],{"type":55,"value":9549},"Assuming that we have deployed an ad hoc environment called ",{"type":49,"tag":326,"props":9551,"children":9553},{"className":9552},[],[9554],{"type":55,"value":8817},{"type":55,"value":9556}," with version ",{"type":49,"tag":326,"props":9558,"children":9560},{"className":9559},[],[9561],{"type":55,"value":9562},"v1.0.0",{"type":55,"value":9564}," of the backend application and ",{"type":49,"tag":326,"props":9566,"children":9568},{"className":9567},[],[9569],{"type":55,"value":9570},"v2.0.0",{"type":55,"value":9572}," of the frontend application, let's think about the process of updating the application to ",{"type":49,"tag":326,"props":9574,"children":9576},{"className":9575},[],[9577],{"type":55,"value":9578},"v1.1.0",{"type":55,"value":9580}," of the backend and ",{"type":49,"tag":326,"props":9582,"children":9584},{"className":9583},[],[9585],{"type":55,"value":9586},"v2.1.0",{"type":55,"value":9588}," of the frontend.",{"type":49,"tag":58,"props":9590,"children":9591},{},[9592,9594,9600],{"type":55,"value":9593},"The simplest approach to updating the application would be edit the ",{"type":49,"tag":326,"props":9595,"children":9597},{"className":9596},[],[9598],{"type":55,"value":9599},"brian.tfvars",{"type":55,"value":9601}," file with the new versions:",{"type":49,"tag":1050,"props":9603,"children":9605},{"code":9604},"# brian.tfvars\nbe_image_tag = \"v1.1.0\"\nfe_image_tag = \"v2.1.0\"\n",[9606],{"type":49,"tag":326,"props":9607,"children":9608},{"__ignoreMap":8},[9609],{"type":55,"value":9604},{"type":49,"tag":58,"props":9611,"children":9612},{},[9613,9615,9620,9621,9626,9627,9632,9634,9639,9641,9648],{"type":55,"value":9614},"If we run the same pipeline that we initially used to deploy ad hoc environment (with ",{"type":49,"tag":326,"props":9616,"children":9618},{"className":9617},[],[9619],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9622,"children":9624},{"className":9623},[],[9625],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9628,"children":9630},{"className":9629},[],[9631],{"type":55,"value":559},{"type":55,"value":9633},") against the updated ",{"type":49,"tag":326,"props":9635,"children":9637},{"className":9636},[],[9638],{"type":55,"value":9599},{"type":55,"value":9640}," file, this will result in a rolling update of the frontend and backend services (",{"type":49,"tag":80,"props":9642,"children":9645},{"href":9643,"rel":9644},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html",[84],[9646],{"type":55,"value":9647},"more on rolling updates here",{"type":55,"value":3213},{"type":49,"tag":58,"props":9650,"children":9651},{},[9652,9654,9659,9661,9667],{"type":55,"value":9653},"If there are database migrations included in the new version of the code that is going out, we need to run database migrations after the ",{"type":49,"tag":326,"props":9655,"children":9657},{"className":9656},[],[9658],{"type":55,"value":559},{"type":55,"value":9660}," completes. We use a top level output from the ad hov environment terraform configuration that is a ",{"type":49,"tag":326,"props":9662,"children":9664},{"className":9663},[],[9665],{"type":55,"value":9666},"run-task",{"type":55,"value":9668}," command with all appropriate arguments that will run database migrations when called from GitHub Actions.",{"type":49,"tag":430,"props":9670,"children":9672},{"id":9671},"order-of-operations",[9673],{"type":55,"value":9674},"Order of Operations",{"type":49,"tag":58,"props":9676,"children":9677},{},[9678,9680,9685],{"type":55,"value":9679},"For ad hoc environments, it is probably fine to update the services and then run the database migrations. Ad hoc environments may only have a single \"user\" -- the developer, so ",{"type":49,"tag":72,"props":9681,"children":9682},{},[9683],{"type":55,"value":9684},"we don't need to worry about any errors that may occur if requests are made against the new version of code before database migrations have been applied",{"type":55,"value":745},{"type":49,"tag":58,"props":9687,"children":9688},{},[9689,9691,9697,9699,9705],{"type":55,"value":9690},"Let's consider a simple example to illustrate what can go wrong here. If we add a ",{"type":49,"tag":326,"props":9692,"children":9694},{"className":9693},[],[9695],{"type":55,"value":9696},"total_views",{"type":55,"value":9698}," to our blog post model to track the total number of page views a post has, we would add a field to the model, generate migration file with ",{"type":49,"tag":326,"props":9700,"children":9702},{"className":9701},[],[9703],{"type":55,"value":9704},"makemigrations",{"type":55,"value":9706},", and then update our views and model serializers to make use of this new field. In the time between updating our service and running the database migrations, any requests to endpoints that access the new database field will fail since the table does not yet exist.",{"type":49,"tag":58,"props":9708,"children":9709},{},[9710,9712,9717],{"type":55,"value":9711},"If we first run database migrations ",{"type":49,"tag":72,"props":9713,"children":9714},{},[9715],{"type":55,"value":9716},"and then",{"type":55,"value":9718}," update application code (ECS services), then we can avoid errors about fields not existing. In our production application, we want to aim for fewer errors, so we should be using this \"order of operations\": first run new database migrations and then update application code.",{"type":49,"tag":430,"props":9720,"children":9722},{"id":9721},"github-action-for-application-updates",[9723],{"type":55,"value":9724},"GitHub Action for application updates",{"type":49,"tag":58,"props":9726,"children":9727},{},[9728],{"type":55,"value":9729},"We need a GitHub Action that can do the following:",{"type":49,"tag":64,"props":9731,"children":9732},{},[9733,9745,9757,9769,9780,9792,9804],{"type":49,"tag":68,"props":9734,"children":9735},{},[9736,9738,9744],{"type":55,"value":9737},"fetch the current container definition JSON files for each backend tasks (",{"type":49,"tag":326,"props":9739,"children":9741},{"className":9740},[],[9742],{"type":55,"value":9743},"aws ecs describe-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9746,"children":9747},{},[9748,9750,9756],{"type":55,"value":9749},"write new container definitions JSON with the new backend image tag (using ",{"type":49,"tag":326,"props":9751,"children":9753},{"className":9752},[],[9754],{"type":55,"value":9755},"jq",{"type":55,"value":616},{"type":49,"tag":68,"props":9758,"children":9759},{},[9760,9762,9768],{"type":55,"value":9761},"register new task definitions with the new container definition JSON files for each task (",{"type":49,"tag":326,"props":9763,"children":9765},{"className":9764},[],[9766],{"type":55,"value":9767},"aws ecs register-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9770,"children":9771},{},[9772,9774,9779],{"type":55,"value":9773},"call run-task with the newly updated migration ECS task (",{"type":49,"tag":326,"props":9775,"children":9777},{"className":9776},[],[9778],{"type":55,"value":9536},{"type":55,"value":616},{"type":49,"tag":68,"props":9781,"children":9782},{},[9783,9785,9791],{"type":55,"value":9784},"wait for the task to exit and display the logs (",{"type":49,"tag":326,"props":9786,"children":9788},{"className":9787},[],[9789],{"type":55,"value":9790},"aws ecs wait tasks-stopped",{"type":55,"value":616},{"type":49,"tag":68,"props":9793,"children":9794},{},[9795,9797,9803],{"type":55,"value":9796},"update the backend services (gunicorn, celery, celery beat) (",{"type":49,"tag":326,"props":9798,"children":9800},{"className":9799},[],[9801],{"type":55,"value":9802},"aws ecs update-service",{"type":55,"value":616},{"type":49,"tag":68,"props":9805,"children":9806},{},[9807,9809,9815],{"type":55,"value":9808},"wait for the new backend services to be stable (",{"type":49,"tag":326,"props":9810,"children":9812},{"className":9811},[],[9813],{"type":55,"value":9814},"aws ecs wait services-stable",{"type":55,"value":616},{"type":49,"tag":58,"props":9817,"children":9818},{},[9819],{"type":55,"value":9820},"Here's a visual representation of the backend update process:",{"type":49,"tag":58,"props":9822,"children":9823},{},[9824],{"type":49,"tag":1601,"props":9825,"children":9827},{"alt":8926,"src":9826},"/static/adhoc/ad_hoc.backend_update.drawio.png",[],{"type":49,"tag":58,"props":9829,"children":9830},{},[9831],{"type":55,"value":9832},"In order have the correct arguments for all of the AWS CLI calls used in the above workflow, we can use the AWS CLI to fetch resource names by tag.",{"type":49,"tag":58,"props":9834,"children":9835},{},[9836],{"type":55,"value":9837},"Here is what I'm using for the script. There lots of comments, so please refer to those comments for an explanation of what the script is doing.",{"type":49,"tag":1050,"props":9839,"children":9841},{"code":9840,"language":2728,"meta":8,"className":2729,"style":8},"#!/bin/bash\n\n# This script will be called to update an ad hoc environment backend\n# with a new image tag. It will first run pre-update tasks (such as migrations)\n# and then do a rolling update of the backend services.\n\n# It is called from the ad_hock_backend_update.yml GitHub Actions file\n\n# Required environment variables that need to be exported before running this script:\n\n# WORKSPACE - ad hoc environment workspace\n# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n\necho \"Updating backend services...\"\n\n# first define a variable containing the new image URI\nNEW_BACKEND_IMAGE_URI=\"$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/backend:$BACKEND_IMAGE_TAG\"\n\n\n# register new task definitions\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\nfor TASK in \"migrate\" \"gunicorn\" \"default\" \"beat\"\ndo\n  echo \"Updating $TASK task definition...\"\n\n  # in Terraform we name our tasks based on the ad hoc environment name\n  # (also the Terraform workspace name) and the name of the task\n  # (e.g. migrate, gunicorn, default, beat)\n  TASK_FAMILY=$WORKSPACE-$TASK\n\n  # save the task definition JSON to a variable\n  TASK_DESCRIPTION=$(aws ecs describe-task-definition \\\n    --task-definition $TASK_FAMILY \\\n  )\n\n  # save container definitions to a file for each task\n  echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.containerDefinitions \\\n    > /tmp/$TASK_FAMILY.json\n\n  # write new container definition JSON with updated image\n  echo \"Writing new $TASK_FAMILY container definitions JSON...\"\n\n  # replace old image URI with new image URI in a new container definitions JSON\n  cat /tmp/$TASK_FAMILY.json \\\n    | jq \\\n    --arg IMAGE \"$NEW_BACKEND_IMAGE_URI\" '.[0].image |= $IMAGE' \\\n    > /tmp/$TASK_FAMILY-new.json\n\n  # Get the existing configuration for the task definition (memory, cpu, etc.)\n  # from the variable that we saved the task definition JSON to earlier\n  echo \"Getting existing configuration for $TASK_FAMILY...\"\n\n  MEMORY=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.memory \\\n  )\n\n  CPU=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.cpu \\\n  )\n\n  ECS_EXECUTION_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.executionRoleArn \\\n  )\n\n  ECS_TASK_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.taskRoleArn \\\n  )\n\n  # check the content of the new container definition JSON\n  cat /tmp/$TASK_FAMILY-new.json\n\n  # register new task definition using the new container definitions\n  # and the values that we read off of the existing task definitions\n  echo \"Registering new $TASK_FAMILY task definition...\"\n\n  aws ecs register-task-definition \\\n    --family $TASK_FAMILY \\\n    --container-definitions file:///tmp/$TASK_FAMILY-new.json \\\n    --memory $MEMORY \\\n    --cpu $CPU \\\n    --network-mode awsvpc \\\n    --execution-role-arn $ECS_EXECUTION_ROLE_ARN \\\n    --task-role-arn $ECS_TASK_ROLE_ARN \\\n    --requires-compatibilities \"FARGATE\"\n\ndone\n\n# Now we need to run migrate, collectstatic and any other commands that need to be run\n# before doing a rolling update of the backend services\n\n# We will use the new task definitions we just created to run these commands\n\n# get the ARN of the most recent revision of the migrate task definition\nTASK_DEFINITION=$( \\\n  aws ecs describe-task-definition \\\n    --task-definition $WORKSPACE-migrate \\\n    | jq -r \\\n    .taskDefinition.taskDefinitionArn \\\n)\n\n# get private subnets as space separated string from shared resources VPC\nSUBNETS=$( \\\n  aws ec2 describe-subnets \\\n    --filters \"Name=tag:env,Values=$SHARED_RESOURCES_WORKSPACE\" \"Name=tag:Name,Values=*private*\" \\\n    --query 'Subnets[*].SubnetId' \\\n    --output text \\\n)\n\n# replace spaces with commas using tr\nSUBNET_IDS=$(echo $SUBNETS | tr ' ' ',')\n\n# https://github.com/aws/aws-cli/issues/5348\n# get ecs_sg_id - just a single value\nECS_SG_ID=$( \\\n  aws ec2 describe-security-groups \\\n    --filters \"Name=tag:Name,Values=$SHARED_RESOURCES_WORKSPACE-ecs-sg\" \\\n    --query 'SecurityGroups[*].GroupId' \\\n    --output text \\\n)\n\necho \"Running database migrations...\"\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nSTART_TIME=$(date +%s000)\n\n# run the migration task and capture the taskArn into a variable called TASK_ID\nTASK_ID=$( \\\n  aws ecs run-task \\\n    --cluster $WORKSPACE-cluster \\\n    --task-definition $TASK_DEFINITION \\\n    --network-configuration \"awsvpcConfiguration={subnets=[$SUBNET_IDS],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}\" \\\n    | jq -r '.tasks[0].taskArn' \\\n  )\n\necho \"Task ID is $TASK_ID\"\n\n# wait for the migrate task to exit\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n# > It will poll every 6 seconds until a successful state has been reached.\n# > This will exit with a return code of 255 after 100 failed checks.\naws ecs wait tasks-stopped \\\n  --tasks $TASK_ID \\\n  --cluster $WORKSPACE-cluster\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nEND_TIME=$(date +%s000)\n\n# print the CloudWatch log events to STDOUT\naws logs get-log-events \\\n  --log-group-name \"/ecs/$WORKSPACE/migrate\" \\\n  --log-stream-name \"migrate/migrate/${TASK_ID##*/}\" \\\n  --start-time $START_TIME \\\n  --end-time $END_TIME \\\n  | jq -r '.events[].message'\n\necho \"Migrations complete. Starting rolling update for backend services...\"\n\n# update backend services\nfor TASK in \"gunicorn\" \"default\" \"beat\"\ndo\n\n  # get taskDefinitionArn for each service to be used in update-service command\n  # this will get the most recent revision of each task (the one that was just created)\n  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n  TASK_DEFINITION=$( \\\n    aws ecs describe-task-definition \\\n      --task-definition $WORKSPACE-$TASK \\\n      | jq -r \\\n      .taskDefinition.taskDefinitionArn \\\n  )\n\n  # update each service with new task definintion\n  aws ecs update-service \\\n    --cluster $WORKSPACE-cluster \\\n    --service $WORKSPACE-$TASK \\\n    --task-definition $TASK_DEFINITION \\\n    --no-cli-pager\n\ndone\n\necho \"Services updated. Waiting for services to become stable...\"\n\n# wait for all service to be stable (runningCount == desiredCount for each service)\naws ecs wait services-stable \\\n  --cluster $WORKSPACE-cluster \\\n  --services $WORKSPACE-gunicorn $WORKSPACE-default $WORKSPACE-beat\n\necho \"Services are now stable. Backend services are now up to date with $BACKEND_IMAGE_TAG.\"\n\necho \"Backend update is now complete!\"\n",[9842],{"type":49,"tag":326,"props":9843,"children":9844},{"__ignoreMap":8},[9845,9853,9860,9868,9876,9884,9891,9899,9906,9914,9921,9929,9937,9945,9953,9960,9974,9981,9989,10026,10033,10040,10048,10056,10094,10102,10125,10132,10140,10149,10158,10186,10194,10203,10240,10259,10268,10276,10285,10317,10330,10354,10362,10371,10393,10401,10410,10436,10453,10490,10511,10519,10528,10537,10559,10567,10609,10622,10630,10638,10679,10692,10700,10708,10749,10762,10770,10778,10819,10832,10840,10848,10857,10877,10885,10894,10903,10924,10932,10954,10971,10998,11016,11034,11052,11070,11088,11102,11110,11119,11127,11136,11145,11153,11162,11170,11179,11200,11220,11242,11262,11275,11283,11291,11300,11321,11343,11375,11393,11411,11419,11427,11436,11485,11493,11502,11511,11532,11553,11579,11596,11612,11620,11628,11641,11649,11658,11689,11697,11706,11727,11748,11770,11787,11824,11849,11857,11865,11887,11895,11904,11913,11922,11931,11957,11975,11993,12001,12009,12038,12046,12055,12077,12104,12136,12154,12172,12194,12202,12215,12223,12232,12260,12268,12276,12285,12294,12303,12324,12345,12371,12392,12405,12413,12421,12430,12451,12471,12496,12512,12521,12529,12537,12545,12558,12566,12575,12600,12620,12656,12664,12686,12694],{"type":49,"tag":1060,"props":9846,"children":9847},{"class":1062,"line":1063},[9848],{"type":49,"tag":1060,"props":9849,"children":9850},{"style":3039},[9851],{"type":55,"value":9852},"#!/bin/bash\n",{"type":49,"tag":1060,"props":9854,"children":9855},{"class":1062,"line":1079},[9856],{"type":49,"tag":1060,"props":9857,"children":9858},{"emptyLinePlaceholder":44},[9859],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9861,"children":9862},{"class":1062,"line":1088},[9863],{"type":49,"tag":1060,"props":9864,"children":9865},{"style":3039},[9866],{"type":55,"value":9867},"# This script will be called to update an ad hoc environment backend\n",{"type":49,"tag":1060,"props":9869,"children":9870},{"class":1062,"line":1097},[9871],{"type":49,"tag":1060,"props":9872,"children":9873},{"style":3039},[9874],{"type":55,"value":9875},"# with a new image tag. It will first run pre-update tasks (such as migrations)\n",{"type":49,"tag":1060,"props":9877,"children":9878},{"class":1062,"line":1111},[9879],{"type":49,"tag":1060,"props":9880,"children":9881},{"style":3039},[9882],{"type":55,"value":9883},"# and then do a rolling update of the backend services.\n",{"type":49,"tag":1060,"props":9885,"children":9886},{"class":1062,"line":1120},[9887],{"type":49,"tag":1060,"props":9888,"children":9889},{"emptyLinePlaceholder":44},[9890],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9892,"children":9893},{"class":1062,"line":1128},[9894],{"type":49,"tag":1060,"props":9895,"children":9896},{"style":3039},[9897],{"type":55,"value":9898},"# It is called from the ad_hock_backend_update.yml GitHub Actions file\n",{"type":49,"tag":1060,"props":9900,"children":9901},{"class":1062,"line":1141},[9902],{"type":49,"tag":1060,"props":9903,"children":9904},{"emptyLinePlaceholder":44},[9905],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9907,"children":9908},{"class":1062,"line":1150},[9909],{"type":49,"tag":1060,"props":9910,"children":9911},{"style":3039},[9912],{"type":55,"value":9913},"# Required environment variables that need to be exported before running this script:\n",{"type":49,"tag":1060,"props":9915,"children":9916},{"class":1062,"line":1158},[9917],{"type":49,"tag":1060,"props":9918,"children":9919},{"emptyLinePlaceholder":44},[9920],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9922,"children":9923},{"class":1062,"line":1171},[9924],{"type":49,"tag":1060,"props":9925,"children":9926},{"style":3039},[9927],{"type":55,"value":9928},"# WORKSPACE - ad hoc environment workspace\n",{"type":49,"tag":1060,"props":9930,"children":9931},{"class":1062,"line":1180},[9932],{"type":49,"tag":1060,"props":9933,"children":9934},{"style":3039},[9935],{"type":55,"value":9936},"# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n",{"type":49,"tag":1060,"props":9938,"children":9939},{"class":1062,"line":1188},[9940],{"type":49,"tag":1060,"props":9941,"children":9942},{"style":3039},[9943],{"type":55,"value":9944},"# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n",{"type":49,"tag":1060,"props":9946,"children":9947},{"class":1062,"line":1201},[9948],{"type":49,"tag":1060,"props":9949,"children":9950},{"style":3039},[9951],{"type":55,"value":9952},"# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n",{"type":49,"tag":1060,"props":9954,"children":9955},{"class":1062,"line":1210},[9956],{"type":49,"tag":1060,"props":9957,"children":9958},{"emptyLinePlaceholder":44},[9959],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9961,"children":9962},{"class":1062,"line":1218},[9963,9969],{"type":49,"tag":1060,"props":9964,"children":9966},{"style":9965},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[9967],{"type":55,"value":9968},"echo",{"type":49,"tag":1060,"props":9970,"children":9971},{"style":2215},[9972],{"type":55,"value":9973}," \"Updating backend services...\"\n",{"type":49,"tag":1060,"props":9975,"children":9976},{"class":1062,"line":1232},[9977],{"type":49,"tag":1060,"props":9978,"children":9979},{"emptyLinePlaceholder":44},[9980],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9982,"children":9983},{"class":1062,"line":1241},[9984],{"type":49,"tag":1060,"props":9985,"children":9986},{"style":3039},[9987],{"type":55,"value":9988},"# first define a variable containing the new image URI\n",{"type":49,"tag":1060,"props":9990,"children":9991},{"class":1062,"line":1249},[9992,9997,10001,10006,10011,10016,10021],{"type":49,"tag":1060,"props":9993,"children":9994},{"style":1073},[9995],{"type":55,"value":9996},"NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":9998,"children":9999},{"style":2194},[10000],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10002,"children":10003},{"style":2215},[10004],{"type":55,"value":10005},"\"",{"type":49,"tag":1060,"props":10007,"children":10008},{"style":1073},[10009],{"type":55,"value":10010},"$AWS_ACCOUNT_ID",{"type":49,"tag":1060,"props":10012,"children":10013},{"style":2215},[10014],{"type":55,"value":10015},".dkr.ecr.us-east-1.amazonaws.com/backend:",{"type":49,"tag":1060,"props":10017,"children":10018},{"style":1073},[10019],{"type":55,"value":10020},"$BACKEND_IMAGE_TAG",{"type":49,"tag":1060,"props":10022,"children":10023},{"style":2215},[10024],{"type":55,"value":10025},"\"\n",{"type":49,"tag":1060,"props":10027,"children":10028},{"class":1062,"line":1262},[10029],{"type":49,"tag":1060,"props":10030,"children":10031},{"emptyLinePlaceholder":44},[10032],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10034,"children":10035},{"class":1062,"line":4581},[10036],{"type":49,"tag":1060,"props":10037,"children":10038},{"emptyLinePlaceholder":44},[10039],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10041,"children":10042},{"class":1062,"line":4631},[10043],{"type":49,"tag":1060,"props":10044,"children":10045},{"style":3039},[10046],{"type":55,"value":10047},"# register new task definitions\n",{"type":49,"tag":1060,"props":10049,"children":10050},{"class":1062,"line":4682},[10051],{"type":49,"tag":1060,"props":10052,"children":10053},{"style":3039},[10054],{"type":55,"value":10055},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":10057,"children":10058},{"class":1062,"line":4709},[10059,10064,10069,10074,10079,10084,10089],{"type":49,"tag":1060,"props":10060,"children":10061},{"style":2194},[10062],{"type":55,"value":10063},"for",{"type":49,"tag":1060,"props":10065,"children":10066},{"style":1073},[10067],{"type":55,"value":10068}," TASK ",{"type":49,"tag":1060,"props":10070,"children":10071},{"style":2194},[10072],{"type":55,"value":10073},"in",{"type":49,"tag":1060,"props":10075,"children":10076},{"style":2215},[10077],{"type":55,"value":10078}," \"migrate\"",{"type":49,"tag":1060,"props":10080,"children":10081},{"style":2215},[10082],{"type":55,"value":10083}," \"gunicorn\"",{"type":49,"tag":1060,"props":10085,"children":10086},{"style":2215},[10087],{"type":55,"value":10088}," \"default\"",{"type":49,"tag":1060,"props":10090,"children":10091},{"style":2215},[10092],{"type":55,"value":10093}," \"beat\"\n",{"type":49,"tag":1060,"props":10095,"children":10096},{"class":1062,"line":5979},[10097],{"type":49,"tag":1060,"props":10098,"children":10099},{"style":2194},[10100],{"type":55,"value":10101},"do\n",{"type":49,"tag":1060,"props":10103,"children":10104},{"class":1062,"line":5988},[10105,10110,10115,10120],{"type":49,"tag":1060,"props":10106,"children":10107},{"style":9965},[10108],{"type":55,"value":10109},"  echo",{"type":49,"tag":1060,"props":10111,"children":10112},{"style":2215},[10113],{"type":55,"value":10114}," \"Updating ",{"type":49,"tag":1060,"props":10116,"children":10117},{"style":1073},[10118],{"type":55,"value":10119},"$TASK",{"type":49,"tag":1060,"props":10121,"children":10122},{"style":2215},[10123],{"type":55,"value":10124}," task definition...\"\n",{"type":49,"tag":1060,"props":10126,"children":10127},{"class":1062,"line":5997},[10128],{"type":49,"tag":1060,"props":10129,"children":10130},{"emptyLinePlaceholder":44},[10131],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10133,"children":10134},{"class":1062,"line":6006},[10135],{"type":49,"tag":1060,"props":10136,"children":10137},{"style":3039},[10138],{"type":55,"value":10139},"  # in Terraform we name our tasks based on the ad hoc environment name\n",{"type":49,"tag":1060,"props":10141,"children":10143},{"class":1062,"line":10142},29,[10144],{"type":49,"tag":1060,"props":10145,"children":10146},{"style":3039},[10147],{"type":55,"value":10148},"  # (also the Terraform workspace name) and the name of the task\n",{"type":49,"tag":1060,"props":10150,"children":10152},{"class":1062,"line":10151},30,[10153],{"type":49,"tag":1060,"props":10154,"children":10155},{"style":3039},[10156],{"type":55,"value":10157},"  # (e.g. migrate, gunicorn, default, beat)\n",{"type":49,"tag":1060,"props":10159,"children":10161},{"class":1062,"line":10160},31,[10162,10167,10171,10176,10181],{"type":49,"tag":1060,"props":10163,"children":10164},{"style":1073},[10165],{"type":55,"value":10166},"  TASK_FAMILY",{"type":49,"tag":1060,"props":10168,"children":10169},{"style":2194},[10170],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10172,"children":10173},{"style":1073},[10174],{"type":55,"value":10175},"$WORKSPACE",{"type":49,"tag":1060,"props":10177,"children":10178},{"style":2215},[10179],{"type":55,"value":10180},"-",{"type":49,"tag":1060,"props":10182,"children":10183},{"style":1073},[10184],{"type":55,"value":10185},"$TASK\n",{"type":49,"tag":1060,"props":10187,"children":10189},{"class":1062,"line":10188},32,[10190],{"type":49,"tag":1060,"props":10191,"children":10192},{"emptyLinePlaceholder":44},[10193],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10195,"children":10197},{"class":1062,"line":10196},33,[10198],{"type":49,"tag":1060,"props":10199,"children":10200},{"style":3039},[10201],{"type":55,"value":10202},"  # save the task definition JSON to a variable\n",{"type":49,"tag":1060,"props":10204,"children":10206},{"class":1062,"line":10205},34,[10207,10212,10216,10221,10225,10230,10235],{"type":49,"tag":1060,"props":10208,"children":10209},{"style":1073},[10210],{"type":55,"value":10211},"  TASK_DESCRIPTION",{"type":49,"tag":1060,"props":10213,"children":10214},{"style":2194},[10215],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10217,"children":10218},{"style":1073},[10219],{"type":55,"value":10220},"$(",{"type":49,"tag":1060,"props":10222,"children":10223},{"style":1067},[10224],{"type":55,"value":20},{"type":49,"tag":1060,"props":10226,"children":10227},{"style":2215},[10228],{"type":55,"value":10229}," ecs",{"type":49,"tag":1060,"props":10231,"children":10232},{"style":2215},[10233],{"type":55,"value":10234}," describe-task-definition",{"type":49,"tag":1060,"props":10236,"children":10237},{"style":2287},[10238],{"type":55,"value":10239}," \\\n",{"type":49,"tag":1060,"props":10241,"children":10243},{"class":1062,"line":10242},35,[10244,10249,10254],{"type":49,"tag":1060,"props":10245,"children":10246},{"style":2287},[10247],{"type":55,"value":10248},"    --task-definition",{"type":49,"tag":1060,"props":10250,"children":10251},{"style":1073},[10252],{"type":55,"value":10253}," $TASK_FAMILY ",{"type":49,"tag":1060,"props":10255,"children":10256},{"style":2287},[10257],{"type":55,"value":10258},"\\\n",{"type":49,"tag":1060,"props":10260,"children":10262},{"class":1062,"line":10261},36,[10263],{"type":49,"tag":1060,"props":10264,"children":10265},{"style":1073},[10266],{"type":55,"value":10267},"  )\n",{"type":49,"tag":1060,"props":10269,"children":10271},{"class":1062,"line":10270},37,[10272],{"type":49,"tag":1060,"props":10273,"children":10274},{"emptyLinePlaceholder":44},[10275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10277,"children":10279},{"class":1062,"line":10278},38,[10280],{"type":49,"tag":1060,"props":10281,"children":10282},{"style":3039},[10283],{"type":55,"value":10284},"  # save container definitions to a file for each task\n",{"type":49,"tag":1060,"props":10286,"children":10288},{"class":1062,"line":10287},39,[10289,10293,10298,10303,10308,10313],{"type":49,"tag":1060,"props":10290,"children":10291},{"style":9965},[10292],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10294,"children":10295},{"style":1073},[10296],{"type":55,"value":10297}," $TASK_DESCRIPTION ",{"type":49,"tag":1060,"props":10299,"children":10300},{"style":2194},[10301],{"type":55,"value":10302},"|",{"type":49,"tag":1060,"props":10304,"children":10305},{"style":1067},[10306],{"type":55,"value":10307}," jq",{"type":49,"tag":1060,"props":10309,"children":10310},{"style":2287},[10311],{"type":55,"value":10312}," -r",{"type":49,"tag":1060,"props":10314,"children":10315},{"style":2287},[10316],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10318,"children":10320},{"class":1062,"line":10319},40,[10321,10326],{"type":49,"tag":1060,"props":10322,"children":10323},{"style":2215},[10324],{"type":55,"value":10325},"    .taskDefinition.containerDefinitions",{"type":49,"tag":1060,"props":10327,"children":10328},{"style":2287},[10329],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10331,"children":10333},{"class":1062,"line":10332},41,[10334,10339,10344,10349],{"type":49,"tag":1060,"props":10335,"children":10336},{"style":2194},[10337],{"type":55,"value":10338},"    >",{"type":49,"tag":1060,"props":10340,"children":10341},{"style":2215},[10342],{"type":55,"value":10343}," /tmp/",{"type":49,"tag":1060,"props":10345,"children":10346},{"style":1073},[10347],{"type":55,"value":10348},"$TASK_FAMILY",{"type":49,"tag":1060,"props":10350,"children":10351},{"style":2215},[10352],{"type":55,"value":10353},".json\n",{"type":49,"tag":1060,"props":10355,"children":10357},{"class":1062,"line":10356},42,[10358],{"type":49,"tag":1060,"props":10359,"children":10360},{"emptyLinePlaceholder":44},[10361],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10363,"children":10365},{"class":1062,"line":10364},43,[10366],{"type":49,"tag":1060,"props":10367,"children":10368},{"style":3039},[10369],{"type":55,"value":10370},"  # write new container definition JSON with updated image\n",{"type":49,"tag":1060,"props":10372,"children":10374},{"class":1062,"line":10373},44,[10375,10379,10384,10388],{"type":49,"tag":1060,"props":10376,"children":10377},{"style":9965},[10378],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10380,"children":10381},{"style":2215},[10382],{"type":55,"value":10383}," \"Writing new ",{"type":49,"tag":1060,"props":10385,"children":10386},{"style":1073},[10387],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10389,"children":10390},{"style":2215},[10391],{"type":55,"value":10392}," container definitions JSON...\"\n",{"type":49,"tag":1060,"props":10394,"children":10396},{"class":1062,"line":10395},45,[10397],{"type":49,"tag":1060,"props":10398,"children":10399},{"emptyLinePlaceholder":44},[10400],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10402,"children":10404},{"class":1062,"line":10403},46,[10405],{"type":49,"tag":1060,"props":10406,"children":10407},{"style":3039},[10408],{"type":55,"value":10409},"  # replace old image URI with new image URI in a new container definitions JSON\n",{"type":49,"tag":1060,"props":10411,"children":10413},{"class":1062,"line":10412},47,[10414,10419,10423,10427,10432],{"type":49,"tag":1060,"props":10415,"children":10416},{"style":1067},[10417],{"type":55,"value":10418},"  cat",{"type":49,"tag":1060,"props":10420,"children":10421},{"style":2215},[10422],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10424,"children":10425},{"style":1073},[10426],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10428,"children":10429},{"style":2215},[10430],{"type":55,"value":10431},".json",{"type":49,"tag":1060,"props":10433,"children":10434},{"style":2287},[10435],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10437,"children":10439},{"class":1062,"line":10438},48,[10440,10445,10449],{"type":49,"tag":1060,"props":10441,"children":10442},{"style":2194},[10443],{"type":55,"value":10444},"    |",{"type":49,"tag":1060,"props":10446,"children":10447},{"style":1067},[10448],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10450,"children":10451},{"style":2287},[10452],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10454,"children":10456},{"class":1062,"line":10455},49,[10457,10462,10467,10472,10477,10481,10486],{"type":49,"tag":1060,"props":10458,"children":10459},{"style":2287},[10460],{"type":55,"value":10461},"    --arg",{"type":49,"tag":1060,"props":10463,"children":10464},{"style":2215},[10465],{"type":55,"value":10466}," IMAGE",{"type":49,"tag":1060,"props":10468,"children":10469},{"style":2215},[10470],{"type":55,"value":10471}," \"",{"type":49,"tag":1060,"props":10473,"children":10474},{"style":1073},[10475],{"type":55,"value":10476},"$NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":10478,"children":10479},{"style":2215},[10480],{"type":55,"value":10005},{"type":49,"tag":1060,"props":10482,"children":10483},{"style":2215},[10484],{"type":55,"value":10485}," '.[0].image |= $IMAGE'",{"type":49,"tag":1060,"props":10487,"children":10488},{"style":2287},[10489],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10491,"children":10493},{"class":1062,"line":10492},50,[10494,10498,10502,10506],{"type":49,"tag":1060,"props":10495,"children":10496},{"style":2194},[10497],{"type":55,"value":10338},{"type":49,"tag":1060,"props":10499,"children":10500},{"style":2215},[10501],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10503,"children":10504},{"style":1073},[10505],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10507,"children":10508},{"style":2215},[10509],{"type":55,"value":10510},"-new.json\n",{"type":49,"tag":1060,"props":10512,"children":10514},{"class":1062,"line":10513},51,[10515],{"type":49,"tag":1060,"props":10516,"children":10517},{"emptyLinePlaceholder":44},[10518],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10520,"children":10522},{"class":1062,"line":10521},52,[10523],{"type":49,"tag":1060,"props":10524,"children":10525},{"style":3039},[10526],{"type":55,"value":10527},"  # Get the existing configuration for the task definition (memory, cpu, etc.)\n",{"type":49,"tag":1060,"props":10529,"children":10531},{"class":1062,"line":10530},53,[10532],{"type":49,"tag":1060,"props":10533,"children":10534},{"style":3039},[10535],{"type":55,"value":10536},"  # from the variable that we saved the task definition JSON to earlier\n",{"type":49,"tag":1060,"props":10538,"children":10540},{"class":1062,"line":10539},54,[10541,10545,10550,10554],{"type":49,"tag":1060,"props":10542,"children":10543},{"style":9965},[10544],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10546,"children":10547},{"style":2215},[10548],{"type":55,"value":10549}," \"Getting existing configuration for ",{"type":49,"tag":1060,"props":10551,"children":10552},{"style":1073},[10553],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10555,"children":10556},{"style":2215},[10557],{"type":55,"value":10558},"...\"\n",{"type":49,"tag":1060,"props":10560,"children":10562},{"class":1062,"line":10561},55,[10563],{"type":49,"tag":1060,"props":10564,"children":10565},{"emptyLinePlaceholder":44},[10566],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10568,"children":10570},{"class":1062,"line":10569},56,[10571,10576,10580,10585,10589,10593,10597,10601,10605],{"type":49,"tag":1060,"props":10572,"children":10573},{"style":1073},[10574],{"type":55,"value":10575},"  MEMORY",{"type":49,"tag":1060,"props":10577,"children":10578},{"style":2194},[10579],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10581,"children":10582},{"style":1073},[10583],{"type":55,"value":10584},"$( ",{"type":49,"tag":1060,"props":10586,"children":10587},{"style":9965},[10588],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10590,"children":10591},{"style":1073},[10592],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10594,"children":10595},{"style":2194},[10596],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10598,"children":10599},{"style":1067},[10600],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10602,"children":10603},{"style":2287},[10604],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10606,"children":10607},{"style":2287},[10608],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10610,"children":10612},{"class":1062,"line":10611},57,[10613,10618],{"type":49,"tag":1060,"props":10614,"children":10615},{"style":2215},[10616],{"type":55,"value":10617},"    .taskDefinition.memory",{"type":49,"tag":1060,"props":10619,"children":10620},{"style":2287},[10621],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10623,"children":10625},{"class":1062,"line":10624},58,[10626],{"type":49,"tag":1060,"props":10627,"children":10628},{"style":1073},[10629],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10631,"children":10633},{"class":1062,"line":10632},59,[10634],{"type":49,"tag":1060,"props":10635,"children":10636},{"emptyLinePlaceholder":44},[10637],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10639,"children":10641},{"class":1062,"line":10640},60,[10642,10647,10651,10655,10659,10663,10667,10671,10675],{"type":49,"tag":1060,"props":10643,"children":10644},{"style":1073},[10645],{"type":55,"value":10646},"  CPU",{"type":49,"tag":1060,"props":10648,"children":10649},{"style":2194},[10650],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10652,"children":10653},{"style":1073},[10654],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10656,"children":10657},{"style":9965},[10658],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10660,"children":10661},{"style":1073},[10662],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10664,"children":10665},{"style":2194},[10666],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10668,"children":10669},{"style":1067},[10670],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10672,"children":10673},{"style":2287},[10674],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10676,"children":10677},{"style":2287},[10678],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10680,"children":10682},{"class":1062,"line":10681},61,[10683,10688],{"type":49,"tag":1060,"props":10684,"children":10685},{"style":2215},[10686],{"type":55,"value":10687},"    .taskDefinition.cpu",{"type":49,"tag":1060,"props":10689,"children":10690},{"style":2287},[10691],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10693,"children":10695},{"class":1062,"line":10694},62,[10696],{"type":49,"tag":1060,"props":10697,"children":10698},{"style":1073},[10699],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10701,"children":10703},{"class":1062,"line":10702},63,[10704],{"type":49,"tag":1060,"props":10705,"children":10706},{"emptyLinePlaceholder":44},[10707],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10709,"children":10711},{"class":1062,"line":10710},64,[10712,10717,10721,10725,10729,10733,10737,10741,10745],{"type":49,"tag":1060,"props":10713,"children":10714},{"style":1073},[10715],{"type":55,"value":10716},"  ECS_EXECUTION_ROLE_ARN",{"type":49,"tag":1060,"props":10718,"children":10719},{"style":2194},[10720],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10722,"children":10723},{"style":1073},[10724],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10726,"children":10727},{"style":9965},[10728],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10730,"children":10731},{"style":1073},[10732],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10734,"children":10735},{"style":2194},[10736],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10738,"children":10739},{"style":1067},[10740],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10742,"children":10743},{"style":2287},[10744],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10746,"children":10747},{"style":2287},[10748],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10750,"children":10752},{"class":1062,"line":10751},65,[10753,10758],{"type":49,"tag":1060,"props":10754,"children":10755},{"style":2215},[10756],{"type":55,"value":10757},"    .taskDefinition.executionRoleArn",{"type":49,"tag":1060,"props":10759,"children":10760},{"style":2287},[10761],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10763,"children":10765},{"class":1062,"line":10764},66,[10766],{"type":49,"tag":1060,"props":10767,"children":10768},{"style":1073},[10769],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10771,"children":10773},{"class":1062,"line":10772},67,[10774],{"type":49,"tag":1060,"props":10775,"children":10776},{"emptyLinePlaceholder":44},[10777],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10779,"children":10781},{"class":1062,"line":10780},68,[10782,10787,10791,10795,10799,10803,10807,10811,10815],{"type":49,"tag":1060,"props":10783,"children":10784},{"style":1073},[10785],{"type":55,"value":10786},"  ECS_TASK_ROLE_ARN",{"type":49,"tag":1060,"props":10788,"children":10789},{"style":2194},[10790],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10792,"children":10793},{"style":1073},[10794],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10796,"children":10797},{"style":9965},[10798],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10800,"children":10801},{"style":1073},[10802],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10804,"children":10805},{"style":2194},[10806],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10808,"children":10809},{"style":1067},[10810],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10812,"children":10813},{"style":2287},[10814],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10816,"children":10817},{"style":2287},[10818],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10820,"children":10822},{"class":1062,"line":10821},69,[10823,10828],{"type":49,"tag":1060,"props":10824,"children":10825},{"style":2215},[10826],{"type":55,"value":10827},"    .taskDefinition.taskRoleArn",{"type":49,"tag":1060,"props":10829,"children":10830},{"style":2287},[10831],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10833,"children":10835},{"class":1062,"line":10834},70,[10836],{"type":49,"tag":1060,"props":10837,"children":10838},{"style":1073},[10839],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10841,"children":10843},{"class":1062,"line":10842},71,[10844],{"type":49,"tag":1060,"props":10845,"children":10846},{"emptyLinePlaceholder":44},[10847],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10849,"children":10851},{"class":1062,"line":10850},72,[10852],{"type":49,"tag":1060,"props":10853,"children":10854},{"style":3039},[10855],{"type":55,"value":10856},"  # check the content of the new container definition JSON\n",{"type":49,"tag":1060,"props":10858,"children":10860},{"class":1062,"line":10859},73,[10861,10865,10869,10873],{"type":49,"tag":1060,"props":10862,"children":10863},{"style":1067},[10864],{"type":55,"value":10418},{"type":49,"tag":1060,"props":10866,"children":10867},{"style":2215},[10868],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10870,"children":10871},{"style":1073},[10872],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10874,"children":10875},{"style":2215},[10876],{"type":55,"value":10510},{"type":49,"tag":1060,"props":10878,"children":10880},{"class":1062,"line":10879},74,[10881],{"type":49,"tag":1060,"props":10882,"children":10883},{"emptyLinePlaceholder":44},[10884],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10886,"children":10888},{"class":1062,"line":10887},75,[10889],{"type":49,"tag":1060,"props":10890,"children":10891},{"style":3039},[10892],{"type":55,"value":10893},"  # register new task definition using the new container definitions\n",{"type":49,"tag":1060,"props":10895,"children":10897},{"class":1062,"line":10896},76,[10898],{"type":49,"tag":1060,"props":10899,"children":10900},{"style":3039},[10901],{"type":55,"value":10902},"  # and the values that we read off of the existing task definitions\n",{"type":49,"tag":1060,"props":10904,"children":10906},{"class":1062,"line":10905},77,[10907,10911,10916,10920],{"type":49,"tag":1060,"props":10908,"children":10909},{"style":9965},[10910],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10912,"children":10913},{"style":2215},[10914],{"type":55,"value":10915}," \"Registering new ",{"type":49,"tag":1060,"props":10917,"children":10918},{"style":1073},[10919],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10921,"children":10922},{"style":2215},[10923],{"type":55,"value":10124},{"type":49,"tag":1060,"props":10925,"children":10927},{"class":1062,"line":10926},78,[10928],{"type":49,"tag":1060,"props":10929,"children":10930},{"emptyLinePlaceholder":44},[10931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10933,"children":10935},{"class":1062,"line":10934},79,[10936,10941,10945,10950],{"type":49,"tag":1060,"props":10937,"children":10938},{"style":1067},[10939],{"type":55,"value":10940},"  aws",{"type":49,"tag":1060,"props":10942,"children":10943},{"style":2215},[10944],{"type":55,"value":10229},{"type":49,"tag":1060,"props":10946,"children":10947},{"style":2215},[10948],{"type":55,"value":10949}," register-task-definition",{"type":49,"tag":1060,"props":10951,"children":10952},{"style":2287},[10953],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10955,"children":10957},{"class":1062,"line":10956},80,[10958,10963,10967],{"type":49,"tag":1060,"props":10959,"children":10960},{"style":2287},[10961],{"type":55,"value":10962},"    --family",{"type":49,"tag":1060,"props":10964,"children":10965},{"style":1073},[10966],{"type":55,"value":10253},{"type":49,"tag":1060,"props":10968,"children":10969},{"style":2287},[10970],{"type":55,"value":10258},{"type":49,"tag":1060,"props":10972,"children":10974},{"class":1062,"line":10973},81,[10975,10980,10985,10989,10994],{"type":49,"tag":1060,"props":10976,"children":10977},{"style":2287},[10978],{"type":55,"value":10979},"    --container-definitions",{"type":49,"tag":1060,"props":10981,"children":10982},{"style":2215},[10983],{"type":55,"value":10984}," file:///tmp/",{"type":49,"tag":1060,"props":10986,"children":10987},{"style":1073},[10988],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10990,"children":10991},{"style":2215},[10992],{"type":55,"value":10993},"-new.json",{"type":49,"tag":1060,"props":10995,"children":10996},{"style":2287},[10997],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10999,"children":11001},{"class":1062,"line":11000},82,[11002,11007,11012],{"type":49,"tag":1060,"props":11003,"children":11004},{"style":2287},[11005],{"type":55,"value":11006},"    --memory",{"type":49,"tag":1060,"props":11008,"children":11009},{"style":1073},[11010],{"type":55,"value":11011}," $MEMORY ",{"type":49,"tag":1060,"props":11013,"children":11014},{"style":2287},[11015],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11017,"children":11019},{"class":1062,"line":11018},83,[11020,11025,11030],{"type":49,"tag":1060,"props":11021,"children":11022},{"style":2287},[11023],{"type":55,"value":11024},"    --cpu",{"type":49,"tag":1060,"props":11026,"children":11027},{"style":1073},[11028],{"type":55,"value":11029}," $CPU ",{"type":49,"tag":1060,"props":11031,"children":11032},{"style":2287},[11033],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11035,"children":11037},{"class":1062,"line":11036},84,[11038,11043,11048],{"type":49,"tag":1060,"props":11039,"children":11040},{"style":2287},[11041],{"type":55,"value":11042},"    --network-mode",{"type":49,"tag":1060,"props":11044,"children":11045},{"style":2215},[11046],{"type":55,"value":11047}," awsvpc",{"type":49,"tag":1060,"props":11049,"children":11050},{"style":2287},[11051],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11053,"children":11055},{"class":1062,"line":11054},85,[11056,11061,11066],{"type":49,"tag":1060,"props":11057,"children":11058},{"style":2287},[11059],{"type":55,"value":11060},"    --execution-role-arn",{"type":49,"tag":1060,"props":11062,"children":11063},{"style":1073},[11064],{"type":55,"value":11065}," $ECS_EXECUTION_ROLE_ARN ",{"type":49,"tag":1060,"props":11067,"children":11068},{"style":2287},[11069],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11071,"children":11073},{"class":1062,"line":11072},86,[11074,11079,11084],{"type":49,"tag":1060,"props":11075,"children":11076},{"style":2287},[11077],{"type":55,"value":11078},"    --task-role-arn",{"type":49,"tag":1060,"props":11080,"children":11081},{"style":1073},[11082],{"type":55,"value":11083}," $ECS_TASK_ROLE_ARN ",{"type":49,"tag":1060,"props":11085,"children":11086},{"style":2287},[11087],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11089,"children":11091},{"class":1062,"line":11090},87,[11092,11097],{"type":49,"tag":1060,"props":11093,"children":11094},{"style":2287},[11095],{"type":55,"value":11096},"    --requires-compatibilities",{"type":49,"tag":1060,"props":11098,"children":11099},{"style":2215},[11100],{"type":55,"value":11101}," \"FARGATE\"\n",{"type":49,"tag":1060,"props":11103,"children":11105},{"class":1062,"line":11104},88,[11106],{"type":49,"tag":1060,"props":11107,"children":11108},{"emptyLinePlaceholder":44},[11109],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11111,"children":11113},{"class":1062,"line":11112},89,[11114],{"type":49,"tag":1060,"props":11115,"children":11116},{"style":2194},[11117],{"type":55,"value":11118},"done\n",{"type":49,"tag":1060,"props":11120,"children":11122},{"class":1062,"line":11121},90,[11123],{"type":49,"tag":1060,"props":11124,"children":11125},{"emptyLinePlaceholder":44},[11126],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11128,"children":11130},{"class":1062,"line":11129},91,[11131],{"type":49,"tag":1060,"props":11132,"children":11133},{"style":3039},[11134],{"type":55,"value":11135},"# Now we need to run migrate, collectstatic and any other commands that need to be run\n",{"type":49,"tag":1060,"props":11137,"children":11139},{"class":1062,"line":11138},92,[11140],{"type":49,"tag":1060,"props":11141,"children":11142},{"style":3039},[11143],{"type":55,"value":11144},"# before doing a rolling update of the backend services\n",{"type":49,"tag":1060,"props":11146,"children":11148},{"class":1062,"line":11147},93,[11149],{"type":49,"tag":1060,"props":11150,"children":11151},{"emptyLinePlaceholder":44},[11152],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11154,"children":11156},{"class":1062,"line":11155},94,[11157],{"type":49,"tag":1060,"props":11158,"children":11159},{"style":3039},[11160],{"type":55,"value":11161},"# We will use the new task definitions we just created to run these commands\n",{"type":49,"tag":1060,"props":11163,"children":11165},{"class":1062,"line":11164},95,[11166],{"type":49,"tag":1060,"props":11167,"children":11168},{"emptyLinePlaceholder":44},[11169],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11171,"children":11173},{"class":1062,"line":11172},96,[11174],{"type":49,"tag":1060,"props":11175,"children":11176},{"style":3039},[11177],{"type":55,"value":11178},"# get the ARN of the most recent revision of the migrate task definition\n",{"type":49,"tag":1060,"props":11180,"children":11182},{"class":1062,"line":11181},97,[11183,11188,11192,11196],{"type":49,"tag":1060,"props":11184,"children":11185},{"style":1073},[11186],{"type":55,"value":11187},"TASK_DEFINITION",{"type":49,"tag":1060,"props":11189,"children":11190},{"style":2194},[11191],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11193,"children":11194},{"style":1073},[11195],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11197,"children":11198},{"style":2287},[11199],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11201,"children":11203},{"class":1062,"line":11202},98,[11204,11208,11212,11216],{"type":49,"tag":1060,"props":11205,"children":11206},{"style":1067},[11207],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11209,"children":11210},{"style":2215},[11211],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11213,"children":11214},{"style":2215},[11215],{"type":55,"value":10234},{"type":49,"tag":1060,"props":11217,"children":11218},{"style":2287},[11219],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11221,"children":11223},{"class":1062,"line":11222},99,[11224,11228,11233,11238],{"type":49,"tag":1060,"props":11225,"children":11226},{"style":2287},[11227],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11229,"children":11230},{"style":1073},[11231],{"type":55,"value":11232}," $WORKSPACE",{"type":49,"tag":1060,"props":11234,"children":11235},{"style":2215},[11236],{"type":55,"value":11237},"-migrate",{"type":49,"tag":1060,"props":11239,"children":11240},{"style":2287},[11241],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11243,"children":11245},{"class":1062,"line":11244},100,[11246,11250,11254,11258],{"type":49,"tag":1060,"props":11247,"children":11248},{"style":2194},[11249],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11251,"children":11252},{"style":1067},[11253],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11255,"children":11256},{"style":2287},[11257],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11259,"children":11260},{"style":2287},[11261],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11263,"children":11265},{"class":1062,"line":11264},101,[11266,11271],{"type":49,"tag":1060,"props":11267,"children":11268},{"style":2215},[11269],{"type":55,"value":11270},"    .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":11272,"children":11273},{"style":2287},[11274],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11276,"children":11278},{"class":1062,"line":11277},102,[11279],{"type":49,"tag":1060,"props":11280,"children":11281},{"style":1073},[11282],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11284,"children":11286},{"class":1062,"line":11285},103,[11287],{"type":49,"tag":1060,"props":11288,"children":11289},{"emptyLinePlaceholder":44},[11290],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11292,"children":11294},{"class":1062,"line":11293},104,[11295],{"type":49,"tag":1060,"props":11296,"children":11297},{"style":3039},[11298],{"type":55,"value":11299},"# get private subnets as space separated string from shared resources VPC\n",{"type":49,"tag":1060,"props":11301,"children":11303},{"class":1062,"line":11302},105,[11304,11309,11313,11317],{"type":49,"tag":1060,"props":11305,"children":11306},{"style":1073},[11307],{"type":55,"value":11308},"SUBNETS",{"type":49,"tag":1060,"props":11310,"children":11311},{"style":2194},[11312],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11314,"children":11315},{"style":1073},[11316],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11318,"children":11319},{"style":2287},[11320],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11322,"children":11324},{"class":1062,"line":11323},106,[11325,11329,11334,11339],{"type":49,"tag":1060,"props":11326,"children":11327},{"style":1067},[11328],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11330,"children":11331},{"style":2215},[11332],{"type":55,"value":11333}," ec2",{"type":49,"tag":1060,"props":11335,"children":11336},{"style":2215},[11337],{"type":55,"value":11338}," describe-subnets",{"type":49,"tag":1060,"props":11340,"children":11341},{"style":2287},[11342],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11344,"children":11346},{"class":1062,"line":11345},107,[11347,11352,11357,11362,11366,11371],{"type":49,"tag":1060,"props":11348,"children":11349},{"style":2287},[11350],{"type":55,"value":11351},"    --filters",{"type":49,"tag":1060,"props":11353,"children":11354},{"style":2215},[11355],{"type":55,"value":11356}," \"Name=tag:env,Values=",{"type":49,"tag":1060,"props":11358,"children":11359},{"style":1073},[11360],{"type":55,"value":11361},"$SHARED_RESOURCES_WORKSPACE",{"type":49,"tag":1060,"props":11363,"children":11364},{"style":2215},[11365],{"type":55,"value":10005},{"type":49,"tag":1060,"props":11367,"children":11368},{"style":2215},[11369],{"type":55,"value":11370}," \"Name=tag:Name,Values=*private*\"",{"type":49,"tag":1060,"props":11372,"children":11373},{"style":2287},[11374],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11376,"children":11378},{"class":1062,"line":11377},108,[11379,11384,11389],{"type":49,"tag":1060,"props":11380,"children":11381},{"style":2287},[11382],{"type":55,"value":11383},"    --query",{"type":49,"tag":1060,"props":11385,"children":11386},{"style":2215},[11387],{"type":55,"value":11388}," 'Subnets[*].SubnetId'",{"type":49,"tag":1060,"props":11390,"children":11391},{"style":2287},[11392],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11394,"children":11396},{"class":1062,"line":11395},109,[11397,11402,11407],{"type":49,"tag":1060,"props":11398,"children":11399},{"style":2287},[11400],{"type":55,"value":11401},"    --output",{"type":49,"tag":1060,"props":11403,"children":11404},{"style":2215},[11405],{"type":55,"value":11406}," text",{"type":49,"tag":1060,"props":11408,"children":11409},{"style":2287},[11410],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11412,"children":11414},{"class":1062,"line":11413},110,[11415],{"type":49,"tag":1060,"props":11416,"children":11417},{"style":1073},[11418],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11420,"children":11422},{"class":1062,"line":11421},111,[11423],{"type":49,"tag":1060,"props":11424,"children":11425},{"emptyLinePlaceholder":44},[11426],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11428,"children":11430},{"class":1062,"line":11429},112,[11431],{"type":49,"tag":1060,"props":11432,"children":11433},{"style":3039},[11434],{"type":55,"value":11435},"# replace spaces with commas using tr\n",{"type":49,"tag":1060,"props":11437,"children":11439},{"class":1062,"line":11438},113,[11440,11445,11449,11453,11457,11462,11466,11471,11476,11481],{"type":49,"tag":1060,"props":11441,"children":11442},{"style":1073},[11443],{"type":55,"value":11444},"SUBNET_IDS",{"type":49,"tag":1060,"props":11446,"children":11447},{"style":2194},[11448],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11450,"children":11451},{"style":1073},[11452],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11454,"children":11455},{"style":9965},[11456],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11458,"children":11459},{"style":1073},[11460],{"type":55,"value":11461}," $SUBNETS ",{"type":49,"tag":1060,"props":11463,"children":11464},{"style":2194},[11465],{"type":55,"value":10302},{"type":49,"tag":1060,"props":11467,"children":11468},{"style":1067},[11469],{"type":55,"value":11470}," tr",{"type":49,"tag":1060,"props":11472,"children":11473},{"style":2215},[11474],{"type":55,"value":11475}," ' '",{"type":49,"tag":1060,"props":11477,"children":11478},{"style":2215},[11479],{"type":55,"value":11480}," ','",{"type":49,"tag":1060,"props":11482,"children":11483},{"style":1073},[11484],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11486,"children":11488},{"class":1062,"line":11487},114,[11489],{"type":49,"tag":1060,"props":11490,"children":11491},{"emptyLinePlaceholder":44},[11492],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11494,"children":11496},{"class":1062,"line":11495},115,[11497],{"type":49,"tag":1060,"props":11498,"children":11499},{"style":3039},[11500],{"type":55,"value":11501},"# https://github.com/aws/aws-cli/issues/5348\n",{"type":49,"tag":1060,"props":11503,"children":11505},{"class":1062,"line":11504},116,[11506],{"type":49,"tag":1060,"props":11507,"children":11508},{"style":3039},[11509],{"type":55,"value":11510},"# get ecs_sg_id - just a single value\n",{"type":49,"tag":1060,"props":11512,"children":11514},{"class":1062,"line":11513},117,[11515,11520,11524,11528],{"type":49,"tag":1060,"props":11516,"children":11517},{"style":1073},[11518],{"type":55,"value":11519},"ECS_SG_ID",{"type":49,"tag":1060,"props":11521,"children":11522},{"style":2194},[11523],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11525,"children":11526},{"style":1073},[11527],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11529,"children":11530},{"style":2287},[11531],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11533,"children":11535},{"class":1062,"line":11534},118,[11536,11540,11544,11549],{"type":49,"tag":1060,"props":11537,"children":11538},{"style":1067},[11539],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11541,"children":11542},{"style":2215},[11543],{"type":55,"value":11333},{"type":49,"tag":1060,"props":11545,"children":11546},{"style":2215},[11547],{"type":55,"value":11548}," describe-security-groups",{"type":49,"tag":1060,"props":11550,"children":11551},{"style":2287},[11552],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11554,"children":11556},{"class":1062,"line":11555},119,[11557,11561,11566,11570,11575],{"type":49,"tag":1060,"props":11558,"children":11559},{"style":2287},[11560],{"type":55,"value":11351},{"type":49,"tag":1060,"props":11562,"children":11563},{"style":2215},[11564],{"type":55,"value":11565}," \"Name=tag:Name,Values=",{"type":49,"tag":1060,"props":11567,"children":11568},{"style":1073},[11569],{"type":55,"value":11361},{"type":49,"tag":1060,"props":11571,"children":11572},{"style":2215},[11573],{"type":55,"value":11574},"-ecs-sg\"",{"type":49,"tag":1060,"props":11576,"children":11577},{"style":2287},[11578],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11580,"children":11582},{"class":1062,"line":11581},120,[11583,11587,11592],{"type":49,"tag":1060,"props":11584,"children":11585},{"style":2287},[11586],{"type":55,"value":11383},{"type":49,"tag":1060,"props":11588,"children":11589},{"style":2215},[11590],{"type":55,"value":11591}," 'SecurityGroups[*].GroupId'",{"type":49,"tag":1060,"props":11593,"children":11594},{"style":2287},[11595],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11597,"children":11599},{"class":1062,"line":11598},121,[11600,11604,11608],{"type":49,"tag":1060,"props":11601,"children":11602},{"style":2287},[11603],{"type":55,"value":11401},{"type":49,"tag":1060,"props":11605,"children":11606},{"style":2215},[11607],{"type":55,"value":11406},{"type":49,"tag":1060,"props":11609,"children":11610},{"style":2287},[11611],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11613,"children":11615},{"class":1062,"line":11614},122,[11616],{"type":49,"tag":1060,"props":11617,"children":11618},{"style":1073},[11619],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11621,"children":11623},{"class":1062,"line":11622},123,[11624],{"type":49,"tag":1060,"props":11625,"children":11626},{"emptyLinePlaceholder":44},[11627],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11629,"children":11631},{"class":1062,"line":11630},124,[11632,11636],{"type":49,"tag":1060,"props":11633,"children":11634},{"style":9965},[11635],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11637,"children":11638},{"style":2215},[11639],{"type":55,"value":11640}," \"Running database migrations...\"\n",{"type":49,"tag":1060,"props":11642,"children":11644},{"class":1062,"line":11643},125,[11645],{"type":49,"tag":1060,"props":11646,"children":11647},{"emptyLinePlaceholder":44},[11648],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11650,"children":11652},{"class":1062,"line":11651},126,[11653],{"type":49,"tag":1060,"props":11654,"children":11655},{"style":3039},[11656],{"type":55,"value":11657},"# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\n",{"type":49,"tag":1060,"props":11659,"children":11661},{"class":1062,"line":11660},127,[11662,11667,11671,11675,11680,11685],{"type":49,"tag":1060,"props":11663,"children":11664},{"style":1073},[11665],{"type":55,"value":11666},"START_TIME",{"type":49,"tag":1060,"props":11668,"children":11669},{"style":2194},[11670],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11672,"children":11673},{"style":1073},[11674],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11676,"children":11677},{"style":1067},[11678],{"type":55,"value":11679},"date",{"type":49,"tag":1060,"props":11681,"children":11682},{"style":2215},[11683],{"type":55,"value":11684}," +%s000",{"type":49,"tag":1060,"props":11686,"children":11687},{"style":1073},[11688],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11690,"children":11692},{"class":1062,"line":11691},128,[11693],{"type":49,"tag":1060,"props":11694,"children":11695},{"emptyLinePlaceholder":44},[11696],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11698,"children":11700},{"class":1062,"line":11699},129,[11701],{"type":49,"tag":1060,"props":11702,"children":11703},{"style":3039},[11704],{"type":55,"value":11705},"# run the migration task and capture the taskArn into a variable called TASK_ID\n",{"type":49,"tag":1060,"props":11707,"children":11709},{"class":1062,"line":11708},130,[11710,11715,11719,11723],{"type":49,"tag":1060,"props":11711,"children":11712},{"style":1073},[11713],{"type":55,"value":11714},"TASK_ID",{"type":49,"tag":1060,"props":11716,"children":11717},{"style":2194},[11718],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11720,"children":11721},{"style":1073},[11722],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11724,"children":11725},{"style":2287},[11726],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11728,"children":11730},{"class":1062,"line":11729},131,[11731,11735,11739,11744],{"type":49,"tag":1060,"props":11732,"children":11733},{"style":1067},[11734],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11736,"children":11737},{"style":2215},[11738],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11740,"children":11741},{"style":2215},[11742],{"type":55,"value":11743}," run-task",{"type":49,"tag":1060,"props":11745,"children":11746},{"style":2287},[11747],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11749,"children":11751},{"class":1062,"line":11750},132,[11752,11757,11761,11766],{"type":49,"tag":1060,"props":11753,"children":11754},{"style":2287},[11755],{"type":55,"value":11756},"    --cluster",{"type":49,"tag":1060,"props":11758,"children":11759},{"style":1073},[11760],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11762,"children":11763},{"style":2215},[11764],{"type":55,"value":11765},"-cluster",{"type":49,"tag":1060,"props":11767,"children":11768},{"style":2287},[11769],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11771,"children":11773},{"class":1062,"line":11772},133,[11774,11778,11783],{"type":49,"tag":1060,"props":11775,"children":11776},{"style":2287},[11777],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11779,"children":11780},{"style":1073},[11781],{"type":55,"value":11782}," $TASK_DEFINITION ",{"type":49,"tag":1060,"props":11784,"children":11785},{"style":2287},[11786],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11788,"children":11790},{"class":1062,"line":11789},134,[11791,11796,11801,11806,11810,11815,11820],{"type":49,"tag":1060,"props":11792,"children":11793},{"style":2287},[11794],{"type":55,"value":11795},"    --network-configuration",{"type":49,"tag":1060,"props":11797,"children":11798},{"style":2215},[11799],{"type":55,"value":11800}," \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":11802,"children":11803},{"style":1073},[11804],{"type":55,"value":11805},"$SUBNET_IDS",{"type":49,"tag":1060,"props":11807,"children":11808},{"style":2215},[11809],{"type":55,"value":3620},{"type":49,"tag":1060,"props":11811,"children":11812},{"style":1073},[11813],{"type":55,"value":11814},"$ECS_SG_ID",{"type":49,"tag":1060,"props":11816,"children":11817},{"style":2215},[11818],{"type":55,"value":11819},"],assignPublicIp=ENABLED}\"",{"type":49,"tag":1060,"props":11821,"children":11822},{"style":2287},[11823],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11825,"children":11827},{"class":1062,"line":11826},135,[11828,11832,11836,11840,11845],{"type":49,"tag":1060,"props":11829,"children":11830},{"style":2194},[11831],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11833,"children":11834},{"style":1067},[11835],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11837,"children":11838},{"style":2287},[11839],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11841,"children":11842},{"style":2215},[11843],{"type":55,"value":11844}," '.tasks[0].taskArn'",{"type":49,"tag":1060,"props":11846,"children":11847},{"style":2287},[11848],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11850,"children":11852},{"class":1062,"line":11851},136,[11853],{"type":49,"tag":1060,"props":11854,"children":11855},{"style":1073},[11856],{"type":55,"value":10267},{"type":49,"tag":1060,"props":11858,"children":11860},{"class":1062,"line":11859},137,[11861],{"type":49,"tag":1060,"props":11862,"children":11863},{"emptyLinePlaceholder":44},[11864],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11866,"children":11868},{"class":1062,"line":11867},138,[11869,11873,11878,11883],{"type":49,"tag":1060,"props":11870,"children":11871},{"style":9965},[11872],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11874,"children":11875},{"style":2215},[11876],{"type":55,"value":11877}," \"Task ID is ",{"type":49,"tag":1060,"props":11879,"children":11880},{"style":1073},[11881],{"type":55,"value":11882},"$TASK_ID",{"type":49,"tag":1060,"props":11884,"children":11885},{"style":2215},[11886],{"type":55,"value":10025},{"type":49,"tag":1060,"props":11888,"children":11890},{"class":1062,"line":11889},139,[11891],{"type":49,"tag":1060,"props":11892,"children":11893},{"emptyLinePlaceholder":44},[11894],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11896,"children":11898},{"class":1062,"line":11897},140,[11899],{"type":49,"tag":1060,"props":11900,"children":11901},{"style":3039},[11902],{"type":55,"value":11903},"# wait for the migrate task to exit\n",{"type":49,"tag":1060,"props":11905,"children":11907},{"class":1062,"line":11906},141,[11908],{"type":49,"tag":1060,"props":11909,"children":11910},{"style":3039},[11911],{"type":55,"value":11912},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n",{"type":49,"tag":1060,"props":11914,"children":11916},{"class":1062,"line":11915},142,[11917],{"type":49,"tag":1060,"props":11918,"children":11919},{"style":3039},[11920],{"type":55,"value":11921},"# > It will poll every 6 seconds until a successful state has been reached.\n",{"type":49,"tag":1060,"props":11923,"children":11925},{"class":1062,"line":11924},143,[11926],{"type":49,"tag":1060,"props":11927,"children":11928},{"style":3039},[11929],{"type":55,"value":11930},"# > This will exit with a return code of 255 after 100 failed checks.\n",{"type":49,"tag":1060,"props":11932,"children":11934},{"class":1062,"line":11933},144,[11935,11939,11943,11948,11953],{"type":49,"tag":1060,"props":11936,"children":11937},{"style":1067},[11938],{"type":55,"value":20},{"type":49,"tag":1060,"props":11940,"children":11941},{"style":2215},[11942],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11944,"children":11945},{"style":2215},[11946],{"type":55,"value":11947}," wait",{"type":49,"tag":1060,"props":11949,"children":11950},{"style":2215},[11951],{"type":55,"value":11952}," tasks-stopped",{"type":49,"tag":1060,"props":11954,"children":11955},{"style":2287},[11956],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11958,"children":11960},{"class":1062,"line":11959},145,[11961,11966,11971],{"type":49,"tag":1060,"props":11962,"children":11963},{"style":2287},[11964],{"type":55,"value":11965},"  --tasks",{"type":49,"tag":1060,"props":11967,"children":11968},{"style":1073},[11969],{"type":55,"value":11970}," $TASK_ID ",{"type":49,"tag":1060,"props":11972,"children":11973},{"style":2287},[11974],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11976,"children":11978},{"class":1062,"line":11977},146,[11979,11984,11988],{"type":49,"tag":1060,"props":11980,"children":11981},{"style":2287},[11982],{"type":55,"value":11983},"  --cluster",{"type":49,"tag":1060,"props":11985,"children":11986},{"style":1073},[11987],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11989,"children":11990},{"style":2215},[11991],{"type":55,"value":11992},"-cluster\n",{"type":49,"tag":1060,"props":11994,"children":11996},{"class":1062,"line":11995},147,[11997],{"type":49,"tag":1060,"props":11998,"children":11999},{"emptyLinePlaceholder":44},[12000],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12002,"children":12004},{"class":1062,"line":12003},148,[12005],{"type":49,"tag":1060,"props":12006,"children":12007},{"style":3039},[12008],{"type":55,"value":11657},{"type":49,"tag":1060,"props":12010,"children":12012},{"class":1062,"line":12011},149,[12013,12018,12022,12026,12030,12034],{"type":49,"tag":1060,"props":12014,"children":12015},{"style":1073},[12016],{"type":55,"value":12017},"END_TIME",{"type":49,"tag":1060,"props":12019,"children":12020},{"style":2194},[12021],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12023,"children":12024},{"style":1073},[12025],{"type":55,"value":10220},{"type":49,"tag":1060,"props":12027,"children":12028},{"style":1067},[12029],{"type":55,"value":11679},{"type":49,"tag":1060,"props":12031,"children":12032},{"style":2215},[12033],{"type":55,"value":11684},{"type":49,"tag":1060,"props":12035,"children":12036},{"style":1073},[12037],{"type":55,"value":5126},{"type":49,"tag":1060,"props":12039,"children":12041},{"class":1062,"line":12040},150,[12042],{"type":49,"tag":1060,"props":12043,"children":12044},{"emptyLinePlaceholder":44},[12045],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12047,"children":12049},{"class":1062,"line":12048},151,[12050],{"type":49,"tag":1060,"props":12051,"children":12052},{"style":3039},[12053],{"type":55,"value":12054},"# print the CloudWatch log events to STDOUT\n",{"type":49,"tag":1060,"props":12056,"children":12058},{"class":1062,"line":12057},152,[12059,12063,12068,12073],{"type":49,"tag":1060,"props":12060,"children":12061},{"style":1067},[12062],{"type":55,"value":20},{"type":49,"tag":1060,"props":12064,"children":12065},{"style":2215},[12066],{"type":55,"value":12067}," logs",{"type":49,"tag":1060,"props":12069,"children":12070},{"style":2215},[12071],{"type":55,"value":12072}," get-log-events",{"type":49,"tag":1060,"props":12074,"children":12075},{"style":2287},[12076],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12078,"children":12080},{"class":1062,"line":12079},153,[12081,12086,12091,12095,12100],{"type":49,"tag":1060,"props":12082,"children":12083},{"style":2287},[12084],{"type":55,"value":12085},"  --log-group-name",{"type":49,"tag":1060,"props":12087,"children":12088},{"style":2215},[12089],{"type":55,"value":12090}," \"/ecs/",{"type":49,"tag":1060,"props":12092,"children":12093},{"style":1073},[12094],{"type":55,"value":10175},{"type":49,"tag":1060,"props":12096,"children":12097},{"style":2215},[12098],{"type":55,"value":12099},"/migrate\"",{"type":49,"tag":1060,"props":12101,"children":12102},{"style":2287},[12103],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12105,"children":12107},{"class":1062,"line":12106},154,[12108,12113,12118,12122,12127,12132],{"type":49,"tag":1060,"props":12109,"children":12110},{"style":2287},[12111],{"type":55,"value":12112},"  --log-stream-name",{"type":49,"tag":1060,"props":12114,"children":12115},{"style":2215},[12116],{"type":55,"value":12117}," \"migrate/migrate/${",{"type":49,"tag":1060,"props":12119,"children":12120},{"style":1073},[12121],{"type":55,"value":11714},{"type":49,"tag":1060,"props":12123,"children":12124},{"style":2194},[12125],{"type":55,"value":12126},"##*/",{"type":49,"tag":1060,"props":12128,"children":12129},{"style":2215},[12130],{"type":55,"value":12131},"}\"",{"type":49,"tag":1060,"props":12133,"children":12134},{"style":2287},[12135],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12137,"children":12139},{"class":1062,"line":12138},155,[12140,12145,12150],{"type":49,"tag":1060,"props":12141,"children":12142},{"style":2287},[12143],{"type":55,"value":12144},"  --start-time",{"type":49,"tag":1060,"props":12146,"children":12147},{"style":1073},[12148],{"type":55,"value":12149}," $START_TIME ",{"type":49,"tag":1060,"props":12151,"children":12152},{"style":2287},[12153],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12155,"children":12157},{"class":1062,"line":12156},156,[12158,12163,12168],{"type":49,"tag":1060,"props":12159,"children":12160},{"style":2287},[12161],{"type":55,"value":12162},"  --end-time",{"type":49,"tag":1060,"props":12164,"children":12165},{"style":1073},[12166],{"type":55,"value":12167}," $END_TIME ",{"type":49,"tag":1060,"props":12169,"children":12170},{"style":2287},[12171],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12173,"children":12175},{"class":1062,"line":12174},157,[12176,12181,12185,12189],{"type":49,"tag":1060,"props":12177,"children":12178},{"style":2194},[12179],{"type":55,"value":12180},"  |",{"type":49,"tag":1060,"props":12182,"children":12183},{"style":1067},[12184],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12186,"children":12187},{"style":2287},[12188],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12190,"children":12191},{"style":2215},[12192],{"type":55,"value":12193}," '.events[].message'\n",{"type":49,"tag":1060,"props":12195,"children":12197},{"class":1062,"line":12196},158,[12198],{"type":49,"tag":1060,"props":12199,"children":12200},{"emptyLinePlaceholder":44},[12201],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12203,"children":12205},{"class":1062,"line":12204},159,[12206,12210],{"type":49,"tag":1060,"props":12207,"children":12208},{"style":9965},[12209],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12211,"children":12212},{"style":2215},[12213],{"type":55,"value":12214}," \"Migrations complete. Starting rolling update for backend services...\"\n",{"type":49,"tag":1060,"props":12216,"children":12218},{"class":1062,"line":12217},160,[12219],{"type":49,"tag":1060,"props":12220,"children":12221},{"emptyLinePlaceholder":44},[12222],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12224,"children":12226},{"class":1062,"line":12225},161,[12227],{"type":49,"tag":1060,"props":12228,"children":12229},{"style":3039},[12230],{"type":55,"value":12231},"# update backend services\n",{"type":49,"tag":1060,"props":12233,"children":12235},{"class":1062,"line":12234},162,[12236,12240,12244,12248,12252,12256],{"type":49,"tag":1060,"props":12237,"children":12238},{"style":2194},[12239],{"type":55,"value":10063},{"type":49,"tag":1060,"props":12241,"children":12242},{"style":1073},[12243],{"type":55,"value":10068},{"type":49,"tag":1060,"props":12245,"children":12246},{"style":2194},[12247],{"type":55,"value":10073},{"type":49,"tag":1060,"props":12249,"children":12250},{"style":2215},[12251],{"type":55,"value":10083},{"type":49,"tag":1060,"props":12253,"children":12254},{"style":2215},[12255],{"type":55,"value":10088},{"type":49,"tag":1060,"props":12257,"children":12258},{"style":2215},[12259],{"type":55,"value":10093},{"type":49,"tag":1060,"props":12261,"children":12263},{"class":1062,"line":12262},163,[12264],{"type":49,"tag":1060,"props":12265,"children":12266},{"style":2194},[12267],{"type":55,"value":10101},{"type":49,"tag":1060,"props":12269,"children":12271},{"class":1062,"line":12270},164,[12272],{"type":49,"tag":1060,"props":12273,"children":12274},{"emptyLinePlaceholder":44},[12275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12277,"children":12279},{"class":1062,"line":12278},165,[12280],{"type":49,"tag":1060,"props":12281,"children":12282},{"style":3039},[12283],{"type":55,"value":12284},"  # get taskDefinitionArn for each service to be used in update-service command\n",{"type":49,"tag":1060,"props":12286,"children":12288},{"class":1062,"line":12287},166,[12289],{"type":49,"tag":1060,"props":12290,"children":12291},{"style":3039},[12292],{"type":55,"value":12293},"  # this will get the most recent revision of each task (the one that was just created)\n",{"type":49,"tag":1060,"props":12295,"children":12297},{"class":1062,"line":12296},167,[12298],{"type":49,"tag":1060,"props":12299,"children":12300},{"style":3039},[12301],{"type":55,"value":12302},"  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":12304,"children":12306},{"class":1062,"line":12305},168,[12307,12312,12316,12320],{"type":49,"tag":1060,"props":12308,"children":12309},{"style":1073},[12310],{"type":55,"value":12311},"  TASK_DEFINITION",{"type":49,"tag":1060,"props":12313,"children":12314},{"style":2194},[12315],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12317,"children":12318},{"style":1073},[12319],{"type":55,"value":10584},{"type":49,"tag":1060,"props":12321,"children":12322},{"style":2287},[12323],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12325,"children":12327},{"class":1062,"line":12326},169,[12328,12333,12337,12341],{"type":49,"tag":1060,"props":12329,"children":12330},{"style":1067},[12331],{"type":55,"value":12332},"    aws",{"type":49,"tag":1060,"props":12334,"children":12335},{"style":2215},[12336],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12338,"children":12339},{"style":2215},[12340],{"type":55,"value":10234},{"type":49,"tag":1060,"props":12342,"children":12343},{"style":2287},[12344],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12346,"children":12348},{"class":1062,"line":12347},170,[12349,12354,12358,12362,12367],{"type":49,"tag":1060,"props":12350,"children":12351},{"style":2287},[12352],{"type":55,"value":12353},"      --task-definition",{"type":49,"tag":1060,"props":12355,"children":12356},{"style":1073},[12357],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12359,"children":12360},{"style":2215},[12361],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12363,"children":12364},{"style":1073},[12365],{"type":55,"value":12366},"$TASK ",{"type":49,"tag":1060,"props":12368,"children":12369},{"style":2287},[12370],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12372,"children":12374},{"class":1062,"line":12373},171,[12375,12380,12384,12388],{"type":49,"tag":1060,"props":12376,"children":12377},{"style":2194},[12378],{"type":55,"value":12379},"      |",{"type":49,"tag":1060,"props":12381,"children":12382},{"style":1067},[12383],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12385,"children":12386},{"style":2287},[12387],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12389,"children":12390},{"style":2287},[12391],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12393,"children":12395},{"class":1062,"line":12394},172,[12396,12401],{"type":49,"tag":1060,"props":12397,"children":12398},{"style":2215},[12399],{"type":55,"value":12400},"      .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":12402,"children":12403},{"style":2287},[12404],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12406,"children":12408},{"class":1062,"line":12407},173,[12409],{"type":49,"tag":1060,"props":12410,"children":12411},{"style":1073},[12412],{"type":55,"value":10267},{"type":49,"tag":1060,"props":12414,"children":12416},{"class":1062,"line":12415},174,[12417],{"type":49,"tag":1060,"props":12418,"children":12419},{"emptyLinePlaceholder":44},[12420],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12422,"children":12424},{"class":1062,"line":12423},175,[12425],{"type":49,"tag":1060,"props":12426,"children":12427},{"style":3039},[12428],{"type":55,"value":12429},"  # update each service with new task definintion\n",{"type":49,"tag":1060,"props":12431,"children":12433},{"class":1062,"line":12432},176,[12434,12438,12442,12447],{"type":49,"tag":1060,"props":12435,"children":12436},{"style":1067},[12437],{"type":55,"value":10940},{"type":49,"tag":1060,"props":12439,"children":12440},{"style":2215},[12441],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12443,"children":12444},{"style":2215},[12445],{"type":55,"value":12446}," update-service",{"type":49,"tag":1060,"props":12448,"children":12449},{"style":2287},[12450],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12452,"children":12454},{"class":1062,"line":12453},177,[12455,12459,12463,12467],{"type":49,"tag":1060,"props":12456,"children":12457},{"style":2287},[12458],{"type":55,"value":11756},{"type":49,"tag":1060,"props":12460,"children":12461},{"style":1073},[12462],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12464,"children":12465},{"style":2215},[12466],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12468,"children":12469},{"style":2287},[12470],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12472,"children":12474},{"class":1062,"line":12473},178,[12475,12480,12484,12488,12492],{"type":49,"tag":1060,"props":12476,"children":12477},{"style":2287},[12478],{"type":55,"value":12479},"    --service",{"type":49,"tag":1060,"props":12481,"children":12482},{"style":1073},[12483],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12485,"children":12486},{"style":2215},[12487],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12489,"children":12490},{"style":1073},[12491],{"type":55,"value":12366},{"type":49,"tag":1060,"props":12493,"children":12494},{"style":2287},[12495],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12497,"children":12499},{"class":1062,"line":12498},179,[12500,12504,12508],{"type":49,"tag":1060,"props":12501,"children":12502},{"style":2287},[12503],{"type":55,"value":10248},{"type":49,"tag":1060,"props":12505,"children":12506},{"style":1073},[12507],{"type":55,"value":11782},{"type":49,"tag":1060,"props":12509,"children":12510},{"style":2287},[12511],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12513,"children":12515},{"class":1062,"line":12514},180,[12516],{"type":49,"tag":1060,"props":12517,"children":12518},{"style":2287},[12519],{"type":55,"value":12520},"    --no-cli-pager\n",{"type":49,"tag":1060,"props":12522,"children":12524},{"class":1062,"line":12523},181,[12525],{"type":49,"tag":1060,"props":12526,"children":12527},{"emptyLinePlaceholder":44},[12528],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12530,"children":12532},{"class":1062,"line":12531},182,[12533],{"type":49,"tag":1060,"props":12534,"children":12535},{"style":2194},[12536],{"type":55,"value":11118},{"type":49,"tag":1060,"props":12538,"children":12540},{"class":1062,"line":12539},183,[12541],{"type":49,"tag":1060,"props":12542,"children":12543},{"emptyLinePlaceholder":44},[12544],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12546,"children":12548},{"class":1062,"line":12547},184,[12549,12553],{"type":49,"tag":1060,"props":12550,"children":12551},{"style":9965},[12552],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12554,"children":12555},{"style":2215},[12556],{"type":55,"value":12557}," \"Services updated. Waiting for services to become stable...\"\n",{"type":49,"tag":1060,"props":12559,"children":12561},{"class":1062,"line":12560},185,[12562],{"type":49,"tag":1060,"props":12563,"children":12564},{"emptyLinePlaceholder":44},[12565],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12567,"children":12569},{"class":1062,"line":12568},186,[12570],{"type":49,"tag":1060,"props":12571,"children":12572},{"style":3039},[12573],{"type":55,"value":12574},"# wait for all service to be stable (runningCount == desiredCount for each service)\n",{"type":49,"tag":1060,"props":12576,"children":12578},{"class":1062,"line":12577},187,[12579,12583,12587,12591,12596],{"type":49,"tag":1060,"props":12580,"children":12581},{"style":1067},[12582],{"type":55,"value":20},{"type":49,"tag":1060,"props":12584,"children":12585},{"style":2215},[12586],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12588,"children":12589},{"style":2215},[12590],{"type":55,"value":11947},{"type":49,"tag":1060,"props":12592,"children":12593},{"style":2215},[12594],{"type":55,"value":12595}," services-stable",{"type":49,"tag":1060,"props":12597,"children":12598},{"style":2287},[12599],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12601,"children":12603},{"class":1062,"line":12602},188,[12604,12608,12612,12616],{"type":49,"tag":1060,"props":12605,"children":12606},{"style":2287},[12607],{"type":55,"value":11983},{"type":49,"tag":1060,"props":12609,"children":12610},{"style":1073},[12611],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12613,"children":12614},{"style":2215},[12615],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12617,"children":12618},{"style":2287},[12619],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12621,"children":12623},{"class":1062,"line":12622},189,[12624,12629,12633,12638,12642,12647,12651],{"type":49,"tag":1060,"props":12625,"children":12626},{"style":2287},[12627],{"type":55,"value":12628},"  --services",{"type":49,"tag":1060,"props":12630,"children":12631},{"style":1073},[12632],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12634,"children":12635},{"style":2215},[12636],{"type":55,"value":12637},"-gunicorn",{"type":49,"tag":1060,"props":12639,"children":12640},{"style":1073},[12641],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12643,"children":12644},{"style":2215},[12645],{"type":55,"value":12646},"-default",{"type":49,"tag":1060,"props":12648,"children":12649},{"style":1073},[12650],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12652,"children":12653},{"style":2215},[12654],{"type":55,"value":12655},"-beat\n",{"type":49,"tag":1060,"props":12657,"children":12659},{"class":1062,"line":12658},190,[12660],{"type":49,"tag":1060,"props":12661,"children":12662},{"emptyLinePlaceholder":44},[12663],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12665,"children":12667},{"class":1062,"line":12666},191,[12668,12672,12677,12681],{"type":49,"tag":1060,"props":12669,"children":12670},{"style":9965},[12671],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12673,"children":12674},{"style":2215},[12675],{"type":55,"value":12676}," \"Services are now stable. Backend services are now up to date with ",{"type":49,"tag":1060,"props":12678,"children":12679},{"style":1073},[12680],{"type":55,"value":10020},{"type":49,"tag":1060,"props":12682,"children":12683},{"style":2215},[12684],{"type":55,"value":12685},".\"\n",{"type":49,"tag":1060,"props":12687,"children":12689},{"class":1062,"line":12688},192,[12690],{"type":49,"tag":1060,"props":12691,"children":12692},{"emptyLinePlaceholder":44},[12693],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12695,"children":12697},{"class":1062,"line":12696},193,[12698,12702],{"type":49,"tag":1060,"props":12699,"children":12700},{"style":9965},[12701],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12703,"children":12704},{"style":2215},[12705],{"type":55,"value":12706}," \"Backend update is now complete!\"\n",{"type":49,"tag":58,"props":12708,"children":12709},{},[12710,12712,12718,12720,12725],{"type":55,"value":12711},"With this GitHub Actions workflow, a developer can now easily change the version of backend code that is running in their ad hoc environments without needing to involve Terraform. Using the ",{"type":49,"tag":326,"props":12713,"children":12715},{"className":12714},[],[12716],{"type":55,"value":12717},"ad_hoc_backend_update.yml",{"type":55,"value":12719}," GitHub Actions workflow, a developer only needs to enter the name of the workspace and the version of the backend code they want to use. The workflow will then run the ",{"type":49,"tag":326,"props":12721,"children":12723},{"className":12722},[],[12724],{"type":55,"value":3323},{"type":55,"value":12726}," task and update the backend services.",{"type":49,"tag":430,"props":12728,"children":12730},{"id":12729},"using-ignore_changes-in-the-definitions",[12731,12733,12739],{"type":55,"value":12732},"Using ",{"type":49,"tag":326,"props":12734,"children":12736},{"className":12735},[],[12737],{"type":55,"value":12738},"ignore_changes",{"type":55,"value":12740}," in the definitions",{"type":49,"tag":58,"props":12742,"children":12743},{},[12744,12746,12751,12753,12759,12761,12767,12769,12781,12783,12788,12790,12795],{"type":55,"value":12745},"There is one more important point to make about Terraform before we conclude this discussion on updating backend code for existing ad hoc environments. Consider the scenario where a developer has launched an ad hoc environment with backend version ",{"type":49,"tag":326,"props":12747,"children":12749},{"className":12748},[],[12750],{"type":55,"value":9562},{"type":55,"value":12752},". They make a small change to the backend code and push version ",{"type":49,"tag":326,"props":12754,"children":12756},{"className":12755},[],[12757],{"type":55,"value":12758},"v1.0.1",{"type":55,"value":12760},". Next, the developer remembers that a backend environment variable needs to be changed. This can be done by updating their ",{"type":49,"tag":326,"props":12762,"children":12764},{"className":12763},[],[12765],{"type":55,"value":12766},"*.tfvars",{"type":55,"value":12768}," file. If they now re-run the ad hoc environment update pipeline ",{"type":49,"tag":72,"props":12770,"children":12771},{},[12772,12774,12779],{"type":55,"value":12773},"without also updating the backend version in their ",{"type":49,"tag":326,"props":12775,"children":12777},{"className":12776},[],[12778],{"type":55,"value":12766},{"type":55,"value":12780}," file",{"type":55,"value":12782},", then their code will be reverted from ",{"type":49,"tag":326,"props":12784,"children":12786},{"className":12785},[],[12787],{"type":55,"value":12758},{"type":55,"value":12789}," to ",{"type":49,"tag":326,"props":12791,"children":12793},{"className":12792},[],[12794],{"type":55,"value":9562},{"type":55,"value":12796},". We would need to coordinate version changes between updating the backend with the pipelines that use Terraform commands and the pipelines that use the AWS CLI commands.",{"type":49,"tag":58,"props":12798,"children":12799},{},[12800,12802,12808,12810,12820,12822,12828,12830,12835,12837,12842,12844,12849,12851,12856],{"type":55,"value":12801},"There is a setting on the ",{"type":49,"tag":326,"props":12803,"children":12805},{"className":12804},[],[12806],{"type":55,"value":12807},"aws_ecs_service",{"type":55,"value":12809}," resource in Terraform we can can use to prevent this from happening. This setting is called ",{"type":49,"tag":80,"props":12811,"children":12814},{"href":12812,"rel":12813},"https://www.terraform.io/language/meta-arguments/lifecycle",[84],[12815],{"type":49,"tag":326,"props":12816,"children":12818},{"className":12817},[],[12819],{"type":55,"value":12738},{"type":55,"value":12821}," and is defined under the resource's ",{"type":49,"tag":326,"props":12823,"children":12825},{"className":12824},[],[12826],{"type":55,"value":12827},"lifecycle",{"type":55,"value":12829}," configuration block. With this setting, when we update the ",{"type":49,"tag":326,"props":12831,"children":12833},{"className":12832},[],[12834],{"type":55,"value":12766},{"type":55,"value":12836}," file with our new environment variable value, we will create another recent task definition with the same ",{"type":49,"tag":326,"props":12838,"children":12840},{"className":12839},[],[12841],{"type":55,"value":9562},{"type":55,"value":12843}," image, but the ECS service will not update in response to this change (that's what the ",{"type":49,"tag":326,"props":12845,"children":12847},{"className":12846},[],[12848],{"type":55,"value":12738},{"type":55,"value":12850}," is for). Once we make the ",{"type":49,"tag":326,"props":12852,"children":12854},{"className":12853},[],[12855],{"type":55,"value":12766},{"type":55,"value":12857}," file update and redeploy using the Terraform pipeline, nothing on our ad hoc changes, but we did get a new task definitions defined in our AWS account for each backend service. When we go to make the backend update with the pipeline that uses AWS CLI commands, the most recent task revision is used to create the new task definition, so it will include the environment variable change that we added earlier.",{"type":49,"tag":430,"props":12859,"children":12861},{"id":12860},"frontend-updates",[12862],{"type":55,"value":12863},"Frontend updates",{"type":49,"tag":58,"props":12865,"children":12866},{},[12867,12869,12874],{"type":55,"value":12868},"The process described above is needed for updating the backend application. Updating the frontend application involves a similar process to the backend update. The main difference is that no task (such as the ",{"type":49,"tag":326,"props":12870,"children":12872},{"className":12871},[],[12873],{"type":55,"value":3323},{"type":55,"value":12875}," command on the backend) needs to run before the service is updated. Here's an overview of the frontend update process:",{"type":49,"tag":64,"props":12877,"children":12878},{},[12879,12890,12901,12912,12923],{"type":49,"tag":68,"props":12880,"children":12881},{},[12882,12884,12889],{"type":55,"value":12883},"fetch the container definition JSON for the frontend tasks (",{"type":49,"tag":326,"props":12885,"children":12887},{"className":12886},[],[12888],{"type":55,"value":9743},{"type":55,"value":616},{"type":49,"tag":68,"props":12891,"children":12892},{},[12893,12895,12900],{"type":55,"value":12894},"write new container definition JSON with the new frontend image tag (using ",{"type":49,"tag":326,"props":12896,"children":12898},{"className":12897},[],[12899],{"type":55,"value":9755},{"type":55,"value":616},{"type":49,"tag":68,"props":12902,"children":12903},{},[12904,12906,12911],{"type":55,"value":12905},"register new task definitions with the new container definition JSON file for the frontend task (",{"type":49,"tag":326,"props":12907,"children":12909},{"className":12908},[],[12910],{"type":55,"value":9767},{"type":55,"value":616},{"type":49,"tag":68,"props":12913,"children":12914},{},[12915,12917,12922],{"type":55,"value":12916},"update the frontend service (",{"type":49,"tag":326,"props":12918,"children":12920},{"className":12919},[],[12921],{"type":55,"value":9802},{"type":55,"value":616},{"type":49,"tag":68,"props":12924,"children":12925},{},[12926,12927,12932],{"type":55,"value":9808},{"type":49,"tag":326,"props":12928,"children":12930},{"className":12929},[],[12931],{"type":55,"value":9814},{"type":55,"value":616},{"type":49,"tag":50,"props":12934,"children":12936},{"id":12935},"setting-up-everything-from-a-new-aws-account-and-github-actions",[12937],{"type":55,"value":12938},"Setting up everything from a new AWS account and GitHub Actions",{"type":49,"tag":58,"props":12940,"children":12941},{},[12942],{"type":55,"value":12943},"Here's a quick overview of initial setup steps that are needed in order to use the automation defined in the GitHub Actions for ad hoc environments.",{"type":49,"tag":430,"props":12945,"children":12947},{"id":12946},"configure-aws-credentials-locally",[12948],{"type":55,"value":12949},"Configure AWS credentials locally",{"type":49,"tag":58,"props":12951,"children":12952},{},[12953],{"type":55,"value":12954},"There is one Terraform command that we will run on our local machine to setup a remote backend for storing our Terraform state. In order to run this, we need to configure AWS credentials locally.",{"type":49,"tag":430,"props":12956,"children":12958},{"id":12957},"run-the-make-tf-bootstrap-command",[12959,12961,12967],{"type":55,"value":12960},"Run the ",{"type":49,"tag":326,"props":12962,"children":12964},{"className":12963},[],[12965],{"type":55,"value":12966},"make tf-bootstrap",{"type":55,"value":12968}," command",{"type":49,"tag":58,"props":12970,"children":12971},{},[12972,12974,12980],{"type":55,"value":12973},"This command will setup an S3 bucket and DynamoDB table for storing Terraform state. Running this command will also require that a ",{"type":49,"tag":326,"props":12975,"children":12977},{"className":12976},[],[12978],{"type":55,"value":12979},"bootstrap.tfvars",{"type":55,"value":12981}," file has been created from the template. This will define the AWS region and name to be used for creating resources.",{"type":49,"tag":430,"props":12983,"children":12985},{"id":12984},"build-and-push-a-backend-and-frontend-image",[12986],{"type":55,"value":12987},"Build and push a backend and frontend image",{"type":49,"tag":58,"props":12989,"children":12990},{},[12991,12992,12998,13000,13006,13007,13013],{"type":55,"value":413},{"type":49,"tag":326,"props":12993,"children":12995},{"className":12994},[],[12996],{"type":55,"value":12997},"tf-bootstrap",{"type":55,"value":12999}," command also creates ECR repositories for the backend and frontend images. We can use the ",{"type":49,"tag":326,"props":13001,"children":13003},{"className":13002},[],[13004],{"type":55,"value":13005},"ecr_backend.yml",{"type":55,"value":715},{"type":49,"tag":326,"props":13008,"children":13010},{"className":13009},[],[13011],{"type":55,"value":13012},"ecr_frontend.yml",{"type":55,"value":13014}," GitHub Actions workflows to build and push the backend and frontend images to the ECR repositories. These pipelines accept a single parameter which is a git tag that must exist in the repo. This git tag will then be used as the image tag for the backend and frontend images.",{"type":49,"tag":430,"props":13016,"children":13018},{"id":13017},"purchase-a-domain-name-in-route-53",[13019],{"type":55,"value":13020},"Purchase a domain name in Route 53",{"type":49,"tag":58,"props":13022,"children":13023},{},[13024],{"type":55,"value":13025},"I use Route 53 to manage DNS records, and have purchased a domain name that I use for testing and debugging in this and other projects.",{"type":49,"tag":430,"props":13027,"children":13029},{"id":13028},"create-a-wildcard-acm-certificate",[13030],{"type":55,"value":13031},"Create a wildcard ACM certificate",{"type":49,"tag":58,"props":13033,"children":13034},{},[13035],{"type":55,"value":13036},"I chose to create this certificate outside of Terraform and import it via ARN. We need a wildcard certificate so that multiple ad hoc environments can be hosted on subdomains of the same domain.",{"type":49,"tag":430,"props":13038,"children":13040},{"id":13039},"create-a-new-ec2-key-pair",[13041],{"type":55,"value":13042},"Create a new EC2 key pair",{"type":49,"tag":58,"props":13044,"children":13045},{},[13046],{"type":55,"value":13047},"The key pair should be created manually and it needs to be added to GitHub repository secrets so that it can be used in the ad hoc environment pipelines.",{"type":49,"tag":430,"props":13049,"children":13051},{"id":13050},"add-secrets-to-github",[13052],{"type":55,"value":13053},"Add secrets to GitHub",{"type":49,"tag":58,"props":13055,"children":13056},{},[13057],{"type":55,"value":13058},"The following secrets are needed for GitHub Actions to run. Add these as repository secrets:",{"type":49,"tag":64,"props":13060,"children":13061},{},[13062,13073,13084,13095,13113,13124,13135,13146,13157,13168,13179],{"type":49,"tag":68,"props":13063,"children":13064},{},[13065,13071],{"type":49,"tag":326,"props":13066,"children":13068},{"className":13067},[],[13069],{"type":55,"value":13070},"ACM_CERTIFICATE_ARN",{"type":55,"value":13072}," - ARN of the wildcard ACM certificate",{"type":49,"tag":68,"props":13074,"children":13075},{},[13076,13082],{"type":49,"tag":326,"props":13077,"children":13079},{"className":13078},[],[13080],{"type":55,"value":13081},"AWS_ACCESS_KEY_ID",{"type":55,"value":13083}," - AWS access key ID",{"type":49,"tag":68,"props":13085,"children":13086},{},[13087,13093],{"type":49,"tag":326,"props":13088,"children":13090},{"className":13089},[],[13091],{"type":55,"value":13092},"AWS_ACCOUNT_ID",{"type":55,"value":13094}," - AWS account ID",{"type":49,"tag":68,"props":13096,"children":13097},{},[13098,13104,13106,13112],{"type":49,"tag":326,"props":13099,"children":13101},{"className":13100},[],[13102],{"type":55,"value":13103},"AWS_DEFAULT_REGION",{"type":55,"value":13105}," - AWS default region (I use ",{"type":49,"tag":326,"props":13107,"children":13109},{"className":13108},[],[13110],{"type":55,"value":13111},"us-east-1",{"type":55,"value":616},{"type":49,"tag":68,"props":13114,"children":13115},{},[13116,13122],{"type":49,"tag":326,"props":13117,"children":13119},{"className":13118},[],[13120],{"type":55,"value":13121},"AWS_SECRET_ACCESS_KEY",{"type":55,"value":13123}," - AWS secret access key",{"type":49,"tag":68,"props":13125,"children":13126},{},[13127,13133],{"type":49,"tag":326,"props":13128,"children":13130},{"className":13129},[],[13131],{"type":55,"value":13132},"DOMAIN_NAME",{"type":55,"value":13134}," - domain name for the ad hoc environment (e.g. example.com)",{"type":49,"tag":68,"props":13136,"children":13137},{},[13138,13144],{"type":49,"tag":326,"props":13139,"children":13141},{"className":13140},[],[13142],{"type":55,"value":13143},"KEY_NAME",{"type":55,"value":13145}," - name of the EC2 key pair",{"type":49,"tag":68,"props":13147,"children":13148},{},[13149,13155],{"type":49,"tag":326,"props":13150,"children":13152},{"className":13151},[],[13153],{"type":55,"value":13154},"SSH_PRIVATE_KEY",{"type":55,"value":13156}," - private key for the EC2 key pair",{"type":49,"tag":68,"props":13158,"children":13159},{},[13160,13166],{"type":49,"tag":326,"props":13161,"children":13163},{"className":13162},[],[13164],{"type":55,"value":13165},"TF_BACKEND_BUCKET",{"type":55,"value":13167}," - name of the S3 bucket used for storing Terraform state",{"type":49,"tag":68,"props":13169,"children":13170},{},[13171,13177],{"type":49,"tag":326,"props":13172,"children":13174},{"className":13173},[],[13175],{"type":55,"value":13176},"TF_BACKEND_DYNAMODB_TABLE",{"type":55,"value":13178}," - name of the DynamoDB table used for locking the Terraform state file",{"type":49,"tag":68,"props":13180,"children":13181},{},[13182,13188],{"type":49,"tag":326,"props":13183,"children":13185},{"className":13184},[],[13186],{"type":55,"value":13187},"TF_BACKEND_REGION",{"type":55,"value":13189}," - AWS region for the S3 bucket and DynamoDB table",{"type":49,"tag":58,"props":13191,"children":13192},{},[13193],{"type":55,"value":13194},"These secrets are referenced in the GitHub Actions workflows.",{"type":49,"tag":430,"props":13196,"children":13198},{"id":13197},"create-shared-resources",[13199],{"type":55,"value":13200},"Create shared resources",{"type":49,"tag":58,"props":13202,"children":13203},{},[13204,13206,13212,13214,13219,13221,13227,13229,13235],{"type":55,"value":13205},"Now that we have GitHub secrets configured, we can run the ",{"type":49,"tag":326,"props":13207,"children":13209},{"className":13208},[],[13210],{"type":55,"value":13211},"shared_resources_create_update.yml",{"type":55,"value":13213}," GitHub Actions workflow. This will create  shared resources environment in which we can build our ad hoc environments. This workflow requires a name (e.g. ",{"type":49,"tag":326,"props":13215,"children":13217},{"className":13216},[],[13218],{"type":55,"value":34},{"type":55,"value":13220},"). This require that we create a ",{"type":49,"tag":326,"props":13222,"children":13224},{"className":13223},[],[13225],{"type":55,"value":13226},"dev.tfvars",{"type":55,"value":13228}," file in ",{"type":49,"tag":326,"props":13230,"children":13232},{"className":13231},[],[13233],{"type":55,"value":13234},"terraform/live/shared-resources",{"type":55,"value":13236}," directory. This usually takes between 5 and 7 minutes to complete since it needs to create an RDS instance which takes a few minutes to provision.",{"type":49,"tag":430,"props":13238,"children":13240},{"id":13239},"create-an-ad-hoc-environment",[13241],{"type":55,"value":13242},"Create an ad hoc environment",{"type":49,"tag":58,"props":13244,"children":13245},{},[13246,13248,13253,13255,13261,13263,13268,13270,13276,13278,13284],{"type":55,"value":13247},"We can now create an ad hoc environment. This requires the name of the shared resources environment (e.g. ",{"type":49,"tag":326,"props":13249,"children":13251},{"className":13250},[],[13252],{"type":55,"value":34},{"type":55,"value":13254},") and the name of the ad hoc environment (e.g. ",{"type":49,"tag":326,"props":13256,"children":13258},{"className":13257},[],[13259],{"type":55,"value":13260},"brian-test",{"type":55,"value":13262},"). The only thing we need to do before creating the ",{"type":49,"tag":326,"props":13264,"children":13266},{"className":13265},[],[13267],{"type":55,"value":13260},{"type":55,"value":13269}," ad hoc environment is to create the ",{"type":49,"tag":326,"props":13271,"children":13273},{"className":13272},[],[13274],{"type":55,"value":13275},"brian-test.tfvars",{"type":55,"value":13277}," file in the ",{"type":49,"tag":326,"props":13279,"children":13281},{"className":13280},[],[13282],{"type":55,"value":13283},"terraform/live/ad-hoc/envs",{"type":55,"value":13285}," directory. This will define the versions of the application and any other environment configuration that is needed. This pipeline usually takes about 3 minutes to finish.",{"type":49,"tag":430,"props":13287,"children":13289},{"id":13288},"update-the-backend-version-in-an-ad-hoc-environment",[13290],{"type":55,"value":13291},"Update the backend version in an ad hoc environment",{"type":49,"tag":58,"props":13293,"children":13294},{},[13295,13297,13302],{"type":55,"value":13296},"Now that the backend is up and running and usable, we can update the backend version used in our ad hoc environment. This can be done by running the ",{"type":49,"tag":326,"props":13298,"children":13300},{"className":13299},[],[13301],{"type":55,"value":12717},{"type":55,"value":13303}," GitHub Actions workflow. To run this workflow you must specify:",{"type":49,"tag":64,"props":13305,"children":13306},{},[13307,13318,13329],{"type":49,"tag":68,"props":13308,"children":13309},{},[13310,13312,13317],{"type":55,"value":13311},"the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13313,"children":13315},{"className":13314},[],[13316],{"type":55,"value":34},{"type":55,"value":616},{"type":49,"tag":68,"props":13319,"children":13320},{},[13321,13323,13328],{"type":55,"value":13322},"the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13324,"children":13326},{"className":13325},[],[13327],{"type":55,"value":13260},{"type":55,"value":616},{"type":49,"tag":68,"props":13330,"children":13331},{},[13332,13334,13340],{"type":55,"value":13333},"the new version of the backend to be used (e.g. ",{"type":49,"tag":326,"props":13335,"children":13337},{"className":13336},[],[13338],{"type":55,"value":13339},"v1.0.2",{"type":55,"value":616},{"type":49,"tag":58,"props":13342,"children":13343},{},[13344,13346,13351],{"type":55,"value":13345},"The backend version should already have been built and pushed to the ECR repository using the ",{"type":49,"tag":326,"props":13347,"children":13349},{"className":13348},[],[13350],{"type":55,"value":13005},{"type":55,"value":13352}," GitHub Actions workflow.",{"type":49,"tag":430,"props":13354,"children":13356},{"id":13355},"use-ecs-exec-to-access-a-django-shell-in-a-running-container",[13357],{"type":55,"value":13358},"Use ECS Exec to access a Django shell in a running container",{"type":49,"tag":58,"props":13360,"children":13361},{},[13362,13364,13370,13372,13377],{"type":55,"value":13363},"Instead of SSHing into the container, we can use the ",{"type":49,"tag":326,"props":13365,"children":13367},{"className":13366},[],[13368],{"type":55,"value":13369},"ecs-exec",{"type":55,"value":13371}," command to access a shell in the container. This is useful for debugging and testing. One of the outputs of the ad hoc environment terraform configuration contains the script needed to run the ",{"type":49,"tag":326,"props":13373,"children":13375},{"className":13374},[],[13376],{"type":55,"value":13369},{"type":55,"value":13378}," command:",{"type":49,"tag":1050,"props":13380,"children":13382},{"code":13381,"language":2728,"meta":8,"className":2729,"style":8},"TASK_ARN=$(aws ecs list-tasks \\\n  --cluster alpha-cluster \\\n  --service-name  alpha-gunicorn | jq -r '.taskArns | .[0]' \\\n)\naws ecs execute-command --cluster alpha-cluster \\\n    --task $TASK_ARN \\\n    --container gunicorn \\\n    --interactive \\\n    --command \"/bin/bash\"\n",[13383],{"type":49,"tag":326,"props":13384,"children":13385},{"__ignoreMap":8},[13386,13419,13435,13470,13477,13506,13523,13540,13552],{"type":49,"tag":1060,"props":13387,"children":13388},{"class":1062,"line":1063},[13389,13394,13398,13402,13406,13410,13415],{"type":49,"tag":1060,"props":13390,"children":13391},{"style":1073},[13392],{"type":55,"value":13393},"TASK_ARN",{"type":49,"tag":1060,"props":13395,"children":13396},{"style":2194},[13397],{"type":55,"value":3068},{"type":49,"tag":1060,"props":13399,"children":13400},{"style":1073},[13401],{"type":55,"value":10220},{"type":49,"tag":1060,"props":13403,"children":13404},{"style":1067},[13405],{"type":55,"value":20},{"type":49,"tag":1060,"props":13407,"children":13408},{"style":2215},[13409],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13411,"children":13412},{"style":2215},[13413],{"type":55,"value":13414}," list-tasks",{"type":49,"tag":1060,"props":13416,"children":13417},{"style":2287},[13418],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13420,"children":13421},{"class":1062,"line":1079},[13422,13426,13431],{"type":49,"tag":1060,"props":13423,"children":13424},{"style":2287},[13425],{"type":55,"value":11983},{"type":49,"tag":1060,"props":13427,"children":13428},{"style":2215},[13429],{"type":55,"value":13430}," alpha-cluster",{"type":49,"tag":1060,"props":13432,"children":13433},{"style":2287},[13434],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13436,"children":13437},{"class":1062,"line":1088},[13438,13443,13448,13453,13457,13461,13466],{"type":49,"tag":1060,"props":13439,"children":13440},{"style":2287},[13441],{"type":55,"value":13442},"  --service-name",{"type":49,"tag":1060,"props":13444,"children":13445},{"style":2215},[13446],{"type":55,"value":13447},"  alpha-gunicorn",{"type":49,"tag":1060,"props":13449,"children":13450},{"style":2194},[13451],{"type":55,"value":13452}," |",{"type":49,"tag":1060,"props":13454,"children":13455},{"style":1067},[13456],{"type":55,"value":10307},{"type":49,"tag":1060,"props":13458,"children":13459},{"style":2287},[13460],{"type":55,"value":10312},{"type":49,"tag":1060,"props":13462,"children":13463},{"style":2215},[13464],{"type":55,"value":13465}," '.taskArns | .[0]'",{"type":49,"tag":1060,"props":13467,"children":13468},{"style":2287},[13469],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13471,"children":13472},{"class":1062,"line":1097},[13473],{"type":49,"tag":1060,"props":13474,"children":13475},{"style":1073},[13476],{"type":55,"value":5126},{"type":49,"tag":1060,"props":13478,"children":13479},{"class":1062,"line":1111},[13480,13484,13488,13493,13498,13502],{"type":49,"tag":1060,"props":13481,"children":13482},{"style":1067},[13483],{"type":55,"value":20},{"type":49,"tag":1060,"props":13485,"children":13486},{"style":2215},[13487],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13489,"children":13490},{"style":2215},[13491],{"type":55,"value":13492}," execute-command",{"type":49,"tag":1060,"props":13494,"children":13495},{"style":2287},[13496],{"type":55,"value":13497}," --cluster",{"type":49,"tag":1060,"props":13499,"children":13500},{"style":2215},[13501],{"type":55,"value":13430},{"type":49,"tag":1060,"props":13503,"children":13504},{"style":2287},[13505],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13507,"children":13508},{"class":1062,"line":1120},[13509,13514,13519],{"type":49,"tag":1060,"props":13510,"children":13511},{"style":2287},[13512],{"type":55,"value":13513},"    --task",{"type":49,"tag":1060,"props":13515,"children":13516},{"style":1073},[13517],{"type":55,"value":13518}," $TASK_ARN ",{"type":49,"tag":1060,"props":13520,"children":13521},{"style":2287},[13522],{"type":55,"value":10258},{"type":49,"tag":1060,"props":13524,"children":13525},{"class":1062,"line":1128},[13526,13531,13536],{"type":49,"tag":1060,"props":13527,"children":13528},{"style":2287},[13529],{"type":55,"value":13530},"    --container",{"type":49,"tag":1060,"props":13532,"children":13533},{"style":2215},[13534],{"type":55,"value":13535}," gunicorn",{"type":49,"tag":1060,"props":13537,"children":13538},{"style":2287},[13539],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13541,"children":13542},{"class":1062,"line":1141},[13543,13548],{"type":49,"tag":1060,"props":13544,"children":13545},{"style":2287},[13546],{"type":55,"value":13547},"    --interactive",{"type":49,"tag":1060,"props":13549,"children":13550},{"style":2287},[13551],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13553,"children":13554},{"class":1062,"line":1150},[13555,13560],{"type":49,"tag":1060,"props":13556,"children":13557},{"style":2287},[13558],{"type":55,"value":13559},"    --command",{"type":49,"tag":1060,"props":13561,"children":13562},{"style":2215},[13563],{"type":55,"value":13564}," \"/bin/bash\"\n",{"type":49,"tag":58,"props":13566,"children":13567},{},[13568],{"type":55,"value":13569},"You will then have a shell in the container:",{"type":49,"tag":1050,"props":13571,"children":13573},{"code":13572},"The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.\n\n\nStarting session with SessionId: ecs-execute-command-073d1947fa71c058c\nroot@ip-10-0-2-167:/code# python manage.py shell\nPython 3.9.9 (main, Dec 21 2021, 10:03:34)\n[GCC 10.2.1 20210110] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>>\n",[13574],{"type":49,"tag":326,"props":13575,"children":13576},{"__ignoreMap":8},[13577],{"type":55,"value":13572},{"type":49,"tag":430,"props":13579,"children":13581},{"id":13580},"destroy-an-ad-hoc-environment",[13582],{"type":55,"value":13583},"Destroy an ad hoc environment",{"type":49,"tag":58,"props":13585,"children":13586},{},[13587,13589,13595,13597,13602,13604,13609],{"type":55,"value":13588},"Use the ",{"type":49,"tag":326,"props":13590,"children":13592},{"className":13591},[],[13593],{"type":55,"value":13594},"ad_hoc_env_destroy.yml",{"type":55,"value":13596}," GitHub Actions workflow to destroy an ad hoc environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13598,"children":13600},{"className":13599},[],[13601],{"type":55,"value":34},{"type":55,"value":13603},") and the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13605,"children":13607},{"className":13606},[],[13608],{"type":55,"value":13260},{"type":55,"value":3213},{"type":49,"tag":430,"props":13611,"children":13613},{"id":13612},"destroy-the-shared-resources-environment",[13614],{"type":55,"value":13615},"Destroy the shared resources environment",{"type":49,"tag":58,"props":13617,"children":13618},{},[13619,13620,13626,13628,13633],{"type":55,"value":13588},{"type":49,"tag":326,"props":13621,"children":13623},{"className":13622},[],[13624],{"type":55,"value":13625},"shared_resources_destroy.yml",{"type":55,"value":13627}," GitHub Actions workflow to destroy the shared resources environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13629,"children":13631},{"className":13630},[],[13632],{"type":55,"value":34},{"type":55,"value":3213},{"type":49,"tag":58,"props":13635,"children":13636},{},[13637],{"type":55,"value":13638},"This defines the full lifecycle of creating and destroying ad hoc environments.",{"type":49,"tag":50,"props":13640,"children":13642},{"id":13641},"future-improvements-open-questions-and-next-steps",[13643],{"type":55,"value":13644},"Future improvements, open questions and next steps",{"type":49,"tag":430,"props":13646,"children":13648},{"id":13647},"enhanced-security",[13649],{"type":55,"value":13650},"Enhanced Security",{"type":49,"tag":58,"props":13652,"children":13653},{},[13654],{"type":55,"value":13655},"The low hanging fruit here is to use least privilege (for roles used in automation) and to define all roles with IaC. Currently I am using Admin roles for the credentials I store in GitHub which is a shortcut to using IaC and is not a best practice.",{"type":49,"tag":430,"props":13657,"children":13659},{"id":13658},"keeping-track-of-ad-hoc-environments",[13660],{"type":55,"value":13661},"Keeping track of ad hoc environments",{"type":49,"tag":58,"props":13663,"children":13664},{},[13665],{"type":55,"value":13666},"We need to think about how we can keep track of our active ad hoc environments. Active environments will incur additional AWS costs, and we do not want developers or the product team to create lots of environments and then leave them running without actively using them.",{"type":49,"tag":58,"props":13668,"children":13669},{},[13670],{"type":55,"value":13671},"We may decide to have some long-lived ad hoc environments, but those would be managed primarily by the DevOps team and respective owners (e.g. QA, product team, etc.).",{"type":49,"tag":58,"props":13673,"children":13674},{},[13675],{"type":55,"value":13676},"One way to check the active ad hoc environments would be to use the AWS CLI. We could list the ECS clusters in our development account, and this would show the number of ad hoc environments running. We could go farther and list the ad hoc environments by when they were last updated. We could then request developers or team members to remove ad hoc environments that are not in use.",{"type":49,"tag":58,"props":13678,"children":13679},{},[13680],{"type":55,"value":13681},"Or we could have a policy that all ad-hoc environments are deleted automatically at the end of each week.",{"type":49,"tag":430,"props":13683,"children":13685},{"id":13684},"terraform-tooling",[13686],{"type":55,"value":13687},"Terraform Tooling",{"type":49,"tag":64,"props":13689,"children":13690},{},[13691,13696,13701,13706],{"type":49,"tag":68,"props":13692,"children":13693},{},[13694],{"type":55,"value":13695},"Testing Terraform Code",{"type":49,"tag":68,"props":13697,"children":13698},{},[13699],{"type":55,"value":13700},"Testing GitHub Actions",{"type":49,"tag":68,"props":13702,"children":13703},{},[13704],{"type":55,"value":13705},"Using advanced Terraform frameworks like Terragrunt",{"type":49,"tag":68,"props":13707,"children":13708},{},[13709],{"type":55,"value":13710},"Using Terraform Cloud for more advanced Terraform features",{"type":49,"tag":430,"props":13712,"children":13714},{"id":13713},"more-secure-way-of-defining-rds-username-and-password",[13715],{"type":55,"value":13716},"More secure way of defining RDS username and password",{"type":49,"tag":58,"props":13718,"children":13719},{},[13720],{"type":55,"value":13721},"Currently the postgres database does not have a secure password. It is both hardcoded in the module as a default value and it will also be saved in plaintext in the Terraform state file.",{"type":49,"tag":430,"props":13723,"children":13725},{"id":13724},"backend-application-update-script",[13726],{"type":55,"value":13727},"Backend application update script",{"type":49,"tag":58,"props":13729,"children":13730},{},[13731],{"type":55,"value":13732},"The script used for updating the backend application could be improved or broken up into multiple scripts to better handle errors and failures that happen during the pipeline. The script runs several different commands and could potentially fail at any step, so it would be nice to improve the error messages so that both developers and DevOps teams can more quickly diagnose pipeline failures.",{"type":49,"tag":430,"props":13734,"children":13736},{"id":13735},"limiting-traffic-to-ad-hoc-environments-to-a-vpn",[13737],{"type":55,"value":13738},"Limiting traffic to ad hoc environments to a VPN",{"type":49,"tag":58,"props":13740,"children":13741},{},[13742],{"type":55,"value":13743},"Another good next step would be to show how we can limit traffic to ad hoc environments to a VPN.",{"type":49,"tag":430,"props":13745,"children":13747},{"id":13746},"figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas",[13748],{"type":55,"value":13749},"Figure out how many ad hoc environments we can create with the default quotas",{"type":49,"tag":58,"props":13751,"children":13752},{},[13753],{"type":55,"value":13754},"AWS accounts limit the number of resources you can create, but for most of this quota limits you can request an increase per account. I need to figure out how many ad hoc environments I can create with the default quotas.",{"type":49,"tag":430,"props":13756,"children":13758},{"id":13757},"code-repo-organization",[13759],{"type":55,"value":13760},"Code Repo Organization",{"type":49,"tag":58,"props":13762,"children":13763},{},[13764,13766,13771,13773,13778],{"type":55,"value":13765},"One minor improvement would be to move the ",{"type":49,"tag":326,"props":13767,"children":13769},{"className":13768},[],[13770],{"type":55,"value":16},{"type":55,"value":13772}," directory out of the ",{"type":49,"tag":326,"props":13774,"children":13776},{"className":13775},[],[13777],{"type":55,"value":1627},{"type":55,"value":13779}," monorepo into a dedicated repo. We may also want to move GitHub Actions for creating, updating and destroying environments to this new repo. For early stage development, using a single repository that stores both application code and Terraform configuration works, but it would be better to keep these separate at the repository level as the project grows.",{"type":49,"tag":430,"props":13781,"children":13783},{"id":13782},"multiple-aws-accounts",[13784],{"type":55,"value":13785},"Multiple AWS Accounts",{"type":49,"tag":58,"props":13787,"children":13788},{},[13789],{"type":55,"value":13790},"Everything shown here uses a single AWS account: ECR images, Terraform remote state storage, all shared resource environments and all ad hoc environments. Using one account keeps things simple for a demonstration of this workflow, but in practice it would be beneficial to use multiple AWS accounts for different purposes. This would also involve more carefully planned IAM roles for cross-account resource access.",{"type":49,"tag":430,"props":13792,"children":13794},{"id":13793},"modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments",[13795],{"type":55,"value":13796},"Modules for stable environments to be used for long-lived pre-production and production environments",{"type":49,"tag":58,"props":13798,"children":13799},{},[13800],{"type":55,"value":13801},"This article looked at how to make tradeoffs between costs, speed of deployment and production parity in ad hoc environments. I'm interested in building a new set of modules that can be used to set up environments that:",{"type":49,"tag":64,"props":13803,"children":13804},{},[13805,13810,13815,13820,13825],{"type":49,"tag":68,"props":13806,"children":13807},{},[13808],{"type":55,"value":13809},"are more stable and more long-lived",{"type":49,"tag":68,"props":13811,"children":13812},{},[13813],{"type":55,"value":13814},"have less resource sharing (dedicated RDS and ElastiCache resources)",{"type":49,"tag":68,"props":13816,"children":13817},{},[13818],{"type":55,"value":13819},"implement autoscaling for load-testing (or maybe implement autoscaling for ad hoc environments)",{"type":49,"tag":68,"props":13821,"children":13822},{},[13823],{"type":55,"value":13824},"can be used to perform load testing",{"type":49,"tag":68,"props":13826,"children":13827},{},[13828],{"type":55,"value":13829},"have enhanced observability tooling",{"type":49,"tag":58,"props":13831,"children":13832},{},[13833],{"type":55,"value":13834},"These environments might be used as part of a QA process that does a final sign-off on a new set of features scheduled for deployment to production environments, for example.",{"type":49,"tag":50,"props":13836,"children":13837},{"id":7730},[13838],{"type":55,"value":7733},{"type":49,"tag":58,"props":13840,"children":13841},{},[13842],{"type":55,"value":13843},"This wraps up the tour of my ad hoc environment infrastructure automation. Thank you for having a read through my article. If you have a similar (or different) approach to building ad hoc environments, I would love to hear about it.",{"type":49,"tag":7749,"props":13845,"children":13846},{},[13847],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":13849},[13850,13851,13852,13853,13854,13861,13862,13866,13875,13879,13883,13890,13906,13918],{"id":52,"depth":1079,"text":56},{"id":7862,"depth":1079,"text":7865},{"id":7987,"depth":1079,"text":7990},{"id":8099,"depth":1079,"text":8102},{"id":8110,"depth":1079,"text":8113,"children":13855},[13856,13857,13858,13859,13860],{"id":8159,"depth":1088,"text":8162},{"id":8347,"depth":1088,"text":8350},{"id":8427,"depth":1088,"text":8430},{"id":8499,"depth":1088,"text":8502},{"id":8580,"depth":1088,"text":8583},{"id":8678,"depth":1079,"text":8681},{"id":8900,"depth":1079,"text":8903,"children":13863},[13864,13865],{"id":8930,"depth":1088,"text":8933},{"id":8989,"depth":1088,"text":8992},{"id":9068,"depth":1079,"text":9071,"children":13867},[13868,13869,13870,13871,13872,13873,13874],{"id":2091,"depth":1088,"text":2094},{"id":9104,"depth":1088,"text":9107},{"id":2160,"depth":1088,"text":2017},{"id":9183,"depth":1088,"text":9186},{"id":9194,"depth":1088,"text":9197},{"id":9205,"depth":1088,"text":2022},{"id":2683,"depth":1088,"text":2032},{"id":9245,"depth":1079,"text":9248,"children":13876},[13877,13878],{"id":2877,"depth":1088,"text":2880},{"id":9265,"depth":1088,"text":9268},{"id":9330,"depth":1079,"text":9333,"children":13880},[13881,13882],{"id":9341,"depth":1088,"text":9344},{"id":9464,"depth":1088,"text":9467},{"id":9541,"depth":1079,"text":9544,"children":13884},[13885,13886,13887,13889],{"id":9671,"depth":1088,"text":9674},{"id":9721,"depth":1088,"text":9724},{"id":12729,"depth":1088,"text":13888},"Using ignore_changes in the definitions",{"id":12860,"depth":1088,"text":12863},{"id":12935,"depth":1079,"text":12938,"children":13891},[13892,13893,13895,13896,13897,13898,13899,13900,13901,13902,13903,13904,13905],{"id":12946,"depth":1088,"text":12949},{"id":12957,"depth":1088,"text":13894},"Run the make tf-bootstrap command",{"id":12984,"depth":1088,"text":12987},{"id":13017,"depth":1088,"text":13020},{"id":13028,"depth":1088,"text":13031},{"id":13039,"depth":1088,"text":13042},{"id":13050,"depth":1088,"text":13053},{"id":13197,"depth":1088,"text":13200},{"id":13239,"depth":1088,"text":13242},{"id":13288,"depth":1088,"text":13291},{"id":13355,"depth":1088,"text":13358},{"id":13580,"depth":1088,"text":13583},{"id":13612,"depth":1088,"text":13615},{"id":13641,"depth":1079,"text":13644,"children":13907},[13908,13909,13910,13911,13912,13913,13914,13915,13916,13917],{"id":13647,"depth":1088,"text":13650},{"id":13658,"depth":1088,"text":13661},{"id":13684,"depth":1088,"text":13687},{"id":13713,"depth":1088,"text":13716},{"id":13724,"depth":1088,"text":13727},{"id":13735,"depth":1088,"text":13738},{"id":13746,"depth":1088,"text":13749},{"id":13757,"depth":1088,"text":13760},{"id":13782,"depth":1088,"text":13785},{"id":13793,"depth":1088,"text":13796},{"id":7730,"depth":1079,"text":7733},"content:2022:03:27:ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",{"_path":13923,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":13924,"description":13925,"date":13926,"image":13927,"tags":13928,"body":13932,"_type":7809,"_id":14528,"_source":7811,"_file":14529,"_stem":14530,"_extension":7814},"/2020/12/27/building-web-applications-with-django-drf-and-nuxt","Building web applications with Django, Django REST Framework, Nuxt.js and docker","This article documents my progress combining the Django web framework with Nuxt JS to build applications that have both great SEO and a smooth SPA user experience.","2020-12-27T00:00:00.000Z","/static/django_nuxt_app_diagram.png",[14,13929,13930,13931,24],"vue","nuxt","drf",{"type":46,"children":13933,"toc":14521},[13934,13939,13970,13981,13986,13993,13999,14004,14031,14036,14041,14046,14058,14063,14068,14074,14110,14130,14434,14440,14445,14450,14456,14487,14492,14498,14511,14516],{"type":49,"tag":58,"props":13935,"children":13936},{},[13937],{"type":55,"value":13938},"Over the holidays between lots of big meals and many naps, I tried to tackle one more goal of mine before this year come to an end: building an application with Django and Nuxt.js.",{"type":49,"tag":58,"props":13940,"children":13941},{},[13942,13944,13951,13953,13959,13961,13968],{"type":55,"value":13943},"This year I rebuilt my personal blog (",{"type":49,"tag":80,"props":13945,"children":13948},{"href":13946,"rel":13947},"https://briancaffey.github.io/",[84],[13949],{"type":55,"value":13950},"briancaffey.github.io",{"type":55,"value":13952},") with Nuxt.js, the ",{"type":49,"tag":326,"props":13954,"children":13956},{"className":13955},[],[13957],{"type":55,"value":13958},"@nuxt/content",{"type":55,"value":13960}," headless git-based CMS and TailwindCSS. It is statically generated with Nuxt's full-static mode and has been really enjoyable to work with. I have also learned a lot more about SEO and how Nuxt helps improve Vue applications' SEO. I have also been working a lot with Django and Vue.js applications where Django serves as an API to a Vue.js SPA. This combination of technologies works well for a lot of use cases, but it falls short in SEO. Nuxt also provides a great way to organize large Vue.js projects which I have been finding very helpful. For these reasons, combining Django and Nuxt has been something that I have wanted to try for a while, so this article will share some of my experiences in recent efforts to build with these two frameworks. I took ",{"type":49,"tag":80,"props":13962,"children":13965},{"href":13963,"rel":13964},"https://gitlab.com/briancaffey/django-nuxt-starter/-/blob/develop/STEP_BY_STEP.md",[84],[13966],{"type":55,"value":13967},"detailed notes of each step of the project setup",{"type":55,"value":13969}," starting from an empty repository, and I put together a diagram of my understanding of how data flows in the application.",{"type":49,"tag":58,"props":13971,"children":13972},{},[13973,13975],{"type":55,"value":13974},"Here's the link to the project repository that I'll be referencing: ",{"type":49,"tag":80,"props":13976,"children":13979},{"href":13977,"rel":13978},"https://gitlab.com/briancaffey/django-nuxt-starter",[84],[13980],{"type":55,"value":13977},{"type":49,"tag":58,"props":13982,"children":13983},{},[13984],{"type":55,"value":13985},"This article will focus on explaining the project through the diagram shown below. I added two types of labels: letters and numbers. The letters will introduce each component of the application and its role in the application as a whole. The numbers summarize how data flows through the different components in my sample blog application.",{"type":49,"tag":58,"props":13987,"children":13988},{},[13989],{"type":49,"tag":1601,"props":13990,"children":13992},{"alt":13991,"src":13927},"Diagram",[],{"type":49,"tag":50,"props":13994,"children":13996},{"id":13995},"diagram-components",[13997],{"type":55,"value":13998},"Diagram components",{"type":49,"tag":58,"props":14000,"children":14001},{},[14002],{"type":55,"value":14003},"A. Your computer - Possibly also your development machine which is running the application in docker containers with docker-compose.",{"type":49,"tag":58,"props":14005,"children":14006},{},[14007,14009,14015,14016,14022,14023,14029],{"type":55,"value":14008},"B. NGINX - This is the \"front desk\" of the application that does a few different things. It is the first component that web requests come to. It serves as a reverse proxy which does path-based routing. It looks at the URL request and determines where to send it. For example: ",{"type":49,"tag":326,"props":14010,"children":14012},{"className":14011},[],[14013],{"type":55,"value":14014},"/api/posts/1",{"type":55,"value":873},{"type":49,"tag":326,"props":14017,"children":14019},{"className":14018},[],[14020],{"type":55,"value":14021},"/dashboard/",{"type":55,"value":873},{"type":49,"tag":326,"props":14024,"children":14026},{"className":14025},[],[14027],{"type":55,"value":14028},"/admin/",{"type":55,"value":14030}," could all be routed differently depending on the NGINX configuration file. We will look at this again in the next section. This  component, like most of the other things in the diagram, runs in a container. NGINX can also serve static files for our Django app and do TLS termination to make our application available over a secure HTTPS connection.",{"type":49,"tag":58,"props":14032,"children":14033},{},[14034],{"type":55,"value":14035},"C. Nuxt.JS server - The first \"S\" in SSR (server side rendering). It is a Node.js process that renders HTML from Vue components that we define in our Nuxt app, as well as data fetched from other servers/APIs before returning HTML back to the client.",{"type":49,"tag":58,"props":14037,"children":14038},{},[14039],{"type":55,"value":14040},"D. Django server - This runs the WSGI application with a gunicorn process in a container.",{"type":49,"tag":58,"props":14042,"children":14043},{},[14044],{"type":55,"value":14045},"E. Django REST Framework is a Django package the facilitates the creation of REST API endpoints. This is part of the Django application, it primarily takes care of data serialization (which can be thought of as translating between JSON and Python objects that represent rows of data in our Postgres database)",{"type":49,"tag":58,"props":14047,"children":14048},{},[14049,14051,14057],{"type":55,"value":14050},"F. This is the Postgres database, also a containerized service. It is on the same docker network as the Django/gunicorn application, so the Django application can connect to the Postgres database using the hostname ",{"type":49,"tag":326,"props":14052,"children":14054},{"className":14053},[],[14055],{"type":55,"value":14056},"postgres",{"type":55,"value":745},{"type":49,"tag":58,"props":14059,"children":14060},{},[14061],{"type":55,"value":14062},"G. docker-compose is used to orchestrate the docker network, containers and volumes that make up the application.",{"type":49,"tag":58,"props":14064,"children":14065},{},[14066],{"type":55,"value":14067},"H. This box represents the docker network that allows for easy networking between services. We will come back to this the significance of this in the next section.",{"type":49,"tag":50,"props":14069,"children":14071},{"id":14070},"data-flow-in-the-application",[14072],{"type":55,"value":14073},"Data flow in the application",{"type":49,"tag":58,"props":14075,"children":14076},{},[14077,14079,14085,14087,14093,14095,14101,14103,14109],{"type":55,"value":14078},"The simple application I have built for this demonstration is a blog. There is only a list view and a detail view for simple blog post model with three fields: title, body and created date. For the list view, the frontend (Nuxt) route is ",{"type":49,"tag":326,"props":14080,"children":14082},{"className":14081},[],[14083],{"type":55,"value":14084},"/posts/",{"type":55,"value":14086}," and the backend route is ",{"type":49,"tag":326,"props":14088,"children":14090},{"className":14089},[],[14091],{"type":55,"value":14092},"/api/posts/",{"type":55,"value":14094}," for the detail view the frontend route is ",{"type":49,"tag":326,"props":14096,"children":14098},{"className":14097},[],[14099],{"type":55,"value":14100},"/posts/_id",{"type":55,"value":14102}," and the API route is ",{"type":49,"tag":326,"props":14104,"children":14106},{"className":14105},[],[14107],{"type":55,"value":14108},"/api/posts/_id/",{"type":55,"value":745},{"type":49,"tag":58,"props":14111,"children":14112},{},[14113,14115,14121,14123,14129],{"type":55,"value":14114},"The data flow shown here will walk through what happens when a user visits ",{"type":49,"tag":326,"props":14116,"children":14118},{"className":14117},[],[14119],{"type":55,"value":14120},"http://localhost/posts/",{"type":55,"value":14122},", and then show what happens when the user clicks on one of the listed posts to see the detail view of the post (",{"type":49,"tag":326,"props":14124,"children":14126},{"className":14125},[],[14127],{"type":55,"value":14128},"http://localhost/posts/2",{"type":55,"value":3213},{"type":49,"tag":8994,"props":14131,"children":14133},{"start":14132},0,[14134,14145,14157,14175,14188,14239,14267,14286,14291,14296,14307,14398],{"type":49,"tag":68,"props":14135,"children":14136},{},[14137,14143],{"type":49,"tag":326,"props":14138,"children":14140},{"className":14139},[],[14141],{"type":55,"value":14142},"docker-compose up",{"type":55,"value":14144}," is one command that is used to start the entire application in local development. This exposes the NGINX process on port 80 of the host machine (your laptop).",{"type":49,"tag":68,"props":14146,"children":14147},{},[14148,14150,14155],{"type":55,"value":14149},"When the application is running on your machine and you navigate to ",{"type":49,"tag":326,"props":14151,"children":14153},{"className":14152},[],[14154],{"type":55,"value":14120},{"type":55,"value":14156},", the request is first handled by NGINX.",{"type":49,"tag":68,"props":14158,"children":14159},{},[14160,14162,14167,14168,14173],{"type":55,"value":14161},"As we mentioned earlier, NGINX's path-based routing sends all requests that do not start with ",{"type":49,"tag":326,"props":14163,"children":14165},{"className":14164},[],[14166],{"type":55,"value":3196},{"type":55,"value":8634},{"type":49,"tag":326,"props":14169,"children":14171},{"className":14170},[],[14172],{"type":55,"value":3203},{"type":55,"value":14174}," to the Nuxt.js server.",{"type":49,"tag":68,"props":14176,"children":14177},{},[14178,14180,14186],{"type":55,"value":14179},"When the request gets to the Nuxt server, the Nuxt lifecycle methods start. The important one that I'm using so far is ",{"type":49,"tag":326,"props":14181,"children":14183},{"className":14182},[],[14184],{"type":55,"value":14185},"asyncData",{"type":55,"value":14187},". This property is used to request data that will be used in the rendering of our HTML response.",{"type":49,"tag":68,"props":14189,"children":14190},{},[14191,14193,14198,14200,14205,14207,14213,14215,14221,14223,14229,14231,14237],{"type":55,"value":14192},"Inside of ",{"type":49,"tag":326,"props":14194,"children":14196},{"className":14195},[],[14197],{"type":55,"value":14185},{"type":55,"value":14199},", the application uses axios to make a request to ",{"type":49,"tag":326,"props":14201,"children":14203},{"className":14202},[],[14204],{"type":55,"value":14092},{"type":55,"value":14206}," (for example). In ",{"type":49,"tag":326,"props":14208,"children":14210},{"className":14209},[],[14211],{"type":55,"value":14212},"nuxt.config.js",{"type":55,"value":14214},", the ",{"type":49,"tag":326,"props":14216,"children":14218},{"className":14217},[],[14219],{"type":55,"value":14220},"privateRuntimeConfig",{"type":55,"value":14222}," sets a baseUrl value for axios to ",{"type":49,"tag":326,"props":14224,"children":14226},{"className":14225},[],[14227],{"type":55,"value":14228},"http://backend:8000",{"type":55,"value":14230},". Since the Nuxt server is on the same docker network as the backend Django/gunicorn server, the Nuxt server is able to resolve ",{"type":49,"tag":326,"props":14232,"children":14234},{"className":14233},[],[14235],{"type":55,"value":14236},"http://backend",{"type":55,"value":14238}," to the address of the backend server.",{"type":49,"tag":68,"props":14240,"children":14241},{},[14242,14244,14250,14252,14258,14260,14266],{"type":55,"value":14243},"Django processes this endpoint, using the ",{"type":49,"tag":326,"props":14245,"children":14247},{"className":14246},[],[14248],{"type":55,"value":14249},"PostViewSet",{"type":55,"value":14251},", the views of which have been added to ",{"type":49,"tag":326,"props":14253,"children":14255},{"className":14254},[],[14256],{"type":55,"value":14257},"urlpatterns",{"type":55,"value":14259}," in ",{"type":49,"tag":326,"props":14261,"children":14263},{"className":14262},[],[14264],{"type":55,"value":14265},"blog/urls.py",{"type":55,"value":745},{"type":49,"tag":68,"props":14268,"children":14269},{},[14270,14271,14276,14278,14284],{"type":55,"value":413},{"type":49,"tag":326,"props":14272,"children":14274},{"className":14273},[],[14275],{"type":55,"value":14249},{"type":55,"value":14277}," makes a database query on the ",{"type":49,"tag":326,"props":14279,"children":14281},{"className":14280},[],[14282],{"type":55,"value":14283},"posts",{"type":55,"value":14285}," which is used to serialize the data.",{"type":49,"tag":68,"props":14287,"children":14288},{},[14289],{"type":55,"value":14290},"The Django server returns the response to the original axios call.",{"type":49,"tag":68,"props":14292,"children":14293},{},[14294],{"type":55,"value":14295},"The data returned from Django is used to render the HTML response.",{"type":49,"tag":68,"props":14297,"children":14298},{},[14299,14301,14306],{"type":55,"value":14300},"The HTML response from the Nuxt server is sent back to the browser that originally navigated to ",{"type":49,"tag":326,"props":14302,"children":14304},{"className":14303},[],[14305],{"type":55,"value":14120},{"type":55,"value":745},{"type":49,"tag":68,"props":14308,"children":14309},{},[14310,14312,14318,14320,14326,14328,14334,14336,14342,14344,14350,14352,14357,14359,14365,14367,14373,14375,14381,14383,14389,14391,14396],{"type":55,"value":14311},"The user is presented with page that lists blog posts. Each blog posts lists to a detail view. When a blog post (let's say the post with ",{"type":49,"tag":326,"props":14313,"children":14315},{"className":14314},[],[14316],{"type":55,"value":14317},"id",{"type":55,"value":14319}," of 2) is clicked on, a request for ",{"type":49,"tag":326,"props":14321,"children":14323},{"className":14322},[],[14324],{"type":55,"value":14325},"/posts/2/",{"type":55,"value":14327}," is made directly to the Django backend. The ",{"type":49,"tag":326,"props":14329,"children":14331},{"className":14330},[],[14332],{"type":55,"value":14333},"browserBaseURL",{"type":55,"value":14335}," value in the ",{"type":49,"tag":326,"props":14337,"children":14339},{"className":14338},[],[14340],{"type":55,"value":14341},"axios",{"type":55,"value":14343}," settings under ",{"type":49,"tag":326,"props":14345,"children":14347},{"className":14346},[],[14348],{"type":55,"value":14349},"publicRuntimeConfig",{"type":55,"value":14351}," defined in ",{"type":49,"tag":326,"props":14353,"children":14355},{"className":14354},[],[14356],{"type":55,"value":14212},{"type":55,"value":14358}," is set to ",{"type":49,"tag":326,"props":14360,"children":14362},{"className":14361},[],[14363],{"type":55,"value":14364},"http://localhost",{"type":55,"value":14366},", so the request is made to ",{"type":49,"tag":326,"props":14368,"children":14370},{"className":14369},[],[14371],{"type":55,"value":14372},"http://localhost/api/posts/2/",{"type":55,"value":14374},". To clarify, since we are making this request using axios in the browser, we can't make a request to ",{"type":49,"tag":326,"props":14376,"children":14378},{"className":14377},[],[14379],{"type":55,"value":14380},"http://backend:8000/api/posts/2/",{"type":55,"value":14382}," like we did in step 4 (",{"type":49,"tag":326,"props":14384,"children":14386},{"className":14385},[],[14387],{"type":55,"value":14388},"http://backend:8000/api/posts/",{"type":55,"value":14390},") because the browser doesn't know how to resolve the ",{"type":49,"tag":326,"props":14392,"children":14394},{"className":14393},[],[14395],{"type":55,"value":1951},{"type":55,"value":14397}," hostname.",{"type":49,"tag":68,"props":14399,"children":14400},{},[14401,14403,14408,14410,14416,14418,14424,14426,14432],{"type":55,"value":14402},"This request to ",{"type":49,"tag":326,"props":14404,"children":14406},{"className":14405},[],[14407],{"type":55,"value":14372},{"type":55,"value":14409},", like all others, first goes to NGINX which sends it to the backend since the path starts with ",{"type":49,"tag":326,"props":14411,"children":14413},{"className":14412},[],[14414],{"type":55,"value":14415},"/api/",{"type":55,"value":14417},". At this point the application functions like a regular Vue SPA making axios calls to a backend service. This is because we used ",{"type":49,"tag":326,"props":14419,"children":14421},{"className":14420},[],[14422],{"type":55,"value":14423},"\u003Cnuxt-link>",{"type":55,"value":14425}," for the posts listed in the posts list view. If we used ",{"type":49,"tag":326,"props":14427,"children":14429},{"className":14428},[],[14430],{"type":55,"value":14431},"\u003Ca>",{"type":55,"value":14433}," tags, we would go through the same process as in step 4 where the HTML is rendered on the Nuxt server and sent back to the browser all at once.",{"type":49,"tag":50,"props":14435,"children":14437},{"id":14436},"discussion",[14438],{"type":55,"value":14439},"Discussion",{"type":49,"tag":58,"props":14441,"children":14442},{},[14443],{"type":55,"value":14444},"My main takeaway is that using Nuxt and Django together can give you good SEO and a great SPA experience at the same time. Using Django alone, or Django with traditional non SSR Vue makes this harder to do. Being a progressive framework, there are a lot of ways to use Vue with any other backend. From what I have heard, most people use Vue via CDN similar to how jQuery was and still is delivered for use in the browser.",{"type":49,"tag":58,"props":14446,"children":14447},{},[14448],{"type":55,"value":14449},"There is additional work in setting up 3 servers for a single application (Nuxt, Django and NGINX), but the tradeoff is that I am (at least I feel) very productive writing frontend logic in Vue and backend logic with DRF. I have never liked working with Django templates and I used to know a lot more about them than I do now.",{"type":49,"tag":50,"props":14451,"children":14453},{"id":14452},"spotlight-for-baserowios-awesome-open-source-django-nuxt-application",[14454],{"type":55,"value":14455},"Spotlight for baserow.io's awesome open-source Django Nuxt application",{"type":49,"tag":58,"props":14457,"children":14458},{},[14459,14461,14468,14470,14477,14479,14485],{"type":55,"value":14460},"Lastly I want to mention that there are some great resources in the ",{"type":49,"tag":80,"props":14462,"children":14465},{"href":14463,"rel":14464},"https://github.com/nuxt-community/awesome-nuxt",[84],[14466],{"type":55,"value":14467},"nuxt-community/awesome-nuxt",{"type":55,"value":14469}," GitHub repo. There's one project that really stood out to me when I searched for \"django\" projects in the README, and that project is called ",{"type":49,"tag":80,"props":14471,"children":14474},{"href":14472,"rel":14473},"https://baserow.io/",[84],[14475],{"type":55,"value":14476},"baserow.io",{"type":55,"value":14478}," (repo: ",{"type":49,"tag":80,"props":14480,"children":14483},{"href":14481,"rel":14482},"https://gitlab.com/bramw/baserow",[84],[14484],{"type":55,"value":14481},{"type":55,"value":14486},"). Please check this repo our if you are interested in Django and Nuxt. This company is building an open source no-code database, similar to Airtable which I have worked with before.",{"type":49,"tag":58,"props":14488,"children":14489},{},[14490],{"type":55,"value":14491},"Their entire product is open source and I have been very impressed with what I have seen. Please go give that project a star or consider becoming a Github sponsor if you are interested. I'm not affiliated with that project in any way, but I'll be referencing how they use Django and Nuxt to build their application.",{"type":49,"tag":50,"props":14493,"children":14495},{"id":14494},"next-steps",[14496],{"type":55,"value":14497},"Next steps",{"type":49,"tag":58,"props":14499,"children":14500},{},[14501,14503,14509],{"type":55,"value":14502},"There is a still a lot I have to learn about Nuxt. I'm still very new to the Framework and this is my first time using Nuxt's SSR mode. Nuxt seems to have its own way of doing lots of things that I'm used to doing in Vue. There is a very supportive community and well-maintained official packages to help with lots of things, like the ",{"type":49,"tag":326,"props":14504,"children":14506},{"className":14505},[],[14507],{"type":55,"value":14508},"@nuxt/axios",{"type":55,"value":14510}," package that I'm using.",{"type":49,"tag":58,"props":14512,"children":14513},{},[14514],{"type":55,"value":14515},"My next step is to keep expanding my blog application. One thing I didn't mention is authentication. I plan on using Django session authentication for authenticating request to Django. It seems that it already works correctly in my application (logging in through Django admin and then navigating to Nuxt routes that make Django requests are working only when I'm logged in.) I think I have an idea about how Vuex, authentication and route guards will work together, but I haven't gotten there yet. If anyone has some good reference projects or recommendations on how to expand on what I already have, please let me know!",{"type":49,"tag":58,"props":14517,"children":14518},{},[14519],{"type":55,"value":14520},"I know that Nuxt has an auth module, so I need to see if that is relevant for what I want need in my application. I also need to continue reading the Nuxt documentation. I still don't know what I don't know about Nuxt and the plugins and modules that it makes available. I also noticed that Nuxt has it's own version of the Vue 3 Composition API, something I am just now starting to learn more about, so that it another area I'll need to dig into eventually.",{"title":8,"searchDepth":1079,"depth":1079,"links":14522},[14523,14524,14525,14526,14527],{"id":13995,"depth":1079,"text":13998},{"id":14070,"depth":1079,"text":14073},{"id":14436,"depth":1079,"text":14439},{"id":14452,"depth":1079,"text":14455},{"id":14494,"depth":1079,"text":14497},"content:2020:12:27:building-web-applications-with-django-drf-and-nuxt.md","2020/12/27/building-web-applications-with-django-drf-and-nuxt.md","2020/12/27/building-web-applications-with-django-drf-and-nuxt",{"_path":14532,"_dir":14533,"_draft":7,"_partial":7,"_locale":8,"title":14534,"description":14535,"date":14536,"image":14537,"tags":14538,"body":14541,"_type":7809,"_id":14759,"_source":7811,"_file":14760,"_stem":14761,"_extension":7814},"/2020/11/29/weekend-project-update-open-sec-data","29","Weekend project update: Open SEC Data","This project uses Django, DRF and Celery to read public SEC filings from sec.gov, build it into an API which is consumed through a Vue.js application.","2020-11-29T00:00:00.000Z","/static/sec-update.jpg",[14,13929,3995,14539,14540,24,3261],"api","gitlab",{"type":46,"children":14542,"toc":14757},[14543,14548,14584,14598,14603,14687,14692],{"type":49,"tag":58,"props":14544,"children":14545},{},[14546],{"type":55,"value":14547},"Here's an early look at a project I have been working on to practice some Django and Vue.js concepts: Open SEC Data.",{"type":49,"tag":64,"props":14549,"children":14550},{},[14551,14562,14573],{"type":49,"tag":68,"props":14552,"children":14553},{},[14554,14560],{"type":49,"tag":80,"props":14555,"children":14558},{"href":14556,"rel":14557},"https://opensecdata.ga",[84],[14559],{"type":55,"value":14556},{"type":55,"value":14561}," (project staging website, deployed to docker swarm cluster running on DigitalOcean)",{"type":49,"tag":68,"props":14563,"children":14564},{},[14565,14571],{"type":49,"tag":80,"props":14566,"children":14569},{"href":14567,"rel":14568},"https://gitlab.com/briancaffey/sec-filings-app",[84],[14570],{"type":55,"value":14567},{"type":55,"value":14572}," (main repository, requires GitLab account)",{"type":49,"tag":68,"props":14574,"children":14575},{},[14576,14582],{"type":49,"tag":80,"props":14577,"children":14580},{"href":14578,"rel":14579},"https://github.com/briancaffey/sec-filings-app",[84],[14581],{"type":55,"value":14578},{"type":55,"value":14583}," (mirror, no account required to view)",{"type":49,"tag":58,"props":14585,"children":14586},{},[14587,14589,14596],{"type":55,"value":14588},"This project uses Django, DRF and Celery to read public SEC filings from ",{"type":49,"tag":80,"props":14590,"children":14593},{"href":14591,"rel":14592},"https://www.sec.gov/Archives/edgar/full-index/",[84],[14594],{"type":55,"value":14595},"sec.gov",{"type":55,"value":14597},", build it into an API which is consumed through a Vue.js application. I'm currently focused on 13F filings which are required for large US investment funds managing over $100 million USD. There is data dating back to 1993 and it is published quarterly.",{"type":49,"tag":58,"props":14599,"children":14600},{},[14601],{"type":55,"value":14602},"Here are some of the things I'm focusing on in this project in no particular order:",{"type":49,"tag":64,"props":14604,"children":14605},{},[14606,14611,14616,14621,14626,14631,14636,14657,14677,14682],{"type":49,"tag":68,"props":14607,"children":14608},{},[14609],{"type":55,"value":14610},"Getting better at Django REST Framework. This project has been helping me apply some of the parts of DRF that I have found difficult. I'm currently using ViewSets which feels function-based views inside of class-based views. They are flexible, but I would like to add more abstraction with filtering",{"type":49,"tag":68,"props":14612,"children":14613},{},[14614],{"type":55,"value":14615},"Django admin. While this project primarily uses Django as a REST API with Django REST Framework, I have tried to take advantage of the Django admin to build out helpful views that can be used to spot check the data I'm creating. Most of my API is read-only, this makes things pretty simple.",{"type":49,"tag":68,"props":14617,"children":14618},{},[14619],{"type":55,"value":14620},"Moderately complex paginated data tables with Vue. I work with lots of paginated table data, and I think there is a better way to do abstract some of the repeated logic that I use (getting and setting current page, rows per page). I'm using Vuex, and I have heard of module factories, but I'm thinking that there will be a better way to do this when Vue 3 officially comes to Quasar Framework (Quasar is a Vue.js framework).",{"type":49,"tag":68,"props":14622,"children":14623},{},[14624],{"type":55,"value":14625},"Session authentication with DRF. There are a lot of guides showing how to use JWT and Token Authentication for DRF with Javascript frontends. The DRF recommends using Session Authentication for such use cases as a web-base Javascript client, so I hope I can promote some best practices around how to use Django's built-in session authentication for use with the Django REST Framework using an HttpOnly session cookie. I also understand that all security decisions have trade-offs, and I'm trying to understand what trade-offs come with handling authentication in this way.",{"type":49,"tag":68,"props":14627,"children":14628},{},[14629],{"type":55,"value":14630},"Social authentication. I have previously setup social authentication with Google, Facebook and GitHub using Python Social Auth. I think it is a great package, and it adds a lot of flexibility with it's concept of pipelines, but I haven't done much with these yet, so I'm hoping to dig in further and better understand how I can make better use of social authentication in my app. This app uses Linkedin 0Auth2 with a custom user model. Logging in with Linkedin account gives you the ability to request an API Token (Django REST Framework's Token) to access the public API.",{"type":49,"tag":68,"props":14632,"children":14633},{},[14634],{"type":55,"value":14635},"Automatic API documentation with OpenAPI. Swagger/OpenAPI seems like nice way to document and API, so I'm hoping to build best practices around how to document a DRF API automatically with OpenAPI and Swagger UI.",{"type":49,"tag":68,"props":14637,"children":14638},{},[14639,14641,14647,14649,14655],{"type":55,"value":14640},"CI/CD with GitLab and docker swarm. I will admit that I am huge GitLab fan. I love how flexible their CI/CD pipelines are. Being a docker fan as well, I chose to use docker swarm for this project to keep things simple and straightforward. I think one under-appreciate feature of docker is being able to set ",{"type":49,"tag":326,"props":14642,"children":14644},{"className":14643},[],[14645],{"type":55,"value":14646},"DOCKER_HOST",{"type":55,"value":14648}," to an SSH connection, such as ",{"type":49,"tag":326,"props":14650,"children":14652},{"className":14651},[],[14653],{"type":55,"value":14654},"ssh://root@123.456.789.10",{"type":55,"value":14656},". This let's you control the remote docker host without needing to SSH to it first, and it is also how I'm able to deploy and run management commands \"manually\" through the GitLab UI.",{"type":49,"tag":68,"props":14658,"children":14659},{},[14660,14662,14668,14669,14675],{"type":55,"value":14661},"Productive development environment. To start the project, you only need to run docker-compose up (after copying ",{"type":49,"tag":326,"props":14663,"children":14665},{"className":14664},[],[14666],{"type":55,"value":14667},".env.template",{"type":55,"value":12789},{"type":49,"tag":326,"props":14670,"children":14672},{"className":14671},[],[14673],{"type":55,"value":14674},".env",{"type":55,"value":14676}," in the root directory for storing sensitive data outside of git such as LinkedIn OAuth2 keys). The development environment is very similar to how this project runs in production with some additional utilities for monitoring and debugging such as pgadmin4, flower (for celery), redis commander (a GUI for viewing redis databases), Django debug toolbar (a must have for any Django project, I believe), runserver_plus with Werkzeug, and others. Also, the backend and frontend hot reload automatically with the help of webpack for Vue and watchdog for Django and Celery.",{"type":49,"tag":68,"props":14678,"children":14679},{},[14680],{"type":55,"value":14681},"Automatic TLS certificate generation with Traefik. For a simple project in docker swarm, I'm really happy with how simple it is to request TLS certificates from Let's Encrypt automatically with Traefik. There are no scripts, cron jobs or one-time setup jobs, it just seems to work out of the box if configured correctly.",{"type":49,"tag":68,"props":14683,"children":14684},{},[14685],{"type":55,"value":14686},"Testing with pytest. I have only been trying to test most of my API views so far. I really like using factory with pytest, so I use that in most of my tests.",{"type":49,"tag":58,"props":14688,"children":14689},{},[14690],{"type":55,"value":14691},"That's all I have for now. I have a long list of questions, things I want to improve, add and experiment with, here are just a few that come to mind:",{"type":49,"tag":64,"props":14693,"children":14694},{},[14695,14700,14705,14718,14723,14728,14733,14738],{"type":49,"tag":68,"props":14696,"children":14697},{},[14698],{"type":55,"value":14699},"Frontend testing. I don't have any component testing or e2d tests, so this would be good to add eventually. Since I'm using a component library and my app uses these components directly, I'm not exactly sure how much testing I should be doing.",{"type":49,"tag":68,"props":14701,"children":14702},{},[14703],{"type":55,"value":14704},"Data verification/validation. There are a lot of site that do provide similar data, WhaleWisdom is the biggest one that I know of. Once I get more data built on the site it would be good to spot check some of the values. There are some nuances to the filing data that I haven't addressed, such as Amendment filings and additions.",{"type":49,"tag":68,"props":14706,"children":14707},{},[14708,14710,14717],{"type":55,"value":14709},"Calculating period changes. One of the features that I'm not sure how best to implement is the ability to sort holdings for a filer in a given period on the percent increase from the last period. One way would be to add these as additional fields to the Holding model and then calculate these values as I process the data in celery. If I process the data from recent periods to later periods, I will have to update these values once the previous period has been processed, so it would be an additional check to do. I'll probably post this question here in more detail later. Here's ",{"type":49,"tag":80,"props":14711,"children":14714},{"href":14712,"rel":14713},"https://whalewisdom.com/filer/ubs-ag#tabholdings_tab_link",[84],[14715],{"type":55,"value":14716},"an example of what this means from WhaleWisdom",{"type":55,"value":745},{"type":49,"tag":68,"props":14719,"children":14720},{},[14721],{"type":55,"value":14722},"Accessing LinkedIn profile data to populate fields on my CustomUser model.",{"type":49,"tag":68,"props":14724,"children":14725},{},[14726],{"type":55,"value":14727},"Scaling? I have a lot more experience with deploying projects to AWS which is built around the ability to scale. I don't know a project on DigitalOcean would be scaled automatically. A single node docker swarm cluster while take some time to process all of the data. I would probably be better of scaling vertically with much bigger droplets and higher celery concurrency.",{"type":49,"tag":68,"props":14729,"children":14730},{},[14731],{"type":55,"value":14732},"Docker swarm secrets. I'm currently using environment variables to pass secrets stored in GitLab CI when I build images and deploy to docker swarm. I would like to learn how to properly use swarm secrets and work them into my CI/CD pipeline.",{"type":49,"tag":68,"props":14734,"children":14735},{},[14736],{"type":55,"value":14737},"As I mentioned above, I'm also interested in updating this project to Vue3 and to apply some of its new features to this project.",{"type":49,"tag":68,"props":14739,"children":14740},{},[14741,14743,14748,14750,14756],{"type":55,"value":14742},"Use pipenv, poetry or some other way of pinning secondary python dependencies. Does anyone have a recommendation on how best to do this with docker. I have always thought that docker ",{"type":49,"tag":126,"props":14744,"children":14745},{},[14746],{"type":55,"value":14747},"is",{"type":55,"value":14749}," the virtual environment, but I realize that some versions of indirect dependencies may change when pip installing without using a lockfile similar to ",{"type":49,"tag":326,"props":14751,"children":14753},{"className":14752},[],[14754],{"type":55,"value":14755},"package-lock.json",{"type":55,"value":745},{"title":8,"searchDepth":1079,"depth":1079,"links":14758},[],"content:2020:11:29:weekend-project-update-open-sec-data.md","2020/11/29/weekend-project-update-open-sec-data.md","2020/11/29/weekend-project-update-open-sec-data",{"_path":14763,"_dir":14764,"_draft":7,"_partial":7,"_locale":8,"title":14765,"description":14766,"layout":14767,"date":14768,"comments":44,"image":14769,"tags":14770,"body":14776,"_type":7809,"_id":19221,"_source":7811,"_file":19222,"_stem":19223,"_extension":7814},"/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","09","Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray","A guide to deploying Django applications with docker using popular open-source tools","post","2020-08-09T00:00:00.000Z","/static/shark.jpg",[14,24,14771,13929,14540,14772,14773,14774,14775],"digital-ocean","rex-ray","traefik","nginx","swarm",{"type":46,"children":14777,"toc":19195},[14778,14810,14815,14823,14835,14840,14846,14851,14917,14949,14955,14999,15005,15042,15047,15052,15057,15063,15076,15152,15158,15180,15186,15191,15199,15210,15216,15228,15233,15241,15262,15267,15275,15288,15296,15301,15310,15338,15385,15403,15414,15583,15609,15647,15723,15731,15756,15850,15858,15879,15966,15979,15985,16021,16029,16057,16098,16104,16109,16117,16125,16162,16167,16175,16187,16206,16214,16234,16242,16262,16271,16297,16526,16601,16645,16686,16694,16715,16720,16727,16745,16757,16764,16784,16794,16827,16831,17037,17055,17062,17074,17111,17155,17167,17214,17230,17315,17534,17563,17568,17573,17586,17604,17615,17806,17825,17858,17866,17939,17947,17967,17993,18001,18080,18092,18235,18240,18254,18274,18282,18287,18295,18334,18368,18373,18380,18394,18399,18417,18422,18430,18435,18462,18481,18511,18516,18835,18843,18867,18952,18964,18972,18984,18991,19003,19011,19029,19037,19042,19050,19055,19060,19068,19087,19093,19098,19114,19122,19127,19131,19136,19142,19147,19153,19158,19164,19169,19175,19180,19186,19191],{"type":49,"tag":58,"props":14779,"children":14780},{},[14781,14783,14790,14792,14799,14801,14808],{"type":55,"value":14782},"I recently wrote two articles about deploying Django applications to AWS serverless environments: one on ",{"type":49,"tag":80,"props":14784,"children":14787},{"href":14785,"rel":14786},"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html",[84],[14788],{"type":55,"value":14789},"AWS Fargate",{"type":55,"value":14791}," (CloudFront, ALB and ECS Fargate containers) and one on ",{"type":49,"tag":80,"props":14793,"children":14796},{"href":14794,"rel":14795},"https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html",[84],[14797],{"type":55,"value":14798},"AWS Lambda",{"type":55,"value":14800}," (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of ",{"type":49,"tag":80,"props":14802,"children":14805},{"href":14803,"rel":14804},"https://aws.amazon.com/cdk/",[84],[14806],{"type":55,"value":14807},"AWS Cloud Development Kit (CDK)",{"type":55,"value":14809},", an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to \"just use a VPS\" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!",{"type":49,"tag":58,"props":14811,"children":14812},{},[14813],{"type":55,"value":14814},"In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets).",{"type":49,"tag":2910,"props":14816,"children":14817},{},[14818],{"type":49,"tag":58,"props":14819,"children":14820},{},[14821],{"type":55,"value":14822},"I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes.",{"type":49,"tag":58,"props":14824,"children":14825},{},[14826,14828,14834],{"type":55,"value":14827},"Here's a link to my project that I'll be referencing: ",{"type":49,"tag":80,"props":14829,"children":14832},{"href":14830,"rel":14831},"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik",[84],[14833],{"type":55,"value":14830},{"type":55,"value":745},{"type":49,"tag":58,"props":14836,"children":14837},{},[14838],{"type":55,"value":14839},"The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article.",{"type":49,"tag":50,"props":14841,"children":14843},{"id":14842},"overview",[14844],{"type":55,"value":14845},"Overview",{"type":49,"tag":58,"props":14847,"children":14848},{},[14849],{"type":55,"value":14850},"Here are some of the key parts of the project that I'll go over:",{"type":49,"tag":64,"props":14852,"children":14853},{},[14854,14859,14864,14869,14874,14879,14892,14897,14902,14907,14912],{"type":49,"tag":68,"props":14855,"children":14856},{},[14857],{"type":55,"value":14858},"DigitalOcean and GitLab setup",{"type":49,"tag":68,"props":14860,"children":14861},{},[14862],{"type":55,"value":14863},"Creating an A Record that points to our Droplet IP",{"type":49,"tag":68,"props":14865,"children":14866},{},[14867],{"type":55,"value":14868},"Using a prebuilt VM image that ships with docker and docker-compose",{"type":49,"tag":68,"props":14870,"children":14871},{},[14872],{"type":55,"value":14873},"Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes",{"type":49,"tag":68,"props":14875,"children":14876},{},[14877],{"type":55,"value":14878},"Setting up a docker swarm cluster",{"type":49,"tag":68,"props":14880,"children":14881},{},[14882,14884,14890],{"type":55,"value":14883},"Setting up a ",{"type":49,"tag":326,"props":14885,"children":14887},{"className":14886},[],[14888],{"type":55,"value":14889},".gitlab-ci.yml",{"type":55,"value":14891}," file to build images and push them to a private GitLab CI project registry",{"type":49,"tag":68,"props":14893,"children":14894},{},[14895],{"type":55,"value":14896},"Writing a docker-compose file to configure the services (containers) that will support the application",{"type":49,"tag":68,"props":14898,"children":14899},{},[14900],{"type":55,"value":14901},"Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH",{"type":49,"tag":68,"props":14903,"children":14904},{},[14905],{"type":55,"value":14906},"Django project settings and management commands for our Postgres database and static files",{"type":49,"tag":68,"props":14908,"children":14909},{},[14910],{"type":55,"value":14911},"Monitoring, logging and debugging",{"type":49,"tag":68,"props":14913,"children":14914},{},[14915],{"type":55,"value":14916},"Destroying the environment + cleanup",{"type":49,"tag":58,"props":14918,"children":14919},{},[14920,14922,14929,14931,14938,14940,14947],{"type":55,"value":14921},"Before I dig into all of this, I recommend that you check out ",{"type":49,"tag":80,"props":14923,"children":14926},{"href":14924,"rel":14925},"https://mattsegal.dev/django-prod-architectures.html",[84],[14927],{"type":55,"value":14928},"this article about Django production architectures by Matt Segal",{"type":55,"value":14930},". This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. ",{"type":49,"tag":80,"props":14932,"children":14935},{"href":14933,"rel":14934},"https://mattsegal.dev",[84],[14936],{"type":55,"value":14937},"mattsegal.dev",{"type":55,"value":14939}," has lots of good content related to Django, I also recommend checking out ",{"type":49,"tag":80,"props":14941,"children":14944},{"href":14942,"rel":14943},"https://mattsegal.dev/nginx-django-reverse-proxy-config.html",[84],[14945],{"type":55,"value":14946},"this article about how NGINX is used with Django",{"type":55,"value":14948},". Thanks for the great resources, Matt!",{"type":49,"tag":50,"props":14950,"children":14952},{"id":14951},"digitalocean-setup",[14953],{"type":55,"value":14954},"DigitalOcean setup",{"type":49,"tag":64,"props":14956,"children":14957},{},[14958,14963,14974,14985],{"type":49,"tag":68,"props":14959,"children":14960},{},[14961],{"type":55,"value":14962},"Sign up for a new DigitalOcean account if you don't already have one",{"type":49,"tag":68,"props":14964,"children":14965},{},[14966,14968],{"type":55,"value":14967},"Create a DigitalOcean project ",{"type":49,"tag":80,"props":14969,"children":14972},{"href":14970,"rel":14971},"https://cloud.digitalocean.com/projects/new",[84],[14973],{"type":55,"value":14970},{"type":49,"tag":68,"props":14975,"children":14976},{},[14977,14979],{"type":55,"value":14978},"Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) ",{"type":49,"tag":80,"props":14980,"children":14983},{"href":14981,"rel":14982},"https://cloud.digitalocean.com/account/api/tokens",[84],[14984],{"type":55,"value":14981},{"type":49,"tag":68,"props":14986,"children":14987},{},[14988,14990,14997],{"type":55,"value":14989},"Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see ",{"type":49,"tag":80,"props":14991,"children":14994},{"href":14992,"rel":14993},"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/",[84],[14995],{"type":55,"value":14996},"this article",{"type":55,"value":14998}," for more information)",{"type":49,"tag":50,"props":15000,"children":15002},{"id":15001},"prebuilt-docker-vm-image",[15003],{"type":55,"value":15004},"Prebuilt Docker VM image",{"type":49,"tag":58,"props":15006,"children":15007},{},[15008,15010,15017,15019,15025,15027,15032,15034,15040],{"type":55,"value":15009},"From the ",{"type":49,"tag":80,"props":15011,"children":15014},{"href":15012,"rel":15013},"https://cloud.digitalocean.com/droplets/new",[84],[15015],{"type":55,"value":15016},"Create Droplets",{"type":55,"value":15018}," page, select ",{"type":49,"tag":326,"props":15020,"children":15022},{"className":15021},[],[15023],{"type":55,"value":15024},"Marketplace",{"type":55,"value":15026}," and search for ",{"type":49,"tag":326,"props":15028,"children":15030},{"className":15029},[],[15031],{"type":55,"value":24},{"type":55,"value":15033},". Select the ",{"type":49,"tag":326,"props":15035,"children":15037},{"className":15036},[],[15038],{"type":55,"value":15039},"Docker 5:19.03.1~3 18.04",{"type":55,"value":15041}," image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed.",{"type":49,"tag":58,"props":15043,"children":15044},{},[15045],{"type":55,"value":15046},"Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options.",{"type":49,"tag":58,"props":15048,"children":15049},{},[15050],{"type":55,"value":15051},"For Authentication, select the SSH key that you created earlier.",{"type":49,"tag":58,"props":15053,"children":15054},{},[15055],{"type":55,"value":15056},"Take note of the Droplet's IP address; we will use this in the next step.",{"type":49,"tag":50,"props":15058,"children":15060},{"id":15059},"gitlab-setup",[15061],{"type":55,"value":15062},"GitLab setup",{"type":49,"tag":58,"props":15064,"children":15065},{},[15066,15068,15074],{"type":55,"value":15067},"Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to ",{"type":49,"tag":326,"props":15069,"children":15071},{"className":15070},[],[15072],{"type":55,"value":15073},"Settings > CI/CD > Variables",{"type":55,"value":15075}," in your GitLab project and add the following environment variables:",{"type":49,"tag":64,"props":15077,"children":15078},{},[15079,15103,15114,15125,15136],{"type":49,"tag":68,"props":15080,"children":15081},{},[15082,15087,15089,15095,15097],{"type":49,"tag":326,"props":15083,"children":15085},{"className":15084},[],[15086],{"type":55,"value":13154},{"type":55,"value":15088},": the value should start with ",{"type":49,"tag":326,"props":15090,"children":15092},{"className":15091},[],[15093],{"type":55,"value":15094},"-----BEGIN RSA PRIVATE KEY-----",{"type":55,"value":15096}," and end with ",{"type":49,"tag":326,"props":15098,"children":15100},{"className":15099},[],[15101],{"type":55,"value":15102},"-----END RSA PRIVATE KEY-----",{"type":49,"tag":68,"props":15104,"children":15105},{},[15106,15112],{"type":49,"tag":326,"props":15107,"children":15109},{"className":15108},[],[15110],{"type":55,"value":15111},"DROPLET_IP",{"type":55,"value":15113},": the IP address of the droplet you just created",{"type":49,"tag":68,"props":15115,"children":15116},{},[15117,15123],{"type":49,"tag":326,"props":15118,"children":15120},{"className":15119},[],[15121],{"type":55,"value":15122},"POSTGRES_PASSWORD",{"type":55,"value":15124},": a secure password that we will use for our Postgres database (we will share this with our Django application later on)",{"type":49,"tag":68,"props":15126,"children":15127},{},[15128,15134],{"type":49,"tag":326,"props":15129,"children":15131},{"className":15130},[],[15132],{"type":55,"value":15133},"SECRET_KEY",{"type":55,"value":15135},": a random secret key to use for our Django application.",{"type":49,"tag":68,"props":15137,"children":15138},{},[15139,15145,15147],{"type":49,"tag":326,"props":15140,"children":15142},{"className":15141},[],[15143],{"type":55,"value":15144},"DEBUG",{"type":55,"value":15146},": the number ",{"type":49,"tag":326,"props":15148,"children":15150},{"className":15149},[],[15151],{"type":55,"value":8397},{"type":49,"tag":50,"props":15153,"children":15155},{"id":15154},"a-record",[15156],{"type":55,"value":15157},"A Record",{"type":49,"tag":58,"props":15159,"children":15160},{},[15161,15163,15169,15171,15178],{"type":55,"value":15162},"By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free ",{"type":49,"tag":326,"props":15164,"children":15166},{"className":15165},[],[15167],{"type":55,"value":15168},".tk",{"type":55,"value":15170}," domain from ",{"type":49,"tag":80,"props":15172,"children":15175},{"href":15173,"rel":15174},"https://www.freenom.com/en/freeandpaiddomains.html",[84],[15176],{"type":55,"value":15177},"freenom",{"type":55,"value":15179},". I have used this before and it is a great option for testing things out.",{"type":49,"tag":50,"props":15181,"children":15183},{"id":15182},"ssh-into-your-digitalocean-droplet",[15184],{"type":55,"value":15185},"SSH into your DigitalOcean Droplet",{"type":49,"tag":58,"props":15187,"children":15188},{},[15189],{"type":55,"value":15190},"You can do this with the following command:",{"type":49,"tag":1050,"props":15192,"children":15194},{"code":15193},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n",[15195],{"type":49,"tag":326,"props":15196,"children":15197},{"__ignoreMap":8},[15198],{"type":55,"value":15193},{"type":49,"tag":58,"props":15200,"children":15201},{},[15202,15208],{"type":49,"tag":326,"props":15203,"children":15205},{"className":15204},[],[15206],{"type":55,"value":15207},"a1_rsa",{"type":55,"value":15209}," is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly.",{"type":49,"tag":50,"props":15211,"children":15213},{"id":15212},"add-the-rex-ray-docker-plugin",[15214],{"type":55,"value":15215},"Add the REX-Ray docker plugin",{"type":49,"tag":58,"props":15217,"children":15218},{},[15219,15221,15227],{"type":55,"value":15220},"This step is very simple, you can follow along with this short guide: ",{"type":49,"tag":80,"props":15222,"children":15225},{"href":15223,"rel":15224},"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container",[84],[15226],{"type":55,"value":15223},{"type":55,"value":745},{"type":49,"tag":58,"props":15229,"children":15230},{},[15231],{"type":55,"value":15232},"There is basically one command to run:",{"type":49,"tag":1050,"props":15234,"children":15236},{"code":15235},"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n",[15237],{"type":49,"tag":326,"props":15238,"children":15239},{"__ignoreMap":8},[15240],{"type":55,"value":15235},{"type":49,"tag":58,"props":15242,"children":15243},{},[15244,15246,15252,15254,15260],{"type":55,"value":15245},"You will need to make sure that you replace ",{"type":49,"tag":326,"props":15247,"children":15249},{"className":15248},[],[15250],{"type":55,"value":15251},"YOUR_DIGITALOCEAN_TOKEN",{"type":55,"value":15253}," with the personal access token you added earlier. Also, ",{"type":49,"tag":326,"props":15255,"children":15257},{"className":15256},[],[15258],{"type":55,"value":15259},"DOBS_REGION",{"type":55,"value":15261}," should be the region you selected for your Droplet earlier.",{"type":49,"tag":58,"props":15263,"children":15264},{},[15265],{"type":55,"value":15266},"Check that the plugin was installed correctly with:",{"type":49,"tag":1050,"props":15268,"children":15270},{"code":15269},"docker plugin ls\n",[15271],{"type":49,"tag":326,"props":15272,"children":15273},{"__ignoreMap":8},[15274],{"type":55,"value":15269},{"type":49,"tag":58,"props":15276,"children":15277},{},[15278,15280,15287],{"type":55,"value":15279},"Here's a quick intro to REX-Ray from ",{"type":49,"tag":80,"props":15281,"children":15284},{"href":15282,"rel":15283},"https://rexray.readthedocs.io/en/stable/",[84],[15285],{"type":55,"value":15286},"rexray.readthedocs.io",{"type":55,"value":6694},{"type":49,"tag":2910,"props":15289,"children":15290},{},[15291],{"type":49,"tag":58,"props":15292,"children":15293},{},[15294],{"type":55,"value":15295},"REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster.",{"type":49,"tag":58,"props":15297,"children":15298},{},[15299],{"type":55,"value":15300},"In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article.",{"type":49,"tag":50,"props":15302,"children":15304},{"id":15303},"gitlab-ciyml",[15305],{"type":49,"tag":326,"props":15306,"children":15308},{"className":15307},[],[15309],{"type":55,"value":14889},{"type":49,"tag":58,"props":15311,"children":15312},{},[15313,15318,15320,15327,15329,15336],{"type":49,"tag":326,"props":15314,"children":15316},{"className":15315},[],[15317],{"type":55,"value":14889},{"type":55,"value":15319}," is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over ",{"type":49,"tag":80,"props":15321,"children":15324},{"href":15322,"rel":15323},"https://docs.gitlab.com/ee/ci/yaml/",[84],[15325],{"type":55,"value":15326},"this page from the GitLab documentation",{"type":55,"value":15328}," which goes over all of the configuration options with many examples. Also, ",{"type":49,"tag":80,"props":15330,"children":15333},{"href":15331,"rel":15332},"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",[84],[15334],{"type":55,"value":15335},"this documentation page",{"type":55,"value":15337}," covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly.",{"type":49,"tag":58,"props":15339,"children":15340},{},[15341,15343,15348,15350,15356,15357,15363,15364,15370,15372,15377,15378,15383],{"type":55,"value":15342},"CI/CD pipelines that I define with ",{"type":49,"tag":326,"props":15344,"children":15346},{"className":15345},[],[15347],{"type":55,"value":14889},{"type":55,"value":15349}," typically contain three stages: ",{"type":49,"tag":326,"props":15351,"children":15353},{"className":15352},[],[15354],{"type":55,"value":15355},"test",{"type":55,"value":873},{"type":49,"tag":326,"props":15358,"children":15360},{"className":15359},[],[15361],{"type":55,"value":15362},"build",{"type":55,"value":715},{"type":49,"tag":326,"props":15365,"children":15367},{"className":15366},[],[15368],{"type":55,"value":15369},"deploy",{"type":55,"value":15371},". We will focus on the ",{"type":49,"tag":326,"props":15373,"children":15375},{"className":15374},[],[15376],{"type":55,"value":15362},{"type":55,"value":715},{"type":49,"tag":326,"props":15379,"children":15381},{"className":15380},[],[15382],{"type":55,"value":15369},{"type":55,"value":15384}," stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest).",{"type":49,"tag":58,"props":15386,"children":15387},{},[15388,15394,15396,15401],{"type":49,"tag":326,"props":15389,"children":15391},{"className":15390},[],[15392],{"type":55,"value":15393},"build-backend",{"type":55,"value":15395}," is the name of a GitLab CI job that builds and tags a docker image from the source code in the ",{"type":49,"tag":326,"props":15397,"children":15399},{"className":15398},[],[15400],{"type":55,"value":1951},{"type":55,"value":15402}," directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later.",{"type":49,"tag":58,"props":15404,"children":15405},{},[15406,15408,15413],{"type":55,"value":15407},"Here's the YAML code for ",{"type":49,"tag":326,"props":15409,"children":15411},{"className":15410},[],[15412],{"type":55,"value":15393},{"type":55,"value":6694},{"type":49,"tag":1050,"props":15415,"children":15419},{"code":15416,"language":15417,"meta":8,"className":15418,"style":8},"build-backend:\n  stage: build\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  before_script:\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - |\n      docker build \\\n        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n        -f backend/docker/Dockerfile.prod \\\n        ./backend/\n    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n","yml","language-yml shiki shiki-themes github-light github-dark monokai",[15420],{"type":49,"tag":326,"props":15421,"children":15422},{"__ignoreMap":8},[15423,15434,15451,15468,15480,15492,15504,15516,15528,15539,15547,15555,15563,15571],{"type":49,"tag":1060,"props":15424,"children":15425},{"class":1062,"line":1063},[15426,15430],{"type":49,"tag":1060,"props":15427,"children":15428},{"style":3839},[15429],{"type":55,"value":15393},{"type":49,"tag":1060,"props":15431,"children":15432},{"style":1073},[15433],{"type":55,"value":6862},{"type":49,"tag":1060,"props":15435,"children":15436},{"class":1062,"line":1079},[15437,15442,15446],{"type":49,"tag":1060,"props":15438,"children":15439},{"style":3839},[15440],{"type":55,"value":15441},"  stage",{"type":49,"tag":1060,"props":15443,"children":15444},{"style":1073},[15445],{"type":55,"value":78},{"type":49,"tag":1060,"props":15447,"children":15448},{"style":2215},[15449],{"type":55,"value":15450},"build\n",{"type":49,"tag":1060,"props":15452,"children":15453},{"class":1062,"line":1088},[15454,15459,15463],{"type":49,"tag":1060,"props":15455,"children":15456},{"style":3839},[15457],{"type":55,"value":15458},"  image",{"type":49,"tag":1060,"props":15460,"children":15461},{"style":1073},[15462],{"type":55,"value":78},{"type":49,"tag":1060,"props":15464,"children":15465},{"style":2215},[15466],{"type":55,"value":15467},"docker:19.03.1\n",{"type":49,"tag":1060,"props":15469,"children":15470},{"class":1062,"line":1097},[15471,15476],{"type":49,"tag":1060,"props":15472,"children":15473},{"style":3839},[15474],{"type":55,"value":15475},"  services",{"type":49,"tag":1060,"props":15477,"children":15478},{"style":1073},[15479],{"type":55,"value":6862},{"type":49,"tag":1060,"props":15481,"children":15482},{"class":1062,"line":1111},[15483,15487],{"type":49,"tag":1060,"props":15484,"children":15485},{"style":1073},[15486],{"type":55,"value":6899},{"type":49,"tag":1060,"props":15488,"children":15489},{"style":2215},[15490],{"type":55,"value":15491},"docker:19.03.5-dind\n",{"type":49,"tag":1060,"props":15493,"children":15494},{"class":1062,"line":1120},[15495,15500],{"type":49,"tag":1060,"props":15496,"children":15497},{"style":3839},[15498],{"type":55,"value":15499},"  before_script",{"type":49,"tag":1060,"props":15501,"children":15502},{"style":1073},[15503],{"type":55,"value":6862},{"type":49,"tag":1060,"props":15505,"children":15506},{"class":1062,"line":1128},[15507,15511],{"type":49,"tag":1060,"props":15508,"children":15509},{"style":1073},[15510],{"type":55,"value":6899},{"type":49,"tag":1060,"props":15512,"children":15513},{"style":2215},[15514],{"type":55,"value":15515},"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n",{"type":49,"tag":1060,"props":15517,"children":15518},{"class":1062,"line":1141},[15519,15524],{"type":49,"tag":1060,"props":15520,"children":15521},{"style":3839},[15522],{"type":55,"value":15523},"  script",{"type":49,"tag":1060,"props":15525,"children":15526},{"style":1073},[15527],{"type":55,"value":6862},{"type":49,"tag":1060,"props":15529,"children":15530},{"class":1062,"line":1150},[15531,15535],{"type":49,"tag":1060,"props":15532,"children":15533},{"style":1073},[15534],{"type":55,"value":6899},{"type":49,"tag":1060,"props":15536,"children":15537},{"style":2194},[15538],{"type":55,"value":3884},{"type":49,"tag":1060,"props":15540,"children":15541},{"class":1062,"line":1158},[15542],{"type":49,"tag":1060,"props":15543,"children":15544},{"style":2215},[15545],{"type":55,"value":15546},"      docker build \\\n",{"type":49,"tag":1060,"props":15548,"children":15549},{"class":1062,"line":1171},[15550],{"type":49,"tag":1060,"props":15551,"children":15552},{"style":2215},[15553],{"type":55,"value":15554},"        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n",{"type":49,"tag":1060,"props":15556,"children":15557},{"class":1062,"line":1180},[15558],{"type":49,"tag":1060,"props":15559,"children":15560},{"style":2215},[15561],{"type":55,"value":15562},"        -f backend/docker/Dockerfile.prod \\\n",{"type":49,"tag":1060,"props":15564,"children":15565},{"class":1062,"line":1188},[15566],{"type":49,"tag":1060,"props":15567,"children":15568},{"style":2215},[15569],{"type":55,"value":15570},"        ./backend/\n",{"type":49,"tag":1060,"props":15572,"children":15573},{"class":1062,"line":1201},[15574,15578],{"type":49,"tag":1060,"props":15575,"children":15576},{"style":1073},[15577],{"type":55,"value":6899},{"type":49,"tag":1060,"props":15579,"children":15580},{"style":2215},[15581],{"type":55,"value":15582},"docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n",{"type":49,"tag":58,"props":15584,"children":15585},{},[15586,15592,15594,15600,15602,15607],{"type":49,"tag":326,"props":15587,"children":15589},{"className":15588},[],[15590],{"type":55,"value":15591},"build-nginx",{"type":55,"value":15593}," is almost identical, but the ",{"type":49,"tag":326,"props":15595,"children":15597},{"className":15596},[],[15598],{"type":55,"value":15599},"docker build",{"type":55,"value":15601}," arguments are slightly different. There are three arguments for the ",{"type":49,"tag":326,"props":15603,"children":15605},{"className":15604},[],[15606],{"type":55,"value":15599},{"type":55,"value":15608}," command that I'm using here:",{"type":49,"tag":8994,"props":15610,"children":15611},{},[15612,15623,15634],{"type":49,"tag":68,"props":15613,"children":15614},{},[15615,15621],{"type":49,"tag":326,"props":15616,"children":15618},{"className":15617},[],[15619],{"type":55,"value":15620},"-t",{"type":55,"value":15622},": the tag to tag the built image with",{"type":49,"tag":68,"props":15624,"children":15625},{},[15626,15632],{"type":49,"tag":326,"props":15627,"children":15629},{"className":15628},[],[15630],{"type":55,"value":15631},"-f",{"type":55,"value":15633},": the Dockerfile to be used for building the image",{"type":49,"tag":68,"props":15635,"children":15636},{},[15637,15639,15645],{"type":55,"value":15638},"the ",{"type":49,"tag":326,"props":15640,"children":15642},{"className":15641},[],[15643],{"type":55,"value":15644},"context",{"type":55,"value":15646}," that is sent to the docker daemon when we build the image",{"type":49,"tag":58,"props":15648,"children":15649},{},[15650,15655,15657,15663,15664,15670,15671,15677,15679,15685,15687,15692,15694,15700,15702,15707,15709,15714,15716,15721],{"type":49,"tag":326,"props":15651,"children":15653},{"className":15652},[],[15654],{"type":55,"value":15620},{"type":55,"value":15656}," makes use of two predefined GitLab CI variables: ",{"type":49,"tag":326,"props":15658,"children":15660},{"className":15659},[],[15661],{"type":55,"value":15662},"CI_REGISTRY_IMAGE",{"type":55,"value":715},{"type":49,"tag":326,"props":15665,"children":15667},{"className":15666},[],[15668],{"type":55,"value":15669},"CI_COMMIT_SHORT_SHA",{"type":55,"value":8561},{"type":49,"tag":326,"props":15672,"children":15674},{"className":15673},[],[15675],{"type":55,"value":15676},"$CI_REGISTRY_IMAGE",{"type":55,"value":15678}," is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: ",{"type":49,"tag":326,"props":15680,"children":15682},{"className":15681},[],[15683],{"type":55,"value":15684},"registry.gitlab.com/\u003Cgitlab_username>/\u003Cproject_name>",{"type":55,"value":15686},", and ",{"type":49,"tag":326,"props":15688,"children":15690},{"className":15689},[],[15691],{"type":55,"value":15669},{"type":55,"value":15693}," is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the ",{"type":49,"tag":326,"props":15695,"children":15697},{"className":15696},[],[15698],{"type":55,"value":15699},"tag",{"type":55,"value":15701},", even though we pass in more than just this value. We combine these two values with ",{"type":49,"tag":326,"props":15703,"children":15705},{"className":15704},[],[15706],{"type":55,"value":3744},{"type":55,"value":15708}," and the name of the image we are building, such as ",{"type":49,"tag":326,"props":15710,"children":15712},{"className":15711},[],[15713],{"type":55,"value":1951},{"type":55,"value":15715},", so the full value being passed to ",{"type":49,"tag":326,"props":15717,"children":15719},{"className":15718},[],[15720],{"type":55,"value":15620},{"type":55,"value":15722}," is:",{"type":49,"tag":1050,"props":15724,"children":15726},{"code":15725},"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n",[15727],{"type":49,"tag":326,"props":15728,"children":15729},{"__ignoreMap":8},[15730],{"type":55,"value":15725},{"type":49,"tag":58,"props":15732,"children":15733},{},[15734,15739,15741,15747,15749,15754],{"type":49,"tag":326,"props":15735,"children":15737},{"className":15736},[],[15738],{"type":55,"value":15631},{"type":55,"value":15740}," is the path to the ",{"type":49,"tag":326,"props":15742,"children":15744},{"className":15743},[],[15745],{"type":55,"value":15746},"Dockerfile",{"type":55,"value":15748}," we are using relative to the directory where we are running the ",{"type":49,"tag":326,"props":15750,"children":15752},{"className":15751},[],[15753],{"type":55,"value":15599},{"type":55,"value":15755}," command, which is the root directory of the project.",{"type":49,"tag":58,"props":15757,"children":15758},{},[15759,15761,15766,15768,15774,15775,15781,15783,15788,15789,15794,15795,15800,15802,15807,15809,15814,15816,15821,15822,15827,15829,15834,15836,15841,15843,15848],{"type":55,"value":15760},"The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with ",{"type":49,"tag":326,"props":15762,"children":15764},{"className":15763},[],[15765],{"type":55,"value":15599},{"type":55,"value":15767},", we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as ",{"type":49,"tag":326,"props":15769,"children":15771},{"className":15770},[],[15772],{"type":55,"value":15773},"ADD",{"type":55,"value":715},{"type":49,"tag":326,"props":15776,"children":15778},{"className":15777},[],[15779],{"type":55,"value":15780},"COPY",{"type":55,"value":15782}," -- we will get to these soon). There's a key difference between the ",{"type":49,"tag":326,"props":15784,"children":15786},{"className":15785},[],[15787],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":15790,"children":15792},{"className":15791},[],[15793],{"type":55,"value":14774},{"type":55,"value":1909},{"type":49,"tag":326,"props":15796,"children":15798},{"className":15797},[],[15799],{"type":55,"value":15599},{"type":55,"value":15801}," commands: the context for ",{"type":49,"tag":326,"props":15803,"children":15805},{"className":15804},[],[15806],{"type":55,"value":1951},{"type":55,"value":15808}," is ",{"type":49,"tag":326,"props":15810,"children":15812},{"className":15811},[],[15813],{"type":55,"value":1951},{"type":55,"value":15815},", but the context for ",{"type":49,"tag":326,"props":15817,"children":15819},{"className":15818},[],[15820],{"type":55,"value":14774},{"type":55,"value":15808},{"type":49,"tag":326,"props":15823,"children":15825},{"className":15824},[],[15826],{"type":55,"value":745},{"type":55,"value":15828}," (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the ",{"type":49,"tag":326,"props":15830,"children":15832},{"className":15831},[],[15833],{"type":55,"value":14774},{"type":55,"value":15835}," and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the ",{"type":49,"tag":326,"props":15837,"children":15839},{"className":15838},[],[15840],{"type":55,"value":15599},{"type":55,"value":15842}," command to hang. The first line of output from a ",{"type":49,"tag":326,"props":15844,"children":15846},{"className":15845},[],[15847],{"type":55,"value":15599},{"type":55,"value":15849}," command should be something like this:",{"type":49,"tag":1050,"props":15851,"children":15853},{"code":15852},"Sending build context to Docker daemon  24.58kB\n",[15854],{"type":49,"tag":326,"props":15855,"children":15856},{"__ignoreMap":8},[15857],{"type":55,"value":15852},{"type":49,"tag":58,"props":15859,"children":15860},{},[15861,15863,15869,15871,15877],{"type":55,"value":15862},"If this number is too high, you should use a ",{"type":49,"tag":326,"props":15864,"children":15866},{"className":15865},[],[15867],{"type":55,"value":15868},".dockerignore",{"type":55,"value":15870}," file that ignores any files or directories you don't want to send to the docker daemon (similar to how ",{"type":49,"tag":326,"props":15872,"children":15874},{"className":15873},[],[15875],{"type":55,"value":15876},".gitignore",{"type":55,"value":15878}," works with git).",{"type":49,"tag":58,"props":15880,"children":15881},{},[15882,15884,15890,15892,15898,15900,15906,15907,15913,15915,15921,15923,15929,15931,15937,15939,15944,15945,15950,15952,15957,15959,15964],{"type":55,"value":15883},"To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the ",{"type":49,"tag":326,"props":15885,"children":15887},{"className":15886},[],[15888],{"type":55,"value":15889},"docker login",{"type":55,"value":15891}," command in the ",{"type":49,"tag":326,"props":15893,"children":15895},{"className":15894},[],[15896],{"type":55,"value":15897},"before_script",{"type":55,"value":15899}," as well two other predefined GitLab CI variables: ",{"type":49,"tag":326,"props":15901,"children":15903},{"className":15902},[],[15904],{"type":55,"value":15905},"CI_JOB_TOKEN",{"type":55,"value":715},{"type":49,"tag":326,"props":15908,"children":15910},{"className":15909},[],[15911],{"type":55,"value":15912},"CI_REGISTRY",{"type":55,"value":15914},". This all happens using a special service called ",{"type":49,"tag":326,"props":15916,"children":15918},{"className":15917},[],[15919],{"type":55,"value":15920},"docker-in-docker",{"type":55,"value":15922}," which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key ",{"type":49,"tag":326,"props":15924,"children":15926},{"className":15925},[],[15927],{"type":55,"value":15928},"image",{"type":55,"value":15930}," -- and can define additional containers -- the ",{"type":49,"tag":326,"props":15932,"children":15934},{"className":15933},[],[15935],{"type":55,"value":15936},"services",{"type":55,"value":15938}," key -- to help with the CI job). Once the two images for ",{"type":49,"tag":326,"props":15940,"children":15942},{"className":15941},[],[15943],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":15946,"children":15948},{"className":15947},[],[15949],{"type":55,"value":14774},{"type":55,"value":15951}," have been built and pushed, our GitLab CI pipeline moves on to the next stage: ",{"type":49,"tag":326,"props":15953,"children":15955},{"className":15954},[],[15956],{"type":55,"value":15369},{"type":55,"value":15958},". In the ",{"type":49,"tag":326,"props":15960,"children":15962},{"className":15961},[],[15963],{"type":55,"value":15369},{"type":55,"value":15965}," stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:",{"type":49,"tag":8994,"props":15967,"children":15968},{},[15969,15974],{"type":49,"tag":68,"props":15970,"children":15971},{},[15972],{"type":55,"value":15973},"initialize a single-node docker swarm cluster on our Droplet and",{"type":49,"tag":68,"props":15975,"children":15976},{},[15977],{"type":55,"value":15978},"create a docker network that our cluster's services (containers) will use",{"type":49,"tag":50,"props":15980,"children":15982},{"id":15981},"setup-a-docker-swarm-cluster",[15983],{"type":55,"value":15984},"Setup a docker swarm cluster",{"type":49,"tag":58,"props":15986,"children":15987},{},[15988,15990,15996,15998,16003,16005,16011,16013,16019],{"type":55,"value":15989},"To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above (",{"type":49,"tag":326,"props":15991,"children":15993},{"className":15992},[],[15994],{"type":55,"value":15995},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91",{"type":55,"value":15997}," where ",{"type":49,"tag":326,"props":15999,"children":16001},{"className":16000},[],[16002],{"type":55,"value":15207},{"type":55,"value":16004}," is the name of the private key file -- you can ignore the ",{"type":49,"tag":326,"props":16006,"children":16008},{"className":16007},[],[16009],{"type":55,"value":16010},"-i ~/.ssh/a1_rsa",{"type":55,"value":16012}," part if you are using an SSH key called ",{"type":49,"tag":326,"props":16014,"children":16016},{"className":16015},[],[16017],{"type":55,"value":16018},"id_rsa",{"type":55,"value":16020},"), and run the following command:",{"type":49,"tag":1050,"props":16022,"children":16024},{"code":16023},"docker swarm init --advertise-addr DROPLET_IP\n",[16025],{"type":49,"tag":326,"props":16026,"children":16027},{"__ignoreMap":8},[16028],{"type":55,"value":16023},{"type":49,"tag":58,"props":16030,"children":16031},{},[16032,16034,16039,16041,16047,16049,16055],{"type":55,"value":16033},"Replace ",{"type":49,"tag":326,"props":16035,"children":16037},{"className":16036},[],[16038],{"type":55,"value":15111},{"type":55,"value":16040}," with your Droplet's IP address (e.g. ",{"type":49,"tag":326,"props":16042,"children":16044},{"className":16043},[],[16045],{"type":55,"value":16046},"123.45.578.91",{"type":55,"value":16048},"). Check out ",{"type":49,"tag":80,"props":16050,"children":16053},{"href":16051,"rel":16052},"https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04",[84],[16054],{"type":55,"value":14996},{"type":55,"value":16056}," for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here.",{"type":49,"tag":58,"props":16058,"children":16059},{},[16060,16062,16067,16069,16075,16077,16082,16084,16089,16091,16096],{"type":55,"value":16061},"Docker swarm uses docker-compose files, but using docker swarm is very different from running ",{"type":49,"tag":326,"props":16063,"children":16065},{"className":16064},[],[16066],{"type":55,"value":14142},{"type":55,"value":16068},", a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using ",{"type":49,"tag":326,"props":16070,"children":16072},{"className":16071},[],[16073],{"type":55,"value":16074},"docker-compose",{"type":55,"value":16076}," (the command) in production. Many people do this, and several official tutorials will often end with \"now just run ",{"type":49,"tag":326,"props":16078,"children":16080},{"className":16079},[],[16081],{"type":55,"value":14142},{"type":55,"value":16083}," and you are done\". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran ",{"type":49,"tag":326,"props":16085,"children":16087},{"className":16086},[],[16088],{"type":55,"value":14142},{"type":55,"value":16090},". It is pretty easy and it works very similarly in both local and production environments, but this guide will be using ",{"type":49,"tag":326,"props":16092,"children":16094},{"className":16093},[],[16095],{"type":55,"value":16074},{"type":55,"value":16097}," in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use.",{"type":49,"tag":50,"props":16099,"children":16101},{"id":16100},"defining-an-overlay-network",[16102],{"type":55,"value":16103},"Defining an overlay network",{"type":49,"tag":58,"props":16105,"children":16106},{},[16107],{"type":55,"value":16108},"SSH into your droplet and run the following command:",{"type":49,"tag":1050,"props":16110,"children":16112},{"code":16111},"docker network create --driver=overlay traefik-public\n",[16113],{"type":49,"tag":326,"props":16114,"children":16115},{"__ignoreMap":8},[16116],{"type":55,"value":16111},{"type":49,"tag":2910,"props":16118,"children":16119},{},[16120],{"type":49,"tag":58,"props":16121,"children":16122},{},[16123],{"type":55,"value":16124},"Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out.",{"type":49,"tag":58,"props":16126,"children":16127},{},[16128,16130,16136,16138,16143,16145,16151,16153,16160],{"type":55,"value":16129},"Let's go over one more docker concept that will helpful in the next few steps. When you run ",{"type":49,"tag":326,"props":16131,"children":16133},{"className":16132},[],[16134],{"type":55,"value":16135},"docker ps",{"type":55,"value":16137}," on your local machine, the docker CLI first looks to see if the ",{"type":49,"tag":326,"props":16139,"children":16141},{"className":16140},[],[16142],{"type":55,"value":14646},{"type":55,"value":16144}," environment variable is set. If it is not, then docker defaults to ",{"type":49,"tag":326,"props":16146,"children":16148},{"className":16147},[],[16149],{"type":55,"value":16150},"unix:///var/run/docker.sock",{"type":55,"value":16152},", a UNIX socket. Check out ",{"type":49,"tag":80,"props":16154,"children":16157},{"href":16155,"rel":16156},"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock",[84],[16158],{"type":55,"value":16159},"this SO post",{"type":55,"value":16161}," titled \"Can anyone explain docker.sock?\"",{"type":49,"tag":58,"props":16163,"children":16164},{},[16165],{"type":55,"value":16166},"We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:",{"type":49,"tag":1050,"props":16168,"children":16170},{"code":16169},"DOCKER_HOST=ssh://root@$DOCKER_IP\n",[16171],{"type":49,"tag":326,"props":16172,"children":16173},{"__ignoreMap":8},[16174],{"type":55,"value":16169},{"type":49,"tag":58,"props":16176,"children":16177},{},[16178,16180,16186],{"type":55,"value":16179},"See this article for a more in-depth discussion: ",{"type":49,"tag":80,"props":16181,"children":16184},{"href":16182,"rel":16183},"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow",[84],[16185],{"type":55,"value":16182},{"type":55,"value":745},{"type":49,"tag":58,"props":16188,"children":16189},{},[16190,16192,16197,16199,16204],{"type":55,"value":16191},"You can try this out locally. Run a container locally, check it with ",{"type":49,"tag":326,"props":16193,"children":16195},{"className":16194},[],[16196],{"type":55,"value":16135},{"type":55,"value":16198},", then export the ",{"type":49,"tag":326,"props":16200,"children":16202},{"className":16201},[],[16203],{"type":55,"value":14646},{"type":55,"value":16205}," environment variable with the following command:",{"type":49,"tag":1050,"props":16207,"children":16209},{"code":16208},"export DOCKER_HOST=ssh://root@123.45.678.91\n",[16210],{"type":49,"tag":326,"props":16211,"children":16212},{"__ignoreMap":8},[16213],{"type":55,"value":16208},{"type":49,"tag":58,"props":16215,"children":16216},{},[16217,16219,16225,16227,16232],{"type":55,"value":16218},"Replacing ",{"type":49,"tag":326,"props":16220,"children":16222},{"className":16221},[],[16223],{"type":55,"value":16224},"123.45.678.91",{"type":55,"value":16226}," with your Droplet IP. Run ",{"type":49,"tag":326,"props":16228,"children":16230},{"className":16229},[],[16231],{"type":55,"value":16135},{"type":55,"value":16233}," again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:",{"type":49,"tag":1050,"props":16235,"children":16237},{"code":16236},"unset DOCKER_HOST\n",[16238],{"type":49,"tag":326,"props":16239,"children":16240},{"__ignoreMap":8},[16241],{"type":55,"value":16236},{"type":49,"tag":58,"props":16243,"children":16244},{},[16245,16247,16252,16254,16260],{"type":55,"value":16246},"Running ",{"type":49,"tag":326,"props":16248,"children":16250},{"className":16249},[],[16251],{"type":55,"value":16135},{"type":55,"value":16253}," again you should see the containers on your machine. We will be using this idea in the next step when we look at the ",{"type":49,"tag":326,"props":16255,"children":16257},{"className":16256},[],[16258],{"type":55,"value":16259},"docker stack deploy",{"type":55,"value":16261}," command.",{"type":49,"tag":50,"props":16263,"children":16265},{"id":16264},"docker-stack-deploy",[16266],{"type":49,"tag":326,"props":16267,"children":16269},{"className":16268},[],[16270],{"type":55,"value":16259},{"type":49,"tag":58,"props":16272,"children":16273},{},[16274,16276,16281,16283,16288,16290,16296],{"type":55,"value":16275},"Now that we have done our one-time-setup steps, let's look at the ",{"type":49,"tag":326,"props":16277,"children":16279},{"className":16278},[],[16280],{"type":55,"value":15369},{"type":55,"value":16282}," stage of ",{"type":49,"tag":326,"props":16284,"children":16286},{"className":16285},[],[16287],{"type":55,"value":14889},{"type":55,"value":16289},", the GitLab CI job that will get our containers running on our Droplet. First, let's break down the ",{"type":49,"tag":326,"props":16291,"children":16293},{"className":16292},[],[16294],{"type":55,"value":16295},"deploy-digital-ocean",{"type":55,"value":13378},{"type":49,"tag":1050,"props":16298,"children":16300},{"code":16299,"language":15417,"meta":8,"className":15418,"style":8},"deploy-digital-ocean:\n  stage: deploy\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  variables:\n    DOCKER_HOST: 'ssh://root@$DROPLET_IP'\n  before_script:\n    - apk update && apk add openssh-client bash\n    - mkdir -p ~/.ssh\n    - echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n    - chmod 600 ~/.ssh/id_rsa\n    - eval \"$(ssh-agent -s)\"\n    - ssh-add ~/.ssh/id_rsa\n    - ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - docker stack deploy -c stack.yml my-stack --with-registry-auth\n",[16301],{"type":49,"tag":326,"props":16302,"children":16303},{"__ignoreMap":8},[16304,16315,16331,16346,16357,16368,16380,16397,16408,16420,16432,16444,16456,16468,16480,16492,16503,16514],{"type":49,"tag":1060,"props":16305,"children":16306},{"class":1062,"line":1063},[16307,16311],{"type":49,"tag":1060,"props":16308,"children":16309},{"style":3839},[16310],{"type":55,"value":16295},{"type":49,"tag":1060,"props":16312,"children":16313},{"style":1073},[16314],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16316,"children":16317},{"class":1062,"line":1079},[16318,16322,16326],{"type":49,"tag":1060,"props":16319,"children":16320},{"style":3839},[16321],{"type":55,"value":15441},{"type":49,"tag":1060,"props":16323,"children":16324},{"style":1073},[16325],{"type":55,"value":78},{"type":49,"tag":1060,"props":16327,"children":16328},{"style":2215},[16329],{"type":55,"value":16330},"deploy\n",{"type":49,"tag":1060,"props":16332,"children":16333},{"class":1062,"line":1088},[16334,16338,16342],{"type":49,"tag":1060,"props":16335,"children":16336},{"style":3839},[16337],{"type":55,"value":15458},{"type":49,"tag":1060,"props":16339,"children":16340},{"style":1073},[16341],{"type":55,"value":78},{"type":49,"tag":1060,"props":16343,"children":16344},{"style":2215},[16345],{"type":55,"value":15467},{"type":49,"tag":1060,"props":16347,"children":16348},{"class":1062,"line":1097},[16349,16353],{"type":49,"tag":1060,"props":16350,"children":16351},{"style":3839},[16352],{"type":55,"value":15475},{"type":49,"tag":1060,"props":16354,"children":16355},{"style":1073},[16356],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16358,"children":16359},{"class":1062,"line":1111},[16360,16364],{"type":49,"tag":1060,"props":16361,"children":16362},{"style":1073},[16363],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16365,"children":16366},{"style":2215},[16367],{"type":55,"value":15491},{"type":49,"tag":1060,"props":16369,"children":16370},{"class":1062,"line":1120},[16371,16376],{"type":49,"tag":1060,"props":16372,"children":16373},{"style":3839},[16374],{"type":55,"value":16375},"  variables",{"type":49,"tag":1060,"props":16377,"children":16378},{"style":1073},[16379],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16381,"children":16382},{"class":1062,"line":1128},[16383,16388,16392],{"type":49,"tag":1060,"props":16384,"children":16385},{"style":3839},[16386],{"type":55,"value":16387},"    DOCKER_HOST",{"type":49,"tag":1060,"props":16389,"children":16390},{"style":1073},[16391],{"type":55,"value":78},{"type":49,"tag":1060,"props":16393,"children":16394},{"style":2215},[16395],{"type":55,"value":16396},"'ssh://root@$DROPLET_IP'\n",{"type":49,"tag":1060,"props":16398,"children":16399},{"class":1062,"line":1141},[16400,16404],{"type":49,"tag":1060,"props":16401,"children":16402},{"style":3839},[16403],{"type":55,"value":15499},{"type":49,"tag":1060,"props":16405,"children":16406},{"style":1073},[16407],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16409,"children":16410},{"class":1062,"line":1150},[16411,16415],{"type":49,"tag":1060,"props":16412,"children":16413},{"style":1073},[16414],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16416,"children":16417},{"style":2215},[16418],{"type":55,"value":16419},"apk update && apk add openssh-client bash\n",{"type":49,"tag":1060,"props":16421,"children":16422},{"class":1062,"line":1158},[16423,16427],{"type":49,"tag":1060,"props":16424,"children":16425},{"style":1073},[16426],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16428,"children":16429},{"style":2215},[16430],{"type":55,"value":16431},"mkdir -p ~/.ssh\n",{"type":49,"tag":1060,"props":16433,"children":16434},{"class":1062,"line":1171},[16435,16439],{"type":49,"tag":1060,"props":16436,"children":16437},{"style":1073},[16438],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16440,"children":16441},{"style":2215},[16442],{"type":55,"value":16443},"echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":16445,"children":16446},{"class":1062,"line":1180},[16447,16451],{"type":49,"tag":1060,"props":16448,"children":16449},{"style":1073},[16450],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16452,"children":16453},{"style":2215},[16454],{"type":55,"value":16455},"chmod 600 ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":16457,"children":16458},{"class":1062,"line":1188},[16459,16463],{"type":49,"tag":1060,"props":16460,"children":16461},{"style":1073},[16462],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16464,"children":16465},{"style":2215},[16466],{"type":55,"value":16467},"eval \"$(ssh-agent -s)\"\n",{"type":49,"tag":1060,"props":16469,"children":16470},{"class":1062,"line":1201},[16471,16475],{"type":49,"tag":1060,"props":16472,"children":16473},{"style":1073},[16474],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16476,"children":16477},{"style":2215},[16478],{"type":55,"value":16479},"ssh-add ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":16481,"children":16482},{"class":1062,"line":1210},[16483,16487],{"type":49,"tag":1060,"props":16484,"children":16485},{"style":1073},[16486],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16488,"children":16489},{"style":2215},[16490],{"type":55,"value":16491},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n",{"type":49,"tag":1060,"props":16493,"children":16494},{"class":1062,"line":1218},[16495,16499],{"type":49,"tag":1060,"props":16496,"children":16497},{"style":1073},[16498],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16500,"children":16501},{"style":2215},[16502],{"type":55,"value":15515},{"type":49,"tag":1060,"props":16504,"children":16505},{"class":1062,"line":1232},[16506,16510],{"type":49,"tag":1060,"props":16507,"children":16508},{"style":3839},[16509],{"type":55,"value":15523},{"type":49,"tag":1060,"props":16511,"children":16512},{"style":1073},[16513],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16515,"children":16516},{"class":1062,"line":1241},[16517,16521],{"type":49,"tag":1060,"props":16518,"children":16519},{"style":1073},[16520],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16522,"children":16523},{"style":2215},[16524],{"type":55,"value":16525},"docker stack deploy -c stack.yml my-stack --with-registry-auth\n",{"type":49,"tag":58,"props":16527,"children":16528},{},[16529,16531,16536,16537,16542,16544,16549,16551,16556,16557,16563,16565,16570,16572,16578,16580,16586,16587,16592,16594,16600],{"type":55,"value":16530},"This job uses the same ",{"type":49,"tag":326,"props":16532,"children":16534},{"className":16533},[],[16535],{"type":55,"value":15928},{"type":55,"value":715},{"type":49,"tag":326,"props":16538,"children":16540},{"className":16539},[],[16541],{"type":55,"value":15936},{"type":55,"value":16543}," that our ",{"type":49,"tag":326,"props":16545,"children":16547},{"className":16546},[],[16548],{"type":55,"value":15362},{"type":55,"value":16550}," stage jobs used. Notice that we set ",{"type":49,"tag":326,"props":16552,"children":16554},{"className":16553},[],[16555],{"type":55,"value":14646},{"type":55,"value":12789},{"type":49,"tag":326,"props":16558,"children":16560},{"className":16559},[],[16561],{"type":55,"value":16562},"\"ssh://root@$DROPLET_IP\"",{"type":55,"value":16564},", this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The ",{"type":49,"tag":326,"props":16566,"children":16568},{"className":16567},[],[16569],{"type":55,"value":15897},{"type":55,"value":16571}," has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, ",{"type":49,"tag":326,"props":16573,"children":16575},{"className":16574},[],[16576],{"type":55,"value":16577},"docker:19.03.1",{"type":55,"value":16579}," is based on Alpine Linus. This version of Linux is super light weight and doesn't come with ",{"type":49,"tag":326,"props":16581,"children":16583},{"className":16582},[],[16584],{"type":55,"value":16585},"openssh-client",{"type":55,"value":8634},{"type":49,"tag":326,"props":16588,"children":16590},{"className":16589},[],[16591],{"type":55,"value":2728},{"type":55,"value":16593},", so our first step is to install these with the Alpine package manager, ",{"type":49,"tag":326,"props":16595,"children":16597},{"className":16596},[],[16598],{"type":55,"value":16599},"apk",{"type":55,"value":6694},{"type":49,"tag":1050,"props":16602,"children":16605},{"code":16419,"language":16603,"meta":8,"className":16604,"style":8},"sh","language-sh shiki shiki-themes github-light github-dark monokai",[16606],{"type":49,"tag":326,"props":16607,"children":16608},{"__ignoreMap":8},[16609],{"type":49,"tag":1060,"props":16610,"children":16611},{"class":1062,"line":1063},[16612,16616,16621,16626,16630,16635,16640],{"type":49,"tag":1060,"props":16613,"children":16614},{"style":1067},[16615],{"type":55,"value":16599},{"type":49,"tag":1060,"props":16617,"children":16618},{"style":2215},[16619],{"type":55,"value":16620}," update",{"type":49,"tag":1060,"props":16622,"children":16623},{"style":1073},[16624],{"type":55,"value":16625}," && ",{"type":49,"tag":1060,"props":16627,"children":16628},{"style":1067},[16629],{"type":55,"value":16599},{"type":49,"tag":1060,"props":16631,"children":16632},{"style":2215},[16633],{"type":55,"value":16634}," add",{"type":49,"tag":1060,"props":16636,"children":16637},{"style":2215},[16638],{"type":55,"value":16639}," openssh-client",{"type":49,"tag":1060,"props":16641,"children":16642},{"style":2215},[16643],{"type":55,"value":16644}," bash\n",{"type":49,"tag":58,"props":16646,"children":16647},{},[16648,16650,16655,16657,16662,16664,16670,16672,16678,16679,16685],{"type":55,"value":16649},"Next, we add the ",{"type":49,"tag":326,"props":16651,"children":16653},{"className":16652},[],[16654],{"type":55,"value":13154},{"type":55,"value":16656}," environment variable into the body of the ",{"type":49,"tag":326,"props":16658,"children":16660},{"className":16659},[],[16661],{"type":55,"value":16018},{"type":55,"value":16663}," private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from ",{"type":49,"tag":326,"props":16665,"children":16667},{"className":16666},[],[16668],{"type":55,"value":16669},"man ssh-agent",{"type":55,"value":16671}," that provides a little bit more context into why we need to run ",{"type":49,"tag":326,"props":16673,"children":16675},{"className":16674},[],[16676],{"type":55,"value":16677},"eval \"$(ssh-agent -s)\"",{"type":55,"value":715},{"type":49,"tag":326,"props":16680,"children":16682},{"className":16681},[],[16683],{"type":55,"value":16684},"ssh-add ~/.ssh/id_rsa",{"type":55,"value":6694},{"type":49,"tag":1050,"props":16687,"children":16689},{"code":16688},"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n",[16690],{"type":49,"tag":326,"props":16691,"children":16692},{"__ignoreMap":8},[16693],{"type":55,"value":16688},{"type":49,"tag":58,"props":16695,"children":16696},{},[16697,16699,16705,16707,16713],{"type":55,"value":16698},"Next, ",{"type":49,"tag":326,"props":16700,"children":16702},{"className":16701},[],[16703],{"type":55,"value":16704},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts",{"type":55,"value":16706}," tells our SSH agent about our Droplet so that it doesn't prompt us with a ",{"type":49,"tag":326,"props":16708,"children":16710},{"className":16709},[],[16711],{"type":55,"value":16712},"Do you want to add this server to known hosts? (yes/no)",{"type":55,"value":16714},", or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH.",{"type":49,"tag":58,"props":16716,"children":16717},{},[16718],{"type":55,"value":16719},"Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:",{"type":49,"tag":1050,"props":16721,"children":16722},{"code":15515},[16723],{"type":49,"tag":326,"props":16724,"children":16725},{"__ignoreMap":8},[16726],{"type":55,"value":15515},{"type":49,"tag":58,"props":16728,"children":16729},{},[16730,16732,16737,16738,16743],{"type":55,"value":16731},"This essentially gives our DigitalOcean Droplet access to the ",{"type":49,"tag":326,"props":16733,"children":16735},{"className":16734},[],[16736],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":16739,"children":16741},{"className":16740},[],[16742],{"type":55,"value":14774},{"type":55,"value":16744}," images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images.",{"type":49,"tag":58,"props":16746,"children":16747},{},[16748,16750,16755],{"type":55,"value":16749},"The last command in the ",{"type":49,"tag":326,"props":16751,"children":16753},{"className":16752},[],[16754],{"type":55,"value":16295},{"type":55,"value":16756}," job is:",{"type":49,"tag":1050,"props":16758,"children":16759},{"code":16525},[16760],{"type":49,"tag":326,"props":16761,"children":16762},{"__ignoreMap":8},[16763],{"type":55,"value":16525},{"type":49,"tag":58,"props":16765,"children":16766},{},[16767,16769,16775,16776,16782],{"type":55,"value":16768},"Check out this link from the docker docs on docker stacks ",{"type":49,"tag":80,"props":16770,"children":16773},{"href":16771,"rel":16772},"https://docs.docker.com/engine/swarm/stack-deploy/",[84],[16774],{"type":55,"value":16771},{"type":55,"value":8561},{"type":49,"tag":326,"props":16777,"children":16779},{"className":16778},[],[16780],{"type":55,"value":16781},"--with-registry-auth",{"type":55,"value":16783}," is important, our command will complete if this is not included, but our application won't start.",{"type":49,"tag":50,"props":16785,"children":16787},{"id":16786},"stackyml",[16788],{"type":49,"tag":326,"props":16789,"children":16791},{"className":16790},[],[16792],{"type":55,"value":16793},"stack.yml",{"type":49,"tag":58,"props":16795,"children":16796},{},[16797,16799,16804,16806,16811,16813,16818,16820,16825],{"type":55,"value":16798},"Now we are ready to tackle the last big file in our repo: ",{"type":49,"tag":326,"props":16800,"children":16802},{"className":16801},[],[16803],{"type":55,"value":16793},{"type":55,"value":16805},". This is a the docker-compose file that we use to deploy our project. The only reason we needed to run ",{"type":49,"tag":326,"props":16807,"children":16809},{"className":16808},[],[16810],{"type":55,"value":15889},{"type":55,"value":16812}," above is because ",{"type":49,"tag":326,"props":16814,"children":16816},{"className":16815},[],[16817],{"type":55,"value":16793},{"type":55,"value":16819}," references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the ",{"type":49,"tag":326,"props":16821,"children":16823},{"className":16822},[],[16824],{"type":55,"value":1951},{"type":55,"value":16826}," service:",{"type":49,"tag":430,"props":16828,"children":16829},{"id":1951},[16830],{"type":55,"value":1951},{"type":49,"tag":1050,"props":16832,"children":16834},{"code":16833,"language":15417,"meta":8,"className":15418,"style":8},"version: '3.4'\nservices:\n  backend:\n  image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n  networks:\n    - main\n  environment:\n    - POSTGRES_PASSWORD\n    - SECRET_KEY\n    - DEBUG\n  volumes:\n    - backendassets:/code/assets\n  depends_on:\n    - postgres\n    - redis\n    - web\n",[16835],{"type":49,"tag":326,"props":16836,"children":16837},{"__ignoreMap":8},[16838,16855,16866,16877,16893,16905,16917,16929,16941,16953,16965,16977,16989,17001,17013,17025],{"type":49,"tag":1060,"props":16839,"children":16840},{"class":1062,"line":1063},[16841,16846,16850],{"type":49,"tag":1060,"props":16842,"children":16843},{"style":3839},[16844],{"type":55,"value":16845},"version",{"type":49,"tag":1060,"props":16847,"children":16848},{"style":1073},[16849],{"type":55,"value":78},{"type":49,"tag":1060,"props":16851,"children":16852},{"style":2215},[16853],{"type":55,"value":16854},"'3.4'\n",{"type":49,"tag":1060,"props":16856,"children":16857},{"class":1062,"line":1079},[16858,16862],{"type":49,"tag":1060,"props":16859,"children":16860},{"style":3839},[16861],{"type":55,"value":15936},{"type":49,"tag":1060,"props":16863,"children":16864},{"style":1073},[16865],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16867,"children":16868},{"class":1062,"line":1088},[16869,16873],{"type":49,"tag":1060,"props":16870,"children":16871},{"style":3839},[16872],{"type":55,"value":4018},{"type":49,"tag":1060,"props":16874,"children":16875},{"style":1073},[16876],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16878,"children":16879},{"class":1062,"line":1097},[16880,16884,16888],{"type":49,"tag":1060,"props":16881,"children":16882},{"style":3839},[16883],{"type":55,"value":15458},{"type":49,"tag":1060,"props":16885,"children":16886},{"style":1073},[16887],{"type":55,"value":78},{"type":49,"tag":1060,"props":16889,"children":16890},{"style":2215},[16891],{"type":55,"value":16892},"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n",{"type":49,"tag":1060,"props":16894,"children":16895},{"class":1062,"line":1111},[16896,16901],{"type":49,"tag":1060,"props":16897,"children":16898},{"style":3839},[16899],{"type":55,"value":16900},"  networks",{"type":49,"tag":1060,"props":16902,"children":16903},{"style":1073},[16904],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16906,"children":16907},{"class":1062,"line":1120},[16908,16912],{"type":49,"tag":1060,"props":16909,"children":16910},{"style":1073},[16911],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16913,"children":16914},{"style":2215},[16915],{"type":55,"value":16916},"main\n",{"type":49,"tag":1060,"props":16918,"children":16919},{"class":1062,"line":1128},[16920,16925],{"type":49,"tag":1060,"props":16921,"children":16922},{"style":3839},[16923],{"type":55,"value":16924},"  environment",{"type":49,"tag":1060,"props":16926,"children":16927},{"style":1073},[16928],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16930,"children":16931},{"class":1062,"line":1141},[16932,16936],{"type":49,"tag":1060,"props":16933,"children":16934},{"style":1073},[16935],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16937,"children":16938},{"style":2215},[16939],{"type":55,"value":16940},"POSTGRES_PASSWORD\n",{"type":49,"tag":1060,"props":16942,"children":16943},{"class":1062,"line":1150},[16944,16948],{"type":49,"tag":1060,"props":16945,"children":16946},{"style":1073},[16947],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16949,"children":16950},{"style":2215},[16951],{"type":55,"value":16952},"SECRET_KEY\n",{"type":49,"tag":1060,"props":16954,"children":16955},{"class":1062,"line":1158},[16956,16960],{"type":49,"tag":1060,"props":16957,"children":16958},{"style":1073},[16959],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16961,"children":16962},{"style":2215},[16963],{"type":55,"value":16964},"DEBUG\n",{"type":49,"tag":1060,"props":16966,"children":16967},{"class":1062,"line":1171},[16968,16973],{"type":49,"tag":1060,"props":16969,"children":16970},{"style":3839},[16971],{"type":55,"value":16972},"  volumes",{"type":49,"tag":1060,"props":16974,"children":16975},{"style":1073},[16976],{"type":55,"value":6862},{"type":49,"tag":1060,"props":16978,"children":16979},{"class":1062,"line":1180},[16980,16984],{"type":49,"tag":1060,"props":16981,"children":16982},{"style":1073},[16983],{"type":55,"value":6899},{"type":49,"tag":1060,"props":16985,"children":16986},{"style":2215},[16987],{"type":55,"value":16988},"backendassets:/code/assets\n",{"type":49,"tag":1060,"props":16990,"children":16991},{"class":1062,"line":1188},[16992,16997],{"type":49,"tag":1060,"props":16993,"children":16994},{"style":3839},[16995],{"type":55,"value":16996},"  depends_on",{"type":49,"tag":1060,"props":16998,"children":16999},{"style":1073},[17000],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17002,"children":17003},{"class":1062,"line":1201},[17004,17008],{"type":49,"tag":1060,"props":17005,"children":17006},{"style":1073},[17007],{"type":55,"value":6899},{"type":49,"tag":1060,"props":17009,"children":17010},{"style":2215},[17011],{"type":55,"value":17012},"postgres\n",{"type":49,"tag":1060,"props":17014,"children":17015},{"class":1062,"line":1210},[17016,17020],{"type":49,"tag":1060,"props":17017,"children":17018},{"style":1073},[17019],{"type":55,"value":6899},{"type":49,"tag":1060,"props":17021,"children":17022},{"style":2215},[17023],{"type":55,"value":17024},"redis\n",{"type":49,"tag":1060,"props":17026,"children":17027},{"class":1062,"line":1218},[17028,17032],{"type":49,"tag":1060,"props":17029,"children":17030},{"style":1073},[17031],{"type":55,"value":6899},{"type":49,"tag":1060,"props":17033,"children":17034},{"style":2215},[17035],{"type":55,"value":17036},"web\n",{"type":49,"tag":58,"props":17038,"children":17039},{},[17040,17041,17046,17048,17053],{"type":55,"value":413},{"type":49,"tag":326,"props":17042,"children":17044},{"className":17043},[],[17045],{"type":55,"value":15928},{"type":55,"value":17047}," is essentially what we defined in ",{"type":49,"tag":326,"props":17049,"children":17051},{"className":17050},[],[17052],{"type":55,"value":14889},{"type":55,"value":17054},", but the syntax is slightly different:",{"type":49,"tag":1050,"props":17056,"children":17057},{"code":16892},[17058],{"type":49,"tag":326,"props":17059,"children":17060},{"__ignoreMap":8},[17061],{"type":55,"value":16892},{"type":49,"tag":58,"props":17063,"children":17064},{},[17065,17067,17072],{"type":55,"value":17066},"We pass environment variables that we defined in GitLab CI via the ",{"type":49,"tag":326,"props":17068,"children":17070},{"className":17069},[],[17071],{"type":55,"value":5113},{"type":55,"value":17073}," key.",{"type":49,"tag":58,"props":17075,"children":17076},{},[17077,17079,17085,17087,17093,17095,17101,17103,17109],{"type":55,"value":17078},"The volume ",{"type":49,"tag":326,"props":17080,"children":17082},{"className":17081},[],[17083],{"type":55,"value":17084},"backendassets",{"type":55,"value":17086}," is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at ",{"type":49,"tag":326,"props":17088,"children":17090},{"className":17089},[],[17091],{"type":55,"value":17092},"/code/assets",{"type":55,"value":17094}," and then define our ",{"type":49,"tag":326,"props":17096,"children":17098},{"className":17097},[],[17099],{"type":55,"value":17100},"STATIC_ROOT",{"type":55,"value":17102}," in Django's ",{"type":49,"tag":326,"props":17104,"children":17106},{"className":17105},[],[17107],{"type":55,"value":17108},"settings.py",{"type":55,"value":17110}," to be:",{"type":49,"tag":1050,"props":17112,"children":17116},{"code":17113,"language":17114,"meta":8,"className":17115,"style":8},"os.path.join(BASE_DIR, \"assets\", \"static\")\n","py","language-py shiki shiki-themes github-light github-dark monokai",[17117],{"type":49,"tag":326,"props":17118,"children":17119},{"__ignoreMap":8},[17120],{"type":49,"tag":1060,"props":17121,"children":17122},{"class":1062,"line":1063},[17123,17128,17133,17137,17142,17146,17151],{"type":49,"tag":1060,"props":17124,"children":17125},{"style":1073},[17126],{"type":55,"value":17127},"os.path.join(",{"type":49,"tag":1060,"props":17129,"children":17130},{"style":2287},[17131],{"type":55,"value":17132},"BASE_DIR",{"type":49,"tag":1060,"props":17134,"children":17135},{"style":1073},[17136],{"type":55,"value":873},{"type":49,"tag":1060,"props":17138,"children":17139},{"style":2215},[17140],{"type":55,"value":17141},"\"assets\"",{"type":49,"tag":1060,"props":17143,"children":17144},{"style":1073},[17145],{"type":55,"value":873},{"type":49,"tag":1060,"props":17147,"children":17148},{"style":2215},[17149],{"type":55,"value":17150},"\"static\"",{"type":49,"tag":1060,"props":17152,"children":17153},{"style":1073},[17154],{"type":55,"value":5126},{"type":49,"tag":58,"props":17156,"children":17157},{},[17158,17160,17165],{"type":55,"value":17159},"Later, when we run ",{"type":49,"tag":326,"props":17161,"children":17163},{"className":17162},[],[17164],{"type":55,"value":3316},{"type":55,"value":17166},", files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application.",{"type":49,"tag":58,"props":17168,"children":17169},{},[17170,17176,17177,17182,17184,17189,17191,17197,17199,17204,17206,17212],{"type":49,"tag":326,"props":17171,"children":17173},{"className":17172},[],[17174],{"type":55,"value":17175},"network",{"type":55,"value":715},{"type":49,"tag":326,"props":17178,"children":17180},{"className":17179},[],[17181],{"type":55,"value":8673},{"type":55,"value":17183}," related to to the other services that this application will communicate with. ",{"type":49,"tag":326,"props":17185,"children":17187},{"className":17186},[],[17188],{"type":55,"value":816},{"type":55,"value":17190}," is a network defined in the ",{"type":49,"tag":326,"props":17192,"children":17194},{"className":17193},[],[17195],{"type":55,"value":17196},"networks",{"type":55,"value":17198}," part of ",{"type":49,"tag":326,"props":17200,"children":17202},{"className":17201},[],[17203],{"type":55,"value":16793},{"type":55,"value":17205},", notice that we reference the ",{"type":49,"tag":326,"props":17207,"children":17209},{"className":17208},[],[17210],{"type":55,"value":17211},"traefik-public",{"type":55,"value":17213}," network here that we created earlier, as well.",{"type":49,"tag":2910,"props":17215,"children":17216},{},[17217],{"type":49,"tag":58,"props":17218,"children":17219},{},[17220,17222,17228],{"type":55,"value":17221},"Depends on helps with service startup order, but it is a better practice to use ",{"type":49,"tag":326,"props":17223,"children":17225},{"className":17224},[],[17226],{"type":55,"value":17227},"./wait-for-it.sh",{"type":55,"value":17229},". However, I have never had any issues related to startup order. I'll try adding this later to make things more robust.",{"type":49,"tag":58,"props":17231,"children":17232},{},[17233,17238,17239,17244,17246,17251,17253,17258,17259,17264,17266,17271,17272,17277,17278,17283,17285,17290,17292,17298,17300,17306,17308,17313],{"type":49,"tag":326,"props":17234,"children":17236},{"className":17235},[],[17237],{"type":55,"value":14056},{"type":55,"value":715},{"type":49,"tag":326,"props":17240,"children":17242},{"className":17241},[],[17243],{"type":55,"value":3151},{"type":55,"value":17245}," will start before ",{"type":49,"tag":326,"props":17247,"children":17249},{"className":17248},[],[17250],{"type":55,"value":1951},{"type":55,"value":17252},". Our Django application will communicate to these services by their hostnames: ",{"type":49,"tag":326,"props":17254,"children":17256},{"className":17255},[],[17257],{"type":55,"value":14056},{"type":55,"value":715},{"type":49,"tag":326,"props":17260,"children":17262},{"className":17261},[],[17263],{"type":55,"value":3151},{"type":55,"value":17265},". The fact that ",{"type":49,"tag":326,"props":17267,"children":17269},{"className":17268},[],[17270],{"type":55,"value":1951},{"type":55,"value":873},{"type":49,"tag":326,"props":17273,"children":17275},{"className":17274},[],[17276],{"type":55,"value":14056},{"type":55,"value":715},{"type":49,"tag":326,"props":17279,"children":17281},{"className":17280},[],[17282],{"type":55,"value":3151},{"type":55,"value":17284}," are all on the same network (",{"type":49,"tag":326,"props":17286,"children":17288},{"className":17287},[],[17289],{"type":55,"value":816},{"type":55,"value":17291},") means that they can resolve each other by these names. For example, the connection string to redis will look like: ",{"type":49,"tag":326,"props":17293,"children":17295},{"className":17294},[],[17296],{"type":55,"value":17297},"redis://redis:6379",{"type":55,"value":17299},". Let's look at the ",{"type":49,"tag":326,"props":17301,"children":17303},{"className":17302},[],[17304],{"type":55,"value":17305},"DATABASES",{"type":55,"value":17307}," configuration in ",{"type":49,"tag":326,"props":17309,"children":17311},{"className":17310},[],[17312],{"type":55,"value":17108},{"type":55,"value":17314}," to see how we connect to Postgres:",{"type":49,"tag":1050,"props":17316,"children":17318},{"code":17317,"language":17114,"meta":8,"className":17115,"style":8},"DATABASES = {\n    \"default\": {\n        \"ENGINE\": \"django.db.backends.postgresql_psycopg2\",\n        \"NAME\": os.environ.get(\"POSTGRES_NAME\", \"postgres\"),\n        \"USER\": os.environ.get(\"POSTGRES_USERNAME\", \"postgres\"),\n        \"PASSWORD\": os.environ.get(\"POSTGRES_PASSWORD\", \"postgres\"),\n        \"HOST\": os.environ.get(\"POSTGRES_SERVICE_HOST\", \"postgres\"),\n        \"PORT\": os.environ.get(\"POSTGRES_SERVICE_PORT\", 5432),\n    }\n}\n",[17319],{"type":49,"tag":326,"props":17320,"children":17321},{"__ignoreMap":8},[17322,17337,17350,17371,17403,17432,17461,17490,17520,17527],{"type":49,"tag":1060,"props":17323,"children":17324},{"class":1062,"line":1063},[17325,17329,17333],{"type":49,"tag":1060,"props":17326,"children":17327},{"style":2287},[17328],{"type":55,"value":17305},{"type":49,"tag":1060,"props":17330,"children":17331},{"style":2194},[17332],{"type":55,"value":2197},{"type":49,"tag":1060,"props":17334,"children":17335},{"style":1073},[17336],{"type":55,"value":4010},{"type":49,"tag":1060,"props":17338,"children":17339},{"class":1062,"line":1079},[17340,17345],{"type":49,"tag":1060,"props":17341,"children":17342},{"style":2215},[17343],{"type":55,"value":17344},"    \"default\"",{"type":49,"tag":1060,"props":17346,"children":17347},{"style":1073},[17348],{"type":55,"value":17349},": {\n",{"type":49,"tag":1060,"props":17351,"children":17352},{"class":1062,"line":1088},[17353,17358,17362,17367],{"type":49,"tag":1060,"props":17354,"children":17355},{"style":2215},[17356],{"type":55,"value":17357},"        \"ENGINE\"",{"type":49,"tag":1060,"props":17359,"children":17360},{"style":1073},[17361],{"type":55,"value":78},{"type":49,"tag":1060,"props":17363,"children":17364},{"style":2215},[17365],{"type":55,"value":17366},"\"django.db.backends.postgresql_psycopg2\"",{"type":49,"tag":1060,"props":17368,"children":17369},{"style":1073},[17370],{"type":55,"value":2497},{"type":49,"tag":1060,"props":17372,"children":17373},{"class":1062,"line":1097},[17374,17379,17384,17389,17393,17398],{"type":49,"tag":1060,"props":17375,"children":17376},{"style":2215},[17377],{"type":55,"value":17378},"        \"NAME\"",{"type":49,"tag":1060,"props":17380,"children":17381},{"style":1073},[17382],{"type":55,"value":17383},": os.environ.get(",{"type":49,"tag":1060,"props":17385,"children":17386},{"style":2215},[17387],{"type":55,"value":17388},"\"POSTGRES_NAME\"",{"type":49,"tag":1060,"props":17390,"children":17391},{"style":1073},[17392],{"type":55,"value":873},{"type":49,"tag":1060,"props":17394,"children":17395},{"style":2215},[17396],{"type":55,"value":17397},"\"postgres\"",{"type":49,"tag":1060,"props":17399,"children":17400},{"style":1073},[17401],{"type":55,"value":17402},"),\n",{"type":49,"tag":1060,"props":17404,"children":17405},{"class":1062,"line":1111},[17406,17411,17415,17420,17424,17428],{"type":49,"tag":1060,"props":17407,"children":17408},{"style":2215},[17409],{"type":55,"value":17410},"        \"USER\"",{"type":49,"tag":1060,"props":17412,"children":17413},{"style":1073},[17414],{"type":55,"value":17383},{"type":49,"tag":1060,"props":17416,"children":17417},{"style":2215},[17418],{"type":55,"value":17419},"\"POSTGRES_USERNAME\"",{"type":49,"tag":1060,"props":17421,"children":17422},{"style":1073},[17423],{"type":55,"value":873},{"type":49,"tag":1060,"props":17425,"children":17426},{"style":2215},[17427],{"type":55,"value":17397},{"type":49,"tag":1060,"props":17429,"children":17430},{"style":1073},[17431],{"type":55,"value":17402},{"type":49,"tag":1060,"props":17433,"children":17434},{"class":1062,"line":1120},[17435,17440,17444,17449,17453,17457],{"type":49,"tag":1060,"props":17436,"children":17437},{"style":2215},[17438],{"type":55,"value":17439},"        \"PASSWORD\"",{"type":49,"tag":1060,"props":17441,"children":17442},{"style":1073},[17443],{"type":55,"value":17383},{"type":49,"tag":1060,"props":17445,"children":17446},{"style":2215},[17447],{"type":55,"value":17448},"\"POSTGRES_PASSWORD\"",{"type":49,"tag":1060,"props":17450,"children":17451},{"style":1073},[17452],{"type":55,"value":873},{"type":49,"tag":1060,"props":17454,"children":17455},{"style":2215},[17456],{"type":55,"value":17397},{"type":49,"tag":1060,"props":17458,"children":17459},{"style":1073},[17460],{"type":55,"value":17402},{"type":49,"tag":1060,"props":17462,"children":17463},{"class":1062,"line":1128},[17464,17469,17473,17478,17482,17486],{"type":49,"tag":1060,"props":17465,"children":17466},{"style":2215},[17467],{"type":55,"value":17468},"        \"HOST\"",{"type":49,"tag":1060,"props":17470,"children":17471},{"style":1073},[17472],{"type":55,"value":17383},{"type":49,"tag":1060,"props":17474,"children":17475},{"style":2215},[17476],{"type":55,"value":17477},"\"POSTGRES_SERVICE_HOST\"",{"type":49,"tag":1060,"props":17479,"children":17480},{"style":1073},[17481],{"type":55,"value":873},{"type":49,"tag":1060,"props":17483,"children":17484},{"style":2215},[17485],{"type":55,"value":17397},{"type":49,"tag":1060,"props":17487,"children":17488},{"style":1073},[17489],{"type":55,"value":17402},{"type":49,"tag":1060,"props":17491,"children":17492},{"class":1062,"line":1141},[17493,17498,17502,17507,17511,17516],{"type":49,"tag":1060,"props":17494,"children":17495},{"style":2215},[17496],{"type":55,"value":17497},"        \"PORT\"",{"type":49,"tag":1060,"props":17499,"children":17500},{"style":1073},[17501],{"type":55,"value":17383},{"type":49,"tag":1060,"props":17503,"children":17504},{"style":2215},[17505],{"type":55,"value":17506},"\"POSTGRES_SERVICE_PORT\"",{"type":49,"tag":1060,"props":17508,"children":17509},{"style":1073},[17510],{"type":55,"value":873},{"type":49,"tag":1060,"props":17512,"children":17513},{"style":2287},[17514],{"type":55,"value":17515},"5432",{"type":49,"tag":1060,"props":17517,"children":17518},{"style":1073},[17519],{"type":55,"value":17402},{"type":49,"tag":1060,"props":17521,"children":17522},{"class":1062,"line":1150},[17523],{"type":49,"tag":1060,"props":17524,"children":17525},{"style":1073},[17526],{"type":55,"value":3100},{"type":49,"tag":1060,"props":17528,"children":17529},{"class":1062,"line":1158},[17530],{"type":49,"tag":1060,"props":17531,"children":17532},{"style":1073},[17533],{"type":55,"value":3675},{"type":49,"tag":58,"props":17535,"children":17536},{},[17537,17539,17545,17547,17553,17555,17561],{"type":55,"value":17538},"I have defined the ",{"type":49,"tag":326,"props":17540,"children":17542},{"className":17541},[],[17543],{"type":55,"value":17544},"HOST",{"type":55,"value":17546}," to be based on the environment variable ",{"type":49,"tag":326,"props":17548,"children":17550},{"className":17549},[],[17551],{"type":55,"value":17552},"POSTGRES_HOST",{"type":55,"value":17554},", but I have not defined this environment variable, so why didn't I just say ",{"type":49,"tag":326,"props":17556,"children":17558},{"className":17557},[],[17559],{"type":55,"value":17560},"\"HOST\": \"postgres\"",{"type":55,"value":17562},"? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values.",{"type":49,"tag":58,"props":17564,"children":17565},{},[17566],{"type":55,"value":17567},"I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself.",{"type":49,"tag":430,"props":17569,"children":17570},{"id":14774},[17571],{"type":55,"value":17572},"NGINX",{"type":49,"tag":58,"props":17574,"children":17575},{},[17576,17578,17584],{"type":55,"value":17577},"The next service we should go over is ",{"type":49,"tag":326,"props":17579,"children":17581},{"className":17580},[],[17582],{"type":55,"value":17583},"web",{"type":55,"value":17585},", the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:",{"type":49,"tag":8994,"props":17587,"children":17588},{},[17589,17594,17599],{"type":49,"tag":68,"props":17590,"children":17591},{},[17592],{"type":55,"value":17593},"Reverse proxy",{"type":49,"tag":68,"props":17595,"children":17596},{},[17597],{"type":55,"value":17598},"Serve static files for Django",{"type":49,"tag":68,"props":17600,"children":17601},{},[17602],{"type":55,"value":17603},"Serve a frontend Javascript application",{"type":49,"tag":58,"props":17605,"children":17606},{},[17607,17609,17614],{"type":55,"value":17608},"Here's the definition of this service in ",{"type":49,"tag":326,"props":17610,"children":17612},{"className":17611},[],[17613],{"type":55,"value":16793},{"type":55,"value":6694},{"type":49,"tag":1050,"props":17616,"children":17618},{"code":17617,"language":15417,"meta":8,"className":15418,"style":8},"services:\n  web:\n    image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n    networks:\n      - traefik-public\n      - main\n    volumes:\n      - backendassets:/usr/src/app/assets\n    deploy:\n      labels:\n        - 'traefik.enable=true'\n        - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n        - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n        - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n        - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",[17619],{"type":49,"tag":326,"props":17620,"children":17621},{"__ignoreMap":8},[17622,17633,17645,17662,17674,17686,17697,17709,17721,17733,17745,17758,17770,17782,17794],{"type":49,"tag":1060,"props":17623,"children":17624},{"class":1062,"line":1063},[17625,17629],{"type":49,"tag":1060,"props":17626,"children":17627},{"style":3839},[17628],{"type":55,"value":15936},{"type":49,"tag":1060,"props":17630,"children":17631},{"style":1073},[17632],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17634,"children":17635},{"class":1062,"line":1079},[17636,17641],{"type":49,"tag":1060,"props":17637,"children":17638},{"style":3839},[17639],{"type":55,"value":17640},"  web",{"type":49,"tag":1060,"props":17642,"children":17643},{"style":1073},[17644],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17646,"children":17647},{"class":1062,"line":1088},[17648,17653,17657],{"type":49,"tag":1060,"props":17649,"children":17650},{"style":3839},[17651],{"type":55,"value":17652},"    image",{"type":49,"tag":1060,"props":17654,"children":17655},{"style":1073},[17656],{"type":55,"value":78},{"type":49,"tag":1060,"props":17658,"children":17659},{"style":2215},[17660],{"type":55,"value":17661},"${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n",{"type":49,"tag":1060,"props":17663,"children":17664},{"class":1062,"line":1097},[17665,17670],{"type":49,"tag":1060,"props":17666,"children":17667},{"style":3839},[17668],{"type":55,"value":17669},"    networks",{"type":49,"tag":1060,"props":17671,"children":17672},{"style":1073},[17673],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17675,"children":17676},{"class":1062,"line":1111},[17677,17681],{"type":49,"tag":1060,"props":17678,"children":17679},{"style":1073},[17680],{"type":55,"value":3836},{"type":49,"tag":1060,"props":17682,"children":17683},{"style":2215},[17684],{"type":55,"value":17685},"traefik-public\n",{"type":49,"tag":1060,"props":17687,"children":17688},{"class":1062,"line":1120},[17689,17693],{"type":49,"tag":1060,"props":17690,"children":17691},{"style":1073},[17692],{"type":55,"value":3836},{"type":49,"tag":1060,"props":17694,"children":17695},{"style":2215},[17696],{"type":55,"value":16916},{"type":49,"tag":1060,"props":17698,"children":17699},{"class":1062,"line":1128},[17700,17705],{"type":49,"tag":1060,"props":17701,"children":17702},{"style":3839},[17703],{"type":55,"value":17704},"    volumes",{"type":49,"tag":1060,"props":17706,"children":17707},{"style":1073},[17708],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17710,"children":17711},{"class":1062,"line":1141},[17712,17716],{"type":49,"tag":1060,"props":17713,"children":17714},{"style":1073},[17715],{"type":55,"value":3836},{"type":49,"tag":1060,"props":17717,"children":17718},{"style":2215},[17719],{"type":55,"value":17720},"backendassets:/usr/src/app/assets\n",{"type":49,"tag":1060,"props":17722,"children":17723},{"class":1062,"line":1150},[17724,17729],{"type":49,"tag":1060,"props":17725,"children":17726},{"style":3839},[17727],{"type":55,"value":17728},"    deploy",{"type":49,"tag":1060,"props":17730,"children":17731},{"style":1073},[17732],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17734,"children":17735},{"class":1062,"line":1158},[17736,17741],{"type":49,"tag":1060,"props":17737,"children":17738},{"style":3839},[17739],{"type":55,"value":17740},"      labels",{"type":49,"tag":1060,"props":17742,"children":17743},{"style":1073},[17744],{"type":55,"value":6862},{"type":49,"tag":1060,"props":17746,"children":17747},{"class":1062,"line":1171},[17748,17753],{"type":49,"tag":1060,"props":17749,"children":17750},{"style":1073},[17751],{"type":55,"value":17752},"        - ",{"type":49,"tag":1060,"props":17754,"children":17755},{"style":2215},[17756],{"type":55,"value":17757},"'traefik.enable=true'\n",{"type":49,"tag":1060,"props":17759,"children":17760},{"class":1062,"line":1180},[17761,17765],{"type":49,"tag":1060,"props":17762,"children":17763},{"style":1073},[17764],{"type":55,"value":17752},{"type":49,"tag":1060,"props":17766,"children":17767},{"style":2215},[17768],{"type":55,"value":17769},"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n",{"type":49,"tag":1060,"props":17771,"children":17772},{"class":1062,"line":1188},[17773,17777],{"type":49,"tag":1060,"props":17774,"children":17775},{"style":1073},[17776],{"type":55,"value":17752},{"type":49,"tag":1060,"props":17778,"children":17779},{"style":2215},[17780],{"type":55,"value":17781},"'traefik.http.routers.nginx-web.entrypoints=websecure'\n",{"type":49,"tag":1060,"props":17783,"children":17784},{"class":1062,"line":1201},[17785,17789],{"type":49,"tag":1060,"props":17786,"children":17787},{"style":1073},[17788],{"type":55,"value":17752},{"type":49,"tag":1060,"props":17790,"children":17791},{"style":2215},[17792],{"type":55,"value":17793},"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n",{"type":49,"tag":1060,"props":17795,"children":17796},{"class":1062,"line":1210},[17797,17801],{"type":49,"tag":1060,"props":17798,"children":17799},{"style":1073},[17800],{"type":55,"value":17752},{"type":49,"tag":1060,"props":17802,"children":17803},{"style":2215},[17804],{"type":55,"value":17805},"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",{"type":49,"tag":58,"props":17807,"children":17808},{},[17809,17811,17816,17818,17823],{"type":55,"value":17810},"For now, ignore the contents under the ",{"type":49,"tag":326,"props":17812,"children":17814},{"className":17813},[],[17815],{"type":55,"value":15369},{"type":55,"value":17817}," key; we will cover this next when we go over the ",{"type":49,"tag":326,"props":17819,"children":17821},{"className":17820},[],[17822],{"type":55,"value":14773},{"type":55,"value":17824}," service.",{"type":49,"tag":58,"props":17826,"children":17827},{},[17828,17830,17835,17836,17841,17843,17848,17850,17856],{"type":55,"value":17829},"NGINX acts as a reverse proxy when it sends request starting with ",{"type":49,"tag":326,"props":17831,"children":17833},{"className":17832},[],[17834],{"type":55,"value":8632},{"type":55,"value":8634},{"type":49,"tag":326,"props":17837,"children":17839},{"className":17838},[],[17840],{"type":55,"value":8640},{"type":55,"value":17842}," to the ",{"type":49,"tag":326,"props":17844,"children":17846},{"className":17845},[],[17847],{"type":55,"value":1951},{"type":55,"value":17849}," container. Two blocks in ",{"type":49,"tag":326,"props":17851,"children":17853},{"className":17852},[],[17854],{"type":55,"value":17855},"prod.conf",{"type":55,"value":17857}," enable this behavior:",{"type":49,"tag":1050,"props":17859,"children":17861},{"code":17860},"  upstream backend {\n    server backend:8000;\n  }\n",[17862],{"type":49,"tag":326,"props":17863,"children":17864},{"__ignoreMap":8},[17865],{"type":55,"value":17860},{"type":49,"tag":58,"props":17867,"children":17868},{},[17869,17871,17876,17878,17884,17885,17890,17892,17897,17899,17904,17906,17911,17913,17918,17919,17924,17926,17931,17933,17938],{"type":55,"value":17870},"This hostname ",{"type":49,"tag":326,"props":17872,"children":17874},{"className":17873},[],[17875],{"type":55,"value":1951},{"type":55,"value":17877}," is defined as ",{"type":49,"tag":326,"props":17879,"children":17881},{"className":17880},[],[17882],{"type":55,"value":17883},"backend:8000",{"type":55,"value":8561},{"type":49,"tag":326,"props":17886,"children":17888},{"className":17887},[],[17889],{"type":55,"value":17883},{"type":55,"value":17891}," can be resolved by the ",{"type":49,"tag":326,"props":17893,"children":17895},{"className":17894},[],[17896],{"type":55,"value":17583},{"type":55,"value":17898}," service because it is on the same ",{"type":49,"tag":326,"props":17900,"children":17902},{"className":17901},[],[17903],{"type":55,"value":816},{"type":55,"value":17905}," network that ",{"type":49,"tag":326,"props":17907,"children":17909},{"className":17908},[],[17910],{"type":55,"value":1951},{"type":55,"value":17912}," is on. If either of the ",{"type":49,"tag":326,"props":17914,"children":17916},{"className":17915},[],[17917],{"type":55,"value":17583},{"type":55,"value":8634},{"type":49,"tag":326,"props":17920,"children":17922},{"className":17921},[],[17923],{"type":55,"value":1951},{"type":55,"value":17925}," wasn't on the ",{"type":49,"tag":326,"props":17927,"children":17929},{"className":17928},[],[17930],{"type":55,"value":816},{"type":55,"value":17932}," network, NGINX would not be able to make sense of ",{"type":49,"tag":326,"props":17934,"children":17936},{"className":17935},[],[17937],{"type":55,"value":17883},{"type":55,"value":745},{"type":49,"tag":1050,"props":17940,"children":17942},{"code":17941},"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n",[17943],{"type":49,"tag":326,"props":17944,"children":17945},{"__ignoreMap":8},[17946],{"type":55,"value":17941},{"type":49,"tag":58,"props":17948,"children":17949},{},[17950,17952,17957,17959,17965],{"type":55,"value":17951},"This block does that actual request forwarding. ",{"type":49,"tag":326,"props":17953,"children":17955},{"className":17954},[],[17956],{"type":55,"value":14236},{"type":55,"value":17958}," references the ",{"type":49,"tag":326,"props":17960,"children":17962},{"className":17961},[],[17963],{"type":55,"value":17964},"upstream backend {}",{"type":55,"value":17966}," block defined above.",{"type":49,"tag":58,"props":17968,"children":17969},{},[17970,17971,17976,17978,17984,17986,17991],{"type":55,"value":17078},{"type":49,"tag":326,"props":17972,"children":17974},{"className":17973},[],[17975],{"type":55,"value":17084},{"type":55,"value":17977}," is referenced here and mounts to ",{"type":49,"tag":326,"props":17979,"children":17981},{"className":17980},[],[17982],{"type":55,"value":17983},"/usr/src/app/assets",{"type":55,"value":17985},". This path is then referenced in ",{"type":49,"tag":326,"props":17987,"children":17989},{"className":17988},[],[17990],{"type":55,"value":17855},{"type":55,"value":17992},", the NGINX configuration file that is used in our custom NGINX-based image:",{"type":49,"tag":1050,"props":17994,"children":17996},{"code":17995},"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n",[17997],{"type":49,"tag":326,"props":17998,"children":17999},{"__ignoreMap":8},[18000],{"type":55,"value":17995},{"type":49,"tag":58,"props":18002,"children":18003},{},[18004,18006,18011,18013,18019,18021,18027,18029,18035,18037,18042,18044,18050,18052,18057,18059,18064,18066,18071,18073,18078],{"type":55,"value":18005},"In this block of ",{"type":49,"tag":326,"props":18007,"children":18009},{"className":18008},[],[18010],{"type":55,"value":17855},{"type":55,"value":18012},", we tell NGINX to serve files from ",{"type":49,"tag":326,"props":18014,"children":18016},{"className":18015},[],[18017],{"type":55,"value":18018},"/usr/src/app/assets/static",{"type":55,"value":18020}," for requests that start with ",{"type":49,"tag":326,"props":18022,"children":18024},{"className":18023},[],[18025],{"type":55,"value":18026},"/static",{"type":55,"value":18028},". A request made to ",{"type":49,"tag":326,"props":18030,"children":18032},{"className":18031},[],[18033],{"type":55,"value":18034},"https://mysite.com/static/base.css",{"type":55,"value":18036}," would return a file located at ",{"type":49,"tag":326,"props":18038,"children":18040},{"className":18039},[],[18041],{"type":55,"value":18018},{"type":55,"value":18043}," if that file existed. Remember, when we run the ",{"type":49,"tag":326,"props":18045,"children":18047},{"className":18046},[],[18048],{"type":55,"value":18049},"collecstatic",{"type":55,"value":18051}," management command in our Django container, it will collect our static files to ",{"type":49,"tag":326,"props":18053,"children":18055},{"className":18054},[],[18056],{"type":55,"value":17084},{"type":55,"value":18058},". Since ",{"type":49,"tag":326,"props":18060,"children":18062},{"className":18061},[],[18063],{"type":55,"value":17084},{"type":55,"value":18065}," is mounted to the ",{"type":49,"tag":326,"props":18067,"children":18069},{"className":18068},[],[18070],{"type":55,"value":17583},{"type":55,"value":18072}," service at ",{"type":49,"tag":326,"props":18074,"children":18076},{"className":18075},[],[18077],{"type":55,"value":17983},{"type":55,"value":18079},", NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container.",{"type":49,"tag":58,"props":18081,"children":18082},{},[18083,18085,18090],{"type":55,"value":18084},"Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the ",{"type":49,"tag":326,"props":18086,"children":18088},{"className":18087},[],[18089],{"type":55,"value":14774},{"type":55,"value":18091}," container:",{"type":49,"tag":1050,"props":18093,"children":18096},{"code":18094,"language":15746,"meta":8,"className":18095,"style":8},"# # build stage\n# FROM node:10-alpine as build-stage\n# WORKDIR /app/\n# COPY frontend/package.json /app/\n# RUN npm cache verify\n# RUN npm install\n# COPY frontend /app/\n# RUN npm run build\n\n# production stage\n# FROM nginx:1.19.1-alpine as production-stage\nFROM nginx:1.19.1-alpine\nCOPY nginx/prod/prod.conf /etc/nginx/nginx.conf\nCOPY nginx/prod/index.html /dist/\n# COPY --from=build-stage /app/dist /dist/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n","language-Dockerfile shiki shiki-themes github-light github-dark monokai",[18097],{"type":49,"tag":326,"props":18098,"children":18099},{"__ignoreMap":8},[18100,18108,18116,18124,18132,18140,18148,18156,18164,18171,18179,18187,18195,18203,18211,18219,18227],{"type":49,"tag":1060,"props":18101,"children":18102},{"class":1062,"line":1063},[18103],{"type":49,"tag":1060,"props":18104,"children":18105},{},[18106],{"type":55,"value":18107},"# # build stage\n",{"type":49,"tag":1060,"props":18109,"children":18110},{"class":1062,"line":1079},[18111],{"type":49,"tag":1060,"props":18112,"children":18113},{},[18114],{"type":55,"value":18115},"# FROM node:10-alpine as build-stage\n",{"type":49,"tag":1060,"props":18117,"children":18118},{"class":1062,"line":1088},[18119],{"type":49,"tag":1060,"props":18120,"children":18121},{},[18122],{"type":55,"value":18123},"# WORKDIR /app/\n",{"type":49,"tag":1060,"props":18125,"children":18126},{"class":1062,"line":1097},[18127],{"type":49,"tag":1060,"props":18128,"children":18129},{},[18130],{"type":55,"value":18131},"# COPY frontend/package.json /app/\n",{"type":49,"tag":1060,"props":18133,"children":18134},{"class":1062,"line":1111},[18135],{"type":49,"tag":1060,"props":18136,"children":18137},{},[18138],{"type":55,"value":18139},"# RUN npm cache verify\n",{"type":49,"tag":1060,"props":18141,"children":18142},{"class":1062,"line":1120},[18143],{"type":49,"tag":1060,"props":18144,"children":18145},{},[18146],{"type":55,"value":18147},"# RUN npm install\n",{"type":49,"tag":1060,"props":18149,"children":18150},{"class":1062,"line":1128},[18151],{"type":49,"tag":1060,"props":18152,"children":18153},{},[18154],{"type":55,"value":18155},"# COPY frontend /app/\n",{"type":49,"tag":1060,"props":18157,"children":18158},{"class":1062,"line":1141},[18159],{"type":49,"tag":1060,"props":18160,"children":18161},{},[18162],{"type":55,"value":18163},"# RUN npm run build\n",{"type":49,"tag":1060,"props":18165,"children":18166},{"class":1062,"line":1150},[18167],{"type":49,"tag":1060,"props":18168,"children":18169},{"emptyLinePlaceholder":44},[18170],{"type":55,"value":1094},{"type":49,"tag":1060,"props":18172,"children":18173},{"class":1062,"line":1158},[18174],{"type":49,"tag":1060,"props":18175,"children":18176},{},[18177],{"type":55,"value":18178},"# production stage\n",{"type":49,"tag":1060,"props":18180,"children":18181},{"class":1062,"line":1171},[18182],{"type":49,"tag":1060,"props":18183,"children":18184},{},[18185],{"type":55,"value":18186},"# FROM nginx:1.19.1-alpine as production-stage\n",{"type":49,"tag":1060,"props":18188,"children":18189},{"class":1062,"line":1180},[18190],{"type":49,"tag":1060,"props":18191,"children":18192},{},[18193],{"type":55,"value":18194},"FROM nginx:1.19.1-alpine\n",{"type":49,"tag":1060,"props":18196,"children":18197},{"class":1062,"line":1188},[18198],{"type":49,"tag":1060,"props":18199,"children":18200},{},[18201],{"type":55,"value":18202},"COPY nginx/prod/prod.conf /etc/nginx/nginx.conf\n",{"type":49,"tag":1060,"props":18204,"children":18205},{"class":1062,"line":1201},[18206],{"type":49,"tag":1060,"props":18207,"children":18208},{},[18209],{"type":55,"value":18210},"COPY nginx/prod/index.html /dist/\n",{"type":49,"tag":1060,"props":18212,"children":18213},{"class":1062,"line":1210},[18214],{"type":49,"tag":1060,"props":18215,"children":18216},{},[18217],{"type":55,"value":18218},"# COPY --from=build-stage /app/dist /dist/\n",{"type":49,"tag":1060,"props":18220,"children":18221},{"class":1062,"line":1218},[18222],{"type":49,"tag":1060,"props":18223,"children":18224},{},[18225],{"type":55,"value":18226},"EXPOSE 80\n",{"type":49,"tag":1060,"props":18228,"children":18229},{"class":1062,"line":1232},[18230],{"type":49,"tag":1060,"props":18231,"children":18232},{},[18233],{"type":55,"value":18234},"CMD [\"nginx\", \"-g\", \"daemon off;\"]\n",{"type":49,"tag":58,"props":18236,"children":18237},{},[18238],{"type":55,"value":18239},"Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:",{"type":49,"tag":1050,"props":18241,"children":18243},{"code":18242,"language":15746,"meta":8,"className":18095,"style":8},"COPY --from=build-stage /app/dist /dist/\n",[18244],{"type":49,"tag":326,"props":18245,"children":18246},{"__ignoreMap":8},[18247],{"type":49,"tag":1060,"props":18248,"children":18249},{"class":1062,"line":1063},[18250],{"type":49,"tag":1060,"props":18251,"children":18252},{},[18253],{"type":55,"value":18242},{"type":49,"tag":58,"props":18255,"children":18256},{},[18257,18259,18265,18267,18272],{"type":55,"value":18258},"This would copy the build files for our Javascript application into the ",{"type":49,"tag":326,"props":18260,"children":18262},{"className":18261},[],[18263],{"type":55,"value":18264},"/dist/",{"type":55,"value":18266}," folder of our NGINX container. Another few declarations and blocks in ",{"type":49,"tag":326,"props":18268,"children":18270},{"className":18269},[],[18271],{"type":55,"value":17855},{"type":55,"value":18273}," allow all other requests to be served by the contents of this folder:",{"type":49,"tag":1050,"props":18275,"children":18277},{"code":18276},"    root /dist/;\n    index index.html;\n",[18278],{"type":49,"tag":326,"props":18279,"children":18280},{"__ignoreMap":8},[18281],{"type":55,"value":18276},{"type":49,"tag":58,"props":18283,"children":18284},{},[18285],{"type":55,"value":18286},"This sets the root and the index document for our NGINX webserver.",{"type":49,"tag":1050,"props":18288,"children":18290},{"code":18289},"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n",[18291],{"type":49,"tag":326,"props":18292,"children":18293},{"__ignoreMap":8},[18294],{"type":55,"value":18289},{"type":49,"tag":58,"props":18296,"children":18297},{},[18298,18300,18306,18308,18313,18315,18320,18321,18326,18327,18332],{"type":55,"value":18299},"These two blocks route all other requests to the frontend Javascript app's ",{"type":49,"tag":326,"props":18301,"children":18303},{"className":18302},[],[18304],{"type":55,"value":18305},"index.html",{"type":55,"value":18307}," file location in ",{"type":49,"tag":326,"props":18309,"children":18311},{"className":18310},[],[18312],{"type":55,"value":18264},{"type":55,"value":18314}," (any request that doesn't start with ",{"type":49,"tag":326,"props":18316,"children":18318},{"className":18317},[],[18319],{"type":55,"value":18026},{"type":55,"value":873},{"type":49,"tag":326,"props":18322,"children":18324},{"className":18323},[],[18325],{"type":55,"value":8632},{"type":55,"value":8634},{"type":49,"tag":326,"props":18328,"children":18330},{"className":18329},[],[18331],{"type":55,"value":8640},{"type":55,"value":18333},"). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path.",{"type":49,"tag":58,"props":18335,"children":18336},{},[18337,18339,18344,18346,18352,18354,18360,18362,18367],{"type":55,"value":18338},"Lastly, the ",{"type":49,"tag":326,"props":18340,"children":18342},{"className":18341},[],[18343],{"type":55,"value":17583},{"type":55,"value":18345}," service's ",{"type":49,"tag":326,"props":18347,"children":18349},{"className":18348},[],[18350],{"type":55,"value":18351},"deployment",{"type":55,"value":18353}," key has some ",{"type":49,"tag":326,"props":18355,"children":18357},{"className":18356},[],[18358],{"type":55,"value":18359},"labels",{"type":55,"value":18361}," defined for Traefik. Let's come back to these after having a look at the ",{"type":49,"tag":326,"props":18363,"children":18365},{"className":18364},[],[18366],{"type":55,"value":14773},{"type":55,"value":17824},{"type":49,"tag":430,"props":18369,"children":18370},{"id":14773},[18371],{"type":55,"value":18372},"Traefik",{"type":49,"tag":58,"props":18374,"children":18375},{},[18376],{"type":49,"tag":1601,"props":18377,"children":18379},{"alt":8926,"src":18378},"https://docs.traefik.io/assets/img/traefik-architecture.png",[],{"type":49,"tag":2910,"props":18381,"children":18382},{},[18383],{"type":49,"tag":58,"props":18384,"children":18385},{},[18386,18388],{"type":55,"value":18387},"Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- ",{"type":49,"tag":80,"props":18389,"children":18392},{"href":18390,"rel":18391},"https://docs.traefik.io/",[84],[18393],{"type":55,"value":18390},{"type":49,"tag":58,"props":18395,"children":18396},{},[18397],{"type":55,"value":18398},"Traefik has three main functions in my application:",{"type":49,"tag":8994,"props":18400,"children":18401},{},[18402,18407,18412],{"type":49,"tag":68,"props":18403,"children":18404},{},[18405],{"type":55,"value":18406},"Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS",{"type":49,"tag":68,"props":18408,"children":18409},{},[18410],{"type":55,"value":18411},"Do TLS termination",{"type":49,"tag":68,"props":18413,"children":18414},{},[18415],{"type":55,"value":18416},"Route all requests to NGINX",{"type":49,"tag":58,"props":18418,"children":18419},{},[18420],{"type":55,"value":18421},"The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed \"fun and easy\", especially when it comes to requesting certificates.",{"type":49,"tag":2910,"props":18423,"children":18424},{},[18425],{"type":49,"tag":58,"props":18426,"children":18427},{},[18428],{"type":55,"value":18429},"I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs.",{"type":49,"tag":58,"props":18431,"children":18432},{},[18433],{"type":55,"value":18434},"There are two main ways to set up Traefik:",{"type":49,"tag":8994,"props":18436,"children":18437},{},[18438,18457],{"type":49,"tag":68,"props":18439,"children":18440},{},[18441,18443,18449,18451,18456],{"type":55,"value":18442},"write a ",{"type":49,"tag":326,"props":18444,"children":18446},{"className":18445},[],[18447],{"type":55,"value":18448},"traefik.toml",{"type":55,"value":18450}," file and build this into your own custom image (similar to what we do with NGINX and ",{"type":49,"tag":326,"props":18452,"children":18454},{"className":18453},[],[18455],{"type":55,"value":17855},{"type":55,"value":616},{"type":49,"tag":68,"props":18458,"children":18459},{},[18460],{"type":55,"value":18461},"use a base image and specify all configure options through command line arguments.",{"type":49,"tag":58,"props":18463,"children":18464},{},[18465,18467,18472,18474,18479],{"type":55,"value":18466},"I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in ",{"type":49,"tag":326,"props":18468,"children":18470},{"className":18469},[],[18471],{"type":55,"value":16793},{"type":55,"value":18473}," (for now all the values I'm using in the ",{"type":49,"tag":326,"props":18475,"children":18477},{"className":18476},[],[18478],{"type":55,"value":14773},{"type":55,"value":18480}," service are hard-coded, this is one more item for my ToDo list on this project).",{"type":49,"tag":58,"props":18482,"children":18483},{},[18484,18486,18491,18493,18500,18502,18509],{"type":55,"value":18485},"I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses ",{"type":49,"tag":326,"props":18487,"children":18489},{"className":18488},[],[18490],{"type":55,"value":14142},{"type":55,"value":18492},". There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled ",{"type":49,"tag":80,"props":18494,"children":18497},{"href":18495,"rel":18496},"https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/",[84],[18498],{"type":55,"value":18499},"How to install Traefik 2.x on a Docker Swarm",{"type":55,"value":18501}," helped me a lot in figuring out how to get everything working. Thank you for the great article, ",{"type":49,"tag":80,"props":18503,"children":18506},{"href":18504,"rel":18505},"https://github.com/creekorful",[84],[18507],{"type":55,"value":18508},"Aloïs",{"type":55,"value":18510},"!",{"type":49,"tag":58,"props":18512,"children":18513},{},[18514],{"type":55,"value":18515},"Here's the code that sets up the traefik service:",{"type":49,"tag":1050,"props":18517,"children":18519},{"code":18518,"language":15417,"meta":8,"className":15418,"style":8},"services:\n  traefik:\n    image: traefik:v2.0.2\n    ports:\n      - '80:80'\n      - '443:443'\n    command:\n      - '--providers.docker.endpoint=unix:///var/run/docker.sock'\n      - '--providers.docker.swarmMode=true'\n      - '--providers.docker.exposedbydefault=false'\n      - '--providers.docker.network=traefik-public'\n      - '--entrypoints.web.address=:80'\n      - '--entrypoints.websecure.address=:443'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n      - '--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n      - '--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n    volumes:\n      - letsencrypt:/letsencrypt\n      - /var/run/docker.sock:/var/run/docker.sock\n    networks:\n      - traefik-public\n    deploy:\n      placement:\n        constraints:\n          - node.role == manager\n",[18520],{"type":49,"tag":326,"props":18521,"children":18522},{"__ignoreMap":8},[18523,18534,18546,18562,18574,18586,18598,18610,18622,18634,18646,18658,18670,18682,18694,18706,18718,18730,18741,18753,18765,18776,18787,18798,18810,18822],{"type":49,"tag":1060,"props":18524,"children":18525},{"class":1062,"line":1063},[18526,18530],{"type":49,"tag":1060,"props":18527,"children":18528},{"style":3839},[18529],{"type":55,"value":15936},{"type":49,"tag":1060,"props":18531,"children":18532},{"style":1073},[18533],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18535,"children":18536},{"class":1062,"line":1079},[18537,18542],{"type":49,"tag":1060,"props":18538,"children":18539},{"style":3839},[18540],{"type":55,"value":18541},"  traefik",{"type":49,"tag":1060,"props":18543,"children":18544},{"style":1073},[18545],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18547,"children":18548},{"class":1062,"line":1088},[18549,18553,18557],{"type":49,"tag":1060,"props":18550,"children":18551},{"style":3839},[18552],{"type":55,"value":17652},{"type":49,"tag":1060,"props":18554,"children":18555},{"style":1073},[18556],{"type":55,"value":78},{"type":49,"tag":1060,"props":18558,"children":18559},{"style":2215},[18560],{"type":55,"value":18561},"traefik:v2.0.2\n",{"type":49,"tag":1060,"props":18563,"children":18564},{"class":1062,"line":1097},[18565,18570],{"type":49,"tag":1060,"props":18566,"children":18567},{"style":3839},[18568],{"type":55,"value":18569},"    ports",{"type":49,"tag":1060,"props":18571,"children":18572},{"style":1073},[18573],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18575,"children":18576},{"class":1062,"line":1111},[18577,18581],{"type":49,"tag":1060,"props":18578,"children":18579},{"style":1073},[18580],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18582,"children":18583},{"style":2215},[18584],{"type":55,"value":18585},"'80:80'\n",{"type":49,"tag":1060,"props":18587,"children":18588},{"class":1062,"line":1120},[18589,18593],{"type":49,"tag":1060,"props":18590,"children":18591},{"style":1073},[18592],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18594,"children":18595},{"style":2215},[18596],{"type":55,"value":18597},"'443:443'\n",{"type":49,"tag":1060,"props":18599,"children":18600},{"class":1062,"line":1128},[18601,18606],{"type":49,"tag":1060,"props":18602,"children":18603},{"style":3839},[18604],{"type":55,"value":18605},"    command",{"type":49,"tag":1060,"props":18607,"children":18608},{"style":1073},[18609],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18611,"children":18612},{"class":1062,"line":1141},[18613,18617],{"type":49,"tag":1060,"props":18614,"children":18615},{"style":1073},[18616],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18618,"children":18619},{"style":2215},[18620],{"type":55,"value":18621},"'--providers.docker.endpoint=unix:///var/run/docker.sock'\n",{"type":49,"tag":1060,"props":18623,"children":18624},{"class":1062,"line":1150},[18625,18629],{"type":49,"tag":1060,"props":18626,"children":18627},{"style":1073},[18628],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18630,"children":18631},{"style":2215},[18632],{"type":55,"value":18633},"'--providers.docker.swarmMode=true'\n",{"type":49,"tag":1060,"props":18635,"children":18636},{"class":1062,"line":1158},[18637,18641],{"type":49,"tag":1060,"props":18638,"children":18639},{"style":1073},[18640],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18642,"children":18643},{"style":2215},[18644],{"type":55,"value":18645},"'--providers.docker.exposedbydefault=false'\n",{"type":49,"tag":1060,"props":18647,"children":18648},{"class":1062,"line":1171},[18649,18653],{"type":49,"tag":1060,"props":18650,"children":18651},{"style":1073},[18652],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18654,"children":18655},{"style":2215},[18656],{"type":55,"value":18657},"'--providers.docker.network=traefik-public'\n",{"type":49,"tag":1060,"props":18659,"children":18660},{"class":1062,"line":1180},[18661,18665],{"type":49,"tag":1060,"props":18662,"children":18663},{"style":1073},[18664],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18666,"children":18667},{"style":2215},[18668],{"type":55,"value":18669},"'--entrypoints.web.address=:80'\n",{"type":49,"tag":1060,"props":18671,"children":18672},{"class":1062,"line":1188},[18673,18677],{"type":49,"tag":1060,"props":18674,"children":18675},{"style":1073},[18676],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18678,"children":18679},{"style":2215},[18680],{"type":55,"value":18681},"'--entrypoints.websecure.address=:443'\n",{"type":49,"tag":1060,"props":18683,"children":18684},{"class":1062,"line":1201},[18685,18689],{"type":49,"tag":1060,"props":18686,"children":18687},{"style":1073},[18688],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18690,"children":18691},{"style":2215},[18692],{"type":55,"value":18693},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n",{"type":49,"tag":1060,"props":18695,"children":18696},{"class":1062,"line":1210},[18697,18701],{"type":49,"tag":1060,"props":18698,"children":18699},{"style":1073},[18700],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18702,"children":18703},{"style":2215},[18704],{"type":55,"value":18705},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n",{"type":49,"tag":1060,"props":18707,"children":18708},{"class":1062,"line":1218},[18709,18713],{"type":49,"tag":1060,"props":18710,"children":18711},{"style":1073},[18712],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18714,"children":18715},{"style":2215},[18716],{"type":55,"value":18717},"'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n",{"type":49,"tag":1060,"props":18719,"children":18720},{"class":1062,"line":1232},[18721,18725],{"type":49,"tag":1060,"props":18722,"children":18723},{"style":1073},[18724],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18726,"children":18727},{"style":2215},[18728],{"type":55,"value":18729},"'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n",{"type":49,"tag":1060,"props":18731,"children":18732},{"class":1062,"line":1241},[18733,18737],{"type":49,"tag":1060,"props":18734,"children":18735},{"style":3839},[18736],{"type":55,"value":17704},{"type":49,"tag":1060,"props":18738,"children":18739},{"style":1073},[18740],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18742,"children":18743},{"class":1062,"line":1249},[18744,18748],{"type":49,"tag":1060,"props":18745,"children":18746},{"style":1073},[18747],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18749,"children":18750},{"style":2215},[18751],{"type":55,"value":18752},"letsencrypt:/letsencrypt\n",{"type":49,"tag":1060,"props":18754,"children":18755},{"class":1062,"line":1262},[18756,18760],{"type":49,"tag":1060,"props":18757,"children":18758},{"style":1073},[18759],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18761,"children":18762},{"style":2215},[18763],{"type":55,"value":18764},"/var/run/docker.sock:/var/run/docker.sock\n",{"type":49,"tag":1060,"props":18766,"children":18767},{"class":1062,"line":4581},[18768,18772],{"type":49,"tag":1060,"props":18769,"children":18770},{"style":3839},[18771],{"type":55,"value":17669},{"type":49,"tag":1060,"props":18773,"children":18774},{"style":1073},[18775],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18777,"children":18778},{"class":1062,"line":4631},[18779,18783],{"type":49,"tag":1060,"props":18780,"children":18781},{"style":1073},[18782],{"type":55,"value":3836},{"type":49,"tag":1060,"props":18784,"children":18785},{"style":2215},[18786],{"type":55,"value":17685},{"type":49,"tag":1060,"props":18788,"children":18789},{"class":1062,"line":4682},[18790,18794],{"type":49,"tag":1060,"props":18791,"children":18792},{"style":3839},[18793],{"type":55,"value":17728},{"type":49,"tag":1060,"props":18795,"children":18796},{"style":1073},[18797],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18799,"children":18800},{"class":1062,"line":4709},[18801,18806],{"type":49,"tag":1060,"props":18802,"children":18803},{"style":3839},[18804],{"type":55,"value":18805},"      placement",{"type":49,"tag":1060,"props":18807,"children":18808},{"style":1073},[18809],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18811,"children":18812},{"class":1062,"line":5979},[18813,18818],{"type":49,"tag":1060,"props":18814,"children":18815},{"style":3839},[18816],{"type":55,"value":18817},"        constraints",{"type":49,"tag":1060,"props":18819,"children":18820},{"style":1073},[18821],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18823,"children":18824},{"class":1062,"line":5988},[18825,18830],{"type":49,"tag":1060,"props":18826,"children":18827},{"style":1073},[18828],{"type":55,"value":18829},"          - ",{"type":49,"tag":1060,"props":18831,"children":18832},{"style":2215},[18833],{"type":55,"value":18834},"node.role == manager\n",{"type":49,"tag":2910,"props":18836,"children":18837},{},[18838],{"type":49,"tag":58,"props":18839,"children":18840},{},[18841],{"type":55,"value":18842},"The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad.",{"type":49,"tag":58,"props":18844,"children":18845},{},[18846,18851,18852,18858,18860,18865],{"type":49,"tag":326,"props":18847,"children":18849},{"className":18848},[],[18850],{"type":55,"value":17583},{"type":55,"value":715},{"type":49,"tag":326,"props":18853,"children":18855},{"className":18854},[],[18856],{"type":55,"value":18857},"websecure",{"type":55,"value":18859}," refer to values declared on the ",{"type":49,"tag":326,"props":18861,"children":18863},{"className":18862},[],[18864],{"type":55,"value":17583},{"type":55,"value":18866}," service. Let's take a look at those values:",{"type":49,"tag":1050,"props":18868,"children":18870},{"code":18869,"language":3823,"meta":8,"className":3824,"style":8},"deploy:\n  labels:\n    - 'traefik.enable=true'\n    - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n    - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n    - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n    - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",[18871],{"type":49,"tag":326,"props":18872,"children":18873},{"__ignoreMap":8},[18874,18885,18897,18908,18919,18930,18941],{"type":49,"tag":1060,"props":18875,"children":18876},{"class":1062,"line":1063},[18877,18881],{"type":49,"tag":1060,"props":18878,"children":18879},{"style":3839},[18880],{"type":55,"value":15369},{"type":49,"tag":1060,"props":18882,"children":18883},{"style":1073},[18884],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18886,"children":18887},{"class":1062,"line":1079},[18888,18893],{"type":49,"tag":1060,"props":18889,"children":18890},{"style":3839},[18891],{"type":55,"value":18892},"  labels",{"type":49,"tag":1060,"props":18894,"children":18895},{"style":1073},[18896],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18898,"children":18899},{"class":1062,"line":1088},[18900,18904],{"type":49,"tag":1060,"props":18901,"children":18902},{"style":1073},[18903],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18905,"children":18906},{"style":2215},[18907],{"type":55,"value":17757},{"type":49,"tag":1060,"props":18909,"children":18910},{"class":1062,"line":1097},[18911,18915],{"type":49,"tag":1060,"props":18912,"children":18913},{"style":1073},[18914],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18916,"children":18917},{"style":2215},[18918],{"type":55,"value":17769},{"type":49,"tag":1060,"props":18920,"children":18921},{"class":1062,"line":1111},[18922,18926],{"type":49,"tag":1060,"props":18923,"children":18924},{"style":1073},[18925],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18927,"children":18928},{"style":2215},[18929],{"type":55,"value":17781},{"type":49,"tag":1060,"props":18931,"children":18932},{"class":1062,"line":1120},[18933,18937],{"type":49,"tag":1060,"props":18934,"children":18935},{"style":1073},[18936],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18938,"children":18939},{"style":2215},[18940],{"type":55,"value":17793},{"type":49,"tag":1060,"props":18942,"children":18943},{"class":1062,"line":1128},[18944,18948],{"type":49,"tag":1060,"props":18945,"children":18946},{"style":1073},[18947],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18949,"children":18950},{"style":2215},[18951],{"type":55,"value":17805},{"type":49,"tag":58,"props":18953,"children":18954},{},[18955,18957,18962],{"type":55,"value":18956},"I still need to setup HTTP -> HTTPS redirecting, so for now only ",{"type":49,"tag":326,"props":18958,"children":18960},{"className":18959},[],[18961],{"type":55,"value":18857},{"type":55,"value":18963}," is defined, but Aloïs explains this clearly in his article.",{"type":49,"tag":2910,"props":18965,"children":18966},{},[18967],{"type":49,"tag":58,"props":18968,"children":18969},{},[18970],{"type":55,"value":18971},"For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK.",{"type":49,"tag":58,"props":18973,"children":18974},{},[18975,18977,18982],{"type":55,"value":18976},"That wraps up our overview of ",{"type":49,"tag":326,"props":18978,"children":18980},{"className":18979},[],[18981],{"type":55,"value":16793},{"type":55,"value":18983},", we left off with the following command:",{"type":49,"tag":1050,"props":18985,"children":18986},{"code":16525},[18987],{"type":49,"tag":326,"props":18988,"children":18989},{"__ignoreMap":8},[18990],{"type":55,"value":16525},{"type":49,"tag":58,"props":18992,"children":18993},{},[18994,18996,19001],{"type":55,"value":18995},"We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the ",{"type":49,"tag":326,"props":18997,"children":18999},{"className":18998},[],[19000],{"type":55,"value":14646},{"type":55,"value":19002}," environment variable that I showed you earlier and run these commands from your local terminal:",{"type":49,"tag":1050,"props":19004,"children":19006},{"code":19005},"docker stack ps my-stack --no-trunc\n",[19007],{"type":49,"tag":326,"props":19008,"children":19009},{"__ignoreMap":8},[19010],{"type":55,"value":19005},{"type":49,"tag":58,"props":19012,"children":19013},{},[19014,19020,19022,19028],{"type":49,"tag":326,"props":19015,"children":19017},{"className":19016},[],[19018],{"type":55,"value":19019},"--no-trunc",{"type":55,"value":19021}," is important because important error messages tend to be cut off. This option will show the full version of each column returned by ",{"type":49,"tag":326,"props":19023,"children":19025},{"className":19024},[],[19026],{"type":55,"value":19027},"docker stack ps",{"type":55,"value":745},{"type":49,"tag":1050,"props":19030,"children":19032},{"code":19031},"docker service ls\n",[19033],{"type":49,"tag":326,"props":19034,"children":19035},{"__ignoreMap":8},[19036],{"type":55,"value":19031},{"type":49,"tag":58,"props":19038,"children":19039},{},[19040],{"type":55,"value":19041},"This command shows some the active services on our Droplet.",{"type":49,"tag":1050,"props":19043,"children":19045},{"code":19044},"docker ps\n",[19046],{"type":49,"tag":326,"props":19047,"children":19048},{"__ignoreMap":8},[19049],{"type":55,"value":19044},{"type":49,"tag":58,"props":19051,"children":19052},{},[19053],{"type":55,"value":19054},"This command is useful for shelling into a container to run commands and poke around for debugging.",{"type":49,"tag":58,"props":19056,"children":19057},{},[19058],{"type":55,"value":19059},"You can get the Container ID of a running container and access it with the following command:",{"type":49,"tag":1050,"props":19061,"children":19063},{"code":19062},"docker exec -it 0da8370ab283 bash\n",[19064],{"type":49,"tag":326,"props":19065,"children":19066},{"__ignoreMap":8},[19067],{"type":55,"value":19062},{"type":49,"tag":58,"props":19069,"children":19070},{},[19071,19073,19078,19080,19086],{"type":55,"value":19072},"This assumes that ",{"type":49,"tag":326,"props":19074,"children":19076},{"className":19075},[],[19077],{"type":55,"value":2728},{"type":55,"value":19079}," is installed on the container with ID ",{"type":49,"tag":326,"props":19081,"children":19083},{"className":19082},[],[19084],{"type":55,"value":19085},"0da8370ab283",{"type":55,"value":745},{"type":49,"tag":50,"props":19088,"children":19090},{"id":19089},"management-commands",[19091],{"type":55,"value":19092},"Management commands",{"type":49,"tag":58,"props":19094,"children":19095},{},[19096],{"type":55,"value":19097},"Once the site is deployed we stil need to run a few commands to set up our Djnago application:",{"type":49,"tag":8994,"props":19099,"children":19100},{},[19101,19105,19109],{"type":49,"tag":68,"props":19102,"children":19103},{},[19104],{"type":55,"value":3316},{"type":49,"tag":68,"props":19106,"children":19107},{},[19108],{"type":55,"value":3323},{"type":49,"tag":68,"props":19110,"children":19111},{},[19112],{"type":55,"value":19113},"createsuperuser",{"type":49,"tag":2910,"props":19115,"children":19116},{},[19117],{"type":49,"tag":58,"props":19118,"children":19119},{},[19120],{"type":55,"value":19121},"One other ToDo is to figure out how to run these commands through manual GitLab CI jobs.",{"type":49,"tag":58,"props":19123,"children":19124},{},[19125],{"type":55,"value":19126},"That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean.",{"type":49,"tag":50,"props":19128,"children":19129},{"id":14494},[19130],{"type":55,"value":14497},{"type":49,"tag":58,"props":19132,"children":19133},{},[19134],{"type":55,"value":19135},"Here are some ideas about the next steps I could take on this project.",{"type":49,"tag":430,"props":19137,"children":19139},{"id":19138},"local-environment",[19140],{"type":55,"value":19141},"Local environment",{"type":49,"tag":58,"props":19143,"children":19144},{},[19145],{"type":55,"value":19146},"I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings.",{"type":49,"tag":430,"props":19148,"children":19150},{"id":19149},"infrastructure-as-code-setup",[19151],{"type":55,"value":19152},"Infrastructure as Code setup",{"type":49,"tag":58,"props":19154,"children":19155},{},[19156],{"type":55,"value":19157},"There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK.",{"type":49,"tag":430,"props":19159,"children":19161},{"id":19160},"scaling-out-docker-swarm-services-across-multiple-machines",[19162],{"type":55,"value":19163},"Scaling out docker swarm services across multiple machines",{"type":49,"tag":58,"props":19165,"children":19166},{},[19167],{"type":55,"value":19168},"I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads.",{"type":49,"tag":430,"props":19170,"children":19172},{"id":19171},"kubernetes-on-digitalocean",[19173],{"type":55,"value":19174},"Kubernetes on DigitalOcean",{"type":49,"tag":58,"props":19176,"children":19177},{},[19178],{"type":55,"value":19179},"DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP.",{"type":49,"tag":430,"props":19181,"children":19183},{"id":19182},"deploying-locally-without-using-gitlab-ci",[19184],{"type":55,"value":19185},"Deploying locally, without using GitLab CI",{"type":49,"tag":58,"props":19187,"children":19188},{},[19189],{"type":55,"value":19190},"CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages.",{"type":49,"tag":7749,"props":19192,"children":19193},{},[19194],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":19196},[19197,19198,19199,19200,19201,19202,19203,19204,19205,19206,19207,19208,19213,19214],{"id":14842,"depth":1079,"text":14845},{"id":14951,"depth":1079,"text":14954},{"id":15001,"depth":1079,"text":15004},{"id":15059,"depth":1079,"text":15062},{"id":15154,"depth":1079,"text":15157},{"id":15182,"depth":1079,"text":15185},{"id":15212,"depth":1079,"text":15215},{"id":15303,"depth":1079,"text":14889},{"id":15981,"depth":1079,"text":15984},{"id":16100,"depth":1079,"text":16103},{"id":16264,"depth":1079,"text":16259},{"id":16786,"depth":1079,"text":16793,"children":19209},[19210,19211,19212],{"id":1951,"depth":1088,"text":1951},{"id":14774,"depth":1088,"text":17572},{"id":14773,"depth":1088,"text":18372},{"id":19089,"depth":1079,"text":19092},{"id":14494,"depth":1079,"text":14497,"children":19215},[19216,19217,19218,19219,19220],{"id":19138,"depth":1088,"text":19141},{"id":19149,"depth":1088,"text":19152},{"id":19160,"depth":1088,"text":19163},{"id":19171,"depth":1088,"text":19174},{"id":19182,"depth":1088,"text":19185},"content:2020:08:09:digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx",{"_path":19225,"_dir":14764,"_draft":7,"_partial":7,"_locale":8,"title":19226,"description":19227,"layout":14767,"date":19228,"comments":44,"image":19229,"tags":19230,"body":19231,"_type":7809,"_id":19324,"_source":7811,"_file":19325,"_stem":19326,"_extension":7814},"/2019/01/09/django-docker-vue-nginx-drf-traefik-celery","Setup, Development and Deployment of a web app using Django, VueJS, VuePress, Docker, nginx, traefik and GitLab","This project is currently deployed on https://verbose-equals-true.tk. The source code is available at https://gitlab.com/briancaffey/verbose-equals-true.","2019-01-09T00:00:00.000Z","/static/technologies.png",[14,13929,24,14540],{"type":46,"children":19232,"toc":19322},[19233,19253,19258,19298,19303,19310],{"type":49,"tag":58,"props":19234,"children":19235},{},[19236,19238,19244,19246,19252],{"type":55,"value":19237},"This project is currently deployed on ",{"type":49,"tag":80,"props":19239,"children":19242},{"href":19240,"rel":19241},"https://verbose-equals-true.tk",[84],[19243],{"type":55,"value":19240},{"type":55,"value":19245},". The source code is available at ",{"type":49,"tag":80,"props":19247,"children":19250},{"href":19248,"rel":19249},"https://gitlab.com/briancaffey/verbose-equals-true",[84],[19251],{"type":55,"value":19248},{"type":55,"value":745},{"type":49,"tag":58,"props":19254,"children":19255},{},[19256],{"type":55,"value":19257},"The goal of this project is to explain how to setup a project starting with a fresh installation of 16.04. Setup includes local development environment, GitLab CI/CD, VSCode settings and configuration of the different containers that make up the application:",{"type":49,"tag":64,"props":19259,"children":19260},{},[19261,19266,19271,19275,19279,19284,19288,19293],{"type":49,"tag":68,"props":19262,"children":19263},{},[19264],{"type":55,"value":19265},"Django",{"type":49,"tag":68,"props":19267,"children":19268},{},[19269],{"type":55,"value":19270},"Node (for local development with VueJS)",{"type":49,"tag":68,"props":19272,"children":19273},{},[19274],{"type":55,"value":14774},{"type":49,"tag":68,"props":19276,"children":19277},{},[19278],{"type":55,"value":18372},{"type":49,"tag":68,"props":19280,"children":19281},{},[19282],{"type":55,"value":19283},"Postgres",{"type":49,"tag":68,"props":19285,"children":19286},{},[19287],{"type":55,"value":3264},{"type":49,"tag":68,"props":19289,"children":19290},{},[19291],{"type":55,"value":19292},"flower",{"type":49,"tag":68,"props":19294,"children":19295},{},[19296],{"type":55,"value":19297},"portainer",{"type":49,"tag":58,"props":19299,"children":19300},{},[19301],{"type":55,"value":19302},"Here's an overview of the architecture used in the application:",{"type":49,"tag":58,"props":19304,"children":19305},{},[19306],{"type":49,"tag":1601,"props":19307,"children":19309},{"alt":8926,"src":19308},"/static/architecture.png",[],{"type":49,"tag":58,"props":19311,"children":19312},{},[19313,19315,19321],{"type":55,"value":19314},"Extensive documentation for this project can be found at ",{"type":49,"tag":80,"props":19316,"children":19319},{"href":19317,"rel":19318},"https://verbose-equals-true.tk/docs",[84],[19320],{"type":55,"value":19317},{"type":55,"value":745},{"title":8,"searchDepth":1079,"depth":1079,"links":19323},[],"content:2019:01:09:django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery",{"_path":19328,"_dir":14764,"_draft":7,"_partial":7,"_locale":8,"title":19329,"description":8,"layout":14767,"date":19330,"comments":44,"image":19331,"tags":19332,"body":19334,"_type":7809,"_id":20816,"_source":7811,"_file":20817,"_stem":20818,"_extension":7814},"/2017/12/09/setting-up-flask-cli-with-docker","Setting up a Flask project with Flask CLI and Docker","2017-12-09T00:00:00.000Z","/static/flask-docker.png",[19333,24],"flask",{"type":46,"children":19335,"toc":20809},[19336,19342,19347,19389,19397,19402,19408,19416,19422,19430,19436,19444,19457,19463,19471,19476,19481,19503,19524,19531,19726,19731,19739,19760,19768,19781,19789,20014,20026,20050,20062,20070,20090,20095,20103,20108,20116,20143,20269,20274,20282,20294,20302,20315,20320,20327,20339,20347,20359,20367,20393,20398,20406,20416,20421,20440,20447,20455,20467,20474,20482,20487,20492,20500,20505,20513,20533,20541,20554,20562,20575,20580,20588,20593,20601,20606,20614,20634,20642,20677,20697,20705,20723,20739,20747,20752,20760,20781,20789,20800,20805],{"type":49,"tag":58,"props":19337,"children":19338},{},[19339],{"type":49,"tag":1601,"props":19340,"children":19341},{"alt":8926,"src":19331},[],{"type":49,"tag":58,"props":19343,"children":19344},{},[19345],{"type":55,"value":19346},"⚠️ This article is under contruction ⚠️",{"type":49,"tag":58,"props":19348,"children":19349},{},[19350,19352,19359,19361,19367,19368,19373,19375,19381,19383,19388],{"type":55,"value":19351},"I've recently been working on an awesome tutorial from ",{"type":49,"tag":80,"props":19353,"children":19356},{"href":19354,"rel":19355},"https://testdriven.io",[84],[19357],{"type":55,"value":19358},"testdriven.io",{"type":55,"value":19360}," that covers flask, react and docker. The beginning of the project covers how to setup a basic flask app using ",{"type":49,"tag":326,"props":19362,"children":19364},{"className":19363},[],[19365],{"type":55,"value":19366},"flask-scripts",{"type":55,"value":8561},{"type":49,"tag":326,"props":19369,"children":19371},{"className":19370},[],[19372],{"type":55,"value":19366},{"type":55,"value":19374}," is a deprecated tool and the tutorial recommends using ",{"type":49,"tag":326,"props":19376,"children":19378},{"className":19377},[],[19379],{"type":55,"value":19380},"Flask CLI",{"type":55,"value":19382},". I have fumbled with this the first time I tried to set it up and while I was able to get it working, I couldn't get it working inside of docker. In this article I'll detail the setup of my flask project with ",{"type":49,"tag":326,"props":19384,"children":19386},{"className":19385},[],[19387],{"type":55,"value":19380},{"type":55,"value":745},{"type":49,"tag":2910,"props":19390,"children":19391},{},[19392],{"type":49,"tag":58,"props":19393,"children":19394},{},[19395],{"type":55,"value":19396},"One of the nice new features in Flask 0.11 is the built-in integration of the click command line interface. This enables a wide range of new features for the Flask ecosystem and your own applications.",{"type":49,"tag":58,"props":19398,"children":19399},{},[19400],{"type":55,"value":19401},"OK. Let's set up a basic flask app:",{"type":49,"tag":430,"props":19403,"children":19405},{"id":19404},"directories",[19406],{"type":55,"value":19407},"Directories",{"type":49,"tag":1050,"props":19409,"children":19411},{"code":19410}," $ mkdir test-flask && cd test-flask\n $ mkdir users-service && cd users-service\n $ mkdir project\n\n",[19412],{"type":49,"tag":326,"props":19413,"children":19414},{"__ignoreMap":8},[19415],{"type":55,"value":19410},{"type":49,"tag":430,"props":19417,"children":19419},{"id":19418},"virtual-environment",[19420],{"type":55,"value":19421},"Virtual Environment",{"type":49,"tag":1050,"props":19423,"children":19425},{"code":19424}," $ virtualenv -p python3 env\nRunning virtualenv with interpreter /home/brian/anaconda3/bin/python3\nUsing base prefix '/home/brian/anaconda3'\nNew python executable in /home/brian/Documents/flask/test-flask/users-service/env/bin/python3\nAlso creating executable in /home/brian/Documents/flask/test-flask/users-service/env/bin/python\nInstalling setuptools, pip, wheel...done.\n",[19426],{"type":49,"tag":326,"props":19427,"children":19428},{"__ignoreMap":8},[19429],{"type":55,"value":19424},{"type":49,"tag":430,"props":19431,"children":19433},{"id":19432},"activate-virtual-environment",[19434],{"type":55,"value":19435},"Activate Virtual Environment",{"type":49,"tag":1050,"props":19437,"children":19439},{"code":19438}," $ source env/bin/activate\n(env) $\n",[19440],{"type":49,"tag":326,"props":19441,"children":19442},{"__ignoreMap":8},[19443],{"type":55,"value":19438},{"type":49,"tag":58,"props":19445,"children":19446},{},[19447,19449,19455],{"type":55,"value":19448},"We will come back to the ",{"type":49,"tag":326,"props":19450,"children":19452},{"className":19451},[],[19453],{"type":55,"value":19454},"activate",{"type":55,"value":19456}," script and add some environment variables to the bottom if it so we have them accessible when we activate the virtual environment.",{"type":49,"tag":430,"props":19458,"children":19460},{"id":19459},"install-flask-in-the-virtual-environment",[19461],{"type":55,"value":19462},"Install flask in the virtual environment",{"type":49,"tag":1050,"props":19464,"children":19466},{"code":19465}," $ pip install flask==0.12.2\nCollecting flask==0.12.2\n  Using cached Flask-0.12.2-py2.py3-none-any.whl\nCollecting itsdangerous>=0.21 (from flask==0.12.2)\nCollecting Werkzeug>=0.7 (from flask==0.12.2)\n  Using cached Werkzeug-0.13-py2.py3-none-any.whl\nCollecting click>=2.0 (from flask==0.12.2)\n  Using cached click-6.7-py2.py3-none-any.whl\nCollecting Jinja2>=2.4 (from flask==0.12.2)\n  Using cached Jinja2-2.10-py2.py3-none-any.whl\nCollecting MarkupSafe>=0.23 (from Jinja2>=2.4->flask==0.12.2)\nInstalling collected packages: itsdangerous, Werkzeug, click, MarkupSafe, Jinja2, flask\nSuccessfully installed Jinja2-2.10 MarkupSafe-1.0 Werkzeug-0.13 click-6.7 flask-0.12.2 itsdangerous-0.24\n(env) $\n",[19467],{"type":49,"tag":326,"props":19468,"children":19469},{"__ignoreMap":8},[19470],{"type":55,"value":19465},{"type":49,"tag":58,"props":19472,"children":19473},{},[19474],{"type":55,"value":19475},"At this point we are ready to create our flask app.",{"type":49,"tag":58,"props":19477,"children":19478},{},[19479],{"type":55,"value":19480},"Here's a note about the CLI:",{"type":49,"tag":2910,"props":19482,"children":19483},{},[19484],{"type":49,"tag":58,"props":19485,"children":19486},{},[19487,19489,19493,19495,19501],{"type":55,"value":19488},"For the ",{"type":49,"tag":72,"props":19490,"children":19491},{},[19492],{"type":55,"value":19333},{"type":55,"value":19494}," script to work, an application needs to be discovered. This is achieved by exporting the ",{"type":49,"tag":326,"props":19496,"children":19498},{"className":19497},[],[19499],{"type":55,"value":19500},"FLASK_APP",{"type":55,"value":19502}," environment variable. It can be either set to an import path or to a filename of a Python module that contains a Flask application.",{"type":49,"tag":58,"props":19504,"children":19505},{},[19506,19508,19514,19516,19522],{"type":55,"value":19507},"Let's add an ",{"type":49,"tag":326,"props":19509,"children":19511},{"className":19510},[],[19512],{"type":55,"value":19513},"app.py",{"type":55,"value":19515}," file inside the ",{"type":49,"tag":326,"props":19517,"children":19519},{"className":19518},[],[19520],{"type":55,"value":19521},"project",{"type":55,"value":19523}," folder:",{"type":49,"tag":58,"props":19525,"children":19526},{},[19527],{"type":49,"tag":126,"props":19528,"children":19529},{},[19530],{"type":55,"value":19513},{"type":49,"tag":1050,"props":19532,"children":19536},{"code":19533,"language":19534,"meta":8,"className":19535,"style":8},"from flask import Flask, jsonify\n\napp = Flask(__name__)\n\n@app.route('/users/ping', methods=['GET'])\ndef ping_pong():\n    return jsonify({\n        'message':'pong!',\n        'status':'success'\n        })\n","python","language-python shiki shiki-themes github-light github-dark monokai",[19537],{"type":49,"tag":326,"props":19538,"children":19539},{"__ignoreMap":8},[19540,19563,19570,19596,19603,19649,19667,19680,19701,19718],{"type":49,"tag":1060,"props":19541,"children":19542},{"class":1062,"line":1063},[19543,19548,19553,19558],{"type":49,"tag":1060,"props":19544,"children":19545},{"style":2194},[19546],{"type":55,"value":19547},"from",{"type":49,"tag":1060,"props":19549,"children":19550},{"style":1073},[19551],{"type":55,"value":19552}," flask ",{"type":49,"tag":1060,"props":19554,"children":19555},{"style":2194},[19556],{"type":55,"value":19557},"import",{"type":49,"tag":1060,"props":19559,"children":19560},{"style":1073},[19561],{"type":55,"value":19562}," Flask, jsonify\n",{"type":49,"tag":1060,"props":19564,"children":19565},{"class":1062,"line":1079},[19566],{"type":49,"tag":1060,"props":19567,"children":19568},{"emptyLinePlaceholder":44},[19569],{"type":55,"value":1094},{"type":49,"tag":1060,"props":19571,"children":19572},{"class":1062,"line":1088},[19573,19578,19582,19587,19592],{"type":49,"tag":1060,"props":19574,"children":19575},{"style":1073},[19576],{"type":55,"value":19577},"app ",{"type":49,"tag":1060,"props":19579,"children":19580},{"style":2194},[19581],{"type":55,"value":3068},{"type":49,"tag":1060,"props":19583,"children":19584},{"style":1073},[19585],{"type":55,"value":19586}," Flask(",{"type":49,"tag":1060,"props":19588,"children":19589},{"style":2188},[19590],{"type":55,"value":19591},"__name__",{"type":49,"tag":1060,"props":19593,"children":19594},{"style":1073},[19595],{"type":55,"value":5126},{"type":49,"tag":1060,"props":19597,"children":19598},{"class":1062,"line":1097},[19599],{"type":49,"tag":1060,"props":19600,"children":19601},{"emptyLinePlaceholder":44},[19602],{"type":55,"value":1094},{"type":49,"tag":1060,"props":19604,"children":19605},{"class":1062,"line":1111},[19606,19611,19615,19620,19624,19630,19634,19639,19644],{"type":49,"tag":1060,"props":19607,"children":19608},{"style":1067},[19609],{"type":55,"value":19610},"@app.route",{"type":49,"tag":1060,"props":19612,"children":19613},{"style":1073},[19614],{"type":55,"value":2284},{"type":49,"tag":1060,"props":19616,"children":19617},{"style":2215},[19618],{"type":55,"value":19619},"'/users/ping'",{"type":49,"tag":1060,"props":19621,"children":19622},{"style":1073},[19623],{"type":55,"value":873},{"type":49,"tag":1060,"props":19625,"children":19627},{"style":19626},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[19628],{"type":55,"value":19629},"methods",{"type":49,"tag":1060,"props":19631,"children":19632},{"style":2194},[19633],{"type":55,"value":3068},{"type":49,"tag":1060,"props":19635,"children":19636},{"style":1073},[19637],{"type":55,"value":19638},"[",{"type":49,"tag":1060,"props":19640,"children":19641},{"style":2215},[19642],{"type":55,"value":19643},"'GET'",{"type":49,"tag":1060,"props":19645,"children":19646},{"style":1073},[19647],{"type":55,"value":19648},"])\n",{"type":49,"tag":1060,"props":19650,"children":19651},{"class":1062,"line":1120},[19652,19657,19662],{"type":49,"tag":1060,"props":19653,"children":19654},{"style":2182},[19655],{"type":55,"value":19656},"def",{"type":49,"tag":1060,"props":19658,"children":19659},{"style":1067},[19660],{"type":55,"value":19661}," ping_pong",{"type":49,"tag":1060,"props":19663,"children":19664},{"style":1073},[19665],{"type":55,"value":19666},"():\n",{"type":49,"tag":1060,"props":19668,"children":19669},{"class":1062,"line":1128},[19670,19675],{"type":49,"tag":1060,"props":19671,"children":19672},{"style":2194},[19673],{"type":55,"value":19674},"    return",{"type":49,"tag":1060,"props":19676,"children":19677},{"style":1073},[19678],{"type":55,"value":19679}," jsonify({\n",{"type":49,"tag":1060,"props":19681,"children":19682},{"class":1062,"line":1141},[19683,19688,19692,19697],{"type":49,"tag":1060,"props":19684,"children":19685},{"style":2215},[19686],{"type":55,"value":19687},"        'message'",{"type":49,"tag":1060,"props":19689,"children":19690},{"style":1073},[19691],{"type":55,"value":6694},{"type":49,"tag":1060,"props":19693,"children":19694},{"style":2215},[19695],{"type":55,"value":19696},"'pong!'",{"type":49,"tag":1060,"props":19698,"children":19699},{"style":1073},[19700],{"type":55,"value":2497},{"type":49,"tag":1060,"props":19702,"children":19703},{"class":1062,"line":1150},[19704,19709,19713],{"type":49,"tag":1060,"props":19705,"children":19706},{"style":2215},[19707],{"type":55,"value":19708},"        'status'",{"type":49,"tag":1060,"props":19710,"children":19711},{"style":1073},[19712],{"type":55,"value":6694},{"type":49,"tag":1060,"props":19714,"children":19715},{"style":2215},[19716],{"type":55,"value":19717},"'success'\n",{"type":49,"tag":1060,"props":19719,"children":19720},{"class":1062,"line":1158},[19721],{"type":49,"tag":1060,"props":19722,"children":19723},{"style":1073},[19724],{"type":55,"value":19725},"        })\n",{"type":49,"tag":58,"props":19727,"children":19728},{},[19729],{"type":55,"value":19730},"And now let's add an environment variable to tell the Flask CLI where our app is located:",{"type":49,"tag":1050,"props":19732,"children":19734},{"code":19733}," $ export FLASK_APP=/home/brian/Documents/flask/test-flask/users-service/project/app.py\n",[19735],{"type":49,"tag":326,"props":19736,"children":19737},{"__ignoreMap":8},[19738],{"type":55,"value":19733},{"type":49,"tag":58,"props":19740,"children":19741},{},[19742,19744,19750,19752,19758],{"type":55,"value":19743},"OK, now let's try to run ",{"type":49,"tag":326,"props":19745,"children":19747},{"className":19746},[],[19748],{"type":55,"value":19749},"flask run",{"type":55,"value":19751}," and navigate to ",{"type":49,"tag":326,"props":19753,"children":19755},{"className":19754},[],[19756],{"type":55,"value":19757},"/users/ping",{"type":55,"value":19759}," and see what happens:",{"type":49,"tag":1050,"props":19761,"children":19763},{"code":19762}," $ flask run\n * Serving Flask app \"app\"\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n127.0.0.1 - - [09/Dec/2017 19:20:14] \"GET /users/ping HTTP/1.1\" 200 -\n",[19764],{"type":49,"tag":326,"props":19765,"children":19766},{"__ignoreMap":8},[19767],{"type":55,"value":19762},{"type":49,"tag":58,"props":19769,"children":19770},{},[19771,19773,19779],{"type":55,"value":19772},"Great! We see our ",{"type":49,"tag":326,"props":19774,"children":19776},{"className":19775},[],[19777],{"type":55,"value":19778},"pong!",{"type":55,"value":19780}," message returned in the browser. Next, let's configure our settings:",{"type":49,"tag":58,"props":19782,"children":19783},{},[19784],{"type":49,"tag":126,"props":19785,"children":19786},{},[19787],{"type":55,"value":19788},"project/config.py",{"type":49,"tag":1050,"props":19790,"children":19792},{"code":19791,"language":19534,"meta":8,"className":19535,"style":8},"class BaseConfig:\n    \"\"\"Base configuration\"\"\"\n    DEBUG = False\n    TESTING = False\nclass DevelopmentConfig(BaseConfig):\n    \"\"\"Development configuration\"\"\"\n    DEBUG = True\nclass TestingConfig(BaseConfig):\n    \"\"\"Testing configuration\"\"\"\n    DEBUG = True\n    TESTING = True\nclass ProductionConfig(BaseConfig):\n    \"\"\"Production configuration\"\"\"\n    DEBUG = False\n",[19793],{"type":49,"tag":326,"props":19794,"children":19795},{"__ignoreMap":8},[19796,19813,19821,19838,19854,19881,19889,19905,19929,19937,19952,19967,19991,19999],{"type":49,"tag":1060,"props":19797,"children":19798},{"class":1062,"line":1063},[19799,19804,19809],{"type":49,"tag":1060,"props":19800,"children":19801},{"style":2182},[19802],{"type":55,"value":19803},"class",{"type":49,"tag":1060,"props":19805,"children":19806},{"style":3992},[19807],{"type":55,"value":19808}," BaseConfig",{"type":49,"tag":1060,"props":19810,"children":19811},{"style":1073},[19812],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19814,"children":19815},{"class":1062,"line":1079},[19816],{"type":49,"tag":1060,"props":19817,"children":19818},{"style":2215},[19819],{"type":55,"value":19820},"    \"\"\"Base configuration\"\"\"\n",{"type":49,"tag":1060,"props":19822,"children":19823},{"class":1062,"line":1088},[19824,19829,19833],{"type":49,"tag":1060,"props":19825,"children":19826},{"style":2287},[19827],{"type":55,"value":19828},"    DEBUG",{"type":49,"tag":1060,"props":19830,"children":19831},{"style":2194},[19832],{"type":55,"value":2197},{"type":49,"tag":1060,"props":19834,"children":19835},{"style":2287},[19836],{"type":55,"value":19837}," False\n",{"type":49,"tag":1060,"props":19839,"children":19840},{"class":1062,"line":1097},[19841,19846,19850],{"type":49,"tag":1060,"props":19842,"children":19843},{"style":2287},[19844],{"type":55,"value":19845},"    TESTING",{"type":49,"tag":1060,"props":19847,"children":19848},{"style":2194},[19849],{"type":55,"value":2197},{"type":49,"tag":1060,"props":19851,"children":19852},{"style":2287},[19853],{"type":55,"value":19837},{"type":49,"tag":1060,"props":19855,"children":19856},{"class":1062,"line":1111},[19857,19861,19866,19870,19876],{"type":49,"tag":1060,"props":19858,"children":19859},{"style":2182},[19860],{"type":55,"value":19803},{"type":49,"tag":1060,"props":19862,"children":19863},{"style":3992},[19864],{"type":55,"value":19865}," DevelopmentConfig",{"type":49,"tag":1060,"props":19867,"children":19868},{"style":1073},[19869],{"type":55,"value":2284},{"type":49,"tag":1060,"props":19871,"children":19873},{"style":19872},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[19874],{"type":55,"value":19875},"BaseConfig",{"type":49,"tag":1060,"props":19877,"children":19878},{"style":1073},[19879],{"type":55,"value":19880},"):\n",{"type":49,"tag":1060,"props":19882,"children":19883},{"class":1062,"line":1120},[19884],{"type":49,"tag":1060,"props":19885,"children":19886},{"style":2215},[19887],{"type":55,"value":19888},"    \"\"\"Development configuration\"\"\"\n",{"type":49,"tag":1060,"props":19890,"children":19891},{"class":1062,"line":1128},[19892,19896,19900],{"type":49,"tag":1060,"props":19893,"children":19894},{"style":2287},[19895],{"type":55,"value":19828},{"type":49,"tag":1060,"props":19897,"children":19898},{"style":2194},[19899],{"type":55,"value":2197},{"type":49,"tag":1060,"props":19901,"children":19902},{"style":2287},[19903],{"type":55,"value":19904}," True\n",{"type":49,"tag":1060,"props":19906,"children":19907},{"class":1062,"line":1141},[19908,19912,19917,19921,19925],{"type":49,"tag":1060,"props":19909,"children":19910},{"style":2182},[19911],{"type":55,"value":19803},{"type":49,"tag":1060,"props":19913,"children":19914},{"style":3992},[19915],{"type":55,"value":19916}," TestingConfig",{"type":49,"tag":1060,"props":19918,"children":19919},{"style":1073},[19920],{"type":55,"value":2284},{"type":49,"tag":1060,"props":19922,"children":19923},{"style":19872},[19924],{"type":55,"value":19875},{"type":49,"tag":1060,"props":19926,"children":19927},{"style":1073},[19928],{"type":55,"value":19880},{"type":49,"tag":1060,"props":19930,"children":19931},{"class":1062,"line":1150},[19932],{"type":49,"tag":1060,"props":19933,"children":19934},{"style":2215},[19935],{"type":55,"value":19936},"    \"\"\"Testing configuration\"\"\"\n",{"type":49,"tag":1060,"props":19938,"children":19939},{"class":1062,"line":1158},[19940,19944,19948],{"type":49,"tag":1060,"props":19941,"children":19942},{"style":2287},[19943],{"type":55,"value":19828},{"type":49,"tag":1060,"props":19945,"children":19946},{"style":2194},[19947],{"type":55,"value":2197},{"type":49,"tag":1060,"props":19949,"children":19950},{"style":2287},[19951],{"type":55,"value":19904},{"type":49,"tag":1060,"props":19953,"children":19954},{"class":1062,"line":1171},[19955,19959,19963],{"type":49,"tag":1060,"props":19956,"children":19957},{"style":2287},[19958],{"type":55,"value":19845},{"type":49,"tag":1060,"props":19960,"children":19961},{"style":2194},[19962],{"type":55,"value":2197},{"type":49,"tag":1060,"props":19964,"children":19965},{"style":2287},[19966],{"type":55,"value":19904},{"type":49,"tag":1060,"props":19968,"children":19969},{"class":1062,"line":1180},[19970,19974,19979,19983,19987],{"type":49,"tag":1060,"props":19971,"children":19972},{"style":2182},[19973],{"type":55,"value":19803},{"type":49,"tag":1060,"props":19975,"children":19976},{"style":3992},[19977],{"type":55,"value":19978}," ProductionConfig",{"type":49,"tag":1060,"props":19980,"children":19981},{"style":1073},[19982],{"type":55,"value":2284},{"type":49,"tag":1060,"props":19984,"children":19985},{"style":19872},[19986],{"type":55,"value":19875},{"type":49,"tag":1060,"props":19988,"children":19989},{"style":1073},[19990],{"type":55,"value":19880},{"type":49,"tag":1060,"props":19992,"children":19993},{"class":1062,"line":1188},[19994],{"type":49,"tag":1060,"props":19995,"children":19996},{"style":2215},[19997],{"type":55,"value":19998},"    \"\"\"Production configuration\"\"\"\n",{"type":49,"tag":1060,"props":20000,"children":20001},{"class":1062,"line":1201},[20002,20006,20010],{"type":49,"tag":1060,"props":20003,"children":20004},{"style":2287},[20005],{"type":55,"value":19828},{"type":49,"tag":1060,"props":20007,"children":20008},{"style":2194},[20009],{"type":55,"value":2197},{"type":49,"tag":1060,"props":20011,"children":20012},{"style":2287},[20013],{"type":55,"value":19837},{"type":49,"tag":58,"props":20015,"children":20016},{},[20017,20019,20025],{"type":55,"value":20018},"And now we can add the following line right below where we define ",{"type":49,"tag":326,"props":20020,"children":20022},{"className":20021},[],[20023],{"type":55,"value":20024},"app = Flask(__name__)",{"type":55,"value":6694},{"type":49,"tag":1050,"props":20027,"children":20029},{"code":20028,"language":19534,"meta":8,"className":19535,"style":8},"app.config.from_object('project.config.DevelopmentConfig')\n",[20030],{"type":49,"tag":326,"props":20031,"children":20032},{"__ignoreMap":8},[20033],{"type":49,"tag":1060,"props":20034,"children":20035},{"class":1062,"line":1063},[20036,20041,20046],{"type":49,"tag":1060,"props":20037,"children":20038},{"style":1073},[20039],{"type":55,"value":20040},"app.config.from_object(",{"type":49,"tag":1060,"props":20042,"children":20043},{"style":2215},[20044],{"type":55,"value":20045},"'project.config.DevelopmentConfig'",{"type":49,"tag":1060,"props":20047,"children":20048},{"style":1073},[20049],{"type":55,"value":5126},{"type":49,"tag":58,"props":20051,"children":20052},{},[20053,20055,20060],{"type":55,"value":20054},"When we run ",{"type":49,"tag":326,"props":20056,"children":20058},{"className":20057},[],[20059],{"type":55,"value":19749},{"type":55,"value":20061},", we get a long error message including:",{"type":49,"tag":1050,"props":20063,"children":20065},{"code":20064},"Debugged import:\n\n- 'project' not found.\n\nOriginal exception:\n\nImportStringError: import_string() failed for 'project.config'. Possible reasons are:\n\n- missing __init__.py in a package;\n- package or module path not included in sys.path;\n- duplicated package or module name taking precedence in sys.path;\n- missing module, class, function or variable;\n",[20066],{"type":49,"tag":326,"props":20067,"children":20068},{"__ignoreMap":8},[20069],{"type":55,"value":20064},{"type":49,"tag":58,"props":20071,"children":20072},{},[20073,20075,20081,20083,20088],{"type":55,"value":20074},"Let's try to add ",{"type":49,"tag":326,"props":20076,"children":20078},{"className":20077},[],[20079],{"type":55,"value":20080},"__init__.py",{"type":55,"value":20082}," to our ",{"type":49,"tag":326,"props":20084,"children":20086},{"className":20085},[],[20087],{"type":55,"value":19521},{"type":55,"value":20089}," folder.",{"type":49,"tag":58,"props":20091,"children":20092},{},[20093],{"type":55,"value":20094},"Once we do this, we are able to run the app successfully, but we don't see any special message about Debug mode being on:",{"type":49,"tag":1050,"props":20096,"children":20098},{"code":20097}," $ flask run\n * Serving Flask app \"project.app\"\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n",[20099],{"type":49,"tag":326,"props":20100,"children":20101},{"__ignoreMap":8},[20102],{"type":55,"value":20097},{"type":49,"tag":58,"props":20104,"children":20105},{},[20106],{"type":55,"value":20107},"The documentation mentions that we can turn on Debug mode with:",{"type":49,"tag":1050,"props":20109,"children":20111},{"code":20110},"export FLASK_DEBUG=1\n",[20112],{"type":49,"tag":326,"props":20113,"children":20114},{"__ignoreMap":8},[20115],{"type":55,"value":20110},{"type":49,"tag":58,"props":20117,"children":20118},{},[20119,20121,20127,20129,20135,20137,20142],{"type":55,"value":20120},"We can check the debug mode by printing ",{"type":49,"tag":326,"props":20122,"children":20124},{"className":20123},[],[20125],{"type":55,"value":20126},"app.config",{"type":55,"value":20128}," in the ",{"type":49,"tag":326,"props":20130,"children":20132},{"className":20131},[],[20133],{"type":55,"value":20134},"ping_pong()",{"type":55,"value":20136}," function that is returned when we hit ",{"type":49,"tag":326,"props":20138,"children":20140},{"className":20139},[],[20141],{"type":55,"value":19757},{"type":55,"value":6694},{"type":49,"tag":1050,"props":20144,"children":20146},{"code":20145,"language":19534,"meta":8,"className":19535,"style":8},"@app.route('/users/ping', methods=['GET'])\ndef ping_pong():\n    print(app.config)\n    return jsonify({\n        'message':'pong!',\n        'status':'success'\n        })\n",[20147],{"type":49,"tag":326,"props":20148,"children":20149},{"__ignoreMap":8},[20150,20189,20204,20217,20228,20247,20262],{"type":49,"tag":1060,"props":20151,"children":20152},{"class":1062,"line":1063},[20153,20157,20161,20165,20169,20173,20177,20181,20185],{"type":49,"tag":1060,"props":20154,"children":20155},{"style":1067},[20156],{"type":55,"value":19610},{"type":49,"tag":1060,"props":20158,"children":20159},{"style":1073},[20160],{"type":55,"value":2284},{"type":49,"tag":1060,"props":20162,"children":20163},{"style":2215},[20164],{"type":55,"value":19619},{"type":49,"tag":1060,"props":20166,"children":20167},{"style":1073},[20168],{"type":55,"value":873},{"type":49,"tag":1060,"props":20170,"children":20171},{"style":19626},[20172],{"type":55,"value":19629},{"type":49,"tag":1060,"props":20174,"children":20175},{"style":2194},[20176],{"type":55,"value":3068},{"type":49,"tag":1060,"props":20178,"children":20179},{"style":1073},[20180],{"type":55,"value":19638},{"type":49,"tag":1060,"props":20182,"children":20183},{"style":2215},[20184],{"type":55,"value":19643},{"type":49,"tag":1060,"props":20186,"children":20187},{"style":1073},[20188],{"type":55,"value":19648},{"type":49,"tag":1060,"props":20190,"children":20191},{"class":1062,"line":1079},[20192,20196,20200],{"type":49,"tag":1060,"props":20193,"children":20194},{"style":2182},[20195],{"type":55,"value":19656},{"type":49,"tag":1060,"props":20197,"children":20198},{"style":1067},[20199],{"type":55,"value":19661},{"type":49,"tag":1060,"props":20201,"children":20202},{"style":1073},[20203],{"type":55,"value":19666},{"type":49,"tag":1060,"props":20205,"children":20206},{"class":1062,"line":1088},[20207,20212],{"type":49,"tag":1060,"props":20208,"children":20209},{"style":9965},[20210],{"type":55,"value":20211},"    print",{"type":49,"tag":1060,"props":20213,"children":20214},{"style":1073},[20215],{"type":55,"value":20216},"(app.config)\n",{"type":49,"tag":1060,"props":20218,"children":20219},{"class":1062,"line":1097},[20220,20224],{"type":49,"tag":1060,"props":20221,"children":20222},{"style":2194},[20223],{"type":55,"value":19674},{"type":49,"tag":1060,"props":20225,"children":20226},{"style":1073},[20227],{"type":55,"value":19679},{"type":49,"tag":1060,"props":20229,"children":20230},{"class":1062,"line":1111},[20231,20235,20239,20243],{"type":49,"tag":1060,"props":20232,"children":20233},{"style":2215},[20234],{"type":55,"value":19687},{"type":49,"tag":1060,"props":20236,"children":20237},{"style":1073},[20238],{"type":55,"value":6694},{"type":49,"tag":1060,"props":20240,"children":20241},{"style":2215},[20242],{"type":55,"value":19696},{"type":49,"tag":1060,"props":20244,"children":20245},{"style":1073},[20246],{"type":55,"value":2497},{"type":49,"tag":1060,"props":20248,"children":20249},{"class":1062,"line":1120},[20250,20254,20258],{"type":49,"tag":1060,"props":20251,"children":20252},{"style":2215},[20253],{"type":55,"value":19708},{"type":49,"tag":1060,"props":20255,"children":20256},{"style":1073},[20257],{"type":55,"value":6694},{"type":49,"tag":1060,"props":20259,"children":20260},{"style":2215},[20261],{"type":55,"value":19717},{"type":49,"tag":1060,"props":20263,"children":20264},{"class":1062,"line":1128},[20265],{"type":49,"tag":1060,"props":20266,"children":20267},{"style":1073},[20268],{"type":55,"value":19725},{"type":49,"tag":58,"props":20270,"children":20271},{},[20272],{"type":55,"value":20273},"Here's what we see in the terminal:",{"type":49,"tag":1050,"props":20275,"children":20277},{"code":20276},"\u003CConfig {'DEBUG': True, 'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'PRESERVE_CONTEXT_ON_EXCEPTION': None, 'SECRET_KEY': None, 'PERMANENT_SESSION_LIFETIME': datetime.timedelta(31), 'USE_X_SENDFILE': False, 'LOGGER_NAME': 'project.app', 'LOGGER_HANDLER_POLICY': 'always', 'SERVER_NAME': None, 'APPLICATION_ROOT': None, 'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': None, 'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True, 'SESSION_COOKIE_SECURE': False, 'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None, 'SEND_FILE_MAX_AGE_DEFAULT': datetime.timedelta(0, 43200), 'TRAP_BAD_REQUEST_ERRORS': False, 'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False, 'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': True, 'JSON_SORT_KEYS': True, 'JSONIFY_PRETTYPRINT_REGULAR': True, 'JSONIFY_MIMETYPE': 'application/json', 'TEMPLATES_AUTO_RELOAD': None}>\n127.0.0.1 - - [09/Dec/2017 19:42:46] \"GET /users/ping HTTP/1.1\" 200 -\n",[20278],{"type":49,"tag":326,"props":20279,"children":20280},{"__ignoreMap":8},[20281],{"type":55,"value":20276},{"type":49,"tag":58,"props":20283,"children":20284},{},[20285,20287,20293],{"type":55,"value":20286},"Just to be sure this is working correctly, let's try another config setting, ",{"type":49,"tag":326,"props":20288,"children":20290},{"className":20289},[],[20291],{"type":55,"value":20292},"ProductionConfig",{"type":55,"value":6694},{"type":49,"tag":1050,"props":20295,"children":20297},{"code":20296},"\u003CConfig {'DEBUG': False, 'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'PRESERVE_CONTEXT_ON_EXCEPTION': None, 'SECRET_KEY': None, 'PERMANENT_SESSION_LIFETIME': datetime.timedelta(31), 'USE_X_SENDFILE': False, 'LOGGER_NAME': 'project.app', 'LOGGER_HANDLER_POLICY': 'always', 'SERVER_NAME': None, 'APPLICATION_ROOT': None, 'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': None, 'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True, 'SESSION_COOKIE_SECURE': False, 'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None, 'SEND_FILE_MAX_AGE_DEFAULT': datetime.timedelta(0, 43200), 'TRAP_BAD_REQUEST_ERRORS': False, 'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False, 'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': True, 'JSON_SORT_KEYS': True, 'JSONIFY_PRETTYPRINT_REGULAR': True, 'JSONIFY_MIMETYPE': 'application/json', 'TEMPLATES_AUTO_RELOAD': None}>\n127.0.0.1 - - [09/Dec/2017 19:45:29] \"GET /users/ping HTTP/1.1\" 200 -\n",[20298],{"type":49,"tag":326,"props":20299,"children":20300},{"__ignoreMap":8},[20301],{"type":55,"value":20296},{"type":49,"tag":58,"props":20303,"children":20304},{},[20305,20307,20313],{"type":55,"value":20306},"OK, so far so good! I think that ",{"type":49,"tag":326,"props":20308,"children":20310},{"className":20309},[],[20311],{"type":55,"value":20312},"FLASK_DEBUG",{"type":55,"value":20314}," may give us some additional information in the terminal.",{"type":49,"tag":58,"props":20316,"children":20317},{},[20318],{"type":55,"value":20319},"Let's run:",{"type":49,"tag":1050,"props":20321,"children":20322},{"code":20110},[20323],{"type":49,"tag":326,"props":20324,"children":20325},{"__ignoreMap":8},[20326],{"type":55,"value":20110},{"type":49,"tag":58,"props":20328,"children":20329},{},[20330,20332,20337],{"type":55,"value":20331},"and run our app in ",{"type":49,"tag":326,"props":20333,"children":20335},{"className":20334},[],[20336],{"type":55,"value":20292},{"type":55,"value":20338}," mode:",{"type":49,"tag":1050,"props":20340,"children":20342},{"code":20341}," $ flask run\n * Serving Flask app \"project.app\"\n * Forcing debug mode on\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 775-946-486\n",[20343],{"type":49,"tag":326,"props":20344,"children":20345},{"__ignoreMap":8},[20346],{"type":55,"value":20341},{"type":49,"tag":58,"props":20348,"children":20349},{},[20350,20352,20357],{"type":55,"value":20351},"and when we hit ",{"type":49,"tag":326,"props":20353,"children":20355},{"className":20354},[],[20356],{"type":55,"value":19757},{"type":55,"value":20358}," we get:",{"type":49,"tag":1050,"props":20360,"children":20362},{"code":20361},"\u003CConfig {'DEBUG': True, 'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'PRESERVE_CONTEXT_ON_EXCEPTION': None, 'SECRET_KEY': None, 'PERMANENT_SESSION_LIFETIME': datetime.timedelta(31), 'USE_X_SENDFILE': False, 'LOGGER_NAME': 'project.app', 'LOGGER_HANDLER_POLICY': 'always', 'SERVER_NAME': None, 'APPLICATION_ROOT': None, 'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': None, 'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True, 'SESSION_COOKIE_SECURE': False, 'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None, 'SEND_FILE_MAX_AGE_DEFAULT': datetime.timedelta(0, 43200), 'TRAP_BAD_REQUEST_ERRORS': False, 'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False, 'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': True, 'JSON_SORT_KEYS': True, 'JSONIFY_PRETTYPRINT_REGULAR': True, 'JSONIFY_MIMETYPE': 'application/json', 'TEMPLATES_AUTO_RELOAD': None}>\n127.0.0.1 - - [09/Dec/2017 19:51:17] \"GET /users/ping HTTP/1.1\" 200 -\n",[20363],{"type":49,"tag":326,"props":20364,"children":20365},{"__ignoreMap":8},[20366],{"type":55,"value":20361},{"type":49,"tag":58,"props":20368,"children":20369},{},[20370,20372,20377,20378,20384,20386,20392],{"type":55,"value":20371},"Here we can see that ",{"type":49,"tag":326,"props":20373,"children":20375},{"className":20374},[],[20376],{"type":55,"value":15144},{"type":55,"value":15808},{"type":49,"tag":326,"props":20379,"children":20381},{"className":20380},[],[20382],{"type":55,"value":20383},"True",{"type":55,"value":20385},", which was forced when we set ",{"type":49,"tag":326,"props":20387,"children":20389},{"className":20388},[],[20390],{"type":55,"value":20391},"FLASK_DEBUG=1",{"type":55,"value":745},{"type":49,"tag":58,"props":20394,"children":20395},{},[20396],{"type":55,"value":20397},"For clarity, let's review the directory structure of our project:",{"type":49,"tag":1050,"props":20399,"children":20401},{"code":20400}," $ tree project/\nproject/\n├── app.py\n├── config.py\n└── __init__.py\n",[20402],{"type":49,"tag":326,"props":20403,"children":20404},{"__ignoreMap":8},[20405],{"type":55,"value":20400},{"type":49,"tag":58,"props":20407,"children":20408},{},[20409,20414],{"type":49,"tag":326,"props":20410,"children":20412},{"className":20411},[],[20413],{"type":55,"value":20080},{"type":55,"value":20415}," is just an empty file at this point, but in the testdriven.io tutorial it is the file that contains our app.",{"type":49,"tag":58,"props":20417,"children":20418},{},[20419],{"type":55,"value":20420},"OK, we have a very simple flask app that we can control with the flask cli. Let's get ready to dockerize this simple project.",{"type":49,"tag":58,"props":20422,"children":20423},{},[20424,20426,20432,20434,20439],{"type":55,"value":20425},"We need a ",{"type":49,"tag":326,"props":20427,"children":20429},{"className":20428},[],[20430],{"type":55,"value":20431},"requirements.txt",{"type":55,"value":20433}," file. So far we just have flask. We want to place this file on the same level as our ",{"type":49,"tag":326,"props":20435,"children":20437},{"className":20436},[],[20438],{"type":55,"value":19521},{"type":55,"value":19523},{"type":49,"tag":58,"props":20441,"children":20442},{},[20443],{"type":49,"tag":126,"props":20444,"children":20445},{},[20446],{"type":55,"value":20431},{"type":49,"tag":1050,"props":20448,"children":20450},{"code":20449},"Flask==0.12.1\n",[20451],{"type":49,"tag":326,"props":20452,"children":20453},{"__ignoreMap":8},[20454],{"type":55,"value":20449},{"type":49,"tag":58,"props":20456,"children":20457},{},[20458,20460,20465],{"type":55,"value":20459},"And we can add a ",{"type":49,"tag":326,"props":20461,"children":20463},{"className":20462},[],[20464],{"type":55,"value":15876},{"type":55,"value":20466}," file as well at the same level:",{"type":49,"tag":58,"props":20468,"children":20469},{},[20470],{"type":49,"tag":126,"props":20471,"children":20472},{},[20473],{"type":55,"value":15876},{"type":49,"tag":1050,"props":20475,"children":20477},{"code":20476},"__pycache__\nenv\n",[20478],{"type":49,"tag":326,"props":20479,"children":20480},{"__ignoreMap":8},[20481],{"type":55,"value":20476},{"type":49,"tag":50,"props":20483,"children":20484},{"id":24},[20485],{"type":55,"value":20486},"Docker",{"type":49,"tag":58,"props":20488,"children":20489},{},[20490],{"type":55,"value":20491},"Here are the versions of docker applications I have installed:",{"type":49,"tag":1050,"props":20493,"children":20495},{"code":20494}," $ docker -v && docker-compose -v && docker-machine -v\nDocker version 17.10.0-ce, build f4ffd2511c\ndocker-compose version 1.17.1, build unknown\ndocker-machine version 0.13.0, build HEAD\n",[20496],{"type":49,"tag":326,"props":20497,"children":20498},{"__ignoreMap":8},[20499],{"type":55,"value":20494},{"type":49,"tag":58,"props":20501,"children":20502},{},[20503],{"type":55,"value":20504},"Currently I don't have any docker machines, images or containers. Here is the status of the docker service:",{"type":49,"tag":1050,"props":20506,"children":20508},{"code":20507}," $ systemctl status docker\n● docker.service - Docker Application Container Engine\n   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)\n   Active: active (running) since Fri 2017-12-08 19:13:09 EST; 24h ago\n     Docs: https://docs.docker.com\n Main PID: 5486 (dockerd)\n    Tasks: 26 (limit: 4915)\n   CGroup: /system.slice/docker.service\n           ├─5486 /usr/bin/dockerd -g /home/brian/docker -H fd://\n           └─5492 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc\n\nDec 08 19:13:08 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:08.126834430-05:00\" level=warning msg=\"Your kernel does not support cgroup rt period\"\nDec 08 19:13:08 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:08.126850093-05:00\" level=warning msg=\"Your kernel does not support cgroup rt runtime\"\nDec 08 19:13:08 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:08.127216425-05:00\" level=info msg=\"Loading containers: start.\"\nDec 08 19:13:08 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:08.776371797-05:00\" level=info msg=\"Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address\"\nDec 08 19:13:09 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:09.013651222-05:00\" level=info msg=\"Loading containers: done.\"\nDec 08 19:13:09 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:09.041318847-05:00\" level=warning msg=\"Not using native diff for overlay2, this may cause degraded performance for building images: kernel has CONFIG_OVERLAY_FS_REDIRECT_DIR enabled\"\nDec 08 19:13:09 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:09.075633462-05:00\" level=info msg=\"Docker daemon\" commit=f4ffd2511c graphdriver(s)=overlay2 version=17.10.0-ce\nDec 08 19:13:09 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:09.076162900-05:00\" level=info msg=\"Daemon has completed initialization\"\nDec 08 19:13:09 archthinkpad dockerd[5486]: time=\"2017-12-08T19:13:09.082056339-05:00\" level=info msg=\"API listen on /var/run/docker.sock\"\nDec 08 19:13:09 archthinkpad systemd[1]: Started Docker Application Container Engine.\n",[20509],{"type":49,"tag":326,"props":20510,"children":20511},{"__ignoreMap":8},[20512],{"type":55,"value":20507},{"type":49,"tag":58,"props":20514,"children":20515},{},[20516,20518,20524,20526,20532],{"type":55,"value":20517},"OK, docker seems to be working fine. Now we need to create a Docker host and point the docker client at it. What does this mean? From what I understand, we will be running docker containers not on our local machine but in an instance of ",{"type":49,"tag":326,"props":20519,"children":20521},{"className":20520},[],[20522],{"type":55,"value":20523},"virtualbox",{"type":55,"value":20525}," on our local machine. To do this, we will use the ",{"type":49,"tag":326,"props":20527,"children":20529},{"className":20528},[],[20530],{"type":55,"value":20531},"docker-machine",{"type":55,"value":13378},{"type":49,"tag":1050,"props":20534,"children":20536},{"code":20535}," $ docker-machine create -d virtualbox testdriven-dev\nRunning pre-create checks...\nCreating machine...\n(testdriven-dev) Copying /home/brian/.docker/machine/cache/boot2docker.iso to /home/brian/.docker/machine/machines/testdriven-dev/boot2docker.iso...\n(testdriven-dev) Creating VirtualBox VM...\n(testdriven-dev) Creating SSH key...\n(testdriven-dev) Starting the VM...\n(testdriven-dev) Check network to re-create if needed...\n(testdriven-dev) Waiting for an IP...\nWaiting for machine to be running, this may take a few minutes...\nDetecting operating system of created instance...\nWaiting for SSH to be available...\nDetecting the provisioner...\nProvisioning with boot2docker...\nCopying certs to the local machine directory...\nCopying certs to the remote machine...\nSetting Docker configuration on the remote daemon...\n\nThis machine has been allocated an IP address, but Docker Machine could not reach it successfully.\n\nSSH for the machine should still work, but connecting to exposed ports, such as the Docker daemon port (usually \u003Cip>:2376), may not work properly.\n\nYou may need to add the route manually, or use another related workaround.\n\nThis could be due to a VPN, proxy, or host file configuration issue.\n\nYou also might want to clear any VirtualBox host only interfaces you are not using.\nChecking connection to Docker...\nDocker is up and running!\nTo see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env testdriven-dev\n",[20537],{"type":49,"tag":326,"props":20538,"children":20539},{"__ignoreMap":8},[20540],{"type":55,"value":20535},{"type":49,"tag":58,"props":20542,"children":20543},{},[20544,20546,20552],{"type":55,"value":20545},"We see that ",{"type":49,"tag":326,"props":20547,"children":20549},{"className":20548},[],[20550],{"type":55,"value":20551},"Docker is up and running!",{"type":55,"value":20553},", but notice this line:",{"type":49,"tag":1050,"props":20555,"children":20557},{"code":20556},"This machine has been allocated an IP address, but Docker Machine could not reach it successfully.\n",[20558],{"type":49,"tag":326,"props":20559,"children":20560},{"__ignoreMap":8},[20561],{"type":55,"value":20556},{"type":49,"tag":58,"props":20563,"children":20564},{},[20565,20567,20573],{"type":55,"value":20566},"This might be a problem. I think that the ",{"type":49,"tag":326,"props":20568,"children":20570},{"className":20569},[],[20571],{"type":55,"value":20572},"docker-machine env \u003Cmachine-name>",{"type":55,"value":20574}," command fixes this:",{"type":49,"tag":58,"props":20576,"children":20577},{},[20578],{"type":55,"value":20579},"When you run this command you get the following:",{"type":49,"tag":1050,"props":20581,"children":20583},{"code":20582}," $ docker-machine env testdriven-dev\nexport DOCKER_TLS_VERIFY=\"1\"\nexport DOCKER_HOST=\"tcp://192.168.99.100:2376\"\nexport DOCKER_CERT_PATH=\"/home/brian/.docker/machine/machines/testdriven-dev\"\nexport DOCKER_MACHINE_NAME=\"testdriven-dev\"\n# Run this command to configure your shell:\n# eval $(docker-machine env testdriven-dev)\n",[20584],{"type":49,"tag":326,"props":20585,"children":20586},{"__ignoreMap":8},[20587],{"type":55,"value":20582},{"type":49,"tag":58,"props":20589,"children":20590},{},[20591],{"type":55,"value":20592},"The result of this command tells us to run `eval $(docker-machine env testdriven-dev):",{"type":49,"tag":1050,"props":20594,"children":20596},{"code":20595},"eval \"$(docker-machine env testdriven-dev)\"\n",[20597],{"type":49,"tag":326,"props":20598,"children":20599},{"__ignoreMap":8},[20600],{"type":55,"value":20595},{"type":49,"tag":58,"props":20602,"children":20603},{},[20604],{"type":55,"value":20605},"To clarify, running the above commands puts adds some environment variables:",{"type":49,"tag":1050,"props":20607,"children":20609},{"code":20608}," $ env | grep DOCKER\nDOCKER_MACHINE_NAME=testdriven-dev\nDOCKER_CERT_PATH=/home/brian/.docker/machine/machines/testdriven-dev\nDOCKER_TLS_VERIFY=1\nDOCKER_HOST=tcp://192.168.99.100:2376\n",[20610],{"type":49,"tag":326,"props":20611,"children":20612},{"__ignoreMap":8},[20613],{"type":55,"value":20608},{"type":49,"tag":58,"props":20615,"children":20616},{},[20617,20619,20625,20627,20632],{"type":55,"value":20618},"Next we need to add a Dockerfile. We will call it ",{"type":49,"tag":326,"props":20620,"children":20622},{"className":20621},[],[20623],{"type":55,"value":20624},"Dockerfile-dev",{"type":55,"value":20626},". Let's look at ",{"type":49,"tag":326,"props":20628,"children":20630},{"className":20629},[],[20631],{"type":55,"value":20624},{"type":55,"value":20633}," from the tutorial and see how we may need to modify it for the way we set up our project:",{"type":49,"tag":1050,"props":20635,"children":20637},{"code":20636},"FROM python:3.6.3\n\n# set working directory\nRUN mkdir -p /usr/src/app\nWORKDIR /usr/src/app\n\n# add requirements\nADD ./requirements.txt /usr/src/app/requirements.txt\n\n# install requirements\nRUN pip install -r requirements.txt\n\n# add app\nADD . /usr/src/app\n\n# run server\nCMD python manage.py runserver -h 0.0.0.0\n",[20638],{"type":49,"tag":326,"props":20639,"children":20640},{"__ignoreMap":8},[20641],{"type":55,"value":20636},{"type":49,"tag":58,"props":20643,"children":20644},{},[20645,20647,20653,20655,20660,20662,20668,20670,20676],{"type":55,"value":20646},"We start by defining a base image with the ",{"type":49,"tag":326,"props":20648,"children":20650},{"className":20649},[],[20651],{"type":55,"value":20652},"FROM",{"type":55,"value":20654}," line which will give us the correct version of python. We then set folders and the current working directory in docker. Next we install flask add the ",{"type":49,"tag":326,"props":20656,"children":20658},{"className":20657},[],[20659],{"type":55,"value":20431},{"type":55,"value":20661}," file and install flask with the ",{"type":49,"tag":326,"props":20663,"children":20665},{"className":20664},[],[20666],{"type":55,"value":20667},"RUN",{"type":55,"value":20669}," line. We then add the directory (on our local machine) with ",{"type":49,"tag":326,"props":20671,"children":20673},{"className":20672},[],[20674],{"type":55,"value":20675},"ADD . /usr/src/app",{"type":55,"value":745},{"type":49,"tag":58,"props":20678,"children":20679},{},[20680,20682,20688,20690,20695],{"type":55,"value":20681},"This should all be fine up until the last line where we see a ",{"type":49,"tag":326,"props":20683,"children":20685},{"className":20684},[],[20686],{"type":55,"value":20687},"manage.py",{"type":55,"value":20689}," file. We never created this file since we wish to use the Flask CLI. We could try replicating the process did locally inside our Dockerfile. We need to add the the ",{"type":49,"tag":326,"props":20691,"children":20693},{"className":20692},[],[20694],{"type":55,"value":19500},{"type":55,"value":20696}," environment variable, and its value should be the script that has just been added to the docker image. Let's try:",{"type":49,"tag":1050,"props":20698,"children":20700},{"code":20699},"[...]\n\nENV FLASK_APP /usr/src/app/project/app.py\n\nCMD flask run\n",[20701],{"type":49,"tag":326,"props":20702,"children":20703},{"__ignoreMap":8},[20704],{"type":55,"value":20699},{"type":49,"tag":58,"props":20706,"children":20707},{},[20708,20710,20715,20716,20721],{"type":55,"value":20709},"Next we need a script for ",{"type":49,"tag":326,"props":20711,"children":20713},{"className":20712},[],[20714],{"type":55,"value":16074},{"type":55,"value":8561},{"type":49,"tag":326,"props":20717,"children":20719},{"className":20718},[],[20720],{"type":55,"value":16074},{"type":55,"value":20722}," is a tool for defining and running multi-container Docker applications. Again, let's look at what was included in the tutorial and then see if we need to make any adjustments:",{"type":49,"tag":58,"props":20724,"children":20725},{},[20726,20731,20733,20738],{"type":49,"tag":126,"props":20727,"children":20728},{},[20729],{"type":55,"value":20730},"docker-compose-dev.yml",{"type":55,"value":20732}," (this file goes in the root directory, one level up from where ",{"type":49,"tag":326,"props":20734,"children":20736},{"className":20735},[],[20737],{"type":55,"value":20624},{"type":55,"value":616},{"type":49,"tag":1050,"props":20740,"children":20742},{"code":20741},"version: '3.3'\n\nservices:\n\n  users-service:\n    container_name: users-service\n      build:\n        context: ./users-service\n        dockerfile: Dockerfile-dev\n      volumes:\n        - './users-service:/usr/src/app'\n      ports:\n        - 5001:5000\n",[20743],{"type":49,"tag":326,"props":20744,"children":20745},{"__ignoreMap":8},[20746],{"type":55,"value":20741},{"type":49,"tag":58,"props":20748,"children":20749},{},[20750],{"type":55,"value":20751},"OK, this looks good! Let's give it a try. We can run the following command:",{"type":49,"tag":1050,"props":20753,"children":20755},{"code":20754}," $ docker-compose -f docker-compose-dev.yml build\nBuilding users-service\n85b1f47fba49: Pull complete\nba6bd283713a: Pull complete\n817c8cd48a09: Pull complete\n47cc0ed96dc3: Pull complete\n4a36819a59dc: Pull complete\ndb9a0221399f: Pull complete\n7a511a7689b6: Pull complete\n1223757f6914: Pull complete\nDigest: sha256:db9d8546f3ff74e96702abe0a78a0e0454df6ea898de8f124feba81deea416d7\nStatus: Downloaded newer image for python:3.6.3\n ---> 79e1dc9af1c1\nStep 2/8 : RUN mkdir -p /usr/src/app\n ---> Running in 808f6c0497d3\n ---> 8873e8e0d526\nRemoving intermediate container 808f6c0497d3\nStep 3/8 : WORKDIR /usr/src/app\n ---> 76ef8912b4d5\nRemoving intermediate container a3ca419fe9c1\nStep 4/8 : ADD ./requirements.txt /usr/src/app/requirements.txt\n ---> eb513314527a\nStep 5/8 : RUN pip install -r requirements.txt\n ---> Running in 1a708ec3b565\nCollecting Flask==0.12.1 (from -r requirements.txt (line 1))\n  Downloading Flask-0.12.1-py2.py3-none-any.whl (82kB)\nCollecting Jinja2>=2.4 (from Flask==0.12.1->-r requirements.txt (line 1))\n  Downloading Jinja2-2.10-py2.py3-none-any.whl (126kB)\nCollecting click>=2.0 (from Flask==0.12.1->-r requirements.txt (line 1))\n  Downloading click-6.7-py2.py3-none-any.whl (71kB)\nCollecting Werkzeug>=0.7 (from Flask==0.12.1->-r requirements.txt (line 1))\n  Downloading Werkzeug-0.13-py2.py3-none-any.whl (311kB)\nCollecting itsdangerous>=0.21 (from Flask==0.12.1->-r requirements.txt (line 1))\n  Downloading itsdangerous-0.24.tar.gz (46kB)\nCollecting MarkupSafe>=0.23 (from Jinja2>=2.4->Flask==0.12.1->-r requirements.txt (line 1))\n  Downloading MarkupSafe-1.0.tar.gz\nBuilding wheels for collected packages: itsdangerous, MarkupSafe\n  Running setup.py bdist_wheel for itsdangerous: started\n  Running setup.py bdist_wheel for itsdangerous: finished with status 'done'\n  Stored in directory: /root/.cache/pip/wheels/fc/a8/66/24d655233c757e178d45dea2de22a04c6d92766abfb741129a\n  Running setup.py bdist_wheel for MarkupSafe: started\n  Running setup.py bdist_wheel for MarkupSafe: finished with status 'done'\n  Stored in directory: /root/.cache/pip/wheels/88/a7/30/e39a54a87bcbe25308fa3ca64e8ddc75d9b3e5afa21ee32d57\nSuccessfully built itsdangerous MarkupSafe\nInstalling collected packages: MarkupSafe, Jinja2, click, Werkzeug, itsdangerous, Flask\nSuccessfully installed Flask-0.12.1 Jinja2-2.10 MarkupSafe-1.0 Werkzeug-0.13 click-6.7 itsdangerous-0.24\n ---> d828a0518114\nRemoving intermediate container 1a708ec3b565\nStep 6/8 : ADD . /usr/src/app\n ---> 8e0efae73a47\nStep 7/8 : ENV FLASK_APP /usr/src/app/project/app.py\n ---> Running in 959581952d05\n ---> 20aaec61b615\nRemoving intermediate container 959581952d05\nStep 8/8 : CMD flask run\n ---> Running in 4f2fc701ba14\n ---> 1d5b59f3cef2\nRemoving intermediate container 4f2fc701ba14\n\nSuccessfully built 1d5b59f3cef2\nSuccessfully tagged testflask_users-service:latest\n\n",[20756],{"type":49,"tag":326,"props":20757,"children":20758},{"__ignoreMap":8},[20759],{"type":55,"value":20754},{"type":49,"tag":58,"props":20761,"children":20762},{},[20763,20765,20771,20773,20779],{"type":55,"value":20764},"That seemed to work. Next the tutorial says to run ",{"type":49,"tag":326,"props":20766,"children":20768},{"className":20767},[],[20769],{"type":55,"value":20770},"docker-compose -f docker-compose-dev.yml up -d",{"type":55,"value":20772},". I'll run this without the ",{"type":49,"tag":326,"props":20774,"children":20776},{"className":20775},[],[20777],{"type":55,"value":20778},"-d",{"type":55,"value":20780}," flag so we can see if there are any errors. Moment of truth!",{"type":49,"tag":1050,"props":20782,"children":20784},{"code":20783}," $ docker-compose -f docker-compose-dev.yml up\nCreating network \"testflask_default\" with the default driver\nCreating users-service ...\nCreating users-service ... done\nAttaching to users-service\nusers-service    | Usage: flask run [OPTIONS]\nusers-service    |\nusers-service    | Error: The file/path provided (/usr/src/app/project/app.py) does not appear to exist.  Please verify the path is correct.  If app is not on PYTHONPATH, ensure the extension is .py\nusers-service exited with code 2\n",[20785],{"type":49,"tag":326,"props":20786,"children":20787},{"__ignoreMap":8},[20788],{"type":55,"value":20783},{"type":49,"tag":58,"props":20790,"children":20791},{},[20792,20794,20799],{"type":55,"value":20793},"OK, we have an error that seems to have come from our ",{"type":49,"tag":326,"props":20795,"children":20797},{"className":20796},[],[20798],{"type":55,"value":19749},{"type":55,"value":16261},{"type":49,"tag":58,"props":20801,"children":20802},{},[20803],{"type":55,"value":20804},"To bo continued...",{"type":49,"tag":7749,"props":20806,"children":20807},{},[20808],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":20810},[20811,20812,20813,20814,20815],{"id":19404,"depth":1088,"text":19407},{"id":19418,"depth":1088,"text":19421},{"id":19432,"depth":1088,"text":19435},{"id":19459,"depth":1088,"text":19462},{"id":24,"depth":1079,"text":20486},"content:2017:12:09:setting-up-flask-cli-with-docker.md","2017/12/09/setting-up-flask-cli-with-docker.md","2017/12/09/setting-up-flask-cli-with-docker",{"_path":20820,"_dir":20821,"_draft":7,"_partial":7,"_locale":8,"title":20822,"description":8,"layout":14767,"date":20823,"comments":44,"image":20824,"tags":20825,"body":20827,"_type":7809,"_id":22142,"_source":7811,"_file":22143,"_stem":22144,"_extension":7814},"/2017/12/03/the-twelve-factor-app-and-my-experience-developing-web-apps","03","Reflecting on my web-app development process after reading The Twelve-Factor App","2017-12-03T00:00:00.000Z","/static/the-12-factor-app.png",[20826,24],"development",{"type":46,"children":20828,"toc":22128},[20829,20835,20855,20861,20869,20905,20917,21032,21038,21046,21059,21067,21072,21092,21126,21131,21139,21166,21172,21180,21185,21193,21206,21214,21220,21228,21233,21241,21255,21420,21447,21455,21488,21493,21672,21678,21686,21691,21699,21705,21713,21718,21726,21731,21753,21761,21774,21878,21884,21892,21897,21909,21917,21922,21930,21936,21944,21949,21957,21962,21970,21983,21989,21997,22005,22026,22034,22040,22048,22053,22058,22064,22072,22080,22092,22097,22103,22111,22119,22124],{"type":49,"tag":58,"props":20830,"children":20831},{},[20832],{"type":49,"tag":1601,"props":20833,"children":20834},{"alt":8926,"src":20824},[],{"type":49,"tag":58,"props":20836,"children":20837},{},[20838,20840,20845,20847,20853],{"type":55,"value":20839},"I recently had a conversation with a developer on the topic of bridging application development and production. From this conversation I was recommneded to have a look at ",{"type":49,"tag":126,"props":20841,"children":20842},{},[20843],{"type":55,"value":20844},"The Twelve-Factor App",{"type":55,"value":20846},", a high level guide for building modern, production-ready web applications. In this article I thought it would be interesting to go through each of the twelve sections and reflect on my current development process and how it follows and/or deviates from these factors. I also want to talk about the new technologies and techniques I have been learning from ",{"type":49,"tag":80,"props":20848,"children":20851},{"href":20849,"rel":20850},"https://testdriven.io/",[84],[20852],{"type":55,"value":19358},{"type":55,"value":20854}," and how I hope they can benefit me on the next stage of my learning.",{"type":49,"tag":50,"props":20856,"children":20858},{"id":20857},"i-codebase",[20859],{"type":55,"value":20860},"I. Codebase",{"type":49,"tag":58,"props":20862,"children":20863},{},[20864],{"type":49,"tag":72,"props":20865,"children":20866},{},[20867],{"type":55,"value":20868},"One codebase tracked in revision control, many deploys",{"type":49,"tag":58,"props":20870,"children":20871},{},[20872,20874,20881,20883,20889,20890,20896,20897,20903],{"type":55,"value":20873},"I have been using git to track my projects since starting ",{"type":49,"tag":80,"props":20875,"children":20878},{"href":20876,"rel":20877},"https://www.obeythetestinggoat.com/",[84],[20879],{"type":55,"value":20880},"Obey the Testing Goat!",{"type":55,"value":20882}," and have been gradually exploring many of the different features beyond a linear ",{"type":49,"tag":326,"props":20884,"children":20886},{"className":20885},[],[20887],{"type":55,"value":20888},"add",{"type":55,"value":10180},{"type":49,"tag":326,"props":20891,"children":20893},{"className":20892},[],[20894],{"type":55,"value":20895},"commit",{"type":55,"value":10180},{"type":49,"tag":326,"props":20898,"children":20900},{"className":20899},[],[20901],{"type":55,"value":20902},"push",{"type":55,"value":20904}," loop. Using Visual Studio Code makes resolving merge conflicts very easy. On this blog I have accepted at least one pull requests from a helpful readers to correct outdated information.",{"type":49,"tag":58,"props":20906,"children":20907},{},[20908,20910,20915],{"type":55,"value":20909},"The pattern I have been following for Django uses ",{"type":49,"tag":326,"props":20911,"children":20913},{"className":20912},[],[20914],{"type":55,"value":15876},{"type":55,"value":20916}," to keep local application settings out of the production codebase using the following logic:",{"type":49,"tag":1050,"props":20918,"children":20920},{"code":20919,"language":19534,"meta":8,"className":19535,"style":8},"from .base import *\n\nfrom .production import *\n\ntry:\n    from .local import *\nexcept:\n    pass\n",[20921],{"type":49,"tag":326,"props":20922,"children":20923},{"__ignoreMap":8},[20924,20945,20952,20972,20979,20991,21012,21024],{"type":49,"tag":1060,"props":20925,"children":20926},{"class":1062,"line":1063},[20927,20931,20936,20940],{"type":49,"tag":1060,"props":20928,"children":20929},{"style":2194},[20930],{"type":55,"value":19547},{"type":49,"tag":1060,"props":20932,"children":20933},{"style":1073},[20934],{"type":55,"value":20935}," .base ",{"type":49,"tag":1060,"props":20937,"children":20938},{"style":2194},[20939],{"type":55,"value":19557},{"type":49,"tag":1060,"props":20941,"children":20942},{"style":2194},[20943],{"type":55,"value":20944}," *\n",{"type":49,"tag":1060,"props":20946,"children":20947},{"class":1062,"line":1079},[20948],{"type":49,"tag":1060,"props":20949,"children":20950},{"emptyLinePlaceholder":44},[20951],{"type":55,"value":1094},{"type":49,"tag":1060,"props":20953,"children":20954},{"class":1062,"line":1088},[20955,20959,20964,20968],{"type":49,"tag":1060,"props":20956,"children":20957},{"style":2194},[20958],{"type":55,"value":19547},{"type":49,"tag":1060,"props":20960,"children":20961},{"style":1073},[20962],{"type":55,"value":20963}," .production ",{"type":49,"tag":1060,"props":20965,"children":20966},{"style":2194},[20967],{"type":55,"value":19557},{"type":49,"tag":1060,"props":20969,"children":20970},{"style":2194},[20971],{"type":55,"value":20944},{"type":49,"tag":1060,"props":20973,"children":20974},{"class":1062,"line":1097},[20975],{"type":49,"tag":1060,"props":20976,"children":20977},{"emptyLinePlaceholder":44},[20978],{"type":55,"value":1094},{"type":49,"tag":1060,"props":20980,"children":20981},{"class":1062,"line":1111},[20982,20987],{"type":49,"tag":1060,"props":20983,"children":20984},{"style":2194},[20985],{"type":55,"value":20986},"try",{"type":49,"tag":1060,"props":20988,"children":20989},{"style":1073},[20990],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20992,"children":20993},{"class":1062,"line":1120},[20994,20999,21004,21008],{"type":49,"tag":1060,"props":20995,"children":20996},{"style":2194},[20997],{"type":55,"value":20998},"    from",{"type":49,"tag":1060,"props":21000,"children":21001},{"style":1073},[21002],{"type":55,"value":21003}," .local ",{"type":49,"tag":1060,"props":21005,"children":21006},{"style":2194},[21007],{"type":55,"value":19557},{"type":49,"tag":1060,"props":21009,"children":21010},{"style":2194},[21011],{"type":55,"value":20944},{"type":49,"tag":1060,"props":21013,"children":21014},{"class":1062,"line":1128},[21015,21020],{"type":49,"tag":1060,"props":21016,"children":21017},{"style":2194},[21018],{"type":55,"value":21019},"except",{"type":49,"tag":1060,"props":21021,"children":21022},{"style":1073},[21023],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21025,"children":21026},{"class":1062,"line":1141},[21027],{"type":49,"tag":1060,"props":21028,"children":21029},{"style":2194},[21030],{"type":55,"value":21031},"    pass\n",{"type":49,"tag":50,"props":21033,"children":21035},{"id":21034},"ii-dependencies",[21036],{"type":55,"value":21037},"II. Dependencies",{"type":49,"tag":58,"props":21039,"children":21040},{},[21041],{"type":49,"tag":72,"props":21042,"children":21043},{},[21044],{"type":55,"value":21045},"Explicitly declare and isolate dependencies",{"type":49,"tag":58,"props":21047,"children":21048},{},[21049,21051,21057],{"type":55,"value":21050},"Using python makes this easy and I have had success running ",{"type":49,"tag":326,"props":21052,"children":21054},{"className":21053},[],[21055],{"type":55,"value":21056},"pip install -r requirements.txt",{"type":55,"value":21058},", or:",{"type":49,"tag":1050,"props":21060,"children":21062},{"code":21061},"ADD ./requirements.txt /usr/src/app/requirements.txt\nRUN pip install -r requirements.txt\n",[21063],{"type":49,"tag":326,"props":21064,"children":21065},{"__ignoreMap":8},[21066],{"type":55,"value":21061},{"type":49,"tag":58,"props":21068,"children":21069},{},[21070],{"type":55,"value":21071},"when running Docker.",{"type":49,"tag":58,"props":21073,"children":21074},{},[21075,21077,21083,21085,21090],{"type":55,"value":21076},"I have ran into minor dependency issues in experimenting with my personal website. I shouldn't have been doing it this way, but I made a virtual environment with ",{"type":49,"tag":326,"props":21078,"children":21080},{"className":21079},[],[21081],{"type":55,"value":21082},"conda create",{"type":55,"value":21084}," and included all of the packages in the environment in my production ",{"type":49,"tag":326,"props":21086,"children":21088},{"className":21087},[],[21089],{"type":55,"value":20431},{"type":55,"value":21091},". The Heroku build process gave me a tricky error that I was able to trace to a dependency that was failing to install on the Heroku instance.",{"type":49,"tag":58,"props":21093,"children":21094},{},[21095,21097,21103,21104,21110,21111,21117,21119,21124],{"type":55,"value":21096},"With Python 3 there are a few different options for creating virtual environments: ",{"type":49,"tag":326,"props":21098,"children":21100},{"className":21099},[],[21101],{"type":55,"value":21102},"virtualenv",{"type":55,"value":873},{"type":49,"tag":326,"props":21105,"children":21107},{"className":21106},[],[21108],{"type":55,"value":21109},"venv",{"type":55,"value":715},{"type":49,"tag":326,"props":21112,"children":21114},{"className":21113},[],[21115],{"type":55,"value":21116},"conda",{"type":55,"value":21118}," are three that I have used, and ",{"type":49,"tag":326,"props":21120,"children":21122},{"className":21121},[],[21123],{"type":55,"value":21102},{"type":55,"value":21125}," is a reliable tool for building webapps that I have seen used widely.",{"type":49,"tag":58,"props":21127,"children":21128},{},[21129],{"type":55,"value":21130},"Another interesting tip from this section relates to common system tools:",{"type":49,"tag":2910,"props":21132,"children":21133},{},[21134],{"type":49,"tag":58,"props":21135,"children":21136},{},[21137],{"type":55,"value":21138},"Twelve-factor apps also do not rely on the implicit existence of any system tools. Examples include shelling out to ImageMagick or curl.",{"type":49,"tag":58,"props":21140,"children":21141},{},[21142,21144,21150,21152,21157,21159,21165],{"type":55,"value":21143},"This is something that I have been grappling with in Docker. Tools like ",{"type":49,"tag":326,"props":21145,"children":21147},{"className":21146},[],[21148],{"type":55,"value":21149},"wget",{"type":55,"value":21151}," aren't part of \"base images\" and need to be intalled in the ",{"type":49,"tag":326,"props":21153,"children":21155},{"className":21154},[],[21156],{"type":55,"value":15746},{"type":55,"value":21158}," or in scripts called from ",{"type":49,"tag":326,"props":21160,"children":21162},{"className":21161},[],[21163],{"type":55,"value":21164},"docker-compose.yml",{"type":55,"value":745},{"type":49,"tag":50,"props":21167,"children":21169},{"id":21168},"iii-config",[21170],{"type":55,"value":21171},"III. Config",{"type":49,"tag":58,"props":21173,"children":21174},{},[21175],{"type":49,"tag":72,"props":21176,"children":21177},{},[21178],{"type":55,"value":21179},"Store config in the environment",{"type":49,"tag":58,"props":21181,"children":21182},{},[21183],{"type":55,"value":21184},"Heroku's command line utilities make setting production environments very easy. I think I can improve the way I organize environment variables locally since I often have many different projects it would be easy for projects to accidentally share the same variable name. One idea I have thought about would be to have an untracked bash script that sets environment variables that I run when starting the development environment, something like:",{"type":49,"tag":1050,"props":21186,"children":21188},{"code":21187},"export SECRET_KEY=\"my_secret_key\"\nexport DB_URL=\"postgres://my_db_url\"\n",[21189],{"type":49,"tag":326,"props":21190,"children":21191},{"__ignoreMap":8},[21192],{"type":55,"value":21187},{"type":49,"tag":58,"props":21194,"children":21195},{},[21196,21198,21204],{"type":55,"value":21197},"Docker wins points again on this factor because environemnt variables can simple be defined in a development and production ",{"type":49,"tag":326,"props":21199,"children":21201},{"className":21200},[],[21202],{"type":55,"value":21203},"docker-compose-*.yml",{"type":55,"value":21205}," files:",{"type":49,"tag":1050,"props":21207,"children":21209},{"code":21208},"    environment:\n      - APP_SETTINGS=project.config.DevelopmentConfig\n      - DATABASE_URL=postgres://postgres:postgres@users-db:5432/users_dev\n      - DATABASE_TEST_URL=postgres://postgres:postgres@users-db:5432/users_test\n",[21210],{"type":49,"tag":326,"props":21211,"children":21212},{"__ignoreMap":8},[21213],{"type":55,"value":21208},{"type":49,"tag":50,"props":21215,"children":21217},{"id":21216},"iv-backing-services",[21218],{"type":55,"value":21219},"IV. Backing services",{"type":49,"tag":58,"props":21221,"children":21222},{},[21223],{"type":49,"tag":72,"props":21224,"children":21225},{},[21226],{"type":55,"value":21227},"Treat backing services as attached resources",{"type":49,"tag":58,"props":21229,"children":21230},{},[21231],{"type":55,"value":21232},"The key takeaway for backing services (databases, message/queuing systems, etc.) is:",{"type":49,"tag":2910,"props":21234,"children":21235},{},[21236],{"type":49,"tag":58,"props":21237,"children":21238},{},[21239],{"type":55,"value":21240},"The code for a twelve-factor app makes no distinction between local and third party services.",{"type":49,"tag":58,"props":21242,"children":21243},{},[21244,21246,21253],{"type":55,"value":21245},"This factor made me think of an interesting syntax that I saw for the first time when learning the microservices architecture with docker in ",{"type":49,"tag":80,"props":21247,"children":21250},{"href":21248,"rel":21249},"https://github.com/jakewright/tutorials/tree/master/docker/02-docker-compose",[84],[21251],{"type":55,"value":21252},"this Docker example",{"type":55,"value":21254}," that uses two Flask apps to provide 1) front-end templates and 2) API backend. When the front end calls the API backend, it does so by referencing the service name in the URL. Here is an example with PHP, but it would work similarly in any other framework:",{"type":49,"tag":1050,"props":21256,"children":21260},{"code":21257,"language":21258,"meta":8,"className":21259,"style":8},"\u003C?php\n    $json = file_get_contents('http://product-service/');\n    $obj = json_decode($json);\n    $products = $obj->products;\n    foreach ($products as $product) {\n        echo \"\u003Cli>$product\u003C/li>\";\n    }\n?>\n","php","language-php shiki shiki-themes github-light github-dark monokai",[21261],{"type":49,"tag":326,"props":21262,"children":21263},{"__ignoreMap":8},[21264,21277,21307,21329,21356,21378,21405,21412],{"type":49,"tag":1060,"props":21265,"children":21266},{"class":1062,"line":1063},[21267,21272],{"type":49,"tag":1060,"props":21268,"children":21269},{"style":2194},[21270],{"type":55,"value":21271},"\u003C?",{"type":49,"tag":1060,"props":21273,"children":21274},{"style":2287},[21275],{"type":55,"value":21276},"php\n",{"type":49,"tag":1060,"props":21278,"children":21279},{"class":1062,"line":1079},[21280,21285,21289,21294,21298,21303],{"type":49,"tag":1060,"props":21281,"children":21282},{"style":1073},[21283],{"type":55,"value":21284},"    $json ",{"type":49,"tag":1060,"props":21286,"children":21287},{"style":2194},[21288],{"type":55,"value":3068},{"type":49,"tag":1060,"props":21290,"children":21291},{"style":9965},[21292],{"type":55,"value":21293}," file_get_contents",{"type":49,"tag":1060,"props":21295,"children":21296},{"style":1073},[21297],{"type":55,"value":2284},{"type":49,"tag":1060,"props":21299,"children":21300},{"style":2215},[21301],{"type":55,"value":21302},"'http://product-service/'",{"type":49,"tag":1060,"props":21304,"children":21305},{"style":1073},[21306],{"type":55,"value":2305},{"type":49,"tag":1060,"props":21308,"children":21309},{"class":1062,"line":1088},[21310,21315,21319,21324],{"type":49,"tag":1060,"props":21311,"children":21312},{"style":1073},[21313],{"type":55,"value":21314},"    $obj ",{"type":49,"tag":1060,"props":21316,"children":21317},{"style":2194},[21318],{"type":55,"value":3068},{"type":49,"tag":1060,"props":21320,"children":21321},{"style":9965},[21322],{"type":55,"value":21323}," json_decode",{"type":49,"tag":1060,"props":21325,"children":21326},{"style":1073},[21327],{"type":55,"value":21328},"($json);\n",{"type":49,"tag":1060,"props":21330,"children":21331},{"class":1062,"line":1097},[21332,21337,21341,21346,21351],{"type":49,"tag":1060,"props":21333,"children":21334},{"style":1073},[21335],{"type":55,"value":21336},"    $products ",{"type":49,"tag":1060,"props":21338,"children":21339},{"style":2194},[21340],{"type":55,"value":3068},{"type":49,"tag":1060,"props":21342,"children":21343},{"style":1073},[21344],{"type":55,"value":21345}," $obj",{"type":49,"tag":1060,"props":21347,"children":21348},{"style":2194},[21349],{"type":55,"value":21350},"->",{"type":49,"tag":1060,"props":21352,"children":21353},{"style":1073},[21354],{"type":55,"value":21355},"products;\n",{"type":49,"tag":1060,"props":21357,"children":21358},{"class":1062,"line":1111},[21359,21364,21369,21373],{"type":49,"tag":1060,"props":21360,"children":21361},{"style":2194},[21362],{"type":55,"value":21363},"    foreach",{"type":49,"tag":1060,"props":21365,"children":21366},{"style":1073},[21367],{"type":55,"value":21368}," ($products ",{"type":49,"tag":1060,"props":21370,"children":21371},{"style":2194},[21372],{"type":55,"value":5178},{"type":49,"tag":1060,"props":21374,"children":21375},{"style":1073},[21376],{"type":55,"value":21377}," $product) {\n",{"type":49,"tag":1060,"props":21379,"children":21380},{"class":1062,"line":1120},[21381,21386,21391,21396,21401],{"type":49,"tag":1060,"props":21382,"children":21383},{"style":9965},[21384],{"type":55,"value":21385},"        echo",{"type":49,"tag":1060,"props":21387,"children":21388},{"style":2215},[21389],{"type":55,"value":21390}," \"\u003Cli>",{"type":49,"tag":1060,"props":21392,"children":21393},{"style":1073},[21394],{"type":55,"value":21395},"$product",{"type":49,"tag":1060,"props":21397,"children":21398},{"style":2215},[21399],{"type":55,"value":21400},"\u003C/li>\"",{"type":49,"tag":1060,"props":21402,"children":21403},{"style":1073},[21404],{"type":55,"value":3791},{"type":49,"tag":1060,"props":21406,"children":21407},{"class":1062,"line":1128},[21408],{"type":49,"tag":1060,"props":21409,"children":21410},{"style":1073},[21411],{"type":55,"value":3100},{"type":49,"tag":1060,"props":21413,"children":21414},{"class":1062,"line":1141},[21415],{"type":49,"tag":1060,"props":21416,"children":21417},{"style":2194},[21418],{"type":55,"value":21419},"?>\n",{"type":49,"tag":58,"props":21421,"children":21422},{},[21423,21425,21431,21433,21439,21441,21446],{"type":55,"value":21424},"This front-end code hits the backend API endpoint ",{"type":49,"tag":326,"props":21426,"children":21428},{"className":21427},[],[21429],{"type":55,"value":21430},"http://product-service/",{"type":55,"value":21432},", where ",{"type":49,"tag":326,"props":21434,"children":21436},{"className":21435},[],[21437],{"type":55,"value":21438},"product-service",{"type":55,"value":21440}," is the name of a service included in ",{"type":49,"tag":326,"props":21442,"children":21444},{"className":21443},[],[21445],{"type":55,"value":21164},{"type":55,"value":6694},{"type":49,"tag":1050,"props":21448,"children":21450},{"code":21449},"version: '3'\n\nservices:\n  product-service:\n    build: ./product\n    volumes:\n      - ./product:/usr/src/app\n    ports:\n      - 5001:80\n\n  website:\n    image: php:apache\n    volumes:\n      - ./website:/var/www/html\n    ports:\n      - 5000:80\n    depends_on:\n      - product-service\n",[21451],{"type":49,"tag":326,"props":21452,"children":21453},{"__ignoreMap":8},[21454],{"type":55,"value":21449},{"type":49,"tag":58,"props":21456,"children":21457},{},[21458,21460,21466,21467,21472,21474,21479,21481,21486],{"type":55,"value":21459},"This is docker-compose file creates a network that includes both ",{"type":49,"tag":326,"props":21461,"children":21463},{"className":21462},[],[21464],{"type":55,"value":21465},"website",{"type":55,"value":715},{"type":49,"tag":326,"props":21468,"children":21470},{"className":21469},[],[21471],{"type":55,"value":21438},{"type":55,"value":21473}," that can be accessed by simply creating a URL with the name of the service in the domain. Coming back to the fourth factor, ",{"type":49,"tag":72,"props":21475,"children":21476},{},[21477],{"type":55,"value":21478},"The code for a twelve-factor app makes no distinction between local and third party services",{"type":55,"value":21480},", multiple docker containers can be thought of as ",{"type":49,"tag":126,"props":21482,"children":21483},{},[21484],{"type":55,"value":21485},"separate services",{"type":55,"value":21487}," even though they may be running on the same virtual environment in either development or production, and the unique domain cooresponding to the service name seems to reinforce this concept.",{"type":49,"tag":58,"props":21489,"children":21490},{},[21491],{"type":55,"value":21492},"This URL could also be referenced with environment variables:",{"type":49,"tag":1050,"props":21494,"children":21498},{"code":21495,"language":21496,"meta":8,"className":21497,"style":8},"getUsers() {\n  axios.get(`${process.env.REACT_APP_USERS_SERVICE_URL}/users`)\n  .then((res) => { console.log(res); })\n  .catch((err) => { console.log(err); })\n}\n","javascript","language-javascript shiki shiki-themes github-light github-dark monokai",[21499],{"type":49,"tag":326,"props":21500,"children":21501},{"__ignoreMap":8},[21502,21515,21576,21623,21665],{"type":49,"tag":1060,"props":21503,"children":21504},{"class":1062,"line":1063},[21505,21510],{"type":49,"tag":1060,"props":21506,"children":21507},{"style":1067},[21508],{"type":55,"value":21509},"getUsers",{"type":49,"tag":1060,"props":21511,"children":21512},{"style":1073},[21513],{"type":55,"value":21514},"() {\n",{"type":49,"tag":1060,"props":21516,"children":21517},{"class":1062,"line":1079},[21518,21523,21528,21532,21536,21540,21545,21549,21554,21558,21563,21567,21572],{"type":49,"tag":1060,"props":21519,"children":21520},{"style":1073},[21521],{"type":55,"value":21522},"  axios.",{"type":49,"tag":1060,"props":21524,"children":21525},{"style":1067},[21526],{"type":55,"value":21527},"get",{"type":49,"tag":1060,"props":21529,"children":21530},{"style":1073},[21531],{"type":55,"value":2284},{"type":49,"tag":1060,"props":21533,"children":21534},{"style":2215},[21535],{"type":55,"value":3786},{"type":49,"tag":1060,"props":21537,"children":21538},{"style":3488},[21539],{"type":55,"value":3491},{"type":49,"tag":1060,"props":21541,"children":21542},{"style":1073},[21543],{"type":55,"value":21544},"process",{"type":49,"tag":1060,"props":21546,"children":21547},{"style":3499},[21548],{"type":55,"value":745},{"type":49,"tag":1060,"props":21550,"children":21551},{"style":1073},[21552],{"type":55,"value":21553},"env",{"type":49,"tag":1060,"props":21555,"children":21556},{"style":3499},[21557],{"type":55,"value":745},{"type":49,"tag":1060,"props":21559,"children":21560},{"style":2188},[21561],{"type":55,"value":21562},"REACT_APP_USERS_SERVICE_URL",{"type":49,"tag":1060,"props":21564,"children":21565},{"style":3488},[21566],{"type":55,"value":3511},{"type":49,"tag":1060,"props":21568,"children":21569},{"style":2215},[21570],{"type":55,"value":21571},"/users`",{"type":49,"tag":1060,"props":21573,"children":21574},{"style":1073},[21575],{"type":55,"value":5126},{"type":49,"tag":1060,"props":21577,"children":21578},{"class":1062,"line":1088},[21579,21584,21589,21594,21599,21603,21608,21613,21618],{"type":49,"tag":1060,"props":21580,"children":21581},{"style":1073},[21582],{"type":55,"value":21583},"  .",{"type":49,"tag":1060,"props":21585,"children":21586},{"style":1067},[21587],{"type":55,"value":21588},"then",{"type":49,"tag":1060,"props":21590,"children":21591},{"style":1073},[21592],{"type":55,"value":21593},"((",{"type":49,"tag":1060,"props":21595,"children":21596},{"style":19626},[21597],{"type":55,"value":21598},"res",{"type":49,"tag":1060,"props":21600,"children":21601},{"style":1073},[21602],{"type":55,"value":5173},{"type":49,"tag":1060,"props":21604,"children":21605},{"style":2182},[21606],{"type":55,"value":21607},"=>",{"type":49,"tag":1060,"props":21609,"children":21610},{"style":1073},[21611],{"type":55,"value":21612}," { console.",{"type":49,"tag":1060,"props":21614,"children":21615},{"style":1067},[21616],{"type":55,"value":21617},"log",{"type":49,"tag":1060,"props":21619,"children":21620},{"style":1073},[21621],{"type":55,"value":21622},"(res); })\n",{"type":49,"tag":1060,"props":21624,"children":21625},{"class":1062,"line":1097},[21626,21630,21635,21639,21644,21648,21652,21656,21660],{"type":49,"tag":1060,"props":21627,"children":21628},{"style":1073},[21629],{"type":55,"value":21583},{"type":49,"tag":1060,"props":21631,"children":21632},{"style":1067},[21633],{"type":55,"value":21634},"catch",{"type":49,"tag":1060,"props":21636,"children":21637},{"style":1073},[21638],{"type":55,"value":21593},{"type":49,"tag":1060,"props":21640,"children":21641},{"style":19626},[21642],{"type":55,"value":21643},"err",{"type":49,"tag":1060,"props":21645,"children":21646},{"style":1073},[21647],{"type":55,"value":5173},{"type":49,"tag":1060,"props":21649,"children":21650},{"style":2182},[21651],{"type":55,"value":21607},{"type":49,"tag":1060,"props":21653,"children":21654},{"style":1073},[21655],{"type":55,"value":21612},{"type":49,"tag":1060,"props":21657,"children":21658},{"style":1067},[21659],{"type":55,"value":21617},{"type":49,"tag":1060,"props":21661,"children":21662},{"style":1073},[21663],{"type":55,"value":21664},"(err); })\n",{"type":49,"tag":1060,"props":21666,"children":21667},{"class":1062,"line":1111},[21668],{"type":49,"tag":1060,"props":21669,"children":21670},{"style":1073},[21671],{"type":55,"value":3675},{"type":49,"tag":50,"props":21673,"children":21675},{"id":21674},"v-build-release-run",[21676],{"type":55,"value":21677},"V. Build, release, run",{"type":49,"tag":58,"props":21679,"children":21680},{},[21681],{"type":49,"tag":72,"props":21682,"children":21683},{},[21684],{"type":55,"value":21685},"Strictly separate build and run stages",{"type":49,"tag":58,"props":21687,"children":21688},{},[21689],{"type":55,"value":21690},"This is an important stage in getting from development to production. It is the handoff from a local repo to a live, running web application. Here's the process live in action:",{"type":49,"tag":1050,"props":21692,"children":21694},{"code":21693}," $ git push heroku master\nCounting objects: 3, done.\nDelta compression using up to 4 threads.\nCompressing objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 303 bytes | 303.00 KiB/s, done.\nTotal 3 (delta 2), reused 0 (delta 0)\nremote: Compressing source files... done.\nremote: Building source:\nremote:\nremote: -----> Python app detected\nremote: -----> Installing requirements with pip\nremote:\nremote: -----> Discovering process types\nremote:        Procfile declares types -> web\nremote:\nremote: -----> Compressing...\nremote:        Done: 193.7M\nremote: -----> Launching...\nremote:        Released v410\nremote:        https://briancaffey.herokuapp.com/ deployed to Heroku\nremote:\nremote: Verifying deploy... done.\nTo https://git.heroku.com/briancaffey.git\n   cd6ce76..d8981a3  master -> master\n(briancaffey) brian@archthinkpad ~/Documents/github/briancaffey/src\n",[21695],{"type":49,"tag":326,"props":21696,"children":21697},{"__ignoreMap":8},[21698],{"type":55,"value":21693},{"type":49,"tag":50,"props":21700,"children":21702},{"id":21701},"vi-processes",[21703],{"type":55,"value":21704},"VI. Processes",{"type":49,"tag":58,"props":21706,"children":21707},{},[21708],{"type":49,"tag":72,"props":21709,"children":21710},{},[21711],{"type":55,"value":21712},"Execute the app as one or more stateless processes",{"type":49,"tag":58,"props":21714,"children":21715},{},[21716],{"type":55,"value":21717},"This is handled in Heroku by the Procfile. For simple Django apps on Heroku this is usually always the same one line:",{"type":49,"tag":1050,"props":21719,"children":21721},{"code":21720},"web: gunicorn projectname.wsgi --log-file -\n",[21722],{"type":49,"tag":326,"props":21723,"children":21724},{"__ignoreMap":8},[21725],{"type":55,"value":21720},{"type":49,"tag":58,"props":21727,"children":21728},{},[21729],{"type":55,"value":21730},"Here's what the Django project says about using gunicorn:",{"type":49,"tag":2910,"props":21732,"children":21733},{},[21734,21739,21744],{"type":49,"tag":58,"props":21735,"children":21736},{},[21737],{"type":55,"value":21738},"When Gunicorn is installed, a gunicorn command is available which starts the Gunicorn server process. At its simplest, gunicorn just needs to be called with the location of a module containing a WSGI application object named application.",{"type":49,"tag":58,"props":21740,"children":21741},{},[21742],{"type":55,"value":21743},"So for a typical Django project, invoking gunicorn would look like:",{"type":49,"tag":58,"props":21745,"children":21746},{},[21747],{"type":49,"tag":326,"props":21748,"children":21750},{"className":21749},[],[21751],{"type":55,"value":21752},"gunicorn myproject.wsgi",{"type":49,"tag":2910,"props":21754,"children":21755},{},[21756],{"type":49,"tag":58,"props":21757,"children":21758},{},[21759],{"type":55,"value":21760},"This will start one process running one thread listening on 127.0.0.1:8000. It requires that your project be on the Python path; the simplest way to ensure that is to run this command from the same directory as your manage.py file.",{"type":49,"tag":58,"props":21762,"children":21763},{},[21764,21766,21772],{"type":55,"value":21765},"In a Django project, the ",{"type":49,"tag":326,"props":21767,"children":21769},{"className":21768},[],[21770],{"type":55,"value":21771},"wsgi.py",{"type":55,"value":21773}," file in the main folder of the project root directory has the following contents:",{"type":49,"tag":1050,"props":21775,"children":21777},{"code":21776,"language":19534,"meta":8,"className":19535,"style":8},"import os\n\nfrom django.core.wsgi import get_wsgi_application\n\nos.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"brianblog.settings\")\n\napplication = get_wsgi_application()\n",[21778],{"type":49,"tag":326,"props":21779,"children":21780},{"__ignoreMap":8},[21781,21793,21800,21821,21828,21854,21861],{"type":49,"tag":1060,"props":21782,"children":21783},{"class":1062,"line":1063},[21784,21788],{"type":49,"tag":1060,"props":21785,"children":21786},{"style":2194},[21787],{"type":55,"value":19557},{"type":49,"tag":1060,"props":21789,"children":21790},{"style":1073},[21791],{"type":55,"value":21792}," os\n",{"type":49,"tag":1060,"props":21794,"children":21795},{"class":1062,"line":1079},[21796],{"type":49,"tag":1060,"props":21797,"children":21798},{"emptyLinePlaceholder":44},[21799],{"type":55,"value":1094},{"type":49,"tag":1060,"props":21801,"children":21802},{"class":1062,"line":1088},[21803,21807,21812,21816],{"type":49,"tag":1060,"props":21804,"children":21805},{"style":2194},[21806],{"type":55,"value":19547},{"type":49,"tag":1060,"props":21808,"children":21809},{"style":1073},[21810],{"type":55,"value":21811}," django.core.wsgi ",{"type":49,"tag":1060,"props":21813,"children":21814},{"style":2194},[21815],{"type":55,"value":19557},{"type":49,"tag":1060,"props":21817,"children":21818},{"style":1073},[21819],{"type":55,"value":21820}," get_wsgi_application\n",{"type":49,"tag":1060,"props":21822,"children":21823},{"class":1062,"line":1097},[21824],{"type":49,"tag":1060,"props":21825,"children":21826},{"emptyLinePlaceholder":44},[21827],{"type":55,"value":1094},{"type":49,"tag":1060,"props":21829,"children":21830},{"class":1062,"line":1111},[21831,21836,21841,21845,21850],{"type":49,"tag":1060,"props":21832,"children":21833},{"style":1073},[21834],{"type":55,"value":21835},"os.environ.setdefault(",{"type":49,"tag":1060,"props":21837,"children":21838},{"style":2215},[21839],{"type":55,"value":21840},"\"DJANGO_SETTINGS_MODULE\"",{"type":49,"tag":1060,"props":21842,"children":21843},{"style":1073},[21844],{"type":55,"value":873},{"type":49,"tag":1060,"props":21846,"children":21847},{"style":2215},[21848],{"type":55,"value":21849},"\"brianblog.settings\"",{"type":49,"tag":1060,"props":21851,"children":21852},{"style":1073},[21853],{"type":55,"value":5126},{"type":49,"tag":1060,"props":21855,"children":21856},{"class":1062,"line":1120},[21857],{"type":49,"tag":1060,"props":21858,"children":21859},{"emptyLinePlaceholder":44},[21860],{"type":55,"value":1094},{"type":49,"tag":1060,"props":21862,"children":21863},{"class":1062,"line":1128},[21864,21869,21873],{"type":49,"tag":1060,"props":21865,"children":21866},{"style":1073},[21867],{"type":55,"value":21868},"application ",{"type":49,"tag":1060,"props":21870,"children":21871},{"style":2194},[21872],{"type":55,"value":3068},{"type":49,"tag":1060,"props":21874,"children":21875},{"style":1073},[21876],{"type":55,"value":21877}," get_wsgi_application()\n",{"type":49,"tag":50,"props":21879,"children":21881},{"id":21880},"vi-port-binding",[21882],{"type":55,"value":21883},"VI. Port binding",{"type":49,"tag":58,"props":21885,"children":21886},{},[21887],{"type":49,"tag":72,"props":21888,"children":21889},{},[21890],{"type":55,"value":21891},"Export services via port binding",{"type":49,"tag":58,"props":21893,"children":21894},{},[21895],{"type":55,"value":21896},"This is an area that I'm trying to learn more about. I feel like I have a pretty good grasp of what is going on regarding port binding in the microservice architecture with docker I have seen.",{"type":49,"tag":58,"props":21898,"children":21899},{},[21900,21902,21908],{"type":55,"value":21901},"From the docker-compose docs, the \"short syntax\" for mapping ports between hosts and containers is ",{"type":49,"tag":326,"props":21903,"children":21905},{"className":21904},[],[21906],{"type":55,"value":21907},"HOST:CONTAINER",{"type":55,"value":6694},{"type":49,"tag":2910,"props":21910,"children":21911},{},[21912],{"type":49,"tag":58,"props":21913,"children":21914},{},[21915],{"type":55,"value":21916},"Either specify both ports (HOST:CONTAINER), or just the container port (a random host port will be chosen).",{"type":49,"tag":58,"props":21918,"children":21919},{},[21920],{"type":55,"value":21921},"The following are examples of how this could work:",{"type":49,"tag":1050,"props":21923,"children":21925},{"code":21924},"ports:\n - \"3000\"\n - \"3000-3005\"\n - \"8000:8000\"\n - \"9090-9091:8080-8081\"\n - \"49100:22\"\n - \"127.0.0.1:8001:8001\"\n - \"127.0.0.1:5000-5010:5000-5010\"\n - \"6060:6060/udp\"\n",[21926],{"type":49,"tag":326,"props":21927,"children":21928},{"__ignoreMap":8},[21929],{"type":55,"value":21924},{"type":49,"tag":50,"props":21931,"children":21933},{"id":21932},"viii-concurrency",[21934],{"type":55,"value":21935},"VIII. Concurrency",{"type":49,"tag":58,"props":21937,"children":21938},{},[21939],{"type":49,"tag":72,"props":21940,"children":21941},{},[21942],{"type":55,"value":21943},"Scale out via the process model",{"type":49,"tag":58,"props":21945,"children":21946},{},[21947],{"type":55,"value":21948},"This is an important area, but it is something I haven't had to be aware of since the apps I have developed don't require scaling processes. I belive that Heroku makes this fairly simple by allowing you to increase the number of web or worker processes through the CLI:",{"type":49,"tag":1050,"props":21950,"children":21952},{"code":21951},"heroku ps:scale web=1 worker=5\n",[21953],{"type":49,"tag":326,"props":21954,"children":21955},{"__ignoreMap":8},[21956],{"type":55,"value":21951},{"type":49,"tag":58,"props":21958,"children":21959},{},[21960],{"type":55,"value":21961},"I haven't covered Part 5 of testdriven.io yet, but it has a section on Elastic Load Balancing with EC2 which should cover this area.",{"type":49,"tag":2910,"props":21963,"children":21964},{},[21965],{"type":49,"tag":58,"props":21966,"children":21967},{},[21968],{"type":55,"value":21969},"Twelve-factor app processes should never daemonize or write PID files. Instead, rely on the operating system’s process manager to manage output streams, respond to crashed processes, and handle user-initiated restarts and shutdowns.",{"type":49,"tag":58,"props":21971,"children":21972},{},[21973,21975,21981],{"type":55,"value":21974},"I have been learning more about ",{"type":49,"tag":326,"props":21976,"children":21978},{"className":21977},[],[21979],{"type":55,"value":21980},"systemd",{"type":55,"value":21982}," and customizing",{"type":49,"tag":50,"props":21984,"children":21986},{"id":21985},"ix-disposability",[21987],{"type":55,"value":21988},"IX. Disposability",{"type":49,"tag":58,"props":21990,"children":21991},{},[21992],{"type":49,"tag":72,"props":21993,"children":21994},{},[21995],{"type":55,"value":21996},"Maximize robustness with fast startup and graceful shutdown",{"type":49,"tag":2910,"props":21998,"children":21999},{},[22000],{"type":49,"tag":58,"props":22001,"children":22002},{},[22003],{"type":55,"value":22004},"The twelve-factor app’s processes are disposable, meaning they can be started or stopped at a moment’s notice. This facilitates fast elastic scaling, rapid deployment of code or config changes, and robustness of production deploys.",{"type":49,"tag":58,"props":22006,"children":22007},{},[22008,22010,22017,22019,22025],{"type":55,"value":22009},"I have used some Heroku tools to start and stop web workers, and docker commands make this factor fairly easy to do correctly. Here's an excerpt from ",{"type":49,"tag":80,"props":22011,"children":22014},{"href":22012,"rel":22013},"https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/",[84],[22015],{"type":55,"value":22016},"Century Link",{"type":55,"value":22018}," about the ",{"type":49,"tag":326,"props":22020,"children":22022},{"className":22021},[],[22023],{"type":55,"value":22024},"docker stop",{"type":55,"value":13378},{"type":49,"tag":2910,"props":22027,"children":22028},{},[22029],{"type":49,"tag":58,"props":22030,"children":22031},{},[22032],{"type":55,"value":22033},"The docker stop command attempts to stop a running container first by sending a SIGTERM signal to the root process (PID 1) in the container. If the process hasn't exited within the timeout period a SIGKILL signal will be sent.",{"type":49,"tag":50,"props":22035,"children":22037},{"id":22036},"x-devprod-parity",[22038],{"type":55,"value":22039},"X. Dev/prod parity",{"type":49,"tag":2910,"props":22041,"children":22042},{},[22043],{"type":49,"tag":58,"props":22044,"children":22045},{},[22046],{"type":55,"value":22047},"Keep development, staging, and production as similar as possible",{"type":49,"tag":58,"props":22049,"children":22050},{},[22051],{"type":55,"value":22052},"This is exactly why I'm so interested in using Docker.",{"type":49,"tag":58,"props":22054,"children":22055},{},[22056],{"type":55,"value":22057},"In one of my personal projects I did with Heroku I was relying on a feature of Postgres that is not available in sqlite3, the default database that comes with Django. This produced friction that I wouldn't have had to deal with if I was using Docker. I could have set up a local postgres server, but it would have been much easier to run a docker container that ran the server.",{"type":49,"tag":50,"props":22059,"children":22061},{"id":22060},"xi-logs",[22062],{"type":55,"value":22063},"XI. Logs",{"type":49,"tag":58,"props":22065,"children":22066},{},[22067],{"type":49,"tag":72,"props":22068,"children":22069},{},[22070],{"type":55,"value":22071},"Treat logs as event streams",{"type":49,"tag":2910,"props":22073,"children":22074},{},[22075],{"type":49,"tag":58,"props":22076,"children":22077},{},[22078],{"type":55,"value":22079},"A twelve-factor app never concerns itself with routing or storage of its output stream. It should not attempt to write to or manage logfiles. Instead, each running process writes its event stream, unbuffered, to stdout. During local development, the developer will view this stream in the foreground of their terminal to observe the app’s behavior.",{"type":49,"tag":58,"props":22081,"children":22082},{},[22083,22084,22090],{"type":55,"value":16246},{"type":49,"tag":326,"props":22085,"children":22087},{"className":22086},[],[22088],{"type":55,"value":22089},"heroku log",{"type":55,"value":22091}," has been helpful in debugging deployment issues.",{"type":49,"tag":58,"props":22093,"children":22094},{},[22095],{"type":55,"value":22096},"Docker also produces helpful logs for all the containers currently running.",{"type":49,"tag":50,"props":22098,"children":22100},{"id":22099},"xii-admin-processes",[22101],{"type":55,"value":22102},"XII. Admin processes",{"type":49,"tag":58,"props":22104,"children":22105},{},[22106],{"type":49,"tag":72,"props":22107,"children":22108},{},[22109],{"type":55,"value":22110},"Run admin/management tasks as one-off processes",{"type":49,"tag":2910,"props":22112,"children":22113},{},[22114],{"type":49,"tag":58,"props":22115,"children":22116},{},[22117],{"type":55,"value":22118},"One-off admin processes should be run in an identical environment as the regular long-running processes of the app. They run against a release, using the same codebase and config as any process run against that release. Admin code must ship with application code to avoid synchronization issues.",{"type":49,"tag":58,"props":22120,"children":22121},{},[22122],{"type":55,"value":22123},"This seems to be true about the way I run admin processes on my Django apps.",{"type":49,"tag":7749,"props":22125,"children":22126},{},[22127],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":22129},[22130,22131,22132,22133,22134,22135,22136,22137,22138,22139,22140,22141],{"id":20857,"depth":1079,"text":20860},{"id":21034,"depth":1079,"text":21037},{"id":21168,"depth":1079,"text":21171},{"id":21216,"depth":1079,"text":21219},{"id":21674,"depth":1079,"text":21677},{"id":21701,"depth":1079,"text":21704},{"id":21880,"depth":1079,"text":21883},{"id":21932,"depth":1079,"text":21935},{"id":21985,"depth":1079,"text":21988},{"id":22036,"depth":1079,"text":22039},{"id":22060,"depth":1079,"text":22063},{"id":22099,"depth":1079,"text":22102},"content:2017:12:03:the-twelve-factor-app-and-my-experience-developing-web-apps.md","2017/12/03/the-twelve-factor-app-and-my-experience-developing-web-apps.md","2017/12/03/the-twelve-factor-app-and-my-experience-developing-web-apps",{"_path":22146,"_dir":22147,"_draft":7,"_partial":7,"_locale":8,"title":22148,"description":22149,"layout":14767,"date":22150,"comments":44,"image":22151,"tags":22152,"body":22154,"_type":7809,"_id":22440,"_source":7811,"_file":22441,"_stem":22442,"_extension":7814},"/2017/11/28/remove-root-partition-bloat-from-docker","28","Removing root partition bloat caused by docker","Recently I've been having storage issues in the root partitions of both my desktop and laptop computers. These issues came up soon after I started playing around with docker. In this article I'll talk briefly about how I fixed this problem, the resources and tools I picked up along the way, and anything else I have learned along the way.","2017-11-28T00:00:00.000Z","/static/baobab.png",[24,22153],"linux",{"type":46,"children":22155,"toc":22438},[22156,22160,22181,22194,22201,22224,22232,22237,22245,22250,22257,22270,22275,22289,22294,22299,22307,22312,22324,22330,22335,22343,22355,22363,22368,22391,22404,22430],{"type":49,"tag":58,"props":22157,"children":22158},{},[22159],{"type":55,"value":22149},{"type":49,"tag":58,"props":22161,"children":22162},{},[22163,22165,22171,22173,22179],{"type":55,"value":22164},"I first learned how bad this issue was when I went to install anaconda on my desktop PC. I quiclky ran ",{"type":49,"tag":326,"props":22166,"children":22168},{"className":22167},[],[22169],{"type":55,"value":22170},"df -h",{"type":55,"value":22172}," and saw that my 20G root partition had less than 1G of available space. To look further into this I ran ",{"type":49,"tag":326,"props":22174,"children":22176},{"className":22175},[],[22177],{"type":55,"value":22178},"baobab",{"type":55,"value":22180},". In the baobab home screen the root partition had slightly more space, but it was still close to being full. The expanded view was only showing me informatoin for around 8G of storage, leaving almost 11G of space not accounted for.",{"type":49,"tag":58,"props":22182,"children":22183},{},[22184,22186,22192],{"type":55,"value":22185},"I started reaching for different tools and packages to slim down disk usage. ",{"type":49,"tag":326,"props":22187,"children":22189},{"className":22188},[],[22190],{"type":55,"value":22191},"pacgraph",{"type":55,"value":22193}," is a pretty neat way to visualize the relative size of packages. Here's an example:",{"type":49,"tag":58,"props":22195,"children":22196},{},[22197],{"type":49,"tag":1601,"props":22198,"children":22200},{"alt":8926,"src":22199},"/static/pacgraph.png",[],{"type":49,"tag":58,"props":22202,"children":22203},{},[22204,22206,22211,22212,22217,22219,22222],{"type":55,"value":22205},"This helps you quickly find packages that you can do without. After removing some large packages like Libre Office I realized that this was barely moving the needle on my storage problem. Running ",{"type":49,"tag":326,"props":22207,"children":22209},{"className":22208},[],[22210],{"type":55,"value":22170},{"type":55,"value":715},{"type":49,"tag":326,"props":22213,"children":22215},{"className":22214},[],[22216],{"type":55,"value":22178},{"type":55,"value":22218}," again with root priviledges gave me slightly different results. At this point I turned to docker and deleted all of the images with `docker rmi ",{"type":49,"tag":1601,"props":22220,"children":22221},{"id":8},[],{"type":55,"value":22223}," -f. This didn't help either. Here are the images that I removed from my desktop:",{"type":49,"tag":1050,"props":22225,"children":22227},{"code":22226},"[brian@a1arch ~]$ docker images\nREPOSITORY                              TAG                 IMAGE ID            CREATED             SIZE\nflaskmicroservicesusers_users-service   latest              1e59fa4d2af5        5 days ago          739MB\n\u003Cnone>                                  \u003Cnone>              18f9191b4d9a        5 days ago          739MB\nflaskmicroservicesusers_users-db        latest              f1de1c3ef3f2        5 days ago          287MB\n\u003Cnone>                                  \u003Cnone>              11188ac6f36a        5 days ago          712MB\npostgres                                latest              599272bf538f        12 days ago         287MB\ntensorflow/tensorflow                   latest-gpu          2f243a16ff63        3 weeks ago         3.36GB\npython                                  3.6.2               26acbad26a2c        2 months ago        690MB\n",[22228],{"type":49,"tag":326,"props":22229,"children":22230},{"__ignoreMap":8},[22231],{"type":55,"value":22226},{"type":49,"tag":58,"props":22233,"children":22234},{},[22235],{"type":55,"value":22236},"Here's the storage profile before I started remove docker-related files:",{"type":49,"tag":1050,"props":22238,"children":22240},{"code":22239}," $ df -h | grep /dev/sda1\n/dev/sda1        20G   18G  737M  97% /\n",[22241],{"type":49,"tag":326,"props":22242,"children":22243},{"__ignoreMap":8},[22244],{"type":55,"value":22239},{"type":49,"tag":58,"props":22246,"children":22247},{},[22248],{"type":55,"value":22249},"After I removed the docker images, here is the same command:",{"type":49,"tag":1050,"props":22251,"children":22252},{"code":22239},[22253],{"type":49,"tag":326,"props":22254,"children":22255},{"__ignoreMap":8},[22256],{"type":55,"value":22239},{"type":49,"tag":58,"props":22258,"children":22259},{},[22260,22262,22269],{"type":55,"value":22261},"I found a helpful serverfault question from 6 years ago that address the issue I was having titled ",{"type":49,"tag":80,"props":22263,"children":22266},{"href":22264,"rel":22265},"https://serverfault.com/questions/275206/disk-full-du-tells-different-how-to-further-investigate",[84],[22267],{"type":55,"value":22268},"Disk full, du tells different. How to further investigate?",{"type":55,"value":745},{"type":49,"tag":58,"props":22271,"children":22272},{},[22273],{"type":55,"value":22274},"I saw a helpful comment related to docker:",{"type":49,"tag":2910,"props":22276,"children":22277},{},[22278],{"type":49,"tag":58,"props":22279,"children":22280},{},[22281,22283],{"type":55,"value":22282},"Thanks - this showed that docker was filling up my hard drive with diffs in ",{"type":49,"tag":326,"props":22284,"children":22286},{"className":22285},[],[22287],{"type":55,"value":22288},"/var/lib/docker/aufs/diff/",{"type":49,"tag":58,"props":22290,"children":22291},{},[22292],{"type":55,"value":22293},"Could this be my issue?",{"type":49,"tag":58,"props":22295,"children":22296},{},[22297],{"type":55,"value":22298},"Here's the folder in question on my laptop:",{"type":49,"tag":1050,"props":22300,"children":22302},{"code":22301}," $ cd /var/lib/docker\n $ sudo du -s -h .\n2.6G    .\n",[22303],{"type":49,"tag":326,"props":22304,"children":22305},{"__ignoreMap":8},[22306],{"type":55,"value":22301},{"type":49,"tag":58,"props":22308,"children":22309},{},[22310],{"type":55,"value":22311},"On my desktop this was taking up about 10G!",{"type":49,"tag":58,"props":22313,"children":22314},{},[22315,22317,22323],{"type":55,"value":22316},"Wow! I didn't even see this when I ran ",{"type":49,"tag":326,"props":22318,"children":22320},{"className":22319},[],[22321],{"type":55,"value":22322},"sudo baobab",{"type":55,"value":6694},{"type":49,"tag":58,"props":22325,"children":22326},{},[22327],{"type":49,"tag":1601,"props":22328,"children":22329},{"alt":8926,"src":22151},[],{"type":49,"tag":58,"props":22331,"children":22332},{},[22333],{"type":55,"value":22334},"I stopped the docker service and deleted the overlay2 file:",{"type":49,"tag":1050,"props":22336,"children":22338},{"code":22337}," $ sudo systemctl stop docker\n $ cd /var/lib/docker\n $ sudo rm -rf layover2\n",[22339],{"type":49,"tag":326,"props":22340,"children":22341},{"__ignoreMap":8},[22342],{"type":55,"value":22337},{"type":49,"tag":58,"props":22344,"children":22345},{},[22346,22348,22353],{"type":55,"value":22347},"With ",{"type":49,"tag":326,"props":22349,"children":22351},{"className":22350},[],[22352],{"type":55,"value":22322},{"type":55,"value":22354}," I was also able to delete 3.6G of trash with this command:",{"type":49,"tag":1050,"props":22356,"children":22358},{"code":22357}," $ sudo -i\n # rm -rf /root/.local/share/Trash\n",[22359],{"type":49,"tag":326,"props":22360,"children":22361},{"__ignoreMap":8},[22362],{"type":55,"value":22357},{"type":49,"tag":58,"props":22364,"children":22365},{},[22366],{"type":55,"value":22367},"I think this may be related to having previously emptied the Trash in nautilus file browser with files that I might not have owned.",{"type":49,"tag":58,"props":22369,"children":22370},{},[22371,22373,22380,22382,22389],{"type":55,"value":22372},"I think it would be a good idea to change the docker image installation directory. ",{"type":49,"tag":80,"props":22374,"children":22377},{"href":22375,"rel":22376},"https://forums.docker.com/t/how-do-i-change-the-docker-image-installation-directory/1169",[84],[22378],{"type":55,"value":22379},"Here is a link",{"type":55,"value":22381}," from a docker forum talking about how to do that. ",{"type":49,"tag":80,"props":22383,"children":22386},{"href":22384,"rel":22385},"https://forums.docker.com/t/some-way-to-clean-up-identify-contents-of-var-lib-docker-overlay/30604",[84],[22387],{"type":55,"value":22388},"Here is another docker forum post",{"type":55,"value":22390}," that talks about the overlay and storage issues that docker has.",{"type":49,"tag":58,"props":22392,"children":22393},{},[22394,22396,22403],{"type":55,"value":22395},"Here is a helpful snippet from the ",{"type":49,"tag":80,"props":22397,"children":22400},{"href":22398,"rel":22399},"https://wiki.archlinux.org/index.php/Docker",[84],[22401],{"type":55,"value":22402},"Arch Wiki Docker article",{"type":55,"value":6694},{"type":49,"tag":2910,"props":22405,"children":22406},{},[22407,22412,22417,22422],{"type":49,"tag":58,"props":22408,"children":22409},{},[22410],{"type":55,"value":22411},"Images location\nBy default, docker images are located at /var/lib/docker. They can be moved to other partitions. First, stop the docker.service.",{"type":49,"tag":58,"props":22413,"children":22414},{},[22415],{"type":55,"value":22416},"If you have run the docker images, you need to make sure the images are unmounted totally. Once that is completed, you may move the images from /var/lib/docker to the target destination.",{"type":49,"tag":58,"props":22418,"children":22419},{},[22420],{"type":55,"value":22421},"Then add a Drop-in snippet for the docker.service, adding the --data-root parameter to the ExecStart:",{"type":49,"tag":1050,"props":22423,"children":22425},{"code":22424},"/etc/systemd/system/docker.service.d/docker-storage.conf\n[Service]\nExecStart=\nExecStart=/usr/bin/dockerd --data-root=/path/to/new/location/docker -H fd://\n",[22426],{"type":49,"tag":326,"props":22427,"children":22428},{"__ignoreMap":8},[22429],{"type":55,"value":22424},{"type":49,"tag":1050,"props":22431,"children":22433},{"code":22432},"\nUpdate: I did this on my desktop with a `--data-rogettingot` path in my home folder.\n\nI followed the directions form [this article](https://linuxconfig.org/how-to-move-docker-s-default-var-lib-docker-to-another-directory-on-ubuntu-debian-linux) and was able to set up docker on my home partition.\n",[22434],{"type":49,"tag":326,"props":22435,"children":22436},{"__ignoreMap":8},[22437],{"type":55,"value":22432},{"title":8,"searchDepth":1079,"depth":1079,"links":22439},[],"content:2017:11:28:remove-root-partition-bloat-from-docker.md","2017/11/28/remove-root-partition-bloat-from-docker.md","2017/11/28/remove-root-partition-bloat-from-docker",{"_path":22444,"_dir":22445,"_draft":7,"_partial":7,"_locale":8,"title":22446,"description":22447,"layout":14767,"date":22448,"comments":44,"image":22449,"tags":22450,"body":22452,"_type":7809,"_id":26145,"_source":7811,"_file":26146,"_stem":26147,"_extension":7814},"/2017/11/20/using-tensorflow-and-tensor-board-with-docker","20","Using Tensorflow and Tensorboard with Docker","In my last article we set up Tensorflow with Docker. Next I want to try to get Tensorboard running.","2017-11-20T00:00:00.000Z","/static/tf.png",[22451,24],"tensorflow",{"type":46,"children":22453,"toc":26143},[22454,22458,22463,22471,22491,22499,22520,22525,22533,22538,26102,26107,26115,26128,26134,26139],{"type":49,"tag":58,"props":22455,"children":22456},{},[22457],{"type":55,"value":22447},{"type":49,"tag":58,"props":22459,"children":22460},{},[22461],{"type":55,"value":22462},"When we opened the Jupyter notebook, our command included port mapping. Here is that command:",{"type":49,"tag":1050,"props":22464,"children":22466},{"code":22465},"$ sudo nvidia-docker run -it -p 8888:8888 tensorflow/tensorflow:latest-gpu\n",[22467],{"type":49,"tag":326,"props":22468,"children":22469},{"__ignoreMap":8},[22470],{"type":55,"value":22465},{"type":49,"tag":58,"props":22472,"children":22473},{},[22474,22476,22482,22484,22490],{"type":55,"value":22475},"Tensorboard will be served in our browser on port ",{"type":49,"tag":326,"props":22477,"children":22479},{"className":22478},[],[22480],{"type":55,"value":22481},"6006",{"type":55,"value":22483},", so we will want to do that port mapping in our ",{"type":49,"tag":326,"props":22485,"children":22487},{"className":22486},[],[22488],{"type":55,"value":22489},"nvidia-docker",{"type":55,"value":13378},{"type":49,"tag":1050,"props":22492,"children":22494},{"code":22493},"sudo nvidia-docker run -p 0.0.0.0:6006:6006 -it tensorflow/tensorflow:latest-gpu bash\n",[22495],{"type":49,"tag":326,"props":22496,"children":22497},{"__ignoreMap":8},[22498],{"type":55,"value":22493},{"type":49,"tag":58,"props":22500,"children":22501},{},[22502,22504,22511,22513,22519],{"type":55,"value":22503},"I want to run ",{"type":49,"tag":80,"props":22505,"children":22508},{"href":22506,"rel":22507},"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/tutorials/mnist/mnist_with_summaries.py",[84],[22509],{"type":55,"value":22510},"this script",{"type":55,"value":22512}," from the Tensorflow github repo. It is an example of MNIST with summaries. Summaries are logs that are captured from script and they provide the data that runs Tensorboard. In this case they are recorded in ",{"type":49,"tag":326,"props":22514,"children":22516},{"className":22515},[],[22517],{"type":55,"value":22518},"/tmp/tensorflow/mnist/logs/",{"type":55,"value":745},{"type":49,"tag":58,"props":22521,"children":22522},{},[22523],{"type":55,"value":22524},"To start with this script let's just copy and paste it into a file. We will need to add vim to our docker container for that:",{"type":49,"tag":1050,"props":22526,"children":22528},{"code":22527},"# apt-get update\n# apt-get install vim\n",[22529],{"type":49,"tag":326,"props":22530,"children":22531},{"__ignoreMap":8},[22532],{"type":55,"value":22527},{"type":49,"tag":58,"props":22534,"children":22535},{},[22536],{"type":55,"value":22537},"Now we can copy and paste the script and run it:",{"type":49,"tag":1050,"props":22539,"children":22541},{"code":22540,"language":19534,"meta":8,"className":19535,"style":8},"root@eb9e069064d7:~# python tb.py\nSuccessfully downloaded train-images-idx3-ubyte.gz 9912422 bytes.\nExtracting /tmp/tensorflow/mnist/input_data/train-images-idx3-ubyte.gz\nSuccessfully downloaded train-labels-idx1-ubyte.gz 28881 bytes.\nExtracting /tmp/tensorflow/mnist/input_data/train-labels-idx1-ubyte.gz\nSuccessfully downloaded t10k-images-idx3-ubyte.gz 1648877 bytes.\nExtracting /tmp/tensorflow/mnist/input_data/t10k-images-idx3-ubyte.gz\nSuccessfully downloaded t10k-labels-idx1-ubyte.gz 4542 bytes.\nExtracting /tmp/tensorflow/mnist/input_data/t10k-labels-idx1-ubyte.gz\n2017-11-20 03:52:53.792141: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\n2017-11-20 03:52:53.878640: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:892] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2017-11-20 03:52:53.878892: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.7335\npciBusID: 0000:01:00.0\ntotalMemory: 7.92GiB freeMemory: 7.43GiB\n2017-11-20 03:52:53.878904: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1)\nAccuracy at step 0: 0.1235\nAccuracy at step 10: 0.7297\nAccuracy at step 20: 0.8414\nAccuracy at step 30: 0.8717\nAccuracy at step 40: 0.886\nAccuracy at step 50: 0.896\nAccuracy at step 60: 0.9027\nAccuracy at step 70: 0.9068\nAccuracy at step 80: 0.9101\nAccuracy at step 90: 0.9121\n2017-11-20 03:52:57.583676: I tensorflow/stream_executor/dso_loader.cc:139] successfully opened CUDA library libcupti.so.8.0 locally\nAdding run metadata for 99\nAccuracy at step 100: 0.9124\nAccuracy at step 110: 0.9164\nAccuracy at step 120: 0.9198\nAccuracy at step 130: 0.9205\nAccuracy at step 140: 0.9142\nAccuracy at step 150: 0.9224\nAccuracy at step 160: 0.9294\nAccuracy at step 170: 0.928\nAccuracy at step 180: 0.9312\nAccuracy at step 190: 0.9301\nAdding run metadata for 199\nAccuracy at step 200: 0.9346\nAccuracy at step 210: 0.9381\nAccuracy at step 220: 0.9396\nAccuracy at step 230: 0.9406\nAccuracy at step 240: 0.9273\nAccuracy at step 250: 0.941\nAccuracy at step 260: 0.9369\nAccuracy at step 270: 0.9329\nAccuracy at step 280: 0.9404\nAccuracy at step 290: 0.9444\nAdding run metadata for 299\nAccuracy at step 300: 0.9438\nAccuracy at step 310: 0.9426\nAccuracy at step 320: 0.9462\nAccuracy at step 330: 0.9449\nAccuracy at step 340: 0.9478\nAccuracy at step 350: 0.9458\nAccuracy at step 360: 0.9464\nAccuracy at step 370: 0.9474\nAccuracy at step 380: 0.9528\nAccuracy at step 390: 0.9499\nAdding run metadata for 399\nAccuracy at step 400: 0.9507\nAccuracy at step 410: 0.9501\nAccuracy at step 420: 0.9513\nAccuracy at step 430: 0.9483\nAccuracy at step 440: 0.9518\nAccuracy at step 450: 0.949\nAccuracy at step 460: 0.9543\nAccuracy at step 470: 0.9552\nAccuracy at step 480: 0.9515\nAccuracy at step 490: 0.9544\nAdding run metadata for 499\nAccuracy at step 500: 0.9586\nAccuracy at step 510: 0.9567\nAccuracy at step 520: 0.9572\nAccuracy at step 530: 0.9574\nAccuracy at step 540: 0.9584\nAccuracy at step 550: 0.9593\nAccuracy at step 560: 0.958\nAccuracy at step 570: 0.9575\nAccuracy at step 580: 0.9582\nAccuracy at step 590: 0.9609\nAdding run metadata for 599\nAccuracy at step 600: 0.9618\nAccuracy at step 610: 0.9605\nAccuracy at step 620: 0.9606\nAccuracy at step 630: 0.961\nAccuracy at step 640: 0.963\nAccuracy at step 650: 0.9614\nAccuracy at step 660: 0.9622\nAccuracy at step 670: 0.9634\nAccuracy at step 680: 0.9641\nAccuracy at step 690: 0.9627\nAdding run metadata for 699\nAccuracy at step 700: 0.9623\nAccuracy at step 710: 0.9612\nAccuracy at step 720: 0.9628\nAccuracy at step 730: 0.965\nAccuracy at step 740: 0.9635\nAccuracy at step 750: 0.9635\nAccuracy at step 760: 0.9648\nAccuracy at step 770: 0.9637\nAccuracy at step 780: 0.9658\nAccuracy at step 790: 0.9649\nAdding run metadata for 799\nAccuracy at step 800: 0.9681\nAccuracy at step 810: 0.9661\nAccuracy at step 820: 0.9657\nAccuracy at step 830: 0.9646\nAccuracy at step 840: 0.9647\nAccuracy at step 850: 0.965\nAccuracy at step 860: 0.9677\nAccuracy at step 870: 0.9649\nAccuracy at step 880: 0.9675\nAccuracy at step 890: 0.969\nAdding run metadata for 899\nAccuracy at step 900: 0.9689\nAccuracy at step 910: 0.967\nAccuracy at step 920: 0.9672\nAccuracy at step 930: 0.9645\nAccuracy at step 940: 0.9657\nAccuracy at step 950: 0.9699\nAccuracy at step 960: 0.968\nAccuracy at step 970: 0.9679\nAccuracy at step 980: 0.9651\nAccuracy at step 990: 0.9683\nAdding run metadata for 999\n",[22542],{"type":49,"tag":326,"props":22543,"children":22544},{"__ignoreMap":8},[22545,22572,22622,22699,22744,22815,22860,22932,22976,23047,23197,23336,23447,23494,23528,23560,23758,23779,23800,23820,23841,23862,23883,23904,23925,23945,23966,24055,24072,24093,24114,24135,24156,24177,24198,24219,24240,24261,24282,24298,24319,24340,24361,24382,24403,24424,24445,24466,24487,24508,24524,24545,24566,24587,24608,24629,24650,24671,24692,24713,24734,24750,24771,24792,24813,24834,24855,24876,24897,24918,24939,24960,24976,24997,25018,25039,25060,25081,25102,25123,25144,25165,25186,25202,25223,25244,25265,25286,25307,25328,25349,25370,25391,25412,25428,25449,25470,25491,25512,25533,25553,25574,25595,25616,25637,25653,25674,25695,25716,25737,25758,25778,25799,25819,25840,25861,25877,25898,25919,25940,25961,25981,26002,26023,26044,26065,26086],{"type":49,"tag":1060,"props":22546,"children":22547},{"class":1062,"line":1063},[22548,22552,22557,22562,22567],{"type":49,"tag":1060,"props":22549,"children":22550},{"style":1073},[22551],{"type":55,"value":46},{"type":49,"tag":1060,"props":22553,"children":22554},{"style":2194},[22555],{"type":55,"value":22556},"@",{"type":49,"tag":1060,"props":22558,"children":22559},{"style":1073},[22560],{"type":55,"value":22561},"eb9e069064d7:",{"type":49,"tag":1060,"props":22563,"children":22564},{"style":2194},[22565],{"type":55,"value":22566},"~",{"type":49,"tag":1060,"props":22568,"children":22569},{"style":3039},[22570],{"type":55,"value":22571},"# python tb.py\n",{"type":49,"tag":1060,"props":22573,"children":22574},{"class":1062,"line":1079},[22575,22580,22584,22589,22593,22598,22602,22607,22612,22617],{"type":49,"tag":1060,"props":22576,"children":22577},{"style":1073},[22578],{"type":55,"value":22579},"Successfully downloaded train",{"type":49,"tag":1060,"props":22581,"children":22582},{"style":2194},[22583],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22585,"children":22586},{"style":1073},[22587],{"type":55,"value":22588},"images",{"type":49,"tag":1060,"props":22590,"children":22591},{"style":2194},[22592],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22594,"children":22595},{"style":1073},[22596],{"type":55,"value":22597},"idx3",{"type":49,"tag":1060,"props":22599,"children":22600},{"style":2194},[22601],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22603,"children":22604},{"style":1073},[22605],{"type":55,"value":22606},"ubyte.gz ",{"type":49,"tag":1060,"props":22608,"children":22609},{"style":2287},[22610],{"type":55,"value":22611},"9912422",{"type":49,"tag":1060,"props":22613,"children":22614},{"style":5200},[22615],{"type":55,"value":22616}," bytes",{"type":49,"tag":1060,"props":22618,"children":22619},{"style":1073},[22620],{"type":55,"value":22621},".\n",{"type":49,"tag":1060,"props":22623,"children":22624},{"class":1062,"line":1088},[22625,22630,22634,22639,22643,22647,22651,22656,22660,22665,22669,22674,22678,22682,22686,22690,22694],{"type":49,"tag":1060,"props":22626,"children":22627},{"style":1073},[22628],{"type":55,"value":22629},"Extracting ",{"type":49,"tag":1060,"props":22631,"children":22632},{"style":2194},[22633],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22635,"children":22636},{"style":1073},[22637],{"type":55,"value":22638},"tmp",{"type":49,"tag":1060,"props":22640,"children":22641},{"style":2194},[22642],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22644,"children":22645},{"style":1073},[22646],{"type":55,"value":22451},{"type":49,"tag":1060,"props":22648,"children":22649},{"style":2194},[22650],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22652,"children":22653},{"style":1073},[22654],{"type":55,"value":22655},"mnist",{"type":49,"tag":1060,"props":22657,"children":22658},{"style":2194},[22659],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22661,"children":22662},{"style":1073},[22663],{"type":55,"value":22664},"input_data",{"type":49,"tag":1060,"props":22666,"children":22667},{"style":2194},[22668],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22670,"children":22671},{"style":1073},[22672],{"type":55,"value":22673},"train",{"type":49,"tag":1060,"props":22675,"children":22676},{"style":2194},[22677],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22679,"children":22680},{"style":1073},[22681],{"type":55,"value":22588},{"type":49,"tag":1060,"props":22683,"children":22684},{"style":2194},[22685],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22687,"children":22688},{"style":1073},[22689],{"type":55,"value":22597},{"type":49,"tag":1060,"props":22691,"children":22692},{"style":2194},[22693],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22695,"children":22696},{"style":1073},[22697],{"type":55,"value":22698},"ubyte.gz\n",{"type":49,"tag":1060,"props":22700,"children":22701},{"class":1062,"line":1097},[22702,22706,22710,22714,22718,22723,22727,22731,22736,22740],{"type":49,"tag":1060,"props":22703,"children":22704},{"style":1073},[22705],{"type":55,"value":22579},{"type":49,"tag":1060,"props":22707,"children":22708},{"style":2194},[22709],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22711,"children":22712},{"style":1073},[22713],{"type":55,"value":18359},{"type":49,"tag":1060,"props":22715,"children":22716},{"style":2194},[22717],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22719,"children":22720},{"style":1073},[22721],{"type":55,"value":22722},"idx1",{"type":49,"tag":1060,"props":22724,"children":22725},{"style":2194},[22726],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22728,"children":22729},{"style":1073},[22730],{"type":55,"value":22606},{"type":49,"tag":1060,"props":22732,"children":22733},{"style":2287},[22734],{"type":55,"value":22735},"28881",{"type":49,"tag":1060,"props":22737,"children":22738},{"style":5200},[22739],{"type":55,"value":22616},{"type":49,"tag":1060,"props":22741,"children":22742},{"style":1073},[22743],{"type":55,"value":22621},{"type":49,"tag":1060,"props":22745,"children":22746},{"class":1062,"line":1111},[22747,22751,22755,22759,22763,22767,22771,22775,22779,22783,22787,22791,22795,22799,22803,22807,22811],{"type":49,"tag":1060,"props":22748,"children":22749},{"style":1073},[22750],{"type":55,"value":22629},{"type":49,"tag":1060,"props":22752,"children":22753},{"style":2194},[22754],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22756,"children":22757},{"style":1073},[22758],{"type":55,"value":22638},{"type":49,"tag":1060,"props":22760,"children":22761},{"style":2194},[22762],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22764,"children":22765},{"style":1073},[22766],{"type":55,"value":22451},{"type":49,"tag":1060,"props":22768,"children":22769},{"style":2194},[22770],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22772,"children":22773},{"style":1073},[22774],{"type":55,"value":22655},{"type":49,"tag":1060,"props":22776,"children":22777},{"style":2194},[22778],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22780,"children":22781},{"style":1073},[22782],{"type":55,"value":22664},{"type":49,"tag":1060,"props":22784,"children":22785},{"style":2194},[22786],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22788,"children":22789},{"style":1073},[22790],{"type":55,"value":22673},{"type":49,"tag":1060,"props":22792,"children":22793},{"style":2194},[22794],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22796,"children":22797},{"style":1073},[22798],{"type":55,"value":18359},{"type":49,"tag":1060,"props":22800,"children":22801},{"style":2194},[22802],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22804,"children":22805},{"style":1073},[22806],{"type":55,"value":22722},{"type":49,"tag":1060,"props":22808,"children":22809},{"style":2194},[22810],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22812,"children":22813},{"style":1073},[22814],{"type":55,"value":22698},{"type":49,"tag":1060,"props":22816,"children":22817},{"class":1062,"line":1120},[22818,22823,22827,22831,22835,22839,22843,22847,22852,22856],{"type":49,"tag":1060,"props":22819,"children":22820},{"style":1073},[22821],{"type":55,"value":22822},"Successfully downloaded t10k",{"type":49,"tag":1060,"props":22824,"children":22825},{"style":2194},[22826],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22828,"children":22829},{"style":1073},[22830],{"type":55,"value":22588},{"type":49,"tag":1060,"props":22832,"children":22833},{"style":2194},[22834],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22836,"children":22837},{"style":1073},[22838],{"type":55,"value":22597},{"type":49,"tag":1060,"props":22840,"children":22841},{"style":2194},[22842],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22844,"children":22845},{"style":1073},[22846],{"type":55,"value":22606},{"type":49,"tag":1060,"props":22848,"children":22849},{"style":2287},[22850],{"type":55,"value":22851},"1648877",{"type":49,"tag":1060,"props":22853,"children":22854},{"style":5200},[22855],{"type":55,"value":22616},{"type":49,"tag":1060,"props":22857,"children":22858},{"style":1073},[22859],{"type":55,"value":22621},{"type":49,"tag":1060,"props":22861,"children":22862},{"class":1062,"line":1128},[22863,22867,22871,22875,22879,22883,22887,22891,22895,22899,22903,22908,22912,22916,22920,22924,22928],{"type":49,"tag":1060,"props":22864,"children":22865},{"style":1073},[22866],{"type":55,"value":22629},{"type":49,"tag":1060,"props":22868,"children":22869},{"style":2194},[22870],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22872,"children":22873},{"style":1073},[22874],{"type":55,"value":22638},{"type":49,"tag":1060,"props":22876,"children":22877},{"style":2194},[22878],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22880,"children":22881},{"style":1073},[22882],{"type":55,"value":22451},{"type":49,"tag":1060,"props":22884,"children":22885},{"style":2194},[22886],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22888,"children":22889},{"style":1073},[22890],{"type":55,"value":22655},{"type":49,"tag":1060,"props":22892,"children":22893},{"style":2194},[22894],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22896,"children":22897},{"style":1073},[22898],{"type":55,"value":22664},{"type":49,"tag":1060,"props":22900,"children":22901},{"style":2194},[22902],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22904,"children":22905},{"style":1073},[22906],{"type":55,"value":22907},"t10k",{"type":49,"tag":1060,"props":22909,"children":22910},{"style":2194},[22911],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22913,"children":22914},{"style":1073},[22915],{"type":55,"value":22588},{"type":49,"tag":1060,"props":22917,"children":22918},{"style":2194},[22919],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22921,"children":22922},{"style":1073},[22923],{"type":55,"value":22597},{"type":49,"tag":1060,"props":22925,"children":22926},{"style":2194},[22927],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22929,"children":22930},{"style":1073},[22931],{"type":55,"value":22698},{"type":49,"tag":1060,"props":22933,"children":22934},{"class":1062,"line":1141},[22935,22939,22943,22947,22951,22955,22959,22963,22968,22972],{"type":49,"tag":1060,"props":22936,"children":22937},{"style":1073},[22938],{"type":55,"value":22822},{"type":49,"tag":1060,"props":22940,"children":22941},{"style":2194},[22942],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22944,"children":22945},{"style":1073},[22946],{"type":55,"value":18359},{"type":49,"tag":1060,"props":22948,"children":22949},{"style":2194},[22950],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22952,"children":22953},{"style":1073},[22954],{"type":55,"value":22722},{"type":49,"tag":1060,"props":22956,"children":22957},{"style":2194},[22958],{"type":55,"value":10180},{"type":49,"tag":1060,"props":22960,"children":22961},{"style":1073},[22962],{"type":55,"value":22606},{"type":49,"tag":1060,"props":22964,"children":22965},{"style":2287},[22966],{"type":55,"value":22967},"4542",{"type":49,"tag":1060,"props":22969,"children":22970},{"style":5200},[22971],{"type":55,"value":22616},{"type":49,"tag":1060,"props":22973,"children":22974},{"style":1073},[22975],{"type":55,"value":22621},{"type":49,"tag":1060,"props":22977,"children":22978},{"class":1062,"line":1150},[22979,22983,22987,22991,22995,22999,23003,23007,23011,23015,23019,23023,23027,23031,23035,23039,23043],{"type":49,"tag":1060,"props":22980,"children":22981},{"style":1073},[22982],{"type":55,"value":22629},{"type":49,"tag":1060,"props":22984,"children":22985},{"style":2194},[22986],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22988,"children":22989},{"style":1073},[22990],{"type":55,"value":22638},{"type":49,"tag":1060,"props":22992,"children":22993},{"style":2194},[22994],{"type":55,"value":3744},{"type":49,"tag":1060,"props":22996,"children":22997},{"style":1073},[22998],{"type":55,"value":22451},{"type":49,"tag":1060,"props":23000,"children":23001},{"style":2194},[23002],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23004,"children":23005},{"style":1073},[23006],{"type":55,"value":22655},{"type":49,"tag":1060,"props":23008,"children":23009},{"style":2194},[23010],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23012,"children":23013},{"style":1073},[23014],{"type":55,"value":22664},{"type":49,"tag":1060,"props":23016,"children":23017},{"style":2194},[23018],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23020,"children":23021},{"style":1073},[23022],{"type":55,"value":22907},{"type":49,"tag":1060,"props":23024,"children":23025},{"style":2194},[23026],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23028,"children":23029},{"style":1073},[23030],{"type":55,"value":18359},{"type":49,"tag":1060,"props":23032,"children":23033},{"style":2194},[23034],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23036,"children":23037},{"style":1073},[23038],{"type":55,"value":22722},{"type":49,"tag":1060,"props":23040,"children":23041},{"style":2194},[23042],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23044,"children":23045},{"style":1073},[23046],{"type":55,"value":22698},{"type":49,"tag":1060,"props":23048,"children":23049},{"class":1062,"line":1158},[23050,23055,23059,23064,23068,23072,23077,23083,23087,23092,23096,23101,23106,23110,23115,23119,23124,23128,23133,23138,23143,23148,23153,23158,23163,23168,23173,23177,23182,23187,23192],{"type":49,"tag":1060,"props":23051,"children":23052},{"style":2287},[23053],{"type":55,"value":23054},"2017",{"type":49,"tag":1060,"props":23056,"children":23057},{"style":2194},[23058],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23060,"children":23061},{"style":2287},[23062],{"type":55,"value":23063},"11",{"type":49,"tag":1060,"props":23065,"children":23066},{"style":2194},[23067],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23069,"children":23070},{"style":2287},[23071],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23073,"children":23074},{"style":2287},[23075],{"type":55,"value":23076}," 0",{"type":49,"tag":1060,"props":23078,"children":23080},{"style":23079},"--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F44747;--shiki-default-font-style:italic;--shiki-dark-font-style:italic;--shiki-sepia-font-style:inherit",[23081],{"type":55,"value":23082},"3",{"type":49,"tag":1060,"props":23084,"children":23085},{"style":1073},[23086],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23088,"children":23089},{"style":2287},[23090],{"type":55,"value":23091},"52",{"type":49,"tag":1060,"props":23093,"children":23094},{"style":1073},[23095],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23097,"children":23098},{"style":2287},[23099],{"type":55,"value":23100},"53.792141",{"type":49,"tag":1060,"props":23102,"children":23103},{"style":1073},[23104],{"type":55,"value":23105},": I tensorflow",{"type":49,"tag":1060,"props":23107,"children":23108},{"style":2194},[23109],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23111,"children":23112},{"style":1073},[23113],{"type":55,"value":23114},"core",{"type":49,"tag":1060,"props":23116,"children":23117},{"style":2194},[23118],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23120,"children":23121},{"style":1073},[23122],{"type":55,"value":23123},"platform",{"type":49,"tag":1060,"props":23125,"children":23126},{"style":2194},[23127],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23129,"children":23130},{"style":1073},[23131],{"type":55,"value":23132},"cpu_feature_guard.cc:",{"type":49,"tag":1060,"props":23134,"children":23135},{"style":2287},[23136],{"type":55,"value":23137},"137",{"type":49,"tag":1060,"props":23139,"children":23140},{"style":1073},[23141],{"type":55,"value":23142},"] Your ",{"type":49,"tag":1060,"props":23144,"children":23145},{"style":2287},[23146],{"type":55,"value":23147},"CPU",{"type":49,"tag":1060,"props":23149,"children":23150},{"style":1073},[23151],{"type":55,"value":23152}," supports instructions that this TensorFlow binary was ",{"type":49,"tag":1060,"props":23154,"children":23155},{"style":2194},[23156],{"type":55,"value":23157},"not",{"type":49,"tag":1060,"props":23159,"children":23160},{"style":1073},[23161],{"type":55,"value":23162}," compiled to use: ",{"type":49,"tag":1060,"props":23164,"children":23165},{"style":2287},[23166],{"type":55,"value":23167},"SSE4",{"type":49,"tag":1060,"props":23169,"children":23170},{"style":1073},[23171],{"type":55,"value":23172},".1 ",{"type":49,"tag":1060,"props":23174,"children":23175},{"style":2287},[23176],{"type":55,"value":23167},{"type":49,"tag":1060,"props":23178,"children":23179},{"style":1073},[23180],{"type":55,"value":23181},".2 ",{"type":49,"tag":1060,"props":23183,"children":23184},{"style":2287},[23185],{"type":55,"value":23186},"AVX",{"type":49,"tag":1060,"props":23188,"children":23189},{"style":2287},[23190],{"type":55,"value":23191}," AVX2",{"type":49,"tag":1060,"props":23193,"children":23194},{"style":2287},[23195],{"type":55,"value":23196}," FMA\n",{"type":49,"tag":1060,"props":23198,"children":23199},{"class":1062,"line":1171},[23200,23204,23208,23212,23216,23220,23224,23228,23232,23236,23240,23245,23249,23253,23258,23262,23267,23271,23276,23281,23286,23291,23296,23300,23305,23309,23313,23318,23322,23327,23331],{"type":49,"tag":1060,"props":23201,"children":23202},{"style":2287},[23203],{"type":55,"value":23054},{"type":49,"tag":1060,"props":23205,"children":23206},{"style":2194},[23207],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23209,"children":23210},{"style":2287},[23211],{"type":55,"value":23063},{"type":49,"tag":1060,"props":23213,"children":23214},{"style":2194},[23215],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23217,"children":23218},{"style":2287},[23219],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23221,"children":23222},{"style":2287},[23223],{"type":55,"value":23076},{"type":49,"tag":1060,"props":23225,"children":23226},{"style":23079},[23227],{"type":55,"value":23082},{"type":49,"tag":1060,"props":23229,"children":23230},{"style":1073},[23231],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23233,"children":23234},{"style":2287},[23235],{"type":55,"value":23091},{"type":49,"tag":1060,"props":23237,"children":23238},{"style":1073},[23239],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23241,"children":23242},{"style":2287},[23243],{"type":55,"value":23244},"53.878640",{"type":49,"tag":1060,"props":23246,"children":23247},{"style":1073},[23248],{"type":55,"value":23105},{"type":49,"tag":1060,"props":23250,"children":23251},{"style":2194},[23252],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23254,"children":23255},{"style":1073},[23256],{"type":55,"value":23257},"stream_executor",{"type":49,"tag":1060,"props":23259,"children":23260},{"style":2194},[23261],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23263,"children":23264},{"style":1073},[23265],{"type":55,"value":23266},"cuda",{"type":49,"tag":1060,"props":23268,"children":23269},{"style":2194},[23270],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23272,"children":23273},{"style":1073},[23274],{"type":55,"value":23275},"cuda_gpu_executor.cc:",{"type":49,"tag":1060,"props":23277,"children":23278},{"style":2287},[23279],{"type":55,"value":23280},"892",{"type":49,"tag":1060,"props":23282,"children":23283},{"style":1073},[23284],{"type":55,"value":23285},"] successful ",{"type":49,"tag":1060,"props":23287,"children":23288},{"style":2287},[23289],{"type":55,"value":23290},"NUMA",{"type":49,"tag":1060,"props":23292,"children":23293},{"style":1073},[23294],{"type":55,"value":23295}," node read ",{"type":49,"tag":1060,"props":23297,"children":23298},{"style":2194},[23299],{"type":55,"value":19547},{"type":49,"tag":1060,"props":23301,"children":23302},{"style":1073},[23303],{"type":55,"value":23304}," SysFS had negative value (",{"type":49,"tag":1060,"props":23306,"children":23307},{"style":2194},[23308],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23310,"children":23311},{"style":2287},[23312],{"type":55,"value":8405},{"type":49,"tag":1060,"props":23314,"children":23315},{"style":1073},[23316],{"type":55,"value":23317},"), but there must be at least one ",{"type":49,"tag":1060,"props":23319,"children":23320},{"style":2287},[23321],{"type":55,"value":23290},{"type":49,"tag":1060,"props":23323,"children":23324},{"style":1073},[23325],{"type":55,"value":23326}," node, so returning ",{"type":49,"tag":1060,"props":23328,"children":23329},{"style":2287},[23330],{"type":55,"value":23290},{"type":49,"tag":1060,"props":23332,"children":23333},{"style":1073},[23334],{"type":55,"value":23335}," node zero\n",{"type":49,"tag":1060,"props":23337,"children":23338},{"class":1062,"line":1180},[23339,23343,23347,23351,23355,23359,23363,23367,23371,23375,23379,23384,23388,23392,23396,23400,23405,23409,23414,23418,23423,23428,23433,23437,23442],{"type":49,"tag":1060,"props":23340,"children":23341},{"style":2287},[23342],{"type":55,"value":23054},{"type":49,"tag":1060,"props":23344,"children":23345},{"style":2194},[23346],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23348,"children":23349},{"style":2287},[23350],{"type":55,"value":23063},{"type":49,"tag":1060,"props":23352,"children":23353},{"style":2194},[23354],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23356,"children":23357},{"style":2287},[23358],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23360,"children":23361},{"style":2287},[23362],{"type":55,"value":23076},{"type":49,"tag":1060,"props":23364,"children":23365},{"style":23079},[23366],{"type":55,"value":23082},{"type":49,"tag":1060,"props":23368,"children":23369},{"style":1073},[23370],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23372,"children":23373},{"style":2287},[23374],{"type":55,"value":23091},{"type":49,"tag":1060,"props":23376,"children":23377},{"style":1073},[23378],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23380,"children":23381},{"style":2287},[23382],{"type":55,"value":23383},"53.878892",{"type":49,"tag":1060,"props":23385,"children":23386},{"style":1073},[23387],{"type":55,"value":23105},{"type":49,"tag":1060,"props":23389,"children":23390},{"style":2194},[23391],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23393,"children":23394},{"style":1073},[23395],{"type":55,"value":23114},{"type":49,"tag":1060,"props":23397,"children":23398},{"style":2194},[23399],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23401,"children":23402},{"style":1073},[23403],{"type":55,"value":23404},"common_runtime",{"type":49,"tag":1060,"props":23406,"children":23407},{"style":2194},[23408],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23410,"children":23411},{"style":1073},[23412],{"type":55,"value":23413},"gpu",{"type":49,"tag":1060,"props":23415,"children":23416},{"style":2194},[23417],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23419,"children":23420},{"style":1073},[23421],{"type":55,"value":23422},"gpu_device.cc:",{"type":49,"tag":1060,"props":23424,"children":23425},{"style":2287},[23426],{"type":55,"value":23427},"1030",{"type":49,"tag":1060,"props":23429,"children":23430},{"style":1073},[23431],{"type":55,"value":23432},"] Found device ",{"type":49,"tag":1060,"props":23434,"children":23435},{"style":2287},[23436],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23438,"children":23439},{"style":2194},[23440],{"type":55,"value":23441}," with",{"type":49,"tag":1060,"props":23443,"children":23444},{"style":1073},[23445],{"type":55,"value":23446}," properties:\n",{"type":49,"tag":1060,"props":23448,"children":23449},{"class":1062,"line":1188},[23450,23455,23460,23465,23470,23475,23480,23484,23489],{"type":49,"tag":1060,"props":23451,"children":23452},{"style":1073},[23453],{"type":55,"value":23454},"name: GeForce ",{"type":49,"tag":1060,"props":23456,"children":23457},{"style":2287},[23458],{"type":55,"value":23459},"GTX",{"type":49,"tag":1060,"props":23461,"children":23462},{"style":2287},[23463],{"type":55,"value":23464}," 1080",{"type":49,"tag":1060,"props":23466,"children":23467},{"style":1073},[23468],{"type":55,"value":23469}," major: ",{"type":49,"tag":1060,"props":23471,"children":23472},{"style":2287},[23473],{"type":55,"value":23474},"6",{"type":49,"tag":1060,"props":23476,"children":23477},{"style":1073},[23478],{"type":55,"value":23479}," minor: ",{"type":49,"tag":1060,"props":23481,"children":23482},{"style":2287},[23483],{"type":55,"value":8405},{"type":49,"tag":1060,"props":23485,"children":23486},{"style":1073},[23487],{"type":55,"value":23488}," memoryClockRate(GHz): ",{"type":49,"tag":1060,"props":23490,"children":23491},{"style":2287},[23492],{"type":55,"value":23493},"1.7335\n",{"type":49,"tag":1060,"props":23495,"children":23496},{"class":1062,"line":1201},[23497,23502,23507,23511,23515,23519,23523],{"type":49,"tag":1060,"props":23498,"children":23499},{"style":1073},[23500],{"type":55,"value":23501},"pciBusID: ",{"type":49,"tag":1060,"props":23503,"children":23504},{"style":2287},[23505],{"type":55,"value":23506},"0000",{"type":49,"tag":1060,"props":23508,"children":23509},{"style":1073},[23510],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23512,"children":23513},{"style":2287},[23514],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23516,"children":23517},{"style":23079},[23518],{"type":55,"value":8405},{"type":49,"tag":1060,"props":23520,"children":23521},{"style":1073},[23522],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23524,"children":23525},{"style":2287},[23526],{"type":55,"value":23527},"00.0\n",{"type":49,"tag":1060,"props":23529,"children":23530},{"class":1062,"line":1210},[23531,23536,23541,23546,23551,23555],{"type":49,"tag":1060,"props":23532,"children":23533},{"style":1073},[23534],{"type":55,"value":23535},"totalMemory: ",{"type":49,"tag":1060,"props":23537,"children":23538},{"style":2287},[23539],{"type":55,"value":23540},"7.",{"type":49,"tag":1060,"props":23542,"children":23543},{"style":23079},[23544],{"type":55,"value":23545},"92GiB",{"type":49,"tag":1060,"props":23547,"children":23548},{"style":1073},[23549],{"type":55,"value":23550}," freeMemory: ",{"type":49,"tag":1060,"props":23552,"children":23553},{"style":2287},[23554],{"type":55,"value":23540},{"type":49,"tag":1060,"props":23556,"children":23557},{"style":23079},[23558],{"type":55,"value":23559},"43GiB\n",{"type":49,"tag":1060,"props":23561,"children":23562},{"class":1062,"line":1218},[23563,23567,23571,23575,23579,23583,23587,23591,23595,23599,23603,23608,23612,23616,23620,23624,23628,23632,23636,23640,23644,23649,23654,23658,23663,23668,23672,23676,23680,23684,23689,23693,23698,23702,23706,23711,23715,23719,23723,23727,23731,23735,23739,23744,23749,23754],{"type":49,"tag":1060,"props":23564,"children":23565},{"style":2287},[23566],{"type":55,"value":23054},{"type":49,"tag":1060,"props":23568,"children":23569},{"style":2194},[23570],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23572,"children":23573},{"style":2287},[23574],{"type":55,"value":23063},{"type":49,"tag":1060,"props":23576,"children":23577},{"style":2194},[23578],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23580,"children":23581},{"style":2287},[23582],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23584,"children":23585},{"style":2287},[23586],{"type":55,"value":23076},{"type":49,"tag":1060,"props":23588,"children":23589},{"style":23079},[23590],{"type":55,"value":23082},{"type":49,"tag":1060,"props":23592,"children":23593},{"style":1073},[23594],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23596,"children":23597},{"style":2287},[23598],{"type":55,"value":23091},{"type":49,"tag":1060,"props":23600,"children":23601},{"style":1073},[23602],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23604,"children":23605},{"style":2287},[23606],{"type":55,"value":23607},"53.878904",{"type":49,"tag":1060,"props":23609,"children":23610},{"style":1073},[23611],{"type":55,"value":23105},{"type":49,"tag":1060,"props":23613,"children":23614},{"style":2194},[23615],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23617,"children":23618},{"style":1073},[23619],{"type":55,"value":23114},{"type":49,"tag":1060,"props":23621,"children":23622},{"style":2194},[23623],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23625,"children":23626},{"style":1073},[23627],{"type":55,"value":23404},{"type":49,"tag":1060,"props":23629,"children":23630},{"style":2194},[23631],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23633,"children":23634},{"style":1073},[23635],{"type":55,"value":23413},{"type":49,"tag":1060,"props":23637,"children":23638},{"style":2194},[23639],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23641,"children":23642},{"style":1073},[23643],{"type":55,"value":23422},{"type":49,"tag":1060,"props":23645,"children":23646},{"style":2287},[23647],{"type":55,"value":23648},"1120",{"type":49,"tag":1060,"props":23650,"children":23651},{"style":1073},[23652],{"type":55,"value":23653},"] Creating TensorFlow device (",{"type":49,"tag":1060,"props":23655,"children":23656},{"style":2194},[23657],{"type":55,"value":3744},{"type":49,"tag":1060,"props":23659,"children":23660},{"style":1073},[23661],{"type":55,"value":23662},"device:",{"type":49,"tag":1060,"props":23664,"children":23665},{"style":2287},[23666],{"type":55,"value":23667},"GPU",{"type":49,"tag":1060,"props":23669,"children":23670},{"style":1073},[23671],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23673,"children":23674},{"style":2287},[23675],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23677,"children":23678},{"style":1073},[23679],{"type":55,"value":5173},{"type":49,"tag":1060,"props":23681,"children":23682},{"style":23079},[23683],{"type":55,"value":21350},{"type":49,"tag":1060,"props":23685,"children":23686},{"style":1073},[23687],{"type":55,"value":23688}," (device: ",{"type":49,"tag":1060,"props":23690,"children":23691},{"style":2287},[23692],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23694,"children":23695},{"style":1073},[23696],{"type":55,"value":23697},", name: GeForce ",{"type":49,"tag":1060,"props":23699,"children":23700},{"style":2287},[23701],{"type":55,"value":23459},{"type":49,"tag":1060,"props":23703,"children":23704},{"style":2287},[23705],{"type":55,"value":23464},{"type":49,"tag":1060,"props":23707,"children":23708},{"style":1073},[23709],{"type":55,"value":23710},", pci bus ",{"type":49,"tag":1060,"props":23712,"children":23713},{"style":9965},[23714],{"type":55,"value":14317},{"type":49,"tag":1060,"props":23716,"children":23717},{"style":1073},[23718],{"type":55,"value":78},{"type":49,"tag":1060,"props":23720,"children":23721},{"style":2287},[23722],{"type":55,"value":23506},{"type":49,"tag":1060,"props":23724,"children":23725},{"style":1073},[23726],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23728,"children":23729},{"style":2287},[23730],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23732,"children":23733},{"style":23079},[23734],{"type":55,"value":8405},{"type":49,"tag":1060,"props":23736,"children":23737},{"style":1073},[23738],{"type":55,"value":6694},{"type":49,"tag":1060,"props":23740,"children":23741},{"style":2287},[23742],{"type":55,"value":23743},"00.0",{"type":49,"tag":1060,"props":23745,"children":23746},{"style":1073},[23747],{"type":55,"value":23748},", compute capability: ",{"type":49,"tag":1060,"props":23750,"children":23751},{"style":2287},[23752],{"type":55,"value":23753},"6.1",{"type":49,"tag":1060,"props":23755,"children":23756},{"style":1073},[23757],{"type":55,"value":5126},{"type":49,"tag":1060,"props":23759,"children":23760},{"class":1062,"line":1232},[23761,23766,23770,23774],{"type":49,"tag":1060,"props":23762,"children":23763},{"style":1073},[23764],{"type":55,"value":23765},"Accuracy at step ",{"type":49,"tag":1060,"props":23767,"children":23768},{"style":2287},[23769],{"type":55,"value":8397},{"type":49,"tag":1060,"props":23771,"children":23772},{"style":1073},[23773],{"type":55,"value":78},{"type":49,"tag":1060,"props":23775,"children":23776},{"style":2287},[23777],{"type":55,"value":23778},"0.1235\n",{"type":49,"tag":1060,"props":23780,"children":23781},{"class":1062,"line":1241},[23782,23786,23791,23795],{"type":49,"tag":1060,"props":23783,"children":23784},{"style":1073},[23785],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23787,"children":23788},{"style":2287},[23789],{"type":55,"value":23790},"10",{"type":49,"tag":1060,"props":23792,"children":23793},{"style":1073},[23794],{"type":55,"value":78},{"type":49,"tag":1060,"props":23796,"children":23797},{"style":2287},[23798],{"type":55,"value":23799},"0.7297\n",{"type":49,"tag":1060,"props":23801,"children":23802},{"class":1062,"line":1249},[23803,23807,23811,23815],{"type":49,"tag":1060,"props":23804,"children":23805},{"style":1073},[23806],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23808,"children":23809},{"style":2287},[23810],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23812,"children":23813},{"style":1073},[23814],{"type":55,"value":78},{"type":49,"tag":1060,"props":23816,"children":23817},{"style":2287},[23818],{"type":55,"value":23819},"0.8414\n",{"type":49,"tag":1060,"props":23821,"children":23822},{"class":1062,"line":1262},[23823,23827,23832,23836],{"type":49,"tag":1060,"props":23824,"children":23825},{"style":1073},[23826],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23828,"children":23829},{"style":2287},[23830],{"type":55,"value":23831},"30",{"type":49,"tag":1060,"props":23833,"children":23834},{"style":1073},[23835],{"type":55,"value":78},{"type":49,"tag":1060,"props":23837,"children":23838},{"style":2287},[23839],{"type":55,"value":23840},"0.8717\n",{"type":49,"tag":1060,"props":23842,"children":23843},{"class":1062,"line":4581},[23844,23848,23853,23857],{"type":49,"tag":1060,"props":23845,"children":23846},{"style":1073},[23847],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23849,"children":23850},{"style":2287},[23851],{"type":55,"value":23852},"40",{"type":49,"tag":1060,"props":23854,"children":23855},{"style":1073},[23856],{"type":55,"value":78},{"type":49,"tag":1060,"props":23858,"children":23859},{"style":2287},[23860],{"type":55,"value":23861},"0.886\n",{"type":49,"tag":1060,"props":23863,"children":23864},{"class":1062,"line":4631},[23865,23869,23874,23878],{"type":49,"tag":1060,"props":23866,"children":23867},{"style":1073},[23868],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23870,"children":23871},{"style":2287},[23872],{"type":55,"value":23873},"50",{"type":49,"tag":1060,"props":23875,"children":23876},{"style":1073},[23877],{"type":55,"value":78},{"type":49,"tag":1060,"props":23879,"children":23880},{"style":2287},[23881],{"type":55,"value":23882},"0.896\n",{"type":49,"tag":1060,"props":23884,"children":23885},{"class":1062,"line":4682},[23886,23890,23895,23899],{"type":49,"tag":1060,"props":23887,"children":23888},{"style":1073},[23889],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23891,"children":23892},{"style":2287},[23893],{"type":55,"value":23894},"60",{"type":49,"tag":1060,"props":23896,"children":23897},{"style":1073},[23898],{"type":55,"value":78},{"type":49,"tag":1060,"props":23900,"children":23901},{"style":2287},[23902],{"type":55,"value":23903},"0.9027\n",{"type":49,"tag":1060,"props":23905,"children":23906},{"class":1062,"line":4709},[23907,23911,23916,23920],{"type":49,"tag":1060,"props":23908,"children":23909},{"style":1073},[23910],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23912,"children":23913},{"style":2287},[23914],{"type":55,"value":23915},"70",{"type":49,"tag":1060,"props":23917,"children":23918},{"style":1073},[23919],{"type":55,"value":78},{"type":49,"tag":1060,"props":23921,"children":23922},{"style":2287},[23923],{"type":55,"value":23924},"0.9068\n",{"type":49,"tag":1060,"props":23926,"children":23927},{"class":1062,"line":5979},[23928,23932,23936,23940],{"type":49,"tag":1060,"props":23929,"children":23930},{"style":1073},[23931],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23933,"children":23934},{"style":2287},[23935],{"type":55,"value":2341},{"type":49,"tag":1060,"props":23937,"children":23938},{"style":1073},[23939],{"type":55,"value":78},{"type":49,"tag":1060,"props":23941,"children":23942},{"style":2287},[23943],{"type":55,"value":23944},"0.9101\n",{"type":49,"tag":1060,"props":23946,"children":23947},{"class":1062,"line":5988},[23948,23952,23957,23961],{"type":49,"tag":1060,"props":23949,"children":23950},{"style":1073},[23951],{"type":55,"value":23765},{"type":49,"tag":1060,"props":23953,"children":23954},{"style":2287},[23955],{"type":55,"value":23956},"90",{"type":49,"tag":1060,"props":23958,"children":23959},{"style":1073},[23960],{"type":55,"value":78},{"type":49,"tag":1060,"props":23962,"children":23963},{"style":2287},[23964],{"type":55,"value":23965},"0.9121\n",{"type":49,"tag":1060,"props":23967,"children":23968},{"class":1062,"line":5997},[23969,23973,23977,23981,23985,23989,23993,23997,24001,24005,24009,24014,24018,24022,24026,24030,24035,24040,24045,24050],{"type":49,"tag":1060,"props":23970,"children":23971},{"style":2287},[23972],{"type":55,"value":23054},{"type":49,"tag":1060,"props":23974,"children":23975},{"style":2194},[23976],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23978,"children":23979},{"style":2287},[23980],{"type":55,"value":23063},{"type":49,"tag":1060,"props":23982,"children":23983},{"style":2194},[23984],{"type":55,"value":10180},{"type":49,"tag":1060,"props":23986,"children":23987},{"style":2287},[23988],{"type":55,"value":22445},{"type":49,"tag":1060,"props":23990,"children":23991},{"style":2287},[23992],{"type":55,"value":23076},{"type":49,"tag":1060,"props":23994,"children":23995},{"style":23079},[23996],{"type":55,"value":23082},{"type":49,"tag":1060,"props":23998,"children":23999},{"style":1073},[24000],{"type":55,"value":6694},{"type":49,"tag":1060,"props":24002,"children":24003},{"style":2287},[24004],{"type":55,"value":23091},{"type":49,"tag":1060,"props":24006,"children":24007},{"style":1073},[24008],{"type":55,"value":6694},{"type":49,"tag":1060,"props":24010,"children":24011},{"style":2287},[24012],{"type":55,"value":24013},"57.583676",{"type":49,"tag":1060,"props":24015,"children":24016},{"style":1073},[24017],{"type":55,"value":23105},{"type":49,"tag":1060,"props":24019,"children":24020},{"style":2194},[24021],{"type":55,"value":3744},{"type":49,"tag":1060,"props":24023,"children":24024},{"style":1073},[24025],{"type":55,"value":23257},{"type":49,"tag":1060,"props":24027,"children":24028},{"style":2194},[24029],{"type":55,"value":3744},{"type":49,"tag":1060,"props":24031,"children":24032},{"style":1073},[24033],{"type":55,"value":24034},"dso_loader.cc:",{"type":49,"tag":1060,"props":24036,"children":24037},{"style":2287},[24038],{"type":55,"value":24039},"139",{"type":49,"tag":1060,"props":24041,"children":24042},{"style":1073},[24043],{"type":55,"value":24044},"] successfully opened ",{"type":49,"tag":1060,"props":24046,"children":24047},{"style":2287},[24048],{"type":55,"value":24049},"CUDA",{"type":49,"tag":1060,"props":24051,"children":24052},{"style":1073},[24053],{"type":55,"value":24054}," library libcupti.so.8.0 locally\n",{"type":49,"tag":1060,"props":24056,"children":24057},{"class":1062,"line":6006},[24058,24063,24067],{"type":49,"tag":1060,"props":24059,"children":24060},{"style":1073},[24061],{"type":55,"value":24062},"Adding run metadata ",{"type":49,"tag":1060,"props":24064,"children":24065},{"style":2194},[24066],{"type":55,"value":10063},{"type":49,"tag":1060,"props":24068,"children":24069},{"style":2287},[24070],{"type":55,"value":24071}," 99\n",{"type":49,"tag":1060,"props":24073,"children":24074},{"class":1062,"line":10142},[24075,24079,24084,24088],{"type":49,"tag":1060,"props":24076,"children":24077},{"style":1073},[24078],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24080,"children":24081},{"style":2287},[24082],{"type":55,"value":24083},"100",{"type":49,"tag":1060,"props":24085,"children":24086},{"style":1073},[24087],{"type":55,"value":78},{"type":49,"tag":1060,"props":24089,"children":24090},{"style":2287},[24091],{"type":55,"value":24092},"0.9124\n",{"type":49,"tag":1060,"props":24094,"children":24095},{"class":1062,"line":10151},[24096,24100,24105,24109],{"type":49,"tag":1060,"props":24097,"children":24098},{"style":1073},[24099],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24101,"children":24102},{"style":2287},[24103],{"type":55,"value":24104},"110",{"type":49,"tag":1060,"props":24106,"children":24107},{"style":1073},[24108],{"type":55,"value":78},{"type":49,"tag":1060,"props":24110,"children":24111},{"style":2287},[24112],{"type":55,"value":24113},"0.9164\n",{"type":49,"tag":1060,"props":24115,"children":24116},{"class":1062,"line":10160},[24117,24121,24126,24130],{"type":49,"tag":1060,"props":24118,"children":24119},{"style":1073},[24120],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24122,"children":24123},{"style":2287},[24124],{"type":55,"value":24125},"120",{"type":49,"tag":1060,"props":24127,"children":24128},{"style":1073},[24129],{"type":55,"value":78},{"type":49,"tag":1060,"props":24131,"children":24132},{"style":2287},[24133],{"type":55,"value":24134},"0.9198\n",{"type":49,"tag":1060,"props":24136,"children":24137},{"class":1062,"line":10188},[24138,24142,24147,24151],{"type":49,"tag":1060,"props":24139,"children":24140},{"style":1073},[24141],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24143,"children":24144},{"style":2287},[24145],{"type":55,"value":24146},"130",{"type":49,"tag":1060,"props":24148,"children":24149},{"style":1073},[24150],{"type":55,"value":78},{"type":49,"tag":1060,"props":24152,"children":24153},{"style":2287},[24154],{"type":55,"value":24155},"0.9205\n",{"type":49,"tag":1060,"props":24157,"children":24158},{"class":1062,"line":10196},[24159,24163,24168,24172],{"type":49,"tag":1060,"props":24160,"children":24161},{"style":1073},[24162],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24164,"children":24165},{"style":2287},[24166],{"type":55,"value":24167},"140",{"type":49,"tag":1060,"props":24169,"children":24170},{"style":1073},[24171],{"type":55,"value":78},{"type":49,"tag":1060,"props":24173,"children":24174},{"style":2287},[24175],{"type":55,"value":24176},"0.9142\n",{"type":49,"tag":1060,"props":24178,"children":24179},{"class":1062,"line":10205},[24180,24184,24189,24193],{"type":49,"tag":1060,"props":24181,"children":24182},{"style":1073},[24183],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24185,"children":24186},{"style":2287},[24187],{"type":55,"value":24188},"150",{"type":49,"tag":1060,"props":24190,"children":24191},{"style":1073},[24192],{"type":55,"value":78},{"type":49,"tag":1060,"props":24194,"children":24195},{"style":2287},[24196],{"type":55,"value":24197},"0.9224\n",{"type":49,"tag":1060,"props":24199,"children":24200},{"class":1062,"line":10242},[24201,24205,24210,24214],{"type":49,"tag":1060,"props":24202,"children":24203},{"style":1073},[24204],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24206,"children":24207},{"style":2287},[24208],{"type":55,"value":24209},"160",{"type":49,"tag":1060,"props":24211,"children":24212},{"style":1073},[24213],{"type":55,"value":78},{"type":49,"tag":1060,"props":24215,"children":24216},{"style":2287},[24217],{"type":55,"value":24218},"0.9294\n",{"type":49,"tag":1060,"props":24220,"children":24221},{"class":1062,"line":10261},[24222,24226,24231,24235],{"type":49,"tag":1060,"props":24223,"children":24224},{"style":1073},[24225],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24227,"children":24228},{"style":2287},[24229],{"type":55,"value":24230},"170",{"type":49,"tag":1060,"props":24232,"children":24233},{"style":1073},[24234],{"type":55,"value":78},{"type":49,"tag":1060,"props":24236,"children":24237},{"style":2287},[24238],{"type":55,"value":24239},"0.928\n",{"type":49,"tag":1060,"props":24241,"children":24242},{"class":1062,"line":10270},[24243,24247,24252,24256],{"type":49,"tag":1060,"props":24244,"children":24245},{"style":1073},[24246],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24248,"children":24249},{"style":2287},[24250],{"type":55,"value":24251},"180",{"type":49,"tag":1060,"props":24253,"children":24254},{"style":1073},[24255],{"type":55,"value":78},{"type":49,"tag":1060,"props":24257,"children":24258},{"style":2287},[24259],{"type":55,"value":24260},"0.9312\n",{"type":49,"tag":1060,"props":24262,"children":24263},{"class":1062,"line":10278},[24264,24268,24273,24277],{"type":49,"tag":1060,"props":24265,"children":24266},{"style":1073},[24267],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24269,"children":24270},{"style":2287},[24271],{"type":55,"value":24272},"190",{"type":49,"tag":1060,"props":24274,"children":24275},{"style":1073},[24276],{"type":55,"value":78},{"type":49,"tag":1060,"props":24278,"children":24279},{"style":2287},[24280],{"type":55,"value":24281},"0.9301\n",{"type":49,"tag":1060,"props":24283,"children":24284},{"class":1062,"line":10287},[24285,24289,24293],{"type":49,"tag":1060,"props":24286,"children":24287},{"style":1073},[24288],{"type":55,"value":24062},{"type":49,"tag":1060,"props":24290,"children":24291},{"style":2194},[24292],{"type":55,"value":10063},{"type":49,"tag":1060,"props":24294,"children":24295},{"style":2287},[24296],{"type":55,"value":24297}," 199\n",{"type":49,"tag":1060,"props":24299,"children":24300},{"class":1062,"line":10319},[24301,24305,24310,24314],{"type":49,"tag":1060,"props":24302,"children":24303},{"style":1073},[24304],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24306,"children":24307},{"style":2287},[24308],{"type":55,"value":24309},"200",{"type":49,"tag":1060,"props":24311,"children":24312},{"style":1073},[24313],{"type":55,"value":78},{"type":49,"tag":1060,"props":24315,"children":24316},{"style":2287},[24317],{"type":55,"value":24318},"0.9346\n",{"type":49,"tag":1060,"props":24320,"children":24321},{"class":1062,"line":10332},[24322,24326,24331,24335],{"type":49,"tag":1060,"props":24323,"children":24324},{"style":1073},[24325],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24327,"children":24328},{"style":2287},[24329],{"type":55,"value":24330},"210",{"type":49,"tag":1060,"props":24332,"children":24333},{"style":1073},[24334],{"type":55,"value":78},{"type":49,"tag":1060,"props":24336,"children":24337},{"style":2287},[24338],{"type":55,"value":24339},"0.9381\n",{"type":49,"tag":1060,"props":24341,"children":24342},{"class":1062,"line":10356},[24343,24347,24352,24356],{"type":49,"tag":1060,"props":24344,"children":24345},{"style":1073},[24346],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24348,"children":24349},{"style":2287},[24350],{"type":55,"value":24351},"220",{"type":49,"tag":1060,"props":24353,"children":24354},{"style":1073},[24355],{"type":55,"value":78},{"type":49,"tag":1060,"props":24357,"children":24358},{"style":2287},[24359],{"type":55,"value":24360},"0.9396\n",{"type":49,"tag":1060,"props":24362,"children":24363},{"class":1062,"line":10364},[24364,24368,24373,24377],{"type":49,"tag":1060,"props":24365,"children":24366},{"style":1073},[24367],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24369,"children":24370},{"style":2287},[24371],{"type":55,"value":24372},"230",{"type":49,"tag":1060,"props":24374,"children":24375},{"style":1073},[24376],{"type":55,"value":78},{"type":49,"tag":1060,"props":24378,"children":24379},{"style":2287},[24380],{"type":55,"value":24381},"0.9406\n",{"type":49,"tag":1060,"props":24383,"children":24384},{"class":1062,"line":10373},[24385,24389,24394,24398],{"type":49,"tag":1060,"props":24386,"children":24387},{"style":1073},[24388],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24390,"children":24391},{"style":2287},[24392],{"type":55,"value":24393},"240",{"type":49,"tag":1060,"props":24395,"children":24396},{"style":1073},[24397],{"type":55,"value":78},{"type":49,"tag":1060,"props":24399,"children":24400},{"style":2287},[24401],{"type":55,"value":24402},"0.9273\n",{"type":49,"tag":1060,"props":24404,"children":24405},{"class":1062,"line":10395},[24406,24410,24415,24419],{"type":49,"tag":1060,"props":24407,"children":24408},{"style":1073},[24409],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24411,"children":24412},{"style":2287},[24413],{"type":55,"value":24414},"250",{"type":49,"tag":1060,"props":24416,"children":24417},{"style":1073},[24418],{"type":55,"value":78},{"type":49,"tag":1060,"props":24420,"children":24421},{"style":2287},[24422],{"type":55,"value":24423},"0.941\n",{"type":49,"tag":1060,"props":24425,"children":24426},{"class":1062,"line":10403},[24427,24431,24436,24440],{"type":49,"tag":1060,"props":24428,"children":24429},{"style":1073},[24430],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24432,"children":24433},{"style":2287},[24434],{"type":55,"value":24435},"260",{"type":49,"tag":1060,"props":24437,"children":24438},{"style":1073},[24439],{"type":55,"value":78},{"type":49,"tag":1060,"props":24441,"children":24442},{"style":2287},[24443],{"type":55,"value":24444},"0.9369\n",{"type":49,"tag":1060,"props":24446,"children":24447},{"class":1062,"line":10412},[24448,24452,24457,24461],{"type":49,"tag":1060,"props":24449,"children":24450},{"style":1073},[24451],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24453,"children":24454},{"style":2287},[24455],{"type":55,"value":24456},"270",{"type":49,"tag":1060,"props":24458,"children":24459},{"style":1073},[24460],{"type":55,"value":78},{"type":49,"tag":1060,"props":24462,"children":24463},{"style":2287},[24464],{"type":55,"value":24465},"0.9329\n",{"type":49,"tag":1060,"props":24467,"children":24468},{"class":1062,"line":10438},[24469,24473,24478,24482],{"type":49,"tag":1060,"props":24470,"children":24471},{"style":1073},[24472],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24474,"children":24475},{"style":2287},[24476],{"type":55,"value":24477},"280",{"type":49,"tag":1060,"props":24479,"children":24480},{"style":1073},[24481],{"type":55,"value":78},{"type":49,"tag":1060,"props":24483,"children":24484},{"style":2287},[24485],{"type":55,"value":24486},"0.9404\n",{"type":49,"tag":1060,"props":24488,"children":24489},{"class":1062,"line":10455},[24490,24494,24499,24503],{"type":49,"tag":1060,"props":24491,"children":24492},{"style":1073},[24493],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24495,"children":24496},{"style":2287},[24497],{"type":55,"value":24498},"290",{"type":49,"tag":1060,"props":24500,"children":24501},{"style":1073},[24502],{"type":55,"value":78},{"type":49,"tag":1060,"props":24504,"children":24505},{"style":2287},[24506],{"type":55,"value":24507},"0.9444\n",{"type":49,"tag":1060,"props":24509,"children":24510},{"class":1062,"line":10492},[24511,24515,24519],{"type":49,"tag":1060,"props":24512,"children":24513},{"style":1073},[24514],{"type":55,"value":24062},{"type":49,"tag":1060,"props":24516,"children":24517},{"style":2194},[24518],{"type":55,"value":10063},{"type":49,"tag":1060,"props":24520,"children":24521},{"style":2287},[24522],{"type":55,"value":24523}," 299\n",{"type":49,"tag":1060,"props":24525,"children":24526},{"class":1062,"line":10513},[24527,24531,24536,24540],{"type":49,"tag":1060,"props":24528,"children":24529},{"style":1073},[24530],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24532,"children":24533},{"style":2287},[24534],{"type":55,"value":24535},"300",{"type":49,"tag":1060,"props":24537,"children":24538},{"style":1073},[24539],{"type":55,"value":78},{"type":49,"tag":1060,"props":24541,"children":24542},{"style":2287},[24543],{"type":55,"value":24544},"0.9438\n",{"type":49,"tag":1060,"props":24546,"children":24547},{"class":1062,"line":10521},[24548,24552,24557,24561],{"type":49,"tag":1060,"props":24549,"children":24550},{"style":1073},[24551],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24553,"children":24554},{"style":2287},[24555],{"type":55,"value":24556},"310",{"type":49,"tag":1060,"props":24558,"children":24559},{"style":1073},[24560],{"type":55,"value":78},{"type":49,"tag":1060,"props":24562,"children":24563},{"style":2287},[24564],{"type":55,"value":24565},"0.9426\n",{"type":49,"tag":1060,"props":24567,"children":24568},{"class":1062,"line":10530},[24569,24573,24578,24582],{"type":49,"tag":1060,"props":24570,"children":24571},{"style":1073},[24572],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24574,"children":24575},{"style":2287},[24576],{"type":55,"value":24577},"320",{"type":49,"tag":1060,"props":24579,"children":24580},{"style":1073},[24581],{"type":55,"value":78},{"type":49,"tag":1060,"props":24583,"children":24584},{"style":2287},[24585],{"type":55,"value":24586},"0.9462\n",{"type":49,"tag":1060,"props":24588,"children":24589},{"class":1062,"line":10539},[24590,24594,24599,24603],{"type":49,"tag":1060,"props":24591,"children":24592},{"style":1073},[24593],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24595,"children":24596},{"style":2287},[24597],{"type":55,"value":24598},"330",{"type":49,"tag":1060,"props":24600,"children":24601},{"style":1073},[24602],{"type":55,"value":78},{"type":49,"tag":1060,"props":24604,"children":24605},{"style":2287},[24606],{"type":55,"value":24607},"0.9449\n",{"type":49,"tag":1060,"props":24609,"children":24610},{"class":1062,"line":10561},[24611,24615,24620,24624],{"type":49,"tag":1060,"props":24612,"children":24613},{"style":1073},[24614],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24616,"children":24617},{"style":2287},[24618],{"type":55,"value":24619},"340",{"type":49,"tag":1060,"props":24621,"children":24622},{"style":1073},[24623],{"type":55,"value":78},{"type":49,"tag":1060,"props":24625,"children":24626},{"style":2287},[24627],{"type":55,"value":24628},"0.9478\n",{"type":49,"tag":1060,"props":24630,"children":24631},{"class":1062,"line":10569},[24632,24636,24641,24645],{"type":49,"tag":1060,"props":24633,"children":24634},{"style":1073},[24635],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24637,"children":24638},{"style":2287},[24639],{"type":55,"value":24640},"350",{"type":49,"tag":1060,"props":24642,"children":24643},{"style":1073},[24644],{"type":55,"value":78},{"type":49,"tag":1060,"props":24646,"children":24647},{"style":2287},[24648],{"type":55,"value":24649},"0.9458\n",{"type":49,"tag":1060,"props":24651,"children":24652},{"class":1062,"line":10611},[24653,24657,24662,24666],{"type":49,"tag":1060,"props":24654,"children":24655},{"style":1073},[24656],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24658,"children":24659},{"style":2287},[24660],{"type":55,"value":24661},"360",{"type":49,"tag":1060,"props":24663,"children":24664},{"style":1073},[24665],{"type":55,"value":78},{"type":49,"tag":1060,"props":24667,"children":24668},{"style":2287},[24669],{"type":55,"value":24670},"0.9464\n",{"type":49,"tag":1060,"props":24672,"children":24673},{"class":1062,"line":10624},[24674,24678,24683,24687],{"type":49,"tag":1060,"props":24675,"children":24676},{"style":1073},[24677],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24679,"children":24680},{"style":2287},[24681],{"type":55,"value":24682},"370",{"type":49,"tag":1060,"props":24684,"children":24685},{"style":1073},[24686],{"type":55,"value":78},{"type":49,"tag":1060,"props":24688,"children":24689},{"style":2287},[24690],{"type":55,"value":24691},"0.9474\n",{"type":49,"tag":1060,"props":24693,"children":24694},{"class":1062,"line":10632},[24695,24699,24704,24708],{"type":49,"tag":1060,"props":24696,"children":24697},{"style":1073},[24698],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24700,"children":24701},{"style":2287},[24702],{"type":55,"value":24703},"380",{"type":49,"tag":1060,"props":24705,"children":24706},{"style":1073},[24707],{"type":55,"value":78},{"type":49,"tag":1060,"props":24709,"children":24710},{"style":2287},[24711],{"type":55,"value":24712},"0.9528\n",{"type":49,"tag":1060,"props":24714,"children":24715},{"class":1062,"line":10640},[24716,24720,24725,24729],{"type":49,"tag":1060,"props":24717,"children":24718},{"style":1073},[24719],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24721,"children":24722},{"style":2287},[24723],{"type":55,"value":24724},"390",{"type":49,"tag":1060,"props":24726,"children":24727},{"style":1073},[24728],{"type":55,"value":78},{"type":49,"tag":1060,"props":24730,"children":24731},{"style":2287},[24732],{"type":55,"value":24733},"0.9499\n",{"type":49,"tag":1060,"props":24735,"children":24736},{"class":1062,"line":10681},[24737,24741,24745],{"type":49,"tag":1060,"props":24738,"children":24739},{"style":1073},[24740],{"type":55,"value":24062},{"type":49,"tag":1060,"props":24742,"children":24743},{"style":2194},[24744],{"type":55,"value":10063},{"type":49,"tag":1060,"props":24746,"children":24747},{"style":2287},[24748],{"type":55,"value":24749}," 399\n",{"type":49,"tag":1060,"props":24751,"children":24752},{"class":1062,"line":10694},[24753,24757,24762,24766],{"type":49,"tag":1060,"props":24754,"children":24755},{"style":1073},[24756],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24758,"children":24759},{"style":2287},[24760],{"type":55,"value":24761},"400",{"type":49,"tag":1060,"props":24763,"children":24764},{"style":1073},[24765],{"type":55,"value":78},{"type":49,"tag":1060,"props":24767,"children":24768},{"style":2287},[24769],{"type":55,"value":24770},"0.9507\n",{"type":49,"tag":1060,"props":24772,"children":24773},{"class":1062,"line":10702},[24774,24778,24783,24787],{"type":49,"tag":1060,"props":24775,"children":24776},{"style":1073},[24777],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24779,"children":24780},{"style":2287},[24781],{"type":55,"value":24782},"410",{"type":49,"tag":1060,"props":24784,"children":24785},{"style":1073},[24786],{"type":55,"value":78},{"type":49,"tag":1060,"props":24788,"children":24789},{"style":2287},[24790],{"type":55,"value":24791},"0.9501\n",{"type":49,"tag":1060,"props":24793,"children":24794},{"class":1062,"line":10710},[24795,24799,24804,24808],{"type":49,"tag":1060,"props":24796,"children":24797},{"style":1073},[24798],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24800,"children":24801},{"style":2287},[24802],{"type":55,"value":24803},"420",{"type":49,"tag":1060,"props":24805,"children":24806},{"style":1073},[24807],{"type":55,"value":78},{"type":49,"tag":1060,"props":24809,"children":24810},{"style":2287},[24811],{"type":55,"value":24812},"0.9513\n",{"type":49,"tag":1060,"props":24814,"children":24815},{"class":1062,"line":10751},[24816,24820,24825,24829],{"type":49,"tag":1060,"props":24817,"children":24818},{"style":1073},[24819],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24821,"children":24822},{"style":2287},[24823],{"type":55,"value":24824},"430",{"type":49,"tag":1060,"props":24826,"children":24827},{"style":1073},[24828],{"type":55,"value":78},{"type":49,"tag":1060,"props":24830,"children":24831},{"style":2287},[24832],{"type":55,"value":24833},"0.9483\n",{"type":49,"tag":1060,"props":24835,"children":24836},{"class":1062,"line":10764},[24837,24841,24846,24850],{"type":49,"tag":1060,"props":24838,"children":24839},{"style":1073},[24840],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24842,"children":24843},{"style":2287},[24844],{"type":55,"value":24845},"440",{"type":49,"tag":1060,"props":24847,"children":24848},{"style":1073},[24849],{"type":55,"value":78},{"type":49,"tag":1060,"props":24851,"children":24852},{"style":2287},[24853],{"type":55,"value":24854},"0.9518\n",{"type":49,"tag":1060,"props":24856,"children":24857},{"class":1062,"line":10772},[24858,24862,24867,24871],{"type":49,"tag":1060,"props":24859,"children":24860},{"style":1073},[24861],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24863,"children":24864},{"style":2287},[24865],{"type":55,"value":24866},"450",{"type":49,"tag":1060,"props":24868,"children":24869},{"style":1073},[24870],{"type":55,"value":78},{"type":49,"tag":1060,"props":24872,"children":24873},{"style":2287},[24874],{"type":55,"value":24875},"0.949\n",{"type":49,"tag":1060,"props":24877,"children":24878},{"class":1062,"line":10780},[24879,24883,24888,24892],{"type":49,"tag":1060,"props":24880,"children":24881},{"style":1073},[24882],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24884,"children":24885},{"style":2287},[24886],{"type":55,"value":24887},"460",{"type":49,"tag":1060,"props":24889,"children":24890},{"style":1073},[24891],{"type":55,"value":78},{"type":49,"tag":1060,"props":24893,"children":24894},{"style":2287},[24895],{"type":55,"value":24896},"0.9543\n",{"type":49,"tag":1060,"props":24898,"children":24899},{"class":1062,"line":10821},[24900,24904,24909,24913],{"type":49,"tag":1060,"props":24901,"children":24902},{"style":1073},[24903],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24905,"children":24906},{"style":2287},[24907],{"type":55,"value":24908},"470",{"type":49,"tag":1060,"props":24910,"children":24911},{"style":1073},[24912],{"type":55,"value":78},{"type":49,"tag":1060,"props":24914,"children":24915},{"style":2287},[24916],{"type":55,"value":24917},"0.9552\n",{"type":49,"tag":1060,"props":24919,"children":24920},{"class":1062,"line":10834},[24921,24925,24930,24934],{"type":49,"tag":1060,"props":24922,"children":24923},{"style":1073},[24924],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24926,"children":24927},{"style":2287},[24928],{"type":55,"value":24929},"480",{"type":49,"tag":1060,"props":24931,"children":24932},{"style":1073},[24933],{"type":55,"value":78},{"type":49,"tag":1060,"props":24935,"children":24936},{"style":2287},[24937],{"type":55,"value":24938},"0.9515\n",{"type":49,"tag":1060,"props":24940,"children":24941},{"class":1062,"line":10842},[24942,24946,24951,24955],{"type":49,"tag":1060,"props":24943,"children":24944},{"style":1073},[24945],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24947,"children":24948},{"style":2287},[24949],{"type":55,"value":24950},"490",{"type":49,"tag":1060,"props":24952,"children":24953},{"style":1073},[24954],{"type":55,"value":78},{"type":49,"tag":1060,"props":24956,"children":24957},{"style":2287},[24958],{"type":55,"value":24959},"0.9544\n",{"type":49,"tag":1060,"props":24961,"children":24962},{"class":1062,"line":10850},[24963,24967,24971],{"type":49,"tag":1060,"props":24964,"children":24965},{"style":1073},[24966],{"type":55,"value":24062},{"type":49,"tag":1060,"props":24968,"children":24969},{"style":2194},[24970],{"type":55,"value":10063},{"type":49,"tag":1060,"props":24972,"children":24973},{"style":2287},[24974],{"type":55,"value":24975}," 499\n",{"type":49,"tag":1060,"props":24977,"children":24978},{"class":1062,"line":10859},[24979,24983,24988,24992],{"type":49,"tag":1060,"props":24980,"children":24981},{"style":1073},[24982],{"type":55,"value":23765},{"type":49,"tag":1060,"props":24984,"children":24985},{"style":2287},[24986],{"type":55,"value":24987},"500",{"type":49,"tag":1060,"props":24989,"children":24990},{"style":1073},[24991],{"type":55,"value":78},{"type":49,"tag":1060,"props":24993,"children":24994},{"style":2287},[24995],{"type":55,"value":24996},"0.9586\n",{"type":49,"tag":1060,"props":24998,"children":24999},{"class":1062,"line":10879},[25000,25004,25009,25013],{"type":49,"tag":1060,"props":25001,"children":25002},{"style":1073},[25003],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25005,"children":25006},{"style":2287},[25007],{"type":55,"value":25008},"510",{"type":49,"tag":1060,"props":25010,"children":25011},{"style":1073},[25012],{"type":55,"value":78},{"type":49,"tag":1060,"props":25014,"children":25015},{"style":2287},[25016],{"type":55,"value":25017},"0.9567\n",{"type":49,"tag":1060,"props":25019,"children":25020},{"class":1062,"line":10887},[25021,25025,25030,25034],{"type":49,"tag":1060,"props":25022,"children":25023},{"style":1073},[25024],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25026,"children":25027},{"style":2287},[25028],{"type":55,"value":25029},"520",{"type":49,"tag":1060,"props":25031,"children":25032},{"style":1073},[25033],{"type":55,"value":78},{"type":49,"tag":1060,"props":25035,"children":25036},{"style":2287},[25037],{"type":55,"value":25038},"0.9572\n",{"type":49,"tag":1060,"props":25040,"children":25041},{"class":1062,"line":10896},[25042,25046,25051,25055],{"type":49,"tag":1060,"props":25043,"children":25044},{"style":1073},[25045],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25047,"children":25048},{"style":2287},[25049],{"type":55,"value":25050},"530",{"type":49,"tag":1060,"props":25052,"children":25053},{"style":1073},[25054],{"type":55,"value":78},{"type":49,"tag":1060,"props":25056,"children":25057},{"style":2287},[25058],{"type":55,"value":25059},"0.9574\n",{"type":49,"tag":1060,"props":25061,"children":25062},{"class":1062,"line":10905},[25063,25067,25072,25076],{"type":49,"tag":1060,"props":25064,"children":25065},{"style":1073},[25066],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25068,"children":25069},{"style":2287},[25070],{"type":55,"value":25071},"540",{"type":49,"tag":1060,"props":25073,"children":25074},{"style":1073},[25075],{"type":55,"value":78},{"type":49,"tag":1060,"props":25077,"children":25078},{"style":2287},[25079],{"type":55,"value":25080},"0.9584\n",{"type":49,"tag":1060,"props":25082,"children":25083},{"class":1062,"line":10926},[25084,25088,25093,25097],{"type":49,"tag":1060,"props":25085,"children":25086},{"style":1073},[25087],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25089,"children":25090},{"style":2287},[25091],{"type":55,"value":25092},"550",{"type":49,"tag":1060,"props":25094,"children":25095},{"style":1073},[25096],{"type":55,"value":78},{"type":49,"tag":1060,"props":25098,"children":25099},{"style":2287},[25100],{"type":55,"value":25101},"0.9593\n",{"type":49,"tag":1060,"props":25103,"children":25104},{"class":1062,"line":10934},[25105,25109,25114,25118],{"type":49,"tag":1060,"props":25106,"children":25107},{"style":1073},[25108],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25110,"children":25111},{"style":2287},[25112],{"type":55,"value":25113},"560",{"type":49,"tag":1060,"props":25115,"children":25116},{"style":1073},[25117],{"type":55,"value":78},{"type":49,"tag":1060,"props":25119,"children":25120},{"style":2287},[25121],{"type":55,"value":25122},"0.958\n",{"type":49,"tag":1060,"props":25124,"children":25125},{"class":1062,"line":10956},[25126,25130,25135,25139],{"type":49,"tag":1060,"props":25127,"children":25128},{"style":1073},[25129],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25131,"children":25132},{"style":2287},[25133],{"type":55,"value":25134},"570",{"type":49,"tag":1060,"props":25136,"children":25137},{"style":1073},[25138],{"type":55,"value":78},{"type":49,"tag":1060,"props":25140,"children":25141},{"style":2287},[25142],{"type":55,"value":25143},"0.9575\n",{"type":49,"tag":1060,"props":25145,"children":25146},{"class":1062,"line":10973},[25147,25151,25156,25160],{"type":49,"tag":1060,"props":25148,"children":25149},{"style":1073},[25150],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25152,"children":25153},{"style":2287},[25154],{"type":55,"value":25155},"580",{"type":49,"tag":1060,"props":25157,"children":25158},{"style":1073},[25159],{"type":55,"value":78},{"type":49,"tag":1060,"props":25161,"children":25162},{"style":2287},[25163],{"type":55,"value":25164},"0.9582\n",{"type":49,"tag":1060,"props":25166,"children":25167},{"class":1062,"line":11000},[25168,25172,25177,25181],{"type":49,"tag":1060,"props":25169,"children":25170},{"style":1073},[25171],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25173,"children":25174},{"style":2287},[25175],{"type":55,"value":25176},"590",{"type":49,"tag":1060,"props":25178,"children":25179},{"style":1073},[25180],{"type":55,"value":78},{"type":49,"tag":1060,"props":25182,"children":25183},{"style":2287},[25184],{"type":55,"value":25185},"0.9609\n",{"type":49,"tag":1060,"props":25187,"children":25188},{"class":1062,"line":11018},[25189,25193,25197],{"type":49,"tag":1060,"props":25190,"children":25191},{"style":1073},[25192],{"type":55,"value":24062},{"type":49,"tag":1060,"props":25194,"children":25195},{"style":2194},[25196],{"type":55,"value":10063},{"type":49,"tag":1060,"props":25198,"children":25199},{"style":2287},[25200],{"type":55,"value":25201}," 599\n",{"type":49,"tag":1060,"props":25203,"children":25204},{"class":1062,"line":11036},[25205,25209,25214,25218],{"type":49,"tag":1060,"props":25206,"children":25207},{"style":1073},[25208],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25210,"children":25211},{"style":2287},[25212],{"type":55,"value":25213},"600",{"type":49,"tag":1060,"props":25215,"children":25216},{"style":1073},[25217],{"type":55,"value":78},{"type":49,"tag":1060,"props":25219,"children":25220},{"style":2287},[25221],{"type":55,"value":25222},"0.9618\n",{"type":49,"tag":1060,"props":25224,"children":25225},{"class":1062,"line":11054},[25226,25230,25235,25239],{"type":49,"tag":1060,"props":25227,"children":25228},{"style":1073},[25229],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25231,"children":25232},{"style":2287},[25233],{"type":55,"value":25234},"610",{"type":49,"tag":1060,"props":25236,"children":25237},{"style":1073},[25238],{"type":55,"value":78},{"type":49,"tag":1060,"props":25240,"children":25241},{"style":2287},[25242],{"type":55,"value":25243},"0.9605\n",{"type":49,"tag":1060,"props":25245,"children":25246},{"class":1062,"line":11072},[25247,25251,25256,25260],{"type":49,"tag":1060,"props":25248,"children":25249},{"style":1073},[25250],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25252,"children":25253},{"style":2287},[25254],{"type":55,"value":25255},"620",{"type":49,"tag":1060,"props":25257,"children":25258},{"style":1073},[25259],{"type":55,"value":78},{"type":49,"tag":1060,"props":25261,"children":25262},{"style":2287},[25263],{"type":55,"value":25264},"0.9606\n",{"type":49,"tag":1060,"props":25266,"children":25267},{"class":1062,"line":11090},[25268,25272,25277,25281],{"type":49,"tag":1060,"props":25269,"children":25270},{"style":1073},[25271],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25273,"children":25274},{"style":2287},[25275],{"type":55,"value":25276},"630",{"type":49,"tag":1060,"props":25278,"children":25279},{"style":1073},[25280],{"type":55,"value":78},{"type":49,"tag":1060,"props":25282,"children":25283},{"style":2287},[25284],{"type":55,"value":25285},"0.961\n",{"type":49,"tag":1060,"props":25287,"children":25288},{"class":1062,"line":11104},[25289,25293,25298,25302],{"type":49,"tag":1060,"props":25290,"children":25291},{"style":1073},[25292],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25294,"children":25295},{"style":2287},[25296],{"type":55,"value":25297},"640",{"type":49,"tag":1060,"props":25299,"children":25300},{"style":1073},[25301],{"type":55,"value":78},{"type":49,"tag":1060,"props":25303,"children":25304},{"style":2287},[25305],{"type":55,"value":25306},"0.963\n",{"type":49,"tag":1060,"props":25308,"children":25309},{"class":1062,"line":11112},[25310,25314,25319,25323],{"type":49,"tag":1060,"props":25311,"children":25312},{"style":1073},[25313],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25315,"children":25316},{"style":2287},[25317],{"type":55,"value":25318},"650",{"type":49,"tag":1060,"props":25320,"children":25321},{"style":1073},[25322],{"type":55,"value":78},{"type":49,"tag":1060,"props":25324,"children":25325},{"style":2287},[25326],{"type":55,"value":25327},"0.9614\n",{"type":49,"tag":1060,"props":25329,"children":25330},{"class":1062,"line":11121},[25331,25335,25340,25344],{"type":49,"tag":1060,"props":25332,"children":25333},{"style":1073},[25334],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25336,"children":25337},{"style":2287},[25338],{"type":55,"value":25339},"660",{"type":49,"tag":1060,"props":25341,"children":25342},{"style":1073},[25343],{"type":55,"value":78},{"type":49,"tag":1060,"props":25345,"children":25346},{"style":2287},[25347],{"type":55,"value":25348},"0.9622\n",{"type":49,"tag":1060,"props":25350,"children":25351},{"class":1062,"line":11129},[25352,25356,25361,25365],{"type":49,"tag":1060,"props":25353,"children":25354},{"style":1073},[25355],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25357,"children":25358},{"style":2287},[25359],{"type":55,"value":25360},"670",{"type":49,"tag":1060,"props":25362,"children":25363},{"style":1073},[25364],{"type":55,"value":78},{"type":49,"tag":1060,"props":25366,"children":25367},{"style":2287},[25368],{"type":55,"value":25369},"0.9634\n",{"type":49,"tag":1060,"props":25371,"children":25372},{"class":1062,"line":11138},[25373,25377,25382,25386],{"type":49,"tag":1060,"props":25374,"children":25375},{"style":1073},[25376],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25378,"children":25379},{"style":2287},[25380],{"type":55,"value":25381},"680",{"type":49,"tag":1060,"props":25383,"children":25384},{"style":1073},[25385],{"type":55,"value":78},{"type":49,"tag":1060,"props":25387,"children":25388},{"style":2287},[25389],{"type":55,"value":25390},"0.9641\n",{"type":49,"tag":1060,"props":25392,"children":25393},{"class":1062,"line":11147},[25394,25398,25403,25407],{"type":49,"tag":1060,"props":25395,"children":25396},{"style":1073},[25397],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25399,"children":25400},{"style":2287},[25401],{"type":55,"value":25402},"690",{"type":49,"tag":1060,"props":25404,"children":25405},{"style":1073},[25406],{"type":55,"value":78},{"type":49,"tag":1060,"props":25408,"children":25409},{"style":2287},[25410],{"type":55,"value":25411},"0.9627\n",{"type":49,"tag":1060,"props":25413,"children":25414},{"class":1062,"line":11155},[25415,25419,25423],{"type":49,"tag":1060,"props":25416,"children":25417},{"style":1073},[25418],{"type":55,"value":24062},{"type":49,"tag":1060,"props":25420,"children":25421},{"style":2194},[25422],{"type":55,"value":10063},{"type":49,"tag":1060,"props":25424,"children":25425},{"style":2287},[25426],{"type":55,"value":25427}," 699\n",{"type":49,"tag":1060,"props":25429,"children":25430},{"class":1062,"line":11164},[25431,25435,25440,25444],{"type":49,"tag":1060,"props":25432,"children":25433},{"style":1073},[25434],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25436,"children":25437},{"style":2287},[25438],{"type":55,"value":25439},"700",{"type":49,"tag":1060,"props":25441,"children":25442},{"style":1073},[25443],{"type":55,"value":78},{"type":49,"tag":1060,"props":25445,"children":25446},{"style":2287},[25447],{"type":55,"value":25448},"0.9623\n",{"type":49,"tag":1060,"props":25450,"children":25451},{"class":1062,"line":11172},[25452,25456,25461,25465],{"type":49,"tag":1060,"props":25453,"children":25454},{"style":1073},[25455],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25457,"children":25458},{"style":2287},[25459],{"type":55,"value":25460},"710",{"type":49,"tag":1060,"props":25462,"children":25463},{"style":1073},[25464],{"type":55,"value":78},{"type":49,"tag":1060,"props":25466,"children":25467},{"style":2287},[25468],{"type":55,"value":25469},"0.9612\n",{"type":49,"tag":1060,"props":25471,"children":25472},{"class":1062,"line":11181},[25473,25477,25482,25486],{"type":49,"tag":1060,"props":25474,"children":25475},{"style":1073},[25476],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25478,"children":25479},{"style":2287},[25480],{"type":55,"value":25481},"720",{"type":49,"tag":1060,"props":25483,"children":25484},{"style":1073},[25485],{"type":55,"value":78},{"type":49,"tag":1060,"props":25487,"children":25488},{"style":2287},[25489],{"type":55,"value":25490},"0.9628\n",{"type":49,"tag":1060,"props":25492,"children":25493},{"class":1062,"line":11202},[25494,25498,25503,25507],{"type":49,"tag":1060,"props":25495,"children":25496},{"style":1073},[25497],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25499,"children":25500},{"style":2287},[25501],{"type":55,"value":25502},"730",{"type":49,"tag":1060,"props":25504,"children":25505},{"style":1073},[25506],{"type":55,"value":78},{"type":49,"tag":1060,"props":25508,"children":25509},{"style":2287},[25510],{"type":55,"value":25511},"0.965\n",{"type":49,"tag":1060,"props":25513,"children":25514},{"class":1062,"line":11222},[25515,25519,25524,25528],{"type":49,"tag":1060,"props":25516,"children":25517},{"style":1073},[25518],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25520,"children":25521},{"style":2287},[25522],{"type":55,"value":25523},"740",{"type":49,"tag":1060,"props":25525,"children":25526},{"style":1073},[25527],{"type":55,"value":78},{"type":49,"tag":1060,"props":25529,"children":25530},{"style":2287},[25531],{"type":55,"value":25532},"0.9635\n",{"type":49,"tag":1060,"props":25534,"children":25535},{"class":1062,"line":11244},[25536,25540,25545,25549],{"type":49,"tag":1060,"props":25537,"children":25538},{"style":1073},[25539],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25541,"children":25542},{"style":2287},[25543],{"type":55,"value":25544},"750",{"type":49,"tag":1060,"props":25546,"children":25547},{"style":1073},[25548],{"type":55,"value":78},{"type":49,"tag":1060,"props":25550,"children":25551},{"style":2287},[25552],{"type":55,"value":25532},{"type":49,"tag":1060,"props":25554,"children":25555},{"class":1062,"line":11264},[25556,25560,25565,25569],{"type":49,"tag":1060,"props":25557,"children":25558},{"style":1073},[25559],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25561,"children":25562},{"style":2287},[25563],{"type":55,"value":25564},"760",{"type":49,"tag":1060,"props":25566,"children":25567},{"style":1073},[25568],{"type":55,"value":78},{"type":49,"tag":1060,"props":25570,"children":25571},{"style":2287},[25572],{"type":55,"value":25573},"0.9648\n",{"type":49,"tag":1060,"props":25575,"children":25576},{"class":1062,"line":11277},[25577,25581,25586,25590],{"type":49,"tag":1060,"props":25578,"children":25579},{"style":1073},[25580],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25582,"children":25583},{"style":2287},[25584],{"type":55,"value":25585},"770",{"type":49,"tag":1060,"props":25587,"children":25588},{"style":1073},[25589],{"type":55,"value":78},{"type":49,"tag":1060,"props":25591,"children":25592},{"style":2287},[25593],{"type":55,"value":25594},"0.9637\n",{"type":49,"tag":1060,"props":25596,"children":25597},{"class":1062,"line":11285},[25598,25602,25607,25611],{"type":49,"tag":1060,"props":25599,"children":25600},{"style":1073},[25601],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25603,"children":25604},{"style":2287},[25605],{"type":55,"value":25606},"780",{"type":49,"tag":1060,"props":25608,"children":25609},{"style":1073},[25610],{"type":55,"value":78},{"type":49,"tag":1060,"props":25612,"children":25613},{"style":2287},[25614],{"type":55,"value":25615},"0.9658\n",{"type":49,"tag":1060,"props":25617,"children":25618},{"class":1062,"line":11293},[25619,25623,25628,25632],{"type":49,"tag":1060,"props":25620,"children":25621},{"style":1073},[25622],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25624,"children":25625},{"style":2287},[25626],{"type":55,"value":25627},"790",{"type":49,"tag":1060,"props":25629,"children":25630},{"style":1073},[25631],{"type":55,"value":78},{"type":49,"tag":1060,"props":25633,"children":25634},{"style":2287},[25635],{"type":55,"value":25636},"0.9649\n",{"type":49,"tag":1060,"props":25638,"children":25639},{"class":1062,"line":11302},[25640,25644,25648],{"type":49,"tag":1060,"props":25641,"children":25642},{"style":1073},[25643],{"type":55,"value":24062},{"type":49,"tag":1060,"props":25645,"children":25646},{"style":2194},[25647],{"type":55,"value":10063},{"type":49,"tag":1060,"props":25649,"children":25650},{"style":2287},[25651],{"type":55,"value":25652}," 799\n",{"type":49,"tag":1060,"props":25654,"children":25655},{"class":1062,"line":11323},[25656,25660,25665,25669],{"type":49,"tag":1060,"props":25657,"children":25658},{"style":1073},[25659],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25661,"children":25662},{"style":2287},[25663],{"type":55,"value":25664},"800",{"type":49,"tag":1060,"props":25666,"children":25667},{"style":1073},[25668],{"type":55,"value":78},{"type":49,"tag":1060,"props":25670,"children":25671},{"style":2287},[25672],{"type":55,"value":25673},"0.9681\n",{"type":49,"tag":1060,"props":25675,"children":25676},{"class":1062,"line":11345},[25677,25681,25686,25690],{"type":49,"tag":1060,"props":25678,"children":25679},{"style":1073},[25680],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25682,"children":25683},{"style":2287},[25684],{"type":55,"value":25685},"810",{"type":49,"tag":1060,"props":25687,"children":25688},{"style":1073},[25689],{"type":55,"value":78},{"type":49,"tag":1060,"props":25691,"children":25692},{"style":2287},[25693],{"type":55,"value":25694},"0.9661\n",{"type":49,"tag":1060,"props":25696,"children":25697},{"class":1062,"line":11377},[25698,25702,25707,25711],{"type":49,"tag":1060,"props":25699,"children":25700},{"style":1073},[25701],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25703,"children":25704},{"style":2287},[25705],{"type":55,"value":25706},"820",{"type":49,"tag":1060,"props":25708,"children":25709},{"style":1073},[25710],{"type":55,"value":78},{"type":49,"tag":1060,"props":25712,"children":25713},{"style":2287},[25714],{"type":55,"value":25715},"0.9657\n",{"type":49,"tag":1060,"props":25717,"children":25718},{"class":1062,"line":11395},[25719,25723,25728,25732],{"type":49,"tag":1060,"props":25720,"children":25721},{"style":1073},[25722],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25724,"children":25725},{"style":2287},[25726],{"type":55,"value":25727},"830",{"type":49,"tag":1060,"props":25729,"children":25730},{"style":1073},[25731],{"type":55,"value":78},{"type":49,"tag":1060,"props":25733,"children":25734},{"style":2287},[25735],{"type":55,"value":25736},"0.9646\n",{"type":49,"tag":1060,"props":25738,"children":25739},{"class":1062,"line":11413},[25740,25744,25749,25753],{"type":49,"tag":1060,"props":25741,"children":25742},{"style":1073},[25743],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25745,"children":25746},{"style":2287},[25747],{"type":55,"value":25748},"840",{"type":49,"tag":1060,"props":25750,"children":25751},{"style":1073},[25752],{"type":55,"value":78},{"type":49,"tag":1060,"props":25754,"children":25755},{"style":2287},[25756],{"type":55,"value":25757},"0.9647\n",{"type":49,"tag":1060,"props":25759,"children":25760},{"class":1062,"line":11421},[25761,25765,25770,25774],{"type":49,"tag":1060,"props":25762,"children":25763},{"style":1073},[25764],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25766,"children":25767},{"style":2287},[25768],{"type":55,"value":25769},"850",{"type":49,"tag":1060,"props":25771,"children":25772},{"style":1073},[25773],{"type":55,"value":78},{"type":49,"tag":1060,"props":25775,"children":25776},{"style":2287},[25777],{"type":55,"value":25511},{"type":49,"tag":1060,"props":25779,"children":25780},{"class":1062,"line":11429},[25781,25785,25790,25794],{"type":49,"tag":1060,"props":25782,"children":25783},{"style":1073},[25784],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25786,"children":25787},{"style":2287},[25788],{"type":55,"value":25789},"860",{"type":49,"tag":1060,"props":25791,"children":25792},{"style":1073},[25793],{"type":55,"value":78},{"type":49,"tag":1060,"props":25795,"children":25796},{"style":2287},[25797],{"type":55,"value":25798},"0.9677\n",{"type":49,"tag":1060,"props":25800,"children":25801},{"class":1062,"line":11438},[25802,25806,25811,25815],{"type":49,"tag":1060,"props":25803,"children":25804},{"style":1073},[25805],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25807,"children":25808},{"style":2287},[25809],{"type":55,"value":25810},"870",{"type":49,"tag":1060,"props":25812,"children":25813},{"style":1073},[25814],{"type":55,"value":78},{"type":49,"tag":1060,"props":25816,"children":25817},{"style":2287},[25818],{"type":55,"value":25636},{"type":49,"tag":1060,"props":25820,"children":25821},{"class":1062,"line":11487},[25822,25826,25831,25835],{"type":49,"tag":1060,"props":25823,"children":25824},{"style":1073},[25825],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25827,"children":25828},{"style":2287},[25829],{"type":55,"value":25830},"880",{"type":49,"tag":1060,"props":25832,"children":25833},{"style":1073},[25834],{"type":55,"value":78},{"type":49,"tag":1060,"props":25836,"children":25837},{"style":2287},[25838],{"type":55,"value":25839},"0.9675\n",{"type":49,"tag":1060,"props":25841,"children":25842},{"class":1062,"line":11495},[25843,25847,25852,25856],{"type":49,"tag":1060,"props":25844,"children":25845},{"style":1073},[25846],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25848,"children":25849},{"style":2287},[25850],{"type":55,"value":25851},"890",{"type":49,"tag":1060,"props":25853,"children":25854},{"style":1073},[25855],{"type":55,"value":78},{"type":49,"tag":1060,"props":25857,"children":25858},{"style":2287},[25859],{"type":55,"value":25860},"0.969\n",{"type":49,"tag":1060,"props":25862,"children":25863},{"class":1062,"line":11504},[25864,25868,25872],{"type":49,"tag":1060,"props":25865,"children":25866},{"style":1073},[25867],{"type":55,"value":24062},{"type":49,"tag":1060,"props":25869,"children":25870},{"style":2194},[25871],{"type":55,"value":10063},{"type":49,"tag":1060,"props":25873,"children":25874},{"style":2287},[25875],{"type":55,"value":25876}," 899\n",{"type":49,"tag":1060,"props":25878,"children":25879},{"class":1062,"line":11513},[25880,25884,25889,25893],{"type":49,"tag":1060,"props":25881,"children":25882},{"style":1073},[25883],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25885,"children":25886},{"style":2287},[25887],{"type":55,"value":25888},"900",{"type":49,"tag":1060,"props":25890,"children":25891},{"style":1073},[25892],{"type":55,"value":78},{"type":49,"tag":1060,"props":25894,"children":25895},{"style":2287},[25896],{"type":55,"value":25897},"0.9689\n",{"type":49,"tag":1060,"props":25899,"children":25900},{"class":1062,"line":11534},[25901,25905,25910,25914],{"type":49,"tag":1060,"props":25902,"children":25903},{"style":1073},[25904],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25906,"children":25907},{"style":2287},[25908],{"type":55,"value":25909},"910",{"type":49,"tag":1060,"props":25911,"children":25912},{"style":1073},[25913],{"type":55,"value":78},{"type":49,"tag":1060,"props":25915,"children":25916},{"style":2287},[25917],{"type":55,"value":25918},"0.967\n",{"type":49,"tag":1060,"props":25920,"children":25921},{"class":1062,"line":11555},[25922,25926,25931,25935],{"type":49,"tag":1060,"props":25923,"children":25924},{"style":1073},[25925],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25927,"children":25928},{"style":2287},[25929],{"type":55,"value":25930},"920",{"type":49,"tag":1060,"props":25932,"children":25933},{"style":1073},[25934],{"type":55,"value":78},{"type":49,"tag":1060,"props":25936,"children":25937},{"style":2287},[25938],{"type":55,"value":25939},"0.9672\n",{"type":49,"tag":1060,"props":25941,"children":25942},{"class":1062,"line":11581},[25943,25947,25952,25956],{"type":49,"tag":1060,"props":25944,"children":25945},{"style":1073},[25946],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25948,"children":25949},{"style":2287},[25950],{"type":55,"value":25951},"930",{"type":49,"tag":1060,"props":25953,"children":25954},{"style":1073},[25955],{"type":55,"value":78},{"type":49,"tag":1060,"props":25957,"children":25958},{"style":2287},[25959],{"type":55,"value":25960},"0.9645\n",{"type":49,"tag":1060,"props":25962,"children":25963},{"class":1062,"line":11598},[25964,25968,25973,25977],{"type":49,"tag":1060,"props":25965,"children":25966},{"style":1073},[25967],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25969,"children":25970},{"style":2287},[25971],{"type":55,"value":25972},"940",{"type":49,"tag":1060,"props":25974,"children":25975},{"style":1073},[25976],{"type":55,"value":78},{"type":49,"tag":1060,"props":25978,"children":25979},{"style":2287},[25980],{"type":55,"value":25715},{"type":49,"tag":1060,"props":25982,"children":25983},{"class":1062,"line":11614},[25984,25988,25993,25997],{"type":49,"tag":1060,"props":25985,"children":25986},{"style":1073},[25987],{"type":55,"value":23765},{"type":49,"tag":1060,"props":25989,"children":25990},{"style":2287},[25991],{"type":55,"value":25992},"950",{"type":49,"tag":1060,"props":25994,"children":25995},{"style":1073},[25996],{"type":55,"value":78},{"type":49,"tag":1060,"props":25998,"children":25999},{"style":2287},[26000],{"type":55,"value":26001},"0.9699\n",{"type":49,"tag":1060,"props":26003,"children":26004},{"class":1062,"line":11622},[26005,26009,26014,26018],{"type":49,"tag":1060,"props":26006,"children":26007},{"style":1073},[26008],{"type":55,"value":23765},{"type":49,"tag":1060,"props":26010,"children":26011},{"style":2287},[26012],{"type":55,"value":26013},"960",{"type":49,"tag":1060,"props":26015,"children":26016},{"style":1073},[26017],{"type":55,"value":78},{"type":49,"tag":1060,"props":26019,"children":26020},{"style":2287},[26021],{"type":55,"value":26022},"0.968\n",{"type":49,"tag":1060,"props":26024,"children":26025},{"class":1062,"line":11630},[26026,26030,26035,26039],{"type":49,"tag":1060,"props":26027,"children":26028},{"style":1073},[26029],{"type":55,"value":23765},{"type":49,"tag":1060,"props":26031,"children":26032},{"style":2287},[26033],{"type":55,"value":26034},"970",{"type":49,"tag":1060,"props":26036,"children":26037},{"style":1073},[26038],{"type":55,"value":78},{"type":49,"tag":1060,"props":26040,"children":26041},{"style":2287},[26042],{"type":55,"value":26043},"0.9679\n",{"type":49,"tag":1060,"props":26045,"children":26046},{"class":1062,"line":11643},[26047,26051,26056,26060],{"type":49,"tag":1060,"props":26048,"children":26049},{"style":1073},[26050],{"type":55,"value":23765},{"type":49,"tag":1060,"props":26052,"children":26053},{"style":2287},[26054],{"type":55,"value":26055},"980",{"type":49,"tag":1060,"props":26057,"children":26058},{"style":1073},[26059],{"type":55,"value":78},{"type":49,"tag":1060,"props":26061,"children":26062},{"style":2287},[26063],{"type":55,"value":26064},"0.9651\n",{"type":49,"tag":1060,"props":26066,"children":26067},{"class":1062,"line":11651},[26068,26072,26077,26081],{"type":49,"tag":1060,"props":26069,"children":26070},{"style":1073},[26071],{"type":55,"value":23765},{"type":49,"tag":1060,"props":26073,"children":26074},{"style":2287},[26075],{"type":55,"value":26076},"990",{"type":49,"tag":1060,"props":26078,"children":26079},{"style":1073},[26080],{"type":55,"value":78},{"type":49,"tag":1060,"props":26082,"children":26083},{"style":2287},[26084],{"type":55,"value":26085},"0.9683\n",{"type":49,"tag":1060,"props":26087,"children":26088},{"class":1062,"line":11660},[26089,26093,26097],{"type":49,"tag":1060,"props":26090,"children":26091},{"style":1073},[26092],{"type":55,"value":24062},{"type":49,"tag":1060,"props":26094,"children":26095},{"style":2194},[26096],{"type":55,"value":10063},{"type":49,"tag":1060,"props":26098,"children":26099},{"style":2287},[26100],{"type":55,"value":26101}," 999\n",{"type":49,"tag":58,"props":26103,"children":26104},{},[26105],{"type":55,"value":26106},"The script completed successfully! Now we can can take a look at what happened during the training. Launch Tensorboard with the following command:",{"type":49,"tag":1050,"props":26108,"children":26110},{"code":26109},"root@eb9e069064d7:~# tensorboard --logdir=/tmp/tensorflow/mnist/logs/\nTensorBoard 0.4.0rc2 at http://eb9e069064d7:6006 (Press CTRL+C to quit)\n",[26111],{"type":49,"tag":326,"props":26112,"children":26113},{"__ignoreMap":8},[26114],{"type":55,"value":26109},{"type":49,"tag":58,"props":26116,"children":26117},{},[26118,26120,26126],{"type":55,"value":26119},"Now we can simply navigate to ",{"type":49,"tag":326,"props":26121,"children":26123},{"className":26122},[],[26124],{"type":55,"value":26125},"localhost:6006",{"type":55,"value":26127}," in our browser to start using Tensorboard. Here's a screenshot of Tensorboard showing accuracy:",{"type":49,"tag":58,"props":26129,"children":26130},{},[26131],{"type":49,"tag":1601,"props":26132,"children":26133},{"alt":8926,"src":22449},[],{"type":49,"tag":58,"props":26135,"children":26136},{},[26137],{"type":55,"value":26138},"This wasn't too bad. The MNIST example included a very nice script with everything set up properly. My next big challenge is to implement some type of learning model with a data set of my own and visualize it with TensorBoard, but I'll have to go through several examples before then.",{"type":49,"tag":7749,"props":26140,"children":26141},{},[26142],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":26144},[],"content:2017:11:20:using-tensorflow-and-tensor-board-with-docker.md","2017/11/20/using-tensorflow-and-tensor-board-with-docker.md","2017/11/20/using-tensorflow-and-tensor-board-with-docker",{"_path":26149,"_dir":26150,"_draft":7,"_partial":7,"_locale":8,"title":26151,"description":26152,"layout":14767,"date":26153,"comments":44,"image":26154,"tags":26155,"body":26158,"_type":7809,"_id":26761,"_source":7811,"_file":26762,"_stem":26763,"_extension":7814},"/2017/11/19/tensorflow-gpu-setup-with-docker-on-arch-linux","19","Installing the GPU version of Tensorflow with Docker on Arch Linux","A walkthrough of Tensorflow setup and usage on Arch Linux with docker","2017-11-19T00:00:00.000Z","/static/trump.png",[26156,22451,24,26157,19534],"arch-linux","nvidia",{"type":46,"children":26159,"toc":26755},[26160,26165,26188,26194,26199,26205,26217,26222,26230,26235,26243,26248,26256,26284,26292,26297,26302,26310,26316,26330,26335,26346,26354,26366,26379,26387,26392,26400,26405,26413,26424,26432,26437,26445,26450,26458,26463,26471,26476,26623,26643,26663,26668,26676,26681,26689,26697,26702,26707,26715,26720,26733,26739,26744,26751],{"type":49,"tag":58,"props":26161,"children":26162},{},[26163],{"type":55,"value":26164},"I've tried installing the GPU version of Tensorflow a few times before and failed. There seems to be lots of confusion about the build process, of which there are many. Also, over the last few years there have been many new versions of the software needed to support the GPU version of Tensorflow as well as the first official release of Tensorflow itself (which is now on version 1.4), such as CUDA and cudnn, and different version of python. This is one more attempt at installing the GPU version of Tensor Flow on my Desktop PC that is currently dual booting with Arch Linux and Windows 10. I've decided to try going the docker route because it should eliminate some of the headache of missing depedencies. Here are the specs for my computer:",{"type":49,"tag":64,"props":26166,"children":26167},{},[26168,26173,26178,26183],{"type":49,"tag":68,"props":26169,"children":26170},{},[26171],{"type":55,"value":26172},"i7-6700K",{"type":49,"tag":68,"props":26174,"children":26175},{},[26176],{"type":55,"value":26177},"NVIDIA GTX 1080",{"type":49,"tag":68,"props":26179,"children":26180},{},[26181],{"type":55,"value":26182},"Asus Hero VIII motherboard",{"type":49,"tag":68,"props":26184,"children":26185},{},[26186],{"type":55,"value":26187},"Arch Linux on a 128 GB SSD (Windows 10 is installed on a separate SSD)",{"type":49,"tag":50,"props":26189,"children":26191},{"id":26190},"installing-cuda-and-cudnn",[26192],{"type":55,"value":26193},"Installing CUDA and cudnn",{"type":49,"tag":58,"props":26195,"children":26196},{},[26197],{"type":55,"value":26198},"We don't need to install these when installing Tensorflow with Docker. Read to the bottom for more info.",{"type":49,"tag":50,"props":26200,"children":26202},{"id":26201},"installing-docker",[26203],{"type":55,"value":26204},"Installing Docker",{"type":49,"tag":58,"props":26206,"children":26207},{},[26208,26210,26216],{"type":55,"value":26209},"To install docker on our machine, let's start with the ",{"type":49,"tag":80,"props":26211,"children":26213},{"href":22398,"rel":26212},[84],[26214],{"type":55,"value":26215},"Arch Wiki article on docker",{"type":55,"value":745},{"type":49,"tag":58,"props":26218,"children":26219},{},[26220],{"type":55,"value":26221},"We need to add the Loopback module to the Linux Kernel, so we run:",{"type":49,"tag":1050,"props":26223,"children":26225},{"code":26224},"# tee /etc/modules-load.d/loop.conf \u003C\u003C\u003C \"loop\"\n# modprobe loop\n$ reboot\n",[26226],{"type":49,"tag":326,"props":26227,"children":26228},{"__ignoreMap":8},[26229],{"type":55,"value":26224},{"type":49,"tag":58,"props":26231,"children":26232},{},[26233],{"type":55,"value":26234},"Ater rebooting we can install docker:",{"type":49,"tag":1050,"props":26236,"children":26238},{"code":26237},"yaourt -S docker\n",[26239],{"type":49,"tag":326,"props":26240,"children":26241},{"__ignoreMap":8},[26242],{"type":55,"value":26237},{"type":49,"tag":58,"props":26244,"children":26245},{},[26246],{"type":55,"value":26247},"Now we want to add ourself to the docker group with the following command:",{"type":49,"tag":1050,"props":26249,"children":26251},{"code":26250},"$ sudo gpasswd -a brian docker\n[sudo] password for brian:\nAdding user brian to group docker\n",[26252],{"type":49,"tag":326,"props":26253,"children":26254},{"__ignoreMap":8},[26255],{"type":55,"value":26250},{"type":49,"tag":58,"props":26257,"children":26258},{},[26259,26261,26267,26269,26275,26277,26282],{"type":55,"value":26260},"If you run ",{"type":49,"tag":326,"props":26262,"children":26264},{"className":26263},[],[26265],{"type":55,"value":26266},"groups",{"type":55,"value":26268},", you won't see docker listed in the groups you (brian) belong to. Run ",{"type":49,"tag":326,"props":26270,"children":26272},{"className":26271},[],[26273],{"type":55,"value":26274},"newgrp docker",{"type":55,"value":26276}," and then re-run docker and you should see ",{"type":49,"tag":326,"props":26278,"children":26280},{"className":26279},[],[26281],{"type":55,"value":24},{"type":55,"value":26283}," listed with any other groups you belong to:",{"type":49,"tag":1050,"props":26285,"children":26287},{"code":26286},"[brian@a1arch ~]$ groups\nwheel storage power users\n[brian@a1arch ~]$ newgrp docker\n                   -`                    brian@a1arch\n                  .o+`                   ------------\n                 `ooo/                   OS: Arch Linux x86_64\n                `+oooo:                  Kernel: 4.12.8-2-ARCH\n               `+oooooo:                 Uptime: 6 mins\n               -+oooooo+:                Packages: 1127\n             `/:-:++oooo+:               Shell: bash 4.4.12\n            `/++++/+++++++:              Resolution: 1920x1080\n           `/++++++++++++++:             WM: i3\n          `/+++ooooooooooooo/`           Theme: Adwaita [GTK2]\n         ./ooosssso++osssssso+`          Icons: Adwaita [GTK2]\n        .oossssso-````/ossssss+`         Terminal: urxvt\n       -osssssso.      :ssssssso.        Terminal Font: Inconsolata-12\n      :osssssss/        osssso+++.       CPU: Intel i7-6700K (8) @ 4.200GHz\n     /ossssssss/        +ssssooo/-       GPU: NVIDIA GeForce GTX 1080\n   `/ossssso+/:-        -:/+osssso+-     Memory: 3289MiB / 15975MiB\n  `+sso+:-`                 `.-/+oso:\n `++:.                           `-/+/\n .`                                 `/\n\n[brian@a1arch ~]$ groups\ndocker wheel storage power users\n",[26288],{"type":49,"tag":326,"props":26289,"children":26290},{"__ignoreMap":8},[26291],{"type":55,"value":26286},{"type":49,"tag":58,"props":26293,"children":26294},{},[26295],{"type":55,"value":26296},"Doing this prevents us from having to write sudo each time we run docker.",{"type":49,"tag":58,"props":26298,"children":26299},{},[26300],{"type":55,"value":26301},"Next we need to start the docker daemon.",{"type":49,"tag":1050,"props":26303,"children":26305},{"code":26304},"$ systemctl start docker\n==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====\nAuthentication is required to start 'docker.service'.\nAuthenticating as: brian\nPassword:\n==== AUTHENTICATION COMPLETE ====\n$\n",[26306],{"type":49,"tag":326,"props":26307,"children":26308},{"__ignoreMap":8},[26309],{"type":55,"value":26304},{"type":49,"tag":430,"props":26311,"children":26313},{"id":26312},"side-note",[26314],{"type":55,"value":26315},"Side note",{"type":49,"tag":58,"props":26317,"children":26318},{},[26319,26321,26328],{"type":55,"value":26320},"There seems to be an ",{"type":49,"tag":80,"props":26322,"children":26325},{"href":26323,"rel":26324},"https://github.com/moby/moby/issues/23289",[84],[26326],{"type":55,"value":26327},"Arch Linux-specific bug",{"type":55,"value":26329}," which prevents us from enabling docker (and nvidia-docker which we will get next). There is a solution to downgrade to an older version of docker, or you can just start the docker service and the nvidia-docker service when you want to use them. I have found it faster to first start nvidia-docker and then start docker services.",{"type":49,"tag":58,"props":26331,"children":26332},{},[26333],{"type":55,"value":26334},"So far so good. Next let's look at the Tensorflow documentation for installing Tensorflow with docker.",{"type":49,"tag":58,"props":26336,"children":26337},{},[26338,26340,26345],{"type":55,"value":26339},"We need to install ",{"type":49,"tag":326,"props":26341,"children":26343},{"className":26342},[],[26344],{"type":55,"value":22489},{"type":55,"value":6694},{"type":49,"tag":1050,"props":26347,"children":26349},{"code":26348},"$ yaourt -S nvidia-docker\n[...]\n[sudo] password for brian:\nloading packages...\nresolving dependencies...\nlooking for conflicting packages...\n\nPackages (1) nvidia-docker-1.0.1-1\n\nTotal Installed Size:  13.34 MiB\n\n:: Proceed with installation? [Y/n]\n(1/1) checking keys in keyring                                 [##################################] 100%\n(1/1) checking package integrity                               [##################################] 100%\n(1/1) loading package files                                    [##################################] 100%\n(1/1) checking for file conflicts                              [##################################] 100%\n(1/1) checking available disk space                            [##################################] 100%\n:: Processing package changes...\n(1/1) installing nvidia-docker                                 [##################################] 100%\n=> Prior to running 'CUDA'-containers, ensure that the nvidia-docker-plugin\n   is loaded. -> https://github.com/NVIDIA/nvidia-docker#other-distributions\n\n*) manually; sudo -b nohup nvidia-docker-plugin > /tmp/nvidia-docker.log\n\n*) automatically at startup; systemctl enable nvidia-docker.service\nOptional dependencies for nvidia-docker\n    cuda [installed]\n    nvidia [installed]\n    opencl-nvidia [installed]\n:: Running post-transaction hooks...\n(1/1) Arming ConditionNeedsUpdate...\n",[26350],{"type":49,"tag":326,"props":26351,"children":26352},{"__ignoreMap":8},[26353],{"type":55,"value":26348},{"type":49,"tag":58,"props":26355,"children":26356},{},[26357,26359,26365],{"type":55,"value":26358},"Next it says: Launch a Docker container that contains one of the TensorFlow binary images. Those images are available ",{"type":49,"tag":80,"props":26360,"children":26363},{"href":26361,"rel":26362},"https://hub.docker.com/r/tensorflow/tensorflow/tags/",[84],[26364],{"type":55,"value":8879},{"type":55,"value":745},{"type":49,"tag":58,"props":26367,"children":26368},{},[26369,26371,26377],{"type":55,"value":26370},"Next I pulled the container with the ",{"type":49,"tag":326,"props":26372,"children":26374},{"className":26373},[],[26375],{"type":55,"value":26376},"gpu-latest",{"type":55,"value":26378}," tag and it started to download the container:",{"type":49,"tag":1050,"props":26380,"children":26382},{"code":26381},"$ docker pull tensorflow/tensorflow:gpu-latest\n[sudo] password for brian:\nlatest-gpu: Pulling from tensorflow/tensorflow\nae79f2514705: Pull complete\nc59d01a7e4ca: Pull complete\n41ba73a9054d: Pull complete\nf1bbfd495cc1: Pull complete\n0c346f7223e2: Pull complete\n5dcd01667896: Pull complete\nca677f607487: Downloading  180.7MB/453MB\nb4637619a887: Download complete\n8c644ff287da: Downloading    224MB/465.6MB\n119c5f576e79: Download complete\n009f82e71a7c: Download complete\ndbc0fb5872c7: Downloading  17.83MB/66.54MB\n5ef01389c5b2: Waiting\n04f824004b76: Waiting\n5861b82f52e5: Waiting\na495a3b4e6e1: Waiting\n3a0a25b1bbaf: Pulling fs layer\nb76a0afeb1e1: Waiting\n",[26383],{"type":49,"tag":326,"props":26384,"children":26385},{"__ignoreMap":8},[26386],{"type":55,"value":26381},{"type":49,"tag":58,"props":26388,"children":26389},{},[26390],{"type":55,"value":26391},"It finished after several minutes:",{"type":49,"tag":1050,"props":26393,"children":26395},{"code":26394},"ca677f607487: Pull complete\nb4637619a887: Pull complete\n8c644ff287da: Pull complete\n119c5f576e79: Pull complete\n009f82e71a7c: Pull complete\ndbc0fb5872c7: Pull complete\n5ef01389c5b2: Pull complete\n04f824004b76: Pull complete\n5861b82f52e5: Pull complete\na495a3b4e6e1: Pull complete\n3a0a25b1bbaf: Pull complete\nb76a0afeb1e1: Pull complete\nDigest: sha256:90e27448121b321c5ec66069fb2c718301df2ddaf25ba916b6f53719141572b0\nStatus: Downloaded newer image for tensorflow/tensorflow:latest-gpu\n$\n",[26396],{"type":49,"tag":326,"props":26397,"children":26398},{"__ignoreMap":8},[26399],{"type":55,"value":26394},{"type":49,"tag":58,"props":26401,"children":26402},{},[26403],{"type":55,"value":26404},"Let's verify that it has the image:",{"type":49,"tag":1050,"props":26406,"children":26408},{"code":26407},"$ docker images\nREPOSITORY              TAG                 IMAGE ID            CREATED             SIZE\ntensorflow/tensorflow   latest-gpu          2f243a16ff63        13 days ago         3.36GB\n",[26409],{"type":49,"tag":326,"props":26410,"children":26411},{"__ignoreMap":8},[26412],{"type":55,"value":26407},{"type":49,"tag":58,"props":26414,"children":26415},{},[26416,26418,26423],{"type":55,"value":26417},"Next let's start the ",{"type":49,"tag":326,"props":26419,"children":26421},{"className":26420},[],[26422],{"type":55,"value":22489},{"type":55,"value":16826},{"type":49,"tag":1050,"props":26425,"children":26427},{"code":26426},"$ systemctl start nvidia-docker\n==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====\nAuthentication is required to start 'nvidia-docker.service'.\nAuthenticating as: brian\nPassword:\n==== AUTHENTICATION COMPLETE ====\n$\n",[26428],{"type":49,"tag":326,"props":26429,"children":26430},{"__ignoreMap":8},[26431],{"type":55,"value":26426},{"type":49,"tag":58,"props":26433,"children":26434},{},[26435],{"type":55,"value":26436},"OK, we should be ready to launch the image:",{"type":49,"tag":1050,"props":26438,"children":26440},{"code":26439},"$ nvidia-docker run -it tensorflow/tensorflow:latest-gpu bash\nroot@761a62c1cff1:/notebooks#\n",[26441],{"type":49,"tag":326,"props":26442,"children":26443},{"__ignoreMap":8},[26444],{"type":55,"value":26439},{"type":49,"tag":58,"props":26446,"children":26447},{},[26448],{"type":55,"value":26449},"This is looking good. Let's try to start python:",{"type":49,"tag":1050,"props":26451,"children":26453},{"code":26452},"root@761a62c1cff1:/notebooks# python\nPython 2.7.12 (default, Nov 19 2016, 06:48:10)\n[GCC 5.4.0 20160609] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import tensorflow as tf\n>>>\n",[26454],{"type":49,"tag":326,"props":26455,"children":26456},{"__ignoreMap":8},[26457],{"type":55,"value":26452},{"type":49,"tag":58,"props":26459,"children":26460},{},[26461],{"type":55,"value":26462},"That works! Let's try out the classic MNIST hand-written digit classification problem that comes packaged as a notebook with the container image:",{"type":49,"tag":1050,"props":26464,"children":26466},{"code":26465},"$ nvidia-docker run -it -p 8888:8888 tensorflow/tensorflow:latest-gpu\n[sudo] password for brian:\n[I 21:54:26.671 NotebookApp] Writing notebook server cookie secret to /root/.local/share/jupyter/runtime/notebook_cookie_secret\n[W 21:54:26.689 NotebookApp] WARNING: The notebook server is listening on all IP addresses and not using encryption. This is not recommended.\n[I 21:54:26.693 NotebookApp] Serving notebooks from local directory: /notebooks\n[I 21:54:26.693 NotebookApp] 0 active kernels\n[I 21:54:26.693 NotebookApp] The Jupyter Notebook is running at:\n[I 21:54:26.693 NotebookApp] http://[all ip addresses on your system]:8888/?token=cda89aff96a3d4a9741cc755aac07f65f3aa372f60a198bd\n[I 21:54:26.693 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).\n[C 21:54:26.693 NotebookApp]\n\n    Copy/paste this URL into your browser when you connect for the first time,\n    to login with a token:\n        http://localhost:8888/?token=cda89aff96a3d4a9741cc755aac07f65f3aa372f60a198bd\n[I 21:54:34.489 NotebookApp] 302 GET /?token=cda89aff96a3d4a9741cc755aac07f65f3aa372f60a198bd (172.17.0.1) 0.32ms\n[I 21:54:59.019 NotebookApp] Writing notebook-signing key to /root/.local/share/jupyter/notebook_secret\n[W 21:54:59.023 NotebookApp] Notebook 3_mnist_from_scratch.ipynb is not trusted\n[W 21:54:59.049 NotebookApp] 404 GET /nbextensions/widgets/notebook/js/extension.js?v=20171119215426 (172.17.0.1) 4.38ms referer=http://localhost:8888/notebooks/3_mnist_from_scratch.ipynb\n[I 21:54:59.813 NotebookApp] Kernel started: 00027a3e-59ae-47ce-90a5-752a9d1fe075\n[I 21:55:00.199 NotebookApp] Adapting to protocol v5.1 for kernel 00027a3e-59ae-47ce-90a5-752a9d1fe075\n[I 21:56:59.815 NotebookApp] Saving file at /3_mnist_from_scratch.ipynb\n[W 21:56:59.816 NotebookApp] Notebook 3_mnist_from_scratch.ipynb is not trusted\n2017-11-19 21:57:03.988627: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\n2017-11-19 21:57:04.070873: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:892] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2017-11-19 21:57:04.071129: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.7335\npciBusID: 0000:01:00.0\ntotalMemory: 7.92GiB freeMemory: 7.44GiB\n2017-11-19 21:57:04.071143: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1)\n",[26467],{"type":49,"tag":326,"props":26468,"children":26469},{"__ignoreMap":8},[26470],{"type":55,"value":26465},{"type":49,"tag":58,"props":26472,"children":26473},{},[26474],{"type":55,"value":26475},"I was only able to get the entire notebook to run after making a few small configuration tweaks to the tensorflow Interactive Session to fix some memory issues:",{"type":49,"tag":1050,"props":26477,"children":26479},{"code":26478,"language":19534,"meta":8,"className":19535,"style":8},"gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=0.75)\n\ns = tf.InteractiveSession(config=tf.ConfigProto(gpu_options=gpu_options))\n\n# Use our newly created session as the default for\n# subsequent operations.\ns.as_default()\n\n# Initialize all the variables we defined above.\ntf.global_variables_initializer().run()\n",[26480],{"type":49,"tag":326,"props":26481,"children":26482},{"__ignoreMap":8},[26483,26518,26525,26569,26576,26584,26592,26600,26607,26615],{"type":49,"tag":1060,"props":26484,"children":26485},{"class":1062,"line":1063},[26486,26491,26495,26500,26505,26509,26514],{"type":49,"tag":1060,"props":26487,"children":26488},{"style":1073},[26489],{"type":55,"value":26490},"gpu_options ",{"type":49,"tag":1060,"props":26492,"children":26493},{"style":2194},[26494],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26496,"children":26497},{"style":1073},[26498],{"type":55,"value":26499}," tf.GPUOptions(",{"type":49,"tag":1060,"props":26501,"children":26502},{"style":19626},[26503],{"type":55,"value":26504},"per_process_gpu_memory_fraction",{"type":49,"tag":1060,"props":26506,"children":26507},{"style":2194},[26508],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26510,"children":26511},{"style":2287},[26512],{"type":55,"value":26513},"0.75",{"type":49,"tag":1060,"props":26515,"children":26516},{"style":1073},[26517],{"type":55,"value":5126},{"type":49,"tag":1060,"props":26519,"children":26520},{"class":1062,"line":1079},[26521],{"type":49,"tag":1060,"props":26522,"children":26523},{"emptyLinePlaceholder":44},[26524],{"type":55,"value":1094},{"type":49,"tag":1060,"props":26526,"children":26527},{"class":1062,"line":1088},[26528,26533,26537,26542,26546,26550,26555,26560,26564],{"type":49,"tag":1060,"props":26529,"children":26530},{"style":1073},[26531],{"type":55,"value":26532},"s ",{"type":49,"tag":1060,"props":26534,"children":26535},{"style":2194},[26536],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26538,"children":26539},{"style":1073},[26540],{"type":55,"value":26541}," tf.InteractiveSession(",{"type":49,"tag":1060,"props":26543,"children":26544},{"style":19626},[26545],{"type":55,"value":6857},{"type":49,"tag":1060,"props":26547,"children":26548},{"style":2194},[26549],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26551,"children":26552},{"style":1073},[26553],{"type":55,"value":26554},"tf.ConfigProto(",{"type":49,"tag":1060,"props":26556,"children":26557},{"style":19626},[26558],{"type":55,"value":26559},"gpu_options",{"type":49,"tag":1060,"props":26561,"children":26562},{"style":2194},[26563],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26565,"children":26566},{"style":1073},[26567],{"type":55,"value":26568},"gpu_options))\n",{"type":49,"tag":1060,"props":26570,"children":26571},{"class":1062,"line":1097},[26572],{"type":49,"tag":1060,"props":26573,"children":26574},{"emptyLinePlaceholder":44},[26575],{"type":55,"value":1094},{"type":49,"tag":1060,"props":26577,"children":26578},{"class":1062,"line":1111},[26579],{"type":49,"tag":1060,"props":26580,"children":26581},{"style":3039},[26582],{"type":55,"value":26583},"# Use our newly created session as the default for\n",{"type":49,"tag":1060,"props":26585,"children":26586},{"class":1062,"line":1120},[26587],{"type":49,"tag":1060,"props":26588,"children":26589},{"style":3039},[26590],{"type":55,"value":26591},"# subsequent operations.\n",{"type":49,"tag":1060,"props":26593,"children":26594},{"class":1062,"line":1128},[26595],{"type":49,"tag":1060,"props":26596,"children":26597},{"style":1073},[26598],{"type":55,"value":26599},"s.as_default()\n",{"type":49,"tag":1060,"props":26601,"children":26602},{"class":1062,"line":1141},[26603],{"type":49,"tag":1060,"props":26604,"children":26605},{"emptyLinePlaceholder":44},[26606],{"type":55,"value":1094},{"type":49,"tag":1060,"props":26608,"children":26609},{"class":1062,"line":1150},[26610],{"type":49,"tag":1060,"props":26611,"children":26612},{"style":3039},[26613],{"type":55,"value":26614},"# Initialize all the variables we defined above.\n",{"type":49,"tag":1060,"props":26616,"children":26617},{"class":1062,"line":1158},[26618],{"type":49,"tag":1060,"props":26619,"children":26620},{"style":1073},[26621],{"type":55,"value":26622},"tf.global_variables_initializer().run()\n",{"type":49,"tag":58,"props":26624,"children":26625},{},[26626,26628,26633,26635,26642],{"type":55,"value":26627},"Without setting ",{"type":49,"tag":326,"props":26629,"children":26631},{"className":26630},[],[26632],{"type":55,"value":26559},{"type":55,"value":26634},", Tensorflow allocates 95% of available GPU memory (according to ",{"type":49,"tag":80,"props":26636,"children":26639},{"href":26637,"rel":26638},"https://stackoverflow.com/questions/34514324/error-using-tensorflow-with-gpu",[84],[26640],{"type":55,"value":26641},"this SO question",{"type":55,"value":3213},{"type":49,"tag":58,"props":26644,"children":26645},{},[26646,26648,26654,26656,26661],{"type":55,"value":26647},"Setting it to ",{"type":49,"tag":326,"props":26649,"children":26651},{"className":26650},[],[26652],{"type":55,"value":26653},"0.333",{"type":55,"value":26655}," was too low and didn't allow for training to complete, but setting it to ",{"type":49,"tag":326,"props":26657,"children":26659},{"className":26658},[],[26660],{"type":55,"value":26513},{"type":55,"value":26662}," seemed to work just fine.",{"type":49,"tag":58,"props":26664,"children":26665},{},[26666],{"type":55,"value":26667},"You can monitor GPU memory usage on NVIDIA cards with the following command:",{"type":49,"tag":1050,"props":26669,"children":26671},{"code":26670},"$ nvidia-smi\nSun Nov 19 17:03:03 2017\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 384.59                 Driver Version: 384.59                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GTX 1080    Off  | 00000000:01:00.0  On |                  N/A |\n| 27%   32C    P8    10W / 180W |   6707MiB /  8105MiB |      0%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|    0       350    C   /usr/bin/python                               6365MiB |\n|    0       554    G   /usr/lib/xorg-server/Xorg                       19MiB |\n|    0       588    G   /usr/bin/gnome-shell                            28MiB |\n|    0       853    G   /usr/lib/xorg-server/Xorg                      186MiB |\n|    0       873    G   compton                                          2MiB |\n|    0      1114    G   ...el-token=A50C2F183DB4F79482A2D8768ED1B285    64MiB |\n|    0      2190    G   ...el-token=1AC796A35DBDCDBE07AEC2FC1E8026C4    35MiB |\n+-----------------------------------------------------------------------------+\n",[26672],{"type":49,"tag":326,"props":26673,"children":26674},{"__ignoreMap":8},[26675],{"type":55,"value":26670},{"type":49,"tag":58,"props":26677,"children":26678},{},[26679],{"type":55,"value":26680},"I think this was a success! I'm fairly certain that we were leveraging the GPU to run the MNIST hand-written digit notebook. I didn't see messages that CUDNN loaded, but I can find versions of both CUDNN and CUDA in the docker image:",{"type":49,"tag":1050,"props":26682,"children":26684},{"code":26683},"root@80f65a971e9a:/# ls /usr/include/x86_64-linux-gnu/\na.out.h  bits  cudnn_v6.h      fpu_control.h  gnu        python2.7\nasm      c++   expat_config.h  freetype2      ieee754.h  sys\n",[26685],{"type":49,"tag":326,"props":26686,"children":26687},{"__ignoreMap":8},[26688],{"type":55,"value":26683},{"type":49,"tag":1050,"props":26690,"children":26692},{"code":26691},"root@80f65a971e9a:/# nvcc --version\nnvcc: NVIDIA (R) Cuda compiler driver\nCopyright (c) 2005-2016 NVIDIA Corporation\nBuilt on Tue_Jan_10_13:22:03_CST_2017\nCuda compilation tools, release 8.0, V8.0.61\n",[26693],{"type":49,"tag":326,"props":26694,"children":26695},{"__ignoreMap":8},[26696],{"type":55,"value":26691},{"type":49,"tag":58,"props":26698,"children":26699},{},[26700],{"type":55,"value":26701},"In previous attempts I had to register for an NVIDIA developer account and install these packages, but they seem to be packaged with the container.",{"type":49,"tag":58,"props":26703,"children":26704},{},[26705],{"type":55,"value":26706},"Finally, we can check the installed python packages:",{"type":49,"tag":1050,"props":26708,"children":26710},{"code":26709},"root@80f65a971e9a:~# pip freeze | grep tensorflow\ntensorflow-gpu==1.4.0\ntensorflow-tensorboard==0.4.0rc2\nroot@80f65a971e9a:~#\n",[26711],{"type":49,"tag":326,"props":26712,"children":26713},{"__ignoreMap":8},[26714],{"type":55,"value":26709},{"type":49,"tag":58,"props":26716,"children":26717},{},[26718],{"type":55,"value":26719},"This looks good, but I'm still not 100% sure that everything was done properly. I would like to learn more about Tensorflow and also play around with some examples using Tensorboard. Let me know if you have any questions or comments about this setup, I'm still learning! Thanks for reading.",{"type":49,"tag":58,"props":26721,"children":26722},{},[26723,26725,26732],{"type":55,"value":26724},"Just for fun, here's a DeepDream rendering of a famous Donald Trump picture using Google's pre-trained ",{"type":49,"tag":80,"props":26726,"children":26729},{"href":26727,"rel":26728},"https://github.com/google/inception",[84],[26730],{"type":55,"value":26731},"Inception model",{"type":55,"value":6694},{"type":49,"tag":58,"props":26734,"children":26735},{},[26736],{"type":49,"tag":1601,"props":26737,"children":26738},{"alt":8926,"src":26154},[],{"type":49,"tag":58,"props":26740,"children":26741},{},[26742],{"type":55,"value":26743},"For comparison, here is the original image:",{"type":49,"tag":58,"props":26745,"children":26746},{},[26747],{"type":49,"tag":1601,"props":26748,"children":26750},{"alt":8926,"src":26749},"/static/trump_original.jpg",[],{"type":49,"tag":7749,"props":26752,"children":26753},{},[26754],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":26756},[26757,26758],{"id":26190,"depth":1079,"text":26193},{"id":26201,"depth":1079,"text":26204,"children":26759},[26760],{"id":26312,"depth":1088,"text":26315},"content:2017:11:19:tensorflow-gpu-setup-with-docker-on-arch-linux.md","2017/11/19/tensorflow-gpu-setup-with-docker-on-arch-linux.md","2017/11/19/tensorflow-gpu-setup-with-docker-on-arch-linux",1723384595821]