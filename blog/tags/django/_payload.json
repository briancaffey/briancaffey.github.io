[{"data":1,"prerenderedAt":45209},["ShallowReactive",2],{"all-articles":3},[4,7815,13922,14029,14903,16041,16639,16869,17583,22041,27005,32587,32689,42048],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"date":11,"image":12,"tags":13,"draft":7,"external":25,"comments":44,"body":45,"_type":7809,"_id":7810,"_source":7811,"_file":7812,"_stem":7813,"_extension":7814},"/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","07",false,"","My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi","Three reusable infrastructure as code libraries for abstracting containerized web app architecture on AWS ECS","2023-01-07","/static/iac_rosetta_stone_og_image.png",[14,15,16,17,18,19,20,21,22,23,24],"django","cdk","terraform","pulumi","cloudformation","github-actions","aws","ecs","fargate","containers","docker",[26,29,32,35,38,41],{"link":27,"site":28},"https://news.ycombinator.com/item?id=34291336","hn",{"link":30,"site":31},"https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/","reddit",{"link":33,"site":34},"https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4","dev",{"link":36,"site":37},"https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a","medium",{"link":39,"site":40},"https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions","hashnode",{"link":42,"site":43},"https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta","substack",true,{"type":46,"children":47,"toc":7754},"root",[48,57,63,149,154,159,164,183,189,197,210,218,236,244,262,270,302,317,339,347,365,373,386,394,423,429,436,441,475,481,486,499,504,525,562,583,588,641,647,652,700,706,746,760,774,780,835,881,895,907,913,918,1037,1049,1269,1281,1286,1292,1332,1338,1343,1377,1404,1412,1420,1428,1436,1444,1452,1460,1468,1474,1486,1497,1505,1516,1524,1535,1543,1549,1554,1587,1592,1597,1606,1611,1617,1630,1670,1675,1718,1723,1756,1763,1775,1806,1818,1824,1829,1867,1872,1877,1891,1961,1966,1979,1985,1990,2033,2039,2052,2060,2066,2071,2084,2089,2095,2107,2137,2158,2163,2168,2355,2361,2366,2389,2394,2399,2405,2417,2422,2427,2609,2622,2630,2643,2681,2686,2691,2720,2725,2761,2767,2772,2825,2851,2857,2862,2867,2875,2881,2909,2926,2932,2944,3022,3027,3101,3109,3117,3123,3128,3149,3155,3160,3165,3171,3214,3219,3254,3259,3265,3278,3297,3303,3336,3354,3366,3427,3432,3815,3820,3964,3969,3974,3979,4715,4720,5038,5043,6012,6018,6023,6089,6095,6116,6131,6136,6190,6196,6201,6214,6219,6269,6289,6299,6429,6434,6597,6602,6652,6657,6822,6843,6965,6970,6976,6988,6993,7001,7013,7021,7027,7035,7062,7076,7094,7107,7112,7130,7135,7147,7153,7178,7184,7276,7289,7299,7304,7316,7322,7340,7366,7371,7377,7427,7433,7438,7614,7620,7625,7723,7728,7734,7748],{"type":49,"tag":50,"props":51,"children":53},"element","h2",{"id":52},"tldr",[54],{"type":55,"value":56},"text","tl;dr",{"type":49,"tag":58,"props":59,"children":60},"p",{},[61],{"type":55,"value":62},"I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions.",{"type":49,"tag":64,"props":65,"children":66},"ul",{},[67,88,104,120],{"type":49,"tag":68,"props":69,"children":70},"li",{},[71,77,79],{"type":49,"tag":72,"props":73,"children":74},"strong",{},[75],{"type":55,"value":76},"CDK Construct Library",{"type":55,"value":78},": ",{"type":49,"tag":80,"props":81,"children":85},"a",{"href":82,"rel":83},"https://github.com/briancaffey/cdk-django",[84],"nofollow",[86],{"type":55,"value":87},"github.com/briancaffey/cdk-django",{"type":49,"tag":68,"props":89,"children":90},{},[91,96,97],{"type":49,"tag":72,"props":92,"children":93},{},[94],{"type":55,"value":95},"Terraform Modules",{"type":55,"value":78},{"type":49,"tag":80,"props":98,"children":101},{"href":99,"rel":100},"https://github.com/briancaffey/terraform-aws-django",[84],[102],{"type":55,"value":103},"github.com/briancaffey/terraform-aws-django",{"type":49,"tag":68,"props":105,"children":106},{},[107,112,113],{"type":49,"tag":72,"props":108,"children":109},{},[110],{"type":55,"value":111},"Pulumi Component Library",{"type":55,"value":78},{"type":49,"tag":80,"props":114,"children":117},{"href":115,"rel":116},"https://github.com/briancaffey/pulumi-aws-django",[84],[118],{"type":55,"value":119},"github.com/briancaffey/pulumi-aws-django",{"type":49,"tag":68,"props":121,"children":122},{},[123,125,131,133,140,142],{"type":55,"value":124},"Mono repo with a sample Django micro blogging app (Î¼blog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that ",{"type":49,"tag":126,"props":127,"children":128},"em",{},[129],{"type":55,"value":130},"consumes",{"type":55,"value":132}," each of the libraries listed above, ",{"type":49,"tag":80,"props":134,"children":137},{"href":135,"rel":136},"https://briancaffey.github.io/django-step-by-step/",[84],[138],{"type":55,"value":139},"VuePress documentation site",{"type":55,"value":141}," and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): ",{"type":49,"tag":80,"props":143,"children":146},{"href":144,"rel":145},"https://github.com/briancaffey/django-step-by-step",[84],[147],{"type":55,"value":148},"github.com/briancaffey/django-step-by-step",{"type":49,"tag":50,"props":150,"children":152},{"id":151},"eli5",[153],{"type":55,"value":151},{"type":49,"tag":58,"props":155,"children":156},{},[157],{"type":55,"value":158},"Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \\castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use.",{"type":49,"tag":58,"props":160,"children":161},{},[162],{"type":55,"value":163},"Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers.",{"type":49,"tag":58,"props":165,"children":166},{},[167,169,174,176,181],{"type":55,"value":168},"The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos ",{"type":49,"tag":126,"props":170,"children":171},{},[172],{"type":55,"value":173},"to YouTube",{"type":55,"value":175},", but the code I'm writing allows you to upload any type of website (even site YouTube) ",{"type":49,"tag":126,"props":177,"children":178},{},[179],{"type":55,"value":180},"to the internet",{"type":55,"value":182},". When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach.",{"type":49,"tag":50,"props":184,"children":186},{"id":185},"why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi",[187],{"type":55,"value":188},"Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi",{"type":49,"tag":58,"props":190,"children":191},{},[192],{"type":49,"tag":72,"props":193,"children":194},{},[195],{"type":55,"value":196},"To push me to learn more about AWS, IaC, CI/CD, automation, and Platform Engineering",{"type":49,"tag":64,"props":198,"children":199},{},[200,205],{"type":49,"tag":68,"props":201,"children":202},{},[203],{"type":55,"value":204},"Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate).",{"type":49,"tag":68,"props":206,"children":207},{},[208],{"type":55,"value":209},"Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward",{"type":49,"tag":58,"props":211,"children":212},{},[213],{"type":49,"tag":72,"props":214,"children":215},{},[216],{"type":55,"value":217},"To fail as many times as possible",{"type":49,"tag":64,"props":219,"children":220},{},[221,226,231],{"type":49,"tag":68,"props":222,"children":223},{},[224],{"type":55,"value":225},"Every time I fail when I think I have things right, I learn something new",{"type":49,"tag":68,"props":227,"children":228},{},[229],{"type":55,"value":230},"Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production",{"type":49,"tag":68,"props":232,"children":233},{},[234],{"type":55,"value":235},"You can oftentimes be \"stuck\" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important",{"type":49,"tag":58,"props":237,"children":238},{},[239],{"type":49,"tag":72,"props":240,"children":241},{},[242],{"type":55,"value":243},"To take an application-first approach to DevOps",{"type":49,"tag":64,"props":245,"children":246},{},[247,252,257],{"type":49,"tag":68,"props":248,"children":249},{},[250],{"type":55,"value":251},"Application developers are increasingly being tasked with operational duties",{"type":49,"tag":68,"props":253,"children":254},{},[255],{"type":55,"value":256},"While learning about IaC, I had a hard time finding in-depth materials covering application development, CI/CD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image",{"type":49,"tag":68,"props":258,"children":259},{},[260],{"type":55,"value":261},"You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind",{"type":49,"tag":58,"props":263,"children":264},{},[265],{"type":49,"tag":72,"props":266,"children":267},{},[268],{"type":55,"value":269},"To develop a project I can reference when helping myself and others",{"type":49,"tag":64,"props":271,"children":272},{},[273,278,290],{"type":49,"tag":68,"props":274,"children":275},{},[276],{"type":55,"value":277},"companies and projects that do IaC and CI/CD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor",{"type":49,"tag":68,"props":279,"children":280},{},[281,283,288],{"type":55,"value":282},"Hopefully, the sample application, IaC, and CI/CD pipelines ",{"type":49,"tag":126,"props":284,"children":285},{},[286],{"type":55,"value":287},"aren't overly complex",{"type":55,"value":289},". There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on",{"type":49,"tag":68,"props":291,"children":292},{},[293,295,300],{"type":55,"value":294},"People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to ",{"type":49,"tag":72,"props":296,"children":297},{},[298],{"type":55,"value":299},"show",{"type":55,"value":301}," people how it can be done",{"type":49,"tag":58,"props":303,"children":304},{},[305],{"type":49,"tag":72,"props":306,"children":307},{},[308,310,315],{"type":55,"value":309},"To encourage others (specifically Developer Advocates / Developer Relations / Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software ",{"type":49,"tag":72,"props":311,"children":312},{},[313],{"type":55,"value":314},"in use",{"type":55,"value":316}," with an actual application.",{"type":49,"tag":64,"props":318,"children":319},{},[320,334],{"type":49,"tag":68,"props":321,"children":322},{},[323,325,332],{"type":55,"value":324},"There are many ways one could create an \"IaC Rosetta Stone\" (",{"type":49,"tag":326,"props":327,"children":329},"code",{"className":328},[],[330],{"type":55,"value":331},"public cloud providers x CI/CD providers x IaC tools",{"type":55,"value":333}," is a big number)",{"type":49,"tag":68,"props":335,"children":336},{},[337],{"type":55,"value":338},"This takes a lot of effort and time",{"type":49,"tag":58,"props":340,"children":341},{},[342],{"type":49,"tag":72,"props":343,"children":344},{},[345],{"type":55,"value":346},"I have nothing to sell you",{"type":49,"tag":64,"props":348,"children":349},{},[350,355,360],{"type":49,"tag":68,"props":351,"children":352},{},[353],{"type":55,"value":354},"So many articles about Cloud/DevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here",{"type":49,"tag":68,"props":356,"children":357},{},[358],{"type":55,"value":359},"I'm also not trying to sell anyone on using my IaC packages",{"type":49,"tag":68,"props":361,"children":362},{},[363],{"type":55,"value":364},"Hopefully, my IaC packages can serve as a helpful reference or starting point",{"type":49,"tag":58,"props":366,"children":367},{},[368],{"type":49,"tag":72,"props":369,"children":370},{},[371],{"type":55,"value":372},"Walk before running",{"type":49,"tag":64,"props":374,"children":375},{},[376,381],{"type":49,"tag":68,"props":377,"children":378},{},[379],{"type":55,"value":380},"I want to build up confidence with vanilla use cases before getting too fancy",{"type":49,"tag":68,"props":382,"children":383},{},[384],{"type":55,"value":385},"With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)",{"type":49,"tag":58,"props":387,"children":388},{},[389],{"type":49,"tag":72,"props":390,"children":391},{},[392],{"type":55,"value":393},"12 Factor App, DevOps, and Platform Engineering",{"type":49,"tag":64,"props":395,"children":396},{},[397,409],{"type":49,"tag":68,"props":398,"children":399},{},[400,407],{"type":49,"tag":80,"props":401,"children":404},{"href":402,"rel":403},"https://12factor.net/",[84],[405],{"type":55,"value":406},"12 Factor App",{"type":55,"value":408}," is great and has guided how I approach both Django application development and IaC library development",{"type":49,"tag":68,"props":410,"children":411},{},[412,414,421],{"type":55,"value":413},"The ",{"type":49,"tag":80,"props":415,"children":418},{"href":416,"rel":417},"https://platformengineering.org/",[84],[419],{"type":55,"value":420},"platformengineering.org",{"type":55,"value":422}," community has some good guiding principles",{"type":49,"tag":50,"props":424,"children":426},{"id":425},"cdkterraformpulumi-terminology",[427],{"type":55,"value":428},"CDK/Terraform/Pulumi terminology",{"type":49,"tag":430,"props":431,"children":433},"h3",{"id":432},"constructs-modules-and-components",[434],{"type":55,"value":435},"constructs, modules and components",{"type":49,"tag":58,"props":437,"children":438},{},[439],{"type":55,"value":440},"A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources.",{"type":49,"tag":58,"props":442,"children":443},{},[444,446,451,453,458,460,465,467,473],{"type":55,"value":445},"In this article I will refer to ",{"type":49,"tag":72,"props":447,"children":448},{},[449],{"type":55,"value":450},"constructs/modules/components",{"type":55,"value":452}," as ",{"type":49,"tag":72,"props":454,"children":455},{},[456],{"type":55,"value":457},"c/m/c",{"type":55,"value":459}," for short, and the term ",{"type":49,"tag":72,"props":461,"children":462},{},[463],{"type":55,"value":464},"stack",{"type":55,"value":466}," can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had ",{"type":49,"tag":326,"props":468,"children":470},{"className":469},[],[471],{"type":55,"value":472},"apply",{"type":55,"value":474}," ran against it.",{"type":49,"tag":430,"props":476,"children":478},{"id":477},"what-is-a-stack",[479],{"type":55,"value":480},"what is a stack?",{"type":49,"tag":58,"props":482,"children":483},{},[484],{"type":55,"value":485},"AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words \"Terraform configuration\" to refer to some group of resources that were built using a module.",{"type":49,"tag":58,"props":487,"children":488},{},[489,491,497],{"type":55,"value":490},"CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the ",{"type":49,"tag":326,"props":492,"children":494},{"className":493},[],[495],{"type":55,"value":496},"@pulumi/aws",{"type":55,"value":498}," package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses).",{"type":49,"tag":430,"props":500,"children":502},{"id":501},"verbs",[503],{"type":55,"value":501},{"type":49,"tag":58,"props":505,"children":506},{},[507,509,515,517,523],{"type":55,"value":508},"In CDK you ",{"type":49,"tag":326,"props":510,"children":512},{"className":511},[],[513],{"type":55,"value":514},"synth",{"type":55,"value":516}," CDK code to generate CloudFormation templates. You can also run ",{"type":49,"tag":326,"props":518,"children":520},{"className":519},[],[521],{"type":55,"value":522},"diff",{"type":55,"value":524}," to see what changes would be applied during a stack update.",{"type":49,"tag":58,"props":526,"children":527},{},[528,530,536,538,544,546,552,554,560],{"type":55,"value":529},"In Terraform you ",{"type":49,"tag":326,"props":531,"children":533},{"className":532},[],[534],{"type":55,"value":535},"init",{"type":55,"value":537}," to download all providers and modules. This is sort of like running ",{"type":49,"tag":326,"props":539,"children":541},{"className":540},[],[542],{"type":55,"value":543},"npm install",{"type":55,"value":545}," in CDK and Pulumi. You then run ",{"type":49,"tag":326,"props":547,"children":549},{"className":548},[],[550],{"type":55,"value":551},"terraform plan",{"type":55,"value":553}," to see the changes that would result. ",{"type":49,"tag":326,"props":555,"children":557},{"className":556},[],[558],{"type":55,"value":559},"terraform apply",{"type":55,"value":561}," does CRUD operations on your cloud resources.",{"type":49,"tag":58,"props":563,"children":564},{},[565,567,573,575,581],{"type":55,"value":566},"In Pulumi you run ",{"type":49,"tag":326,"props":568,"children":570},{"className":569},[],[571],{"type":55,"value":572},"pulumi preview",{"type":55,"value":574}," to see what changes would be made to a stack. You can use the ",{"type":49,"tag":326,"props":576,"children":578},{"className":577},[],[579],{"type":55,"value":580},"--diff",{"type":55,"value":582}," flag to see the specifics of what would change.",{"type":49,"tag":58,"props":584,"children":585},{},[586],{"type":55,"value":587},"To summarize:",{"type":49,"tag":64,"props":589,"children":590},{},[591,596,617,630],{"type":49,"tag":68,"props":592,"children":593},{},[594],{"type":55,"value":595},"In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An \"app\" can contain multiple stacks, and you can deploy one or more stacks in an app at a time",{"type":49,"tag":68,"props":597,"children":598},{},[599,601,606,608,615],{"type":55,"value":600},"In Terraform you plan a configuration made up of modules, and then run ",{"type":49,"tag":326,"props":602,"children":604},{"className":603},[],[605],{"type":55,"value":559},{"type":55,"value":607}," to build the configuration/stack (",{"type":49,"tag":80,"props":609,"children":612},{"href":610,"rel":611},"https://discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",[84],[613],{"type":55,"value":614},"discuss.hashicorp.com/t/what-is-a-terraform-stack/31985",{"type":55,"value":616},")",{"type":49,"tag":68,"props":618,"children":619},{},[620,622,628],{"type":55,"value":621},"Pulumi: You preview a Pulumi stack made up of components, and then run ",{"type":49,"tag":326,"props":623,"children":625},{"className":624},[],[626],{"type":55,"value":627},"pulumi up",{"type":55,"value":629}," to build the resources",{"type":49,"tag":68,"props":631,"children":632},{},[633,635],{"type":55,"value":634},"To tear down a stack in all three tools, you run ",{"type":49,"tag":326,"props":636,"children":638},{"className":637},[],[639],{"type":55,"value":640},"destroy",{"type":49,"tag":50,"props":642,"children":644},{"id":643},"infrastructure-as-code-library-repos",[645],{"type":55,"value":646},"Infrastructure as Code library repos",{"type":49,"tag":58,"props":648,"children":649},{},[650],{"type":55,"value":651},"Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate.",{"type":49,"tag":64,"props":653,"children":654},{},[655,670,685],{"type":49,"tag":68,"props":656,"children":657},{},[658,660],{"type":55,"value":659},"CDK: ",{"type":49,"tag":80,"props":661,"children":663},{"href":82,"rel":662},[84],[664],{"type":49,"tag":326,"props":665,"children":667},{"className":666},[],[668],{"type":55,"value":669},"cdk-django",{"type":49,"tag":68,"props":671,"children":672},{},[673,675],{"type":55,"value":674},"Terraform: ",{"type":49,"tag":80,"props":676,"children":678},{"href":99,"rel":677},[84],[679],{"type":49,"tag":326,"props":680,"children":682},{"className":681},[],[683],{"type":55,"value":684},"terraform-aws-django",{"type":49,"tag":68,"props":686,"children":687},{},[688,690],{"type":55,"value":689},"Pulumi: ",{"type":49,"tag":80,"props":691,"children":693},{"href":115,"rel":692},[84],[694],{"type":49,"tag":326,"props":695,"children":697},{"className":696},[],[698],{"type":55,"value":699},"pulumi-aws-django",{"type":49,"tag":430,"props":701,"children":703},{"id":702},"language",[704],{"type":55,"value":705},"Language",{"type":49,"tag":58,"props":707,"children":708},{},[709,714,716,721,723,728,730,735,737,744],{"type":49,"tag":326,"props":710,"children":712},{"className":711},[],[713],{"type":55,"value":669},{"type":55,"value":715}," and ",{"type":49,"tag":326,"props":717,"children":719},{"className":718},[],[720],{"type":55,"value":699},{"type":55,"value":722}," are both written in TypeScript. ",{"type":49,"tag":326,"props":724,"children":726},{"className":725},[],[727],{"type":55,"value":684},{"type":55,"value":729}," is written in HCL, a domain specific language created by HashiCorp. The ",{"type":49,"tag":326,"props":731,"children":733},{"className":732},[],[734],{"type":55,"value":669},{"type":55,"value":736}," is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using ",{"type":49,"tag":80,"props":738,"children":741},{"href":739,"rel":740},"https://github.com/aws/jsii",[84],[742],{"type":55,"value":743},"jsii",{"type":55,"value":745},".",{"type":49,"tag":58,"props":747,"children":748},{},[749,751,758],{"type":55,"value":750},"My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See ",{"type":49,"tag":80,"props":752,"children":755},{"href":753,"rel":754},"https://github.com/pulumi/pulumi-component-provider-ts-boilerplate",[84],[756],{"type":55,"value":757},"this GitHub repo",{"type":55,"value":759}," for more information on this.",{"type":49,"tag":58,"props":761,"children":762},{},[763,765,772],{"type":55,"value":764},"The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called ",{"type":49,"tag":80,"props":766,"children":769},{"href":767,"rel":768},"https://developer.hashicorp.com/terraform/cdktf",[84],[770],{"type":55,"value":771},"CDKTF",{"type":55,"value":773}," which allows you to write HCL Terraform in TypeScript, but I haven't used it yet.",{"type":49,"tag":430,"props":775,"children":777},{"id":776},"release-management-versioning-and-publishing",[778],{"type":55,"value":779},"Release management, versioning and publishing",{"type":49,"tag":58,"props":781,"children":782},{},[783,788,789,794,796,802,804,809,811,817,819,825,827,833],{"type":49,"tag":326,"props":784,"children":786},{"className":785},[],[787],{"type":55,"value":699},{"type":55,"value":715},{"type":49,"tag":326,"props":790,"children":792},{"className":791},[],[793],{"type":55,"value":684},{"type":55,"value":795}," both use ",{"type":49,"tag":326,"props":797,"children":799},{"className":798},[],[800],{"type":55,"value":801},"release-please",{"type":55,"value":803}," for automatically generating a changelog file and bumping versions. ",{"type":49,"tag":326,"props":805,"children":807},{"className":806},[],[808],{"type":55,"value":801},{"type":55,"value":810}," is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to ",{"type":49,"tag":326,"props":812,"children":814},{"className":813},[],[815],{"type":55,"value":816},"main",{"type":55,"value":818},", a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in ",{"type":49,"tag":326,"props":820,"children":822},{"className":821},[],[823],{"type":55,"value":824},"package.json",{"type":55,"value":826}," and adds a new git tag (e.g. ",{"type":49,"tag":326,"props":828,"children":830},{"className":829},[],[831],{"type":55,"value":832},"v1.2.3",{"type":55,"value":834},") based on commit messages.",{"type":49,"tag":58,"props":836,"children":837},{},[838,843,845,856,858,864,866,872,874,879],{"type":49,"tag":326,"props":839,"children":841},{"className":840},[],[842],{"type":55,"value":669},{"type":55,"value":844}," uses ",{"type":49,"tag":80,"props":846,"children":849},{"href":847,"rel":848},"https://github.com/projen/projen",[84],[850],{"type":49,"tag":326,"props":851,"children":853},{"className":852},[],[854],{"type":55,"value":855},"projen",{"type":55,"value":857}," for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file (",{"type":49,"tag":326,"props":859,"children":861},{"className":860},[],[862],{"type":55,"value":863},".projenrc.ts",{"type":55,"value":865},") to configure your entire repo, including files like ",{"type":49,"tag":326,"props":867,"children":869},{"className":868},[],[870],{"type":55,"value":871},"tsconfig.json",{"type":55,"value":873},", ",{"type":49,"tag":326,"props":875,"children":877},{"className":876},[],[878],{"type":55,"value":824},{"type":55,"value":880},", and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action.",{"type":49,"tag":58,"props":882,"children":883},{},[884,886,893],{"type":55,"value":885},"These tools are both based on ",{"type":49,"tag":80,"props":887,"children":890},{"href":888,"rel":889},"https://www.conventionalcommits.org/en/v1.0.0/",[84],[891],{"type":55,"value":892},"conventional commits",{"type":55,"value":894}," to automatically update the Changelog file.",{"type":49,"tag":58,"props":896,"children":897},{},[898,900,905],{"type":55,"value":899},"I'm still manually publishing my ",{"type":49,"tag":326,"props":901,"children":903},{"className":902},[],[904],{"type":55,"value":699},{"type":55,"value":906}," package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!",{"type":49,"tag":430,"props":908,"children":910},{"id":909},"makefile-examples-and-local-development",[911],{"type":55,"value":912},"Makefile, examples and local development",{"type":49,"tag":58,"props":914,"children":915},{},[916],{"type":55,"value":917},"Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:",{"type":49,"tag":64,"props":919,"children":920},{},[921,933,943,953,971,987,998,1008,1027],{"type":49,"tag":68,"props":922,"children":923},{},[924,926,931],{"type":55,"value":925},"synthesizing CDK to CloudFormation / running ",{"type":49,"tag":326,"props":927,"children":929},{"className":928},[],[930],{"type":55,"value":551},{"type":55,"value":932}," / previewing pulumi up for both the base and app stacks",{"type":49,"tag":68,"props":934,"children":935},{},[936,938],{"type":55,"value":937},"creating/updating an ad hoc base stack called ",{"type":49,"tag":326,"props":939,"children":941},{"className":940},[],[942],{"type":55,"value":34},{"type":49,"tag":68,"props":944,"children":945},{},[946,948],{"type":55,"value":947},"destroying resources in the ad-hoc base stack called ",{"type":49,"tag":326,"props":949,"children":951},{"className":950},[],[952],{"type":55,"value":34},{"type":49,"tag":68,"props":954,"children":955},{},[956,958,964,966],{"type":55,"value":957},"creating an ad hoc app stack called ",{"type":49,"tag":326,"props":959,"children":961},{"className":960},[],[962],{"type":55,"value":963},"alpha",{"type":55,"value":965}," that uses resources from ",{"type":49,"tag":326,"props":967,"children":969},{"className":968},[],[970],{"type":55,"value":34},{"type":49,"tag":68,"props":972,"children":973},{},[974,976,981,982],{"type":55,"value":975},"destroying an ad hoc app stack called ",{"type":49,"tag":326,"props":977,"children":979},{"className":978},[],[980],{"type":55,"value":963},{"type":55,"value":965},{"type":49,"tag":326,"props":983,"children":985},{"className":984},[],[986],{"type":55,"value":34},{"type":49,"tag":68,"props":988,"children":989},{},[990,992],{"type":55,"value":991},"creating/updating a prod base stack called ",{"type":49,"tag":326,"props":993,"children":995},{"className":994},[],[996],{"type":55,"value":997},"stage",{"type":49,"tag":68,"props":999,"children":1000},{},[1001,1003],{"type":55,"value":1002},"destroying resources in the prod base stack called ",{"type":49,"tag":326,"props":1004,"children":1006},{"className":1005},[],[1007],{"type":55,"value":997},{"type":49,"tag":68,"props":1009,"children":1010},{},[1011,1013,1018,1020,1025],{"type":55,"value":1012},"creating a prod app stack using called ",{"type":49,"tag":326,"props":1014,"children":1016},{"className":1015},[],[1017],{"type":55,"value":997},{"type":55,"value":1019}," that uses resources from the ",{"type":49,"tag":326,"props":1021,"children":1023},{"className":1022},[],[1024],{"type":55,"value":997},{"type":55,"value":1026}," base stack",{"type":49,"tag":68,"props":1028,"children":1029},{},[1030,1032],{"type":55,"value":1031},"destroying resources in the prod app stack called ",{"type":49,"tag":326,"props":1033,"children":1035},{"className":1034},[],[1036],{"type":55,"value":997},{"type":49,"tag":58,"props":1038,"children":1039},{},[1040,1042,1047],{"type":55,"value":1041},"Here's an example of what these commands look like in ",{"type":49,"tag":326,"props":1043,"children":1045},{"className":1044},[],[1046],{"type":55,"value":699},{"type":55,"value":1048}," for prod infrastructure base and app stacks:",{"type":49,"tag":1050,"props":1051,"children":1055},"pre",{"code":1052,"language":1053,"meta":8,"className":1054,"style":8},"prod-base-preview:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive preview\n\nprod-base-up:   build\n    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n\nprod-base-destroy:  build\n    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n\nprod-app-preview:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview\n\nprod-app-preview-diff:  build\n    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n\nprod-app-up:    build\n    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n\nprod-app-destroy:   build\n    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n","make","language-make shiki shiki-themes github-light github-dark monokai",[1056],{"type":49,"tag":326,"props":1057,"children":1058},{"__ignoreMap":8},[1059,1077,1086,1095,1109,1118,1126,1139,1148,1156,1169,1178,1186,1199,1208,1216,1230,1239,1247,1260],{"type":49,"tag":1060,"props":1061,"children":1064},"span",{"class":1062,"line":1063},"line",1,[1065,1071],{"type":49,"tag":1060,"props":1066,"children":1068},{"style":1067},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1069],{"type":55,"value":1070},"prod-base-preview",{"type":49,"tag":1060,"props":1072,"children":1074},{"style":1073},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[1075],{"type":55,"value":1076},":  build\n",{"type":49,"tag":1060,"props":1078,"children":1080},{"class":1062,"line":1079},2,[1081],{"type":49,"tag":1060,"props":1082,"children":1083},{"style":1073},[1084],{"type":55,"value":1085},"    pulumi -C examples/prod/base --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1087,"children":1089},{"class":1062,"line":1088},3,[1090],{"type":49,"tag":1060,"props":1091,"children":1092},{"emptyLinePlaceholder":44},[1093],{"type":55,"value":1094},"\n",{"type":49,"tag":1060,"props":1096,"children":1098},{"class":1062,"line":1097},4,[1099,1104],{"type":49,"tag":1060,"props":1100,"children":1101},{"style":1067},[1102],{"type":55,"value":1103},"prod-base-up",{"type":49,"tag":1060,"props":1105,"children":1106},{"style":1073},[1107],{"type":55,"value":1108},":   build\n",{"type":49,"tag":1060,"props":1110,"children":1112},{"class":1062,"line":1111},5,[1113],{"type":49,"tag":1060,"props":1114,"children":1115},{"style":1073},[1116],{"type":55,"value":1117},"    pulumi -C examples/prod/base --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1119,"children":1121},{"class":1062,"line":1120},6,[1122],{"type":49,"tag":1060,"props":1123,"children":1124},{"emptyLinePlaceholder":44},[1125],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1127,"children":1129},{"class":1062,"line":1128},7,[1130,1135],{"type":49,"tag":1060,"props":1131,"children":1132},{"style":1067},[1133],{"type":55,"value":1134},"prod-base-destroy",{"type":49,"tag":1060,"props":1136,"children":1137},{"style":1073},[1138],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1140,"children":1142},{"class":1062,"line":1141},8,[1143],{"type":49,"tag":1060,"props":1144,"children":1145},{"style":1073},[1146],{"type":55,"value":1147},"    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":1060,"props":1149,"children":1151},{"class":1062,"line":1150},9,[1152],{"type":49,"tag":1060,"props":1153,"children":1154},{"emptyLinePlaceholder":44},[1155],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1157,"children":1159},{"class":1062,"line":1158},10,[1160,1165],{"type":49,"tag":1060,"props":1161,"children":1162},{"style":1067},[1163],{"type":55,"value":1164},"prod-app-preview",{"type":49,"tag":1060,"props":1166,"children":1167},{"style":1073},[1168],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1170,"children":1172},{"class":1062,"line":1171},11,[1173],{"type":49,"tag":1060,"props":1174,"children":1175},{"style":1073},[1176],{"type":55,"value":1177},"    pulumi -C examples/prod/app --stack stage --non-interactive preview\n",{"type":49,"tag":1060,"props":1179,"children":1181},{"class":1062,"line":1180},12,[1182],{"type":49,"tag":1060,"props":1183,"children":1184},{"emptyLinePlaceholder":44},[1185],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1187,"children":1189},{"class":1062,"line":1188},13,[1190,1195],{"type":49,"tag":1060,"props":1191,"children":1192},{"style":1067},[1193],{"type":55,"value":1194},"prod-app-preview-diff",{"type":49,"tag":1060,"props":1196,"children":1197},{"style":1073},[1198],{"type":55,"value":1076},{"type":49,"tag":1060,"props":1200,"children":1202},{"class":1062,"line":1201},14,[1203],{"type":49,"tag":1060,"props":1204,"children":1205},{"style":1073},[1206],{"type":55,"value":1207},"    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff\n",{"type":49,"tag":1060,"props":1209,"children":1211},{"class":1062,"line":1210},15,[1212],{"type":49,"tag":1060,"props":1213,"children":1214},{"emptyLinePlaceholder":44},[1215],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1217,"children":1219},{"class":1062,"line":1218},16,[1220,1225],{"type":49,"tag":1060,"props":1221,"children":1222},{"style":1067},[1223],{"type":55,"value":1224},"prod-app-up",{"type":49,"tag":1060,"props":1226,"children":1227},{"style":1073},[1228],{"type":55,"value":1229},":    build\n",{"type":49,"tag":1060,"props":1231,"children":1233},{"class":1062,"line":1232},17,[1234],{"type":49,"tag":1060,"props":1235,"children":1236},{"style":1073},[1237],{"type":55,"value":1238},"    pulumi -C examples/prod/app --stack stage --non-interactive up --yes\n",{"type":49,"tag":1060,"props":1240,"children":1242},{"class":1062,"line":1241},18,[1243],{"type":49,"tag":1060,"props":1244,"children":1245},{"emptyLinePlaceholder":44},[1246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":1248,"children":1250},{"class":1062,"line":1249},19,[1251,1256],{"type":49,"tag":1060,"props":1252,"children":1253},{"style":1067},[1254],{"type":55,"value":1255},"prod-app-destroy",{"type":49,"tag":1060,"props":1257,"children":1258},{"style":1073},[1259],{"type":55,"value":1108},{"type":49,"tag":1060,"props":1261,"children":1263},{"class":1062,"line":1262},20,[1264],{"type":49,"tag":1060,"props":1265,"children":1266},{"style":1073},[1267],{"type":55,"value":1268},"    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes\n",{"type":49,"tag":58,"props":1270,"children":1271},{},[1272,1274,1279],{"type":55,"value":1273},"I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the ",{"type":49,"tag":326,"props":1275,"children":1277},{"className":1276},[],[1278],{"type":55,"value":457},{"type":55,"value":1280},"s to create environments and smoke check the environments to make sure everything works correctly.",{"type":49,"tag":58,"props":1282,"children":1283},{},[1284],{"type":55,"value":1285},"Adding unit tests is another item for the backlog.",{"type":49,"tag":430,"props":1287,"children":1289},{"id":1288},"ad-hoc-vs-prod",[1290],{"type":55,"value":1291},"ad-hoc vs prod",{"type":49,"tag":64,"props":1293,"children":1294},{},[1295,1307,1312,1317,1322,1327],{"type":49,"tag":68,"props":1296,"children":1297},{},[1298,1305],{"type":49,"tag":80,"props":1299,"children":1302},{"href":1300,"rel":1301},"https://briancaffey.github.io/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",[84],[1303],{"type":55,"value":1304},"the last article I wrote was about ad hoc environments",{"type":55,"value":1306},". Also known as \"on-demand\" environments or \"preview\" environments.",{"type":49,"tag":68,"props":1308,"children":1309},{},[1310],{"type":55,"value":1311},"the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)",{"type":49,"tag":68,"props":1313,"children":1314},{},[1315],{"type":55,"value":1316},"you can completely ignore \"ad-hoc\" environments and use the \"prod\" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)",{"type":49,"tag":68,"props":1318,"children":1319},{},[1320],{"type":55,"value":1321},"prod can be used for a production environment and any number of pre-production environments",{"type":49,"tag":68,"props":1323,"children":1324},{},[1325],{"type":55,"value":1326},"multiple environments built with \"prod\" infrastructure can be configured with a \"knobs and dials\" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)",{"type":49,"tag":68,"props":1328,"children":1329},{},[1330],{"type":55,"value":1331},"the \"prod\" infrastructure should be the same for the \"production\" environment and the \"staging\" environment",{"type":49,"tag":430,"props":1333,"children":1335},{"id":1334},"directory-structure",[1336],{"type":55,"value":1337},"Directory structure",{"type":49,"tag":58,"props":1339,"children":1340},{},[1341],{"type":55,"value":1342},"The directory structures for each repo are all similar with some minor differences.",{"type":49,"tag":58,"props":1344,"children":1345},{},[1346,1348,1354,1355,1361,1363,1369,1370,1376],{"type":55,"value":1347},"There are two types of environments: ",{"type":49,"tag":326,"props":1349,"children":1351},{"className":1350},[],[1352],{"type":55,"value":1353},"ad-hoc",{"type":55,"value":715},{"type":49,"tag":326,"props":1356,"children":1358},{"className":1357},[],[1359],{"type":55,"value":1360},"prod",{"type":55,"value":1362},". Within ad-hoc and production, there are two directories ",{"type":49,"tag":326,"props":1364,"children":1366},{"className":1365},[],[1367],{"type":55,"value":1368},"base",{"type":55,"value":715},{"type":49,"tag":326,"props":1371,"children":1373},{"className":1372},[],[1374],{"type":55,"value":1375},"app",{"type":55,"value":745},{"type":49,"tag":58,"props":1378,"children":1379},{},[1380,1382,1388,1390,1395,1397,1402],{"type":55,"value":1381},"Each repo has a directory called ",{"type":49,"tag":326,"props":1383,"children":1385},{"className":1384},[],[1386],{"type":55,"value":1387},"internal",{"type":55,"value":1389}," which contain building blocks used by the ",{"type":49,"tag":326,"props":1391,"children":1393},{"className":1392},[],[1394],{"type":55,"value":457},{"type":55,"value":1396},"s that are exposed. The contents of the ",{"type":49,"tag":326,"props":1398,"children":1400},{"className":1399},[],[1401],{"type":55,"value":1387},{"type":55,"value":1403}," directories are not intended to be used by anyone who is using the libraries.",{"type":49,"tag":58,"props":1405,"children":1406},{},[1407],{"type":49,"tag":72,"props":1408,"children":1409},{},[1410],{"type":55,"value":1411},"CDK construct library repo structure",{"type":49,"tag":1050,"props":1413,"children":1415},{"code":1414},"~/git/github/cdk-django$ tree -L 4 -d src/\nsrc/\nâââ constructs\nâ   âââ ad-hoc\nâ   â   âââ app\nâ   â   âââ base\nâ   âââ internal\nâ   â   âââ alb\nâ   â   âââ bastion\nâ   â   âââ customResources\nâ   â   â   âââ highestPriorityRule\nâ   â   âââ ecs\nâ   â   â   âââ iam\nâ   â   â   âââ management-command\nâ   â   â   âââ redis\nâ   â   â   âââ scheduler\nâ   â   â   âââ web\nâ   â   â   âââ worker\nâ   â   âââ rds\nâ   â   âââ sg\nâ   â   âââ vpc\nâ   âââ prod\nâ       âââ app\nâ       âââ base\nâââ examples\n    âââ ad-hoc\n        âââ app\n        â   âââ config\n        âââ base\n            âââ config\n",[1416],{"type":49,"tag":326,"props":1417,"children":1418},{"__ignoreMap":8},[1419],{"type":55,"value":1414},{"type":49,"tag":58,"props":1421,"children":1422},{},[1423],{"type":49,"tag":72,"props":1424,"children":1425},{},[1426],{"type":55,"value":1427},"Terraform module library repo structure",{"type":49,"tag":1050,"props":1429,"children":1431},{"code":1430},"~/git/github/terraform-aws-django$ tree -L 4 -d modules\nmodules\nâââ ad-hoc\nâ   âââ app\nâ   âââ base\nâââ internal\nâ   âââ alb\nâ   âââ autoscaling\nâ   âââ bastion\nâ   âââ ecs\nâ   â   âââ ad-hoc\nâ   â   â   âââ celery_beat\nâ   â   â   âââ celery_worker\nâ   â   â   âââ cluster\nâ   â   â   âââ management_command\nâ   â   â   âââ redis\nâ   â   â   âââ web\nâ   â   âââ prod\nâ   â       âââ celery_beat\nâ   â       âââ celery_worker\nâ   â       âââ cluster\nâ   â       âââ management_command\nâ   â       âââ web\nâ   âââ elasticache\nâ   âââ iam\nâ   âââ rds\nâ   âââ route53\nâ   âââ s3\nâ   âââ sd\nâ   âââ sg\nâââ prod\n    âââ app\n    âââ base\n",[1432],{"type":49,"tag":326,"props":1433,"children":1434},{"__ignoreMap":8},[1435],{"type":55,"value":1430},{"type":49,"tag":58,"props":1437,"children":1438},{},[1439],{"type":49,"tag":72,"props":1440,"children":1441},{},[1442],{"type":55,"value":1443},"Pulumi component library repo structure",{"type":49,"tag":1050,"props":1445,"children":1447},{"code":1446},"~/git/github/pulumi-aws-django$ tree -L 3 src/\nsrc/\nâââ components\nâ   âââ ad-hoc\nâ   â   âââ README.md\nâ   â   âââ app\nâ   â   âââ base\nâ   âââ internal\nâ       âââ README.md\nâ       âââ alb\nâ       âââ bastion\nâ       âââ cw\nâ       âââ ecs\nâ       âââ iam\nâ       âââ rds\nâ       âââ sg\nâââ util\n    âââ index.ts\n    âââ taggable.ts\n",[1448],{"type":49,"tag":326,"props":1449,"children":1450},{"__ignoreMap":8},[1451],{"type":55,"value":1446},{"type":49,"tag":58,"props":1453,"children":1454},{},[1455],{"type":49,"tag":72,"props":1456,"children":1457},{},[1458],{"type":55,"value":1459},"Pulumi examples directory",{"type":49,"tag":1050,"props":1461,"children":1463},{"code":1462},"~/git/github/pulumi-aws-django$ tree -L 3 examples/\nexamples/\nâââ ad-hoc\n    âââ app\n    â   âââ Pulumi.alpha.yaml\n    â   âââ Pulumi.yaml\n    â   âââ index.ts\n    â   âââ node_modules\n    â   âââ package-lock.json\n    â   âââ package.json\n    â   âââ tsconfig.json\n    âââ base\n        âââ Pulumi.yaml\n        âââ bin\n        âââ index.ts\n        âââ package-lock.json\n        âââ package.json\n        âââ tsconfig.json\n",[1464],{"type":49,"tag":326,"props":1465,"children":1466},{"__ignoreMap":8},[1467],{"type":55,"value":1462},{"type":49,"tag":430,"props":1469,"children":1471},{"id":1470},"cloc",[1472],{"type":55,"value":1473},"CLOC",{"type":49,"tag":58,"props":1475,"children":1476},{},[1477,1479,1484],{"type":55,"value":1478},"Let's use CLOC (count lines of code) to compare the lines of code used in the ",{"type":49,"tag":326,"props":1480,"children":1482},{"className":1481},[],[1483],{"type":55,"value":457},{"type":55,"value":1485}," of CDK/CloudFormation/Terraform/Pulumi.",{"type":49,"tag":58,"props":1487,"children":1488},{},[1489],{"type":49,"tag":72,"props":1490,"children":1491},{},[1492],{"type":49,"tag":326,"props":1493,"children":1495},{"className":1494},[],[1496],{"type":55,"value":669},{"type":49,"tag":1050,"props":1498,"children":1500},{"code":1499},"~/git/github/cdk-django$ cloc src/constructs/\n      14 text files.\n      14 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            155             59            908\nPython                           1             18              8             33\n-------------------------------------------------------------------------------\nSUM:                            14            173             67            941\n-------------------------------------------------------------------------------\n",[1501],{"type":49,"tag":326,"props":1502,"children":1503},{"__ignoreMap":8},[1504],{"type":55,"value":1499},{"type":49,"tag":58,"props":1506,"children":1507},{},[1508],{"type":49,"tag":72,"props":1509,"children":1510},{},[1511],{"type":49,"tag":326,"props":1512,"children":1514},{"className":1513},[],[1515],{"type":55,"value":684},{"type":49,"tag":1050,"props":1517,"children":1519},{"code":1518},"~/git/github/terraform-aws-django$ cloc modules/\n      68 text files.\n      58 unique files.\n      11 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nHCL                             55            472            205           2390\nMarkdown                         3              7              0             20\n-------------------------------------------------------------------------------\nSUM:                            58            479            205           2410\n-------------------------------------------------------------------------------\n",[1520],{"type":49,"tag":326,"props":1521,"children":1522},{"__ignoreMap":8},[1523],{"type":55,"value":1518},{"type":49,"tag":58,"props":1525,"children":1526},{},[1527],{"type":49,"tag":72,"props":1528,"children":1529},{},[1530],{"type":49,"tag":326,"props":1531,"children":1533},{"className":1532},[],[1534],{"type":55,"value":699},{"type":49,"tag":1050,"props":1536,"children":1538},{"code":1537},"~/git/github/pulumi-aws-django$ cloc src/components/\n      15 text files.\n      15 unique files.\n       0 files ignored.\n\ngithub.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)\n-------------------------------------------------------------------------------\nLanguage                     files          blank        comment           code\n-------------------------------------------------------------------------------\nTypeScript                      13            110            176           1119\nMarkdown                         2              6              0             30\n-------------------------------------------------------------------------------\nSUM:                            15            116            176           1149\n-------------------------------------------------------------------------------\n",[1539],{"type":49,"tag":326,"props":1540,"children":1541},{"__ignoreMap":8},[1542],{"type":55,"value":1537},{"type":49,"tag":50,"props":1544,"children":1546},{"id":1545},"communities",[1547],{"type":55,"value":1548},"Communities",{"type":49,"tag":58,"props":1550,"children":1551},{},[1552],{"type":55,"value":1553},"The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!",{"type":49,"tag":64,"props":1555,"children":1556},{},[1557,1567,1577],{"type":49,"tag":68,"props":1558,"children":1559},{},[1560],{"type":49,"tag":80,"props":1561,"children":1564},{"href":1562,"rel":1563},"https://cdk.dev/",[84],[1565],{"type":55,"value":1566},"cdk.dev",{"type":49,"tag":68,"props":1568,"children":1569},{},[1570],{"type":49,"tag":80,"props":1571,"children":1574},{"href":1572,"rel":1573},"https://discuss.hashicorp.com/c/terraform-core/27",[84],[1575],{"type":55,"value":1576},"Terraform Section of HashiCorp Discuss Forum",{"type":49,"tag":68,"props":1578,"children":1579},{},[1580],{"type":49,"tag":80,"props":1581,"children":1584},{"href":1582,"rel":1583},"https://slack.pulumi.com/",[84],[1585],{"type":55,"value":1586},"Pulumi Slack",{"type":49,"tag":50,"props":1588,"children":1590},{"id":1589},"Î¼blog",[1591],{"type":55,"value":1589},{"type":49,"tag":58,"props":1593,"children":1594},{},[1595],{"type":55,"value":1596},"Î¼blog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:",{"type":49,"tag":58,"props":1598,"children":1599},{},[1600],{"type":49,"tag":1601,"props":1602,"children":1605},"img",{"alt":1603,"src":1604},"ublog","/static/ublog_screenshot.png",[],{"type":49,"tag":58,"props":1607,"children":1608},{},[1609],{"type":55,"value":1610},"It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts.",{"type":49,"tag":430,"props":1612,"children":1614},{"id":1613},"mono-repo-structure",[1615],{"type":55,"value":1616},"Mono-repo structure",{"type":49,"tag":58,"props":1618,"children":1619},{},[1620,1622,1628],{"type":55,"value":1621},"It lives in a GitHub mono repo called ",{"type":49,"tag":326,"props":1623,"children":1625},{"className":1624},[],[1626],{"type":55,"value":1627},"django-step-by-step",{"type":55,"value":1629},". This mono repo contains a few different things:",{"type":49,"tag":64,"props":1631,"children":1632},{},[1633,1638,1643,1665],{"type":49,"tag":68,"props":1634,"children":1635},{},[1636],{"type":55,"value":1637},"backend Django application",{"type":49,"tag":68,"props":1639,"children":1640},{},[1641],{"type":55,"value":1642},"frontend Vue.js application",{"type":49,"tag":68,"props":1644,"children":1645},{},[1646,1648,1653,1654,1659,1660],{"type":55,"value":1647},"IaC code that uses c/m/c from ",{"type":49,"tag":326,"props":1649,"children":1651},{"className":1650},[],[1652],{"type":55,"value":669},{"type":55,"value":873},{"type":49,"tag":326,"props":1655,"children":1657},{"className":1656},[],[1658],{"type":55,"value":684},{"type":55,"value":715},{"type":49,"tag":326,"props":1661,"children":1663},{"className":1662},[],[1664],{"type":55,"value":699},{"type":49,"tag":68,"props":1666,"children":1667},{},[1668],{"type":55,"value":1669},"GitHub Actions workflows for both Infrastructure deployments and application deployments",{"type":49,"tag":58,"props":1671,"children":1672},{},[1673],{"type":55,"value":1674},"Î¼blog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. Î¼blog is meant to represent a generic 12 Factor application that uses:",{"type":49,"tag":64,"props":1676,"children":1677},{},[1678,1683,1688,1693,1698,1703,1708,1713],{"type":49,"tag":68,"props":1679,"children":1680},{},[1681],{"type":55,"value":1682},"gunicorn for a backend API",{"type":49,"tag":68,"props":1684,"children":1685},{},[1686],{"type":55,"value":1687},"Vue.js for a client that consumes the backend API",{"type":49,"tag":68,"props":1689,"children":1690},{},[1691],{"type":55,"value":1692},"celery for async task processing",{"type":49,"tag":68,"props":1694,"children":1695},{},[1696],{"type":55,"value":1697},"celery beat for scheduling tasks",{"type":49,"tag":68,"props":1699,"children":1700},{},[1701],{"type":55,"value":1702},"Postgres for relational data",{"type":49,"tag":68,"props":1704,"children":1705},{},[1706],{"type":55,"value":1707},"Redis for caching and message brokering",{"type":49,"tag":68,"props":1709,"children":1710},{},[1711],{"type":55,"value":1712},"S3 for object storage",{"type":49,"tag":68,"props":1714,"children":1715},{},[1716],{"type":55,"value":1717},"Django admin for a simple admin interface",{"type":49,"tag":58,"props":1719,"children":1720},{},[1721],{"type":55,"value":1722},"There is a lot more I could add on Î¼blog. For now I'll just mention that it:",{"type":49,"tag":64,"props":1724,"children":1725},{},[1726,1731,1736,1741,1746],{"type":49,"tag":68,"props":1727,"children":1728},{},[1729],{"type":55,"value":1730},"has a great local development environment (supports both docker-compose and virtual environments)",{"type":49,"tag":68,"props":1732,"children":1733},{},[1734],{"type":55,"value":1735},"demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL.",{"type":49,"tag":68,"props":1737,"children":1738},{},[1739],{"type":55,"value":1740},"GitHub Actions for running unit tests",{"type":49,"tag":68,"props":1742,"children":1743},{},[1744],{"type":55,"value":1745},"k6 for load testing",{"type":49,"tag":68,"props":1747,"children":1748},{},[1749,1751],{"type":55,"value":1750},"contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: ",{"type":49,"tag":80,"props":1752,"children":1754},{"href":135,"rel":1753},[84],[1755],{"type":55,"value":135},{"type":49,"tag":1757,"props":1758,"children":1760},"h1",{"id":1759},"infrastructure-deep-dive",[1761],{"type":55,"value":1762},"Infrastructure Deep Dive",{"type":49,"tag":58,"props":1764,"children":1765},{},[1766,1768,1773],{"type":55,"value":1767},"Let's go through each of the ",{"type":49,"tag":326,"props":1769,"children":1771},{"className":1770},[],[1772],{"type":55,"value":457},{"type":55,"value":1774},"s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi.",{"type":49,"tag":58,"props":1776,"children":1777},{},[1778,1780,1785,1786,1791,1793,1798,1799,1804],{"type":55,"value":1779},"I'll first talk about the two stacks used in ad hoc environments: ",{"type":49,"tag":326,"props":1781,"children":1783},{"className":1782},[],[1784],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1787,"children":1789},{"className":1788},[],[1790],{"type":55,"value":1375},{"type":55,"value":1792},". Then I'll talk about the prod environments which are also composed of ",{"type":49,"tag":326,"props":1794,"children":1796},{"className":1795},[],[1797],{"type":55,"value":1368},{"type":55,"value":715},{"type":49,"tag":326,"props":1800,"children":1802},{"className":1801},[],[1803],{"type":55,"value":1375},{"type":55,"value":1805}," stacks.",{"type":49,"tag":58,"props":1807,"children":1808},{},[1809,1811,1816],{"type":55,"value":1810},"Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, ",{"type":49,"tag":72,"props":1812,"children":1813},{},[1814],{"type":55,"value":1815},"especially with Terraform",{"type":55,"value":1817},". In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried).",{"type":49,"tag":50,"props":1819,"children":1821},{"id":1820},"splitting-up-the-stacks",[1822],{"type":55,"value":1823},"Splitting up the stacks",{"type":49,"tag":58,"props":1825,"children":1826},{},[1827],{"type":55,"value":1828},"While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so.",{"type":49,"tag":64,"props":1830,"children":1831},{},[1832,1843,1855],{"type":49,"tag":68,"props":1833,"children":1834},{},[1835,1837],{"type":55,"value":1836},"Terraform enables this with outputs and ",{"type":49,"tag":326,"props":1838,"children":1840},{"className":1839},[],[1841],{"type":55,"value":1842},"terraform_remote_state",{"type":49,"tag":68,"props":1844,"children":1845},{},[1846,1848],{"type":55,"value":1847},"Pulumi encourages the use of ",{"type":49,"tag":80,"props":1849,"children":1852},{"href":1850,"rel":1851},"https://www.pulumi.com/docs/guides/organizing-projects-stacks/",[84],[1853],{"type":55,"value":1854},"micro stacks",{"type":49,"tag":68,"props":1856,"children":1857},{},[1858,1860],{"type":55,"value":1859},"CDK has an article on how to ",{"type":49,"tag":80,"props":1861,"children":1864},{"href":1862,"rel":1863},"https://docs.aws.amazon.com/cdk/v2/guide/stack_how_to_create_multiple_stacks.html",[84],[1865],{"type":55,"value":1866},"create an app with multiple stacks",{"type":49,"tag":58,"props":1868,"children":1869},{},[1870],{"type":55,"value":1871},"My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack.",{"type":49,"tag":58,"props":1873,"children":1874},{},[1875],{"type":55,"value":1876},"Also, on-demand environments really lends itself to stacks that are split up.",{"type":49,"tag":58,"props":1878,"children":1879},{},[1880,1882,1889],{"type":55,"value":1881},"In the section ",{"type":49,"tag":80,"props":1883,"children":1886},{"href":1884,"rel":1885},"https://docs.aws.amazon.com/cdk/v2/guide/resources.html",[84],[1887],{"type":55,"value":1888},"\"Passing unique identifiers\"",{"type":55,"value":1890},", the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app.",{"type":49,"tag":58,"props":1892,"children":1893},{},[1894,1896,1901,1903,1908,1910,1915,1917,1923,1924,1930,1932,1937,1939,1945,1946,1952,1953,1959],{"type":55,"value":1895},"There is a balance to be found between single stacks vs micro stacks. Both the base and app ",{"type":49,"tag":326,"props":1897,"children":1899},{"className":1898},[],[1900],{"type":55,"value":457},{"type":55,"value":1902},"s could be split out further. For example, the ",{"type":49,"tag":326,"props":1904,"children":1906},{"className":1905},[],[1907],{"type":55,"value":1368},{"type":55,"value":1909}," ",{"type":49,"tag":326,"props":1911,"children":1913},{"className":1912},[],[1914],{"type":55,"value":457},{"type":55,"value":1916},"s could be split into ",{"type":49,"tag":326,"props":1918,"children":1920},{"className":1919},[],[1921],{"type":55,"value":1922},"networking",{"type":55,"value":715},{"type":49,"tag":326,"props":1925,"children":1927},{"className":1926},[],[1928],{"type":55,"value":1929},"rds",{"type":55,"value":1931},". The ",{"type":49,"tag":326,"props":1933,"children":1935},{"className":1934},[],[1936],{"type":55,"value":1375},{"type":55,"value":1938}," stack could be split into different ECS services so that their infrastructure can be deployed independently, like ",{"type":49,"tag":326,"props":1940,"children":1942},{"className":1941},[],[1943],{"type":55,"value":1944},"cluster",{"type":55,"value":873},{"type":49,"tag":326,"props":1947,"children":1949},{"className":1948},[],[1950],{"type":55,"value":1951},"backend",{"type":55,"value":715},{"type":49,"tag":326,"props":1954,"children":1956},{"className":1955},[],[1957],{"type":55,"value":1958},"frontend",{"type":55,"value":1960},". The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article.",{"type":49,"tag":58,"props":1962,"children":1963},{},[1964],{"type":55,"value":1965},"My rules of thumbs are:",{"type":49,"tag":64,"props":1967,"children":1968},{},[1969,1974],{"type":49,"tag":68,"props":1970,"children":1971},{},[1972],{"type":55,"value":1973},"single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change",{"type":49,"tag":68,"props":1975,"children":1976},{},[1977],{"type":55,"value":1978},"Lots of small stacks can cause overhead and make things more complex than they need to be",{"type":49,"tag":50,"props":1980,"children":1982},{"id":1981},"ad-hoc-base-overview",[1983],{"type":55,"value":1984},"Ad hoc base overview",{"type":49,"tag":58,"props":1986,"children":1987},{},[1988],{"type":55,"value":1989},"Here's an overview of the resources used in an ad hoc base environment.",{"type":49,"tag":64,"props":1991,"children":1992},{},[1993,1998,2003,2008,2013,2018,2023,2028],{"type":49,"tag":68,"props":1994,"children":1995},{},[1996],{"type":55,"value":1997},"(Inputs)",{"type":49,"tag":68,"props":1999,"children":2000},{},[2001],{"type":55,"value":2002},"(Optional environment configs)",{"type":49,"tag":68,"props":2004,"children":2005},{},[2006],{"type":55,"value":2007},"VPC and Service Discovery",{"type":49,"tag":68,"props":2009,"children":2010},{},[2011],{"type":55,"value":2012},"S3",{"type":49,"tag":68,"props":2014,"children":2015},{},[2016],{"type":55,"value":2017},"Security Groups",{"type":49,"tag":68,"props":2019,"children":2020},{},[2021],{"type":55,"value":2022},"Load Balancer",{"type":49,"tag":68,"props":2024,"children":2025},{},[2026],{"type":55,"value":2027},"RDS",{"type":49,"tag":68,"props":2029,"children":2030},{},[2031],{"type":55,"value":2032},"Bastion Host",{"type":49,"tag":430,"props":2034,"children":2036},{"id":2035},"visualization",[2037],{"type":55,"value":2038},"Visualization",{"type":49,"tag":58,"props":2040,"children":2041},{},[2042,2044,2050],{"type":55,"value":2043},"Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the ",{"type":49,"tag":326,"props":2045,"children":2047},{"className":2046},[],[2048],{"type":55,"value":2049},"Resources",{"type":55,"value":2051}," tab of the ad hoc base stack in the Pulumi console.",{"type":49,"tag":58,"props":2053,"children":2054},{},[2055],{"type":49,"tag":1601,"props":2056,"children":2059},{"alt":2057,"src":2058},"Graph view of ad hoc base infrastructure","/static/pulumi_ad_hoc_base_dep_graph.png",[],{"type":49,"tag":430,"props":2061,"children":2063},{"id":2062},"inputs",[2064],{"type":55,"value":2065},"Inputs",{"type":49,"tag":58,"props":2067,"children":2068},{},[2069],{"type":55,"value":2070},"There are only two required inputs for the ad hoc base stack",{"type":49,"tag":64,"props":2072,"children":2073},{},[2074,2079],{"type":49,"tag":68,"props":2075,"children":2076},{},[2077],{"type":55,"value":2078},"ACM certificate ARN",{"type":49,"tag":68,"props":2080,"children":2081},{},[2082],{"type":55,"value":2083},"Domain Name",{"type":49,"tag":58,"props":2085,"children":2086},{},[2087],{"type":55,"value":2088},"I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy/apply/up or synth/plan/preview.",{"type":49,"tag":430,"props":2090,"children":2092},{"id":2091},"vpc",[2093],{"type":55,"value":2094},"VPC",{"type":49,"tag":58,"props":2096,"children":2097},{},[2098,2100,2105],{"type":55,"value":2099},"The VPC is the first resource that is created as part of the ",{"type":49,"tag":326,"props":2101,"children":2103},{"className":2102},[],[2104],{"type":55,"value":1368},{"type":55,"value":2106}," stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources.",{"type":49,"tag":64,"props":2108,"children":2109},{},[2110,2121,2132],{"type":49,"tag":68,"props":2111,"children":2112},{},[2113,2119],{"type":49,"tag":326,"props":2114,"children":2116},{"className":2115},[],[2117],{"type":55,"value":2118},"awsx",{"type":55,"value":2120}," has a VPC module",{"type":49,"tag":68,"props":2122,"children":2123},{},[2124,2130],{"type":49,"tag":326,"props":2125,"children":2127},{"className":2126},[],[2128],{"type":55,"value":2129},"terraform-aws-vpc",{"type":55,"value":2131}," module",{"type":49,"tag":68,"props":2133,"children":2134},{},[2135],{"type":55,"value":2136},"L2 VPC Construct in CDK",{"type":49,"tag":58,"props":2138,"children":2139},{},[2140,2142,2148,2150,2156],{"type":55,"value":2141},"The setting in the Terraform VPC module ",{"type":49,"tag":326,"props":2143,"children":2145},{"className":2144},[],[2146],{"type":55,"value":2147},"one_nat_gateway_per_az = false",{"type":55,"value":2149}," doesn't seem to exist on the ",{"type":49,"tag":326,"props":2151,"children":2153},{"className":2152},[],[2154],{"type":55,"value":2155},"awsx.ec2.Vpc",{"type":55,"value":2157}," module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3.",{"type":49,"tag":430,"props":2159,"children":2161},{"id":2160},"security-groups",[2162],{"type":55,"value":2017},{"type":49,"tag":58,"props":2164,"children":2165},{},[2166],{"type":55,"value":2167},"Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups.",{"type":49,"tag":1050,"props":2169,"children":2173},{"code":2170,"language":2171,"meta":8,"className":2172,"style":8},"    const albSecurityGroup = new SecurityGroup(scope, 'AlbSecurityGroup', {\n      vpc: props.vpc,\n    });\n\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(443), 'HTTPS');\n    albSecurityGroup.addIngressRule(Peer.anyIpv4(), Port.tcp(80), 'HTTP');\n","ts","language-ts shiki shiki-themes github-light github-dark monokai",[2174],{"type":49,"tag":326,"props":2175,"children":2176},{"__ignoreMap":8},[2177,2224,2232,2240,2247,2306],{"type":49,"tag":1060,"props":2178,"children":2179},{"class":1062,"line":1063},[2180,2186,2192,2198,2203,2208,2213,2219],{"type":49,"tag":1060,"props":2181,"children":2183},{"style":2182},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[2184],{"type":55,"value":2185},"    const",{"type":49,"tag":1060,"props":2187,"children":2189},{"style":2188},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[2190],{"type":55,"value":2191}," albSecurityGroup",{"type":49,"tag":1060,"props":2193,"children":2195},{"style":2194},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[2196],{"type":55,"value":2197}," =",{"type":49,"tag":1060,"props":2199,"children":2200},{"style":2194},[2201],{"type":55,"value":2202}," new",{"type":49,"tag":1060,"props":2204,"children":2205},{"style":1067},[2206],{"type":55,"value":2207}," SecurityGroup",{"type":49,"tag":1060,"props":2209,"children":2210},{"style":1073},[2211],{"type":55,"value":2212},"(scope, ",{"type":49,"tag":1060,"props":2214,"children":2216},{"style":2215},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[2217],{"type":55,"value":2218},"'AlbSecurityGroup'",{"type":49,"tag":1060,"props":2220,"children":2221},{"style":1073},[2222],{"type":55,"value":2223},", {\n",{"type":49,"tag":1060,"props":2225,"children":2226},{"class":1062,"line":1079},[2227],{"type":49,"tag":1060,"props":2228,"children":2229},{"style":1073},[2230],{"type":55,"value":2231},"      vpc: props.vpc,\n",{"type":49,"tag":1060,"props":2233,"children":2234},{"class":1062,"line":1088},[2235],{"type":49,"tag":1060,"props":2236,"children":2237},{"style":1073},[2238],{"type":55,"value":2239},"    });\n",{"type":49,"tag":1060,"props":2241,"children":2242},{"class":1062,"line":1097},[2243],{"type":49,"tag":1060,"props":2244,"children":2245},{"emptyLinePlaceholder":44},[2246],{"type":55,"value":1094},{"type":49,"tag":1060,"props":2248,"children":2249},{"class":1062,"line":1111},[2250,2255,2260,2265,2270,2275,2280,2285,2291,2296,2301],{"type":49,"tag":1060,"props":2251,"children":2252},{"style":1073},[2253],{"type":55,"value":2254},"    albSecurityGroup.",{"type":49,"tag":1060,"props":2256,"children":2257},{"style":1067},[2258],{"type":55,"value":2259},"addIngressRule",{"type":49,"tag":1060,"props":2261,"children":2262},{"style":1073},[2263],{"type":55,"value":2264},"(Peer.",{"type":49,"tag":1060,"props":2266,"children":2267},{"style":1067},[2268],{"type":55,"value":2269},"anyIpv4",{"type":49,"tag":1060,"props":2271,"children":2272},{"style":1073},[2273],{"type":55,"value":2274},"(), Port.",{"type":49,"tag":1060,"props":2276,"children":2277},{"style":1067},[2278],{"type":55,"value":2279},"tcp",{"type":49,"tag":1060,"props":2281,"children":2282},{"style":1073},[2283],{"type":55,"value":2284},"(",{"type":49,"tag":1060,"props":2286,"children":2288},{"style":2287},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2289],{"type":55,"value":2290},"443",{"type":49,"tag":1060,"props":2292,"children":2293},{"style":1073},[2294],{"type":55,"value":2295},"), ",{"type":49,"tag":1060,"props":2297,"children":2298},{"style":2215},[2299],{"type":55,"value":2300},"'HTTPS'",{"type":49,"tag":1060,"props":2302,"children":2303},{"style":1073},[2304],{"type":55,"value":2305},");\n",{"type":49,"tag":1060,"props":2307,"children":2308},{"class":1062,"line":1120},[2309,2313,2317,2321,2325,2329,2333,2337,2342,2346,2351],{"type":49,"tag":1060,"props":2310,"children":2311},{"style":1073},[2312],{"type":55,"value":2254},{"type":49,"tag":1060,"props":2314,"children":2315},{"style":1067},[2316],{"type":55,"value":2259},{"type":49,"tag":1060,"props":2318,"children":2319},{"style":1073},[2320],{"type":55,"value":2264},{"type":49,"tag":1060,"props":2322,"children":2323},{"style":1067},[2324],{"type":55,"value":2269},{"type":49,"tag":1060,"props":2326,"children":2327},{"style":1073},[2328],{"type":55,"value":2274},{"type":49,"tag":1060,"props":2330,"children":2331},{"style":1067},[2332],{"type":55,"value":2279},{"type":49,"tag":1060,"props":2334,"children":2335},{"style":1073},[2336],{"type":55,"value":2284},{"type":49,"tag":1060,"props":2338,"children":2339},{"style":2287},[2340],{"type":55,"value":2341},"80",{"type":49,"tag":1060,"props":2343,"children":2344},{"style":1073},[2345],{"type":55,"value":2295},{"type":49,"tag":1060,"props":2347,"children":2348},{"style":2215},[2349],{"type":55,"value":2350},"'HTTP'",{"type":49,"tag":1060,"props":2352,"children":2353},{"style":1073},[2354],{"type":55,"value":2305},{"type":49,"tag":430,"props":2356,"children":2358},{"id":2357},"load-balancer-resources",[2359],{"type":55,"value":2360},"Load Balancer Resources",{"type":49,"tag":58,"props":2362,"children":2363},{},[2364],{"type":55,"value":2365},"There's not much to comment on here. In each library I have resource group that defines the following:",{"type":49,"tag":64,"props":2367,"children":2368},{},[2369,2374,2379,2384],{"type":49,"tag":68,"props":2370,"children":2371},{},[2372],{"type":55,"value":2373},"Application Load Balancer",{"type":49,"tag":68,"props":2375,"children":2376},{},[2377],{"type":55,"value":2378},"A default target group",{"type":49,"tag":68,"props":2380,"children":2381},{},[2382],{"type":55,"value":2383},"An HTTP listener that redirects to HTTPS",{"type":49,"tag":68,"props":2385,"children":2386},{},[2387],{"type":55,"value":2388},"An HTTPS listener with a default \"fixed-response\" action",{"type":49,"tag":58,"props":2390,"children":2391},{},[2392],{"type":55,"value":2393},"Properties from these resources are used in the \"app\" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services.",{"type":49,"tag":58,"props":2395,"children":2396},{},[2397],{"type":55,"value":2398},"Ad hoc app environments all share a common load balancer from the base stack that they use.",{"type":49,"tag":430,"props":2400,"children":2402},{"id":2401},"rds-resources",[2403],{"type":55,"value":2404},"RDS Resources",{"type":49,"tag":58,"props":2406,"children":2407},{},[2408,2410,2415],{"type":55,"value":2409},"All three libraries have the RDS security group and Subnet Group in the same ",{"type":49,"tag":326,"props":2411,"children":2413},{"className":2412},[],[2414],{"type":55,"value":457},{"type":55,"value":2416}," as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources.",{"type":49,"tag":58,"props":2418,"children":2419},{},[2420],{"type":55,"value":2421},"Currently the RDS resources are part of the \"base\" stack for each library. A future optimization may be to break the RDS instance out of the \"base\" stack and put it in its own stack. The \"RDS\" stack would be dependent on the \"base\" stack, and then \"app\" stack would then be dependent on both the \"base\" stack and the \"RDS\" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the \"micro stacks\" approach limited to only 2 stacks for an environment.",{"type":49,"tag":58,"props":2423,"children":2424},{},[2425],{"type":55,"value":2426},"The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently \"hardcoding\" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential.",{"type":49,"tag":1050,"props":2428,"children":2430},{"code":2429,"language":2171,"meta":8,"className":2172,"style":8},"    const secret = new Secret(scope, 'dbSecret', {\n      secretName: props.dbSecretName,\n      description: 'secret for rds',\n      generateSecretString: {\n        secretStringTemplate: JSON.stringify({ username: 'postgres' }),\n        generateStringKey: 'password',\n        excludePunctuation: true,\n        includeSpace: false,\n      },\n    });\n",[2431],{"type":49,"tag":326,"props":2432,"children":2433},{"__ignoreMap":8},[2434,2472,2480,2498,2506,2543,2560,2577,2594,2602],{"type":49,"tag":1060,"props":2435,"children":2436},{"class":1062,"line":1063},[2437,2441,2446,2450,2454,2459,2463,2468],{"type":49,"tag":1060,"props":2438,"children":2439},{"style":2182},[2440],{"type":55,"value":2185},{"type":49,"tag":1060,"props":2442,"children":2443},{"style":2188},[2444],{"type":55,"value":2445}," secret",{"type":49,"tag":1060,"props":2447,"children":2448},{"style":2194},[2449],{"type":55,"value":2197},{"type":49,"tag":1060,"props":2451,"children":2452},{"style":2194},[2453],{"type":55,"value":2202},{"type":49,"tag":1060,"props":2455,"children":2456},{"style":1067},[2457],{"type":55,"value":2458}," Secret",{"type":49,"tag":1060,"props":2460,"children":2461},{"style":1073},[2462],{"type":55,"value":2212},{"type":49,"tag":1060,"props":2464,"children":2465},{"style":2215},[2466],{"type":55,"value":2467},"'dbSecret'",{"type":49,"tag":1060,"props":2469,"children":2470},{"style":1073},[2471],{"type":55,"value":2223},{"type":49,"tag":1060,"props":2473,"children":2474},{"class":1062,"line":1079},[2475],{"type":49,"tag":1060,"props":2476,"children":2477},{"style":1073},[2478],{"type":55,"value":2479},"      secretName: props.dbSecretName,\n",{"type":49,"tag":1060,"props":2481,"children":2482},{"class":1062,"line":1088},[2483,2488,2493],{"type":49,"tag":1060,"props":2484,"children":2485},{"style":1073},[2486],{"type":55,"value":2487},"      description: ",{"type":49,"tag":1060,"props":2489,"children":2490},{"style":2215},[2491],{"type":55,"value":2492},"'secret for rds'",{"type":49,"tag":1060,"props":2494,"children":2495},{"style":1073},[2496],{"type":55,"value":2497},",\n",{"type":49,"tag":1060,"props":2499,"children":2500},{"class":1062,"line":1097},[2501],{"type":49,"tag":1060,"props":2502,"children":2503},{"style":1073},[2504],{"type":55,"value":2505},"      generateSecretString: {\n",{"type":49,"tag":1060,"props":2507,"children":2508},{"class":1062,"line":1111},[2509,2514,2519,2523,2528,2533,2538],{"type":49,"tag":1060,"props":2510,"children":2511},{"style":1073},[2512],{"type":55,"value":2513},"        secretStringTemplate: ",{"type":49,"tag":1060,"props":2515,"children":2516},{"style":2188},[2517],{"type":55,"value":2518},"JSON",{"type":49,"tag":1060,"props":2520,"children":2521},{"style":1073},[2522],{"type":55,"value":745},{"type":49,"tag":1060,"props":2524,"children":2525},{"style":1067},[2526],{"type":55,"value":2527},"stringify",{"type":49,"tag":1060,"props":2529,"children":2530},{"style":1073},[2531],{"type":55,"value":2532},"({ username: ",{"type":49,"tag":1060,"props":2534,"children":2535},{"style":2215},[2536],{"type":55,"value":2537},"'postgres'",{"type":49,"tag":1060,"props":2539,"children":2540},{"style":1073},[2541],{"type":55,"value":2542}," }),\n",{"type":49,"tag":1060,"props":2544,"children":2545},{"class":1062,"line":1120},[2546,2551,2556],{"type":49,"tag":1060,"props":2547,"children":2548},{"style":1073},[2549],{"type":55,"value":2550},"        generateStringKey: ",{"type":49,"tag":1060,"props":2552,"children":2553},{"style":2215},[2554],{"type":55,"value":2555},"'password'",{"type":49,"tag":1060,"props":2557,"children":2558},{"style":1073},[2559],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2561,"children":2562},{"class":1062,"line":1128},[2563,2568,2573],{"type":49,"tag":1060,"props":2564,"children":2565},{"style":1073},[2566],{"type":55,"value":2567},"        excludePunctuation: ",{"type":49,"tag":1060,"props":2569,"children":2570},{"style":2287},[2571],{"type":55,"value":2572},"true",{"type":49,"tag":1060,"props":2574,"children":2575},{"style":1073},[2576],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2578,"children":2579},{"class":1062,"line":1141},[2580,2585,2590],{"type":49,"tag":1060,"props":2581,"children":2582},{"style":1073},[2583],{"type":55,"value":2584},"        includeSpace: ",{"type":49,"tag":1060,"props":2586,"children":2587},{"style":2287},[2588],{"type":55,"value":2589},"false",{"type":49,"tag":1060,"props":2591,"children":2592},{"style":1073},[2593],{"type":55,"value":2497},{"type":49,"tag":1060,"props":2595,"children":2596},{"class":1062,"line":1150},[2597],{"type":49,"tag":1060,"props":2598,"children":2599},{"style":1073},[2600],{"type":55,"value":2601},"      },\n",{"type":49,"tag":1060,"props":2603,"children":2604},{"class":1062,"line":1158},[2605],{"type":49,"tag":1060,"props":2606,"children":2607},{"style":1073},[2608],{"type":55,"value":2239},{"type":49,"tag":58,"props":2610,"children":2611},{},[2612,2614,2620],{"type":55,"value":2613},"In the ",{"type":49,"tag":326,"props":2615,"children":2617},{"className":2616},[],[2618],{"type":55,"value":2619},"DatabaseInstance",{"type":55,"value":2621}," props we can then use this secret like so:",{"type":49,"tag":1050,"props":2623,"children":2625},{"code":2624},"    credentials: Credentials.fromSecret(secret),\n",[2626],{"type":49,"tag":326,"props":2627,"children":2628},{"__ignoreMap":8},[2629],{"type":55,"value":2624},{"type":49,"tag":58,"props":2631,"children":2632},{},[2633,2635,2641],{"type":55,"value":2634},"In the application deployed with CDK, I use a Django settings module package that uses a package called ",{"type":49,"tag":326,"props":2636,"children":2638},{"className":2637},[],[2639],{"type":55,"value":2640},"aws_secretsmanager_caching",{"type":55,"value":2642}," to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable.",{"type":49,"tag":58,"props":2644,"children":2645},{},[2646,2648,2654,2656,2667,2668,2679],{"type":55,"value":2647},"The Terraform and Pulumi database instance arguments simply accept a ",{"type":49,"tag":326,"props":2649,"children":2651},{"className":2650},[],[2652],{"type":55,"value":2653},"password",{"type":55,"value":2655}," field. This will be another item for the backlog for Terraform and Pulumi. The ",{"type":49,"tag":80,"props":2657,"children":2660},{"href":2658,"rel":2659},"https://www.pulumi.com/registry/packages/random/api-docs/randompassword/",[84],[2661],{"type":49,"tag":326,"props":2662,"children":2664},{"className":2663},[],[2665],{"type":55,"value":2666},"randompassword",{"type":55,"value":715},{"type":49,"tag":80,"props":2669,"children":2672},{"href":2670,"rel":2671},"https://www.pulumi.com/registry/packages/aws/api-docs/secretsmanager/secretversion/",[84],[2673],{"type":49,"tag":326,"props":2674,"children":2676},{"className":2675},[],[2677],{"type":55,"value":2678},"secretversion",{"type":55,"value":2680}," components can be used to do this.",{"type":49,"tag":430,"props":2682,"children":2684},{"id":2683},"bastion-host",[2685],{"type":55,"value":2032},{"type":49,"tag":58,"props":2687,"children":2688},{},[2689],{"type":55,"value":2690},"There are two main use cases for the bastion host in ad-hoc environments.",{"type":49,"tag":64,"props":2692,"children":2693},{},[2694,2707],{"type":49,"tag":68,"props":2695,"children":2696},{},[2697,2699,2705],{"type":55,"value":2698},"When creating a new ad hoc app environment, the bastion host is used to create a new database called ",{"type":49,"tag":326,"props":2700,"children":2702},{"className":2701},[],[2703],{"type":55,"value":2704},"{ad-hoc-env-name}-db",{"type":55,"value":2706}," that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now).",{"type":49,"tag":68,"props":2708,"children":2709},{},[2710,2712,2718],{"type":55,"value":2711},"If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to ",{"type":49,"tag":326,"props":2713,"children":2715},{"className":2714},[],[2716],{"type":55,"value":2717},"localhost:5432",{"type":55,"value":2719}," on your local machine.",{"type":49,"tag":58,"props":2721,"children":2722},{},[2723],{"type":55,"value":2724},"You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:",{"type":49,"tag":1050,"props":2726,"children":2730},{"code":2727,"language":2728,"meta":8,"className":2729,"style":8},"aws ssm start-session --target $INSTANCE_ID\n","bash","language-bash shiki shiki-themes github-light github-dark monokai",[2731],{"type":49,"tag":326,"props":2732,"children":2733},{"__ignoreMap":8},[2734],{"type":49,"tag":1060,"props":2735,"children":2736},{"class":1062,"line":1063},[2737,2741,2746,2751,2756],{"type":49,"tag":1060,"props":2738,"children":2739},{"style":1067},[2740],{"type":55,"value":20},{"type":49,"tag":1060,"props":2742,"children":2743},{"style":2215},[2744],{"type":55,"value":2745}," ssm",{"type":49,"tag":1060,"props":2747,"children":2748},{"style":2215},[2749],{"type":55,"value":2750}," start-session",{"type":49,"tag":1060,"props":2752,"children":2753},{"style":2287},[2754],{"type":55,"value":2755}," --target",{"type":49,"tag":1060,"props":2757,"children":2758},{"style":1073},[2759],{"type":55,"value":2760}," $INSTANCE_ID\n",{"type":49,"tag":430,"props":2762,"children":2764},{"id":2763},"outputs",[2765],{"type":55,"value":2766},"Outputs",{"type":49,"tag":58,"props":2768,"children":2769},{},[2770],{"type":55,"value":2771},"Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:",{"type":49,"tag":64,"props":2773,"children":2774},{},[2775,2780,2785,2790,2795,2800,2805,2810,2815,2820],{"type":49,"tag":68,"props":2776,"children":2777},{},[2778],{"type":55,"value":2779},"vpc_id",{"type":49,"tag":68,"props":2781,"children":2782},{},[2783],{"type":55,"value":2784},"assets_bucket_name",{"type":49,"tag":68,"props":2786,"children":2787},{},[2788],{"type":55,"value":2789},"private_subnet_ids",{"type":49,"tag":68,"props":2791,"children":2792},{},[2793],{"type":55,"value":2794},"app_sg_id",{"type":49,"tag":68,"props":2796,"children":2797},{},[2798],{"type":55,"value":2799},"alb_sg_id",{"type":49,"tag":68,"props":2801,"children":2802},{},[2803],{"type":55,"value":2804},"listener_arn",{"type":49,"tag":68,"props":2806,"children":2807},{},[2808],{"type":55,"value":2809},"alb_dns_name",{"type":49,"tag":68,"props":2811,"children":2812},{},[2813],{"type":55,"value":2814},"task_role_arn",{"type":49,"tag":68,"props":2816,"children":2817},{},[2818],{"type":55,"value":2819},"execution_role_arn",{"type":49,"tag":68,"props":2821,"children":2822},{},[2823],{"type":55,"value":2824},"rds_address",{"type":49,"tag":58,"props":2826,"children":2827},{},[2828,2830,2836,2837,2843,2845,2850],{"type":55,"value":2829},"In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like ",{"type":49,"tag":326,"props":2831,"children":2833},{"className":2832},[],[2834],{"type":55,"value":2835},"Vpc",{"type":55,"value":715},{"type":49,"tag":326,"props":2838,"children":2840},{"className":2839},[],[2841],{"type":55,"value":2842},"RdsInstance",{"type":55,"value":2844},". More on this later in the following section ",{"type":49,"tag":72,"props":2846,"children":2847},{},[2848],{"type":55,"value":2849},"Passing data between stacks",{"type":55,"value":745},{"type":49,"tag":50,"props":2852,"children":2854},{"id":2853},"ad-hoc-app-overview",[2855],{"type":55,"value":2856},"Ad hoc app overview",{"type":49,"tag":58,"props":2858,"children":2859},{},[2860],{"type":55,"value":2861},"The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc.",{"type":49,"tag":58,"props":2863,"children":2864},{},[2865],{"type":55,"value":2866},"This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console.",{"type":49,"tag":58,"props":2868,"children":2869},{},[2870],{"type":49,"tag":1601,"props":2871,"children":2874},{"alt":2872,"src":2873},"Graph view of ad hoc app infrastructure","/static/pulumi_ad_hoc_app_dep_graph.png",[],{"type":49,"tag":430,"props":2876,"children":2878},{"id":2877},"ecs-cluster",[2879],{"type":55,"value":2880},"ECS Cluster",{"type":49,"tag":64,"props":2882,"children":2883},{},[2884,2889],{"type":49,"tag":68,"props":2885,"children":2886},{},[2887],{"type":55,"value":2888},"This is a small component that defines both ECS Cluster and the default capacity providers",{"type":49,"tag":68,"props":2890,"children":2891},{},[2892,2894,2900,2902,2907],{"type":55,"value":2893},"It defaults to not using ",{"type":49,"tag":326,"props":2895,"children":2897},{"className":2896},[],[2898],{"type":55,"value":2899},"FARGATE_SPOT",{"type":55,"value":2901},"; ad hoc environments do use ",{"type":49,"tag":326,"props":2903,"children":2905},{"className":2904},[],[2906],{"type":55,"value":2899},{"type":55,"value":2908}," for cost savings",{"type":49,"tag":2910,"props":2911,"children":2912},"blockquote",{},[2913],{"type":49,"tag":58,"props":2914,"children":2915},{},[2916,2918,2925],{"type":55,"value":2917},"NOTE: defaultCapacityProviderStrategy on cluster not currently supported. (",{"type":49,"tag":80,"props":2919,"children":2922},{"href":2920,"rel":2921},"https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ecs.CapacityProviderStrategy.html",[84],[2923],{"type":55,"value":2924},"link",{"type":55,"value":616},{"type":49,"tag":430,"props":2927,"children":2929},{"id":2928},"shared-environment-variables",[2930],{"type":55,"value":2931},"Shared environment variables",{"type":49,"tag":58,"props":2933,"children":2934},{},[2935,2937,2942],{"type":55,"value":2936},"The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource ",{"type":49,"tag":326,"props":2938,"children":2940},{"className":2939},[],[2941],{"type":55,"value":457},{"type":55,"value":2943},"s.",{"type":49,"tag":64,"props":2945,"children":2946},{},[2947,2975,2986,2997,3009],{"type":49,"tag":68,"props":2948,"children":2949},{},[2950,2952,2958,2960,2966,2968,2974],{"type":55,"value":2951},"I struggled to get this right in pulumi. A lot of Pulumi examples used ",{"type":49,"tag":326,"props":2953,"children":2955},{"className":2954},[],[2956],{"type":55,"value":2957},"JSON.stringify",{"type":55,"value":2959}," for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use ",{"type":49,"tag":326,"props":2961,"children":2963},{"className":2962},[],[2964],{"type":55,"value":2965},"pulumi.jsonStringify",{"type":55,"value":2967}," which was added in a relatively recent version of ",{"type":49,"tag":326,"props":2969,"children":2971},{"className":2970},[],[2972],{"type":55,"value":2973},"pulumi/pulumi",{"type":55,"value":745},{"type":49,"tag":68,"props":2976,"children":2977},{},[2978,2980],{"type":55,"value":2979},"CDK allows you to declare environment variables for a containerDefinition like ",{"type":49,"tag":326,"props":2981,"children":2983},{"className":2982},[],[2984],{"type":55,"value":2985},"{ FOO: \"bar\" }",{"type":49,"tag":68,"props":2987,"children":2988},{},[2989,2991],{"type":55,"value":2990},"Pulumi and Terraform require that values are passed like ",{"type":49,"tag":326,"props":2992,"children":2994},{"className":2993},[],[2995],{"type":55,"value":2996},"{ name: \"FOO\", value: \"bar\"}",{"type":49,"tag":68,"props":2998,"children":2999},{},[3000,3002,3007],{"type":55,"value":3001},"You could transform ",{"type":49,"tag":326,"props":3003,"children":3005},{"className":3004},[],[3006],{"type":55,"value":2985},{"type":55,"value":3008}," into the name/value format, but I didn't bother to do this",{"type":49,"tag":68,"props":3010,"children":3011},{},[3012,3014,3020],{"type":55,"value":3013},"extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the ",{"type":49,"tag":326,"props":3015,"children":3017},{"className":3016},[],[3018],{"type":55,"value":3019},"concat",{"type":55,"value":3021}," function to add these to the list of default environment variables.",{"type":49,"tag":58,"props":3023,"children":3024},{},[3025],{"type":55,"value":3026},"Here's what the code looks like for joining extra environment variables to the default environment variables:",{"type":49,"tag":1050,"props":3028,"children":3030},{"code":3029,"language":2171,"meta":8,"className":2172,"style":8},"    // CDK\n    if (extraEnvVars) {\n      environmentVariables = { ...extraEnvVars, ...environmentVariables };\n    }\n",[3031],{"type":49,"tag":326,"props":3032,"children":3033},{"__ignoreMap":8},[3034,3043,3056,3093],{"type":49,"tag":1060,"props":3035,"children":3036},{"class":1062,"line":1063},[3037],{"type":49,"tag":1060,"props":3038,"children":3040},{"style":3039},"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F",[3041],{"type":55,"value":3042},"    // CDK\n",{"type":49,"tag":1060,"props":3044,"children":3045},{"class":1062,"line":1079},[3046,3051],{"type":49,"tag":1060,"props":3047,"children":3048},{"style":2194},[3049],{"type":55,"value":3050},"    if",{"type":49,"tag":1060,"props":3052,"children":3053},{"style":1073},[3054],{"type":55,"value":3055}," (extraEnvVars) {\n",{"type":49,"tag":1060,"props":3057,"children":3058},{"class":1062,"line":1088},[3059,3064,3069,3074,3079,3084,3088],{"type":49,"tag":1060,"props":3060,"children":3061},{"style":1073},[3062],{"type":55,"value":3063},"      environmentVariables ",{"type":49,"tag":1060,"props":3065,"children":3066},{"style":2194},[3067],{"type":55,"value":3068},"=",{"type":49,"tag":1060,"props":3070,"children":3071},{"style":1073},[3072],{"type":55,"value":3073}," { ",{"type":49,"tag":1060,"props":3075,"children":3076},{"style":2194},[3077],{"type":55,"value":3078},"...",{"type":49,"tag":1060,"props":3080,"children":3081},{"style":1073},[3082],{"type":55,"value":3083},"extraEnvVars, ",{"type":49,"tag":1060,"props":3085,"children":3086},{"style":2194},[3087],{"type":55,"value":3078},{"type":49,"tag":1060,"props":3089,"children":3090},{"style":1073},[3091],{"type":55,"value":3092},"environmentVariables };\n",{"type":49,"tag":1060,"props":3094,"children":3095},{"class":1062,"line":1097},[3096],{"type":49,"tag":1060,"props":3097,"children":3098},{"style":1073},[3099],{"type":55,"value":3100},"    }\n",{"type":49,"tag":1050,"props":3102,"children":3104},{"code":3103},"    # terraform\n    env_vars = concat(local.env_vars, var.extra_env_vars)\n",[3105],{"type":49,"tag":326,"props":3106,"children":3107},{"__ignoreMap":8},[3108],{"type":55,"value":3103},{"type":49,"tag":1050,"props":3110,"children":3112},{"code":3111},"    // Pulumi\n    if (extraEnvVars) {\n      envVars = envVars.apply(x => x.concat(extraEnvVars!))\n    }\n",[3113],{"type":49,"tag":326,"props":3114,"children":3115},{"__ignoreMap":8},[3116],{"type":55,"value":3111},{"type":49,"tag":430,"props":3118,"children":3120},{"id":3119},"route53-record",[3121],{"type":55,"value":3122},"Route53 Record",{"type":49,"tag":58,"props":3124,"children":3125},{},[3126],{"type":55,"value":3127},"This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns.",{"type":49,"tag":58,"props":3129,"children":3130},{},[3131,3133,3139,3141,3147],{"type":55,"value":3132},"This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching ",{"type":49,"tag":326,"props":3134,"children":3136},{"className":3135},[],[3137],{"type":55,"value":3138},"example.com/api/*",{"type":55,"value":3140}," are routed to the backend API and all other requests matching ",{"type":49,"tag":326,"props":3142,"children":3144},{"className":3143},[],[3145],{"type":55,"value":3146},"example.com/*",{"type":55,"value":3148}," are routed to the frontend service.",{"type":49,"tag":430,"props":3150,"children":3152},{"id":3151},"redis",[3153],{"type":55,"value":3154},"Redis",{"type":49,"tag":58,"props":3156,"children":3157},{},[3158],{"type":55,"value":3159},"I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis.",{"type":49,"tag":58,"props":3161,"children":3162},{},[3163],{"type":55,"value":3164},"I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable.",{"type":49,"tag":430,"props":3166,"children":3168},{"id":3167},"web-service",[3169],{"type":55,"value":3170},"Web Service",{"type":49,"tag":58,"props":3172,"children":3173},{},[3174,3176,3181,3183,3189,3191,3197,3198,3204,3206,3212],{"type":55,"value":3175},"The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This ",{"type":49,"tag":326,"props":3177,"children":3179},{"className":3178},[],[3180],{"type":55,"value":457},{"type":55,"value":3182}," has an input parameter called ",{"type":49,"tag":326,"props":3184,"children":3186},{"className":3185},[],[3187],{"type":55,"value":3188},"pathPatterns",{"type":55,"value":3190}," which determines which paths it serves. For example, the API container may serve traffic for ",{"type":49,"tag":326,"props":3192,"children":3194},{"className":3193},[],[3195],{"type":55,"value":3196},"/api/*",{"type":55,"value":715},{"type":49,"tag":326,"props":3199,"children":3201},{"className":3200},[],[3202],{"type":55,"value":3203},"/admin/*",{"type":55,"value":3205}," only, or it may want to serve all traffic (",{"type":49,"tag":326,"props":3207,"children":3209},{"className":3208},[],[3210],{"type":55,"value":3211},"/*",{"type":55,"value":3213},").",{"type":49,"tag":58,"props":3215,"children":3216},{},[3217],{"type":55,"value":3218},"The way I use these components in ad hoc and prod environments is heavily opinionated in that:",{"type":49,"tag":64,"props":3220,"children":3221},{},[3222],{"type":49,"tag":68,"props":3223,"children":3224},{},[3225,3227,3232,3234,3239,3240,3245,3246,3252],{"type":55,"value":3226},"it assumes that the frontend SPA/SSR site should have a lower priority rule than the backend service and should route request paths matching ",{"type":49,"tag":326,"props":3228,"children":3230},{"className":3229},[],[3231],{"type":55,"value":3211},{"type":55,"value":3233},", while the backend service routes requests for a specific list of path patterns (",{"type":49,"tag":326,"props":3235,"children":3237},{"className":3236},[],[3238],{"type":55,"value":3196},{"type":55,"value":873},{"type":49,"tag":326,"props":3241,"children":3243},{"className":3242},[],[3244],{"type":55,"value":3203},{"type":55,"value":873},{"type":49,"tag":326,"props":3247,"children":3249},{"className":3248},[],[3250],{"type":55,"value":3251},"/graphql/*",{"type":55,"value":3253},", etc.).",{"type":49,"tag":58,"props":3255,"children":3256},{},[3257],{"type":55,"value":3258},"You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring.",{"type":49,"tag":430,"props":3260,"children":3262},{"id":3261},"celery",[3263],{"type":55,"value":3264},"Celery",{"type":49,"tag":64,"props":3266,"children":3267},{},[3268,3273],{"type":49,"tag":68,"props":3269,"children":3270},{},[3271],{"type":55,"value":3272},"The reason for having a celery service is to be able to have potentially multiple workers that scale independently",{"type":49,"tag":68,"props":3274,"children":3275},{},[3276],{"type":55,"value":3277},"I use the same Pulumi component for both works and schedulers",{"type":49,"tag":58,"props":3279,"children":3280},{},[3281,3283,3289,3291,3296],{"type":55,"value":3282},"The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like ",{"type":49,"tag":326,"props":3284,"children":3286},{"className":3285},[],[3287],{"type":55,"value":3288},"AsyncWorker",{"type":55,"value":3290}," across the board rather than using the term ",{"type":49,"tag":326,"props":3292,"children":3294},{"className":3293},[],[3295],{"type":55,"value":3261},{"type":55,"value":745},{"type":49,"tag":430,"props":3298,"children":3300},{"id":3299},"management-command",[3301],{"type":55,"value":3302},"Management Command",{"type":49,"tag":64,"props":3304,"children":3305},{},[3306,3324],{"type":49,"tag":68,"props":3307,"children":3308},{},[3309,3311,3317,3318],{"type":55,"value":3310},"Defines a task that can be used to run commands like ",{"type":49,"tag":326,"props":3312,"children":3314},{"className":3313},[],[3315],{"type":55,"value":3316},"collectstatic",{"type":55,"value":715},{"type":49,"tag":326,"props":3319,"children":3321},{"className":3320},[],[3322],{"type":55,"value":3323},"migrate",{"type":49,"tag":68,"props":3325,"children":3326},{},[3327,3329,3334],{"type":55,"value":3328},"These tasks are ran both after the initial ",{"type":49,"tag":326,"props":3330,"children":3332},{"className":3331},[],[3333],{"type":55,"value":1375},{"type":55,"value":3335}," stack deployment and before rolling application upgrades",{"type":49,"tag":58,"props":3337,"children":3338},{},[3339,3341,3346,3347,3352],{"type":55,"value":3340},"In my Django app I have a single management command that calls ",{"type":49,"tag":326,"props":3342,"children":3344},{"className":3343},[],[3345],{"type":55,"value":3323},{"type":55,"value":715},{"type":49,"tag":326,"props":3348,"children":3350},{"className":3349},[],[3351],{"type":55,"value":3316},{"type":55,"value":3353}," and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc.",{"type":49,"tag":58,"props":3355,"children":3356},{},[3357,3359,3364],{"type":55,"value":3358},"One other thing to note about this ",{"type":49,"tag":326,"props":3360,"children":3362},{"className":3361},[],[3363],{"type":55,"value":457},{"type":55,"value":3365}," is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:",{"type":49,"tag":64,"props":3367,"children":3368},{},[3369,3382,3387,3392,3403],{"type":49,"tag":68,"props":3370,"children":3371},{},[3372,3374,3380],{"type":55,"value":3373},"saves the ",{"type":49,"tag":326,"props":3375,"children":3377},{"className":3376},[],[3378],{"type":55,"value":3379},"START",{"type":55,"value":3381}," timestamp",{"type":49,"tag":68,"props":3383,"children":3384},{},[3385],{"type":55,"value":3386},"runs the task with the required settings",{"type":49,"tag":68,"props":3388,"children":3389},{},[3390],{"type":55,"value":3391},"waits for the task to complete",{"type":49,"tag":68,"props":3393,"children":3394},{},[3395,3396,3402],{"type":55,"value":3373},{"type":49,"tag":326,"props":3397,"children":3399},{"className":3398},[],[3400],{"type":55,"value":3401},"END",{"type":55,"value":3381},{"type":49,"tag":68,"props":3404,"children":3405},{},[3406,3408,3413,3414,3419,3421],{"type":55,"value":3407},"collects the logs for the task between ",{"type":49,"tag":326,"props":3409,"children":3411},{"className":3410},[],[3412],{"type":55,"value":3379},{"type":55,"value":715},{"type":49,"tag":326,"props":3415,"children":3417},{"className":3416},[],[3418],{"type":55,"value":3401},{"type":55,"value":3420}," and prints them to ",{"type":49,"tag":326,"props":3422,"children":3424},{"className":3423},[],[3425],{"type":55,"value":3426},"stdout",{"type":49,"tag":58,"props":3428,"children":3429},{},[3430],{"type":55,"value":3431},"Here's an example of what the script looks like in Pulumi:",{"type":49,"tag":1050,"props":3433,"children":3435},{"code":3434,"language":2171,"meta":8,"className":2172,"style":8},"    const executionScript = pulumi.interpolate`#!/bin/bash\nSTART_TIME=$(date +%s000)\nTASK_ID=$(aws ecs run-task --cluster ${props.ecsClusterId} --task-definition ${taskDefinition.arn} --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[${props.privateSubnetIds.apply(x => x.join(\",\"))}],securityGroups=[${props.appSgId}],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\naws ecs wait tasks-stopped --tasks $TASK_ID --cluster ${props.ecsClusterId}\nEND_TIME=$(date +%s000)\naws logs get-log-events --log-group-name ${cwLoggingResources.cwLogGroupName} --log-stream-name ${props.name}/${props.name}/\\${TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n`;\n    this.executionScript = executionScript;\n",[3436],{"type":49,"tag":326,"props":3437,"children":3438},{"__ignoreMap":8},[3439,3470,3478,3647,3676,3684,3779,3792],{"type":49,"tag":1060,"props":3440,"children":3441},{"class":1062,"line":1063},[3442,3446,3451,3455,3460,3465],{"type":49,"tag":1060,"props":3443,"children":3444},{"style":2182},[3445],{"type":55,"value":2185},{"type":49,"tag":1060,"props":3447,"children":3448},{"style":2188},[3449],{"type":55,"value":3450}," executionScript",{"type":49,"tag":1060,"props":3452,"children":3453},{"style":2194},[3454],{"type":55,"value":2197},{"type":49,"tag":1060,"props":3456,"children":3457},{"style":1073},[3458],{"type":55,"value":3459}," pulumi.",{"type":49,"tag":1060,"props":3461,"children":3462},{"style":1067},[3463],{"type":55,"value":3464},"interpolate",{"type":49,"tag":1060,"props":3466,"children":3467},{"style":2215},[3468],{"type":55,"value":3469},"`#!/bin/bash\n",{"type":49,"tag":1060,"props":3471,"children":3472},{"class":1062,"line":1079},[3473],{"type":49,"tag":1060,"props":3474,"children":3475},{"style":2215},[3476],{"type":55,"value":3477},"START_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3479,"children":3480},{"class":1062,"line":1088},[3481,3486,3492,3497,3502,3507,3512,3517,3521,3526,3530,3535,3539,3544,3548,3552,3556,3561,3565,3569,3573,3579,3584,3589,3593,3598,3602,3607,3612,3616,3621,3625,3629,3633,3638,3642],{"type":49,"tag":1060,"props":3482,"children":3483},{"style":2215},[3484],{"type":55,"value":3485},"TASK_ID=$(aws ecs run-task --cluster ",{"type":49,"tag":1060,"props":3487,"children":3489},{"style":3488},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672",[3490],{"type":55,"value":3491},"${",{"type":49,"tag":1060,"props":3493,"children":3494},{"style":1073},[3495],{"type":55,"value":3496},"props",{"type":49,"tag":1060,"props":3498,"children":3500},{"style":3499},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F8F8F2",[3501],{"type":55,"value":745},{"type":49,"tag":1060,"props":3503,"children":3504},{"style":1073},[3505],{"type":55,"value":3506},"ecsClusterId",{"type":49,"tag":1060,"props":3508,"children":3509},{"style":3488},[3510],{"type":55,"value":3511},"}",{"type":49,"tag":1060,"props":3513,"children":3514},{"style":2215},[3515],{"type":55,"value":3516}," --task-definition ",{"type":49,"tag":1060,"props":3518,"children":3519},{"style":3488},[3520],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3522,"children":3523},{"style":1073},[3524],{"type":55,"value":3525},"taskDefinition",{"type":49,"tag":1060,"props":3527,"children":3528},{"style":3499},[3529],{"type":55,"value":745},{"type":49,"tag":1060,"props":3531,"children":3532},{"style":1073},[3533],{"type":55,"value":3534},"arn",{"type":49,"tag":1060,"props":3536,"children":3537},{"style":3488},[3538],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3540,"children":3541},{"style":2215},[3542],{"type":55,"value":3543}," --launch-type FARGATE --network-configuration \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":3545,"children":3546},{"style":3488},[3547],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3549,"children":3550},{"style":1073},[3551],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3553,"children":3554},{"style":3499},[3555],{"type":55,"value":745},{"type":49,"tag":1060,"props":3557,"children":3558},{"style":1073},[3559],{"type":55,"value":3560},"privateSubnetIds",{"type":49,"tag":1060,"props":3562,"children":3563},{"style":3499},[3564],{"type":55,"value":745},{"type":49,"tag":1060,"props":3566,"children":3567},{"style":1067},[3568],{"type":55,"value":472},{"type":49,"tag":1060,"props":3570,"children":3571},{"style":3499},[3572],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3574,"children":3576},{"style":3575},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[3577],{"type":55,"value":3578},"x",{"type":49,"tag":1060,"props":3580,"children":3581},{"style":2182},[3582],{"type":55,"value":3583}," =>",{"type":49,"tag":1060,"props":3585,"children":3586},{"style":1073},[3587],{"type":55,"value":3588}," x",{"type":49,"tag":1060,"props":3590,"children":3591},{"style":3499},[3592],{"type":55,"value":745},{"type":49,"tag":1060,"props":3594,"children":3595},{"style":1067},[3596],{"type":55,"value":3597},"join",{"type":49,"tag":1060,"props":3599,"children":3600},{"style":3499},[3601],{"type":55,"value":2284},{"type":49,"tag":1060,"props":3603,"children":3604},{"style":2215},[3605],{"type":55,"value":3606},"\",\"",{"type":49,"tag":1060,"props":3608,"children":3609},{"style":3499},[3610],{"type":55,"value":3611},"))",{"type":49,"tag":1060,"props":3613,"children":3614},{"style":3488},[3615],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3617,"children":3618},{"style":2215},[3619],{"type":55,"value":3620},"],securityGroups=[",{"type":49,"tag":1060,"props":3622,"children":3623},{"style":3488},[3624],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3626,"children":3627},{"style":1073},[3628],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3630,"children":3631},{"style":3499},[3632],{"type":55,"value":745},{"type":49,"tag":1060,"props":3634,"children":3635},{"style":1073},[3636],{"type":55,"value":3637},"appSgId",{"type":49,"tag":1060,"props":3639,"children":3640},{"style":3488},[3641],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3643,"children":3644},{"style":2215},[3645],{"type":55,"value":3646},"],assignPublicIp=ENABLED}\" | jq -r '.tasks[0].taskArn')\n",{"type":49,"tag":1060,"props":3648,"children":3649},{"class":1062,"line":1097},[3650,3655,3659,3663,3667,3671],{"type":49,"tag":1060,"props":3651,"children":3652},{"style":2215},[3653],{"type":55,"value":3654},"aws ecs wait tasks-stopped --tasks $TASK_ID --cluster ",{"type":49,"tag":1060,"props":3656,"children":3657},{"style":3488},[3658],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3660,"children":3661},{"style":1073},[3662],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3664,"children":3665},{"style":3499},[3666],{"type":55,"value":745},{"type":49,"tag":1060,"props":3668,"children":3669},{"style":1073},[3670],{"type":55,"value":3506},{"type":49,"tag":1060,"props":3672,"children":3673},{"style":3488},[3674],{"type":55,"value":3675},"}\n",{"type":49,"tag":1060,"props":3677,"children":3678},{"class":1062,"line":1111},[3679],{"type":49,"tag":1060,"props":3680,"children":3681},{"style":2215},[3682],{"type":55,"value":3683},"END_TIME=$(date +%s000)\n",{"type":49,"tag":1060,"props":3685,"children":3686},{"class":1062,"line":1120},[3687,3692,3696,3701,3705,3710,3714,3719,3723,3727,3731,3736,3740,3745,3749,3753,3757,3761,3765,3769,3774],{"type":49,"tag":1060,"props":3688,"children":3689},{"style":2215},[3690],{"type":55,"value":3691},"aws logs get-log-events --log-group-name ",{"type":49,"tag":1060,"props":3693,"children":3694},{"style":3488},[3695],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3697,"children":3698},{"style":1073},[3699],{"type":55,"value":3700},"cwLoggingResources",{"type":49,"tag":1060,"props":3702,"children":3703},{"style":3499},[3704],{"type":55,"value":745},{"type":49,"tag":1060,"props":3706,"children":3707},{"style":1073},[3708],{"type":55,"value":3709},"cwLogGroupName",{"type":49,"tag":1060,"props":3711,"children":3712},{"style":3488},[3713],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3715,"children":3716},{"style":2215},[3717],{"type":55,"value":3718}," --log-stream-name ",{"type":49,"tag":1060,"props":3720,"children":3721},{"style":3488},[3722],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3724,"children":3725},{"style":1073},[3726],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3728,"children":3729},{"style":3499},[3730],{"type":55,"value":745},{"type":49,"tag":1060,"props":3732,"children":3733},{"style":1073},[3734],{"type":55,"value":3735},"name",{"type":49,"tag":1060,"props":3737,"children":3738},{"style":3488},[3739],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3741,"children":3742},{"style":2215},[3743],{"type":55,"value":3744},"/",{"type":49,"tag":1060,"props":3746,"children":3747},{"style":3488},[3748],{"type":55,"value":3491},{"type":49,"tag":1060,"props":3750,"children":3751},{"style":1073},[3752],{"type":55,"value":3496},{"type":49,"tag":1060,"props":3754,"children":3755},{"style":3499},[3756],{"type":55,"value":745},{"type":49,"tag":1060,"props":3758,"children":3759},{"style":1073},[3760],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3762,"children":3763},{"style":3488},[3764],{"type":55,"value":3511},{"type":49,"tag":1060,"props":3766,"children":3767},{"style":2215},[3768],{"type":55,"value":3744},{"type":49,"tag":1060,"props":3770,"children":3771},{"style":2287},[3772],{"type":55,"value":3773},"\\$",{"type":49,"tag":1060,"props":3775,"children":3776},{"style":2215},[3777],{"type":55,"value":3778},"{TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'\n",{"type":49,"tag":1060,"props":3780,"children":3781},{"class":1062,"line":1128},[3782,3787],{"type":49,"tag":1060,"props":3783,"children":3784},{"style":2215},[3785],{"type":55,"value":3786},"`",{"type":49,"tag":1060,"props":3788,"children":3789},{"style":1073},[3790],{"type":55,"value":3791},";\n",{"type":49,"tag":1060,"props":3793,"children":3794},{"class":1062,"line":1141},[3795,3801,3806,3810],{"type":49,"tag":1060,"props":3796,"children":3798},{"style":3797},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[3799],{"type":55,"value":3800},"    this",{"type":49,"tag":1060,"props":3802,"children":3803},{"style":1073},[3804],{"type":55,"value":3805},".executionScript ",{"type":49,"tag":1060,"props":3807,"children":3808},{"style":2194},[3809],{"type":55,"value":3068},{"type":49,"tag":1060,"props":3811,"children":3812},{"style":1073},[3813],{"type":55,"value":3814}," executionScript;\n",{"type":49,"tag":58,"props":3816,"children":3817},{},[3818],{"type":55,"value":3819},"In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:",{"type":49,"tag":1050,"props":3821,"children":3825},{"code":3822,"language":3823,"meta":8,"className":3824,"style":8},"      - name: \"Run backend update command\"\n        id: run_backend_update\n        run: |\n          # get the script from the stack output with an output key that contains the string `backendUpdate`\n          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n            --stack-name $AD_HOC_APP_NAME \\\n            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n          )\n\n          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n          cat backend_update_command.sh\n          sudo chmod +x backend_update_command.sh\n          ./backend_update_command.sh\n","yaml","language-yaml shiki shiki-themes github-light github-dark monokai",[3826],{"type":49,"tag":326,"props":3827,"children":3828},{"__ignoreMap":8},[3829,3851,3868,3885,3893,3901,3909,3917,3925,3932,3940,3948,3956],{"type":49,"tag":1060,"props":3830,"children":3831},{"class":1062,"line":1063},[3832,3837,3842,3846],{"type":49,"tag":1060,"props":3833,"children":3834},{"style":1073},[3835],{"type":55,"value":3836},"      - ",{"type":49,"tag":1060,"props":3838,"children":3840},{"style":3839},"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[3841],{"type":55,"value":3735},{"type":49,"tag":1060,"props":3843,"children":3844},{"style":1073},[3845],{"type":55,"value":78},{"type":49,"tag":1060,"props":3847,"children":3848},{"style":2215},[3849],{"type":55,"value":3850},"\"Run backend update command\"\n",{"type":49,"tag":1060,"props":3852,"children":3853},{"class":1062,"line":1079},[3854,3859,3863],{"type":49,"tag":1060,"props":3855,"children":3856},{"style":3839},[3857],{"type":55,"value":3858},"        id",{"type":49,"tag":1060,"props":3860,"children":3861},{"style":1073},[3862],{"type":55,"value":78},{"type":49,"tag":1060,"props":3864,"children":3865},{"style":2215},[3866],{"type":55,"value":3867},"run_backend_update\n",{"type":49,"tag":1060,"props":3869,"children":3870},{"class":1062,"line":1088},[3871,3876,3880],{"type":49,"tag":1060,"props":3872,"children":3873},{"style":3839},[3874],{"type":55,"value":3875},"        run",{"type":49,"tag":1060,"props":3877,"children":3878},{"style":1073},[3879],{"type":55,"value":78},{"type":49,"tag":1060,"props":3881,"children":3882},{"style":2194},[3883],{"type":55,"value":3884},"|\n",{"type":49,"tag":1060,"props":3886,"children":3887},{"class":1062,"line":1097},[3888],{"type":49,"tag":1060,"props":3889,"children":3890},{"style":2215},[3891],{"type":55,"value":3892},"          # get the script from the stack output with an output key that contains the string `backendUpdate`\n",{"type":49,"tag":1060,"props":3894,"children":3895},{"class":1062,"line":1111},[3896],{"type":49,"tag":1060,"props":3897,"children":3898},{"style":2215},[3899],{"type":55,"value":3900},"          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \\\n",{"type":49,"tag":1060,"props":3902,"children":3903},{"class":1062,"line":1120},[3904],{"type":49,"tag":1060,"props":3905,"children":3906},{"style":2215},[3907],{"type":55,"value":3908},"            --stack-name $AD_HOC_APP_NAME \\\n",{"type":49,"tag":1060,"props":3910,"children":3911},{"class":1062,"line":1128},[3912],{"type":49,"tag":1060,"props":3913,"children":3914},{"style":2215},[3915],{"type":55,"value":3916},"            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains(\"backendUpdate\")) | .OutputValue' \\\n",{"type":49,"tag":1060,"props":3918,"children":3919},{"class":1062,"line":1141},[3920],{"type":49,"tag":1060,"props":3921,"children":3922},{"style":2215},[3923],{"type":55,"value":3924},"          )\n",{"type":49,"tag":1060,"props":3926,"children":3927},{"class":1062,"line":1150},[3928],{"type":49,"tag":1060,"props":3929,"children":3930},{"emptyLinePlaceholder":44},[3931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":3933,"children":3934},{"class":1062,"line":1158},[3935],{"type":49,"tag":1060,"props":3936,"children":3937},{"style":2215},[3938],{"type":55,"value":3939},"          echo \"$BACKEND_UPDATE_SCRIPT\" > backend_update_command.sh\n",{"type":49,"tag":1060,"props":3941,"children":3942},{"class":1062,"line":1171},[3943],{"type":49,"tag":1060,"props":3944,"children":3945},{"style":2215},[3946],{"type":55,"value":3947},"          cat backend_update_command.sh\n",{"type":49,"tag":1060,"props":3949,"children":3950},{"class":1062,"line":1180},[3951],{"type":49,"tag":1060,"props":3952,"children":3953},{"style":2215},[3954],{"type":55,"value":3955},"          sudo chmod +x backend_update_command.sh\n",{"type":49,"tag":1060,"props":3957,"children":3958},{"class":1062,"line":1188},[3959],{"type":49,"tag":1060,"props":3960,"children":3961},{"style":2215},[3962],{"type":55,"value":3963},"          ./backend_update_command.sh\n",{"type":49,"tag":430,"props":3965,"children":3967},{"id":3966},"passing-data-between-stacks",[3968],{"type":55,"value":2849},{"type":49,"tag":58,"props":3970,"children":3971},{},[3972],{"type":55,"value":3973},"Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References.",{"type":49,"tag":58,"props":3975,"children":3976},{},[3977],{"type":55,"value":3978},"Here's what this looks like in Terraform",{"type":49,"tag":1050,"props":3980,"children":3983},{"code":3981,"language":16,"meta":8,"className":3982,"style":8},"data \"terraform_remote_state\" \"this\" {\n  backend = \"local\"\n\n  config = {\n    path = \"../base/terraform.tfstate\"\n  }\n}\n\nmodule \"main\" {\n  source = \"../../../modules/ad-hoc/app\"\n\n  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id\n  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name\n  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids\n  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id\n  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id\n  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn\n  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name\n  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id\n  rds_address                    = data.terraform_remote_state.this.outputs.rds_address\n  domain_name                    = data.terraform_remote_state.this.outputs.domain_name\n  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name\n  region                         = var.region\n}\n","language-terraform shiki shiki-themes github-light github-dark monokai",[3984],{"type":49,"tag":326,"props":3985,"children":3986},{"__ignoreMap":8},[3987,4011,4028,4035,4051,4068,4076,4083,4090,4107,4124,4131,4183,4233,4282,4332,4381,4431,4480,4529,4579,4629,4680,4707],{"type":49,"tag":1060,"props":3988,"children":3989},{"class":1062,"line":1063},[3990,3996,4001,4006],{"type":49,"tag":1060,"props":3991,"children":3993},{"style":3992},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[3994],{"type":55,"value":3995},"data",{"type":49,"tag":1060,"props":3997,"children":3998},{"style":2188},[3999],{"type":55,"value":4000}," \"terraform_remote_state\"",{"type":49,"tag":1060,"props":4002,"children":4003},{"style":2188},[4004],{"type":55,"value":4005}," \"this\"",{"type":49,"tag":1060,"props":4007,"children":4008},{"style":1073},[4009],{"type":55,"value":4010}," {\n",{"type":49,"tag":1060,"props":4012,"children":4013},{"class":1062,"line":1079},[4014,4019,4023],{"type":49,"tag":1060,"props":4015,"children":4016},{"style":1073},[4017],{"type":55,"value":4018},"  backend",{"type":49,"tag":1060,"props":4020,"children":4021},{"style":2194},[4022],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4024,"children":4025},{"style":2215},[4026],{"type":55,"value":4027}," \"local\"\n",{"type":49,"tag":1060,"props":4029,"children":4030},{"class":1062,"line":1088},[4031],{"type":49,"tag":1060,"props":4032,"children":4033},{"emptyLinePlaceholder":44},[4034],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4036,"children":4037},{"class":1062,"line":1097},[4038,4043,4047],{"type":49,"tag":1060,"props":4039,"children":4040},{"style":1073},[4041],{"type":55,"value":4042},"  config",{"type":49,"tag":1060,"props":4044,"children":4045},{"style":2194},[4046],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4048,"children":4049},{"style":1073},[4050],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4052,"children":4053},{"class":1062,"line":1111},[4054,4059,4063],{"type":49,"tag":1060,"props":4055,"children":4056},{"style":1073},[4057],{"type":55,"value":4058},"    path ",{"type":49,"tag":1060,"props":4060,"children":4061},{"style":2194},[4062],{"type":55,"value":3068},{"type":49,"tag":1060,"props":4064,"children":4065},{"style":2215},[4066],{"type":55,"value":4067}," \"../base/terraform.tfstate\"\n",{"type":49,"tag":1060,"props":4069,"children":4070},{"class":1062,"line":1120},[4071],{"type":49,"tag":1060,"props":4072,"children":4073},{"style":1073},[4074],{"type":55,"value":4075},"  }\n",{"type":49,"tag":1060,"props":4077,"children":4078},{"class":1062,"line":1128},[4079],{"type":49,"tag":1060,"props":4080,"children":4081},{"style":1073},[4082],{"type":55,"value":3675},{"type":49,"tag":1060,"props":4084,"children":4085},{"class":1062,"line":1141},[4086],{"type":49,"tag":1060,"props":4087,"children":4088},{"emptyLinePlaceholder":44},[4089],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4091,"children":4092},{"class":1062,"line":1150},[4093,4098,4103],{"type":49,"tag":1060,"props":4094,"children":4095},{"style":3992},[4096],{"type":55,"value":4097},"module",{"type":49,"tag":1060,"props":4099,"children":4100},{"style":2188},[4101],{"type":55,"value":4102}," \"main\"",{"type":49,"tag":1060,"props":4104,"children":4105},{"style":1073},[4106],{"type":55,"value":4010},{"type":49,"tag":1060,"props":4108,"children":4109},{"class":1062,"line":1158},[4110,4115,4119],{"type":49,"tag":1060,"props":4111,"children":4112},{"style":1073},[4113],{"type":55,"value":4114},"  source",{"type":49,"tag":1060,"props":4116,"children":4117},{"style":2194},[4118],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4120,"children":4121},{"style":2215},[4122],{"type":55,"value":4123}," \"../../../modules/ad-hoc/app\"\n",{"type":49,"tag":1060,"props":4125,"children":4126},{"class":1062,"line":1171},[4127],{"type":49,"tag":1060,"props":4128,"children":4129},{"emptyLinePlaceholder":44},[4130],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4132,"children":4133},{"class":1062,"line":1180},[4134,4139,4144,4149,4153,4157,4161,4166,4170,4174,4178],{"type":49,"tag":1060,"props":4135,"children":4136},{"style":1073},[4137],{"type":55,"value":4138},"  vpc_id",{"type":49,"tag":1060,"props":4140,"children":4141},{"style":2194},[4142],{"type":55,"value":4143},"                         =",{"type":49,"tag":1060,"props":4145,"children":4146},{"style":1073},[4147],{"type":55,"value":4148}," data",{"type":49,"tag":1060,"props":4150,"children":4151},{"style":2194},[4152],{"type":55,"value":745},{"type":49,"tag":1060,"props":4154,"children":4155},{"style":1073},[4156],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4158,"children":4159},{"style":2194},[4160],{"type":55,"value":745},{"type":49,"tag":1060,"props":4162,"children":4163},{"style":1073},[4164],{"type":55,"value":4165},"this",{"type":49,"tag":1060,"props":4167,"children":4168},{"style":2194},[4169],{"type":55,"value":745},{"type":49,"tag":1060,"props":4171,"children":4172},{"style":1073},[4173],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4175,"children":4176},{"style":2194},[4177],{"type":55,"value":745},{"type":49,"tag":1060,"props":4179,"children":4180},{"style":1073},[4181],{"type":55,"value":4182},"vpc_id\n",{"type":49,"tag":1060,"props":4184,"children":4185},{"class":1062,"line":1188},[4186,4191,4196,4200,4204,4208,4212,4216,4220,4224,4228],{"type":49,"tag":1060,"props":4187,"children":4188},{"style":1073},[4189],{"type":55,"value":4190},"  assets_bucket_name",{"type":49,"tag":1060,"props":4192,"children":4193},{"style":2194},[4194],{"type":55,"value":4195},"             =",{"type":49,"tag":1060,"props":4197,"children":4198},{"style":1073},[4199],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4201,"children":4202},{"style":2194},[4203],{"type":55,"value":745},{"type":49,"tag":1060,"props":4205,"children":4206},{"style":1073},[4207],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4209,"children":4210},{"style":2194},[4211],{"type":55,"value":745},{"type":49,"tag":1060,"props":4213,"children":4214},{"style":1073},[4215],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4217,"children":4218},{"style":2194},[4219],{"type":55,"value":745},{"type":49,"tag":1060,"props":4221,"children":4222},{"style":1073},[4223],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4225,"children":4226},{"style":2194},[4227],{"type":55,"value":745},{"type":49,"tag":1060,"props":4229,"children":4230},{"style":1073},[4231],{"type":55,"value":4232},"assets_bucket_name\n",{"type":49,"tag":1060,"props":4234,"children":4235},{"class":1062,"line":1201},[4236,4241,4245,4249,4253,4257,4261,4265,4269,4273,4277],{"type":49,"tag":1060,"props":4237,"children":4238},{"style":1073},[4239],{"type":55,"value":4240},"  private_subnet_ids",{"type":49,"tag":1060,"props":4242,"children":4243},{"style":2194},[4244],{"type":55,"value":4195},{"type":49,"tag":1060,"props":4246,"children":4247},{"style":1073},[4248],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4250,"children":4251},{"style":2194},[4252],{"type":55,"value":745},{"type":49,"tag":1060,"props":4254,"children":4255},{"style":1073},[4256],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4258,"children":4259},{"style":2194},[4260],{"type":55,"value":745},{"type":49,"tag":1060,"props":4262,"children":4263},{"style":1073},[4264],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4266,"children":4267},{"style":2194},[4268],{"type":55,"value":745},{"type":49,"tag":1060,"props":4270,"children":4271},{"style":1073},[4272],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4274,"children":4275},{"style":2194},[4276],{"type":55,"value":745},{"type":49,"tag":1060,"props":4278,"children":4279},{"style":1073},[4280],{"type":55,"value":4281},"private_subnet_ids\n",{"type":49,"tag":1060,"props":4283,"children":4284},{"class":1062,"line":1210},[4285,4290,4295,4299,4303,4307,4311,4315,4319,4323,4327],{"type":49,"tag":1060,"props":4286,"children":4287},{"style":1073},[4288],{"type":55,"value":4289},"  app_sg_id",{"type":49,"tag":1060,"props":4291,"children":4292},{"style":2194},[4293],{"type":55,"value":4294},"                      =",{"type":49,"tag":1060,"props":4296,"children":4297},{"style":1073},[4298],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4300,"children":4301},{"style":2194},[4302],{"type":55,"value":745},{"type":49,"tag":1060,"props":4304,"children":4305},{"style":1073},[4306],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4308,"children":4309},{"style":2194},[4310],{"type":55,"value":745},{"type":49,"tag":1060,"props":4312,"children":4313},{"style":1073},[4314],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4316,"children":4317},{"style":2194},[4318],{"type":55,"value":745},{"type":49,"tag":1060,"props":4320,"children":4321},{"style":1073},[4322],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4324,"children":4325},{"style":2194},[4326],{"type":55,"value":745},{"type":49,"tag":1060,"props":4328,"children":4329},{"style":1073},[4330],{"type":55,"value":4331},"app_sg_id\n",{"type":49,"tag":1060,"props":4333,"children":4334},{"class":1062,"line":1218},[4335,4340,4344,4348,4352,4356,4360,4364,4368,4372,4376],{"type":49,"tag":1060,"props":4336,"children":4337},{"style":1073},[4338],{"type":55,"value":4339},"  alb_sg_id",{"type":49,"tag":1060,"props":4341,"children":4342},{"style":2194},[4343],{"type":55,"value":4294},{"type":49,"tag":1060,"props":4345,"children":4346},{"style":1073},[4347],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4349,"children":4350},{"style":2194},[4351],{"type":55,"value":745},{"type":49,"tag":1060,"props":4353,"children":4354},{"style":1073},[4355],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4357,"children":4358},{"style":2194},[4359],{"type":55,"value":745},{"type":49,"tag":1060,"props":4361,"children":4362},{"style":1073},[4363],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4365,"children":4366},{"style":2194},[4367],{"type":55,"value":745},{"type":49,"tag":1060,"props":4369,"children":4370},{"style":1073},[4371],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4373,"children":4374},{"style":2194},[4375],{"type":55,"value":745},{"type":49,"tag":1060,"props":4377,"children":4378},{"style":1073},[4379],{"type":55,"value":4380},"alb_sg_id\n",{"type":49,"tag":1060,"props":4382,"children":4383},{"class":1062,"line":1232},[4384,4389,4394,4398,4402,4406,4410,4414,4418,4422,4426],{"type":49,"tag":1060,"props":4385,"children":4386},{"style":1073},[4387],{"type":55,"value":4388},"  listener_arn",{"type":49,"tag":1060,"props":4390,"children":4391},{"style":2194},[4392],{"type":55,"value":4393},"                   =",{"type":49,"tag":1060,"props":4395,"children":4396},{"style":1073},[4397],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4399,"children":4400},{"style":2194},[4401],{"type":55,"value":745},{"type":49,"tag":1060,"props":4403,"children":4404},{"style":1073},[4405],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4407,"children":4408},{"style":2194},[4409],{"type":55,"value":745},{"type":49,"tag":1060,"props":4411,"children":4412},{"style":1073},[4413],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4415,"children":4416},{"style":2194},[4417],{"type":55,"value":745},{"type":49,"tag":1060,"props":4419,"children":4420},{"style":1073},[4421],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4423,"children":4424},{"style":2194},[4425],{"type":55,"value":745},{"type":49,"tag":1060,"props":4427,"children":4428},{"style":1073},[4429],{"type":55,"value":4430},"listener_arn\n",{"type":49,"tag":1060,"props":4432,"children":4433},{"class":1062,"line":1241},[4434,4439,4443,4447,4451,4455,4459,4463,4467,4471,4475],{"type":49,"tag":1060,"props":4435,"children":4436},{"style":1073},[4437],{"type":55,"value":4438},"  alb_dns_name",{"type":49,"tag":1060,"props":4440,"children":4441},{"style":2194},[4442],{"type":55,"value":4393},{"type":49,"tag":1060,"props":4444,"children":4445},{"style":1073},[4446],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4448,"children":4449},{"style":2194},[4450],{"type":55,"value":745},{"type":49,"tag":1060,"props":4452,"children":4453},{"style":1073},[4454],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4456,"children":4457},{"style":2194},[4458],{"type":55,"value":745},{"type":49,"tag":1060,"props":4460,"children":4461},{"style":1073},[4462],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4464,"children":4465},{"style":2194},[4466],{"type":55,"value":745},{"type":49,"tag":1060,"props":4468,"children":4469},{"style":1073},[4470],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4472,"children":4473},{"style":2194},[4474],{"type":55,"value":745},{"type":49,"tag":1060,"props":4476,"children":4477},{"style":1073},[4478],{"type":55,"value":4479},"alb_dns_name\n",{"type":49,"tag":1060,"props":4481,"children":4482},{"class":1062,"line":1249},[4483,4488,4492,4496,4500,4504,4508,4512,4516,4520,4524],{"type":49,"tag":1060,"props":4484,"children":4485},{"style":1073},[4486],{"type":55,"value":4487},"  service_discovery_namespace_id",{"type":49,"tag":1060,"props":4489,"children":4490},{"style":2194},[4491],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4493,"children":4494},{"style":1073},[4495],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4497,"children":4498},{"style":2194},[4499],{"type":55,"value":745},{"type":49,"tag":1060,"props":4501,"children":4502},{"style":1073},[4503],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4505,"children":4506},{"style":2194},[4507],{"type":55,"value":745},{"type":49,"tag":1060,"props":4509,"children":4510},{"style":1073},[4511],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4513,"children":4514},{"style":2194},[4515],{"type":55,"value":745},{"type":49,"tag":1060,"props":4517,"children":4518},{"style":1073},[4519],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4521,"children":4522},{"style":2194},[4523],{"type":55,"value":745},{"type":49,"tag":1060,"props":4525,"children":4526},{"style":1073},[4527],{"type":55,"value":4528},"service_discovery_namespace_id\n",{"type":49,"tag":1060,"props":4530,"children":4531},{"class":1062,"line":1262},[4532,4537,4542,4546,4550,4554,4558,4562,4566,4570,4574],{"type":49,"tag":1060,"props":4533,"children":4534},{"style":1073},[4535],{"type":55,"value":4536},"  rds_address",{"type":49,"tag":1060,"props":4538,"children":4539},{"style":2194},[4540],{"type":55,"value":4541},"                    =",{"type":49,"tag":1060,"props":4543,"children":4544},{"style":1073},[4545],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4547,"children":4548},{"style":2194},[4549],{"type":55,"value":745},{"type":49,"tag":1060,"props":4551,"children":4552},{"style":1073},[4553],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4555,"children":4556},{"style":2194},[4557],{"type":55,"value":745},{"type":49,"tag":1060,"props":4559,"children":4560},{"style":1073},[4561],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4563,"children":4564},{"style":2194},[4565],{"type":55,"value":745},{"type":49,"tag":1060,"props":4567,"children":4568},{"style":1073},[4569],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4571,"children":4572},{"style":2194},[4573],{"type":55,"value":745},{"type":49,"tag":1060,"props":4575,"children":4576},{"style":1073},[4577],{"type":55,"value":4578},"rds_address\n",{"type":49,"tag":1060,"props":4580,"children":4582},{"class":1062,"line":4581},21,[4583,4588,4592,4596,4600,4604,4608,4612,4616,4620,4624],{"type":49,"tag":1060,"props":4584,"children":4585},{"style":1073},[4586],{"type":55,"value":4587},"  domain_name",{"type":49,"tag":1060,"props":4589,"children":4590},{"style":2194},[4591],{"type":55,"value":4541},{"type":49,"tag":1060,"props":4593,"children":4594},{"style":1073},[4595],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4597,"children":4598},{"style":2194},[4599],{"type":55,"value":745},{"type":49,"tag":1060,"props":4601,"children":4602},{"style":1073},[4603],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4605,"children":4606},{"style":2194},[4607],{"type":55,"value":745},{"type":49,"tag":1060,"props":4609,"children":4610},{"style":1073},[4611],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4613,"children":4614},{"style":2194},[4615],{"type":55,"value":745},{"type":49,"tag":1060,"props":4617,"children":4618},{"style":1073},[4619],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4621,"children":4622},{"style":2194},[4623],{"type":55,"value":745},{"type":49,"tag":1060,"props":4625,"children":4626},{"style":1073},[4627],{"type":55,"value":4628},"domain_name\n",{"type":49,"tag":1060,"props":4630,"children":4632},{"class":1062,"line":4631},22,[4633,4638,4643,4647,4651,4655,4659,4663,4667,4671,4675],{"type":49,"tag":1060,"props":4634,"children":4635},{"style":1073},[4636],{"type":55,"value":4637},"  base_stack_name",{"type":49,"tag":1060,"props":4639,"children":4640},{"style":2194},[4641],{"type":55,"value":4642},"                =",{"type":49,"tag":1060,"props":4644,"children":4645},{"style":1073},[4646],{"type":55,"value":4148},{"type":49,"tag":1060,"props":4648,"children":4649},{"style":2194},[4650],{"type":55,"value":745},{"type":49,"tag":1060,"props":4652,"children":4653},{"style":1073},[4654],{"type":55,"value":1842},{"type":49,"tag":1060,"props":4656,"children":4657},{"style":2194},[4658],{"type":55,"value":745},{"type":49,"tag":1060,"props":4660,"children":4661},{"style":1073},[4662],{"type":55,"value":4165},{"type":49,"tag":1060,"props":4664,"children":4665},{"style":2194},[4666],{"type":55,"value":745},{"type":49,"tag":1060,"props":4668,"children":4669},{"style":1073},[4670],{"type":55,"value":2763},{"type":49,"tag":1060,"props":4672,"children":4673},{"style":2194},[4674],{"type":55,"value":745},{"type":49,"tag":1060,"props":4676,"children":4677},{"style":1073},[4678],{"type":55,"value":4679},"base_stack_name\n",{"type":49,"tag":1060,"props":4681,"children":4683},{"class":1062,"line":4682},23,[4684,4689,4693,4698,4702],{"type":49,"tag":1060,"props":4685,"children":4686},{"style":1073},[4687],{"type":55,"value":4688},"  region",{"type":49,"tag":1060,"props":4690,"children":4691},{"style":2194},[4692],{"type":55,"value":4143},{"type":49,"tag":1060,"props":4694,"children":4695},{"style":1073},[4696],{"type":55,"value":4697}," var",{"type":49,"tag":1060,"props":4699,"children":4700},{"style":2194},[4701],{"type":55,"value":745},{"type":49,"tag":1060,"props":4703,"children":4704},{"style":1073},[4705],{"type":55,"value":4706},"region\n",{"type":49,"tag":1060,"props":4708,"children":4710},{"class":1062,"line":4709},24,[4711],{"type":49,"tag":1060,"props":4712,"children":4713},{"style":1073},[4714],{"type":55,"value":3675},{"type":49,"tag":58,"props":4716,"children":4717},{},[4718],{"type":55,"value":4719},"In CDK:",{"type":49,"tag":1050,"props":4721,"children":4723},{"code":4722,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n\nconst adHocBase = new AdHocBase(baseStack, 'AdHocBase', { certificateArn, domainName });\n\nconst addHocApp = new AdHocApp(appStack, 'AdHocApp', {\n  baseStackName: adHocBaseEnvName,\n  vpc: adHocBase.vpc,\n  alb: adHocBase.alb,\n  appSecurityGroup: adHocBase.appSecurityGroup,\n  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n  rdsInstance: adHocBase.databaseInstance,\n  assetsBucket: adHocBase.assetsBucket,\n  domainName: adHocBase.domainName,\n  listener: adHocBase.listener,\n});\n",[4724],{"type":49,"tag":326,"props":4725,"children":4726},{"__ignoreMap":8},[4727,4768,4795,4802,4840,4865,4872,4912,4919,4958,4966,4974,4982,4990,4998,5006,5014,5022,5030],{"type":49,"tag":1060,"props":4728,"children":4729},{"class":1062,"line":1063},[4730,4735,4740,4744,4748,4753,4758,4763],{"type":49,"tag":1060,"props":4731,"children":4732},{"style":2182},[4733],{"type":55,"value":4734},"const",{"type":49,"tag":1060,"props":4736,"children":4737},{"style":2188},[4738],{"type":55,"value":4739}," baseStack",{"type":49,"tag":1060,"props":4741,"children":4742},{"style":2194},[4743],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4745,"children":4746},{"style":2194},[4747],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4749,"children":4750},{"style":1067},[4751],{"type":55,"value":4752}," Stack",{"type":49,"tag":1060,"props":4754,"children":4755},{"style":1073},[4756],{"type":55,"value":4757},"(app, ",{"type":49,"tag":1060,"props":4759,"children":4760},{"style":2215},[4761],{"type":55,"value":4762},"'ExampleAdHocBaseStack'",{"type":49,"tag":1060,"props":4764,"children":4765},{"style":1073},[4766],{"type":55,"value":4767},", { env, stackName: adHocBaseEnvName });\n",{"type":49,"tag":1060,"props":4769,"children":4770},{"class":1062,"line":1079},[4771,4776,4781,4785,4790],{"type":49,"tag":1060,"props":4772,"children":4773},{"style":1073},[4774],{"type":55,"value":4775},"baseStack.node.",{"type":49,"tag":1060,"props":4777,"children":4778},{"style":1067},[4779],{"type":55,"value":4780},"setContext",{"type":49,"tag":1060,"props":4782,"children":4783},{"style":1073},[4784],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4786,"children":4787},{"style":2215},[4788],{"type":55,"value":4789},"'config'",{"type":49,"tag":1060,"props":4791,"children":4792},{"style":1073},[4793],{"type":55,"value":4794},", adHocBaseEnvConfig);\n",{"type":49,"tag":1060,"props":4796,"children":4797},{"class":1062,"line":1088},[4798],{"type":49,"tag":1060,"props":4799,"children":4800},{"emptyLinePlaceholder":44},[4801],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4803,"children":4804},{"class":1062,"line":1097},[4805,4809,4814,4818,4822,4826,4830,4835],{"type":49,"tag":1060,"props":4806,"children":4807},{"style":2182},[4808],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4810,"children":4811},{"style":2188},[4812],{"type":55,"value":4813}," appStack",{"type":49,"tag":1060,"props":4815,"children":4816},{"style":2194},[4817],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4819,"children":4820},{"style":2194},[4821],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4823,"children":4824},{"style":1067},[4825],{"type":55,"value":4752},{"type":49,"tag":1060,"props":4827,"children":4828},{"style":1073},[4829],{"type":55,"value":4757},{"type":49,"tag":1060,"props":4831,"children":4832},{"style":2215},[4833],{"type":55,"value":4834},"'ExampleAdHocAppStack'",{"type":49,"tag":1060,"props":4836,"children":4837},{"style":1073},[4838],{"type":55,"value":4839},", { env, stackName: adHocAppEnvName });\n",{"type":49,"tag":1060,"props":4841,"children":4842},{"class":1062,"line":1111},[4843,4848,4852,4856,4860],{"type":49,"tag":1060,"props":4844,"children":4845},{"style":1073},[4846],{"type":55,"value":4847},"appStack.node.",{"type":49,"tag":1060,"props":4849,"children":4850},{"style":1067},[4851],{"type":55,"value":4780},{"type":49,"tag":1060,"props":4853,"children":4854},{"style":1073},[4855],{"type":55,"value":2284},{"type":49,"tag":1060,"props":4857,"children":4858},{"style":2215},[4859],{"type":55,"value":4789},{"type":49,"tag":1060,"props":4861,"children":4862},{"style":1073},[4863],{"type":55,"value":4864},", adHocAppEnvConfig);\n",{"type":49,"tag":1060,"props":4866,"children":4867},{"class":1062,"line":1120},[4868],{"type":49,"tag":1060,"props":4869,"children":4870},{"emptyLinePlaceholder":44},[4871],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4873,"children":4874},{"class":1062,"line":1128},[4875,4879,4884,4888,4892,4897,4902,4907],{"type":49,"tag":1060,"props":4876,"children":4877},{"style":2182},[4878],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4880,"children":4881},{"style":2188},[4882],{"type":55,"value":4883}," adHocBase",{"type":49,"tag":1060,"props":4885,"children":4886},{"style":2194},[4887],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4889,"children":4890},{"style":2194},[4891],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4893,"children":4894},{"style":1067},[4895],{"type":55,"value":4896}," AdHocBase",{"type":49,"tag":1060,"props":4898,"children":4899},{"style":1073},[4900],{"type":55,"value":4901},"(baseStack, ",{"type":49,"tag":1060,"props":4903,"children":4904},{"style":2215},[4905],{"type":55,"value":4906},"'AdHocBase'",{"type":49,"tag":1060,"props":4908,"children":4909},{"style":1073},[4910],{"type":55,"value":4911},", { certificateArn, domainName });\n",{"type":49,"tag":1060,"props":4913,"children":4914},{"class":1062,"line":1141},[4915],{"type":49,"tag":1060,"props":4916,"children":4917},{"emptyLinePlaceholder":44},[4918],{"type":55,"value":1094},{"type":49,"tag":1060,"props":4920,"children":4921},{"class":1062,"line":1150},[4922,4926,4931,4935,4939,4944,4949,4954],{"type":49,"tag":1060,"props":4923,"children":4924},{"style":2182},[4925],{"type":55,"value":4734},{"type":49,"tag":1060,"props":4927,"children":4928},{"style":2188},[4929],{"type":55,"value":4930}," addHocApp",{"type":49,"tag":1060,"props":4932,"children":4933},{"style":2194},[4934],{"type":55,"value":2197},{"type":49,"tag":1060,"props":4936,"children":4937},{"style":2194},[4938],{"type":55,"value":2202},{"type":49,"tag":1060,"props":4940,"children":4941},{"style":1067},[4942],{"type":55,"value":4943}," AdHocApp",{"type":49,"tag":1060,"props":4945,"children":4946},{"style":1073},[4947],{"type":55,"value":4948},"(appStack, ",{"type":49,"tag":1060,"props":4950,"children":4951},{"style":2215},[4952],{"type":55,"value":4953},"'AdHocApp'",{"type":49,"tag":1060,"props":4955,"children":4956},{"style":1073},[4957],{"type":55,"value":2223},{"type":49,"tag":1060,"props":4959,"children":4960},{"class":1062,"line":1158},[4961],{"type":49,"tag":1060,"props":4962,"children":4963},{"style":1073},[4964],{"type":55,"value":4965},"  baseStackName: adHocBaseEnvName,\n",{"type":49,"tag":1060,"props":4967,"children":4968},{"class":1062,"line":1171},[4969],{"type":49,"tag":1060,"props":4970,"children":4971},{"style":1073},[4972],{"type":55,"value":4973},"  vpc: adHocBase.vpc,\n",{"type":49,"tag":1060,"props":4975,"children":4976},{"class":1062,"line":1180},[4977],{"type":49,"tag":1060,"props":4978,"children":4979},{"style":1073},[4980],{"type":55,"value":4981},"  alb: adHocBase.alb,\n",{"type":49,"tag":1060,"props":4983,"children":4984},{"class":1062,"line":1188},[4985],{"type":49,"tag":1060,"props":4986,"children":4987},{"style":1073},[4988],{"type":55,"value":4989},"  appSecurityGroup: adHocBase.appSecurityGroup,\n",{"type":49,"tag":1060,"props":4991,"children":4992},{"class":1062,"line":1201},[4993],{"type":49,"tag":1060,"props":4994,"children":4995},{"style":1073},[4996],{"type":55,"value":4997},"  serviceDiscoveryNamespace: adHocBase.serviceDiscoveryNamespace,\n",{"type":49,"tag":1060,"props":4999,"children":5000},{"class":1062,"line":1210},[5001],{"type":49,"tag":1060,"props":5002,"children":5003},{"style":1073},[5004],{"type":55,"value":5005},"  rdsInstance: adHocBase.databaseInstance,\n",{"type":49,"tag":1060,"props":5007,"children":5008},{"class":1062,"line":1218},[5009],{"type":49,"tag":1060,"props":5010,"children":5011},{"style":1073},[5012],{"type":55,"value":5013},"  assetsBucket: adHocBase.assetsBucket,\n",{"type":49,"tag":1060,"props":5015,"children":5016},{"class":1062,"line":1232},[5017],{"type":49,"tag":1060,"props":5018,"children":5019},{"style":1073},[5020],{"type":55,"value":5021},"  domainName: adHocBase.domainName,\n",{"type":49,"tag":1060,"props":5023,"children":5024},{"class":1062,"line":1241},[5025],{"type":49,"tag":1060,"props":5026,"children":5027},{"style":1073},[5028],{"type":55,"value":5029},"  listener: adHocBase.listener,\n",{"type":49,"tag":1060,"props":5031,"children":5032},{"class":1062,"line":1249},[5033],{"type":49,"tag":1060,"props":5034,"children":5035},{"style":1073},[5036],{"type":55,"value":5037},"});\n",{"type":49,"tag":58,"props":5039,"children":5040},{},[5041],{"type":55,"value":5042},"and in Pulumi:",{"type":49,"tag":1050,"props":5044,"children":5046},{"code":5045,"language":2171,"meta":8,"className":2172,"style":8},"const stackReference = new pulumi.StackReference(`${org}/ad-hoc-base/${environment}`)\n\nconst vpcId = stackReference.getOutput(\"vpcId\") as pulumi.Output\u003Cstring>;\nconst assetsBucketName = stackReference.getOutput(\"assetsBucketName\") as pulumi.Output\u003Cstring>;\nconst privateSubnets = stackReference.getOutput(\"privateSubnetIds\") as pulumi.Output\u003Cstring[]>;\nconst appSgId = stackReference.getOutput(\"appSgId\") as pulumi.Output\u003Cstring>;\nconst albSgId = stackReference.getOutput(\"albSgId\") as pulumi.Output\u003Cstring>;\nconst listenerArn = stackReference.getOutput(\"listenerArn\") as pulumi.Output\u003Cstring>;\nconst albDnsName = stackReference.getOutput(\"albDnsName\") as pulumi.Output\u003Cstring>;\nconst serviceDiscoveryNamespaceId = stackReference.getOutput(\"serviceDiscoveryNamespaceId\") as pulumi.Output\u003Cstring>;\nconst rdsAddress = stackReference.getOutput(\"rdsAddress\") as pulumi.Output\u003Cstring>;\nconst domainName = stackReference.getOutput(\"domainName\") as pulumi.Output\u003Cstring>;\nconst baseStackName = stackReference.getOutput(\"baseStackName\") as pulumi.Output\u003Cstring>;\n\n// ad hoc app env\nconst adHocAppComponent = new AdHocAppComponent(\"AdHocAppComponent\", {\n  vpcId,\n  assetsBucketName,\n  privateSubnets,\n  appSgId,\n  albSgId,\n  listenerArn,\n  albDnsName,\n  serviceDiscoveryNamespaceId,\n  rdsAddress,\n  domainName,\n  baseStackName\n});\n",[5047],{"type":49,"tag":326,"props":5048,"children":5049},{"__ignoreMap":8},[5050,5127,5134,5209,5274,5340,5405,5470,5535,5600,5665,5730,5795,5860,5867,5875,5913,5921,5929,5937,5945,5953,5961,5969,5977,5986,5995,6004],{"type":49,"tag":1060,"props":5051,"children":5052},{"class":1062,"line":1063},[5053,5057,5062,5066,5070,5074,5079,5083,5087,5091,5096,5100,5105,5109,5114,5118,5122],{"type":49,"tag":1060,"props":5054,"children":5055},{"style":2182},[5056],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5058,"children":5059},{"style":2188},[5060],{"type":55,"value":5061}," stackReference",{"type":49,"tag":1060,"props":5063,"children":5064},{"style":2194},[5065],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5067,"children":5068},{"style":2194},[5069],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5071,"children":5072},{"style":1073},[5073],{"type":55,"value":3459},{"type":49,"tag":1060,"props":5075,"children":5076},{"style":1067},[5077],{"type":55,"value":5078},"StackReference",{"type":49,"tag":1060,"props":5080,"children":5081},{"style":1073},[5082],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5084,"children":5085},{"style":2215},[5086],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5088,"children":5089},{"style":3488},[5090],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5092,"children":5093},{"style":1073},[5094],{"type":55,"value":5095},"org",{"type":49,"tag":1060,"props":5097,"children":5098},{"style":3488},[5099],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5101,"children":5102},{"style":2215},[5103],{"type":55,"value":5104},"/ad-hoc-base/",{"type":49,"tag":1060,"props":5106,"children":5107},{"style":3488},[5108],{"type":55,"value":3491},{"type":49,"tag":1060,"props":5110,"children":5111},{"style":1073},[5112],{"type":55,"value":5113},"environment",{"type":49,"tag":1060,"props":5115,"children":5116},{"style":3488},[5117],{"type":55,"value":3511},{"type":49,"tag":1060,"props":5119,"children":5120},{"style":2215},[5121],{"type":55,"value":3786},{"type":49,"tag":1060,"props":5123,"children":5124},{"style":1073},[5125],{"type":55,"value":5126},")\n",{"type":49,"tag":1060,"props":5128,"children":5129},{"class":1062,"line":1079},[5130],{"type":49,"tag":1060,"props":5131,"children":5132},{"emptyLinePlaceholder":44},[5133],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5135,"children":5136},{"class":1062,"line":1088},[5137,5141,5146,5150,5155,5160,5164,5169,5174,5179,5184,5188,5193,5198,5204],{"type":49,"tag":1060,"props":5138,"children":5139},{"style":2182},[5140],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5142,"children":5143},{"style":2188},[5144],{"type":55,"value":5145}," vpcId",{"type":49,"tag":1060,"props":5147,"children":5148},{"style":2194},[5149],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5151,"children":5152},{"style":1073},[5153],{"type":55,"value":5154}," stackReference.",{"type":49,"tag":1060,"props":5156,"children":5157},{"style":1067},[5158],{"type":55,"value":5159},"getOutput",{"type":49,"tag":1060,"props":5161,"children":5162},{"style":1073},[5163],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5165,"children":5166},{"style":2215},[5167],{"type":55,"value":5168},"\"vpcId\"",{"type":49,"tag":1060,"props":5170,"children":5171},{"style":1073},[5172],{"type":55,"value":5173},") ",{"type":49,"tag":1060,"props":5175,"children":5176},{"style":2194},[5177],{"type":55,"value":5178},"as",{"type":49,"tag":1060,"props":5180,"children":5181},{"style":3992},[5182],{"type":55,"value":5183}," pulumi",{"type":49,"tag":1060,"props":5185,"children":5186},{"style":1073},[5187],{"type":55,"value":745},{"type":49,"tag":1060,"props":5189,"children":5190},{"style":3992},[5191],{"type":55,"value":5192},"Output",{"type":49,"tag":1060,"props":5194,"children":5195},{"style":1073},[5196],{"type":55,"value":5197},"\u003C",{"type":49,"tag":1060,"props":5199,"children":5201},{"style":5200},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[5202],{"type":55,"value":5203},"string",{"type":49,"tag":1060,"props":5205,"children":5206},{"style":1073},[5207],{"type":55,"value":5208},">;\n",{"type":49,"tag":1060,"props":5210,"children":5211},{"class":1062,"line":1097},[5212,5216,5221,5225,5229,5233,5237,5242,5246,5250,5254,5258,5262,5266,5270],{"type":49,"tag":1060,"props":5213,"children":5214},{"style":2182},[5215],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5217,"children":5218},{"style":2188},[5219],{"type":55,"value":5220}," assetsBucketName",{"type":49,"tag":1060,"props":5222,"children":5223},{"style":2194},[5224],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5226,"children":5227},{"style":1073},[5228],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5230,"children":5231},{"style":1067},[5232],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5234,"children":5235},{"style":1073},[5236],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5238,"children":5239},{"style":2215},[5240],{"type":55,"value":5241},"\"assetsBucketName\"",{"type":49,"tag":1060,"props":5243,"children":5244},{"style":1073},[5245],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5247,"children":5248},{"style":2194},[5249],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5251,"children":5252},{"style":3992},[5253],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5255,"children":5256},{"style":1073},[5257],{"type":55,"value":745},{"type":49,"tag":1060,"props":5259,"children":5260},{"style":3992},[5261],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5263,"children":5264},{"style":1073},[5265],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5267,"children":5268},{"style":5200},[5269],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5271,"children":5272},{"style":1073},[5273],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5275,"children":5276},{"class":1062,"line":1111},[5277,5281,5286,5290,5294,5298,5302,5307,5311,5315,5319,5323,5327,5331,5335],{"type":49,"tag":1060,"props":5278,"children":5279},{"style":2182},[5280],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5282,"children":5283},{"style":2188},[5284],{"type":55,"value":5285}," privateSubnets",{"type":49,"tag":1060,"props":5287,"children":5288},{"style":2194},[5289],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5291,"children":5292},{"style":1073},[5293],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5295,"children":5296},{"style":1067},[5297],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5299,"children":5300},{"style":1073},[5301],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5303,"children":5304},{"style":2215},[5305],{"type":55,"value":5306},"\"privateSubnetIds\"",{"type":49,"tag":1060,"props":5308,"children":5309},{"style":1073},[5310],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5312,"children":5313},{"style":2194},[5314],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5316,"children":5317},{"style":3992},[5318],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5320,"children":5321},{"style":1073},[5322],{"type":55,"value":745},{"type":49,"tag":1060,"props":5324,"children":5325},{"style":3992},[5326],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5328,"children":5329},{"style":1073},[5330],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5332,"children":5333},{"style":5200},[5334],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5336,"children":5337},{"style":1073},[5338],{"type":55,"value":5339},"[]>;\n",{"type":49,"tag":1060,"props":5341,"children":5342},{"class":1062,"line":1120},[5343,5347,5352,5356,5360,5364,5368,5373,5377,5381,5385,5389,5393,5397,5401],{"type":49,"tag":1060,"props":5344,"children":5345},{"style":2182},[5346],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5348,"children":5349},{"style":2188},[5350],{"type":55,"value":5351}," appSgId",{"type":49,"tag":1060,"props":5353,"children":5354},{"style":2194},[5355],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5357,"children":5358},{"style":1073},[5359],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5361,"children":5362},{"style":1067},[5363],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5365,"children":5366},{"style":1073},[5367],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5369,"children":5370},{"style":2215},[5371],{"type":55,"value":5372},"\"appSgId\"",{"type":49,"tag":1060,"props":5374,"children":5375},{"style":1073},[5376],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5378,"children":5379},{"style":2194},[5380],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5382,"children":5383},{"style":3992},[5384],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5386,"children":5387},{"style":1073},[5388],{"type":55,"value":745},{"type":49,"tag":1060,"props":5390,"children":5391},{"style":3992},[5392],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5394,"children":5395},{"style":1073},[5396],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5398,"children":5399},{"style":5200},[5400],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5402,"children":5403},{"style":1073},[5404],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5406,"children":5407},{"class":1062,"line":1128},[5408,5412,5417,5421,5425,5429,5433,5438,5442,5446,5450,5454,5458,5462,5466],{"type":49,"tag":1060,"props":5409,"children":5410},{"style":2182},[5411],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5413,"children":5414},{"style":2188},[5415],{"type":55,"value":5416}," albSgId",{"type":49,"tag":1060,"props":5418,"children":5419},{"style":2194},[5420],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5422,"children":5423},{"style":1073},[5424],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5426,"children":5427},{"style":1067},[5428],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5430,"children":5431},{"style":1073},[5432],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5434,"children":5435},{"style":2215},[5436],{"type":55,"value":5437},"\"albSgId\"",{"type":49,"tag":1060,"props":5439,"children":5440},{"style":1073},[5441],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5443,"children":5444},{"style":2194},[5445],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5447,"children":5448},{"style":3992},[5449],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5451,"children":5452},{"style":1073},[5453],{"type":55,"value":745},{"type":49,"tag":1060,"props":5455,"children":5456},{"style":3992},[5457],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5459,"children":5460},{"style":1073},[5461],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5463,"children":5464},{"style":5200},[5465],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5467,"children":5468},{"style":1073},[5469],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5471,"children":5472},{"class":1062,"line":1141},[5473,5477,5482,5486,5490,5494,5498,5503,5507,5511,5515,5519,5523,5527,5531],{"type":49,"tag":1060,"props":5474,"children":5475},{"style":2182},[5476],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5478,"children":5479},{"style":2188},[5480],{"type":55,"value":5481}," listenerArn",{"type":49,"tag":1060,"props":5483,"children":5484},{"style":2194},[5485],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5487,"children":5488},{"style":1073},[5489],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5491,"children":5492},{"style":1067},[5493],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5495,"children":5496},{"style":1073},[5497],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5499,"children":5500},{"style":2215},[5501],{"type":55,"value":5502},"\"listenerArn\"",{"type":49,"tag":1060,"props":5504,"children":5505},{"style":1073},[5506],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5508,"children":5509},{"style":2194},[5510],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5512,"children":5513},{"style":3992},[5514],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5516,"children":5517},{"style":1073},[5518],{"type":55,"value":745},{"type":49,"tag":1060,"props":5520,"children":5521},{"style":3992},[5522],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5524,"children":5525},{"style":1073},[5526],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5528,"children":5529},{"style":5200},[5530],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5532,"children":5533},{"style":1073},[5534],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5536,"children":5537},{"class":1062,"line":1150},[5538,5542,5547,5551,5555,5559,5563,5568,5572,5576,5580,5584,5588,5592,5596],{"type":49,"tag":1060,"props":5539,"children":5540},{"style":2182},[5541],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5543,"children":5544},{"style":2188},[5545],{"type":55,"value":5546}," albDnsName",{"type":49,"tag":1060,"props":5548,"children":5549},{"style":2194},[5550],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5552,"children":5553},{"style":1073},[5554],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5556,"children":5557},{"style":1067},[5558],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5560,"children":5561},{"style":1073},[5562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5564,"children":5565},{"style":2215},[5566],{"type":55,"value":5567},"\"albDnsName\"",{"type":49,"tag":1060,"props":5569,"children":5570},{"style":1073},[5571],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5573,"children":5574},{"style":2194},[5575],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5577,"children":5578},{"style":3992},[5579],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5581,"children":5582},{"style":1073},[5583],{"type":55,"value":745},{"type":49,"tag":1060,"props":5585,"children":5586},{"style":3992},[5587],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5589,"children":5590},{"style":1073},[5591],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5593,"children":5594},{"style":5200},[5595],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5597,"children":5598},{"style":1073},[5599],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5601,"children":5602},{"class":1062,"line":1158},[5603,5607,5612,5616,5620,5624,5628,5633,5637,5641,5645,5649,5653,5657,5661],{"type":49,"tag":1060,"props":5604,"children":5605},{"style":2182},[5606],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5608,"children":5609},{"style":2188},[5610],{"type":55,"value":5611}," serviceDiscoveryNamespaceId",{"type":49,"tag":1060,"props":5613,"children":5614},{"style":2194},[5615],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5617,"children":5618},{"style":1073},[5619],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5621,"children":5622},{"style":1067},[5623],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5625,"children":5626},{"style":1073},[5627],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5629,"children":5630},{"style":2215},[5631],{"type":55,"value":5632},"\"serviceDiscoveryNamespaceId\"",{"type":49,"tag":1060,"props":5634,"children":5635},{"style":1073},[5636],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5638,"children":5639},{"style":2194},[5640],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5642,"children":5643},{"style":3992},[5644],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5646,"children":5647},{"style":1073},[5648],{"type":55,"value":745},{"type":49,"tag":1060,"props":5650,"children":5651},{"style":3992},[5652],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5654,"children":5655},{"style":1073},[5656],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5658,"children":5659},{"style":5200},[5660],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5662,"children":5663},{"style":1073},[5664],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5666,"children":5667},{"class":1062,"line":1171},[5668,5672,5677,5681,5685,5689,5693,5698,5702,5706,5710,5714,5718,5722,5726],{"type":49,"tag":1060,"props":5669,"children":5670},{"style":2182},[5671],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5673,"children":5674},{"style":2188},[5675],{"type":55,"value":5676}," rdsAddress",{"type":49,"tag":1060,"props":5678,"children":5679},{"style":2194},[5680],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5682,"children":5683},{"style":1073},[5684],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5686,"children":5687},{"style":1067},[5688],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5690,"children":5691},{"style":1073},[5692],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5694,"children":5695},{"style":2215},[5696],{"type":55,"value":5697},"\"rdsAddress\"",{"type":49,"tag":1060,"props":5699,"children":5700},{"style":1073},[5701],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5703,"children":5704},{"style":2194},[5705],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5707,"children":5708},{"style":3992},[5709],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5711,"children":5712},{"style":1073},[5713],{"type":55,"value":745},{"type":49,"tag":1060,"props":5715,"children":5716},{"style":3992},[5717],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5719,"children":5720},{"style":1073},[5721],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5723,"children":5724},{"style":5200},[5725],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5727,"children":5728},{"style":1073},[5729],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5731,"children":5732},{"class":1062,"line":1180},[5733,5737,5742,5746,5750,5754,5758,5763,5767,5771,5775,5779,5783,5787,5791],{"type":49,"tag":1060,"props":5734,"children":5735},{"style":2182},[5736],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5738,"children":5739},{"style":2188},[5740],{"type":55,"value":5741}," domainName",{"type":49,"tag":1060,"props":5743,"children":5744},{"style":2194},[5745],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5747,"children":5748},{"style":1073},[5749],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5751,"children":5752},{"style":1067},[5753],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5755,"children":5756},{"style":1073},[5757],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5759,"children":5760},{"style":2215},[5761],{"type":55,"value":5762},"\"domainName\"",{"type":49,"tag":1060,"props":5764,"children":5765},{"style":1073},[5766],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5768,"children":5769},{"style":2194},[5770],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5772,"children":5773},{"style":3992},[5774],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5776,"children":5777},{"style":1073},[5778],{"type":55,"value":745},{"type":49,"tag":1060,"props":5780,"children":5781},{"style":3992},[5782],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5784,"children":5785},{"style":1073},[5786],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5788,"children":5789},{"style":5200},[5790],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5792,"children":5793},{"style":1073},[5794],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5796,"children":5797},{"class":1062,"line":1188},[5798,5802,5807,5811,5815,5819,5823,5828,5832,5836,5840,5844,5848,5852,5856],{"type":49,"tag":1060,"props":5799,"children":5800},{"style":2182},[5801],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5803,"children":5804},{"style":2188},[5805],{"type":55,"value":5806}," baseStackName",{"type":49,"tag":1060,"props":5808,"children":5809},{"style":2194},[5810],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5812,"children":5813},{"style":1073},[5814],{"type":55,"value":5154},{"type":49,"tag":1060,"props":5816,"children":5817},{"style":1067},[5818],{"type":55,"value":5159},{"type":49,"tag":1060,"props":5820,"children":5821},{"style":1073},[5822],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5824,"children":5825},{"style":2215},[5826],{"type":55,"value":5827},"\"baseStackName\"",{"type":49,"tag":1060,"props":5829,"children":5830},{"style":1073},[5831],{"type":55,"value":5173},{"type":49,"tag":1060,"props":5833,"children":5834},{"style":2194},[5835],{"type":55,"value":5178},{"type":49,"tag":1060,"props":5837,"children":5838},{"style":3992},[5839],{"type":55,"value":5183},{"type":49,"tag":1060,"props":5841,"children":5842},{"style":1073},[5843],{"type":55,"value":745},{"type":49,"tag":1060,"props":5845,"children":5846},{"style":3992},[5847],{"type":55,"value":5192},{"type":49,"tag":1060,"props":5849,"children":5850},{"style":1073},[5851],{"type":55,"value":5197},{"type":49,"tag":1060,"props":5853,"children":5854},{"style":5200},[5855],{"type":55,"value":5203},{"type":49,"tag":1060,"props":5857,"children":5858},{"style":1073},[5859],{"type":55,"value":5208},{"type":49,"tag":1060,"props":5861,"children":5862},{"class":1062,"line":1201},[5863],{"type":49,"tag":1060,"props":5864,"children":5865},{"emptyLinePlaceholder":44},[5866],{"type":55,"value":1094},{"type":49,"tag":1060,"props":5868,"children":5869},{"class":1062,"line":1210},[5870],{"type":49,"tag":1060,"props":5871,"children":5872},{"style":3039},[5873],{"type":55,"value":5874},"// ad hoc app env\n",{"type":49,"tag":1060,"props":5876,"children":5877},{"class":1062,"line":1218},[5878,5882,5887,5891,5895,5900,5904,5909],{"type":49,"tag":1060,"props":5879,"children":5880},{"style":2182},[5881],{"type":55,"value":4734},{"type":49,"tag":1060,"props":5883,"children":5884},{"style":2188},[5885],{"type":55,"value":5886}," adHocAppComponent",{"type":49,"tag":1060,"props":5888,"children":5889},{"style":2194},[5890],{"type":55,"value":2197},{"type":49,"tag":1060,"props":5892,"children":5893},{"style":2194},[5894],{"type":55,"value":2202},{"type":49,"tag":1060,"props":5896,"children":5897},{"style":1067},[5898],{"type":55,"value":5899}," AdHocAppComponent",{"type":49,"tag":1060,"props":5901,"children":5902},{"style":1073},[5903],{"type":55,"value":2284},{"type":49,"tag":1060,"props":5905,"children":5906},{"style":2215},[5907],{"type":55,"value":5908},"\"AdHocAppComponent\"",{"type":49,"tag":1060,"props":5910,"children":5911},{"style":1073},[5912],{"type":55,"value":2223},{"type":49,"tag":1060,"props":5914,"children":5915},{"class":1062,"line":1232},[5916],{"type":49,"tag":1060,"props":5917,"children":5918},{"style":1073},[5919],{"type":55,"value":5920},"  vpcId,\n",{"type":49,"tag":1060,"props":5922,"children":5923},{"class":1062,"line":1241},[5924],{"type":49,"tag":1060,"props":5925,"children":5926},{"style":1073},[5927],{"type":55,"value":5928},"  assetsBucketName,\n",{"type":49,"tag":1060,"props":5930,"children":5931},{"class":1062,"line":1249},[5932],{"type":49,"tag":1060,"props":5933,"children":5934},{"style":1073},[5935],{"type":55,"value":5936},"  privateSubnets,\n",{"type":49,"tag":1060,"props":5938,"children":5939},{"class":1062,"line":1262},[5940],{"type":49,"tag":1060,"props":5941,"children":5942},{"style":1073},[5943],{"type":55,"value":5944},"  appSgId,\n",{"type":49,"tag":1060,"props":5946,"children":5947},{"class":1062,"line":4581},[5948],{"type":49,"tag":1060,"props":5949,"children":5950},{"style":1073},[5951],{"type":55,"value":5952},"  albSgId,\n",{"type":49,"tag":1060,"props":5954,"children":5955},{"class":1062,"line":4631},[5956],{"type":49,"tag":1060,"props":5957,"children":5958},{"style":1073},[5959],{"type":55,"value":5960},"  listenerArn,\n",{"type":49,"tag":1060,"props":5962,"children":5963},{"class":1062,"line":4682},[5964],{"type":49,"tag":1060,"props":5965,"children":5966},{"style":1073},[5967],{"type":55,"value":5968},"  albDnsName,\n",{"type":49,"tag":1060,"props":5970,"children":5971},{"class":1062,"line":4709},[5972],{"type":49,"tag":1060,"props":5973,"children":5974},{"style":1073},[5975],{"type":55,"value":5976},"  serviceDiscoveryNamespaceId,\n",{"type":49,"tag":1060,"props":5978,"children":5980},{"class":1062,"line":5979},25,[5981],{"type":49,"tag":1060,"props":5982,"children":5983},{"style":1073},[5984],{"type":55,"value":5985},"  rdsAddress,\n",{"type":49,"tag":1060,"props":5987,"children":5989},{"class":1062,"line":5988},26,[5990],{"type":49,"tag":1060,"props":5991,"children":5992},{"style":1073},[5993],{"type":55,"value":5994},"  domainName,\n",{"type":49,"tag":1060,"props":5996,"children":5998},{"class":1062,"line":5997},27,[5999],{"type":49,"tag":1060,"props":6000,"children":6001},{"style":1073},[6002],{"type":55,"value":6003},"  baseStackName\n",{"type":49,"tag":1060,"props":6005,"children":6007},{"class":1062,"line":6006},28,[6008],{"type":49,"tag":1060,"props":6009,"children":6010},{"style":1073},[6011],{"type":55,"value":5037},{"type":49,"tag":50,"props":6013,"children":6015},{"id":6014},"cli-scaffolding",[6016],{"type":55,"value":6017},"CLI scaffolding",{"type":49,"tag":58,"props":6019,"children":6020},{},[6021],{"type":55,"value":6022},"CDK and Pulumi have some good options for how to scaffold a project.",{"type":49,"tag":64,"props":6024,"children":6025},{},[6026,6054,6066,6084],{"type":49,"tag":68,"props":6027,"children":6028},{},[6029,6031,6037,6039,6045,6047,6052],{"type":55,"value":6030},"Pulumi has ",{"type":49,"tag":326,"props":6032,"children":6034},{"className":6033},[],[6035],{"type":55,"value":6036},"pulumi new aws-typescript",{"type":55,"value":6038}," among lots of other options (run ",{"type":49,"tag":326,"props":6040,"children":6042},{"className":6041},[],[6043],{"type":55,"value":6044},"pulumi new -l",{"type":55,"value":6046}," to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in ",{"type":49,"tag":326,"props":6048,"children":6050},{"className":6049},[],[6051],{"type":55,"value":1627},{"type":55,"value":6053}," that consume the library.",{"type":49,"tag":68,"props":6055,"children":6056},{},[6057,6059,6064],{"type":55,"value":6058},"CDK has ",{"type":49,"tag":326,"props":6060,"children":6062},{"className":6061},[],[6063],{"type":55,"value":855},{"type":55,"value":6065}," CLI commands which can help set up either library code or project code",{"type":49,"tag":68,"props":6067,"children":6068},{},[6069,6071,6076,6077,6082],{"type":55,"value":6070},"The major benefits of these tools is setting up ",{"type":49,"tag":326,"props":6072,"children":6074},{"className":6073},[],[6075],{"type":55,"value":871},{"type":55,"value":715},{"type":49,"tag":326,"props":6078,"children":6080},{"className":6079},[],[6081],{"type":55,"value":824},{"type":55,"value":6083}," correctly",{"type":49,"tag":68,"props":6085,"children":6086},{},[6087],{"type":55,"value":6088},"Terraform is so simple that it doesn't really need tooling for scaffolding",{"type":49,"tag":50,"props":6090,"children":6092},{"id":6091},"best-practices",[6093],{"type":55,"value":6094},"Best practices",{"type":49,"tag":58,"props":6096,"children":6097},{},[6098,6100,6105,6107,6114],{"type":55,"value":6099},"For ",{"type":49,"tag":326,"props":6101,"children":6103},{"className":6102},[],[6104],{"type":55,"value":684},{"type":55,"value":6106},", I tried to follow the recommendations from ",{"type":49,"tag":80,"props":6108,"children":6111},{"href":6109,"rel":6110},"https://www.terraform-best-practices.com/",[84],[6112],{"type":55,"value":6113},"terraform-best-practices.com",{"type":55,"value":6115}," which helped me a lot with things like consistent naming patterns and directory structures. For example:",{"type":49,"tag":64,"props":6117,"children":6118},{},[6119],{"type":49,"tag":68,"props":6120,"children":6121},{},[6122,6124,6129],{"type":55,"value":6123},"use the name ",{"type":49,"tag":326,"props":6125,"children":6127},{"className":6126},[],[6128],{"type":55,"value":4165},{"type":55,"value":6130}," for resources in a module where that resource is the only resource of its type",{"type":49,"tag":58,"props":6132,"children":6133},{},[6134],{"type":55,"value":6135},"CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi.",{"type":49,"tag":58,"props":6137,"children":6138},{},[6139,6141,6146,6147,6152,6153,6159,6160,6166,6167,6173,6175,6181,6182,6188],{"type":55,"value":6140},"For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of ",{"type":49,"tag":326,"props":6142,"children":6144},{"className":6143},[],[6145],{"type":55,"value":2065},{"type":55,"value":873},{"type":49,"tag":326,"props":6148,"children":6150},{"className":6149},[],[6151],{"type":55,"value":2766},{"type":55,"value":873},{"type":49,"tag":326,"props":6154,"children":6156},{"className":6155},[],[6157],{"type":55,"value":6158},"pulumi.interpolate",{"type":55,"value":873},{"type":49,"tag":326,"props":6161,"children":6163},{"className":6162},[],[6164],{"type":55,"value":6165},"apply()",{"type":55,"value":873},{"type":49,"tag":326,"props":6168,"children":6170},{"className":6169},[],[6171],{"type":55,"value":6172},"all()",{"type":55,"value":6174}," and the differences between ",{"type":49,"tag":326,"props":6176,"children":6178},{"className":6177},[],[6179],{"type":55,"value":6180},"getX",{"type":55,"value":715},{"type":49,"tag":326,"props":6183,"children":6185},{"className":6184},[],[6186],{"type":55,"value":6187},"getXOutput",{"type":55,"value":6189},". There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way.",{"type":49,"tag":50,"props":6191,"children":6193},{"id":6192},"environment-configuration",[6194],{"type":55,"value":6195},"Environment configuration",{"type":49,"tag":58,"props":6197,"children":6198},{},[6199],{"type":55,"value":6200},"Environment configuration allows for either a base or app stack to be configured with non-default values. For example:",{"type":49,"tag":64,"props":6202,"children":6203},{},[6204,6209],{"type":49,"tag":68,"props":6205,"children":6206},{},[6207],{"type":55,"value":6208},"you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration",{"type":49,"tag":68,"props":6210,"children":6211},{},[6212],{"type":55,"value":6213},"You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config.",{"type":49,"tag":58,"props":6215,"children":6216},{},[6217],{"type":55,"value":6218},"In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values.",{"type":49,"tag":64,"props":6220,"children":6221},{},[6222,6243,6256],{"type":49,"tag":68,"props":6223,"children":6224},{},[6225,6227,6233,6235,6242],{"type":55,"value":6226},"Pulumi defines environment-specific config in files called ",{"type":49,"tag":326,"props":6228,"children":6230},{"className":6229},[],[6231],{"type":55,"value":6232},"Pulumi.{env}.yaml",{"type":55,"value":6234}," (",{"type":49,"tag":80,"props":6236,"children":6239},{"href":6237,"rel":6238},"https://www.pulumi.com/docs/intro/concepts/config/",[84],[6240],{"type":55,"value":6241},"Pulumi article on configuration",{"type":55,"value":616},{"type":49,"tag":68,"props":6244,"children":6245},{},[6246,6248,6254],{"type":55,"value":6247},"Terraform uses ",{"type":49,"tag":326,"props":6249,"children":6251},{"className":6250},[],[6252],{"type":55,"value":6253},"{env}.tfvars",{"type":55,"value":6255}," for this type of configuration",{"type":49,"tag":68,"props":6257,"children":6258},{},[6259,6261,6267],{"type":55,"value":6260},"CDK has several options for this type of configuration (",{"type":49,"tag":326,"props":6262,"children":6264},{"className":6263},[],[6265],{"type":55,"value":6266},"cdk.context.json",{"type":55,"value":6268},", extending stack props, etc.)",{"type":49,"tag":58,"props":6270,"children":6271},{},[6272,6274,6279,6281,6287],{"type":55,"value":6273},"For CDK I have been using ",{"type":49,"tag":326,"props":6275,"children":6277},{"className":6276},[],[6278],{"type":55,"value":4780},{"type":55,"value":6280}," and the ",{"type":49,"tag":326,"props":6282,"children":6284},{"className":6283},[],[6285],{"type":55,"value":6286},"tryGetContext",{"type":55,"value":6288}," method:",{"type":49,"tag":58,"props":6290,"children":6291},{},[6292,6297],{"type":49,"tag":326,"props":6293,"children":6295},{"className":6294},[],[6296],{"type":55,"value":4780},{"type":55,"value":6298}," needs to be set on the node before any child nodes are added:",{"type":49,"tag":1050,"props":6300,"children":6302},{"code":6301,"language":2171,"meta":8,"className":2172,"style":8},"const baseStack = new Stack(app, 'ExampleAdHocBaseStack', { env, stackName: adHocBaseEnvName });\nbaseStack.node.setContext('config', adHocBaseEnvConfig);\n\nconst appStack = new Stack(app, 'ExampleAdHocAppStack', { env, stackName: adHocAppEnvName });\nappStack.node.setContext('config', adHocAppEnvConfig);\n",[6303],{"type":49,"tag":326,"props":6304,"children":6305},{"__ignoreMap":8},[6306,6341,6364,6371,6406],{"type":49,"tag":1060,"props":6307,"children":6308},{"class":1062,"line":1063},[6309,6313,6317,6321,6325,6329,6333,6337],{"type":49,"tag":1060,"props":6310,"children":6311},{"style":2182},[6312],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6314,"children":6315},{"style":2188},[6316],{"type":55,"value":4739},{"type":49,"tag":1060,"props":6318,"children":6319},{"style":2194},[6320],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6322,"children":6323},{"style":2194},[6324],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6326,"children":6327},{"style":1067},[6328],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6330,"children":6331},{"style":1073},[6332],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6334,"children":6335},{"style":2215},[6336],{"type":55,"value":4762},{"type":49,"tag":1060,"props":6338,"children":6339},{"style":1073},[6340],{"type":55,"value":4767},{"type":49,"tag":1060,"props":6342,"children":6343},{"class":1062,"line":1079},[6344,6348,6352,6356,6360],{"type":49,"tag":1060,"props":6345,"children":6346},{"style":1073},[6347],{"type":55,"value":4775},{"type":49,"tag":1060,"props":6349,"children":6350},{"style":1067},[6351],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6353,"children":6354},{"style":1073},[6355],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6357,"children":6358},{"style":2215},[6359],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6361,"children":6362},{"style":1073},[6363],{"type":55,"value":4794},{"type":49,"tag":1060,"props":6365,"children":6366},{"class":1062,"line":1088},[6367],{"type":49,"tag":1060,"props":6368,"children":6369},{"emptyLinePlaceholder":44},[6370],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6372,"children":6373},{"class":1062,"line":1097},[6374,6378,6382,6386,6390,6394,6398,6402],{"type":49,"tag":1060,"props":6375,"children":6376},{"style":2182},[6377],{"type":55,"value":4734},{"type":49,"tag":1060,"props":6379,"children":6380},{"style":2188},[6381],{"type":55,"value":4813},{"type":49,"tag":1060,"props":6383,"children":6384},{"style":2194},[6385],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6387,"children":6388},{"style":2194},[6389],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6391,"children":6392},{"style":1067},[6393],{"type":55,"value":4752},{"type":49,"tag":1060,"props":6395,"children":6396},{"style":1073},[6397],{"type":55,"value":4757},{"type":49,"tag":1060,"props":6399,"children":6400},{"style":2215},[6401],{"type":55,"value":4834},{"type":49,"tag":1060,"props":6403,"children":6404},{"style":1073},[6405],{"type":55,"value":4839},{"type":49,"tag":1060,"props":6407,"children":6408},{"class":1062,"line":1111},[6409,6413,6417,6421,6425],{"type":49,"tag":1060,"props":6410,"children":6411},{"style":1073},[6412],{"type":55,"value":4847},{"type":49,"tag":1060,"props":6414,"children":6415},{"style":1067},[6416],{"type":55,"value":4780},{"type":49,"tag":1060,"props":6418,"children":6419},{"style":1073},[6420],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6422,"children":6423},{"style":2215},[6424],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6426,"children":6427},{"style":1073},[6428],{"type":55,"value":4864},{"type":49,"tag":58,"props":6430,"children":6431},{},[6432],{"type":55,"value":6433},"And the config objects are read from JSON files like this:",{"type":49,"tag":1050,"props":6435,"children":6437},{"code":6436,"language":2171,"meta":8,"className":2172,"style":8},"var adHocBaseEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/base/config/${adHocBaseEnvName}.json`, 'utf8'));\nvar adHocAppEnvConfig = JSON.parse(fs.readFileSync(`src/examples/ad-hoc/app/config/${adHocAppEnvName}.json`, 'utf8'));\n",[6438],{"type":49,"tag":326,"props":6439,"children":6440},{"__ignoreMap":8},[6441,6523],{"type":49,"tag":1060,"props":6442,"children":6443},{"class":1062,"line":1063},[6444,6449,6454,6458,6463,6467,6472,6477,6482,6486,6491,6495,6500,6504,6509,6513,6518],{"type":49,"tag":1060,"props":6445,"children":6446},{"style":2182},[6447],{"type":55,"value":6448},"var",{"type":49,"tag":1060,"props":6450,"children":6451},{"style":1073},[6452],{"type":55,"value":6453}," adHocBaseEnvConfig ",{"type":49,"tag":1060,"props":6455,"children":6456},{"style":2194},[6457],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6459,"children":6460},{"style":2188},[6461],{"type":55,"value":6462}," JSON",{"type":49,"tag":1060,"props":6464,"children":6465},{"style":1073},[6466],{"type":55,"value":745},{"type":49,"tag":1060,"props":6468,"children":6469},{"style":1067},[6470],{"type":55,"value":6471},"parse",{"type":49,"tag":1060,"props":6473,"children":6474},{"style":1073},[6475],{"type":55,"value":6476},"(fs.",{"type":49,"tag":1060,"props":6478,"children":6479},{"style":1067},[6480],{"type":55,"value":6481},"readFileSync",{"type":49,"tag":1060,"props":6483,"children":6484},{"style":1073},[6485],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6487,"children":6488},{"style":2215},[6489],{"type":55,"value":6490},"`src/examples/ad-hoc/base/config/",{"type":49,"tag":1060,"props":6492,"children":6493},{"style":3488},[6494],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6496,"children":6497},{"style":1073},[6498],{"type":55,"value":6499},"adHocBaseEnvName",{"type":49,"tag":1060,"props":6501,"children":6502},{"style":3488},[6503],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6505,"children":6506},{"style":2215},[6507],{"type":55,"value":6508},".json`",{"type":49,"tag":1060,"props":6510,"children":6511},{"style":1073},[6512],{"type":55,"value":873},{"type":49,"tag":1060,"props":6514,"children":6515},{"style":2215},[6516],{"type":55,"value":6517},"'utf8'",{"type":49,"tag":1060,"props":6519,"children":6520},{"style":1073},[6521],{"type":55,"value":6522},"));\n",{"type":49,"tag":1060,"props":6524,"children":6525},{"class":1062,"line":1079},[6526,6530,6535,6539,6543,6547,6551,6555,6559,6563,6568,6572,6577,6581,6585,6589,6593],{"type":49,"tag":1060,"props":6527,"children":6528},{"style":2182},[6529],{"type":55,"value":6448},{"type":49,"tag":1060,"props":6531,"children":6532},{"style":1073},[6533],{"type":55,"value":6534}," adHocAppEnvConfig ",{"type":49,"tag":1060,"props":6536,"children":6537},{"style":2194},[6538],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6540,"children":6541},{"style":2188},[6542],{"type":55,"value":6462},{"type":49,"tag":1060,"props":6544,"children":6545},{"style":1073},[6546],{"type":55,"value":745},{"type":49,"tag":1060,"props":6548,"children":6549},{"style":1067},[6550],{"type":55,"value":6471},{"type":49,"tag":1060,"props":6552,"children":6553},{"style":1073},[6554],{"type":55,"value":6476},{"type":49,"tag":1060,"props":6556,"children":6557},{"style":1067},[6558],{"type":55,"value":6481},{"type":49,"tag":1060,"props":6560,"children":6561},{"style":1073},[6562],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6564,"children":6565},{"style":2215},[6566],{"type":55,"value":6567},"`src/examples/ad-hoc/app/config/",{"type":49,"tag":1060,"props":6569,"children":6570},{"style":3488},[6571],{"type":55,"value":3491},{"type":49,"tag":1060,"props":6573,"children":6574},{"style":1073},[6575],{"type":55,"value":6576},"adHocAppEnvName",{"type":49,"tag":1060,"props":6578,"children":6579},{"style":3488},[6580],{"type":55,"value":3511},{"type":49,"tag":1060,"props":6582,"children":6583},{"style":2215},[6584],{"type":55,"value":6508},{"type":49,"tag":1060,"props":6586,"children":6587},{"style":1073},[6588],{"type":55,"value":873},{"type":49,"tag":1060,"props":6590,"children":6591},{"style":2215},[6592],{"type":55,"value":6517},{"type":49,"tag":1060,"props":6594,"children":6595},{"style":1073},[6596],{"type":55,"value":6522},{"type":49,"tag":58,"props":6598,"children":6599},{},[6600],{"type":55,"value":6601},"The context can be used in constructs like this:",{"type":49,"tag":1050,"props":6603,"children":6605},{"code":6604,"language":2171,"meta":8,"className":2172,"style":8},"    const extraEnvVars = this.node.tryGetContext('config').extraEnvVars;\n",[6606],{"type":49,"tag":326,"props":6607,"children":6608},{"__ignoreMap":8},[6609],{"type":49,"tag":1060,"props":6610,"children":6611},{"class":1062,"line":1063},[6612,6616,6621,6625,6630,6635,6639,6643,6647],{"type":49,"tag":1060,"props":6613,"children":6614},{"style":2182},[6615],{"type":55,"value":2185},{"type":49,"tag":1060,"props":6617,"children":6618},{"style":2188},[6619],{"type":55,"value":6620}," extraEnvVars",{"type":49,"tag":1060,"props":6622,"children":6623},{"style":2194},[6624],{"type":55,"value":2197},{"type":49,"tag":1060,"props":6626,"children":6627},{"style":3797},[6628],{"type":55,"value":6629}," this",{"type":49,"tag":1060,"props":6631,"children":6632},{"style":1073},[6633],{"type":55,"value":6634},".node.",{"type":49,"tag":1060,"props":6636,"children":6637},{"style":1067},[6638],{"type":55,"value":6286},{"type":49,"tag":1060,"props":6640,"children":6641},{"style":1073},[6642],{"type":55,"value":2284},{"type":49,"tag":1060,"props":6644,"children":6645},{"style":2215},[6646],{"type":55,"value":4789},{"type":49,"tag":1060,"props":6648,"children":6649},{"style":1073},[6650],{"type":55,"value":6651},").extraEnvVars;\n",{"type":49,"tag":58,"props":6653,"children":6654},{},[6655],{"type":55,"value":6656},"Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:",{"type":49,"tag":1050,"props":6658,"children":6660},{"code":6659,"language":2171,"meta":8,"className":2172,"style":8},"    interface EnvVar {\n      name: string;\n      value: string;\n    }\n\n    let config = new pulumi.Config();\n    let extraEnvVars = config.getObject\u003CEnvVar[]>(\"extraEnvVars\");\n",[6661],{"type":49,"tag":326,"props":6662,"children":6663},{"__ignoreMap":8},[6664,6681,6704,6724,6731,6738,6773],{"type":49,"tag":1060,"props":6665,"children":6666},{"class":1062,"line":1063},[6667,6672,6677],{"type":49,"tag":1060,"props":6668,"children":6669},{"style":2182},[6670],{"type":55,"value":6671},"    interface",{"type":49,"tag":1060,"props":6673,"children":6674},{"style":3992},[6675],{"type":55,"value":6676}," EnvVar",{"type":49,"tag":1060,"props":6678,"children":6679},{"style":1073},[6680],{"type":55,"value":4010},{"type":49,"tag":1060,"props":6682,"children":6683},{"class":1062,"line":1079},[6684,6690,6695,6700],{"type":49,"tag":1060,"props":6685,"children":6687},{"style":6686},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#F8F8F2",[6688],{"type":55,"value":6689},"      name",{"type":49,"tag":1060,"props":6691,"children":6692},{"style":2194},[6693],{"type":55,"value":6694},":",{"type":49,"tag":1060,"props":6696,"children":6697},{"style":5200},[6698],{"type":55,"value":6699}," string",{"type":49,"tag":1060,"props":6701,"children":6702},{"style":1073},[6703],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6705,"children":6706},{"class":1062,"line":1088},[6707,6712,6716,6720],{"type":49,"tag":1060,"props":6708,"children":6709},{"style":6686},[6710],{"type":55,"value":6711},"      value",{"type":49,"tag":1060,"props":6713,"children":6714},{"style":2194},[6715],{"type":55,"value":6694},{"type":49,"tag":1060,"props":6717,"children":6718},{"style":5200},[6719],{"type":55,"value":6699},{"type":49,"tag":1060,"props":6721,"children":6722},{"style":1073},[6723],{"type":55,"value":3791},{"type":49,"tag":1060,"props":6725,"children":6726},{"class":1062,"line":1097},[6727],{"type":49,"tag":1060,"props":6728,"children":6729},{"style":1073},[6730],{"type":55,"value":3100},{"type":49,"tag":1060,"props":6732,"children":6733},{"class":1062,"line":1111},[6734],{"type":49,"tag":1060,"props":6735,"children":6736},{"emptyLinePlaceholder":44},[6737],{"type":55,"value":1094},{"type":49,"tag":1060,"props":6739,"children":6740},{"class":1062,"line":1120},[6741,6746,6751,6755,6759,6763,6768],{"type":49,"tag":1060,"props":6742,"children":6743},{"style":2182},[6744],{"type":55,"value":6745},"    let",{"type":49,"tag":1060,"props":6747,"children":6748},{"style":1073},[6749],{"type":55,"value":6750}," config ",{"type":49,"tag":1060,"props":6752,"children":6753},{"style":2194},[6754],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6756,"children":6757},{"style":2194},[6758],{"type":55,"value":2202},{"type":49,"tag":1060,"props":6760,"children":6761},{"style":1073},[6762],{"type":55,"value":3459},{"type":49,"tag":1060,"props":6764,"children":6765},{"style":1067},[6766],{"type":55,"value":6767},"Config",{"type":49,"tag":1060,"props":6769,"children":6770},{"style":1073},[6771],{"type":55,"value":6772},"();\n",{"type":49,"tag":1060,"props":6774,"children":6775},{"class":1062,"line":1128},[6776,6780,6785,6789,6794,6799,6803,6808,6813,6818],{"type":49,"tag":1060,"props":6777,"children":6778},{"style":2182},[6779],{"type":55,"value":6745},{"type":49,"tag":1060,"props":6781,"children":6782},{"style":1073},[6783],{"type":55,"value":6784}," extraEnvVars ",{"type":49,"tag":1060,"props":6786,"children":6787},{"style":2194},[6788],{"type":55,"value":3068},{"type":49,"tag":1060,"props":6790,"children":6791},{"style":1073},[6792],{"type":55,"value":6793}," config.",{"type":49,"tag":1060,"props":6795,"children":6796},{"style":1067},[6797],{"type":55,"value":6798},"getObject",{"type":49,"tag":1060,"props":6800,"children":6801},{"style":1073},[6802],{"type":55,"value":5197},{"type":49,"tag":1060,"props":6804,"children":6805},{"style":3992},[6806],{"type":55,"value":6807},"EnvVar",{"type":49,"tag":1060,"props":6809,"children":6810},{"style":1073},[6811],{"type":55,"value":6812},"[]>(",{"type":49,"tag":1060,"props":6814,"children":6815},{"style":2215},[6816],{"type":55,"value":6817},"\"extraEnvVars\"",{"type":49,"tag":1060,"props":6819,"children":6820},{"style":1073},[6821],{"type":55,"value":2305},{"type":49,"tag":58,"props":6823,"children":6824},{},[6825,6827,6833,6835,6841],{"type":55,"value":6826},"In my ",{"type":49,"tag":326,"props":6828,"children":6830},{"className":6829},[],[6831],{"type":55,"value":6832},"Pulumi.alpha.yaml",{"type":55,"value":6834}," file I have the ",{"type":49,"tag":326,"props":6836,"children":6838},{"className":6837},[],[6839],{"type":55,"value":6840},"extraEnvVars",{"type":55,"value":6842}," set like this:",{"type":49,"tag":1050,"props":6844,"children":6846},{"code":6845,"language":3823,"meta":8,"className":3824,"style":8},"config:\n  aws:region: us-east-1\n  extraEnvVars:\n    - name: FOO\n      value: BAR\n    - name: BIZ\n      value: BUZ\n",[6847],{"type":49,"tag":326,"props":6848,"children":6849},{"__ignoreMap":8},[6850,6863,6880,6892,6913,6929,6949],{"type":49,"tag":1060,"props":6851,"children":6852},{"class":1062,"line":1063},[6853,6858],{"type":49,"tag":1060,"props":6854,"children":6855},{"style":3839},[6856],{"type":55,"value":6857},"config",{"type":49,"tag":1060,"props":6859,"children":6860},{"style":1073},[6861],{"type":55,"value":6862},":\n",{"type":49,"tag":1060,"props":6864,"children":6865},{"class":1062,"line":1079},[6866,6871,6875],{"type":49,"tag":1060,"props":6867,"children":6868},{"style":3839},[6869],{"type":55,"value":6870},"  aws:region",{"type":49,"tag":1060,"props":6872,"children":6873},{"style":1073},[6874],{"type":55,"value":78},{"type":49,"tag":1060,"props":6876,"children":6877},{"style":2215},[6878],{"type":55,"value":6879},"us-east-1\n",{"type":49,"tag":1060,"props":6881,"children":6882},{"class":1062,"line":1088},[6883,6888],{"type":49,"tag":1060,"props":6884,"children":6885},{"style":3839},[6886],{"type":55,"value":6887},"  extraEnvVars",{"type":49,"tag":1060,"props":6889,"children":6890},{"style":1073},[6891],{"type":55,"value":6862},{"type":49,"tag":1060,"props":6893,"children":6894},{"class":1062,"line":1097},[6895,6900,6904,6908],{"type":49,"tag":1060,"props":6896,"children":6897},{"style":1073},[6898],{"type":55,"value":6899},"    - ",{"type":49,"tag":1060,"props":6901,"children":6902},{"style":3839},[6903],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6905,"children":6906},{"style":1073},[6907],{"type":55,"value":78},{"type":49,"tag":1060,"props":6909,"children":6910},{"style":2215},[6911],{"type":55,"value":6912},"FOO\n",{"type":49,"tag":1060,"props":6914,"children":6915},{"class":1062,"line":1111},[6916,6920,6924],{"type":49,"tag":1060,"props":6917,"children":6918},{"style":3839},[6919],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6921,"children":6922},{"style":1073},[6923],{"type":55,"value":78},{"type":49,"tag":1060,"props":6925,"children":6926},{"style":2215},[6927],{"type":55,"value":6928},"BAR\n",{"type":49,"tag":1060,"props":6930,"children":6931},{"class":1062,"line":1120},[6932,6936,6940,6944],{"type":49,"tag":1060,"props":6933,"children":6934},{"style":1073},[6935],{"type":55,"value":6899},{"type":49,"tag":1060,"props":6937,"children":6938},{"style":3839},[6939],{"type":55,"value":3735},{"type":49,"tag":1060,"props":6941,"children":6942},{"style":1073},[6943],{"type":55,"value":78},{"type":49,"tag":1060,"props":6945,"children":6946},{"style":2215},[6947],{"type":55,"value":6948},"BIZ\n",{"type":49,"tag":1060,"props":6950,"children":6951},{"class":1062,"line":1128},[6952,6956,6960],{"type":49,"tag":1060,"props":6953,"children":6954},{"style":3839},[6955],{"type":55,"value":6711},{"type":49,"tag":1060,"props":6957,"children":6958},{"style":1073},[6959],{"type":55,"value":78},{"type":49,"tag":1060,"props":6961,"children":6962},{"style":2215},[6963],{"type":55,"value":6964},"BUZ\n",{"type":49,"tag":58,"props":6966,"children":6967},{},[6968],{"type":55,"value":6969},"I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per \"production\" environment (QA, stage, prod, etc.)",{"type":49,"tag":50,"props":6971,"children":6973},{"id":6972},"local-development",[6974],{"type":55,"value":6975},"Local development",{"type":49,"tag":58,"props":6977,"children":6978},{},[6979,6981,6986],{"type":55,"value":6980},"Using the Makefile targets in each library repo, my process for developing ",{"type":49,"tag":326,"props":6982,"children":6984},{"className":6983},[],[6985],{"type":55,"value":457},{"type":55,"value":6987},"s involves making code changes followed by Makefile targets that preview/plan/diff against my AWS account, then running deploy/apply/up and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services.",{"type":49,"tag":58,"props":6989,"children":6990},{},[6991],{"type":55,"value":6992},"Here are some sample times for deploying ad hoc stacks with CDK.",{"type":49,"tag":1050,"props":6994,"children":6996},{"code":6995},"# CDK ad hoc base deployment time\n\n â  ExampleAdHocBaseStack (dev)\n\nâ¨  Deployment time: 629.64s\n\n# CDK ad hoc app deployment time\n\n â  ExampleAdHocAppStack (alpha)\n\nâ¨  Deployment time: 126.62s\n",[6997],{"type":49,"tag":326,"props":6998,"children":6999},{"__ignoreMap":8},[7000],{"type":55,"value":6995},{"type":49,"tag":58,"props":7002,"children":7003},{},[7004,7006,7011],{"type":55,"value":7005},"Here is an example of what the ",{"type":49,"tag":326,"props":7007,"children":7009},{"className":7008},[],[7010],{"type":55,"value":572},{"type":55,"value":7012}," commands shows for the ad-hoc base stack:",{"type":49,"tag":1050,"props":7014,"children":7016},{"code":7015},"# Pulumi preview\n~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview\nPreviewing update (dev)\n\nView Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a\n\n     Type                                                    Name                        Plan\n +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create\n +   ââ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create\n +      ââ pulumi-contrib:components:AlbResources            AlbResources                create\n +      â  ââ aws:alb:TargetGroup                            DefaultTg                   create\n +      â  ââ aws:alb:LoadBalancer                           LoadBalancer                create\n +      â  ââ aws:alb:Listener                               HttpListener                create\n +      â  ââ aws:alb:Listener                               HttpsListener               create\n +      ââ pulumi-contrib:components:BastionHostResources    BastionHostResources        create\n +      â  ââ aws:iam:Role                                   BastionHostRole             create\n +      â  ââ aws:iam:RolePolicy                             BastionHostPolicy           create\n +      â  ââ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create\n +      â  ââ aws:ec2:Instance                               BastionHostInstance         create\n +      ââ pulumi-contrib:components:RdsResources            RdsResources                create\n +      â  ââ aws:rds:SubnetGroup                            DbSubnetGroup               create\n +      â  ââ aws:ec2:SecurityGroup                          RdsSecurityGroup            create\n +      â  ââ aws:rds:Instance                               DbInstance                  create\n +      ââ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create\n +      â  ââ aws:ec2:SecurityGroup                          AlbSecurityGroup            create\n +      â  ââ aws:ec2:SecurityGroup                          AppSecurityGroup            create\n +      ââ aws:s3:Bucket                                     assetsBucket                create\n +      ââ awsx:ec2:Vpc                                      dev                         create\n +      â  ââ aws:ec2:Vpc                                    dev                         create\n +      â     ââ aws:ec2:InternetGateway                     dev                         create\n +      â     ââ aws:ec2:Subnet                              dev-private-1               create\n +      â     â  ââ aws:ec2:RouteTable                       dev-private-1               create\n +      â     â     ââ aws:ec2:RouteTableAssociation         dev-private-1               create\n +      â     â     ââ aws:ec2:Route                         dev-private-1               create\n +      â     ââ aws:ec2:Subnet                              dev-private-2               create\n +      â     â  ââ aws:ec2:RouteTable                       dev-private-2               create\n +      â     â     ââ aws:ec2:RouteTableAssociation         dev-private-2               create\n +      â     â     ââ aws:ec2:Route                         dev-private-2               create\n +      â     ââ aws:ec2:Subnet                              dev-public-1                create\n +      â     â  ââ aws:ec2:RouteTable                       dev-public-1                create\n +      â     â  â  ââ aws:ec2:RouteTableAssociation         dev-public-1                create\n +      â     â  â  ââ aws:ec2:Route                         dev-public-1                create\n +      â     â  ââ aws:ec2:Eip                              dev-1                       create\n +      â     â  ââ aws:ec2:NatGateway                       dev-1                       create\n +      â     ââ aws:ec2:Subnet                              dev-public-2                create\n +      â        ââ aws:ec2:RouteTable                       dev-public-2                create\n +      â        â  ââ aws:ec2:RouteTableAssociation         dev-public-2                create\n +      â        â  ââ aws:ec2:Route                         dev-public-2                create\n +      â        ââ aws:ec2:Eip                              dev-2                       create\n +      â        ââ aws:ec2:NatGateway                       dev-2                       create\n +      ââ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create\n\n\nOutputs:\n    albDnsName                 : output\u003Cstring>\n    albSgId                    : output\u003Cstring>\n    appSgId                    : output\u003Cstring>\n    assetsBucketName           : output\u003Cstring>\n    baseStackName              : \"dev\"\n    bastionHostInstanceId      : output\u003Cstring>\n    domainName                 : \"example.com\"\n    listenerArn                : output\u003Cstring>\n    privateSubnetIds           : output\u003Cstring>\n    rdsAddress                 : output\u003Cstring>\n    serviceDiscoveryNamespaceId: output\u003Cstring>\n    vpcId                      : output\u003Cstring>\n\nResources:\n    + 44 to create\n",[7017],{"type":49,"tag":326,"props":7018,"children":7019},{"__ignoreMap":8},[7020],{"type":55,"value":7015},{"type":49,"tag":50,"props":7022,"children":7024},{"id":7023},"running-infrastructure-pipelines-in-github-actions",[7025],{"type":55,"value":7026},"Running infrastructure pipelines in GitHub Actions",{"type":49,"tag":58,"props":7028,"children":7029},{},[7030],{"type":49,"tag":126,"props":7031,"children":7032},{},[7033],{"type":55,"value":7034},"I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!",{"type":49,"tag":58,"props":7036,"children":7037},{},[7038,7039,7045,7047,7052,7054,7060],{"type":55,"value":2613},{"type":49,"tag":326,"props":7040,"children":7042},{"className":7041},[],[7043],{"type":55,"value":7044},".github/workflows",{"type":55,"value":7046}," directory of the ",{"type":49,"tag":326,"props":7048,"children":7050},{"className":7049},[],[7051],{"type":55,"value":1627},{"type":55,"value":7053}," repo, I will have the following ",{"type":49,"tag":326,"props":7055,"children":7057},{"className":7056},[],[7058],{"type":55,"value":7059},"2 * 2 * 2 * 3 = 24",{"type":55,"value":7061}," pipelines for running infrastructure as code pipelines:",{"type":49,"tag":1050,"props":7063,"children":7065},{"code":7064,"language":2728,"meta":8,"className":2729,"style":8},"{ad_hoc,prod}_{base,app}_{create_update,destroy}_{cdk,terraform,pulumi}.yml\n",[7066],{"type":49,"tag":326,"props":7067,"children":7068},{"__ignoreMap":8},[7069],{"type":49,"tag":1060,"props":7070,"children":7071},{"class":1062,"line":1063},[7072],{"type":49,"tag":1060,"props":7073,"children":7074},{"style":1073},[7075],{"type":55,"value":7064},{"type":49,"tag":64,"props":7077,"children":7078},{},[7079,7084,7089],{"type":49,"tag":68,"props":7080,"children":7081},{},[7082],{"type":55,"value":7083},"For CDK I'm using CDK CLI commands",{"type":49,"tag":68,"props":7085,"children":7086},{},[7087],{"type":55,"value":7088},"For Terraform I'm also using terraform CLI commands",{"type":49,"tag":68,"props":7090,"children":7091},{},[7092],{"type":55,"value":7093},"For Pulumi I'm using the official Pulumi GitHub Action",{"type":49,"tag":58,"props":7095,"children":7096},{},[7097,7098,7105],{"type":55,"value":6030},{"type":49,"tag":80,"props":7099,"children":7102},{"href":7100,"rel":7101},"https://www.pulumi.com/docs/guides/continuous-delivery/github-actions/",[84],[7103],{"type":55,"value":7104},"a great article",{"type":55,"value":7106}," about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags.",{"type":49,"tag":58,"props":7108,"children":7109},{},[7110],{"type":55,"value":7111},"The general pattern that all of these pipelines use is:",{"type":49,"tag":64,"props":7113,"children":7114},{},[7115,7120,7125],{"type":49,"tag":68,"props":7116,"children":7117},{},[7118],{"type":55,"value":7119},"Do a synth/plan/preview, and upload the synth/plan/preview file to an artifact",{"type":49,"tag":68,"props":7121,"children":7122},{},[7123],{"type":55,"value":7124},"Pause and wait on manual review of the planned changes",{"type":49,"tag":68,"props":7126,"children":7127},{},[7128],{"type":55,"value":7129},"download the artifact and run deploy/apply/up against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected.",{"type":49,"tag":58,"props":7131,"children":7132},{},[7133],{"type":55,"value":7134},"I do this by having two jobs in each GitHub Action: one for synth/plan/preview and one for deploy/apply/up.",{"type":49,"tag":58,"props":7136,"children":7137},{},[7138,7140,7145],{"type":55,"value":7139},"The job for deploy/apply/up includes an ",{"type":49,"tag":326,"props":7141,"children":7143},{"className":7142},[],[7144],{"type":55,"value":5113},{"type":55,"value":7146}," that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job.",{"type":49,"tag":50,"props":7148,"children":7150},{"id":7149},"application-deployments",[7151],{"type":55,"value":7152},"Application deployments",{"type":49,"tag":64,"props":7154,"children":7155},{},[7156,7161,7173],{"type":49,"tag":68,"props":7157,"children":7158},{},[7159],{"type":55,"value":7160},"There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)",{"type":49,"tag":68,"props":7162,"children":7163},{},[7164,7166,7171],{"type":55,"value":7165},"The backend deployment script runs database migrations, the ",{"type":49,"tag":326,"props":7167,"children":7169},{"className":7168},[],[7170],{"type":55,"value":3316},{"type":55,"value":7172}," command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)",{"type":49,"tag":68,"props":7174,"children":7175},{},[7176],{"type":55,"value":7177},"What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting \"outputs\" of the app stacks.",{"type":49,"tag":50,"props":7179,"children":7181},{"id":7180},"interacting-with-aws-via-iac",[7182],{"type":55,"value":7183},"Interacting with AWS via IaC",{"type":49,"tag":64,"props":7185,"children":7186},{},[7187,7201,7226],{"type":49,"tag":68,"props":7188,"children":7189},{},[7190,7192,7199],{"type":55,"value":7191},"CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides ",{"type":49,"tag":80,"props":7193,"children":7196},{"href":7194,"rel":7195},"https://docs.aws.amazon.com/cdk/v2/guide/constructs.html",[84],[7197],{"type":55,"value":7198},"L1, L2 and L3 constructs",{"type":55,"value":7200}," which offer different levels of abstraction over CloudFormation.",{"type":49,"tag":68,"props":7202,"children":7203},{},[7204,7206,7213,7214,7225],{"type":55,"value":7205},"Terraform has the ",{"type":49,"tag":80,"props":7207,"children":7210},{"href":7208,"rel":7209},"https://registry.terraform.io/providers/hashicorp/aws/latest/docs",[84],[7211],{"type":55,"value":7212},"AWS Provider",{"type":55,"value":6280},{"type":49,"tag":80,"props":7215,"children":7218},{"href":7216,"rel":7217},"https://registry.terraform.io/namespaces/terraform-aws-modules",[84],[7219],{"type":49,"tag":326,"props":7220,"children":7222},{"className":7221},[],[7223],{"type":55,"value":7224},"terraform-aws-modules",{"type":55,"value":745},{"type":49,"tag":68,"props":7227,"children":7228},{},[7229,7231,7236,7237,7242,7243,7249,7250,7257,7258,7263,7264,7270,7271,7275],{"type":55,"value":7230},"Pulumi has AWS Classic (",{"type":49,"tag":326,"props":7232,"children":7234},{"className":7233},[],[7235],{"type":55,"value":496},{"type":55,"value":5173},{"type":49,"tag":72,"props":7238,"children":7239},{},[7240],{"type":55,"value":7241},"provider",{"type":55,"value":715},{"type":49,"tag":326,"props":7244,"children":7246},{"className":7245},[],[7247],{"type":55,"value":7248},"AWSx",{"type":55,"value":6234},{"type":49,"tag":80,"props":7251,"children":7254},{"href":7252,"rel":7253},"https://www.pulumi.com/registry/packages/awsx/",[84],[7255],{"type":55,"value":7256},"Crosswalk for Pulumi",{"type":55,"value":5173},{"type":49,"tag":72,"props":7259,"children":7260},{},[7261],{"type":55,"value":7262},"library",{"type":55,"value":715},{"type":49,"tag":326,"props":7265,"children":7267},{"className":7266},[],[7268],{"type":55,"value":7269},"aws_native",{"type":55,"value":1909},{"type":49,"tag":72,"props":7272,"children":7273},{},[7274],{"type":55,"value":7241},{"type":55,"value":745},{"type":49,"tag":2910,"props":7277,"children":7278},{},[7279],{"type":49,"tag":58,"props":7280,"children":7281},{},[7282,7287],{"type":49,"tag":326,"props":7283,"children":7285},{"className":7284},[],[7286],{"type":55,"value":7269},{"type":55,"value":7288}," \"manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch.\"",{"type":49,"tag":58,"props":7290,"children":7291},{},[7292,7297],{"type":49,"tag":326,"props":7293,"children":7295},{"className":7294},[],[7296],{"type":55,"value":7269},{"type":55,"value":7298}," looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider.",{"type":49,"tag":58,"props":7300,"children":7301},{},[7302],{"type":55,"value":7303},"For CDK I use mostly L2 constructs and some L1 constructs.",{"type":49,"tag":58,"props":7305,"children":7306},{},[7307,7309,7314],{"type":55,"value":7308},"Fot Terraform I use the VPC from the ",{"type":49,"tag":326,"props":7310,"children":7312},{"className":7311},[],[7313],{"type":55,"value":7224},{"type":55,"value":7315},", and everything else uses the AWS Terraform Provider.",{"type":49,"tag":50,"props":7317,"children":7319},{"id":7318},"what-i-did-not-put-in-iac",[7320],{"type":55,"value":7321},"What I did not put in IaC",{"type":49,"tag":64,"props":7323,"children":7324},{},[7325,7330,7335],{"type":49,"tag":68,"props":7326,"children":7327},{},[7328],{"type":55,"value":7329},"ECR (Elastic Container Registry)",{"type":49,"tag":68,"props":7331,"children":7332},{},[7333],{"type":55,"value":7334},"ACM (Amazon Certificate Manager)",{"type":49,"tag":68,"props":7336,"children":7337},{},[7338],{"type":55,"value":7339},"(Roles used for deployments)",{"type":49,"tag":58,"props":7341,"children":7342},{},[7343,7345,7350,7351,7356,7358,7364],{"type":55,"value":7344},"I created the Elastic Container Registry ",{"type":49,"tag":326,"props":7346,"children":7348},{"className":7347},[],[7349],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":7352,"children":7354},{"className":7353},[],[7355],{"type":55,"value":1958},{"type":55,"value":7357}," repos manually in the AWS Console. I also manually requested an ACM certificate for ",{"type":49,"tag":326,"props":7359,"children":7361},{"className":7360},[],[7362],{"type":55,"value":7363},"*.mydomain.com",{"type":55,"value":7365}," for the domain that I use for testing that I purchased through Route53 domains.",{"type":49,"tag":58,"props":7367,"children":7368},{},[7369],{"type":55,"value":7370},"I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog.",{"type":49,"tag":50,"props":7372,"children":7374},{"id":7373},"tagging",[7375],{"type":55,"value":7376},"Tagging",{"type":49,"tag":64,"props":7378,"children":7379},{},[7380,7385,7390,7399,7408,7413],{"type":49,"tag":68,"props":7381,"children":7382},{},[7383],{"type":55,"value":7384},"Terraform and CDK both make it easy to automatically tag all resources in a stack",{"type":49,"tag":68,"props":7386,"children":7387},{},[7388],{"type":55,"value":7389},"It is possible to do this in Pulumi, but you need to write a little bit of code.",{"type":49,"tag":68,"props":7391,"children":7392},{},[7393],{"type":49,"tag":80,"props":7394,"children":7397},{"href":7395,"rel":7396},"https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/",[84],[7398],{"type":55,"value":7395},{"type":49,"tag":68,"props":7400,"children":7401},{},[7402],{"type":49,"tag":80,"props":7403,"children":7406},{"href":7404,"rel":7405},"https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts",[84],[7407],{"type":55,"value":7404},{"type":49,"tag":68,"props":7409,"children":7410},{},[7411],{"type":55,"value":7412},"Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)",{"type":49,"tag":68,"props":7414,"children":7415},{},[7416,7418,7425],{"type":55,"value":7417},"Automatically tagging resources works through ",{"type":49,"tag":80,"props":7419,"children":7422},{"href":7420,"rel":7421},"https://www.pulumi.com/docs/intro/vs/terraform/",[84],[7423],{"type":55,"value":7424},"stack transformations",{"type":55,"value":7426}," are unique to Pulumi",{"type":49,"tag":50,"props":7428,"children":7430},{"id":7429},"smoke-checking-application-environments",[7431],{"type":55,"value":7432},"Smoke checking application environments",{"type":49,"tag":58,"props":7434,"children":7435},{},[7436],{"type":55,"value":7437},"Here's the list of things I check when standing up an application environment:",{"type":49,"tag":64,"props":7439,"children":7442},{"className":7440},[7441],"contains-task-list",[7443,7455,7471,7487,7503,7519,7535,7551,7560,7569,7578,7587,7596,7605],{"type":49,"tag":68,"props":7444,"children":7447},{"className":7445},[7446],"task-list-item",[7448,7453],{"type":49,"tag":7449,"props":7450,"children":7452},"input",{"checked":44,"disabled":44,"type":7451},"checkbox",[],{"type":55,"value":7454}," Run the init/tsc, synth/plan/preview and deploy/apply/up commands successfully",{"type":49,"tag":68,"props":7456,"children":7458},{"className":7457},[7446],[7459,7462,7464,7470],{"type":49,"tag":7449,"props":7460,"children":7461},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7463}," Access the bastion host (",{"type":49,"tag":326,"props":7465,"children":7467},{"className":7466},[],[7468],{"type":55,"value":7469},"make aws-ssm-start-session",{"type":55,"value":616},{"type":49,"tag":68,"props":7472,"children":7474},{"className":7473},[7446],[7475,7478,7480,7486],{"type":49,"tag":7449,"props":7476,"children":7477},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7479}," Run ECSExec to access a shell in a backend container (",{"type":49,"tag":326,"props":7481,"children":7483},{"className":7482},[],[7484],{"type":55,"value":7485},"make aws-ecs-exec",{"type":55,"value":616},{"type":49,"tag":68,"props":7488,"children":7490},{"className":7489},[7446],[7491,7494,7496,7502],{"type":49,"tag":7449,"props":7492,"children":7493},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7495}," Test database connectivity (",{"type":49,"tag":326,"props":7497,"children":7499},{"className":7498},[],[7500],{"type":55,"value":7501},"python manage.py showmigrations",{"type":55,"value":616},{"type":49,"tag":68,"props":7504,"children":7506},{"className":7505},[7446],[7507,7510,7512,7518],{"type":49,"tag":7449,"props":7508,"children":7509},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7511}," Run the migrations (",{"type":49,"tag":326,"props":7513,"children":7515},{"className":7514},[],[7516],{"type":55,"value":7517},"python manage.py migrate",{"type":55,"value":616},{"type":49,"tag":68,"props":7520,"children":7522},{"className":7521},[7446],[7523,7526,7528,7534],{"type":49,"tag":7449,"props":7524,"children":7525},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7527}," Run collectstatic (",{"type":49,"tag":326,"props":7529,"children":7531},{"className":7530},[],[7532],{"type":55,"value":7533},"python manage.py collectstatic",{"type":55,"value":616},{"type":49,"tag":68,"props":7536,"children":7538},{"className":7537},[7446],[7539,7542,7544,7550],{"type":49,"tag":7449,"props":7540,"children":7541},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7543}," Visit the site (",{"type":49,"tag":326,"props":7545,"children":7547},{"className":7546},[],[7548],{"type":55,"value":7549},"alpha.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":7552,"children":7554},{"className":7553},[7446],[7555,7558],{"type":49,"tag":7449,"props":7556,"children":7557},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7559}," Publish a blog post",{"type":49,"tag":68,"props":7561,"children":7563},{"className":7562},[7446],[7564,7567],{"type":49,"tag":7449,"props":7565,"children":7566},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7568}," Publish a blog post with an image",{"type":49,"tag":68,"props":7570,"children":7572},{"className":7571},[7446],[7573,7576],{"type":49,"tag":7449,"props":7574,"children":7575},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7577}," Check celery worker logs for successfully complete scheduled tasks",{"type":49,"tag":68,"props":7579,"children":7581},{"className":7580},[7446],[7582,7585],{"type":49,"tag":7449,"props":7583,"children":7584},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7586}," Trigger an autoscaling event by running k6 load tests against an environment",{"type":49,"tag":68,"props":7588,"children":7590},{"className":7589},[7446],[7591,7594],{"type":49,"tag":7449,"props":7592,"children":7593},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7595}," Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates",{"type":49,"tag":68,"props":7597,"children":7599},{"className":7598},[7446],[7600,7603],{"type":49,"tag":7449,"props":7601,"children":7602},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7604}," Destroy the app stack",{"type":49,"tag":68,"props":7606,"children":7608},{"className":7607},[7446],[7609,7612],{"type":49,"tag":7449,"props":7610,"children":7611},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7613}," Destroy the base stack",{"type":49,"tag":50,"props":7615,"children":7617},{"id":7616},"backlog-and-next-steps",[7618],{"type":55,"value":7619},"Backlog and next steps",{"type":49,"tag":58,"props":7621,"children":7622},{},[7623],{"type":55,"value":7624},"Here are some of the next things I'll be working on in these project, roughly in order of importance:",{"type":49,"tag":64,"props":7626,"children":7628},{"className":7627},[7441],[7629,7638,7643,7648,7660,7665,7678,7683,7688,7693,7698,7703,7708,7713,7718],{"type":49,"tag":68,"props":7630,"children":7632},{"className":7631},[7446],[7633,7636],{"type":49,"tag":7449,"props":7634,"children":7635},{"checked":44,"disabled":44,"type":7451},[],{"type":55,"value":7637}," Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or \"planning\" before proceeding with an live operations in infrastructure pipelines",{"type":49,"tag":68,"props":7639,"children":7640},{},[7641],{"type":55,"value":7642},"Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub",{"type":49,"tag":68,"props":7644,"children":7645},{},[7646],{"type":55,"value":7647},"Show how to do account isolation (different accounts for prod vs pre-prod environments)",{"type":49,"tag":68,"props":7649,"children":7650},{},[7651,7653,7658],{"type":55,"value":7652},"GitHub Actions deployment pipeline for publishing ",{"type":49,"tag":326,"props":7654,"children":7656},{"className":7655},[],[7657],{"type":55,"value":699},{"type":55,"value":7659}," package",{"type":49,"tag":68,"props":7661,"children":7662},{},[7663],{"type":55,"value":7664},"Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)",{"type":49,"tag":68,"props":7666,"children":7667},{},[7668,7670,7676],{"type":55,"value":7669},"For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the ",{"type":49,"tag":326,"props":7671,"children":7673},{"className":7672},[],[7674],{"type":55,"value":7675},"random",{"type":55,"value":7677}," functions to do this",{"type":49,"tag":68,"props":7679,"children":7680},{},[7681],{"type":55,"value":7682},"Refactor GitHub Actions and make them reusable across different projects",{"type":49,"tag":68,"props":7684,"children":7685},{},[7686],{"type":55,"value":7687},"Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules",{"type":49,"tag":68,"props":7689,"children":7690},{},[7691],{"type":55,"value":7692},"Use graviton instances and have the option to select between different architectures",{"type":49,"tag":68,"props":7694,"children":7695},{},[7696],{"type":55,"value":7697},"Standardize all resources names across CDK, Terraform and Pulumi",{"type":49,"tag":68,"props":7699,"children":7700},{},[7701],{"type":55,"value":7702},"The Pulumi components that define the resources associated with each ECS service are not very dry",{"type":49,"tag":68,"props":7704,"children":7705},{},[7706],{"type":55,"value":7707},"Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)",{"type":49,"tag":68,"props":7709,"children":7710},{},[7711],{"type":55,"value":7712},"Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is.",{"type":49,"tag":68,"props":7714,"children":7715},{},[7716],{"type":55,"value":7717},"Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional",{"type":49,"tag":68,"props":7719,"children":7720},{},[7721],{"type":55,"value":7722},"experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site",{"type":49,"tag":58,"props":7724,"children":7725},{},[7726],{"type":55,"value":7727},"If you want to get involved or help with any of the above, please let me know!",{"type":49,"tag":50,"props":7729,"children":7731},{"id":7730},"conclusion",[7732],{"type":55,"value":7733},"Conclusion",{"type":49,"tag":58,"props":7735,"children":7736},{},[7737,7739,7746],{"type":55,"value":7738},"I first started out with IaC following this project ",{"type":49,"tag":80,"props":7740,"children":7743},{"href":7741,"rel":7742},"https://github.com/aws-samples/ecs-refarch-cloudformation",[84],[7744],{"type":55,"value":7745},"aws-samples/ecs-refarch-cloudformation",{"type":55,"value":7747}," (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform.",{"type":49,"tag":7749,"props":7750,"children":7751},"style",{},[7752],{"type":55,"value":7753},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":8,"searchDepth":1079,"depth":1079,"links":7755},[7756,7757,7758,7759,7764,7772,7773,7776,7777,7787,7797,7798,7799,7800,7801,7802,7803,7804,7805,7806,7807,7808],{"id":52,"depth":1079,"text":56},{"id":151,"depth":1079,"text":151},{"id":185,"depth":1079,"text":188},{"id":425,"depth":1079,"text":428,"children":7760},[7761,7762,7763],{"id":432,"depth":1088,"text":435},{"id":477,"depth":1088,"text":480},{"id":501,"depth":1088,"text":501},{"id":643,"depth":1079,"text":646,"children":7765},[7766,7767,7768,7769,7770,7771],{"id":702,"depth":1088,"text":705},{"id":776,"depth":1088,"text":779},{"id":909,"depth":1088,"text":912},{"id":1288,"depth":1088,"text":1291},{"id":1334,"depth":1088,"text":1337},{"id":1470,"depth":1088,"text":1473},{"id":1545,"depth":1079,"text":1548},{"id":1589,"depth":1079,"text":1589,"children":7774},[7775],{"id":1613,"depth":1088,"text":1616},{"id":1820,"depth":1079,"text":1823},{"id":1981,"depth":1079,"text":1984,"children":7778},[7779,7780,7781,7782,7783,7784,7785,7786],{"id":2035,"depth":1088,"text":2038},{"id":2062,"depth":1088,"text":2065},{"id":2091,"depth":1088,"text":2094},{"id":2160,"depth":1088,"text":2017},{"id":2357,"depth":1088,"text":2360},{"id":2401,"depth":1088,"text":2404},{"id":2683,"depth":1088,"text":2032},{"id":2763,"depth":1088,"text":2766},{"id":2853,"depth":1079,"text":2856,"children":7788},[7789,7790,7791,7792,7793,7794,7795,7796],{"id":2877,"depth":1088,"text":2880},{"id":2928,"depth":1088,"text":2931},{"id":3119,"depth":1088,"text":3122},{"id":3151,"depth":1088,"text":3154},{"id":3167,"depth":1088,"text":3170},{"id":3261,"depth":1088,"text":3264},{"id":3299,"depth":1088,"text":3302},{"id":3966,"depth":1088,"text":2849},{"id":6014,"depth":1079,"text":6017},{"id":6091,"depth":1079,"text":6094},{"id":6192,"depth":1079,"text":6195},{"id":6972,"depth":1079,"text":6975},{"id":7023,"depth":1079,"text":7026},{"id":7149,"depth":1079,"text":7152},{"id":7180,"depth":1079,"text":7183},{"id":7318,"depth":1079,"text":7321},{"id":7373,"depth":1079,"text":7376},{"id":7429,"depth":1079,"text":7432},{"id":7616,"depth":1079,"text":7619},{"id":7730,"depth":1079,"text":7733},"markdown","content:2023:01:07:i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","content","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi.md","2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi","md",{"_path":7816,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":7818,"description":7819,"date":7820,"image":7821,"tags":7822,"external":7823,"comments":44,"body":7841,"_type":7809,"_id":13919,"_source":7811,"_file":13920,"_stem":13921,"_extension":7814},"/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions","27","Setting up ad hoc development environments for Django applications with AWS ECS, Terraform and GitHub Actions","This article will show how software development teams can build on-demand environments for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete instances of a web application.","2022-06-11","/static/adhoc.png",[14,16,19,20,21,23,24],[7824,7826,7828,7830,7832,7833,7836,7838],{"link":7825,"site":28},"https://news.ycombinator.com/item?id=31704417",{"link":7827,"site":31},"https://www.reddit.com/r/aws/comments/v9ycwh/my_approach_to_building_ad_hoc_developer/",{"link":7829,"site":34},"https://dev.to/briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions-4abh",{"link":7831,"site":37},"https://medium.com/@briancaffey/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-84d26e710539",{"link":39,"site":40},{"link":7834,"site":7835},"https://twitter.com/briancaffey/status/1535683865330831360","twitter",{"link":7837,"site":43},"https://briancaffey.substack.com/p/setting-up-ad-hoc-development-environments",{"link":7839,"site":7840},"https://hackernoon.com/ad-hoc-environments-for-django-applications-with-ecs-terraform-and-github-actions","hackernoon",{"type":46,"children":7842,"toc":13848},[7843,7847,7860,7866,7871,7985,7991,7996,8034,8039,8097,8103,8108,8114,8119,8152,8157,8163,8168,8211,8223,8228,8233,8340,8345,8351,8356,8374,8379,8408,8420,8425,8431,8436,8454,8459,8464,8469,8474,8487,8492,8497,8503,8508,8534,8578,8584,8589,8607,8612,8617,8622,8643,8676,8682,8687,8692,8728,8733,8787,8792,8842,8853,8881,8898,8904,8921,8928,8934,8947,8952,8957,8962,8967,8972,8977,8982,8987,8993,9066,9072,9077,9085,9089,9102,9108,9113,9126,9131,9139,9143,9148,9181,9187,9192,9198,9203,9208,9229,9234,9238,9243,9249,9254,9258,9263,9269,9274,9279,9306,9311,9328,9334,9339,9345,9385,9411,9416,9436,9462,9468,9480,9488,9500,9539,9545,9589,9602,9610,9649,9669,9675,9686,9707,9719,9725,9730,9816,9821,9828,9833,9838,12707,12727,12741,12797,12858,12864,12876,12933,12939,12944,12950,12955,12969,12982,12988,13015,13021,13026,13032,13037,13043,13048,13054,13059,13190,13195,13201,13237,13243,13286,13292,13304,13341,13353,13359,13379,13565,13570,13578,13584,13610,13616,13634,13639,13645,13651,13656,13662,13667,13672,13677,13682,13688,13711,13717,13722,13728,13733,13739,13744,13750,13755,13761,13780,13786,13791,13797,13802,13830,13835,13839,13844],{"type":49,"tag":50,"props":7844,"children":7845},{"id":52},[7846],{"type":55,"value":56},{"type":49,"tag":58,"props":7848,"children":7849},{},[7850,7852,7858],{"type":55,"value":7851},"This article will show how software development teams can build on-demand instances of a web application project for dog-food testing, quality review, internal and external demos and other use cases that require short-lived but feature-complete environments. It will focus on the technical implementation of building ad hoc environments using a specific set of tools (including AWS ECS, Terraform and GitHub Actions). I will also be giving context on high-level implementation decisions based on what I think are best practices guided by the ",{"type":49,"tag":80,"props":7853,"children":7855},{"href":402,"rel":7854},[84],[7856],{"type":55,"value":7857},"12-Factor Application methodology",{"type":55,"value":7859},". If any of this interests you, please have a read and let me know what you think in the comments on the outlets where I'll be sharing this article (links at the end).",{"type":49,"tag":50,"props":7861,"children":7863},{"id":7862},"github-links",[7864],{"type":55,"value":7865},"GitHub Links",{"type":49,"tag":58,"props":7867,"children":7868},{},[7869],{"type":55,"value":7870},"This article references three open-source code repositories on GitHub.",{"type":49,"tag":64,"props":7872,"children":7873},{},[7874,7905,7945],{"type":49,"tag":68,"props":7875,"children":7876},{},[7877,7882],{"type":49,"tag":80,"props":7878,"children":7880},{"href":144,"rel":7879},[84],[7881],{"type":55,"value":1627},{"type":49,"tag":64,"props":7883,"children":7884},{},[7885,7890,7895,7900],{"type":49,"tag":68,"props":7886,"children":7887},{},[7888],{"type":55,"value":7889},"this repo contains an example microblogging application called Î¼blog built with Django",{"type":49,"tag":68,"props":7891,"children":7892},{},[7893],{"type":55,"value":7894},"the same application is implemented as a traditional Model Template View (MTV) site, a decoupled REST API and Javascript web application and a GraphQL API",{"type":49,"tag":68,"props":7896,"children":7897},{},[7898],{"type":55,"value":7899},"it is a monorepo that also includes a frontend Vue.js application, CI/CD pipelines, a VuePress documentation site as well as tooling and instructions for settings up a local development environments (both with and without docker)",{"type":49,"tag":68,"props":7901,"children":7902},{},[7903],{"type":55,"value":7904},"it includes a complete set of GitHub Action examples for automating the processes of creating, updating and destroying ad hoc environments that will be an important part of what is covered in this article",{"type":49,"tag":68,"props":7906,"children":7907},{},[7908,7913],{"type":49,"tag":80,"props":7909,"children":7911},{"href":99,"rel":7910},[84],[7912],{"type":55,"value":684},{"type":49,"tag":64,"props":7914,"children":7915},{},[7916,7921,7926],{"type":49,"tag":68,"props":7917,"children":7918},{},[7919],{"type":55,"value":7920},"a collection of modules for running Django applications on AWS using Terraform",{"type":49,"tag":68,"props":7922,"children":7923},{},[7924],{"type":55,"value":7925},"one of the submodules can be used for creating ad hoc environments which will be what we use to create ad hoc environments",{"type":49,"tag":68,"props":7927,"children":7928},{},[7929,7931,7937,7938,7943],{"type":55,"value":7930},"this module has been published to Terraform Registry and is used in the ",{"type":49,"tag":326,"props":7932,"children":7934},{"className":7933},[],[7935],{"type":55,"value":7936},"terraform/live/ad-hoc",{"type":55,"value":7046},{"type":49,"tag":326,"props":7939,"children":7941},{"className":7940},[],[7942],{"type":55,"value":1627},{"type":55,"value":7944}," repo",{"type":49,"tag":68,"props":7946,"children":7947},{},[7948,7955],{"type":49,"tag":80,"props":7949,"children":7952},{"href":7950,"rel":7951},"https://github.com/briancaffey/terraform-aws-ad-hoc-environments",[84],[7953],{"type":55,"value":7954},"terraform-aws-ad-hoc-environments",{"type":49,"tag":64,"props":7956,"children":7957},{},[7958,7963,7973],{"type":49,"tag":68,"props":7959,"children":7960},{},[7961],{"type":55,"value":7962},"a Terraform module that provides shared infrastructure used by ad hoc environments (including VPC, RDS instance, bastion host, security groups and IAM roles, etc.)",{"type":49,"tag":68,"props":7964,"children":7965},{},[7966,7968],{"type":55,"value":7967},"this module has also been published to Terraform Registry and is also used in ",{"type":49,"tag":326,"props":7969,"children":7971},{"className":7970},[],[7972],{"type":55,"value":1627},{"type":49,"tag":68,"props":7974,"children":7975},{},[7976,7978,7983],{"type":55,"value":7977},"this module is designed to be used with the ",{"type":49,"tag":326,"props":7979,"children":7981},{"className":7980},[],[7982],{"type":55,"value":684},{"type":55,"value":7984}," Terraform module",{"type":49,"tag":50,"props":7986,"children":7988},{"id":7987},"assumptions",[7989],{"type":55,"value":7990},"Assumptions",{"type":49,"tag":58,"props":7992,"children":7993},{},[7994],{"type":55,"value":7995},"There are all sorts of applications, and all sort of engineering teams. For some context on what I'm describing in this article, here are some basic assumptions that I'm making about the type of engineering team and software application product that would be a good fit for this type of development workflow.",{"type":49,"tag":64,"props":7997,"children":7998},{},[7999,8004,8009,8014,8019,8024,8029],{"type":49,"tag":68,"props":8000,"children":8001},{},[8002],{"type":55,"value":8003},"engineering team is composed of a backend team, a frontend team, a devops team and works closely with a product team",{"type":49,"tag":68,"props":8005,"children":8006},{},[8007],{"type":55,"value":8008},"backend team primarily develops a REST API",{"type":49,"tag":68,"props":8010,"children":8011},{},[8012],{"type":55,"value":8013},"frontend team develops a JavaScript SPA (frontend website)",{"type":49,"tag":68,"props":8015,"children":8016},{},[8017],{"type":55,"value":8018},"SPA consumes backend REST API",{"type":49,"tag":68,"props":8020,"children":8021},{},[8022],{"type":55,"value":8023},"product team frequently needs to demo applications to prospective clients",{"type":49,"tag":68,"props":8025,"children":8026},{},[8027],{"type":55,"value":8028},"development teams don't have deep expertise in infrastructure, containers, CI/CD or automation",{"type":49,"tag":68,"props":8030,"children":8031},{},[8032],{"type":55,"value":8033},"devops team has been tasked with building automation that will allow anyone on the team to quickly spin up a complete environment for testing and demoing purposes within minutes",{"type":49,"tag":58,"props":8035,"children":8036},{},[8037],{"type":55,"value":8038},"Here are assumptions about specific tools and technologies used at the company:",{"type":49,"tag":64,"props":8040,"children":8041},{},[8042,8047,8052,8057,8062,8067,8072,8077,8082,8087,8092],{"type":49,"tag":68,"props":8043,"children":8044},{},[8045],{"type":55,"value":8046},"backend is a REST API developed with Django and a Postgres database",{"type":49,"tag":68,"props":8048,"children":8049},{},[8050],{"type":55,"value":8051},"backend is packaged into a docker container",{"type":49,"tag":68,"props":8053,"children":8054},{},[8055],{"type":55,"value":8056},"frontend is also packaged into a docker container using multi-stage builds and NGINX",{"type":49,"tag":68,"props":8058,"children":8059},{},[8060],{"type":55,"value":8061},"frontend does not require any build-time configuration (all configuration needed by frontend is fetched from backend)",{"type":49,"tag":68,"props":8063,"children":8064},{},[8065],{"type":55,"value":8066},"backend application's configuration is driven by plain-text environment variables at run-time",{"type":49,"tag":68,"props":8068,"children":8069},{},[8070],{"type":55,"value":8071},"engineering team uses AWS",{"type":49,"tag":68,"props":8073,"children":8074},{},[8075],{"type":55,"value":8076},"automation pipeline exists for building, tagging and pushing backend and frontend container images to an ECR repository",{"type":49,"tag":68,"props":8078,"children":8079},{},[8080],{"type":55,"value":8081},"devops team uses AWS ECS for running containerized workloads",{"type":49,"tag":68,"props":8083,"children":8084},{},[8085],{"type":55,"value":8086},"devops team uses Terraform for provisioning infrastructure",{"type":49,"tag":68,"props":8088,"children":8089},{},[8090],{"type":55,"value":8091},"devops team uses GitHub Actions for building automation pipelines",{"type":49,"tag":68,"props":8093,"children":8094},{},[8095],{"type":55,"value":8096},"team is somewhat cost-conscious",{"type":49,"tag":50,"props":8098,"children":8100},{"id":8099},"what-are-ad-hoc-environments",[8101],{"type":55,"value":8102},"What are ad hoc environments?",{"type":49,"tag":58,"props":8104,"children":8105},{},[8106],{"type":55,"value":8107},"Ad hoc environments are short-lived environments that are designed to be used for testing a specific set of features or for demoing a specific application configuration in an isolated environment. It is intended to be a functional duplicate of the main production environment. An ad hoc environment is the first cloud environment that the application code will be deployed to after a developer has been working on it in a local development environment.",{"type":49,"tag":50,"props":8109,"children":8111},{"id":8110},"trade-offs-to-make-when-designing-ad-hoc-environment-infrastructure-and-automation",[8112],{"type":55,"value":8113},"Trade-offs to make when designing ad hoc environment infrastructure and automation",{"type":49,"tag":58,"props":8115,"children":8116},{},[8117],{"type":55,"value":8118},"Now that we have a sense of what we are building and the team we are working with, let's think about the high-level trade-offs that we will face as we build a solution for providing on-demand ad hoc environments. When building infrastructure and workflows for ad hoc environments, there are a few things to solve for:",{"type":49,"tag":64,"props":8120,"children":8121},{},[8122,8127,8132,8137,8142,8147],{"type":49,"tag":68,"props":8123,"children":8124},{},[8125],{"type":55,"value":8126},"simplicity of the end-user interface and process for requesting an ad hoc environment",{"type":49,"tag":68,"props":8128,"children":8129},{},[8130],{"type":55,"value":8131},"startup speed",{"type":49,"tag":68,"props":8133,"children":8134},{},[8135],{"type":55,"value":8136},"total cost of ownership",{"type":49,"tag":68,"props":8138,"children":8139},{},[8140],{"type":55,"value":8141},"degree of similarity to production environments",{"type":49,"tag":68,"props":8143,"children":8144},{},[8145],{"type":55,"value":8146},"shared vs isolated resources",{"type":49,"tag":68,"props":8148,"children":8149},{},[8150],{"type":55,"value":8151},"automation complexity",{"type":49,"tag":58,"props":8153,"children":8154},{},[8155],{"type":55,"value":8156},"Let's look at these items by considering how we can set up the main infrastructure components that will be used to run our ad hoc application environments.",{"type":49,"tag":430,"props":8158,"children":8160},{"id":8159},"relational-databases",[8161],{"type":55,"value":8162},"Relational Databases",{"type":49,"tag":58,"props":8164,"children":8165},{},[8166],{"type":55,"value":8167},"Startup speed can be measured by the time between when an environment is requested and when that environment can be used by whoever requested it. In this period of time, an automation pipeline may do some of the following:",{"type":49,"tag":64,"props":8169,"children":8170},{},[8171,8196,8201,8206],{"type":49,"tag":68,"props":8172,"children":8173},{},[8174,8176,8182,8183,8188,8189,8194],{"type":55,"value":8175},"run ",{"type":49,"tag":326,"props":8177,"children":8179},{"className":8178},[],[8180],{"type":55,"value":8181},"terraform init",{"type":55,"value":873},{"type":49,"tag":326,"props":8184,"children":8186},{"className":8185},[],[8187],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":8190,"children":8192},{"className":8191},[],[8193],{"type":55,"value":559},{"type":55,"value":8195}," to build infrastructure",{"type":49,"tag":68,"props":8197,"children":8198},{},[8199],{"type":55,"value":8200},"run scripts to prepare the application such as database migrations",{"type":49,"tag":68,"props":8202,"children":8203},{},[8204],{"type":55,"value":8205},"seeding initial sample data with a script or database dump",{"type":49,"tag":68,"props":8207,"children":8208},{},[8209],{"type":55,"value":8210},"message the user with information about the environment (URLs, commands for accessing an interactive shell, etc.)",{"type":49,"tag":58,"props":8212,"children":8213},{},[8214,8216,8221],{"type":55,"value":8215},"RDS instances can take a long time to create relative to other AWS resources such as S3 buckets and IAM roles. RDS instances are also more costly than other resources. We could use a single, shared RDS instance placed in a private subnet of a shared VPC. Each ad hoc environment could use a different named database in the RDS instance in the form ",{"type":49,"tag":326,"props":8217,"children":8219},{"className":8218},[],[8220],{"type":55,"value":2704},{"type":55,"value":8222},". Using one RDS instance per ad hoc environment would be slow to startup and tear down and also costly if there are many developers using ad hoc environments simultaneously.",{"type":49,"tag":58,"props":8224,"children":8225},{},[8226],{"type":55,"value":8227},"If we choose to isolate the application's relational database at the database level (and not the RDS instance level), then we will need our automation workflow to create a database per ad hoc environment.",{"type":49,"tag":58,"props":8229,"children":8230},{},[8231],{"type":55,"value":8232},"Let's spin up a simple example to illustrate how this would would work.",{"type":49,"tag":64,"props":8234,"children":8235},{},[8236,8249,8260,8271,8292,8297,8309,8321],{"type":49,"tag":68,"props":8237,"children":8238},{},[8239,8241,8247],{"type":55,"value":8240},"A developer is working on ",{"type":49,"tag":326,"props":8242,"children":8244},{"className":8243},[],[8245],{"type":55,"value":8246},"feature-abc",{"type":55,"value":8248}," that involves a significant refactor of the data model.",{"type":49,"tag":68,"props":8250,"children":8251},{},[8252,8254,8259],{"type":55,"value":8253},"The developer decides to spin up an ad hoc environment called ",{"type":49,"tag":326,"props":8255,"children":8257},{"className":8256},[],[8258],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8261,"children":8262},{},[8263,8265,8270],{"type":55,"value":8264},"Our automation will need to create a database in the RDS instance called ",{"type":49,"tag":326,"props":8266,"children":8268},{"className":8267},[],[8269],{"type":55,"value":8246},{"type":55,"value":745},{"type":49,"tag":68,"props":8272,"children":8273},{},[8274,8276,8282,8284,8290],{"type":55,"value":8275},"We can configure a bastion host with ",{"type":49,"tag":326,"props":8277,"children":8279},{"className":8278},[],[8280],{"type":55,"value":8281},"psql",{"type":55,"value":8283}," installed that has network and security group access to our RDS instance, and we can give our GitHub Actions an SSH key that can be used to run ",{"type":49,"tag":326,"props":8285,"children":8287},{"className":8286},[],[8288],{"type":55,"value":8289},"createdb",{"type":55,"value":8291}," over SSH.",{"type":49,"tag":68,"props":8293,"children":8294},{},[8295],{"type":55,"value":8296},"The automation also runs database migrations once the application has started, and we can view the logs of the database migration to check for any irregularities or other issues.",{"type":49,"tag":68,"props":8298,"children":8299},{},[8300,8302,8307],{"type":55,"value":8301},"This will give the developer and the rest of team confidence that the promoting ",{"type":49,"tag":326,"props":8303,"children":8305},{"className":8304},[],[8306],{"type":55,"value":8246},{"type":55,"value":8308}," to the next pre-production environments will not have any errors.",{"type":49,"tag":68,"props":8310,"children":8311},{},[8312,8314,8319],{"type":55,"value":8313},"The developer may even choose to load a SQL dump of the next pre-production environment into their ",{"type":49,"tag":326,"props":8315,"children":8317},{"className":8316},[],[8318],{"type":55,"value":8246},{"type":55,"value":8320}," database get even more confidence that there will be no data integrity errors.",{"type":49,"tag":68,"props":8322,"children":8323},{},[8324,8326,8331,8333,8338],{"type":55,"value":8325},"When the developer's PR is merged and approved, the ad hoc environment ",{"type":49,"tag":326,"props":8327,"children":8329},{"className":8328},[],[8330],{"type":55,"value":8246},{"type":55,"value":8332}," can be destroyed, including the ",{"type":49,"tag":326,"props":8334,"children":8336},{"className":8335},[],[8337],{"type":55,"value":8246},{"type":55,"value":8339}," database in the shared RDS instance.",{"type":49,"tag":58,"props":8341,"children":8342},{},[8343],{"type":55,"value":8344},"With this approach we won't incur the costs of multiple RDS instances. Ad hoc environments will start up faster because an RDS instance per environment is not required. We do have slightly less resource isolation, and we need to introduce a bastion host, but I consider this an acceptable trade-off.",{"type":49,"tag":430,"props":8346,"children":8348},{"id":8347},"redis-key-value-database",[8349],{"type":55,"value":8350},"Redis (key-value database)",{"type":49,"tag":58,"props":8352,"children":8353},{},[8354],{"type":55,"value":8355},"Redis is another database used in the application and it plays a few different roles:",{"type":49,"tag":64,"props":8357,"children":8358},{},[8359,8364,8369],{"type":49,"tag":68,"props":8360,"children":8361},{},[8362],{"type":55,"value":8363},"primarily, it is a caching layer that can cache request responses to reduce load on the database and speed up our application",{"type":49,"tag":68,"props":8365,"children":8366},{},[8367],{"type":55,"value":8368},"it is a message broker for our async task workers (celery)",{"type":49,"tag":68,"props":8370,"children":8371},{},[8372],{"type":55,"value":8373},"it can be used as a backend for other 3rd party Django apps that our main application may need to use (such as django-constance, cache-ops, django-channels, etc.)",{"type":49,"tag":58,"props":8375,"children":8376},{},[8377],{"type":55,"value":8378},"AWS offers a managed Redis service called ElastiCache. Redis running on an ElastiCache instance can do database isolation similar to how Postgres running on RDS can do database isolation as we discussed previously, but there are some key differences:",{"type":49,"tag":64,"props":8380,"children":8381},{},[8382,8387],{"type":49,"tag":68,"props":8383,"children":8384},{},[8385],{"type":55,"value":8386},"redis databases are numbered, not named",{"type":49,"tag":68,"props":8388,"children":8389},{},[8390,8392,8398,8400,8406],{"type":55,"value":8391},"the backend application uses isolated numbered databases for the different 3rd party apps that I just mentioned (for example: celery can use database ",{"type":49,"tag":326,"props":8393,"children":8395},{"className":8394},[],[8396],{"type":55,"value":8397},"0",{"type":55,"value":8399},",  API caching layer can use database ",{"type":49,"tag":326,"props":8401,"children":8403},{"className":8402},[],[8404],{"type":55,"value":8405},"1",{"type":55,"value":8407},", etc.)",{"type":49,"tag":58,"props":8409,"children":8410},{},[8411,8413,8418],{"type":55,"value":8412},"This makes it difficult to use a single ElastiCache instance for our ad hoc environments since we would need to figure out which numbered database to assign to a specific role for each ad hoc environment (e.g. how do we know which numbered database to use for the API caching for the ",{"type":49,"tag":326,"props":8414,"children":8416},{"className":8415},[],[8417],{"type":55,"value":8246},{"type":55,"value":8419}," ad hoc environment).",{"type":49,"tag":58,"props":8421,"children":8422},{},[8423],{"type":55,"value":8424},"So how can we approach providing isolated redis instances for multiple ad hoc environments? Spoiler: my solution is to run redis as a stateful service in ECS. Before we dig into how to do this, we need to talk about another important part of our application: compute.",{"type":49,"tag":430,"props":8426,"children":8428},{"id":8427},"compute",[8429],{"type":55,"value":8430},"Compute",{"type":49,"tag":58,"props":8432,"children":8433},{},[8434],{"type":55,"value":8435},"Our backend application is composed of a few different services that all share the same code base. In other words, our backend's services uses the same docker image but run different processes for each component:",{"type":49,"tag":64,"props":8437,"children":8438},{},[8439,8444,8449],{"type":49,"tag":68,"props":8440,"children":8441},{},[8442],{"type":55,"value":8443},"gunicorn for the core API",{"type":49,"tag":68,"props":8445,"children":8446},{},[8447],{"type":55,"value":8448},"celery for the task workers",{"type":49,"tag":68,"props":8450,"children":8451},{},[8452],{"type":55,"value":8453},"celerybeat for task scheduling",{"type":49,"tag":58,"props":8455,"children":8456},{},[8457],{"type":55,"value":8458},"If our application used websockets, we could have another service that runs an asgi server process (like daphne or uvicorn).",{"type":49,"tag":58,"props":8460,"children":8461},{},[8462],{"type":55,"value":8463},"Since our backend application is packaged into a container and we are using AWS as our cloud provider, ECS is a great choice for running our backend services. ECS is a container orchestration tool that I usually describe as a nice middle ground between docker swarm and Kubernetes. Simply put, it is a flexible option for running our containerized services that make up our backend application.",{"type":49,"tag":58,"props":8465,"children":8466},{},[8467],{"type":55,"value":8468},"With ECS you can choose to run containers directly on EC2 instances that you manage, or you can run containers using Fargate. Fargate is a serverless compute option that takes care of managing both the underlying \"computer\" and operating system that run our application's containers. All of our backend dependencies are defined in our Dockerfile, so we do not to maintain or update the underlying operating system that runs our containers -- AWS handles all of this for us. To use Fargate, we simply tell AWS which containers to run and how much CPU and memory to use in the ECS Task that runs the containers. To scale our app horizontally, the ECS service that managed ECS tasks simply increases the number of tasks that run.",{"type":49,"tag":58,"props":8470,"children":8471},{},[8472],{"type":55,"value":8473},"Since we are going to use the Fargate launch type for our ECS Tasks, let's talk about the ergonomics of these serverless compute instances compared to running our services directly on an EC2 instances.",{"type":49,"tag":64,"props":8475,"children":8476},{},[8477,8482],{"type":49,"tag":68,"props":8478,"children":8479},{},[8480],{"type":55,"value":8481},"We can't SSH into Fargate compute instances. We can instead use AWS Systems Manager and EcsExec to open an interactive shell in a running backend container. This can be useful for developers who might need to run a management command or access an interactive Django shell to verify behavior in their ad hoc environment.",{"type":49,"tag":68,"props":8483,"children":8484},{},[8485],{"type":55,"value":8486},"We can't simply change code on the server and restart services. This can sometimes be a useful pattern for debugging something that can only be tested on a cloud environment (e.g. something that can't easily be reproduced on your local machine), so this requires that developers push new images to their backend services for every change they want to see reflected on their ad hoc environment. Later on I'll discuss how we can provide tooling for developers to quickly update the image used in their backend services.",{"type":49,"tag":58,"props":8488,"children":8489},{},[8490],{"type":55,"value":8491},"With AWS Fargate, you will pay more than you would for a comparable amount of CPU and memory on EC2 instances. Similar to EC2 spot instances, Fargate offers interruptable instances called Fargate Spot which costs significantly less than regular Fargate instances. Fargate spot is appropriate for our ad hoc environments since ad hoc environments are non-critical workloads. In the event that a Fargate spot instance is interrupted, the ECS service will automatically launch another Fargate task to replace the task that was stopped.",{"type":49,"tag":58,"props":8493,"children":8494},{},[8495],{"type":55,"value":8496},"In my opinion, ECS with Fargate is ideal for running the stateless services that make up our backend application. In terms of parity with our production environment, we can keep almost everything the same, except use regular Fargate instances instead of Fargate spot instances.",{"type":49,"tag":430,"props":8498,"children":8500},{"id":8499},"redis-revisited",[8501],{"type":55,"value":8502},"Redis, revisited",{"type":49,"tag":58,"props":8504,"children":8505},{},[8506],{"type":55,"value":8507},"We can run redis as an ECS service instead of using ElastiCache. In order to do this, we will need our backend services (gunicorn, celery and celerybeat) to be able to communicate with a fourth ECS service that will be running redis (using an official redis image from Docker Hub, or a redis image that we define in ECR).",{"type":49,"tag":58,"props":8509,"children":8510},{},[8511,8513,8518,8520,8525,8527,8532],{"type":55,"value":8512},"By default, ",{"type":49,"tag":72,"props":8514,"children":8515},{},[8516],{"type":55,"value":8517},"there is no way for our backend services to know how to communicate with any other service in our ECS cluster",{"type":55,"value":8519},". If you have used docker-compose, you may know that you can use the service name ",{"type":49,"tag":326,"props":8521,"children":8523},{"className":8522},[],[8524],{"type":55,"value":3151},{"type":55,"value":8526}," in a backend service to easily communicate with a redis service called ",{"type":49,"tag":326,"props":8528,"children":8530},{"className":8529},[],[8531],{"type":55,"value":3151},{"type":55,"value":8533},". This networking convenience is not available to use out of the box with ECS. To achieve this in AWS, we need some way to manage a unique ad hoc environment-specific Route 53 DNS record that points to the private IP of the Fargate task that is running redis in an ECS cluster for a given ad hoc environment. Such a service exists in AWS and it is called Cloud Map. Cloud Map offers service discovery so that our backend services can make network calls to a static DNS address that will reliably point to the correct private IP of the ECS task running the redis container.",{"type":49,"tag":58,"props":8535,"children":8536},{},[8537,8539,8544,8546,8552,8554,8560,8562,8568,8570,8576],{"type":55,"value":8538},"We can define a service discovery namespace (which will essentially be a top level domain, or TLD) that all of our ad hoc environments can share. Let's assume this namespace is called ",{"type":49,"tag":326,"props":8540,"children":8542},{"className":8541},[],[8543],{"type":55,"value":1353},{"type":55,"value":8545},". Each ad hoc environment can then define a service discovery service in the shared namespace for redis that is called ",{"type":49,"tag":326,"props":8547,"children":8549},{"className":8548},[],[8550],{"type":55,"value":8551},"{ad-hoc-env-name}-redis",{"type":55,"value":8553},". This way, we can have a reliable address that we can configure as an environment for our backend that will look like this: ",{"type":49,"tag":326,"props":8555,"children":8557},{"className":8556},[],[8558],{"type":55,"value":8559},"redis://{ad-hoc-env-name}-redis.ad-hoc:6379/0",{"type":55,"value":8561},". ",{"type":49,"tag":326,"props":8563,"children":8565},{"className":8564},[],[8566],{"type":55,"value":8567},"{ad-hoc-env-name-redis}.ad-hoc",{"type":55,"value":8569}," will be the hostname of the redis service, and Route 53 will create records that point to ",{"type":49,"tag":326,"props":8571,"children":8573},{"className":8572},[],[8574],{"type":55,"value":8575},"{ad-hoc-env-name}-redis.ad-hoc",{"type":55,"value":8577}," to the private IP of the redis Fargate task for each ad hoc environment.",{"type":49,"tag":430,"props":8579,"children":8581},{"id":8580},"load-balancing",[8582],{"type":55,"value":8583},"Load Balancing",{"type":49,"tag":58,"props":8585,"children":8586},{},[8587],{"type":55,"value":8588},"We now have our backend services (gunicorn, celery and celerybeat) running on Fargate spot instances, and these services can communicate with the redis service in our ad hoc environment's ECS cluster using service discovery that we configured with Cloud Map. We still need to think about a few things:",{"type":49,"tag":64,"props":8590,"children":8591},{},[8592,8597,8602],{"type":49,"tag":68,"props":8593,"children":8594},{},[8595],{"type":55,"value":8596},"how will we expose our API service to the public (or private) internet",{"type":49,"tag":68,"props":8598,"children":8599},{},[8600],{"type":55,"value":8601},"how will we expose our frontend application to the public (or private) internet",{"type":49,"tag":68,"props":8603,"children":8604},{},[8605],{"type":55,"value":8606},"how will we make sure that requests go the correct ECS services",{"type":49,"tag":58,"props":8608,"children":8609},{},[8610],{"type":55,"value":8611},"Application load balancers (ALBs) are a great way to expose web app traffic to the internet. We could either have one application load balancer per ad hoc environment, or one application load balancer shared between all ad hoc environments. ALBs are somewhat slow to create and they also incur a significant monthly cost. They are also highly scalable, so using a shared ALB for all ad hoc environments would work.",{"type":49,"tag":58,"props":8613,"children":8614},{},[8615],{"type":55,"value":8616},"Individual ad hoc environments can then create target groups and listener rules for a shared ALB for each service that needs to serve requests from the internet (the backend and the frontend). In our case this is the backend API server and the frontend server that serves our static frontend site using NGINX.",{"type":49,"tag":58,"props":8618,"children":8619},{},[8620],{"type":55,"value":8621},"ECS services that need to be exposed to the internet can specify the target group, port and container to use for load balancing. A target group is created that defines the health check and other settings, and a load balancer listener rule is created on the shared load balancer that will forward traffic matching certain conditions to the target group for our service.",{"type":49,"tag":58,"props":8623,"children":8624},{},[8625,8627,8633,8635,8641],{"type":55,"value":8626},"For a given ad hoc environment, we need to specify that only traffic with certain paths should be sent to the backend service, and all other traffic should be sent to the frontend service. For example, we may only want to send traffic that starts with the path ",{"type":49,"tag":326,"props":8628,"children":8630},{"className":8629},[],[8631],{"type":55,"value":8632},"/api",{"type":55,"value":8634}," or ",{"type":49,"tag":326,"props":8636,"children":8638},{"className":8637},[],[8639],{"type":55,"value":8640},"/admin",{"type":55,"value":8642}," to the backend target group, and all other traffic should be sent to the frontend target group. We can do this by setting conditions on the listener rules that forward traffic do the frontend and backend target groups based on the hostname and path.",{"type":49,"tag":58,"props":8644,"children":8645},{},[8646,8648,8653,8654,8659,8661,8666,8668,8674],{"type":55,"value":8647},"We want our listener rule logic to forward ",{"type":49,"tag":326,"props":8649,"children":8651},{"className":8650},[],[8652],{"type":55,"value":8632},{"type":55,"value":873},{"type":49,"tag":326,"props":8655,"children":8657},{"className":8656},[],[8658],{"type":55,"value":8640},{"type":55,"value":8660}," and any other backend traffic to the backend target group, and forward all other traffic (",{"type":49,"tag":326,"props":8662,"children":8664},{"className":8663},[],[8665],{"type":55,"value":3211},{"type":55,"value":8667},") to the frontend target group. In order to do this, we need the backend listener rule to have a higher priority than the frontend listener rule for each ad hoc environment. Since we are using the same load balancer for all ad hoc environments, the priority values for each listener rule need to be unique. If we don't set the priority explicitly, then the priority will be set automatically to the next available value in ascending order. In order to make sure that the backend listener rule has a higher priority than the frontend listener rule for each ad hoc environment, we need to tell Terraform that the frontend module ",{"type":49,"tag":326,"props":8669,"children":8671},{"className":8670},[],[8672],{"type":55,"value":8673},"depends_on",{"type":55,"value":8675}," the backend module. This way the backend listener rule will have a higher priority (e.g. priority of 1) because it will be created first, and the frontend listener rule will have a lower priority (e.g. priority of 2).",{"type":49,"tag":50,"props":8677,"children":8679},{"id":8678},"more-on-shared-resources-vs-per-environment-resources",[8680],{"type":55,"value":8681},"More on shared resources vs per-environment resources",{"type":49,"tag":58,"props":8683,"children":8684},{},[8685],{"type":55,"value":8686},"Up until now we have discussed infrastructure design decisions at a high level, but we have not yet talked about how to organize our infrastructure as code. At a basic level, components of our ad hoc environment either fall into shared infrastructure or infrastructure that is specific to an individual ad hoc environment. Here's a list of the resources that are shared and the resources that are specific to each ad hoc environment.",{"type":49,"tag":58,"props":8688,"children":8689},{},[8690],{"type":55,"value":8691},"Shared resources include:",{"type":49,"tag":64,"props":8693,"children":8694},{},[8695,8699,8704,8709,8714,8719,8723],{"type":49,"tag":68,"props":8696,"children":8697},{},[8698],{"type":55,"value":2094},{"type":49,"tag":68,"props":8700,"children":8701},{},[8702],{"type":55,"value":8703},"IAM policies",{"type":49,"tag":68,"props":8705,"children":8706},{},[8707],{"type":55,"value":8708},"Security groups",{"type":49,"tag":68,"props":8710,"children":8711},{},[8712],{"type":55,"value":8713},"RDS instance",{"type":49,"tag":68,"props":8715,"children":8716},{},[8717],{"type":55,"value":8718},"Service Discovery namespace",{"type":49,"tag":68,"props":8720,"children":8721},{},[8722],{"type":55,"value":2373},{"type":49,"tag":68,"props":8724,"children":8725},{},[8726],{"type":55,"value":8727},"Bastion host",{"type":49,"tag":58,"props":8729,"children":8730},{},[8731],{"type":55,"value":8732},"Ad hoc environment resources include:",{"type":49,"tag":64,"props":8734,"children":8735},{},[8736,8740,8745,8750,8755,8760,8765,8777,8782],{"type":49,"tag":68,"props":8737,"children":8738},{},[8739],{"type":55,"value":2880},{"type":49,"tag":68,"props":8741,"children":8742},{},[8743],{"type":55,"value":8744},"ECS Tasks and Services (for backend and frontend applications)",{"type":49,"tag":68,"props":8746,"children":8747},{},[8748],{"type":55,"value":8749},"ECS Tasks for running management commands (such as migrate)",{"type":49,"tag":68,"props":8751,"children":8752},{},[8753],{"type":55,"value":8754},"CloudWatch logging groups for containers defined in ECS Tasks",{"type":49,"tag":68,"props":8756,"children":8757},{},[8758],{"type":55,"value":8759},"ALB Target groups",{"type":49,"tag":68,"props":8761,"children":8762},{},[8763],{"type":55,"value":8764},"ALB listener rules",{"type":49,"tag":68,"props":8766,"children":8767},{},[8768,8770,8776],{"type":55,"value":8769},"Route 53 record that points to the load balancer (e.g. ",{"type":49,"tag":326,"props":8771,"children":8773},{"className":8772},[],[8774],{"type":55,"value":8775},"ad-hoc-env-name.example.com",{"type":55,"value":616},{"type":49,"tag":68,"props":8778,"children":8779},{},[8780],{"type":55,"value":8781},"S3 bucket for static and media assets",{"type":49,"tag":68,"props":8783,"children":8784},{},[8785],{"type":55,"value":8786},"Service Discovery Service for redis service in ECS cluster",{"type":49,"tag":58,"props":8788,"children":8789},{},[8790],{"type":55,"value":8791},"Shared resources can be defined in one terraform configuration and deployed once. These resources will be long-lived as long as the application is under active development and the team requires on-demand provisioning of ad hoc environments.",{"type":49,"tag":58,"props":8793,"children":8794},{},[8795,8797,8802,8804,8810,8812,8818,8819,8825,8826,8832,8834,8840],{"type":55,"value":8796},"Ad hoc environment resources can be defined in another terraform configuration that references outputs from the shared resource configuration using ",{"type":49,"tag":326,"props":8798,"children":8800},{"className":8799},[],[8801],{"type":55,"value":1842},{"type":55,"value":8803},". Each ad hoc environment can be defined by a ",{"type":49,"tag":326,"props":8805,"children":8807},{"className":8806},[],[8808],{"type":55,"value":8809},"\u003Cname>.tfvars",{"type":55,"value":8811}," file that contains the name of the ad hoc environment (such as ",{"type":49,"tag":326,"props":8813,"children":8815},{"className":8814},[],[8816],{"type":55,"value":8817},"brian",{"type":55,"value":873},{"type":49,"tag":326,"props":8820,"children":8822},{"className":8821},[],[8823],{"type":55,"value":8824},"brian2",{"type":55,"value":873},{"type":49,"tag":326,"props":8827,"children":8829},{"className":8828},[],[8830],{"type":55,"value":8831},"demo-feature-abc",{"type":55,"value":8833},", etc.). This ",{"type":49,"tag":326,"props":8835,"children":8837},{"className":8836},[],[8838],{"type":55,"value":8839},"\u003Cname>",{"type":55,"value":8841}," value will also be the name of the Terraform workspace and will be used to name and tag AWS resources associated with the corresponding ad hoc environment.",{"type":49,"tag":58,"props":8843,"children":8844},{},[8845,8846,8851],{"type":55,"value":413},{"type":49,"tag":326,"props":8847,"children":8849},{"className":8848},[],[8850],{"type":55,"value":8809},{"type":55,"value":8852}," file will allow developers to use a simple, standard file interface for defining application specific values, such as the version of the backend and frontend. This brings developers into the concepts and practices of \"infrastructure as code\" and \"configuration as code\" and also helps the entire team keep track of how different environments are configured.",{"type":49,"tag":58,"props":8854,"children":8855},{},[8856,8858,8863,8865,8871,8873,8880],{"type":55,"value":8857},"Ad hoc environment ",{"type":49,"tag":326,"props":8859,"children":8861},{"className":8860},[],[8862],{"type":55,"value":8809},{"type":55,"value":8864}," files are stored in a directory of a special git repository that also defines the ad hoc environment terraform configuration. Currently, the ",{"type":49,"tag":326,"props":8866,"children":8868},{"className":8867},[],[8869],{"type":55,"value":8870},"tfvars",{"type":55,"value":8872}," files are stored ",{"type":49,"tag":80,"props":8874,"children":8877},{"href":8875,"rel":8876},"https://github.com/briancaffey/django-step-by-step/tree/main/terraform/live/ad-hoc/envs",[84],[8878],{"type":55,"value":8879},"here",{"type":55,"value":745},{"type":49,"tag":58,"props":8882,"children":8883},{},[8884,8886,8891,8892,8897],{"type":55,"value":8885},"Now let's look at the two terraform configurations used for defining ",{"type":49,"tag":72,"props":8887,"children":8888},{},[8889],{"type":55,"value":8890},"shared resources",{"type":55,"value":715},{"type":49,"tag":72,"props":8893,"children":8894},{},[8895],{"type":55,"value":8896},"ad hoc environment resources",{"type":55,"value":745},{"type":49,"tag":50,"props":8899,"children":8901},{"id":8900},"ad-hoc-environment-diagram",[8902],{"type":55,"value":8903},"Ad Hoc Environment Diagram",{"type":49,"tag":58,"props":8905,"children":8906},{},[8907,8909,8914,8915,8920],{"type":55,"value":8908},"Here's an overview of the resources used for the ad hoc environments. The ",{"type":49,"tag":72,"props":8910,"children":8911},{},[8912],{"type":55,"value":8913},"letters represent shared resources",{"type":55,"value":6280},{"type":49,"tag":72,"props":8916,"children":8917},{},[8918],{"type":55,"value":8919},"numbers represent per-environment resources",{"type":55,"value":745},{"type":49,"tag":58,"props":8922,"children":8923},{},[8924],{"type":49,"tag":1601,"props":8925,"children":8927},{"alt":8926,"src":7821},"png",[],{"type":49,"tag":430,"props":8929,"children":8931},{"id":8930},"shared-architecture",[8932],{"type":55,"value":8933},"Shared architecture",{"type":49,"tag":58,"props":8935,"children":8936},{},[8937,8939,8946],{"type":55,"value":8938},"A. VPC (created using the ",{"type":49,"tag":80,"props":8940,"children":8943},{"href":8941,"rel":8942},"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest",[84],[8944],{"type":55,"value":8945},"official AWS VPC Module",{"type":55,"value":616},{"type":49,"tag":58,"props":8948,"children":8949},{},[8950],{"type":55,"value":8951},"B. Public subnets for bastion host, NAT Gateways and Load Balancer",{"type":49,"tag":58,"props":8953,"children":8954},{},[8955],{"type":55,"value":8956},"C. Private subnets for application workloads and RDS",{"type":49,"tag":58,"props":8958,"children":8959},{},[8960],{"type":55,"value":8961},"D. Application Load Balancer that is shared between all ad hoc environments. A pre-provisioned wildcard ACM certificate is attached to the load balancer that is used to secure traffic for load-balanced ECS services",{"type":49,"tag":58,"props":8963,"children":8964},{},[8965],{"type":55,"value":8966},"E. Service discovery namespace that provides a namespace for application workloads to access the redis service running in ECS",{"type":49,"tag":58,"props":8968,"children":8969},{},[8970],{"type":55,"value":8971},"F. IAM roles needed for ECS tasks to access AWS services",{"type":49,"tag":58,"props":8973,"children":8974},{},[8975],{"type":55,"value":8976},"G. RDS instance using postgres engine that is shared between all ad hoc environments",{"type":49,"tag":58,"props":8978,"children":8979},{},[8980],{"type":55,"value":8981},"H. Bastion host used to access RDS from GitHub Actions (needed for creating per-environment databases)",{"type":49,"tag":58,"props":8983,"children":8984},{},[8985],{"type":55,"value":8986},"I. NAT Gateway used to give traffic in private subnets a route to the public internet",{"type":49,"tag":430,"props":8988,"children":8990},{"id":8989},"environment-specific-architecture",[8991],{"type":55,"value":8992},"Environment-specific architecture",{"type":49,"tag":8994,"props":8995,"children":8996},"ol",{},[8997,9002,9007,9012,9017,9022,9027,9032,9037,9047,9056,9061],{"type":49,"tag":68,"props":8998,"children":8999},{},[9000],{"type":55,"value":9001},"ECS Cluster that groups all ECS tasks for a single ad hoc environment",{"type":49,"tag":68,"props":9003,"children":9004},{},[9005],{"type":55,"value":9006},"Listener rules and target groups that direct traffic from the load balancer to the ECS services for an ad hoc environment.",{"type":49,"tag":68,"props":9008,"children":9009},{},[9010],{"type":55,"value":9011},"Redis service running in ECS that provides caching and serves as a task broker for celery",{"type":49,"tag":68,"props":9013,"children":9014},{},[9015],{"type":55,"value":9016},"Route53 records that point to the load balancer",{"type":49,"tag":68,"props":9018,"children":9019},{},[9020],{"type":55,"value":9021},"Frontend service that serves the Vue.js application over NGINX",{"type":49,"tag":68,"props":9023,"children":9024},{},[9025],{"type":55,"value":9026},"API service that serves the backend with Gunicorn",{"type":49,"tag":68,"props":9028,"children":9029},{},[9030],{"type":55,"value":9031},"Celery worker that process jobs in the default queue",{"type":49,"tag":68,"props":9033,"children":9034},{},[9035],{"type":55,"value":9036},"Celery beat that schedules celery tasks",{"type":49,"tag":68,"props":9038,"children":9039},{},[9040,9045],{"type":49,"tag":326,"props":9041,"children":9043},{"className":9042},[],[9044],{"type":55,"value":3316},{"type":55,"value":9046}," task",{"type":49,"tag":68,"props":9048,"children":9049},{},[9050,9055],{"type":49,"tag":326,"props":9051,"children":9053},{"className":9052},[],[9054],{"type":55,"value":3323},{"type":55,"value":9046},{"type":49,"tag":68,"props":9057,"children":9058},{},[9059],{"type":55,"value":9060},"CloudWatch log groups are created for each ECS task in an ad hoc environment",{"type":49,"tag":68,"props":9062,"children":9063},{},[9064],{"type":55,"value":9065},"Each ad hoc environment gets a database in the shared RDS instance",{"type":49,"tag":50,"props":9067,"children":9069},{"id":9068},"shared-resources-terraform-configuration",[9070],{"type":55,"value":9071},"Shared resources terraform configuration",{"type":49,"tag":58,"props":9073,"children":9074},{},[9075],{"type":55,"value":9076},"Let's have a detailed look at the terraform configuration for shared resources that will support ad hoc environments.",{"type":49,"tag":58,"props":9078,"children":9079},{},[9080],{"type":49,"tag":1601,"props":9081,"children":9084},{"alt":9082,"src":9083},"Shared AWS resources for ad hoc environment","/image/shared-resources.png",[],{"type":49,"tag":430,"props":9086,"children":9087},{"id":2091},[9088],{"type":55,"value":2094},{"type":49,"tag":58,"props":9090,"children":9091},{},[9092,9094,9100],{"type":55,"value":9093},"We can use the ",{"type":49,"tag":80,"props":9095,"children":9097},{"href":8941,"rel":9096},[84],[9098],{"type":55,"value":9099},"AWS VPC module",{"type":55,"value":9101}," for creating the shared VPC with Terraform. This module provides a high level interface that will provision lots of the components that are needed for a VPC following best practices, and it is less code for the DevOps team to manage compared to defining each component of a VPC (route tables, subnets, internet gateways, etc.).",{"type":49,"tag":430,"props":9103,"children":9105},{"id":9104},"cloud-map-service-discovery-namespace",[9106],{"type":55,"value":9107},"Cloud Map Service Discovery Namespace",{"type":49,"tag":58,"props":9109,"children":9110},{},[9111],{"type":55,"value":9112},"Cloud Map is used in order to allow services in our ECS cluster to communicate with each other. The only reason that Cloud Map is needed is so that the backend services (API, celery workers, beat) can communicate with Redis, which will be an important service for our application, providing caching and also serving as a broker for celery. If we were to use Django Channels for websockets, the Redis service would also function as the backend for Django Channels.",{"type":49,"tag":58,"props":9114,"children":9115},{},[9116,9118,9124],{"type":55,"value":9117},"We will only need to specify ",{"type":49,"tag":326,"props":9119,"children":9121},{"className":9120},[],[9122],{"type":55,"value":9123},"service_registries",{"type":55,"value":9125}," on the redis service in our ECS cluster. What this will do is provide an address that our other services can use to communicate with redis. This address is created in the form of a Route 53 record, and it points to the private IP address of the redis service. If the private IP of the redis service is updated, the Route 53 record record for our redis service will be updated as well.",{"type":49,"tag":58,"props":9127,"children":9128},{},[9129],{"type":55,"value":9130},"In order for service discovery to work in the VPC that we created, we need to add the following options to the terraform AWS VPC module:",{"type":49,"tag":1050,"props":9132,"children":9134},{"code":9133},"# DNS settings\nenable_dns_hostnames = true\nenable_dns_support   = true\n",[9135],{"type":49,"tag":326,"props":9136,"children":9137},{"__ignoreMap":8},[9138],{"type":55,"value":9133},{"type":49,"tag":430,"props":9140,"children":9141},{"id":2160},[9142],{"type":55,"value":2017},{"type":49,"tag":58,"props":9144,"children":9145},{},[9146],{"type":55,"value":9147},"There are two important security groups that we will set up as part of the shared infrastructure layer to be used by each ad hoc environment: one security group for the load balancer, and one security group where all of our ECS services will run.",{"type":49,"tag":58,"props":9149,"children":9150},{},[9151,9153,9158,9159,9164,9166,9172,9173,9179],{"type":55,"value":9152},"The load balancer security group will allow all traffic on port ",{"type":49,"tag":326,"props":9154,"children":9156},{"className":9155},[],[9157],{"type":55,"value":2341},{"type":55,"value":715},{"type":49,"tag":326,"props":9160,"children":9162},{"className":9161},[],[9163],{"type":55,"value":2290},{"type":55,"value":9165}," for ",{"type":49,"tag":326,"props":9167,"children":9169},{"className":9168},[],[9170],{"type":55,"value":9171},"HTTP",{"type":55,"value":715},{"type":49,"tag":326,"props":9174,"children":9176},{"className":9175},[],[9177],{"type":55,"value":9178},"HTTPS",{"type":55,"value":9180}," traffic. The ECS security group will only allow inbound traffic from the application load balancer security group. It will also allow for traffic from port 6379 for redis traffic.",{"type":49,"tag":430,"props":9182,"children":9184},{"id":9183},"iam-roles",[9185],{"type":55,"value":9186},"IAM Roles",{"type":49,"tag":58,"props":9188,"children":9189},{},[9190],{"type":55,"value":9191},"There are two important IAM roles that we will need for our ECS tasks. We need a task execution role that our ECS tasks will use to interact with other AWS services, such as S3, Secrets Manager, etc.",{"type":49,"tag":430,"props":9193,"children":9195},{"id":9194},"rds-instance",[9196],{"type":55,"value":9197},"RDS Instance",{"type":49,"tag":58,"props":9199,"children":9200},{},[9201],{"type":55,"value":9202},"We will create one RDS instance in one of the private subnets in our VPC. This RDS instance will have one Postgres database per ad hoc environment. This RDS instance has a security group that allows all traffic from our ECS security group.",{"type":49,"tag":430,"props":9204,"children":9206},{"id":9205},"load-balancer",[9207],{"type":55,"value":2022},{"type":49,"tag":58,"props":9209,"children":9210},{},[9211,9213,9219,9221,9227],{"type":55,"value":9212},"We will use one load balancer for all ad hoc environments. This load balancer will have a wildcard ACM certificate attached to it (",{"type":49,"tag":326,"props":9214,"children":9216},{"className":9215},[],[9217],{"type":55,"value":9218},"*.dev.example.com",{"type":55,"value":9220},", for example). Each ad hoc environment will create a Route 53 record that will point to this load balancer's public DNS name. For example, ",{"type":49,"tag":326,"props":9222,"children":9224},{"className":9223},[],[9225],{"type":55,"value":9226},"brian.dev.example.com",{"type":55,"value":9228}," will be the address of my ad hoc environment. Requests to this address will then be routed to either the frontend ECS service or the backend ECS service depending on request header values and request path values that will be set on the listener rules.",{"type":49,"tag":58,"props":9230,"children":9231},{},[9232],{"type":55,"value":9233},"By default, a load balancer supports up to 50 listener rules, so we can create plenty of ad hoc environments before we need to increase the default quota. There will be a discussion at the end of this article about AWS service quotas.",{"type":49,"tag":430,"props":9235,"children":9236},{"id":2683},[9237],{"type":55,"value":2032},{"type":49,"tag":58,"props":9239,"children":9240},{},[9241],{"type":55,"value":9242},"The bastion host will be created in one of the VPC's public subnets. This will primarily be used for connecting to RDS to create new databases for new ad hoc environments, or for manually manipulating data in an ad hoc environment for debugging.",{"type":49,"tag":50,"props":9244,"children":9246},{"id":9245},"ad-hoc-environment-resources",[9247],{"type":55,"value":9248},"Ad hoc environment resources",{"type":49,"tag":58,"props":9250,"children":9251},{},[9252],{"type":55,"value":9253},"Now that we have defined a shared set of infrastructure that our ad hoc environments will use, let's have a look at the resources that will be specific to ad hoc environments that will be added on top of the shared resources.",{"type":49,"tag":430,"props":9255,"children":9256},{"id":2877},[9257],{"type":55,"value":2880},{"type":49,"tag":58,"props":9259,"children":9260},{},[9261],{"type":55,"value":9262},"The ECS Cluster is a simple grouping of ECS tasks and services.",{"type":49,"tag":430,"props":9264,"children":9266},{"id":9265},"ecs-tasks-and-services",[9267],{"type":55,"value":9268},"ECS Tasks and Services",{"type":49,"tag":58,"props":9270,"children":9271},{},[9272],{"type":55,"value":9273},"Each environment will have a set of ECS tasks and services that will be used to run the application.",{"type":49,"tag":58,"props":9275,"children":9276},{},[9277],{"type":55,"value":9278},"There are four important ECS services in our application that are used to run \"long-running\" ECS tasks. Long-running tasks are tasks that start processes that run indefinitely, rather than running until completion. The long-running tasks in our application include:",{"type":49,"tag":64,"props":9280,"children":9281},{},[9282,9287,9292,9297,9302],{"type":49,"tag":68,"props":9283,"children":9284},{},[9285],{"type":55,"value":9286},"backend web application (gunciron web server)",{"type":49,"tag":68,"props":9288,"children":9289},{},[9290],{"type":55,"value":9291},"backend celery worker",{"type":49,"tag":68,"props":9293,"children":9294},{},[9295],{"type":55,"value":9296},"backend celery beat",{"type":49,"tag":68,"props":9298,"children":9299},{},[9300],{"type":55,"value":9301},"frontend web site (nginx web server)",{"type":49,"tag":68,"props":9303,"children":9304},{},[9305],{"type":55,"value":3151},{"type":49,"tag":58,"props":9307,"children":9308},{},[9309],{"type":55,"value":9310},"The infrastructure code also defines some tasks that are not long-running but rather short lived tasks that run until completion and do not start again. These tasks include:",{"type":49,"tag":64,"props":9312,"children":9313},{},[9314,9318,9323],{"type":49,"tag":68,"props":9315,"children":9316},{},[9317],{"type":55,"value":3316},{"type":49,"tag":68,"props":9319,"children":9320},{},[9321],{"type":55,"value":9322},"database migrations",{"type":49,"tag":68,"props":9324,"children":9325},{},[9326],{"type":55,"value":9327},"any other ad-hoc task that we want to run, usually wrapped in a Django management command",{"type":49,"tag":50,"props":9329,"children":9331},{"id":9330},"how-to-setup-an-ad-hoc-environment",[9332],{"type":55,"value":9333},"How to setup an ad hoc environment",{"type":49,"tag":58,"props":9335,"children":9336},{},[9337],{"type":55,"value":9338},"Now that we have been over the resources that will be created to support our ad hoc environments, let's talk about how we can enable individuals on our team to create and update ad hoc environments.",{"type":49,"tag":430,"props":9340,"children":9342},{"id":9341},"design-decisions",[9343],{"type":55,"value":9344},"Design decisions",{"type":49,"tag":58,"props":9346,"children":9347},{},[9348,9350,9356,9358,9363,9364,9369,9371,9376,9378,9383],{"type":55,"value":9349},"The devops team will decide on the interface that will be used for creating an ad hoc environment. Since we are using Terraform, this interface will be a Terraform configuration. The minimum amount of information that our ad hoc environment configuration needs is image tags for the frontend and backend images to use. Other configurations will be provided by default values set in ",{"type":49,"tag":326,"props":9351,"children":9353},{"className":9352},[],[9354],{"type":55,"value":9355},"variables.tf",{"type":55,"value":9357},", and these defaults can easily be overridden by passing values to ",{"type":49,"tag":326,"props":9359,"children":9361},{"className":9360},[],[9362],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9365,"children":9367},{"className":9366},[],[9368],{"type":55,"value":559},{"type":55,"value":9370},". I'm choosing to use ",{"type":49,"tag":326,"props":9372,"children":9374},{"className":9373},[],[9375],{"type":55,"value":8809},{"type":55,"value":9377}," as the way to pass configuration values to our ad hoc environments where ",{"type":49,"tag":326,"props":9379,"children":9381},{"className":9380},[],[9382],{"type":55,"value":8839},{"type":55,"value":9384}," is the name of the ad hoc environment being created. This will give us the following benefits:",{"type":49,"tag":64,"props":9386,"children":9387},{},[9388,9400],{"type":49,"tag":68,"props":9389,"children":9390},{},[9391,9393,9398],{"type":55,"value":9392},"all ad hoc environments will be visible to the entire team in git since each ad hoc environment will have a ",{"type":49,"tag":326,"props":9394,"children":9396},{"className":9395},[],[9397],{"type":55,"value":8809},{"type":55,"value":9399}," file associated with it",{"type":49,"tag":68,"props":9401,"children":9402},{},[9403,9405],{"type":55,"value":9404},"adding additional customization to an ad hoc environment does not add additional complexity to our automation pipeline since all customization is added through a single file that will be referenced by ",{"type":49,"tag":326,"props":9406,"children":9408},{"className":9407},[],[9409],{"type":55,"value":9410},"$WORKSPACE.tfvars",{"type":49,"tag":58,"props":9412,"children":9413},{},[9414],{"type":55,"value":9415},"The downsides of this approach are:",{"type":49,"tag":64,"props":9417,"children":9418},{},[9419,9424],{"type":49,"tag":68,"props":9420,"children":9421},{},[9422],{"type":55,"value":9423},"creating ad hoc environments requires knowledge of git, so non-technical product team members might need help from the engineering team when setting up an ad hoc environment",{"type":49,"tag":68,"props":9425,"children":9426},{},[9427,9429,9434],{"type":55,"value":9428},"there is an additional \"manual\" step of creating a ",{"type":49,"tag":326,"props":9430,"children":9432},{"className":9431},[],[9433],{"type":55,"value":8809},{"type":55,"value":9435}," file that must be done before running a pipeline to create an ad hoc environment",{"type":49,"tag":58,"props":9437,"children":9438},{},[9439,9441,9446,9448,9453,9455,9460],{"type":55,"value":9440},"Provided that a ",{"type":49,"tag":326,"props":9442,"children":9444},{"className":9443},[],[9445],{"type":55,"value":8809},{"type":55,"value":9447}," file has been created and pushed to the repo, creating or updating an ad hoc environment will be as simple as running a pipeline in GitHub Actions that specifies the ",{"type":49,"tag":326,"props":9449,"children":9451},{"className":9450},[],[9452],{"type":55,"value":8839},{"type":55,"value":9454}," of our ad hoc environment. If no such ",{"type":49,"tag":326,"props":9456,"children":9458},{"className":9457},[],[9459],{"type":55,"value":8809},{"type":55,"value":9461}," file exists, our pipeline will fail.",{"type":49,"tag":430,"props":9463,"children":9465},{"id":9464},"github-action",[9466],{"type":55,"value":9467},"GitHub Action",{"type":49,"tag":58,"props":9469,"children":9470},{},[9471,9473,9479],{"type":55,"value":9472},"Creating ad hoc environments will involve manually triggering a GitHub Action that runs on ",{"type":49,"tag":326,"props":9474,"children":9476},{"className":9475},[],[9477],{"type":55,"value":9478},"workflow_dispatch",{"type":55,"value":6694},{"type":49,"tag":1050,"props":9481,"children":9483},{"code":9482},"on:\n  workflow_dispatch:\n    inputs:\n      workspace:\n        description: 'Name of terraform workspace to use'\n        required: true\n        default: 'dev'\n        type: string\n",[9484],{"type":49,"tag":326,"props":9485,"children":9486},{"__ignoreMap":8},[9487],{"type":55,"value":9482},{"type":49,"tag":58,"props":9489,"children":9490},{},[9491,9493,9498],{"type":55,"value":9492},"We only have to enter the name of the ad hoc environment we want to create or update. The ad hoc environment name is used as the Terraform workspace name. This name is also the name of the ",{"type":49,"tag":326,"props":9494,"children":9496},{"className":9495},[],[9497],{"type":55,"value":8809},{"type":55,"value":9499}," file that must be created per environment.",{"type":49,"tag":58,"props":9501,"children":9502},{},[9503,9505,9510,9511,9516,9517,9522,9524,9529,9531,9537],{"type":55,"value":9504},"This workflow will do ",{"type":49,"tag":326,"props":9506,"children":9508},{"className":9507},[],[9509],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9512,"children":9514},{"className":9513},[],[9515],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9518,"children":9520},{"className":9519},[],[9521],{"type":55,"value":559},{"type":55,"value":9523}," using the ",{"type":49,"tag":326,"props":9525,"children":9527},{"className":9526},[],[9528],{"type":55,"value":8809},{"type":55,"value":9530}," file. When everything has been created, we will use the AWS CLI to prepare the environment so that it can be used. We will use the ",{"type":49,"tag":326,"props":9532,"children":9534},{"className":9533},[],[9535],{"type":55,"value":9536},"aws ecs run-task",{"type":55,"value":9538}," command to run database migrations needed so that the application code can make database queries.",{"type":49,"tag":50,"props":9540,"children":9542},{"id":9541},"how-to-update-code-in-an-existing-ad-hoc-environment",[9543],{"type":55,"value":9544},"How to update code in an existing ad hoc environment",{"type":49,"tag":58,"props":9546,"children":9547},{},[9548,9550,9555,9557,9563,9565,9571,9573,9579,9581,9587],{"type":55,"value":9549},"Assuming that we have deployed an ad hoc environment called ",{"type":49,"tag":326,"props":9551,"children":9553},{"className":9552},[],[9554],{"type":55,"value":8817},{"type":55,"value":9556}," with version ",{"type":49,"tag":326,"props":9558,"children":9560},{"className":9559},[],[9561],{"type":55,"value":9562},"v1.0.0",{"type":55,"value":9564}," of the backend application and ",{"type":49,"tag":326,"props":9566,"children":9568},{"className":9567},[],[9569],{"type":55,"value":9570},"v2.0.0",{"type":55,"value":9572}," of the frontend application, let's think about the process of updating the application to ",{"type":49,"tag":326,"props":9574,"children":9576},{"className":9575},[],[9577],{"type":55,"value":9578},"v1.1.0",{"type":55,"value":9580}," of the backend and ",{"type":49,"tag":326,"props":9582,"children":9584},{"className":9583},[],[9585],{"type":55,"value":9586},"v2.1.0",{"type":55,"value":9588}," of the frontend.",{"type":49,"tag":58,"props":9590,"children":9591},{},[9592,9594,9600],{"type":55,"value":9593},"The simplest approach to updating the application would be edit the ",{"type":49,"tag":326,"props":9595,"children":9597},{"className":9596},[],[9598],{"type":55,"value":9599},"brian.tfvars",{"type":55,"value":9601}," file with the new versions:",{"type":49,"tag":1050,"props":9603,"children":9605},{"code":9604},"# brian.tfvars\nbe_image_tag = \"v1.1.0\"\nfe_image_tag = \"v2.1.0\"\n",[9606],{"type":49,"tag":326,"props":9607,"children":9608},{"__ignoreMap":8},[9609],{"type":55,"value":9604},{"type":49,"tag":58,"props":9611,"children":9612},{},[9613,9615,9620,9621,9626,9627,9632,9634,9639,9641,9648],{"type":55,"value":9614},"If we run the same pipeline that we initially used to deploy ad hoc environment (with ",{"type":49,"tag":326,"props":9616,"children":9618},{"className":9617},[],[9619],{"type":55,"value":8181},{"type":55,"value":873},{"type":49,"tag":326,"props":9622,"children":9624},{"className":9623},[],[9625],{"type":55,"value":551},{"type":55,"value":715},{"type":49,"tag":326,"props":9628,"children":9630},{"className":9629},[],[9631],{"type":55,"value":559},{"type":55,"value":9633},") against the updated ",{"type":49,"tag":326,"props":9635,"children":9637},{"className":9636},[],[9638],{"type":55,"value":9599},{"type":55,"value":9640}," file, this will result in a rolling update of the frontend and backend services (",{"type":49,"tag":80,"props":9642,"children":9645},{"href":9643,"rel":9644},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html",[84],[9646],{"type":55,"value":9647},"more on rolling updates here",{"type":55,"value":3213},{"type":49,"tag":58,"props":9650,"children":9651},{},[9652,9654,9659,9661,9667],{"type":55,"value":9653},"If there are database migrations included in the new version of the code that is going out, we need to run database migrations after the ",{"type":49,"tag":326,"props":9655,"children":9657},{"className":9656},[],[9658],{"type":55,"value":559},{"type":55,"value":9660}," completes. We use a top level output from the ad hov environment terraform configuration that is a ",{"type":49,"tag":326,"props":9662,"children":9664},{"className":9663},[],[9665],{"type":55,"value":9666},"run-task",{"type":55,"value":9668}," command with all appropriate arguments that will run database migrations when called from GitHub Actions.",{"type":49,"tag":430,"props":9670,"children":9672},{"id":9671},"order-of-operations",[9673],{"type":55,"value":9674},"Order of Operations",{"type":49,"tag":58,"props":9676,"children":9677},{},[9678,9680,9685],{"type":55,"value":9679},"For ad hoc environments, it is probably fine to update the services and then run the database migrations. Ad hoc environments may only have a single \"user\" -- the developer, so ",{"type":49,"tag":72,"props":9681,"children":9682},{},[9683],{"type":55,"value":9684},"we don't need to worry about any errors that may occur if requests are made against the new version of code before database migrations have been applied",{"type":55,"value":745},{"type":49,"tag":58,"props":9687,"children":9688},{},[9689,9691,9697,9699,9705],{"type":55,"value":9690},"Let's consider a simple example to illustrate what can go wrong here. If we add a ",{"type":49,"tag":326,"props":9692,"children":9694},{"className":9693},[],[9695],{"type":55,"value":9696},"total_views",{"type":55,"value":9698}," to our blog post model to track the total number of page views a post has, we would add a field to the model, generate migration file with ",{"type":49,"tag":326,"props":9700,"children":9702},{"className":9701},[],[9703],{"type":55,"value":9704},"makemigrations",{"type":55,"value":9706},", and then update our views and model serializers to make use of this new field. In the time between updating our service and running the database migrations, any requests to endpoints that access the new database field will fail since the table does not yet exist.",{"type":49,"tag":58,"props":9708,"children":9709},{},[9710,9712,9717],{"type":55,"value":9711},"If we first run database migrations ",{"type":49,"tag":72,"props":9713,"children":9714},{},[9715],{"type":55,"value":9716},"and then",{"type":55,"value":9718}," update application code (ECS services), then we can avoid errors about fields not existing. In our production application, we want to aim for fewer errors, so we should be using this \"order of operations\": first run new database migrations and then update application code.",{"type":49,"tag":430,"props":9720,"children":9722},{"id":9721},"github-action-for-application-updates",[9723],{"type":55,"value":9724},"GitHub Action for application updates",{"type":49,"tag":58,"props":9726,"children":9727},{},[9728],{"type":55,"value":9729},"We need a GitHub Action that can do the following:",{"type":49,"tag":64,"props":9731,"children":9732},{},[9733,9745,9757,9769,9780,9792,9804],{"type":49,"tag":68,"props":9734,"children":9735},{},[9736,9738,9744],{"type":55,"value":9737},"fetch the current container definition JSON files for each backend tasks (",{"type":49,"tag":326,"props":9739,"children":9741},{"className":9740},[],[9742],{"type":55,"value":9743},"aws ecs describe-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9746,"children":9747},{},[9748,9750,9756],{"type":55,"value":9749},"write new container definitions JSON with the new backend image tag (using ",{"type":49,"tag":326,"props":9751,"children":9753},{"className":9752},[],[9754],{"type":55,"value":9755},"jq",{"type":55,"value":616},{"type":49,"tag":68,"props":9758,"children":9759},{},[9760,9762,9768],{"type":55,"value":9761},"register new task definitions with the new container definition JSON files for each task (",{"type":49,"tag":326,"props":9763,"children":9765},{"className":9764},[],[9766],{"type":55,"value":9767},"aws ecs register-task-definition",{"type":55,"value":616},{"type":49,"tag":68,"props":9770,"children":9771},{},[9772,9774,9779],{"type":55,"value":9773},"call run-task with the newly updated migration ECS task (",{"type":49,"tag":326,"props":9775,"children":9777},{"className":9776},[],[9778],{"type":55,"value":9536},{"type":55,"value":616},{"type":49,"tag":68,"props":9781,"children":9782},{},[9783,9785,9791],{"type":55,"value":9784},"wait for the task to exit and display the logs (",{"type":49,"tag":326,"props":9786,"children":9788},{"className":9787},[],[9789],{"type":55,"value":9790},"aws ecs wait tasks-stopped",{"type":55,"value":616},{"type":49,"tag":68,"props":9793,"children":9794},{},[9795,9797,9803],{"type":55,"value":9796},"update the backend services (gunicorn, celery, celery beat) (",{"type":49,"tag":326,"props":9798,"children":9800},{"className":9799},[],[9801],{"type":55,"value":9802},"aws ecs update-service",{"type":55,"value":616},{"type":49,"tag":68,"props":9805,"children":9806},{},[9807,9809,9815],{"type":55,"value":9808},"wait for the new backend services to be stable (",{"type":49,"tag":326,"props":9810,"children":9812},{"className":9811},[],[9813],{"type":55,"value":9814},"aws ecs wait services-stable",{"type":55,"value":616},{"type":49,"tag":58,"props":9817,"children":9818},{},[9819],{"type":55,"value":9820},"Here's a visual representation of the backend update process:",{"type":49,"tag":58,"props":9822,"children":9823},{},[9824],{"type":49,"tag":1601,"props":9825,"children":9827},{"alt":8926,"src":9826},"/static/adhoc/ad_hoc.backend_update.drawio.png",[],{"type":49,"tag":58,"props":9829,"children":9830},{},[9831],{"type":55,"value":9832},"In order have the correct arguments for all of the AWS CLI calls used in the above workflow, we can use the AWS CLI to fetch resource names by tag.",{"type":49,"tag":58,"props":9834,"children":9835},{},[9836],{"type":55,"value":9837},"Here is what I'm using for the script. There lots of comments, so please refer to those comments for an explanation of what the script is doing.",{"type":49,"tag":1050,"props":9839,"children":9841},{"code":9840,"language":2728,"meta":8,"className":2729,"style":8},"#!/bin/bash\n\n# This script will be called to update an ad hoc environment backend\n# with a new image tag. It will first run pre-update tasks (such as migrations)\n# and then do a rolling update of the backend services.\n\n# It is called from the ad_hock_backend_update.yml GitHub Actions file\n\n# Required environment variables that need to be exported before running this script:\n\n# WORKSPACE - ad hoc environment workspace\n# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n\necho \"Updating backend services...\"\n\n# first define a variable containing the new image URI\nNEW_BACKEND_IMAGE_URI=\"$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/backend:$BACKEND_IMAGE_TAG\"\n\n\n# register new task definitions\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\nfor TASK in \"migrate\" \"gunicorn\" \"default\" \"beat\"\ndo\n  echo \"Updating $TASK task definition...\"\n\n  # in Terraform we name our tasks based on the ad hoc environment name\n  # (also the Terraform workspace name) and the name of the task\n  # (e.g. migrate, gunicorn, default, beat)\n  TASK_FAMILY=$WORKSPACE-$TASK\n\n  # save the task definition JSON to a variable\n  TASK_DESCRIPTION=$(aws ecs describe-task-definition \\\n    --task-definition $TASK_FAMILY \\\n  )\n\n  # save container definitions to a file for each task\n  echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.containerDefinitions \\\n    > /tmp/$TASK_FAMILY.json\n\n  # write new container definition JSON with updated image\n  echo \"Writing new $TASK_FAMILY container definitions JSON...\"\n\n  # replace old image URI with new image URI in a new container definitions JSON\n  cat /tmp/$TASK_FAMILY.json \\\n    | jq \\\n    --arg IMAGE \"$NEW_BACKEND_IMAGE_URI\" '.[0].image |= $IMAGE' \\\n    > /tmp/$TASK_FAMILY-new.json\n\n  # Get the existing configuration for the task definition (memory, cpu, etc.)\n  # from the variable that we saved the task definition JSON to earlier\n  echo \"Getting existing configuration for $TASK_FAMILY...\"\n\n  MEMORY=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.memory \\\n  )\n\n  CPU=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.cpu \\\n  )\n\n  ECS_EXECUTION_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.executionRoleArn \\\n  )\n\n  ECS_TASK_ROLE_ARN=$( echo $TASK_DESCRIPTION | jq -r \\\n    .taskDefinition.taskRoleArn \\\n  )\n\n  # check the content of the new container definition JSON\n  cat /tmp/$TASK_FAMILY-new.json\n\n  # register new task definition using the new container definitions\n  # and the values that we read off of the existing task definitions\n  echo \"Registering new $TASK_FAMILY task definition...\"\n\n  aws ecs register-task-definition \\\n    --family $TASK_FAMILY \\\n    --container-definitions file:///tmp/$TASK_FAMILY-new.json \\\n    --memory $MEMORY \\\n    --cpu $CPU \\\n    --network-mode awsvpc \\\n    --execution-role-arn $ECS_EXECUTION_ROLE_ARN \\\n    --task-role-arn $ECS_TASK_ROLE_ARN \\\n    --requires-compatibilities \"FARGATE\"\n\ndone\n\n# Now we need to run migrate, collectstatic and any other commands that need to be run\n# before doing a rolling update of the backend services\n\n# We will use the new task definitions we just created to run these commands\n\n# get the ARN of the most recent revision of the migrate task definition\nTASK_DEFINITION=$( \\\n  aws ecs describe-task-definition \\\n    --task-definition $WORKSPACE-migrate \\\n    | jq -r \\\n    .taskDefinition.taskDefinitionArn \\\n)\n\n# get private subnets as space separated string from shared resources VPC\nSUBNETS=$( \\\n  aws ec2 describe-subnets \\\n    --filters \"Name=tag:env,Values=$SHARED_RESOURCES_WORKSPACE\" \"Name=tag:Name,Values=*private*\" \\\n    --query 'Subnets[*].SubnetId' \\\n    --output text \\\n)\n\n# replace spaces with commas using tr\nSUBNET_IDS=$(echo $SUBNETS | tr ' ' ',')\n\n# https://github.com/aws/aws-cli/issues/5348\n# get ecs_sg_id - just a single value\nECS_SG_ID=$( \\\n  aws ec2 describe-security-groups \\\n    --filters \"Name=tag:Name,Values=$SHARED_RESOURCES_WORKSPACE-ecs-sg\" \\\n    --query 'SecurityGroups[*].GroupId' \\\n    --output text \\\n)\n\necho \"Running database migrations...\"\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nSTART_TIME=$(date +%s000)\n\n# run the migration task and capture the taskArn into a variable called TASK_ID\nTASK_ID=$( \\\n  aws ecs run-task \\\n    --cluster $WORKSPACE-cluster \\\n    --task-definition $TASK_DEFINITION \\\n    --network-configuration \"awsvpcConfiguration={subnets=[$SUBNET_IDS],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}\" \\\n    | jq -r '.tasks[0].taskArn' \\\n  )\n\necho \"Task ID is $TASK_ID\"\n\n# wait for the migrate task to exit\n# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n# > It will poll every 6 seconds until a successful state has been reached.\n# > This will exit with a return code of 255 after 100 failed checks.\naws ecs wait tasks-stopped \\\n  --tasks $TASK_ID \\\n  --cluster $WORKSPACE-cluster\n\n# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\nEND_TIME=$(date +%s000)\n\n# print the CloudWatch log events to STDOUT\naws logs get-log-events \\\n  --log-group-name \"/ecs/$WORKSPACE/migrate\" \\\n  --log-stream-name \"migrate/migrate/${TASK_ID##*/}\" \\\n  --start-time $START_TIME \\\n  --end-time $END_TIME \\\n  | jq -r '.events[].message'\n\necho \"Migrations complete. Starting rolling update for backend services...\"\n\n# update backend services\nfor TASK in \"gunicorn\" \"default\" \"beat\"\ndo\n\n  # get taskDefinitionArn for each service to be used in update-service command\n  # this will get the most recent revision of each task (the one that was just created)\n  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n  TASK_DEFINITION=$( \\\n    aws ecs describe-task-definition \\\n      --task-definition $WORKSPACE-$TASK \\\n      | jq -r \\\n      .taskDefinition.taskDefinitionArn \\\n  )\n\n  # update each service with new task definintion\n  aws ecs update-service \\\n    --cluster $WORKSPACE-cluster \\\n    --service $WORKSPACE-$TASK \\\n    --task-definition $TASK_DEFINITION \\\n    --no-cli-pager\n\ndone\n\necho \"Services updated. Waiting for services to become stable...\"\n\n# wait for all service to be stable (runningCount == desiredCount for each service)\naws ecs wait services-stable \\\n  --cluster $WORKSPACE-cluster \\\n  --services $WORKSPACE-gunicorn $WORKSPACE-default $WORKSPACE-beat\n\necho \"Services are now stable. Backend services are now up to date with $BACKEND_IMAGE_TAG.\"\n\necho \"Backend update is now complete!\"\n",[9842],{"type":49,"tag":326,"props":9843,"children":9844},{"__ignoreMap":8},[9845,9853,9860,9868,9876,9884,9891,9899,9906,9914,9921,9929,9937,9945,9953,9960,9974,9981,9989,10026,10033,10040,10048,10056,10094,10102,10125,10132,10140,10149,10158,10186,10194,10203,10240,10259,10268,10276,10285,10317,10330,10354,10362,10371,10393,10401,10410,10436,10453,10490,10511,10519,10528,10537,10559,10567,10609,10622,10630,10638,10679,10692,10700,10708,10749,10762,10770,10778,10819,10832,10840,10848,10857,10877,10885,10894,10903,10924,10932,10954,10971,10998,11016,11034,11052,11070,11088,11102,11110,11119,11127,11136,11145,11153,11162,11170,11179,11200,11220,11242,11262,11275,11283,11291,11300,11321,11343,11375,11393,11411,11419,11427,11436,11485,11493,11502,11511,11532,11553,11579,11596,11612,11620,11628,11641,11649,11658,11689,11697,11706,11727,11748,11770,11787,11824,11849,11857,11865,11887,11895,11904,11913,11922,11931,11957,11975,11993,12001,12009,12038,12046,12055,12077,12104,12136,12154,12172,12194,12202,12215,12223,12232,12260,12268,12276,12285,12294,12303,12324,12345,12371,12392,12405,12413,12421,12430,12451,12471,12496,12512,12521,12529,12537,12545,12558,12566,12575,12600,12620,12656,12664,12686,12694],{"type":49,"tag":1060,"props":9846,"children":9847},{"class":1062,"line":1063},[9848],{"type":49,"tag":1060,"props":9849,"children":9850},{"style":3039},[9851],{"type":55,"value":9852},"#!/bin/bash\n",{"type":49,"tag":1060,"props":9854,"children":9855},{"class":1062,"line":1079},[9856],{"type":49,"tag":1060,"props":9857,"children":9858},{"emptyLinePlaceholder":44},[9859],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9861,"children":9862},{"class":1062,"line":1088},[9863],{"type":49,"tag":1060,"props":9864,"children":9865},{"style":3039},[9866],{"type":55,"value":9867},"# This script will be called to update an ad hoc environment backend\n",{"type":49,"tag":1060,"props":9869,"children":9870},{"class":1062,"line":1097},[9871],{"type":49,"tag":1060,"props":9872,"children":9873},{"style":3039},[9874],{"type":55,"value":9875},"# with a new image tag. It will first run pre-update tasks (such as migrations)\n",{"type":49,"tag":1060,"props":9877,"children":9878},{"class":1062,"line":1111},[9879],{"type":49,"tag":1060,"props":9880,"children":9881},{"style":3039},[9882],{"type":55,"value":9883},"# and then do a rolling update of the backend services.\n",{"type":49,"tag":1060,"props":9885,"children":9886},{"class":1062,"line":1120},[9887],{"type":49,"tag":1060,"props":9888,"children":9889},{"emptyLinePlaceholder":44},[9890],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9892,"children":9893},{"class":1062,"line":1128},[9894],{"type":49,"tag":1060,"props":9895,"children":9896},{"style":3039},[9897],{"type":55,"value":9898},"# It is called from the ad_hock_backend_update.yml GitHub Actions file\n",{"type":49,"tag":1060,"props":9900,"children":9901},{"class":1062,"line":1141},[9902],{"type":49,"tag":1060,"props":9903,"children":9904},{"emptyLinePlaceholder":44},[9905],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9907,"children":9908},{"class":1062,"line":1150},[9909],{"type":49,"tag":1060,"props":9910,"children":9911},{"style":3039},[9912],{"type":55,"value":9913},"# Required environment variables that need to be exported before running this script:\n",{"type":49,"tag":1060,"props":9915,"children":9916},{"class":1062,"line":1158},[9917],{"type":49,"tag":1060,"props":9918,"children":9919},{"emptyLinePlaceholder":44},[9920],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9922,"children":9923},{"class":1062,"line":1171},[9924],{"type":49,"tag":1060,"props":9925,"children":9926},{"style":3039},[9927],{"type":55,"value":9928},"# WORKSPACE - ad hoc environment workspace\n",{"type":49,"tag":1060,"props":9930,"children":9931},{"class":1062,"line":1180},[9932],{"type":49,"tag":1060,"props":9933,"children":9934},{"style":3039},[9935],{"type":55,"value":9936},"# SHARED_RESOURCES_WORKSPACE - shared resources workspace\n",{"type":49,"tag":1060,"props":9938,"children":9939},{"class":1062,"line":1188},[9940],{"type":49,"tag":1060,"props":9941,"children":9942},{"style":3039},[9943],{"type":55,"value":9944},"# BACKEND_IMAGE_TAG - backend image tag to update services to (e.g. v1.2.3)\n",{"type":49,"tag":1060,"props":9946,"children":9947},{"class":1062,"line":1201},[9948],{"type":49,"tag":1060,"props":9949,"children":9950},{"style":3039},[9951],{"type":55,"value":9952},"# AWS_ACCOUNT_ID - AWS account ID is used for the ECR repository URL\n",{"type":49,"tag":1060,"props":9954,"children":9955},{"class":1062,"line":1210},[9956],{"type":49,"tag":1060,"props":9957,"children":9958},{"emptyLinePlaceholder":44},[9959],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9961,"children":9962},{"class":1062,"line":1218},[9963,9969],{"type":49,"tag":1060,"props":9964,"children":9966},{"style":9965},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[9967],{"type":55,"value":9968},"echo",{"type":49,"tag":1060,"props":9970,"children":9971},{"style":2215},[9972],{"type":55,"value":9973}," \"Updating backend services...\"\n",{"type":49,"tag":1060,"props":9975,"children":9976},{"class":1062,"line":1232},[9977],{"type":49,"tag":1060,"props":9978,"children":9979},{"emptyLinePlaceholder":44},[9980],{"type":55,"value":1094},{"type":49,"tag":1060,"props":9982,"children":9983},{"class":1062,"line":1241},[9984],{"type":49,"tag":1060,"props":9985,"children":9986},{"style":3039},[9987],{"type":55,"value":9988},"# first define a variable containing the new image URI\n",{"type":49,"tag":1060,"props":9990,"children":9991},{"class":1062,"line":1249},[9992,9997,10001,10006,10011,10016,10021],{"type":49,"tag":1060,"props":9993,"children":9994},{"style":1073},[9995],{"type":55,"value":9996},"NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":9998,"children":9999},{"style":2194},[10000],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10002,"children":10003},{"style":2215},[10004],{"type":55,"value":10005},"\"",{"type":49,"tag":1060,"props":10007,"children":10008},{"style":1073},[10009],{"type":55,"value":10010},"$AWS_ACCOUNT_ID",{"type":49,"tag":1060,"props":10012,"children":10013},{"style":2215},[10014],{"type":55,"value":10015},".dkr.ecr.us-east-1.amazonaws.com/backend:",{"type":49,"tag":1060,"props":10017,"children":10018},{"style":1073},[10019],{"type":55,"value":10020},"$BACKEND_IMAGE_TAG",{"type":49,"tag":1060,"props":10022,"children":10023},{"style":2215},[10024],{"type":55,"value":10025},"\"\n",{"type":49,"tag":1060,"props":10027,"children":10028},{"class":1062,"line":1262},[10029],{"type":49,"tag":1060,"props":10030,"children":10031},{"emptyLinePlaceholder":44},[10032],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10034,"children":10035},{"class":1062,"line":4581},[10036],{"type":49,"tag":1060,"props":10037,"children":10038},{"emptyLinePlaceholder":44},[10039],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10041,"children":10042},{"class":1062,"line":4631},[10043],{"type":49,"tag":1060,"props":10044,"children":10045},{"style":3039},[10046],{"type":55,"value":10047},"# register new task definitions\n",{"type":49,"tag":1060,"props":10049,"children":10050},{"class":1062,"line":4682},[10051],{"type":49,"tag":1060,"props":10052,"children":10053},{"style":3039},[10054],{"type":55,"value":10055},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":10057,"children":10058},{"class":1062,"line":4709},[10059,10064,10069,10074,10079,10084,10089],{"type":49,"tag":1060,"props":10060,"children":10061},{"style":2194},[10062],{"type":55,"value":10063},"for",{"type":49,"tag":1060,"props":10065,"children":10066},{"style":1073},[10067],{"type":55,"value":10068}," TASK ",{"type":49,"tag":1060,"props":10070,"children":10071},{"style":2194},[10072],{"type":55,"value":10073},"in",{"type":49,"tag":1060,"props":10075,"children":10076},{"style":2215},[10077],{"type":55,"value":10078}," \"migrate\"",{"type":49,"tag":1060,"props":10080,"children":10081},{"style":2215},[10082],{"type":55,"value":10083}," \"gunicorn\"",{"type":49,"tag":1060,"props":10085,"children":10086},{"style":2215},[10087],{"type":55,"value":10088}," \"default\"",{"type":49,"tag":1060,"props":10090,"children":10091},{"style":2215},[10092],{"type":55,"value":10093}," \"beat\"\n",{"type":49,"tag":1060,"props":10095,"children":10096},{"class":1062,"line":5979},[10097],{"type":49,"tag":1060,"props":10098,"children":10099},{"style":2194},[10100],{"type":55,"value":10101},"do\n",{"type":49,"tag":1060,"props":10103,"children":10104},{"class":1062,"line":5988},[10105,10110,10115,10120],{"type":49,"tag":1060,"props":10106,"children":10107},{"style":9965},[10108],{"type":55,"value":10109},"  echo",{"type":49,"tag":1060,"props":10111,"children":10112},{"style":2215},[10113],{"type":55,"value":10114}," \"Updating ",{"type":49,"tag":1060,"props":10116,"children":10117},{"style":1073},[10118],{"type":55,"value":10119},"$TASK",{"type":49,"tag":1060,"props":10121,"children":10122},{"style":2215},[10123],{"type":55,"value":10124}," task definition...\"\n",{"type":49,"tag":1060,"props":10126,"children":10127},{"class":1062,"line":5997},[10128],{"type":49,"tag":1060,"props":10129,"children":10130},{"emptyLinePlaceholder":44},[10131],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10133,"children":10134},{"class":1062,"line":6006},[10135],{"type":49,"tag":1060,"props":10136,"children":10137},{"style":3039},[10138],{"type":55,"value":10139},"  # in Terraform we name our tasks based on the ad hoc environment name\n",{"type":49,"tag":1060,"props":10141,"children":10143},{"class":1062,"line":10142},29,[10144],{"type":49,"tag":1060,"props":10145,"children":10146},{"style":3039},[10147],{"type":55,"value":10148},"  # (also the Terraform workspace name) and the name of the task\n",{"type":49,"tag":1060,"props":10150,"children":10152},{"class":1062,"line":10151},30,[10153],{"type":49,"tag":1060,"props":10154,"children":10155},{"style":3039},[10156],{"type":55,"value":10157},"  # (e.g. migrate, gunicorn, default, beat)\n",{"type":49,"tag":1060,"props":10159,"children":10161},{"class":1062,"line":10160},31,[10162,10167,10171,10176,10181],{"type":49,"tag":1060,"props":10163,"children":10164},{"style":1073},[10165],{"type":55,"value":10166},"  TASK_FAMILY",{"type":49,"tag":1060,"props":10168,"children":10169},{"style":2194},[10170],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10172,"children":10173},{"style":1073},[10174],{"type":55,"value":10175},"$WORKSPACE",{"type":49,"tag":1060,"props":10177,"children":10178},{"style":2215},[10179],{"type":55,"value":10180},"-",{"type":49,"tag":1060,"props":10182,"children":10183},{"style":1073},[10184],{"type":55,"value":10185},"$TASK\n",{"type":49,"tag":1060,"props":10187,"children":10189},{"class":1062,"line":10188},32,[10190],{"type":49,"tag":1060,"props":10191,"children":10192},{"emptyLinePlaceholder":44},[10193],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10195,"children":10197},{"class":1062,"line":10196},33,[10198],{"type":49,"tag":1060,"props":10199,"children":10200},{"style":3039},[10201],{"type":55,"value":10202},"  # save the task definition JSON to a variable\n",{"type":49,"tag":1060,"props":10204,"children":10206},{"class":1062,"line":10205},34,[10207,10212,10216,10221,10225,10230,10235],{"type":49,"tag":1060,"props":10208,"children":10209},{"style":1073},[10210],{"type":55,"value":10211},"  TASK_DESCRIPTION",{"type":49,"tag":1060,"props":10213,"children":10214},{"style":2194},[10215],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10217,"children":10218},{"style":1073},[10219],{"type":55,"value":10220},"$(",{"type":49,"tag":1060,"props":10222,"children":10223},{"style":1067},[10224],{"type":55,"value":20},{"type":49,"tag":1060,"props":10226,"children":10227},{"style":2215},[10228],{"type":55,"value":10229}," ecs",{"type":49,"tag":1060,"props":10231,"children":10232},{"style":2215},[10233],{"type":55,"value":10234}," describe-task-definition",{"type":49,"tag":1060,"props":10236,"children":10237},{"style":2287},[10238],{"type":55,"value":10239}," \\\n",{"type":49,"tag":1060,"props":10241,"children":10243},{"class":1062,"line":10242},35,[10244,10249,10254],{"type":49,"tag":1060,"props":10245,"children":10246},{"style":2287},[10247],{"type":55,"value":10248},"    --task-definition",{"type":49,"tag":1060,"props":10250,"children":10251},{"style":1073},[10252],{"type":55,"value":10253}," $TASK_FAMILY ",{"type":49,"tag":1060,"props":10255,"children":10256},{"style":2287},[10257],{"type":55,"value":10258},"\\\n",{"type":49,"tag":1060,"props":10260,"children":10262},{"class":1062,"line":10261},36,[10263],{"type":49,"tag":1060,"props":10264,"children":10265},{"style":1073},[10266],{"type":55,"value":10267},"  )\n",{"type":49,"tag":1060,"props":10269,"children":10271},{"class":1062,"line":10270},37,[10272],{"type":49,"tag":1060,"props":10273,"children":10274},{"emptyLinePlaceholder":44},[10275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10277,"children":10279},{"class":1062,"line":10278},38,[10280],{"type":49,"tag":1060,"props":10281,"children":10282},{"style":3039},[10283],{"type":55,"value":10284},"  # save container definitions to a file for each task\n",{"type":49,"tag":1060,"props":10286,"children":10288},{"class":1062,"line":10287},39,[10289,10293,10298,10303,10308,10313],{"type":49,"tag":1060,"props":10290,"children":10291},{"style":9965},[10292],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10294,"children":10295},{"style":1073},[10296],{"type":55,"value":10297}," $TASK_DESCRIPTION ",{"type":49,"tag":1060,"props":10299,"children":10300},{"style":2194},[10301],{"type":55,"value":10302},"|",{"type":49,"tag":1060,"props":10304,"children":10305},{"style":1067},[10306],{"type":55,"value":10307}," jq",{"type":49,"tag":1060,"props":10309,"children":10310},{"style":2287},[10311],{"type":55,"value":10312}," -r",{"type":49,"tag":1060,"props":10314,"children":10315},{"style":2287},[10316],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10318,"children":10320},{"class":1062,"line":10319},40,[10321,10326],{"type":49,"tag":1060,"props":10322,"children":10323},{"style":2215},[10324],{"type":55,"value":10325},"    .taskDefinition.containerDefinitions",{"type":49,"tag":1060,"props":10327,"children":10328},{"style":2287},[10329],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10331,"children":10333},{"class":1062,"line":10332},41,[10334,10339,10344,10349],{"type":49,"tag":1060,"props":10335,"children":10336},{"style":2194},[10337],{"type":55,"value":10338},"    >",{"type":49,"tag":1060,"props":10340,"children":10341},{"style":2215},[10342],{"type":55,"value":10343}," /tmp/",{"type":49,"tag":1060,"props":10345,"children":10346},{"style":1073},[10347],{"type":55,"value":10348},"$TASK_FAMILY",{"type":49,"tag":1060,"props":10350,"children":10351},{"style":2215},[10352],{"type":55,"value":10353},".json\n",{"type":49,"tag":1060,"props":10355,"children":10357},{"class":1062,"line":10356},42,[10358],{"type":49,"tag":1060,"props":10359,"children":10360},{"emptyLinePlaceholder":44},[10361],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10363,"children":10365},{"class":1062,"line":10364},43,[10366],{"type":49,"tag":1060,"props":10367,"children":10368},{"style":3039},[10369],{"type":55,"value":10370},"  # write new container definition JSON with updated image\n",{"type":49,"tag":1060,"props":10372,"children":10374},{"class":1062,"line":10373},44,[10375,10379,10384,10388],{"type":49,"tag":1060,"props":10376,"children":10377},{"style":9965},[10378],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10380,"children":10381},{"style":2215},[10382],{"type":55,"value":10383}," \"Writing new ",{"type":49,"tag":1060,"props":10385,"children":10386},{"style":1073},[10387],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10389,"children":10390},{"style":2215},[10391],{"type":55,"value":10392}," container definitions JSON...\"\n",{"type":49,"tag":1060,"props":10394,"children":10396},{"class":1062,"line":10395},45,[10397],{"type":49,"tag":1060,"props":10398,"children":10399},{"emptyLinePlaceholder":44},[10400],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10402,"children":10404},{"class":1062,"line":10403},46,[10405],{"type":49,"tag":1060,"props":10406,"children":10407},{"style":3039},[10408],{"type":55,"value":10409},"  # replace old image URI with new image URI in a new container definitions JSON\n",{"type":49,"tag":1060,"props":10411,"children":10413},{"class":1062,"line":10412},47,[10414,10419,10423,10427,10432],{"type":49,"tag":1060,"props":10415,"children":10416},{"style":1067},[10417],{"type":55,"value":10418},"  cat",{"type":49,"tag":1060,"props":10420,"children":10421},{"style":2215},[10422],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10424,"children":10425},{"style":1073},[10426],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10428,"children":10429},{"style":2215},[10430],{"type":55,"value":10431},".json",{"type":49,"tag":1060,"props":10433,"children":10434},{"style":2287},[10435],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10437,"children":10439},{"class":1062,"line":10438},48,[10440,10445,10449],{"type":49,"tag":1060,"props":10441,"children":10442},{"style":2194},[10443],{"type":55,"value":10444},"    |",{"type":49,"tag":1060,"props":10446,"children":10447},{"style":1067},[10448],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10450,"children":10451},{"style":2287},[10452],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10454,"children":10456},{"class":1062,"line":10455},49,[10457,10462,10467,10472,10477,10481,10486],{"type":49,"tag":1060,"props":10458,"children":10459},{"style":2287},[10460],{"type":55,"value":10461},"    --arg",{"type":49,"tag":1060,"props":10463,"children":10464},{"style":2215},[10465],{"type":55,"value":10466}," IMAGE",{"type":49,"tag":1060,"props":10468,"children":10469},{"style":2215},[10470],{"type":55,"value":10471}," \"",{"type":49,"tag":1060,"props":10473,"children":10474},{"style":1073},[10475],{"type":55,"value":10476},"$NEW_BACKEND_IMAGE_URI",{"type":49,"tag":1060,"props":10478,"children":10479},{"style":2215},[10480],{"type":55,"value":10005},{"type":49,"tag":1060,"props":10482,"children":10483},{"style":2215},[10484],{"type":55,"value":10485}," '.[0].image |= $IMAGE'",{"type":49,"tag":1060,"props":10487,"children":10488},{"style":2287},[10489],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10491,"children":10493},{"class":1062,"line":10492},50,[10494,10498,10502,10506],{"type":49,"tag":1060,"props":10495,"children":10496},{"style":2194},[10497],{"type":55,"value":10338},{"type":49,"tag":1060,"props":10499,"children":10500},{"style":2215},[10501],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10503,"children":10504},{"style":1073},[10505],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10507,"children":10508},{"style":2215},[10509],{"type":55,"value":10510},"-new.json\n",{"type":49,"tag":1060,"props":10512,"children":10514},{"class":1062,"line":10513},51,[10515],{"type":49,"tag":1060,"props":10516,"children":10517},{"emptyLinePlaceholder":44},[10518],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10520,"children":10522},{"class":1062,"line":10521},52,[10523],{"type":49,"tag":1060,"props":10524,"children":10525},{"style":3039},[10526],{"type":55,"value":10527},"  # Get the existing configuration for the task definition (memory, cpu, etc.)\n",{"type":49,"tag":1060,"props":10529,"children":10531},{"class":1062,"line":10530},53,[10532],{"type":49,"tag":1060,"props":10533,"children":10534},{"style":3039},[10535],{"type":55,"value":10536},"  # from the variable that we saved the task definition JSON to earlier\n",{"type":49,"tag":1060,"props":10538,"children":10540},{"class":1062,"line":10539},54,[10541,10545,10550,10554],{"type":49,"tag":1060,"props":10542,"children":10543},{"style":9965},[10544],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10546,"children":10547},{"style":2215},[10548],{"type":55,"value":10549}," \"Getting existing configuration for ",{"type":49,"tag":1060,"props":10551,"children":10552},{"style":1073},[10553],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10555,"children":10556},{"style":2215},[10557],{"type":55,"value":10558},"...\"\n",{"type":49,"tag":1060,"props":10560,"children":10562},{"class":1062,"line":10561},55,[10563],{"type":49,"tag":1060,"props":10564,"children":10565},{"emptyLinePlaceholder":44},[10566],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10568,"children":10570},{"class":1062,"line":10569},56,[10571,10576,10580,10585,10589,10593,10597,10601,10605],{"type":49,"tag":1060,"props":10572,"children":10573},{"style":1073},[10574],{"type":55,"value":10575},"  MEMORY",{"type":49,"tag":1060,"props":10577,"children":10578},{"style":2194},[10579],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10581,"children":10582},{"style":1073},[10583],{"type":55,"value":10584},"$( ",{"type":49,"tag":1060,"props":10586,"children":10587},{"style":9965},[10588],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10590,"children":10591},{"style":1073},[10592],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10594,"children":10595},{"style":2194},[10596],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10598,"children":10599},{"style":1067},[10600],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10602,"children":10603},{"style":2287},[10604],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10606,"children":10607},{"style":2287},[10608],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10610,"children":10612},{"class":1062,"line":10611},57,[10613,10618],{"type":49,"tag":1060,"props":10614,"children":10615},{"style":2215},[10616],{"type":55,"value":10617},"    .taskDefinition.memory",{"type":49,"tag":1060,"props":10619,"children":10620},{"style":2287},[10621],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10623,"children":10625},{"class":1062,"line":10624},58,[10626],{"type":49,"tag":1060,"props":10627,"children":10628},{"style":1073},[10629],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10631,"children":10633},{"class":1062,"line":10632},59,[10634],{"type":49,"tag":1060,"props":10635,"children":10636},{"emptyLinePlaceholder":44},[10637],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10639,"children":10641},{"class":1062,"line":10640},60,[10642,10647,10651,10655,10659,10663,10667,10671,10675],{"type":49,"tag":1060,"props":10643,"children":10644},{"style":1073},[10645],{"type":55,"value":10646},"  CPU",{"type":49,"tag":1060,"props":10648,"children":10649},{"style":2194},[10650],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10652,"children":10653},{"style":1073},[10654],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10656,"children":10657},{"style":9965},[10658],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10660,"children":10661},{"style":1073},[10662],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10664,"children":10665},{"style":2194},[10666],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10668,"children":10669},{"style":1067},[10670],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10672,"children":10673},{"style":2287},[10674],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10676,"children":10677},{"style":2287},[10678],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10680,"children":10682},{"class":1062,"line":10681},61,[10683,10688],{"type":49,"tag":1060,"props":10684,"children":10685},{"style":2215},[10686],{"type":55,"value":10687},"    .taskDefinition.cpu",{"type":49,"tag":1060,"props":10689,"children":10690},{"style":2287},[10691],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10693,"children":10695},{"class":1062,"line":10694},62,[10696],{"type":49,"tag":1060,"props":10697,"children":10698},{"style":1073},[10699],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10701,"children":10703},{"class":1062,"line":10702},63,[10704],{"type":49,"tag":1060,"props":10705,"children":10706},{"emptyLinePlaceholder":44},[10707],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10709,"children":10711},{"class":1062,"line":10710},64,[10712,10717,10721,10725,10729,10733,10737,10741,10745],{"type":49,"tag":1060,"props":10713,"children":10714},{"style":1073},[10715],{"type":55,"value":10716},"  ECS_EXECUTION_ROLE_ARN",{"type":49,"tag":1060,"props":10718,"children":10719},{"style":2194},[10720],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10722,"children":10723},{"style":1073},[10724],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10726,"children":10727},{"style":9965},[10728],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10730,"children":10731},{"style":1073},[10732],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10734,"children":10735},{"style":2194},[10736],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10738,"children":10739},{"style":1067},[10740],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10742,"children":10743},{"style":2287},[10744],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10746,"children":10747},{"style":2287},[10748],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10750,"children":10752},{"class":1062,"line":10751},65,[10753,10758],{"type":49,"tag":1060,"props":10754,"children":10755},{"style":2215},[10756],{"type":55,"value":10757},"    .taskDefinition.executionRoleArn",{"type":49,"tag":1060,"props":10759,"children":10760},{"style":2287},[10761],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10763,"children":10765},{"class":1062,"line":10764},66,[10766],{"type":49,"tag":1060,"props":10767,"children":10768},{"style":1073},[10769],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10771,"children":10773},{"class":1062,"line":10772},67,[10774],{"type":49,"tag":1060,"props":10775,"children":10776},{"emptyLinePlaceholder":44},[10777],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10779,"children":10781},{"class":1062,"line":10780},68,[10782,10787,10791,10795,10799,10803,10807,10811,10815],{"type":49,"tag":1060,"props":10783,"children":10784},{"style":1073},[10785],{"type":55,"value":10786},"  ECS_TASK_ROLE_ARN",{"type":49,"tag":1060,"props":10788,"children":10789},{"style":2194},[10790],{"type":55,"value":3068},{"type":49,"tag":1060,"props":10792,"children":10793},{"style":1073},[10794],{"type":55,"value":10584},{"type":49,"tag":1060,"props":10796,"children":10797},{"style":9965},[10798],{"type":55,"value":9968},{"type":49,"tag":1060,"props":10800,"children":10801},{"style":1073},[10802],{"type":55,"value":10297},{"type":49,"tag":1060,"props":10804,"children":10805},{"style":2194},[10806],{"type":55,"value":10302},{"type":49,"tag":1060,"props":10808,"children":10809},{"style":1067},[10810],{"type":55,"value":10307},{"type":49,"tag":1060,"props":10812,"children":10813},{"style":2287},[10814],{"type":55,"value":10312},{"type":49,"tag":1060,"props":10816,"children":10817},{"style":2287},[10818],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10820,"children":10822},{"class":1062,"line":10821},69,[10823,10828],{"type":49,"tag":1060,"props":10824,"children":10825},{"style":2215},[10826],{"type":55,"value":10827},"    .taskDefinition.taskRoleArn",{"type":49,"tag":1060,"props":10829,"children":10830},{"style":2287},[10831],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10833,"children":10835},{"class":1062,"line":10834},70,[10836],{"type":49,"tag":1060,"props":10837,"children":10838},{"style":1073},[10839],{"type":55,"value":10267},{"type":49,"tag":1060,"props":10841,"children":10843},{"class":1062,"line":10842},71,[10844],{"type":49,"tag":1060,"props":10845,"children":10846},{"emptyLinePlaceholder":44},[10847],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10849,"children":10851},{"class":1062,"line":10850},72,[10852],{"type":49,"tag":1060,"props":10853,"children":10854},{"style":3039},[10855],{"type":55,"value":10856},"  # check the content of the new container definition JSON\n",{"type":49,"tag":1060,"props":10858,"children":10860},{"class":1062,"line":10859},73,[10861,10865,10869,10873],{"type":49,"tag":1060,"props":10862,"children":10863},{"style":1067},[10864],{"type":55,"value":10418},{"type":49,"tag":1060,"props":10866,"children":10867},{"style":2215},[10868],{"type":55,"value":10343},{"type":49,"tag":1060,"props":10870,"children":10871},{"style":1073},[10872],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10874,"children":10875},{"style":2215},[10876],{"type":55,"value":10510},{"type":49,"tag":1060,"props":10878,"children":10880},{"class":1062,"line":10879},74,[10881],{"type":49,"tag":1060,"props":10882,"children":10883},{"emptyLinePlaceholder":44},[10884],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10886,"children":10888},{"class":1062,"line":10887},75,[10889],{"type":49,"tag":1060,"props":10890,"children":10891},{"style":3039},[10892],{"type":55,"value":10893},"  # register new task definition using the new container definitions\n",{"type":49,"tag":1060,"props":10895,"children":10897},{"class":1062,"line":10896},76,[10898],{"type":49,"tag":1060,"props":10899,"children":10900},{"style":3039},[10901],{"type":55,"value":10902},"  # and the values that we read off of the existing task definitions\n",{"type":49,"tag":1060,"props":10904,"children":10906},{"class":1062,"line":10905},77,[10907,10911,10916,10920],{"type":49,"tag":1060,"props":10908,"children":10909},{"style":9965},[10910],{"type":55,"value":10109},{"type":49,"tag":1060,"props":10912,"children":10913},{"style":2215},[10914],{"type":55,"value":10915}," \"Registering new ",{"type":49,"tag":1060,"props":10917,"children":10918},{"style":1073},[10919],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10921,"children":10922},{"style":2215},[10923],{"type":55,"value":10124},{"type":49,"tag":1060,"props":10925,"children":10927},{"class":1062,"line":10926},78,[10928],{"type":49,"tag":1060,"props":10929,"children":10930},{"emptyLinePlaceholder":44},[10931],{"type":55,"value":1094},{"type":49,"tag":1060,"props":10933,"children":10935},{"class":1062,"line":10934},79,[10936,10941,10945,10950],{"type":49,"tag":1060,"props":10937,"children":10938},{"style":1067},[10939],{"type":55,"value":10940},"  aws",{"type":49,"tag":1060,"props":10942,"children":10943},{"style":2215},[10944],{"type":55,"value":10229},{"type":49,"tag":1060,"props":10946,"children":10947},{"style":2215},[10948],{"type":55,"value":10949}," register-task-definition",{"type":49,"tag":1060,"props":10951,"children":10952},{"style":2287},[10953],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10955,"children":10957},{"class":1062,"line":10956},80,[10958,10963,10967],{"type":49,"tag":1060,"props":10959,"children":10960},{"style":2287},[10961],{"type":55,"value":10962},"    --family",{"type":49,"tag":1060,"props":10964,"children":10965},{"style":1073},[10966],{"type":55,"value":10253},{"type":49,"tag":1060,"props":10968,"children":10969},{"style":2287},[10970],{"type":55,"value":10258},{"type":49,"tag":1060,"props":10972,"children":10974},{"class":1062,"line":10973},81,[10975,10980,10985,10989,10994],{"type":49,"tag":1060,"props":10976,"children":10977},{"style":2287},[10978],{"type":55,"value":10979},"    --container-definitions",{"type":49,"tag":1060,"props":10981,"children":10982},{"style":2215},[10983],{"type":55,"value":10984}," file:///tmp/",{"type":49,"tag":1060,"props":10986,"children":10987},{"style":1073},[10988],{"type":55,"value":10348},{"type":49,"tag":1060,"props":10990,"children":10991},{"style":2215},[10992],{"type":55,"value":10993},"-new.json",{"type":49,"tag":1060,"props":10995,"children":10996},{"style":2287},[10997],{"type":55,"value":10239},{"type":49,"tag":1060,"props":10999,"children":11001},{"class":1062,"line":11000},82,[11002,11007,11012],{"type":49,"tag":1060,"props":11003,"children":11004},{"style":2287},[11005],{"type":55,"value":11006},"    --memory",{"type":49,"tag":1060,"props":11008,"children":11009},{"style":1073},[11010],{"type":55,"value":11011}," $MEMORY ",{"type":49,"tag":1060,"props":11013,"children":11014},{"style":2287},[11015],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11017,"children":11019},{"class":1062,"line":11018},83,[11020,11025,11030],{"type":49,"tag":1060,"props":11021,"children":11022},{"style":2287},[11023],{"type":55,"value":11024},"    --cpu",{"type":49,"tag":1060,"props":11026,"children":11027},{"style":1073},[11028],{"type":55,"value":11029}," $CPU ",{"type":49,"tag":1060,"props":11031,"children":11032},{"style":2287},[11033],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11035,"children":11037},{"class":1062,"line":11036},84,[11038,11043,11048],{"type":49,"tag":1060,"props":11039,"children":11040},{"style":2287},[11041],{"type":55,"value":11042},"    --network-mode",{"type":49,"tag":1060,"props":11044,"children":11045},{"style":2215},[11046],{"type":55,"value":11047}," awsvpc",{"type":49,"tag":1060,"props":11049,"children":11050},{"style":2287},[11051],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11053,"children":11055},{"class":1062,"line":11054},85,[11056,11061,11066],{"type":49,"tag":1060,"props":11057,"children":11058},{"style":2287},[11059],{"type":55,"value":11060},"    --execution-role-arn",{"type":49,"tag":1060,"props":11062,"children":11063},{"style":1073},[11064],{"type":55,"value":11065}," $ECS_EXECUTION_ROLE_ARN ",{"type":49,"tag":1060,"props":11067,"children":11068},{"style":2287},[11069],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11071,"children":11073},{"class":1062,"line":11072},86,[11074,11079,11084],{"type":49,"tag":1060,"props":11075,"children":11076},{"style":2287},[11077],{"type":55,"value":11078},"    --task-role-arn",{"type":49,"tag":1060,"props":11080,"children":11081},{"style":1073},[11082],{"type":55,"value":11083}," $ECS_TASK_ROLE_ARN ",{"type":49,"tag":1060,"props":11085,"children":11086},{"style":2287},[11087],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11089,"children":11091},{"class":1062,"line":11090},87,[11092,11097],{"type":49,"tag":1060,"props":11093,"children":11094},{"style":2287},[11095],{"type":55,"value":11096},"    --requires-compatibilities",{"type":49,"tag":1060,"props":11098,"children":11099},{"style":2215},[11100],{"type":55,"value":11101}," \"FARGATE\"\n",{"type":49,"tag":1060,"props":11103,"children":11105},{"class":1062,"line":11104},88,[11106],{"type":49,"tag":1060,"props":11107,"children":11108},{"emptyLinePlaceholder":44},[11109],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11111,"children":11113},{"class":1062,"line":11112},89,[11114],{"type":49,"tag":1060,"props":11115,"children":11116},{"style":2194},[11117],{"type":55,"value":11118},"done\n",{"type":49,"tag":1060,"props":11120,"children":11122},{"class":1062,"line":11121},90,[11123],{"type":49,"tag":1060,"props":11124,"children":11125},{"emptyLinePlaceholder":44},[11126],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11128,"children":11130},{"class":1062,"line":11129},91,[11131],{"type":49,"tag":1060,"props":11132,"children":11133},{"style":3039},[11134],{"type":55,"value":11135},"# Now we need to run migrate, collectstatic and any other commands that need to be run\n",{"type":49,"tag":1060,"props":11137,"children":11139},{"class":1062,"line":11138},92,[11140],{"type":49,"tag":1060,"props":11141,"children":11142},{"style":3039},[11143],{"type":55,"value":11144},"# before doing a rolling update of the backend services\n",{"type":49,"tag":1060,"props":11146,"children":11148},{"class":1062,"line":11147},93,[11149],{"type":49,"tag":1060,"props":11150,"children":11151},{"emptyLinePlaceholder":44},[11152],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11154,"children":11156},{"class":1062,"line":11155},94,[11157],{"type":49,"tag":1060,"props":11158,"children":11159},{"style":3039},[11160],{"type":55,"value":11161},"# We will use the new task definitions we just created to run these commands\n",{"type":49,"tag":1060,"props":11163,"children":11165},{"class":1062,"line":11164},95,[11166],{"type":49,"tag":1060,"props":11167,"children":11168},{"emptyLinePlaceholder":44},[11169],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11171,"children":11173},{"class":1062,"line":11172},96,[11174],{"type":49,"tag":1060,"props":11175,"children":11176},{"style":3039},[11177],{"type":55,"value":11178},"# get the ARN of the most recent revision of the migrate task definition\n",{"type":49,"tag":1060,"props":11180,"children":11182},{"class":1062,"line":11181},97,[11183,11188,11192,11196],{"type":49,"tag":1060,"props":11184,"children":11185},{"style":1073},[11186],{"type":55,"value":11187},"TASK_DEFINITION",{"type":49,"tag":1060,"props":11189,"children":11190},{"style":2194},[11191],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11193,"children":11194},{"style":1073},[11195],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11197,"children":11198},{"style":2287},[11199],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11201,"children":11203},{"class":1062,"line":11202},98,[11204,11208,11212,11216],{"type":49,"tag":1060,"props":11205,"children":11206},{"style":1067},[11207],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11209,"children":11210},{"style":2215},[11211],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11213,"children":11214},{"style":2215},[11215],{"type":55,"value":10234},{"type":49,"tag":1060,"props":11217,"children":11218},{"style":2287},[11219],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11221,"children":11223},{"class":1062,"line":11222},99,[11224,11228,11233,11238],{"type":49,"tag":1060,"props":11225,"children":11226},{"style":2287},[11227],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11229,"children":11230},{"style":1073},[11231],{"type":55,"value":11232}," $WORKSPACE",{"type":49,"tag":1060,"props":11234,"children":11235},{"style":2215},[11236],{"type":55,"value":11237},"-migrate",{"type":49,"tag":1060,"props":11239,"children":11240},{"style":2287},[11241],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11243,"children":11245},{"class":1062,"line":11244},100,[11246,11250,11254,11258],{"type":49,"tag":1060,"props":11247,"children":11248},{"style":2194},[11249],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11251,"children":11252},{"style":1067},[11253],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11255,"children":11256},{"style":2287},[11257],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11259,"children":11260},{"style":2287},[11261],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11263,"children":11265},{"class":1062,"line":11264},101,[11266,11271],{"type":49,"tag":1060,"props":11267,"children":11268},{"style":2215},[11269],{"type":55,"value":11270},"    .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":11272,"children":11273},{"style":2287},[11274],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11276,"children":11278},{"class":1062,"line":11277},102,[11279],{"type":49,"tag":1060,"props":11280,"children":11281},{"style":1073},[11282],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11284,"children":11286},{"class":1062,"line":11285},103,[11287],{"type":49,"tag":1060,"props":11288,"children":11289},{"emptyLinePlaceholder":44},[11290],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11292,"children":11294},{"class":1062,"line":11293},104,[11295],{"type":49,"tag":1060,"props":11296,"children":11297},{"style":3039},[11298],{"type":55,"value":11299},"# get private subnets as space separated string from shared resources VPC\n",{"type":49,"tag":1060,"props":11301,"children":11303},{"class":1062,"line":11302},105,[11304,11309,11313,11317],{"type":49,"tag":1060,"props":11305,"children":11306},{"style":1073},[11307],{"type":55,"value":11308},"SUBNETS",{"type":49,"tag":1060,"props":11310,"children":11311},{"style":2194},[11312],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11314,"children":11315},{"style":1073},[11316],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11318,"children":11319},{"style":2287},[11320],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11322,"children":11324},{"class":1062,"line":11323},106,[11325,11329,11334,11339],{"type":49,"tag":1060,"props":11326,"children":11327},{"style":1067},[11328],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11330,"children":11331},{"style":2215},[11332],{"type":55,"value":11333}," ec2",{"type":49,"tag":1060,"props":11335,"children":11336},{"style":2215},[11337],{"type":55,"value":11338}," describe-subnets",{"type":49,"tag":1060,"props":11340,"children":11341},{"style":2287},[11342],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11344,"children":11346},{"class":1062,"line":11345},107,[11347,11352,11357,11362,11366,11371],{"type":49,"tag":1060,"props":11348,"children":11349},{"style":2287},[11350],{"type":55,"value":11351},"    --filters",{"type":49,"tag":1060,"props":11353,"children":11354},{"style":2215},[11355],{"type":55,"value":11356}," \"Name=tag:env,Values=",{"type":49,"tag":1060,"props":11358,"children":11359},{"style":1073},[11360],{"type":55,"value":11361},"$SHARED_RESOURCES_WORKSPACE",{"type":49,"tag":1060,"props":11363,"children":11364},{"style":2215},[11365],{"type":55,"value":10005},{"type":49,"tag":1060,"props":11367,"children":11368},{"style":2215},[11369],{"type":55,"value":11370}," \"Name=tag:Name,Values=*private*\"",{"type":49,"tag":1060,"props":11372,"children":11373},{"style":2287},[11374],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11376,"children":11378},{"class":1062,"line":11377},108,[11379,11384,11389],{"type":49,"tag":1060,"props":11380,"children":11381},{"style":2287},[11382],{"type":55,"value":11383},"    --query",{"type":49,"tag":1060,"props":11385,"children":11386},{"style":2215},[11387],{"type":55,"value":11388}," 'Subnets[*].SubnetId'",{"type":49,"tag":1060,"props":11390,"children":11391},{"style":2287},[11392],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11394,"children":11396},{"class":1062,"line":11395},109,[11397,11402,11407],{"type":49,"tag":1060,"props":11398,"children":11399},{"style":2287},[11400],{"type":55,"value":11401},"    --output",{"type":49,"tag":1060,"props":11403,"children":11404},{"style":2215},[11405],{"type":55,"value":11406}," text",{"type":49,"tag":1060,"props":11408,"children":11409},{"style":2287},[11410],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11412,"children":11414},{"class":1062,"line":11413},110,[11415],{"type":49,"tag":1060,"props":11416,"children":11417},{"style":1073},[11418],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11420,"children":11422},{"class":1062,"line":11421},111,[11423],{"type":49,"tag":1060,"props":11424,"children":11425},{"emptyLinePlaceholder":44},[11426],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11428,"children":11430},{"class":1062,"line":11429},112,[11431],{"type":49,"tag":1060,"props":11432,"children":11433},{"style":3039},[11434],{"type":55,"value":11435},"# replace spaces with commas using tr\n",{"type":49,"tag":1060,"props":11437,"children":11439},{"class":1062,"line":11438},113,[11440,11445,11449,11453,11457,11462,11466,11471,11476,11481],{"type":49,"tag":1060,"props":11441,"children":11442},{"style":1073},[11443],{"type":55,"value":11444},"SUBNET_IDS",{"type":49,"tag":1060,"props":11446,"children":11447},{"style":2194},[11448],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11450,"children":11451},{"style":1073},[11452],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11454,"children":11455},{"style":9965},[11456],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11458,"children":11459},{"style":1073},[11460],{"type":55,"value":11461}," $SUBNETS ",{"type":49,"tag":1060,"props":11463,"children":11464},{"style":2194},[11465],{"type":55,"value":10302},{"type":49,"tag":1060,"props":11467,"children":11468},{"style":1067},[11469],{"type":55,"value":11470}," tr",{"type":49,"tag":1060,"props":11472,"children":11473},{"style":2215},[11474],{"type":55,"value":11475}," ' '",{"type":49,"tag":1060,"props":11477,"children":11478},{"style":2215},[11479],{"type":55,"value":11480}," ','",{"type":49,"tag":1060,"props":11482,"children":11483},{"style":1073},[11484],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11486,"children":11488},{"class":1062,"line":11487},114,[11489],{"type":49,"tag":1060,"props":11490,"children":11491},{"emptyLinePlaceholder":44},[11492],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11494,"children":11496},{"class":1062,"line":11495},115,[11497],{"type":49,"tag":1060,"props":11498,"children":11499},{"style":3039},[11500],{"type":55,"value":11501},"# https://github.com/aws/aws-cli/issues/5348\n",{"type":49,"tag":1060,"props":11503,"children":11505},{"class":1062,"line":11504},116,[11506],{"type":49,"tag":1060,"props":11507,"children":11508},{"style":3039},[11509],{"type":55,"value":11510},"# get ecs_sg_id - just a single value\n",{"type":49,"tag":1060,"props":11512,"children":11514},{"class":1062,"line":11513},117,[11515,11520,11524,11528],{"type":49,"tag":1060,"props":11516,"children":11517},{"style":1073},[11518],{"type":55,"value":11519},"ECS_SG_ID",{"type":49,"tag":1060,"props":11521,"children":11522},{"style":2194},[11523],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11525,"children":11526},{"style":1073},[11527],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11529,"children":11530},{"style":2287},[11531],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11533,"children":11535},{"class":1062,"line":11534},118,[11536,11540,11544,11549],{"type":49,"tag":1060,"props":11537,"children":11538},{"style":1067},[11539],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11541,"children":11542},{"style":2215},[11543],{"type":55,"value":11333},{"type":49,"tag":1060,"props":11545,"children":11546},{"style":2215},[11547],{"type":55,"value":11548}," describe-security-groups",{"type":49,"tag":1060,"props":11550,"children":11551},{"style":2287},[11552],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11554,"children":11556},{"class":1062,"line":11555},119,[11557,11561,11566,11570,11575],{"type":49,"tag":1060,"props":11558,"children":11559},{"style":2287},[11560],{"type":55,"value":11351},{"type":49,"tag":1060,"props":11562,"children":11563},{"style":2215},[11564],{"type":55,"value":11565}," \"Name=tag:Name,Values=",{"type":49,"tag":1060,"props":11567,"children":11568},{"style":1073},[11569],{"type":55,"value":11361},{"type":49,"tag":1060,"props":11571,"children":11572},{"style":2215},[11573],{"type":55,"value":11574},"-ecs-sg\"",{"type":49,"tag":1060,"props":11576,"children":11577},{"style":2287},[11578],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11580,"children":11582},{"class":1062,"line":11581},120,[11583,11587,11592],{"type":49,"tag":1060,"props":11584,"children":11585},{"style":2287},[11586],{"type":55,"value":11383},{"type":49,"tag":1060,"props":11588,"children":11589},{"style":2215},[11590],{"type":55,"value":11591}," 'SecurityGroups[*].GroupId'",{"type":49,"tag":1060,"props":11593,"children":11594},{"style":2287},[11595],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11597,"children":11599},{"class":1062,"line":11598},121,[11600,11604,11608],{"type":49,"tag":1060,"props":11601,"children":11602},{"style":2287},[11603],{"type":55,"value":11401},{"type":49,"tag":1060,"props":11605,"children":11606},{"style":2215},[11607],{"type":55,"value":11406},{"type":49,"tag":1060,"props":11609,"children":11610},{"style":2287},[11611],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11613,"children":11615},{"class":1062,"line":11614},122,[11616],{"type":49,"tag":1060,"props":11617,"children":11618},{"style":1073},[11619],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11621,"children":11623},{"class":1062,"line":11622},123,[11624],{"type":49,"tag":1060,"props":11625,"children":11626},{"emptyLinePlaceholder":44},[11627],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11629,"children":11631},{"class":1062,"line":11630},124,[11632,11636],{"type":49,"tag":1060,"props":11633,"children":11634},{"style":9965},[11635],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11637,"children":11638},{"style":2215},[11639],{"type":55,"value":11640}," \"Running database migrations...\"\n",{"type":49,"tag":1060,"props":11642,"children":11644},{"class":1062,"line":11643},125,[11645],{"type":49,"tag":1060,"props":11646,"children":11647},{"emptyLinePlaceholder":44},[11648],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11650,"children":11652},{"class":1062,"line":11651},126,[11653],{"type":49,"tag":1060,"props":11654,"children":11655},{"style":3039},[11656],{"type":55,"value":11657},"# timestamp used for log retrieval (milliseconds after Jan 1, 1970 00:00:00 UTC)\n",{"type":49,"tag":1060,"props":11659,"children":11661},{"class":1062,"line":11660},127,[11662,11667,11671,11675,11680,11685],{"type":49,"tag":1060,"props":11663,"children":11664},{"style":1073},[11665],{"type":55,"value":11666},"START_TIME",{"type":49,"tag":1060,"props":11668,"children":11669},{"style":2194},[11670],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11672,"children":11673},{"style":1073},[11674],{"type":55,"value":10220},{"type":49,"tag":1060,"props":11676,"children":11677},{"style":1067},[11678],{"type":55,"value":11679},"date",{"type":49,"tag":1060,"props":11681,"children":11682},{"style":2215},[11683],{"type":55,"value":11684}," +%s000",{"type":49,"tag":1060,"props":11686,"children":11687},{"style":1073},[11688],{"type":55,"value":5126},{"type":49,"tag":1060,"props":11690,"children":11692},{"class":1062,"line":11691},128,[11693],{"type":49,"tag":1060,"props":11694,"children":11695},{"emptyLinePlaceholder":44},[11696],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11698,"children":11700},{"class":1062,"line":11699},129,[11701],{"type":49,"tag":1060,"props":11702,"children":11703},{"style":3039},[11704],{"type":55,"value":11705},"# run the migration task and capture the taskArn into a variable called TASK_ID\n",{"type":49,"tag":1060,"props":11707,"children":11709},{"class":1062,"line":11708},130,[11710,11715,11719,11723],{"type":49,"tag":1060,"props":11711,"children":11712},{"style":1073},[11713],{"type":55,"value":11714},"TASK_ID",{"type":49,"tag":1060,"props":11716,"children":11717},{"style":2194},[11718],{"type":55,"value":3068},{"type":49,"tag":1060,"props":11720,"children":11721},{"style":1073},[11722],{"type":55,"value":10584},{"type":49,"tag":1060,"props":11724,"children":11725},{"style":2287},[11726],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11728,"children":11730},{"class":1062,"line":11729},131,[11731,11735,11739,11744],{"type":49,"tag":1060,"props":11732,"children":11733},{"style":1067},[11734],{"type":55,"value":10940},{"type":49,"tag":1060,"props":11736,"children":11737},{"style":2215},[11738],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11740,"children":11741},{"style":2215},[11742],{"type":55,"value":11743}," run-task",{"type":49,"tag":1060,"props":11745,"children":11746},{"style":2287},[11747],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11749,"children":11751},{"class":1062,"line":11750},132,[11752,11757,11761,11766],{"type":49,"tag":1060,"props":11753,"children":11754},{"style":2287},[11755],{"type":55,"value":11756},"    --cluster",{"type":49,"tag":1060,"props":11758,"children":11759},{"style":1073},[11760],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11762,"children":11763},{"style":2215},[11764],{"type":55,"value":11765},"-cluster",{"type":49,"tag":1060,"props":11767,"children":11768},{"style":2287},[11769],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11771,"children":11773},{"class":1062,"line":11772},133,[11774,11778,11783],{"type":49,"tag":1060,"props":11775,"children":11776},{"style":2287},[11777],{"type":55,"value":10248},{"type":49,"tag":1060,"props":11779,"children":11780},{"style":1073},[11781],{"type":55,"value":11782}," $TASK_DEFINITION ",{"type":49,"tag":1060,"props":11784,"children":11785},{"style":2287},[11786],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11788,"children":11790},{"class":1062,"line":11789},134,[11791,11796,11801,11806,11810,11815,11820],{"type":49,"tag":1060,"props":11792,"children":11793},{"style":2287},[11794],{"type":55,"value":11795},"    --network-configuration",{"type":49,"tag":1060,"props":11797,"children":11798},{"style":2215},[11799],{"type":55,"value":11800}," \"awsvpcConfiguration={subnets=[",{"type":49,"tag":1060,"props":11802,"children":11803},{"style":1073},[11804],{"type":55,"value":11805},"$SUBNET_IDS",{"type":49,"tag":1060,"props":11807,"children":11808},{"style":2215},[11809],{"type":55,"value":3620},{"type":49,"tag":1060,"props":11811,"children":11812},{"style":1073},[11813],{"type":55,"value":11814},"$ECS_SG_ID",{"type":49,"tag":1060,"props":11816,"children":11817},{"style":2215},[11818],{"type":55,"value":11819},"],assignPublicIp=ENABLED}\"",{"type":49,"tag":1060,"props":11821,"children":11822},{"style":2287},[11823],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11825,"children":11827},{"class":1062,"line":11826},135,[11828,11832,11836,11840,11845],{"type":49,"tag":1060,"props":11829,"children":11830},{"style":2194},[11831],{"type":55,"value":10444},{"type":49,"tag":1060,"props":11833,"children":11834},{"style":1067},[11835],{"type":55,"value":10307},{"type":49,"tag":1060,"props":11837,"children":11838},{"style":2287},[11839],{"type":55,"value":10312},{"type":49,"tag":1060,"props":11841,"children":11842},{"style":2215},[11843],{"type":55,"value":11844}," '.tasks[0].taskArn'",{"type":49,"tag":1060,"props":11846,"children":11847},{"style":2287},[11848],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11850,"children":11852},{"class":1062,"line":11851},136,[11853],{"type":49,"tag":1060,"props":11854,"children":11855},{"style":1073},[11856],{"type":55,"value":10267},{"type":49,"tag":1060,"props":11858,"children":11860},{"class":1062,"line":11859},137,[11861],{"type":49,"tag":1060,"props":11862,"children":11863},{"emptyLinePlaceholder":44},[11864],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11866,"children":11868},{"class":1062,"line":11867},138,[11869,11873,11878,11883],{"type":49,"tag":1060,"props":11870,"children":11871},{"style":9965},[11872],{"type":55,"value":9968},{"type":49,"tag":1060,"props":11874,"children":11875},{"style":2215},[11876],{"type":55,"value":11877}," \"Task ID is ",{"type":49,"tag":1060,"props":11879,"children":11880},{"style":1073},[11881],{"type":55,"value":11882},"$TASK_ID",{"type":49,"tag":1060,"props":11884,"children":11885},{"style":2215},[11886],{"type":55,"value":10025},{"type":49,"tag":1060,"props":11888,"children":11890},{"class":1062,"line":11889},139,[11891],{"type":49,"tag":1060,"props":11892,"children":11893},{"emptyLinePlaceholder":44},[11894],{"type":55,"value":1094},{"type":49,"tag":1060,"props":11896,"children":11898},{"class":1062,"line":11897},140,[11899],{"type":49,"tag":1060,"props":11900,"children":11901},{"style":3039},[11902],{"type":55,"value":11903},"# wait for the migrate task to exit\n",{"type":49,"tag":1060,"props":11905,"children":11907},{"class":1062,"line":11906},141,[11908],{"type":49,"tag":1060,"props":11909,"children":11910},{"style":3039},[11911],{"type":55,"value":11912},"# https://docs.aws.amazon.com/cli/latest/reference/ecs/wait/tasks-stopped.html#description\n",{"type":49,"tag":1060,"props":11914,"children":11916},{"class":1062,"line":11915},142,[11917],{"type":49,"tag":1060,"props":11918,"children":11919},{"style":3039},[11920],{"type":55,"value":11921},"# > It will poll every 6 seconds until a successful state has been reached.\n",{"type":49,"tag":1060,"props":11923,"children":11925},{"class":1062,"line":11924},143,[11926],{"type":49,"tag":1060,"props":11927,"children":11928},{"style":3039},[11929],{"type":55,"value":11930},"# > This will exit with a return code of 255 after 100 failed checks.\n",{"type":49,"tag":1060,"props":11932,"children":11934},{"class":1062,"line":11933},144,[11935,11939,11943,11948,11953],{"type":49,"tag":1060,"props":11936,"children":11937},{"style":1067},[11938],{"type":55,"value":20},{"type":49,"tag":1060,"props":11940,"children":11941},{"style":2215},[11942],{"type":55,"value":10229},{"type":49,"tag":1060,"props":11944,"children":11945},{"style":2215},[11946],{"type":55,"value":11947}," wait",{"type":49,"tag":1060,"props":11949,"children":11950},{"style":2215},[11951],{"type":55,"value":11952}," tasks-stopped",{"type":49,"tag":1060,"props":11954,"children":11955},{"style":2287},[11956],{"type":55,"value":10239},{"type":49,"tag":1060,"props":11958,"children":11960},{"class":1062,"line":11959},145,[11961,11966,11971],{"type":49,"tag":1060,"props":11962,"children":11963},{"style":2287},[11964],{"type":55,"value":11965},"  --tasks",{"type":49,"tag":1060,"props":11967,"children":11968},{"style":1073},[11969],{"type":55,"value":11970}," $TASK_ID ",{"type":49,"tag":1060,"props":11972,"children":11973},{"style":2287},[11974],{"type":55,"value":10258},{"type":49,"tag":1060,"props":11976,"children":11978},{"class":1062,"line":11977},146,[11979,11984,11988],{"type":49,"tag":1060,"props":11980,"children":11981},{"style":2287},[11982],{"type":55,"value":11983},"  --cluster",{"type":49,"tag":1060,"props":11985,"children":11986},{"style":1073},[11987],{"type":55,"value":11232},{"type":49,"tag":1060,"props":11989,"children":11990},{"style":2215},[11991],{"type":55,"value":11992},"-cluster\n",{"type":49,"tag":1060,"props":11994,"children":11996},{"class":1062,"line":11995},147,[11997],{"type":49,"tag":1060,"props":11998,"children":11999},{"emptyLinePlaceholder":44},[12000],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12002,"children":12004},{"class":1062,"line":12003},148,[12005],{"type":49,"tag":1060,"props":12006,"children":12007},{"style":3039},[12008],{"type":55,"value":11657},{"type":49,"tag":1060,"props":12010,"children":12012},{"class":1062,"line":12011},149,[12013,12018,12022,12026,12030,12034],{"type":49,"tag":1060,"props":12014,"children":12015},{"style":1073},[12016],{"type":55,"value":12017},"END_TIME",{"type":49,"tag":1060,"props":12019,"children":12020},{"style":2194},[12021],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12023,"children":12024},{"style":1073},[12025],{"type":55,"value":10220},{"type":49,"tag":1060,"props":12027,"children":12028},{"style":1067},[12029],{"type":55,"value":11679},{"type":49,"tag":1060,"props":12031,"children":12032},{"style":2215},[12033],{"type":55,"value":11684},{"type":49,"tag":1060,"props":12035,"children":12036},{"style":1073},[12037],{"type":55,"value":5126},{"type":49,"tag":1060,"props":12039,"children":12041},{"class":1062,"line":12040},150,[12042],{"type":49,"tag":1060,"props":12043,"children":12044},{"emptyLinePlaceholder":44},[12045],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12047,"children":12049},{"class":1062,"line":12048},151,[12050],{"type":49,"tag":1060,"props":12051,"children":12052},{"style":3039},[12053],{"type":55,"value":12054},"# print the CloudWatch log events to STDOUT\n",{"type":49,"tag":1060,"props":12056,"children":12058},{"class":1062,"line":12057},152,[12059,12063,12068,12073],{"type":49,"tag":1060,"props":12060,"children":12061},{"style":1067},[12062],{"type":55,"value":20},{"type":49,"tag":1060,"props":12064,"children":12065},{"style":2215},[12066],{"type":55,"value":12067}," logs",{"type":49,"tag":1060,"props":12069,"children":12070},{"style":2215},[12071],{"type":55,"value":12072}," get-log-events",{"type":49,"tag":1060,"props":12074,"children":12075},{"style":2287},[12076],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12078,"children":12080},{"class":1062,"line":12079},153,[12081,12086,12091,12095,12100],{"type":49,"tag":1060,"props":12082,"children":12083},{"style":2287},[12084],{"type":55,"value":12085},"  --log-group-name",{"type":49,"tag":1060,"props":12087,"children":12088},{"style":2215},[12089],{"type":55,"value":12090}," \"/ecs/",{"type":49,"tag":1060,"props":12092,"children":12093},{"style":1073},[12094],{"type":55,"value":10175},{"type":49,"tag":1060,"props":12096,"children":12097},{"style":2215},[12098],{"type":55,"value":12099},"/migrate\"",{"type":49,"tag":1060,"props":12101,"children":12102},{"style":2287},[12103],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12105,"children":12107},{"class":1062,"line":12106},154,[12108,12113,12118,12122,12127,12132],{"type":49,"tag":1060,"props":12109,"children":12110},{"style":2287},[12111],{"type":55,"value":12112},"  --log-stream-name",{"type":49,"tag":1060,"props":12114,"children":12115},{"style":2215},[12116],{"type":55,"value":12117}," \"migrate/migrate/${",{"type":49,"tag":1060,"props":12119,"children":12120},{"style":1073},[12121],{"type":55,"value":11714},{"type":49,"tag":1060,"props":12123,"children":12124},{"style":2194},[12125],{"type":55,"value":12126},"##*/",{"type":49,"tag":1060,"props":12128,"children":12129},{"style":2215},[12130],{"type":55,"value":12131},"}\"",{"type":49,"tag":1060,"props":12133,"children":12134},{"style":2287},[12135],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12137,"children":12139},{"class":1062,"line":12138},155,[12140,12145,12150],{"type":49,"tag":1060,"props":12141,"children":12142},{"style":2287},[12143],{"type":55,"value":12144},"  --start-time",{"type":49,"tag":1060,"props":12146,"children":12147},{"style":1073},[12148],{"type":55,"value":12149}," $START_TIME ",{"type":49,"tag":1060,"props":12151,"children":12152},{"style":2287},[12153],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12155,"children":12157},{"class":1062,"line":12156},156,[12158,12163,12168],{"type":49,"tag":1060,"props":12159,"children":12160},{"style":2287},[12161],{"type":55,"value":12162},"  --end-time",{"type":49,"tag":1060,"props":12164,"children":12165},{"style":1073},[12166],{"type":55,"value":12167}," $END_TIME ",{"type":49,"tag":1060,"props":12169,"children":12170},{"style":2287},[12171],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12173,"children":12175},{"class":1062,"line":12174},157,[12176,12181,12185,12189],{"type":49,"tag":1060,"props":12177,"children":12178},{"style":2194},[12179],{"type":55,"value":12180},"  |",{"type":49,"tag":1060,"props":12182,"children":12183},{"style":1067},[12184],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12186,"children":12187},{"style":2287},[12188],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12190,"children":12191},{"style":2215},[12192],{"type":55,"value":12193}," '.events[].message'\n",{"type":49,"tag":1060,"props":12195,"children":12197},{"class":1062,"line":12196},158,[12198],{"type":49,"tag":1060,"props":12199,"children":12200},{"emptyLinePlaceholder":44},[12201],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12203,"children":12205},{"class":1062,"line":12204},159,[12206,12210],{"type":49,"tag":1060,"props":12207,"children":12208},{"style":9965},[12209],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12211,"children":12212},{"style":2215},[12213],{"type":55,"value":12214}," \"Migrations complete. Starting rolling update for backend services...\"\n",{"type":49,"tag":1060,"props":12216,"children":12218},{"class":1062,"line":12217},160,[12219],{"type":49,"tag":1060,"props":12220,"children":12221},{"emptyLinePlaceholder":44},[12222],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12224,"children":12226},{"class":1062,"line":12225},161,[12227],{"type":49,"tag":1060,"props":12228,"children":12229},{"style":3039},[12230],{"type":55,"value":12231},"# update backend services\n",{"type":49,"tag":1060,"props":12233,"children":12235},{"class":1062,"line":12234},162,[12236,12240,12244,12248,12252,12256],{"type":49,"tag":1060,"props":12237,"children":12238},{"style":2194},[12239],{"type":55,"value":10063},{"type":49,"tag":1060,"props":12241,"children":12242},{"style":1073},[12243],{"type":55,"value":10068},{"type":49,"tag":1060,"props":12245,"children":12246},{"style":2194},[12247],{"type":55,"value":10073},{"type":49,"tag":1060,"props":12249,"children":12250},{"style":2215},[12251],{"type":55,"value":10083},{"type":49,"tag":1060,"props":12253,"children":12254},{"style":2215},[12255],{"type":55,"value":10088},{"type":49,"tag":1060,"props":12257,"children":12258},{"style":2215},[12259],{"type":55,"value":10093},{"type":49,"tag":1060,"props":12261,"children":12263},{"class":1062,"line":12262},163,[12264],{"type":49,"tag":1060,"props":12265,"children":12266},{"style":2194},[12267],{"type":55,"value":10101},{"type":49,"tag":1060,"props":12269,"children":12271},{"class":1062,"line":12270},164,[12272],{"type":49,"tag":1060,"props":12273,"children":12274},{"emptyLinePlaceholder":44},[12275],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12277,"children":12279},{"class":1062,"line":12278},165,[12280],{"type":49,"tag":1060,"props":12281,"children":12282},{"style":3039},[12283],{"type":55,"value":12284},"  # get taskDefinitionArn for each service to be used in update-service command\n",{"type":49,"tag":1060,"props":12286,"children":12288},{"class":1062,"line":12287},166,[12289],{"type":49,"tag":1060,"props":12290,"children":12291},{"style":3039},[12292],{"type":55,"value":12293},"  # this will get the most recent revision of each task (the one that was just created)\n",{"type":49,"tag":1060,"props":12295,"children":12297},{"class":1062,"line":12296},167,[12298],{"type":49,"tag":1060,"props":12299,"children":12300},{"style":3039},[12301],{"type":55,"value":12302},"  # https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html#description\n",{"type":49,"tag":1060,"props":12304,"children":12306},{"class":1062,"line":12305},168,[12307,12312,12316,12320],{"type":49,"tag":1060,"props":12308,"children":12309},{"style":1073},[12310],{"type":55,"value":12311},"  TASK_DEFINITION",{"type":49,"tag":1060,"props":12313,"children":12314},{"style":2194},[12315],{"type":55,"value":3068},{"type":49,"tag":1060,"props":12317,"children":12318},{"style":1073},[12319],{"type":55,"value":10584},{"type":49,"tag":1060,"props":12321,"children":12322},{"style":2287},[12323],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12325,"children":12327},{"class":1062,"line":12326},169,[12328,12333,12337,12341],{"type":49,"tag":1060,"props":12329,"children":12330},{"style":1067},[12331],{"type":55,"value":12332},"    aws",{"type":49,"tag":1060,"props":12334,"children":12335},{"style":2215},[12336],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12338,"children":12339},{"style":2215},[12340],{"type":55,"value":10234},{"type":49,"tag":1060,"props":12342,"children":12343},{"style":2287},[12344],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12346,"children":12348},{"class":1062,"line":12347},170,[12349,12354,12358,12362,12367],{"type":49,"tag":1060,"props":12350,"children":12351},{"style":2287},[12352],{"type":55,"value":12353},"      --task-definition",{"type":49,"tag":1060,"props":12355,"children":12356},{"style":1073},[12357],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12359,"children":12360},{"style":2215},[12361],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12363,"children":12364},{"style":1073},[12365],{"type":55,"value":12366},"$TASK ",{"type":49,"tag":1060,"props":12368,"children":12369},{"style":2287},[12370],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12372,"children":12374},{"class":1062,"line":12373},171,[12375,12380,12384,12388],{"type":49,"tag":1060,"props":12376,"children":12377},{"style":2194},[12378],{"type":55,"value":12379},"      |",{"type":49,"tag":1060,"props":12381,"children":12382},{"style":1067},[12383],{"type":55,"value":10307},{"type":49,"tag":1060,"props":12385,"children":12386},{"style":2287},[12387],{"type":55,"value":10312},{"type":49,"tag":1060,"props":12389,"children":12390},{"style":2287},[12391],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12393,"children":12395},{"class":1062,"line":12394},172,[12396,12401],{"type":49,"tag":1060,"props":12397,"children":12398},{"style":2215},[12399],{"type":55,"value":12400},"      .taskDefinition.taskDefinitionArn",{"type":49,"tag":1060,"props":12402,"children":12403},{"style":2287},[12404],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12406,"children":12408},{"class":1062,"line":12407},173,[12409],{"type":49,"tag":1060,"props":12410,"children":12411},{"style":1073},[12412],{"type":55,"value":10267},{"type":49,"tag":1060,"props":12414,"children":12416},{"class":1062,"line":12415},174,[12417],{"type":49,"tag":1060,"props":12418,"children":12419},{"emptyLinePlaceholder":44},[12420],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12422,"children":12424},{"class":1062,"line":12423},175,[12425],{"type":49,"tag":1060,"props":12426,"children":12427},{"style":3039},[12428],{"type":55,"value":12429},"  # update each service with new task definintion\n",{"type":49,"tag":1060,"props":12431,"children":12433},{"class":1062,"line":12432},176,[12434,12438,12442,12447],{"type":49,"tag":1060,"props":12435,"children":12436},{"style":1067},[12437],{"type":55,"value":10940},{"type":49,"tag":1060,"props":12439,"children":12440},{"style":2215},[12441],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12443,"children":12444},{"style":2215},[12445],{"type":55,"value":12446}," update-service",{"type":49,"tag":1060,"props":12448,"children":12449},{"style":2287},[12450],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12452,"children":12454},{"class":1062,"line":12453},177,[12455,12459,12463,12467],{"type":49,"tag":1060,"props":12456,"children":12457},{"style":2287},[12458],{"type":55,"value":11756},{"type":49,"tag":1060,"props":12460,"children":12461},{"style":1073},[12462],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12464,"children":12465},{"style":2215},[12466],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12468,"children":12469},{"style":2287},[12470],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12472,"children":12474},{"class":1062,"line":12473},178,[12475,12480,12484,12488,12492],{"type":49,"tag":1060,"props":12476,"children":12477},{"style":2287},[12478],{"type":55,"value":12479},"    --service",{"type":49,"tag":1060,"props":12481,"children":12482},{"style":1073},[12483],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12485,"children":12486},{"style":2215},[12487],{"type":55,"value":10180},{"type":49,"tag":1060,"props":12489,"children":12490},{"style":1073},[12491],{"type":55,"value":12366},{"type":49,"tag":1060,"props":12493,"children":12494},{"style":2287},[12495],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12497,"children":12499},{"class":1062,"line":12498},179,[12500,12504,12508],{"type":49,"tag":1060,"props":12501,"children":12502},{"style":2287},[12503],{"type":55,"value":10248},{"type":49,"tag":1060,"props":12505,"children":12506},{"style":1073},[12507],{"type":55,"value":11782},{"type":49,"tag":1060,"props":12509,"children":12510},{"style":2287},[12511],{"type":55,"value":10258},{"type":49,"tag":1060,"props":12513,"children":12515},{"class":1062,"line":12514},180,[12516],{"type":49,"tag":1060,"props":12517,"children":12518},{"style":2287},[12519],{"type":55,"value":12520},"    --no-cli-pager\n",{"type":49,"tag":1060,"props":12522,"children":12524},{"class":1062,"line":12523},181,[12525],{"type":49,"tag":1060,"props":12526,"children":12527},{"emptyLinePlaceholder":44},[12528],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12530,"children":12532},{"class":1062,"line":12531},182,[12533],{"type":49,"tag":1060,"props":12534,"children":12535},{"style":2194},[12536],{"type":55,"value":11118},{"type":49,"tag":1060,"props":12538,"children":12540},{"class":1062,"line":12539},183,[12541],{"type":49,"tag":1060,"props":12542,"children":12543},{"emptyLinePlaceholder":44},[12544],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12546,"children":12548},{"class":1062,"line":12547},184,[12549,12553],{"type":49,"tag":1060,"props":12550,"children":12551},{"style":9965},[12552],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12554,"children":12555},{"style":2215},[12556],{"type":55,"value":12557}," \"Services updated. Waiting for services to become stable...\"\n",{"type":49,"tag":1060,"props":12559,"children":12561},{"class":1062,"line":12560},185,[12562],{"type":49,"tag":1060,"props":12563,"children":12564},{"emptyLinePlaceholder":44},[12565],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12567,"children":12569},{"class":1062,"line":12568},186,[12570],{"type":49,"tag":1060,"props":12571,"children":12572},{"style":3039},[12573],{"type":55,"value":12574},"# wait for all service to be stable (runningCount == desiredCount for each service)\n",{"type":49,"tag":1060,"props":12576,"children":12578},{"class":1062,"line":12577},187,[12579,12583,12587,12591,12596],{"type":49,"tag":1060,"props":12580,"children":12581},{"style":1067},[12582],{"type":55,"value":20},{"type":49,"tag":1060,"props":12584,"children":12585},{"style":2215},[12586],{"type":55,"value":10229},{"type":49,"tag":1060,"props":12588,"children":12589},{"style":2215},[12590],{"type":55,"value":11947},{"type":49,"tag":1060,"props":12592,"children":12593},{"style":2215},[12594],{"type":55,"value":12595}," services-stable",{"type":49,"tag":1060,"props":12597,"children":12598},{"style":2287},[12599],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12601,"children":12603},{"class":1062,"line":12602},188,[12604,12608,12612,12616],{"type":49,"tag":1060,"props":12605,"children":12606},{"style":2287},[12607],{"type":55,"value":11983},{"type":49,"tag":1060,"props":12609,"children":12610},{"style":1073},[12611],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12613,"children":12614},{"style":2215},[12615],{"type":55,"value":11765},{"type":49,"tag":1060,"props":12617,"children":12618},{"style":2287},[12619],{"type":55,"value":10239},{"type":49,"tag":1060,"props":12621,"children":12623},{"class":1062,"line":12622},189,[12624,12629,12633,12638,12642,12647,12651],{"type":49,"tag":1060,"props":12625,"children":12626},{"style":2287},[12627],{"type":55,"value":12628},"  --services",{"type":49,"tag":1060,"props":12630,"children":12631},{"style":1073},[12632],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12634,"children":12635},{"style":2215},[12636],{"type":55,"value":12637},"-gunicorn",{"type":49,"tag":1060,"props":12639,"children":12640},{"style":1073},[12641],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12643,"children":12644},{"style":2215},[12645],{"type":55,"value":12646},"-default",{"type":49,"tag":1060,"props":12648,"children":12649},{"style":1073},[12650],{"type":55,"value":11232},{"type":49,"tag":1060,"props":12652,"children":12653},{"style":2215},[12654],{"type":55,"value":12655},"-beat\n",{"type":49,"tag":1060,"props":12657,"children":12659},{"class":1062,"line":12658},190,[12660],{"type":49,"tag":1060,"props":12661,"children":12662},{"emptyLinePlaceholder":44},[12663],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12665,"children":12667},{"class":1062,"line":12666},191,[12668,12672,12677,12681],{"type":49,"tag":1060,"props":12669,"children":12670},{"style":9965},[12671],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12673,"children":12674},{"style":2215},[12675],{"type":55,"value":12676}," \"Services are now stable. Backend services are now up to date with ",{"type":49,"tag":1060,"props":12678,"children":12679},{"style":1073},[12680],{"type":55,"value":10020},{"type":49,"tag":1060,"props":12682,"children":12683},{"style":2215},[12684],{"type":55,"value":12685},".\"\n",{"type":49,"tag":1060,"props":12687,"children":12689},{"class":1062,"line":12688},192,[12690],{"type":49,"tag":1060,"props":12691,"children":12692},{"emptyLinePlaceholder":44},[12693],{"type":55,"value":1094},{"type":49,"tag":1060,"props":12695,"children":12697},{"class":1062,"line":12696},193,[12698,12702],{"type":49,"tag":1060,"props":12699,"children":12700},{"style":9965},[12701],{"type":55,"value":9968},{"type":49,"tag":1060,"props":12703,"children":12704},{"style":2215},[12705],{"type":55,"value":12706}," \"Backend update is now complete!\"\n",{"type":49,"tag":58,"props":12708,"children":12709},{},[12710,12712,12718,12720,12725],{"type":55,"value":12711},"With this GitHub Actions workflow, a developer can now easily change the version of backend code that is running in their ad hoc environments without needing to involve Terraform. Using the ",{"type":49,"tag":326,"props":12713,"children":12715},{"className":12714},[],[12716],{"type":55,"value":12717},"ad_hoc_backend_update.yml",{"type":55,"value":12719}," GitHub Actions workflow, a developer only needs to enter the name of the workspace and the version of the backend code they want to use. The workflow will then run the ",{"type":49,"tag":326,"props":12721,"children":12723},{"className":12722},[],[12724],{"type":55,"value":3323},{"type":55,"value":12726}," task and update the backend services.",{"type":49,"tag":430,"props":12728,"children":12730},{"id":12729},"using-ignore_changes-in-the-definitions",[12731,12733,12739],{"type":55,"value":12732},"Using ",{"type":49,"tag":326,"props":12734,"children":12736},{"className":12735},[],[12737],{"type":55,"value":12738},"ignore_changes",{"type":55,"value":12740}," in the definitions",{"type":49,"tag":58,"props":12742,"children":12743},{},[12744,12746,12751,12753,12759,12761,12767,12769,12781,12783,12788,12790,12795],{"type":55,"value":12745},"There is one more important point to make about Terraform before we conclude this discussion on updating backend code for existing ad hoc environments. Consider the scenario where a developer has launched an ad hoc environment with backend version ",{"type":49,"tag":326,"props":12747,"children":12749},{"className":12748},[],[12750],{"type":55,"value":9562},{"type":55,"value":12752},". They make a small change to the backend code and push version ",{"type":49,"tag":326,"props":12754,"children":12756},{"className":12755},[],[12757],{"type":55,"value":12758},"v1.0.1",{"type":55,"value":12760},". Next, the developer remembers that a backend environment variable needs to be changed. This can be done by updating their ",{"type":49,"tag":326,"props":12762,"children":12764},{"className":12763},[],[12765],{"type":55,"value":12766},"*.tfvars",{"type":55,"value":12768}," file. If they now re-run the ad hoc environment update pipeline ",{"type":49,"tag":72,"props":12770,"children":12771},{},[12772,12774,12779],{"type":55,"value":12773},"without also updating the backend version in their ",{"type":49,"tag":326,"props":12775,"children":12777},{"className":12776},[],[12778],{"type":55,"value":12766},{"type":55,"value":12780}," file",{"type":55,"value":12782},", then their code will be reverted from ",{"type":49,"tag":326,"props":12784,"children":12786},{"className":12785},[],[12787],{"type":55,"value":12758},{"type":55,"value":12789}," to ",{"type":49,"tag":326,"props":12791,"children":12793},{"className":12792},[],[12794],{"type":55,"value":9562},{"type":55,"value":12796},". We would need to coordinate version changes between updating the backend with the pipelines that use Terraform commands and the pipelines that use the AWS CLI commands.",{"type":49,"tag":58,"props":12798,"children":12799},{},[12800,12802,12808,12810,12820,12822,12828,12830,12835,12837,12842,12844,12849,12851,12856],{"type":55,"value":12801},"There is a setting on the ",{"type":49,"tag":326,"props":12803,"children":12805},{"className":12804},[],[12806],{"type":55,"value":12807},"aws_ecs_service",{"type":55,"value":12809}," resource in Terraform we can can use to prevent this from happening. This setting is called ",{"type":49,"tag":80,"props":12811,"children":12814},{"href":12812,"rel":12813},"https://www.terraform.io/language/meta-arguments/lifecycle",[84],[12815],{"type":49,"tag":326,"props":12816,"children":12818},{"className":12817},[],[12819],{"type":55,"value":12738},{"type":55,"value":12821}," and is defined under the resource's ",{"type":49,"tag":326,"props":12823,"children":12825},{"className":12824},[],[12826],{"type":55,"value":12827},"lifecycle",{"type":55,"value":12829}," configuration block. With this setting, when we update the ",{"type":49,"tag":326,"props":12831,"children":12833},{"className":12832},[],[12834],{"type":55,"value":12766},{"type":55,"value":12836}," file with our new environment variable value, we will create another recent task definition with the same ",{"type":49,"tag":326,"props":12838,"children":12840},{"className":12839},[],[12841],{"type":55,"value":9562},{"type":55,"value":12843}," image, but the ECS service will not update in response to this change (that's what the ",{"type":49,"tag":326,"props":12845,"children":12847},{"className":12846},[],[12848],{"type":55,"value":12738},{"type":55,"value":12850}," is for). Once we make the ",{"type":49,"tag":326,"props":12852,"children":12854},{"className":12853},[],[12855],{"type":55,"value":12766},{"type":55,"value":12857}," file update and redeploy using the Terraform pipeline, nothing on our ad hoc changes, but we did get a new task definitions defined in our AWS account for each backend service. When we go to make the backend update with the pipeline that uses AWS CLI commands, the most recent task revision is used to create the new task definition, so it will include the environment variable change that we added earlier.",{"type":49,"tag":430,"props":12859,"children":12861},{"id":12860},"frontend-updates",[12862],{"type":55,"value":12863},"Frontend updates",{"type":49,"tag":58,"props":12865,"children":12866},{},[12867,12869,12874],{"type":55,"value":12868},"The process described above is needed for updating the backend application. Updating the frontend application involves a similar process to the backend update. The main difference is that no task (such as the ",{"type":49,"tag":326,"props":12870,"children":12872},{"className":12871},[],[12873],{"type":55,"value":3323},{"type":55,"value":12875}," command on the backend) needs to run before the service is updated. Here's an overview of the frontend update process:",{"type":49,"tag":64,"props":12877,"children":12878},{},[12879,12890,12901,12912,12923],{"type":49,"tag":68,"props":12880,"children":12881},{},[12882,12884,12889],{"type":55,"value":12883},"fetch the container definition JSON for the frontend tasks (",{"type":49,"tag":326,"props":12885,"children":12887},{"className":12886},[],[12888],{"type":55,"value":9743},{"type":55,"value":616},{"type":49,"tag":68,"props":12891,"children":12892},{},[12893,12895,12900],{"type":55,"value":12894},"write new container definition JSON with the new frontend image tag (using ",{"type":49,"tag":326,"props":12896,"children":12898},{"className":12897},[],[12899],{"type":55,"value":9755},{"type":55,"value":616},{"type":49,"tag":68,"props":12902,"children":12903},{},[12904,12906,12911],{"type":55,"value":12905},"register new task definitions with the new container definition JSON file for the frontend task (",{"type":49,"tag":326,"props":12907,"children":12909},{"className":12908},[],[12910],{"type":55,"value":9767},{"type":55,"value":616},{"type":49,"tag":68,"props":12913,"children":12914},{},[12915,12917,12922],{"type":55,"value":12916},"update the frontend service (",{"type":49,"tag":326,"props":12918,"children":12920},{"className":12919},[],[12921],{"type":55,"value":9802},{"type":55,"value":616},{"type":49,"tag":68,"props":12924,"children":12925},{},[12926,12927,12932],{"type":55,"value":9808},{"type":49,"tag":326,"props":12928,"children":12930},{"className":12929},[],[12931],{"type":55,"value":9814},{"type":55,"value":616},{"type":49,"tag":50,"props":12934,"children":12936},{"id":12935},"setting-up-everything-from-a-new-aws-account-and-github-actions",[12937],{"type":55,"value":12938},"Setting up everything from a new AWS account and GitHub Actions",{"type":49,"tag":58,"props":12940,"children":12941},{},[12942],{"type":55,"value":12943},"Here's a quick overview of initial setup steps that are needed in order to use the automation defined in the GitHub Actions for ad hoc environments.",{"type":49,"tag":430,"props":12945,"children":12947},{"id":12946},"configure-aws-credentials-locally",[12948],{"type":55,"value":12949},"Configure AWS credentials locally",{"type":49,"tag":58,"props":12951,"children":12952},{},[12953],{"type":55,"value":12954},"There is one Terraform command that we will run on our local machine to setup a remote backend for storing our Terraform state. In order to run this, we need to configure AWS credentials locally.",{"type":49,"tag":430,"props":12956,"children":12958},{"id":12957},"run-the-make-tf-bootstrap-command",[12959,12961,12967],{"type":55,"value":12960},"Run the ",{"type":49,"tag":326,"props":12962,"children":12964},{"className":12963},[],[12965],{"type":55,"value":12966},"make tf-bootstrap",{"type":55,"value":12968}," command",{"type":49,"tag":58,"props":12970,"children":12971},{},[12972,12974,12980],{"type":55,"value":12973},"This command will setup an S3 bucket and DynamoDB table for storing Terraform state. Running this command will also require that a ",{"type":49,"tag":326,"props":12975,"children":12977},{"className":12976},[],[12978],{"type":55,"value":12979},"bootstrap.tfvars",{"type":55,"value":12981}," file has been created from the template. This will define the AWS region and name to be used for creating resources.",{"type":49,"tag":430,"props":12983,"children":12985},{"id":12984},"build-and-push-a-backend-and-frontend-image",[12986],{"type":55,"value":12987},"Build and push a backend and frontend image",{"type":49,"tag":58,"props":12989,"children":12990},{},[12991,12992,12998,13000,13006,13007,13013],{"type":55,"value":413},{"type":49,"tag":326,"props":12993,"children":12995},{"className":12994},[],[12996],{"type":55,"value":12997},"tf-bootstrap",{"type":55,"value":12999}," command also creates ECR repositories for the backend and frontend images. We can use the ",{"type":49,"tag":326,"props":13001,"children":13003},{"className":13002},[],[13004],{"type":55,"value":13005},"ecr_backend.yml",{"type":55,"value":715},{"type":49,"tag":326,"props":13008,"children":13010},{"className":13009},[],[13011],{"type":55,"value":13012},"ecr_frontend.yml",{"type":55,"value":13014}," GitHub Actions workflows to build and push the backend and frontend images to the ECR repositories. These pipelines accept a single parameter which is a git tag that must exist in the repo. This git tag will then be used as the image tag for the backend and frontend images.",{"type":49,"tag":430,"props":13016,"children":13018},{"id":13017},"purchase-a-domain-name-in-route-53",[13019],{"type":55,"value":13020},"Purchase a domain name in Route 53",{"type":49,"tag":58,"props":13022,"children":13023},{},[13024],{"type":55,"value":13025},"I use Route 53 to manage DNS records, and have purchased a domain name that I use for testing and debugging in this and other projects.",{"type":49,"tag":430,"props":13027,"children":13029},{"id":13028},"create-a-wildcard-acm-certificate",[13030],{"type":55,"value":13031},"Create a wildcard ACM certificate",{"type":49,"tag":58,"props":13033,"children":13034},{},[13035],{"type":55,"value":13036},"I chose to create this certificate outside of Terraform and import it via ARN. We need a wildcard certificate so that multiple ad hoc environments can be hosted on subdomains of the same domain.",{"type":49,"tag":430,"props":13038,"children":13040},{"id":13039},"create-a-new-ec2-key-pair",[13041],{"type":55,"value":13042},"Create a new EC2 key pair",{"type":49,"tag":58,"props":13044,"children":13045},{},[13046],{"type":55,"value":13047},"The key pair should be created manually and it needs to be added to GitHub repository secrets so that it can be used in the ad hoc environment pipelines.",{"type":49,"tag":430,"props":13049,"children":13051},{"id":13050},"add-secrets-to-github",[13052],{"type":55,"value":13053},"Add secrets to GitHub",{"type":49,"tag":58,"props":13055,"children":13056},{},[13057],{"type":55,"value":13058},"The following secrets are needed for GitHub Actions to run. Add these as repository secrets:",{"type":49,"tag":64,"props":13060,"children":13061},{},[13062,13073,13084,13095,13113,13124,13135,13146,13157,13168,13179],{"type":49,"tag":68,"props":13063,"children":13064},{},[13065,13071],{"type":49,"tag":326,"props":13066,"children":13068},{"className":13067},[],[13069],{"type":55,"value":13070},"ACM_CERTIFICATE_ARN",{"type":55,"value":13072}," - ARN of the wildcard ACM certificate",{"type":49,"tag":68,"props":13074,"children":13075},{},[13076,13082],{"type":49,"tag":326,"props":13077,"children":13079},{"className":13078},[],[13080],{"type":55,"value":13081},"AWS_ACCESS_KEY_ID",{"type":55,"value":13083}," - AWS access key ID",{"type":49,"tag":68,"props":13085,"children":13086},{},[13087,13093],{"type":49,"tag":326,"props":13088,"children":13090},{"className":13089},[],[13091],{"type":55,"value":13092},"AWS_ACCOUNT_ID",{"type":55,"value":13094}," - AWS account ID",{"type":49,"tag":68,"props":13096,"children":13097},{},[13098,13104,13106,13112],{"type":49,"tag":326,"props":13099,"children":13101},{"className":13100},[],[13102],{"type":55,"value":13103},"AWS_DEFAULT_REGION",{"type":55,"value":13105}," - AWS default region (I use ",{"type":49,"tag":326,"props":13107,"children":13109},{"className":13108},[],[13110],{"type":55,"value":13111},"us-east-1",{"type":55,"value":616},{"type":49,"tag":68,"props":13114,"children":13115},{},[13116,13122],{"type":49,"tag":326,"props":13117,"children":13119},{"className":13118},[],[13120],{"type":55,"value":13121},"AWS_SECRET_ACCESS_KEY",{"type":55,"value":13123}," - AWS secret access key",{"type":49,"tag":68,"props":13125,"children":13126},{},[13127,13133],{"type":49,"tag":326,"props":13128,"children":13130},{"className":13129},[],[13131],{"type":55,"value":13132},"DOMAIN_NAME",{"type":55,"value":13134}," - domain name for the ad hoc environment (e.g. example.com)",{"type":49,"tag":68,"props":13136,"children":13137},{},[13138,13144],{"type":49,"tag":326,"props":13139,"children":13141},{"className":13140},[],[13142],{"type":55,"value":13143},"KEY_NAME",{"type":55,"value":13145}," - name of the EC2 key pair",{"type":49,"tag":68,"props":13147,"children":13148},{},[13149,13155],{"type":49,"tag":326,"props":13150,"children":13152},{"className":13151},[],[13153],{"type":55,"value":13154},"SSH_PRIVATE_KEY",{"type":55,"value":13156}," - private key for the EC2 key pair",{"type":49,"tag":68,"props":13158,"children":13159},{},[13160,13166],{"type":49,"tag":326,"props":13161,"children":13163},{"className":13162},[],[13164],{"type":55,"value":13165},"TF_BACKEND_BUCKET",{"type":55,"value":13167}," - name of the S3 bucket used for storing Terraform state",{"type":49,"tag":68,"props":13169,"children":13170},{},[13171,13177],{"type":49,"tag":326,"props":13172,"children":13174},{"className":13173},[],[13175],{"type":55,"value":13176},"TF_BACKEND_DYNAMODB_TABLE",{"type":55,"value":13178}," - name of the DynamoDB table used for locking the Terraform state file",{"type":49,"tag":68,"props":13180,"children":13181},{},[13182,13188],{"type":49,"tag":326,"props":13183,"children":13185},{"className":13184},[],[13186],{"type":55,"value":13187},"TF_BACKEND_REGION",{"type":55,"value":13189}," - AWS region for the S3 bucket and DynamoDB table",{"type":49,"tag":58,"props":13191,"children":13192},{},[13193],{"type":55,"value":13194},"These secrets are referenced in the GitHub Actions workflows.",{"type":49,"tag":430,"props":13196,"children":13198},{"id":13197},"create-shared-resources",[13199],{"type":55,"value":13200},"Create shared resources",{"type":49,"tag":58,"props":13202,"children":13203},{},[13204,13206,13212,13214,13219,13221,13227,13229,13235],{"type":55,"value":13205},"Now that we have GitHub secrets configured, we can run the ",{"type":49,"tag":326,"props":13207,"children":13209},{"className":13208},[],[13210],{"type":55,"value":13211},"shared_resources_create_update.yml",{"type":55,"value":13213}," GitHub Actions workflow. This will create  shared resources environment in which we can build our ad hoc environments. This workflow requires a name (e.g. ",{"type":49,"tag":326,"props":13215,"children":13217},{"className":13216},[],[13218],{"type":55,"value":34},{"type":55,"value":13220},"). This require that we create a ",{"type":49,"tag":326,"props":13222,"children":13224},{"className":13223},[],[13225],{"type":55,"value":13226},"dev.tfvars",{"type":55,"value":13228}," file in ",{"type":49,"tag":326,"props":13230,"children":13232},{"className":13231},[],[13233],{"type":55,"value":13234},"terraform/live/shared-resources",{"type":55,"value":13236}," directory. This usually takes between 5 and 7 minutes to complete since it needs to create an RDS instance which takes a few minutes to provision.",{"type":49,"tag":430,"props":13238,"children":13240},{"id":13239},"create-an-ad-hoc-environment",[13241],{"type":55,"value":13242},"Create an ad hoc environment",{"type":49,"tag":58,"props":13244,"children":13245},{},[13246,13248,13253,13255,13261,13263,13268,13270,13276,13278,13284],{"type":55,"value":13247},"We can now create an ad hoc environment. This requires the name of the shared resources environment (e.g. ",{"type":49,"tag":326,"props":13249,"children":13251},{"className":13250},[],[13252],{"type":55,"value":34},{"type":55,"value":13254},") and the name of the ad hoc environment (e.g. ",{"type":49,"tag":326,"props":13256,"children":13258},{"className":13257},[],[13259],{"type":55,"value":13260},"brian-test",{"type":55,"value":13262},"). The only thing we need to do before creating the ",{"type":49,"tag":326,"props":13264,"children":13266},{"className":13265},[],[13267],{"type":55,"value":13260},{"type":55,"value":13269}," ad hoc environment is to create the ",{"type":49,"tag":326,"props":13271,"children":13273},{"className":13272},[],[13274],{"type":55,"value":13275},"brian-test.tfvars",{"type":55,"value":13277}," file in the ",{"type":49,"tag":326,"props":13279,"children":13281},{"className":13280},[],[13282],{"type":55,"value":13283},"terraform/live/ad-hoc/envs",{"type":55,"value":13285}," directory. This will define the versions of the application and any other environment configuration that is needed. This pipeline usually takes about 3 minutes to finish.",{"type":49,"tag":430,"props":13287,"children":13289},{"id":13288},"update-the-backend-version-in-an-ad-hoc-environment",[13290],{"type":55,"value":13291},"Update the backend version in an ad hoc environment",{"type":49,"tag":58,"props":13293,"children":13294},{},[13295,13297,13302],{"type":55,"value":13296},"Now that the backend is up and running and usable, we can update the backend version used in our ad hoc environment. This can be done by running the ",{"type":49,"tag":326,"props":13298,"children":13300},{"className":13299},[],[13301],{"type":55,"value":12717},{"type":55,"value":13303}," GitHub Actions workflow. To run this workflow you must specify:",{"type":49,"tag":64,"props":13305,"children":13306},{},[13307,13318,13329],{"type":49,"tag":68,"props":13308,"children":13309},{},[13310,13312,13317],{"type":55,"value":13311},"the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13313,"children":13315},{"className":13314},[],[13316],{"type":55,"value":34},{"type":55,"value":616},{"type":49,"tag":68,"props":13319,"children":13320},{},[13321,13323,13328],{"type":55,"value":13322},"the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13324,"children":13326},{"className":13325},[],[13327],{"type":55,"value":13260},{"type":55,"value":616},{"type":49,"tag":68,"props":13330,"children":13331},{},[13332,13334,13340],{"type":55,"value":13333},"the new version of the backend to be used (e.g. ",{"type":49,"tag":326,"props":13335,"children":13337},{"className":13336},[],[13338],{"type":55,"value":13339},"v1.0.2",{"type":55,"value":616},{"type":49,"tag":58,"props":13342,"children":13343},{},[13344,13346,13351],{"type":55,"value":13345},"The backend version should already have been built and pushed to the ECR repository using the ",{"type":49,"tag":326,"props":13347,"children":13349},{"className":13348},[],[13350],{"type":55,"value":13005},{"type":55,"value":13352}," GitHub Actions workflow.",{"type":49,"tag":430,"props":13354,"children":13356},{"id":13355},"use-ecs-exec-to-access-a-django-shell-in-a-running-container",[13357],{"type":55,"value":13358},"Use ECS Exec to access a Django shell in a running container",{"type":49,"tag":58,"props":13360,"children":13361},{},[13362,13364,13370,13372,13377],{"type":55,"value":13363},"Instead of SSHing into the container, we can use the ",{"type":49,"tag":326,"props":13365,"children":13367},{"className":13366},[],[13368],{"type":55,"value":13369},"ecs-exec",{"type":55,"value":13371}," command to access a shell in the container. This is useful for debugging and testing. One of the outputs of the ad hoc environment terraform configuration contains the script needed to run the ",{"type":49,"tag":326,"props":13373,"children":13375},{"className":13374},[],[13376],{"type":55,"value":13369},{"type":55,"value":13378}," command:",{"type":49,"tag":1050,"props":13380,"children":13382},{"code":13381,"language":2728,"meta":8,"className":2729,"style":8},"TASK_ARN=$(aws ecs list-tasks \\\n  --cluster alpha-cluster \\\n  --service-name  alpha-gunicorn | jq -r '.taskArns | .[0]' \\\n)\naws ecs execute-command --cluster alpha-cluster \\\n    --task $TASK_ARN \\\n    --container gunicorn \\\n    --interactive \\\n    --command \"/bin/bash\"\n",[13383],{"type":49,"tag":326,"props":13384,"children":13385},{"__ignoreMap":8},[13386,13419,13435,13470,13477,13506,13523,13540,13552],{"type":49,"tag":1060,"props":13387,"children":13388},{"class":1062,"line":1063},[13389,13394,13398,13402,13406,13410,13415],{"type":49,"tag":1060,"props":13390,"children":13391},{"style":1073},[13392],{"type":55,"value":13393},"TASK_ARN",{"type":49,"tag":1060,"props":13395,"children":13396},{"style":2194},[13397],{"type":55,"value":3068},{"type":49,"tag":1060,"props":13399,"children":13400},{"style":1073},[13401],{"type":55,"value":10220},{"type":49,"tag":1060,"props":13403,"children":13404},{"style":1067},[13405],{"type":55,"value":20},{"type":49,"tag":1060,"props":13407,"children":13408},{"style":2215},[13409],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13411,"children":13412},{"style":2215},[13413],{"type":55,"value":13414}," list-tasks",{"type":49,"tag":1060,"props":13416,"children":13417},{"style":2287},[13418],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13420,"children":13421},{"class":1062,"line":1079},[13422,13426,13431],{"type":49,"tag":1060,"props":13423,"children":13424},{"style":2287},[13425],{"type":55,"value":11983},{"type":49,"tag":1060,"props":13427,"children":13428},{"style":2215},[13429],{"type":55,"value":13430}," alpha-cluster",{"type":49,"tag":1060,"props":13432,"children":13433},{"style":2287},[13434],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13436,"children":13437},{"class":1062,"line":1088},[13438,13443,13448,13453,13457,13461,13466],{"type":49,"tag":1060,"props":13439,"children":13440},{"style":2287},[13441],{"type":55,"value":13442},"  --service-name",{"type":49,"tag":1060,"props":13444,"children":13445},{"style":2215},[13446],{"type":55,"value":13447},"  alpha-gunicorn",{"type":49,"tag":1060,"props":13449,"children":13450},{"style":2194},[13451],{"type":55,"value":13452}," |",{"type":49,"tag":1060,"props":13454,"children":13455},{"style":1067},[13456],{"type":55,"value":10307},{"type":49,"tag":1060,"props":13458,"children":13459},{"style":2287},[13460],{"type":55,"value":10312},{"type":49,"tag":1060,"props":13462,"children":13463},{"style":2215},[13464],{"type":55,"value":13465}," '.taskArns | .[0]'",{"type":49,"tag":1060,"props":13467,"children":13468},{"style":2287},[13469],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13471,"children":13472},{"class":1062,"line":1097},[13473],{"type":49,"tag":1060,"props":13474,"children":13475},{"style":1073},[13476],{"type":55,"value":5126},{"type":49,"tag":1060,"props":13478,"children":13479},{"class":1062,"line":1111},[13480,13484,13488,13493,13498,13502],{"type":49,"tag":1060,"props":13481,"children":13482},{"style":1067},[13483],{"type":55,"value":20},{"type":49,"tag":1060,"props":13485,"children":13486},{"style":2215},[13487],{"type":55,"value":10229},{"type":49,"tag":1060,"props":13489,"children":13490},{"style":2215},[13491],{"type":55,"value":13492}," execute-command",{"type":49,"tag":1060,"props":13494,"children":13495},{"style":2287},[13496],{"type":55,"value":13497}," --cluster",{"type":49,"tag":1060,"props":13499,"children":13500},{"style":2215},[13501],{"type":55,"value":13430},{"type":49,"tag":1060,"props":13503,"children":13504},{"style":2287},[13505],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13507,"children":13508},{"class":1062,"line":1120},[13509,13514,13519],{"type":49,"tag":1060,"props":13510,"children":13511},{"style":2287},[13512],{"type":55,"value":13513},"    --task",{"type":49,"tag":1060,"props":13515,"children":13516},{"style":1073},[13517],{"type":55,"value":13518}," $TASK_ARN ",{"type":49,"tag":1060,"props":13520,"children":13521},{"style":2287},[13522],{"type":55,"value":10258},{"type":49,"tag":1060,"props":13524,"children":13525},{"class":1062,"line":1128},[13526,13531,13536],{"type":49,"tag":1060,"props":13527,"children":13528},{"style":2287},[13529],{"type":55,"value":13530},"    --container",{"type":49,"tag":1060,"props":13532,"children":13533},{"style":2215},[13534],{"type":55,"value":13535}," gunicorn",{"type":49,"tag":1060,"props":13537,"children":13538},{"style":2287},[13539],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13541,"children":13542},{"class":1062,"line":1141},[13543,13548],{"type":49,"tag":1060,"props":13544,"children":13545},{"style":2287},[13546],{"type":55,"value":13547},"    --interactive",{"type":49,"tag":1060,"props":13549,"children":13550},{"style":2287},[13551],{"type":55,"value":10239},{"type":49,"tag":1060,"props":13553,"children":13554},{"class":1062,"line":1150},[13555,13560],{"type":49,"tag":1060,"props":13556,"children":13557},{"style":2287},[13558],{"type":55,"value":13559},"    --command",{"type":49,"tag":1060,"props":13561,"children":13562},{"style":2215},[13563],{"type":55,"value":13564}," \"/bin/bash\"\n",{"type":49,"tag":58,"props":13566,"children":13567},{},[13568],{"type":55,"value":13569},"You will then have a shell in the container:",{"type":49,"tag":1050,"props":13571,"children":13573},{"code":13572},"The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.\n\n\nStarting session with SessionId: ecs-execute-command-073d1947fa71c058c\nroot@ip-10-0-2-167:/code# python manage.py shell\nPython 3.9.9 (main, Dec 21 2021, 10:03:34)\n[GCC 10.2.1 20210110] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n(InteractiveConsole)\n>>>\n",[13574],{"type":49,"tag":326,"props":13575,"children":13576},{"__ignoreMap":8},[13577],{"type":55,"value":13572},{"type":49,"tag":430,"props":13579,"children":13581},{"id":13580},"destroy-an-ad-hoc-environment",[13582],{"type":55,"value":13583},"Destroy an ad hoc environment",{"type":49,"tag":58,"props":13585,"children":13586},{},[13587,13589,13595,13597,13602,13604,13609],{"type":55,"value":13588},"Use the ",{"type":49,"tag":326,"props":13590,"children":13592},{"className":13591},[],[13593],{"type":55,"value":13594},"ad_hoc_env_destroy.yml",{"type":55,"value":13596}," GitHub Actions workflow to destroy an ad hoc environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13598,"children":13600},{"className":13599},[],[13601],{"type":55,"value":34},{"type":55,"value":13603},") and the ad hoc environment name (e.g. ",{"type":49,"tag":326,"props":13605,"children":13607},{"className":13606},[],[13608],{"type":55,"value":13260},{"type":55,"value":3213},{"type":49,"tag":430,"props":13611,"children":13613},{"id":13612},"destroy-the-shared-resources-environment",[13614],{"type":55,"value":13615},"Destroy the shared resources environment",{"type":49,"tag":58,"props":13617,"children":13618},{},[13619,13620,13626,13628,13633],{"type":55,"value":13588},{"type":49,"tag":326,"props":13621,"children":13623},{"className":13622},[],[13624],{"type":55,"value":13625},"shared_resources_destroy.yml",{"type":55,"value":13627}," GitHub Actions workflow to destroy the shared resources environment. To run this workflow you need to specify the shared resource workspace (e.g. ",{"type":49,"tag":326,"props":13629,"children":13631},{"className":13630},[],[13632],{"type":55,"value":34},{"type":55,"value":3213},{"type":49,"tag":58,"props":13635,"children":13636},{},[13637],{"type":55,"value":13638},"This defines the full lifecycle of creating and destroying ad hoc environments.",{"type":49,"tag":50,"props":13640,"children":13642},{"id":13641},"future-improvements-open-questions-and-next-steps",[13643],{"type":55,"value":13644},"Future improvements, open questions and next steps",{"type":49,"tag":430,"props":13646,"children":13648},{"id":13647},"enhanced-security",[13649],{"type":55,"value":13650},"Enhanced Security",{"type":49,"tag":58,"props":13652,"children":13653},{},[13654],{"type":55,"value":13655},"The low hanging fruit here is to use least privilege (for roles used in automation) and to define all roles with IaC. Currently I am using Admin roles for the credentials I store in GitHub which is a shortcut to using IaC and is not a best practice.",{"type":49,"tag":430,"props":13657,"children":13659},{"id":13658},"keeping-track-of-ad-hoc-environments",[13660],{"type":55,"value":13661},"Keeping track of ad hoc environments",{"type":49,"tag":58,"props":13663,"children":13664},{},[13665],{"type":55,"value":13666},"We need to think about how we can keep track of our active ad hoc environments. Active environments will incur additional AWS costs, and we do not want developers or the product team to create lots of environments and then leave them running without actively using them.",{"type":49,"tag":58,"props":13668,"children":13669},{},[13670],{"type":55,"value":13671},"We may decide to have some long-lived ad hoc environments, but those would be managed primarily by the DevOps team and respective owners (e.g. QA, product team, etc.).",{"type":49,"tag":58,"props":13673,"children":13674},{},[13675],{"type":55,"value":13676},"One way to check the active ad hoc environments would be to use the AWS CLI. We could list the ECS clusters in our development account, and this would show the number of ad hoc environments running. We could go farther and list the ad hoc environments by when they were last updated. We could then request developers or team members to remove ad hoc environments that are not in use.",{"type":49,"tag":58,"props":13678,"children":13679},{},[13680],{"type":55,"value":13681},"Or we could have a policy that all ad-hoc environments are deleted automatically at the end of each week.",{"type":49,"tag":430,"props":13683,"children":13685},{"id":13684},"terraform-tooling",[13686],{"type":55,"value":13687},"Terraform Tooling",{"type":49,"tag":64,"props":13689,"children":13690},{},[13691,13696,13701,13706],{"type":49,"tag":68,"props":13692,"children":13693},{},[13694],{"type":55,"value":13695},"Testing Terraform Code",{"type":49,"tag":68,"props":13697,"children":13698},{},[13699],{"type":55,"value":13700},"Testing GitHub Actions",{"type":49,"tag":68,"props":13702,"children":13703},{},[13704],{"type":55,"value":13705},"Using advanced Terraform frameworks like Terragrunt",{"type":49,"tag":68,"props":13707,"children":13708},{},[13709],{"type":55,"value":13710},"Using Terraform Cloud for more advanced Terraform features",{"type":49,"tag":430,"props":13712,"children":13714},{"id":13713},"more-secure-way-of-defining-rds-username-and-password",[13715],{"type":55,"value":13716},"More secure way of defining RDS username and password",{"type":49,"tag":58,"props":13718,"children":13719},{},[13720],{"type":55,"value":13721},"Currently the postgres database does not have a secure password. It is both hardcoded in the module as a default value and it will also be saved in plaintext in the Terraform state file.",{"type":49,"tag":430,"props":13723,"children":13725},{"id":13724},"backend-application-update-script",[13726],{"type":55,"value":13727},"Backend application update script",{"type":49,"tag":58,"props":13729,"children":13730},{},[13731],{"type":55,"value":13732},"The script used for updating the backend application could be improved or broken up into multiple scripts to better handle errors and failures that happen during the pipeline. The script runs several different commands and could potentially fail at any step, so it would be nice to improve the error messages so that both developers and DevOps teams can more quickly diagnose pipeline failures.",{"type":49,"tag":430,"props":13734,"children":13736},{"id":13735},"limiting-traffic-to-ad-hoc-environments-to-a-vpn",[13737],{"type":55,"value":13738},"Limiting traffic to ad hoc environments to a VPN",{"type":49,"tag":58,"props":13740,"children":13741},{},[13742],{"type":55,"value":13743},"Another good next step would be to show how we can limit traffic to ad hoc environments to a VPN.",{"type":49,"tag":430,"props":13745,"children":13747},{"id":13746},"figure-out-how-many-ad-hoc-environments-we-can-create-with-the-default-quotas",[13748],{"type":55,"value":13749},"Figure out how many ad hoc environments we can create with the default quotas",{"type":49,"tag":58,"props":13751,"children":13752},{},[13753],{"type":55,"value":13754},"AWS accounts limit the number of resources you can create, but for most of this quota limits you can request an increase per account. I need to figure out how many ad hoc environments I can create with the default quotas.",{"type":49,"tag":430,"props":13756,"children":13758},{"id":13757},"code-repo-organization",[13759],{"type":55,"value":13760},"Code Repo Organization",{"type":49,"tag":58,"props":13762,"children":13763},{},[13764,13766,13771,13773,13778],{"type":55,"value":13765},"One minor improvement would be to move the ",{"type":49,"tag":326,"props":13767,"children":13769},{"className":13768},[],[13770],{"type":55,"value":16},{"type":55,"value":13772}," directory out of the ",{"type":49,"tag":326,"props":13774,"children":13776},{"className":13775},[],[13777],{"type":55,"value":1627},{"type":55,"value":13779}," monorepo into a dedicated repo. We may also want to move GitHub Actions for creating, updating and destroying environments to this new repo. For early stage development, using a single repository that stores both application code and Terraform configuration works, but it would be better to keep these separate at the repository level as the project grows.",{"type":49,"tag":430,"props":13781,"children":13783},{"id":13782},"multiple-aws-accounts",[13784],{"type":55,"value":13785},"Multiple AWS Accounts",{"type":49,"tag":58,"props":13787,"children":13788},{},[13789],{"type":55,"value":13790},"Everything shown here uses a single AWS account: ECR images, Terraform remote state storage, all shared resource environments and all ad hoc environments. Using one account keeps things simple for a demonstration of this workflow, but in practice it would be beneficial to use multiple AWS accounts for different purposes. This would also involve more carefully planned IAM roles for cross-account resource access.",{"type":49,"tag":430,"props":13792,"children":13794},{"id":13793},"modules-for-stable-environments-to-be-used-for-long-lived-pre-production-and-production-environments",[13795],{"type":55,"value":13796},"Modules for stable environments to be used for long-lived pre-production and production environments",{"type":49,"tag":58,"props":13798,"children":13799},{},[13800],{"type":55,"value":13801},"This article looked at how to make tradeoffs between costs, speed of deployment and production parity in ad hoc environments. I'm interested in building a new set of modules that can be used to set up environments that:",{"type":49,"tag":64,"props":13803,"children":13804},{},[13805,13810,13815,13820,13825],{"type":49,"tag":68,"props":13806,"children":13807},{},[13808],{"type":55,"value":13809},"are more stable and more long-lived",{"type":49,"tag":68,"props":13811,"children":13812},{},[13813],{"type":55,"value":13814},"have less resource sharing (dedicated RDS and ElastiCache resources)",{"type":49,"tag":68,"props":13816,"children":13817},{},[13818],{"type":55,"value":13819},"implement autoscaling for load-testing (or maybe implement autoscaling for ad hoc environments)",{"type":49,"tag":68,"props":13821,"children":13822},{},[13823],{"type":55,"value":13824},"can be used to perform load testing",{"type":49,"tag":68,"props":13826,"children":13827},{},[13828],{"type":55,"value":13829},"have enhanced observability tooling",{"type":49,"tag":58,"props":13831,"children":13832},{},[13833],{"type":55,"value":13834},"These environments might be used as part of a QA process that does a final sign-off on a new set of features scheduled for deployment to production environments, for example.",{"type":49,"tag":50,"props":13836,"children":13837},{"id":7730},[13838],{"type":55,"value":7733},{"type":49,"tag":58,"props":13840,"children":13841},{},[13842],{"type":55,"value":13843},"This wraps up the tour of my ad hoc environment infrastructure automation. Thank you for having a read through my article. If you have a similar (or different) approach to building ad hoc environments, I would love to hear about it.",{"type":49,"tag":7749,"props":13845,"children":13846},{},[13847],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":13849},[13850,13851,13852,13853,13854,13861,13862,13866,13875,13879,13883,13890,13906,13918],{"id":52,"depth":1079,"text":56},{"id":7862,"depth":1079,"text":7865},{"id":7987,"depth":1079,"text":7990},{"id":8099,"depth":1079,"text":8102},{"id":8110,"depth":1079,"text":8113,"children":13855},[13856,13857,13858,13859,13860],{"id":8159,"depth":1088,"text":8162},{"id":8347,"depth":1088,"text":8350},{"id":8427,"depth":1088,"text":8430},{"id":8499,"depth":1088,"text":8502},{"id":8580,"depth":1088,"text":8583},{"id":8678,"depth":1079,"text":8681},{"id":8900,"depth":1079,"text":8903,"children":13863},[13864,13865],{"id":8930,"depth":1088,"text":8933},{"id":8989,"depth":1088,"text":8992},{"id":9068,"depth":1079,"text":9071,"children":13867},[13868,13869,13870,13871,13872,13873,13874],{"id":2091,"depth":1088,"text":2094},{"id":9104,"depth":1088,"text":9107},{"id":2160,"depth":1088,"text":2017},{"id":9183,"depth":1088,"text":9186},{"id":9194,"depth":1088,"text":9197},{"id":9205,"depth":1088,"text":2022},{"id":2683,"depth":1088,"text":2032},{"id":9245,"depth":1079,"text":9248,"children":13876},[13877,13878],{"id":2877,"depth":1088,"text":2880},{"id":9265,"depth":1088,"text":9268},{"id":9330,"depth":1079,"text":9333,"children":13880},[13881,13882],{"id":9341,"depth":1088,"text":9344},{"id":9464,"depth":1088,"text":9467},{"id":9541,"depth":1079,"text":9544,"children":13884},[13885,13886,13887,13889],{"id":9671,"depth":1088,"text":9674},{"id":9721,"depth":1088,"text":9724},{"id":12729,"depth":1088,"text":13888},"Using ignore_changes in the definitions",{"id":12860,"depth":1088,"text":12863},{"id":12935,"depth":1079,"text":12938,"children":13891},[13892,13893,13895,13896,13897,13898,13899,13900,13901,13902,13903,13904,13905],{"id":12946,"depth":1088,"text":12949},{"id":12957,"depth":1088,"text":13894},"Run the make tf-bootstrap command",{"id":12984,"depth":1088,"text":12987},{"id":13017,"depth":1088,"text":13020},{"id":13028,"depth":1088,"text":13031},{"id":13039,"depth":1088,"text":13042},{"id":13050,"depth":1088,"text":13053},{"id":13197,"depth":1088,"text":13200},{"id":13239,"depth":1088,"text":13242},{"id":13288,"depth":1088,"text":13291},{"id":13355,"depth":1088,"text":13358},{"id":13580,"depth":1088,"text":13583},{"id":13612,"depth":1088,"text":13615},{"id":13641,"depth":1079,"text":13644,"children":13907},[13908,13909,13910,13911,13912,13913,13914,13915,13916,13917],{"id":13647,"depth":1088,"text":13650},{"id":13658,"depth":1088,"text":13661},{"id":13684,"depth":1088,"text":13687},{"id":13713,"depth":1088,"text":13716},{"id":13724,"depth":1088,"text":13727},{"id":13735,"depth":1088,"text":13738},{"id":13746,"depth":1088,"text":13749},{"id":13757,"depth":1088,"text":13760},{"id":13782,"depth":1088,"text":13785},{"id":13793,"depth":1088,"text":13796},{"id":7730,"depth":1079,"text":7733},"content:2022:03:27:ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions.md","2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions",{"_path":13923,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":13924,"description":13925,"date":13926,"image":13927,"tags":13928,"body":13932,"_type":7809,"_id":14026,"_source":7811,"_file":14027,"_stem":14028,"_extension":7814},"/2021/08/07/authenticating-requests-with-jwt-tokens-stored-in-httponly-cookies-in-django","Authenticating requests with JWT tokens stored in HTTPOnly cookies in Django","This article describes how you can use JWT tokens in Django applications with decoupled frontend JavaScript applications running the browser in secure way using HttpOnly cookies.","2021-08-01","/static/djjwt/dj_jwt.png",[14,13929,13930,13931],"vue","jwt","authentication",{"type":46,"children":13933,"toc":14019},[13934,13938,13943,13949,13954,13960,13965,13974,13979,13985,13990,13999,14006,14011],{"type":49,"tag":50,"props":13935,"children":13936},{"id":52},[13937],{"type":55,"value":56},{"type":49,"tag":58,"props":13939,"children":13940},{},[13941],{"type":55,"value":13942},"If you want to use JWTs to securely authenticate requests to Django REST Framework applications in a decoupled frontend JavaScript application, you can do the following: store the access token in memory and store the refresh token  in an HttpOnly cookie. The refresh token is used to request new access tokens on an regular interval.",{"type":49,"tag":50,"props":13944,"children":13946},{"id":13945},"some-context",[13947],{"type":55,"value":13948},"Some context",{"type":49,"tag":58,"props":13950,"children":13951},{},[13952],{"type":55,"value":13953},"Django is a web framework based on the Model, Template, View (MTV) paradigm. Django is increasingly used as an API server that is coupled with a Javascript or native frontend application.",{"type":49,"tag":50,"props":13955,"children":13957},{"id":13956},"jwt-auth-with-httponly-cookies",[13958],{"type":55,"value":13959},"JWT Auth with HttpOnly Cookies",{"type":49,"tag":58,"props":13961,"children":13962},{},[13963],{"type":55,"value":13964},"Following this guide:",{"type":49,"tag":58,"props":13966,"children":13967},{},[13968],{"type":49,"tag":80,"props":13969,"children":13972},{"href":13970,"rel":13971},"https://hasura.io/blog/best-practices-of-using-jwt-with-graphql/#jwt_security",[84],[13973],{"type":55,"value":13970},{"type":49,"tag":58,"props":13975,"children":13976},{},[13977],{"type":55,"value":13978},"We can reimplement our JWT authentication setup to be more secure.",{"type":49,"tag":430,"props":13980,"children":13982},{"id":13981},"drf-simple-jwt-modifications",[13983],{"type":55,"value":13984},"DRF Simple JWT modifications",{"type":49,"tag":58,"props":13986,"children":13987},{},[13988],{"type":55,"value":13989},"We need to change the default behavior of the views from DRF simple JWT as described in this issue:",{"type":49,"tag":58,"props":13991,"children":13992},{},[13993],{"type":49,"tag":80,"props":13994,"children":13997},{"href":13995,"rel":13996},"https://github.com/jazzband/djangorestframework-simplejwt/issues/71",[84],[13998],{"type":55,"value":13995},{"type":49,"tag":58,"props":14000,"children":14001},{},[14002],{"type":49,"tag":1601,"props":14003,"children":14005},{"alt":8926,"src":14004},"/static/jwt-authentication.png",[],{"type":49,"tag":58,"props":14007,"children":14008},{},[14009],{"type":55,"value":14010},"This diagram shows how authentication data moves between the Django backend and the Vue.js frontend running in the browser.",{"type":49,"tag":58,"props":14012,"children":14013},{},[14014],{"type":49,"tag":126,"props":14015,"children":14016},{},[14017],{"type":55,"value":14018},"This article should now be complete complete",{"title":8,"searchDepth":1079,"depth":1079,"links":14020},[14021,14022,14023],{"id":52,"depth":1079,"text":56},{"id":13945,"depth":1079,"text":13948},{"id":13956,"depth":1079,"text":13959,"children":14024},[14025],{"id":13981,"depth":1088,"text":13984},"content:2021:08:07:authenticating-requests-with-jwt-tokens-stored-in-httponly-cookies-in-django.md","2021/08/07/authenticating-requests-with-jwt-tokens-stored-in-httponly-cookies-in-django.md","2021/08/07/authenticating-requests-with-jwt-tokens-stored-in-httponly-cookies-in-django",{"_path":14030,"_dir":14031,"_draft":7,"_partial":7,"_locale":8,"title":14032,"description":14033,"date":14034,"image":14035,"tags":14036,"body":14039,"_type":7809,"_id":14900,"_source":7811,"_file":14901,"_stem":14902,"_extension":7814},"/2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application","02","Using Stripe for recurring monthly SaaS subscriptions in a Django + Vue application","This article shares my experience learning and implementing the Stripe API for recurring monthly SaaS subscription payments in an application using Django and Vue.js","2021-01-02T00:00:00.000Z","/static/django_vue_stripe.png",[14,13929,14037,14038],"drf","stripe",{"type":46,"children":14040,"toc":14890},[14041,14047,14052,14057,14063,14076,14088,14094,14114,14121,14127,14132,14138,14369,14375,14380,14706,14712,14717,14779,14785],{"type":49,"tag":1757,"props":14042,"children":14044},{"id":14043},"using-stripe-for-recurring-monthly-payments-to-a-paid-saas-subscription-in-a-django-vuejs-application",[14045],{"type":55,"value":14046},"Using Stripe for recurring monthly payments to a paid SaaS subscription in a Django + Vue.js application",{"type":49,"tag":58,"props":14048,"children":14049},{},[14050],{"type":55,"value":14051},"This diagram shows the flow of data for the lifecycle of a paid customer subscription in a Django application with a Vue.js client. There are four stages:",{"type":49,"tag":58,"props":14053,"children":14054},{},[14055],{"type":55,"value":14056},"I. Account setup, configuration, model and object creation\nII. Logic and data flow for starting a customer's premium monthly subscription\nIII. Automatic subscription renewal\nIV. Cancelling a premium subscription",{"type":49,"tag":50,"props":14058,"children":14060},{"id":14059},"context",[14061],{"type":55,"value":14062},"Context",{"type":49,"tag":58,"props":14064,"children":14065},{},[14066,14068,14074],{"type":55,"value":14067},"This is my first attempt at using Stripe, or any other online payment service API. Most of what I have diagramed here comes from this article from the Stripe documentation: ",{"type":49,"tag":80,"props":14069,"children":14072},{"href":14070,"rel":14071},"https://stripe.com/docs/billing/subscriptions/fixed-price",[84],[14073],{"type":55,"value":14070},{"type":55,"value":14075},". Knowing almost nothing about what is needed to create a SaaS subscription, I found this article very helpful. It was a lot to read at once, but each call to to the Stripe API is very clear and straightforward.",{"type":49,"tag":58,"props":14077,"children":14078},{},[14079,14081,14087],{"type":55,"value":14080},"I made some modifications and additions to this walk-through for my use case, which is an API service called Open SEC Data, an open source project that I'm working on (",{"type":49,"tag":80,"props":14082,"children":14085},{"href":14083,"rel":14084},"https://gitlab.com/briancaffey/sec-filings-app",[84],[14086],{"type":55,"value":14083},{"type":55,"value":3213},{"type":49,"tag":50,"props":14089,"children":14091},{"id":14090},"diagram",[14092],{"type":55,"value":14093},"Diagram",{"type":49,"tag":58,"props":14095,"children":14096},{},[14097,14099,14105,14107,14113],{"type":55,"value":14098},"Here's a read-only link to the diagram: ",{"type":49,"tag":80,"props":14100,"children":14103},{"href":14101,"rel":14102},"https://drive.google.com/file/d/1oH2b0W-c-dI5oXzc_jvCGvXx9sJagr4a/view?usp=sharing",[84],[14104],{"type":55,"value":14101},{"type":55,"value":14106},". This diagram is made with ",{"type":49,"tag":80,"props":14108,"children":14111},{"href":14109,"rel":14110},"https://www.diagrams.net/",[84],[14112],{"type":55,"value":14109},{"type":55,"value":745},{"type":49,"tag":58,"props":14115,"children":14116},{},[14117],{"type":49,"tag":1601,"props":14118,"children":14120},{"alt":8926,"src":14119},"/static/django_vue_stripe_diagram.png",[],{"type":49,"tag":50,"props":14122,"children":14124},{"id":14123},"legend",[14125],{"type":55,"value":14126},"Legend",{"type":49,"tag":58,"props":14128,"children":14129},{},[14130],{"type":55,"value":14131},"Here's a detailed description of each part of the diagram, starting with the first section.",{"type":49,"tag":430,"props":14133,"children":14135},{"id":14134},"i-account-setup-configuration-model-and-object-creation",[14136],{"type":55,"value":14137},"I. Account setup, configuration, model and object creation",{"type":49,"tag":8994,"props":14139,"children":14140},{},[14141,14154,14166,14192,14205,14223,14228,14257,14283,14309,14333,14344],{"type":49,"tag":68,"props":14142,"children":14143},{},[14144,14146,14152],{"type":55,"value":14145},"Setup a Stripe account. For local development, make sure you turn on ",{"type":49,"tag":326,"props":14147,"children":14149},{"className":14148},[],[14150],{"type":55,"value":14151},"View test data",{"type":55,"value":14153},". On your local machine, install the stripe CLI and authenticate with your Stripe account",{"type":49,"tag":68,"props":14155,"children":14156},{},[14157,14159,14165],{"type":55,"value":14158},"Create a Product in Stripe (mine is called ",{"type":49,"tag":326,"props":14160,"children":14162},{"className":14161},[],[14163],{"type":55,"value":14164},"Open SEC Data Premium Subscription",{"type":55,"value":616},{"type":49,"tag":68,"props":14167,"children":14168},{},[14169,14171,14175,14177,14183,14185,14191],{"type":55,"value":14170},"Create a Price in Stripe that references the Product.",{"type":49,"tag":14172,"props":14173,"children":14174},"br",{},[],{"type":55,"value":14176},"Instead of creating these objects in the Stripe Dashboard, you can also create them with the Stripe CLI or the Python SDK. I created a Django management command called ",{"type":49,"tag":326,"props":14178,"children":14180},{"className":14179},[],[14181],{"type":55,"value":14182},"create_stripe_data",{"type":55,"value":14184}," that will create a Product and related Price in Stripe. We will need the id of the Price, it looks like this: ",{"type":49,"tag":326,"props":14186,"children":14188},{"className":14187},[],[14189],{"type":55,"value":14190},"price_1Hx0goL67dRDwyuDh9yEWsBo",{"type":55,"value":745},{"type":49,"tag":68,"props":14193,"children":14194},{},[14195,14197,14203],{"type":55,"value":14196},"Add the Price ID as an environment variable ",{"type":49,"tag":326,"props":14198,"children":14200},{"className":14199},[],[14201],{"type":55,"value":14202},"SUBSCRIPTION_PRICE_ID",{"type":55,"value":14204}," to the backend. This will be used later when we make API calls to Stripe from inside of Django views.",{"type":49,"tag":68,"props":14206,"children":14207},{},[14208,14210,14213,14215,14221],{"type":55,"value":14209},"For production environments, you will need to a register a Stripe webhook. This is an endpoint in Django that Stripe will POST to in order to inform the Django application of events that have happened in Stripe.",{"type":49,"tag":14172,"props":14211,"children":14212},{},[],{"type":55,"value":14214},"For local development we need to run ",{"type":49,"tag":326,"props":14216,"children":14218},{"className":14217},[],[14219],{"type":55,"value":14220},"stripe listen --forward-to localhost/api/stripe-webhooks/",{"type":55,"value":14222}," in order to forward webhook events to the local Django application. This works really well for local development.",{"type":49,"tag":68,"props":14224,"children":14225},{},[14226],{"type":55,"value":14227},"In both local and production environments we need to add an environment variables to the Django application that will be used to validate the webhook event.",{"type":49,"tag":68,"props":14229,"children":14230},{},[14231,14233,14239,14241,14247,14249,14255],{"type":55,"value":14232},"You will need to create a ",{"type":49,"tag":326,"props":14234,"children":14236},{"className":14235},[],[14237],{"type":55,"value":14238},"Subscription",{"type":55,"value":14240}," model or similar in your Django models. This model should be related to your user model in some way. At a minimum it should have the ",{"type":49,"tag":326,"props":14242,"children":14244},{"className":14243},[],[14245],{"type":55,"value":14246},"subscription_id",{"type":55,"value":14248}," (the ID of the Stripe Subscription) and ",{"type":49,"tag":326,"props":14250,"children":14252},{"className":14251},[],[14253],{"type":55,"value":14254},"current_period_end",{"type":55,"value":14256}," (also from the Stripe Subscription object). We will use this model in the next sections.",{"type":49,"tag":68,"props":14258,"children":14259},{},[14260,14266,14268,14274,14276,14282],{"type":49,"tag":326,"props":14261,"children":14263},{"className":14262},[],[14264],{"type":55,"value":14265},"/api/stripe-webhooks/",{"type":55,"value":14267}," is the endpoint in the Django application that Stripe will send POST requests to in order to inform the Django application of events that happen in Stripe. The URL can be called anything you want, as long as you register it with that URL. In local development, you need to specify this URL in the ",{"type":49,"tag":326,"props":14269,"children":14271},{"className":14270},[],[14272],{"type":55,"value":14273},"stipe listen",{"type":55,"value":14275}," command (for example, ",{"type":49,"tag":326,"props":14277,"children":14279},{"className":14278},[],[14280],{"type":55,"value":14281},"stripe listen forward-to localhost/api/stripe-webhooks/",{"type":55,"value":3213},{"type":49,"tag":68,"props":14284,"children":14285},{},[14286,14292,14294,14300,14302,14308],{"type":49,"tag":326,"props":14287,"children":14289},{"className":14288},[],[14290],{"type":55,"value":14291},"STRIPE_SECRET_KEY",{"type":55,"value":14293}," is the name of the secret API key that should only be accessible by the backend. In local development, this key looks like ",{"type":49,"tag":326,"props":14295,"children":14297},{"className":14296},[],[14298],{"type":55,"value":14299},"sk_test_Abc123",{"type":55,"value":14301},". In production, this key will look like ",{"type":49,"tag":326,"props":14303,"children":14305},{"className":14304},[],[14306],{"type":55,"value":14307},"sk_Abc123",{"type":55,"value":745},{"type":49,"tag":68,"props":14310,"children":14311},{},[14312,14317,14319,14325,14326,14332],{"type":49,"tag":326,"props":14313,"children":14315},{"className":14314},[],[14316],{"type":55,"value":14038},{"type":55,"value":14318}," is the name of the PyPI package that we need to add to ",{"type":49,"tag":326,"props":14320,"children":14322},{"className":14321},[],[14323],{"type":55,"value":14324},"requirements.txt",{"type":55,"value":6234},{"type":49,"tag":326,"props":14327,"children":14329},{"className":14328},[],[14330],{"type":55,"value":14331},"requirements/base.txt",{"type":55,"value":3213},{"type":49,"tag":68,"props":14334,"children":14335},{},[14336,14342],{"type":49,"tag":326,"props":14337,"children":14339},{"className":14338},[],[14340],{"type":55,"value":14341},"STRIPE_PUBLISHABLE_KEY",{"type":55,"value":14343}," is the value of the Stripe API key that can be made public and is used in the Vue application to instantiate Stripe.",{"type":49,"tag":68,"props":14345,"children":14346},{},[14347,14349,14355,14357],{"type":55,"value":14348},"The Stripe library is included in ",{"type":49,"tag":326,"props":14350,"children":14352},{"className":14351},[],[14353],{"type":55,"value":14354},"index.html",{"type":55,"value":14356}," via CDN so that it is accessible anywhere in the Vue application. Stripe object is instantiated in the Vue application with:",{"type":49,"tag":2910,"props":14358,"children":14359},{},[14360],{"type":49,"tag":58,"props":14361,"children":14362},{},[14363],{"type":49,"tag":326,"props":14364,"children":14366},{"className":14365},[],[14367],{"type":55,"value":14368},"let stripe = Stripe(process.env.STRIPE_PUBLISHABLE_KEY)",{"type":49,"tag":430,"props":14370,"children":14372},{"id":14371},"ii-logic-and-data-flow-for-starting-a-customers-premium-monthly-subscription",[14373],{"type":55,"value":14374},"II. Logic and data flow for starting a customer's premium monthly subscription",{"type":49,"tag":58,"props":14376,"children":14377},{},[14378],{"type":55,"value":14379},"With everything setup and configured properly in Stripe, the backend Django application and the frontend Vue application, customers can now start paying for monthly subscriptions. In my application, a user can sign up for an account first without having a premium subscription. In other scenarios, having an active account may require a premium subscription.",{"type":49,"tag":8994,"props":14381,"children":14382},{"start":1188},[14383,14420,14469,14481,14506,14524,14537,14542,14547,14552,14594,14612,14623,14633,14653,14658,14663,14668,14701],{"type":49,"tag":68,"props":14384,"children":14385},{},[14386,14388,14394,14396,14402,14404,14411,14413,14419],{"type":55,"value":14387},"When a logged-in user visits their ",{"type":49,"tag":326,"props":14389,"children":14391},{"className":14390},[],[14392],{"type":55,"value":14393},"/account",{"type":55,"value":14395}," page, they will see the status of their account: Basic (free) or Premium (paid subscription). Users on a Basic plan will see the option to upgrade to Premium. They will be redirected to a ",{"type":49,"tag":326,"props":14397,"children":14399},{"className":14398},[],[14400],{"type":55,"value":14401},"/premium",{"type":55,"value":14403}," page where they will be presented with a credit card form. This credit card form is generated by ",{"type":49,"tag":80,"props":14405,"children":14408},{"href":14406,"rel":14407},"https://stripe.com/payments/elements",[84],[14409],{"type":55,"value":14410},"Stripe Elements",{"type":55,"value":14412},". The user fills out their credit card, expiration date, card security code and billing ZIP code and then clicks ",{"type":49,"tag":326,"props":14414,"children":14416},{"className":14415},[],[14417],{"type":55,"value":14418},"Purchase",{"type":55,"value":745},{"type":49,"tag":68,"props":14421,"children":14422},{},[14423,14425,14430,14432,14438,14440,14446,14447,14453,14455,14460,14462,14468],{"type":55,"value":14424},"Clicking on ",{"type":49,"tag":326,"props":14426,"children":14428},{"className":14427},[],[14429],{"type":55,"value":14418},{"type":55,"value":14431}," calls a method ",{"type":49,"tag":326,"props":14433,"children":14435},{"className":14434},[],[14436],{"type":55,"value":14437},"purchase",{"type":55,"value":14439}," that calls ",{"type":49,"tag":326,"props":14441,"children":14443},{"className":14442},[],[14444],{"type":55,"value":14445},"stripe.CreatePaymentMethod",{"type":55,"value":1931},{"type":49,"tag":326,"props":14448,"children":14450},{"className":14449},[],[14451],{"type":55,"value":14452},"paymentMethodId",{"type":55,"value":14454}," token returned from ",{"type":49,"tag":326,"props":14456,"children":14458},{"className":14457},[],[14459],{"type":55,"value":14445},{"type":55,"value":14461}," is then passed to the method called ",{"type":49,"tag":326,"props":14463,"children":14465},{"className":14464},[],[14466],{"type":55,"value":14467},"createSubscription",{"type":55,"value":745},{"type":49,"tag":68,"props":14470,"children":14471},{},[14472,14474,14479],{"type":55,"value":14473},"Stripe creates this object and returns a response that contains a ",{"type":49,"tag":326,"props":14475,"children":14477},{"className":14476},[],[14478],{"type":55,"value":14452},{"type":55,"value":14480}," token.",{"type":49,"tag":68,"props":14482,"children":14483},{},[14484,14489,14491,14497,14499,14504],{"type":49,"tag":326,"props":14485,"children":14487},{"className":14486},[],[14488],{"type":55,"value":14467},{"type":55,"value":14490}," sends a POST request to ",{"type":49,"tag":326,"props":14492,"children":14494},{"className":14493},[],[14495],{"type":55,"value":14496},"/api/stripe/create-subscription/",{"type":55,"value":14498}," in the Django application with the ",{"type":49,"tag":326,"props":14500,"children":14502},{"className":14501},[],[14503],{"type":55,"value":14452},{"type":55,"value":14505}," that we generated in the previous step.",{"type":49,"tag":68,"props":14507,"children":14508},{},[14509,14514,14516,14522],{"type":49,"tag":326,"props":14510,"children":14512},{"className":14511},[],[14513],{"type":55,"value":14496},{"type":55,"value":14515}," calls a view called ",{"type":49,"tag":326,"props":14517,"children":14519},{"className":14518},[],[14520],{"type":55,"value":14521},"create_subscription",{"type":55,"value":14523}," which makes a number of API calls to Stripe and then finally saves some data in the application's Postgres database.",{"type":49,"tag":68,"props":14525,"children":14526},{},[14527,14529,14535],{"type":55,"value":14528},"The first API call creates the Customer object in Stripe if it does not exist. ",{"type":49,"tag":326,"props":14530,"children":14532},{"className":14531},[],[14533],{"type":55,"value":14534},"email=request.user.email",{"type":55,"value":14536}," is used in the API call to associate the Stripe customer with the user's email.",{"type":49,"tag":68,"props":14538,"children":14539},{},[14540],{"type":55,"value":14541},"Next the payment method is attached to Stripe Customer model.",{"type":49,"tag":68,"props":14543,"children":14544},{},[14545],{"type":55,"value":14546},"Next the Stripe payment method is set as the default payment method for Stripe customer for future billing.",{"type":49,"tag":68,"props":14548,"children":14549},{},[14550],{"type":55,"value":14551},"The Stripe subscription model is created with the customer ID that was created in the earlier and the price ID corresponding to the premium subscription (added in the setup stage).",{"type":49,"tag":68,"props":14553,"children":14554},{},[14555,14557,14563,14564,14570,14571,14577,14579,14584,14586,14592],{"type":55,"value":14556},"Once these Stripe API calls have finished, a new Subscription is saved in the Postgres database. ",{"type":49,"tag":326,"props":14558,"children":14560},{"className":14559},[],[14561],{"type":55,"value":14562},"stripe_subscription_id",{"type":55,"value":873},{"type":49,"tag":326,"props":14565,"children":14567},{"className":14566},[],[14568],{"type":55,"value":14569},"stripe_customer_id",{"type":55,"value":715},{"type":49,"tag":326,"props":14572,"children":14574},{"className":14573},[],[14575],{"type":55,"value":14576},"valid_through",{"type":55,"value":14578}," (DateTimeField that keeps track of the date through which the user's subscription has been paid for) are saved to the ",{"type":49,"tag":326,"props":14580,"children":14582},{"className":14581},[],[14583],{"type":55,"value":14238},{"type":55,"value":14585}," model and then the subscription model is saved to the user model's ",{"type":49,"tag":326,"props":14587,"children":14589},{"className":14588},[],[14590],{"type":55,"value":14591},"subscription",{"type":55,"value":14593}," field.",{"type":49,"tag":68,"props":14595,"children":14596},{},[14597,14599,14604,14606],{"type":55,"value":14598},"When the ",{"type":49,"tag":326,"props":14600,"children":14602},{"className":14601},[],[14603],{"type":55,"value":14467},{"type":55,"value":14605}," method's POST requests returns successfully, the user's account is fetched again from ",{"type":49,"tag":326,"props":14607,"children":14609},{"className":14608},[],[14610],{"type":55,"value":14611},"/api/account/",{"type":49,"tag":68,"props":14613,"children":14614},{},[14615,14617,14622],{"type":55,"value":14616},"The browser makes a request to ",{"type":49,"tag":326,"props":14618,"children":14620},{"className":14619},[],[14621],{"type":55,"value":14611},{"type":55,"value":745},{"type":49,"tag":68,"props":14624,"children":14625},{},[14626,14631],{"type":49,"tag":326,"props":14627,"children":14629},{"className":14628},[],[14630],{"type":55,"value":14611},{"type":55,"value":14632}," returns information on the user and their subscription.",{"type":49,"tag":68,"props":14634,"children":14635},{},[14636,14638,14643,14645,14651],{"type":55,"value":14637},"Data from ",{"type":49,"tag":326,"props":14639,"children":14641},{"className":14640},[],[14642],{"type":55,"value":14611},{"type":55,"value":14644}," is updated in Vuex ",{"type":49,"tag":326,"props":14646,"children":14648},{"className":14647},[],[14649],{"type":55,"value":14650},"user",{"type":55,"value":14652}," store.",{"type":49,"tag":68,"props":14654,"children":14655},{},[14656],{"type":55,"value":14657},"The user is now able to make requests to resources for premium features.",{"type":49,"tag":68,"props":14659,"children":14660},{},[14661],{"type":55,"value":14662},"In this application, one such example is the ability to request an API key for making for making API calls.",{"type":49,"tag":68,"props":14664,"children":14665},{},[14666],{"type":55,"value":14667},"A user makes a request to an API endpoint for a premium feature.",{"type":49,"tag":68,"props":14669,"children":14670},{},[14671,14673,14679,14680,14686,14688,14693,14695,14700],{"type":55,"value":14672},"When determining permissions for resources that should only be accessible to customers with valid subscriptions, we need to compare ",{"type":49,"tag":326,"props":14674,"children":14676},{"className":14675},[],[14677],{"type":55,"value":14678},"request.user.subscription.valid_through",{"type":55,"value":12789},{"type":49,"tag":326,"props":14681,"children":14683},{"className":14682},[],[14684],{"type":55,"value":14685},"timezone.now()",{"type":55,"value":14687}," and make sure that ",{"type":49,"tag":326,"props":14689,"children":14691},{"className":14690},[],[14692],{"type":55,"value":14576},{"type":55,"value":14694}," is greater than ",{"type":49,"tag":326,"props":14696,"children":14698},{"className":14697},[],[14699],{"type":55,"value":14685},{"type":55,"value":745},{"type":49,"tag":68,"props":14702,"children":14703},{},[14704],{"type":55,"value":14705},"Requests for protected resources are successfully returned to the browser.",{"type":49,"tag":430,"props":14707,"children":14709},{"id":14708},"iii-automatic-subscription-renewal",[14710],{"type":55,"value":14711},"III. Automatic subscription renewal",{"type":49,"tag":58,"props":14713,"children":14714},{},[14715],{"type":55,"value":14716},"The customer's credit card is charged once each month that they are subscribed to the service. This action happens in Stripe. This section assumes that the customer's primary payment method is still valid (it has not been canceled expired or not able to be charged for some other reason).",{"type":49,"tag":8994,"props":14718,"children":14719},{"start":10188},[14720,14725,14746],{"type":49,"tag":68,"props":14721,"children":14722},{},[14723],{"type":55,"value":14724},"The customer's card is charged in Stripe and an event is sent to the Django backend via a webhook that we registered in the setup stage.",{"type":49,"tag":68,"props":14726,"children":14727},{},[14728,14730,14736,14738,14744],{"type":55,"value":14729},"The webhook view checks ",{"type":49,"tag":326,"props":14731,"children":14733},{"className":14732},[],[14734],{"type":55,"value":14735},"event.type",{"type":55,"value":14737}," and if the event is of type ",{"type":49,"tag":326,"props":14739,"children":14741},{"className":14740},[],[14742],{"type":55,"value":14743},"invoice.paid",{"type":55,"value":14745}," we extend the user's subscription by one month.",{"type":49,"tag":68,"props":14747,"children":14748},{},[14749,14751,14757,14759,14764,14766,14771,14773,14778],{"type":55,"value":14750},"To extend the user's subscription, we modify the ",{"type":49,"tag":326,"props":14752,"children":14754},{"className":14753},[],[14755],{"type":55,"value":14756},"DateTimeField",{"type":55,"value":14758}," field on the ",{"type":49,"tag":326,"props":14760,"children":14762},{"className":14761},[],[14763],{"type":55,"value":14238},{"type":55,"value":14765}," that tracks the ",{"type":49,"tag":326,"props":14767,"children":14769},{"className":14768},[],[14770],{"type":55,"value":14254},{"type":55,"value":14772}," which is included in the webhook data object. The model field in my code is called ",{"type":49,"tag":326,"props":14774,"children":14776},{"className":14775},[],[14777],{"type":55,"value":14576},{"type":55,"value":745},{"type":49,"tag":430,"props":14780,"children":14782},{"id":14781},"iv-cancelling-a-premium-subscription",[14783],{"type":55,"value":14784},"IV. Cancelling a premium subscription",{"type":49,"tag":8994,"props":14786,"children":14787},{"start":10242},[14788,14801,14853,14866,14878],{"type":49,"tag":68,"props":14789,"children":14790},{},[14791,14793,14799],{"type":55,"value":14792},"When a user decides to cancel their payed subscription service, they click on the ",{"type":49,"tag":326,"props":14794,"children":14796},{"className":14795},[],[14797],{"type":55,"value":14798},"Cancel My Subscription",{"type":55,"value":14800}," button.",{"type":49,"tag":68,"props":14802,"children":14803},{},[14804,14806,14812,14814,14820,14822,14828,14830,14836,14838,14844,14846,14851],{"type":55,"value":14805},"This makes a POST request to ",{"type":49,"tag":326,"props":14807,"children":14809},{"className":14808},[],[14810],{"type":55,"value":14811},"/api/stripe/cancel-subscription",{"type":55,"value":14813}," which calls the ",{"type":49,"tag":326,"props":14815,"children":14817},{"className":14816},[],[14818],{"type":55,"value":14819},"cancel_subscription",{"type":55,"value":14821}," view. This view calls ",{"type":49,"tag":326,"props":14823,"children":14825},{"className":14824},[],[14826],{"type":55,"value":14827},"stripe.Subscription.delete(subscriptionId)",{"type":55,"value":14829},", where the ",{"type":49,"tag":326,"props":14831,"children":14833},{"className":14832},[],[14834],{"type":55,"value":14835},"subscriptionId",{"type":55,"value":14837}," is retrieved from ",{"type":49,"tag":326,"props":14839,"children":14841},{"className":14840},[],[14842],{"type":55,"value":14843},"request.user.subscription",{"type":55,"value":14845}," (the ",{"type":49,"tag":326,"props":14847,"children":14849},{"className":14848},[],[14850],{"type":55,"value":14238},{"type":55,"value":14852}," model created in the setup section).",{"type":49,"tag":68,"props":14854,"children":14855},{},[14856,14858,14864],{"type":55,"value":14857},"The subscription is deleted in Stripe through the ",{"type":49,"tag":326,"props":14859,"children":14861},{"className":14860},[],[14862],{"type":55,"value":14863},"stripe.Subscription.delete",{"type":55,"value":14865}," API call.",{"type":49,"tag":68,"props":14867,"children":14868},{},[14869,14871,14877],{"type":55,"value":14870},"The user's subscription is deleted from the user model with ",{"type":49,"tag":326,"props":14872,"children":14874},{"className":14873},[],[14875],{"type":55,"value":14876},"request.user.subscription.delete()",{"type":55,"value":745},{"type":49,"tag":68,"props":14879,"children":14880},{},[14881,14883,14888],{"type":55,"value":14882},"The frontend responds to the deleted subscription by fetching ",{"type":49,"tag":326,"props":14884,"children":14886},{"className":14885},[],[14887],{"type":55,"value":14611},{"type":55,"value":14889}," again, refresh, or redirecting and the user no longer has access to their premium subscription.",{"title":8,"searchDepth":1079,"depth":1079,"links":14891},[14892,14893,14894],{"id":14059,"depth":1079,"text":14062},{"id":14090,"depth":1079,"text":14093},{"id":14123,"depth":1079,"text":14126,"children":14895},[14896,14897,14898,14899],{"id":14134,"depth":1088,"text":14137},{"id":14371,"depth":1088,"text":14374},{"id":14708,"depth":1088,"text":14711},{"id":14781,"depth":1088,"text":14784},"content:2021:01:02:using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application.md","2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application.md","2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application",{"_path":14904,"_dir":14905,"_draft":7,"_partial":7,"_locale":8,"title":14906,"description":14907,"date":14908,"image":14909,"tags":14910,"body":14912,"_type":7809,"_id":16038,"_source":7811,"_file":16039,"_stem":16040,"_extension":7814},"/2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt","01","Session Authentication with Django, Django REST Framework and Nuxt","This article shows how to use session authentication with Django + Nuxt.js applications","2021-01-01T00:00:00.000Z","/static/django_nuxt_auth_og.png",[14,13929,14911,14037,13931],"nuxt",{"type":46,"children":14913,"toc":16013},[14914,14919,14924,14933,14938,14943,14948,14953,14957,14962,14967,14973,14978,14984,14989,15012,15017,15023,15028,15077,15083,15088,15093,15099,15104,15109,15114,15118,15126,15131,15150,15155,15186,15191,15216,15244,15414,15426,15489,15552,15605,15617,15681,15701,15723,15734,15912,15918,15924,15929,15935,15948,15953,15959,15964,15969,15975,15980,15986,15991,15997,16002,16008],{"type":49,"tag":58,"props":14915,"children":14916},{},[14917],{"type":55,"value":14918},"This will be a continuation of the discussion about how data flows in Django + Nuxt applications, looking specifically at session authentication.",{"type":49,"tag":58,"props":14920,"children":14921},{},[14922],{"type":55,"value":14923},"Here's a GitLab repo that where you can find the source code and other diagrams related to this project:",{"type":49,"tag":58,"props":14925,"children":14926},{},[14927],{"type":49,"tag":80,"props":14928,"children":14931},{"href":14929,"rel":14930},"https://gitlab.com/briancaffey/django-nuxt-starter",[84],[14932],{"type":55,"value":14929},{"type":49,"tag":58,"props":14934,"children":14935},{},[14936],{"type":55,"value":14937},"This diagram focuses on the interactions between:",{"type":49,"tag":58,"props":14939,"children":14940},{},[14941],{"type":55,"value":14942},"I. The browser",{"type":49,"tag":58,"props":14944,"children":14945},{},[14946],{"type":55,"value":14947},"II. The Nuxt server (Node process)",{"type":49,"tag":58,"props":14949,"children":14950},{},[14951],{"type":55,"value":14952},"III. The Django backend API server (gunicorn process)",{"type":49,"tag":50,"props":14954,"children":14955},{"id":14059},[14956],{"type":55,"value":14062},{"type":49,"tag":58,"props":14958,"children":14959},{},[14960],{"type":55,"value":14961},"For illustration purposes, I'm using a simple CRUD application that has two models: Users and (blog) Posts. Users can log in with email and password credentials and create, read, update and delete blog posts (CRUD). Currently I'm only doing the R (read) of CRUD: listing and viewing blog posts. Creating, updating and delete will be added later. For now, users must be logged in to see posts.",{"type":49,"tag":58,"props":14963,"children":14964},{},[14965],{"type":55,"value":14966},"I'm still learning a lot about Nuxt and how it can be used with Django and Django REST Framework. This project is an effort at documenting my learning process, learning in public and learning from mistakes, so any feedback or guidance on what I have written here would be highly appreciated!",{"type":49,"tag":50,"props":14968,"children":14970},{"id":14969},"why-nuxt",[14971],{"type":55,"value":14972},"Why Nuxt?",{"type":49,"tag":58,"props":14974,"children":14975},{},[14976],{"type":55,"value":14977},"Using Nuxt (with Server Side Rendering, or SSR) is one of many ways to use Vue.js with Django. Vue is a progressive framework, which means that it can be gradually adopted into a project--you don't have to go all-in on the framework or rewrite the application from scratch to fit with how Vue works.",{"type":49,"tag":430,"props":14979,"children":14981},{"id":14980},"different-ways-to-use-vue-with-django",[14982],{"type":55,"value":14983},"Different ways to use Vue with Django",{"type":49,"tag":58,"props":14985,"children":14986},{},[14987],{"type":55,"value":14988},"In terms of Django, here are some ways that you can use Vue:",{"type":49,"tag":64,"props":14990,"children":14991},{},[14992,14997,15002,15007],{"type":49,"tag":68,"props":14993,"children":14994},{},[14995],{"type":55,"value":14996},"Vue as a jQuery replacement for adding basic interactivity in views served by Django templates",{"type":49,"tag":68,"props":14998,"children":14999},{},[15000],{"type":55,"value":15001},"Build a static Vue application and serve it as a set of static assets in a Django project alongside routes that are served by other normal Django templates views.",{"type":49,"tag":68,"props":15003,"children":15004},{},[15005],{"type":55,"value":15006},"Build a Vue SPA which consumes a Django API (usually built with Django REST Framework or similar), and serve it over a content delivery network (CDN).",{"type":49,"tag":68,"props":15008,"children":15009},{},[15010],{"type":55,"value":15011},"Use Vue to build an Electron desktop app that uses Django as an API",{"type":49,"tag":58,"props":15013,"children":15014},{},[15015],{"type":55,"value":15016},"In these scenarios, Vue is served as either static assets (such as in the case of serving a SPA over a CDN), or Vue code is included in an HTML response from a server (where the view library, not your application, is served over a CDN), similar to how jQuery is used.",{"type":49,"tag":430,"props":15018,"children":15020},{"id":15019},"different-ways-to-use-nuxt",[15021],{"type":55,"value":15022},"Different ways to use Nuxt",{"type":49,"tag":58,"props":15024,"children":15025},{},[15026],{"type":55,"value":15027},"Nuxt is a Framework that can be used in a few different ways, I'll briefly discus three ways in which Nuxt can be used. Common to all three of these ways of using Nuxt is the directory structure. No matter how you use Nuxt, it provides a great way to organize Vue code.",{"type":49,"tag":8994,"props":15029,"children":15030},{},[15031,15044,15049],{"type":49,"tag":68,"props":15032,"children":15033},{},[15034,15036,15043],{"type":55,"value":15035},"Static mode: this mode allows you to write Vue code which is built into a static HTML, and then that HTML is deployed to a CDN or webserver like NGINX. The developer (or CI/CD process) runs a command to generate HTML files for each page in the application, and these pages are served as-is when accessed by a user. I recently migrated my personal blog from Jekyll to Nuxt with full-static mode. Check it out at (",{"type":49,"tag":80,"props":15037,"children":15040},{"href":15038,"rel":15039},"https://briancaffey.github.io",[84],[15041],{"type":55,"value":15042},"briancaffey.github.io",{"type":55,"value":3213},{"type":49,"tag":68,"props":15045,"children":15046},{},[15047],{"type":55,"value":15048},"SPA mode: This is similar to what you might use if you started a Vue project with Vue CLI. The project is also generated as in Static Mode, but what is generated is primarily Javascript code that is executed on the browser.",{"type":49,"tag":68,"props":15050,"children":15051},{},[15052,15054,15060,15062,15067,15069,15075],{"type":55,"value":15053},"SSR mode: Server Side Rendering is the mode that I'll be focusing on here. Unlike the other ways of using Vue that have already been discussed, this mode involves a Node.js server that will handle our requests. For example, a web request for ",{"type":49,"tag":326,"props":15055,"children":15057},{"className":15056},[],[15058],{"type":55,"value":15059},"/posts",{"type":55,"value":15061}," is sent to our Nuxt Server (a Node.js server process) and Node.js is responsible for returning HTML that contains all of the blog Posts that we want to show (or a paginated selection of all blog posts, which is how my example blog app is built). So the Nuxt app has to make a request to our Django API server before returning fully rendered HTML page for the ",{"type":49,"tag":326,"props":15063,"children":15065},{"className":15064},[],[15066],{"type":55,"value":15059},{"type":55,"value":15068}," page. The user then gets the page from Nuxt, reads all of the blog posts and then decides to check out the blog posts on the second page of posts. When the user clicks on page 2, we request the second page of data from our Django API directly, not from Nuxt. The user then sees a short loading animation followed by the second page of blog posts that are loaded in using AJAX (usually with ",{"type":49,"tag":326,"props":15070,"children":15072},{"className":15071},[],[15073],{"type":55,"value":15074},"fetch",{"type":55,"value":15076}," or axios).",{"type":49,"tag":430,"props":15078,"children":15080},{"id":15079},"nuxt-benefits",[15081],{"type":55,"value":15082},"Nuxt Benefits",{"type":49,"tag":58,"props":15084,"children":15085},{},[15086],{"type":55,"value":15087},"The main reason for using Nuxt is to render the first page loads on the server, returning a complete HTML response that can be beneficial for SEO, social sharing, and other scenarios where you need control over how a website's pages are delivered (specifically, the initial request made to the server).",{"type":49,"tag":58,"props":15089,"children":15090},{},[15091],{"type":55,"value":15092},"This type of control is not possible for applications that serve Vue over CDN since they can only request backend API data once the JS client has been requested from a CDN.",{"type":49,"tag":430,"props":15094,"children":15096},{"id":15095},"nuxt-downsides-and-tradeoffs",[15097],{"type":55,"value":15098},"Nuxt Downsides and Tradeoffs",{"type":49,"tag":58,"props":15100,"children":15101},{},[15102],{"type":55,"value":15103},"Using Nuxt for SSR introduces quite a bit of complexity in both the application deployment and our Vue code. The backend API won't have to change at all when moving to Nuxt from a static Vue SPA.",{"type":49,"tag":58,"props":15105,"children":15106},{},[15107],{"type":55,"value":15108},"Django alone is capable of returning fully generated, SEO-optimized HTML for each request, but applications built with Vue and Django templates may be difficult to work on as the project grows larger and larger. The Django/DRF + Nuxt approach may be more appropriate for projects with dedicated backend and frontend teams.",{"type":49,"tag":58,"props":15110,"children":15111},{},[15112],{"type":55,"value":15113},"One other potential downside is added latency because of the \"double request\". If the Nuxt server and the Django server are on the same machine, then this latency will probably be a non-issue.",{"type":49,"tag":50,"props":15115,"children":15116},{"id":14090},[15117],{"type":55,"value":14093},{"type":49,"tag":58,"props":15119,"children":15120},{},[15121],{"type":49,"tag":1601,"props":15122,"children":15125},{"alt":15123,"src":15124},"Nuxt Django Auth","/static/django_nuxt_auth.png",[],{"type":49,"tag":58,"props":15127,"children":15128},{},[15129],{"type":55,"value":15130},"This diagram looks at session authentication with a focus on the browser, the Nuxt server and the Django server. It looks at two simple user stories, ordered from top to bottom in the diagram.",{"type":49,"tag":58,"props":15132,"children":15133},{},[15134,15136,15141,15143,15148],{"type":55,"value":15135},"I. An existing application user visits the site in a new browser, navigates to the Login page, logs in with credentials and then visits a protected page: ",{"type":49,"tag":326,"props":15137,"children":15139},{"className":15138},[],[15140],{"type":55,"value":15059},{"type":55,"value":15142},".\nII. The user closes the browser and then comes back directly to the ",{"type":49,"tag":326,"props":15144,"children":15146},{"className":15145},[],[15147],{"type":55,"value":15059},{"type":55,"value":15149}," page.",{"type":49,"tag":58,"props":15151,"children":15152},{},[15153],{"type":55,"value":15154},"These two user stories sound simple, but they touch on a lot of the features of Nuxt that make it powerful, and complicated at first (for Vue users). These include:",{"type":49,"tag":64,"props":15156,"children":15157},{},[15158,15167,15176,15181],{"type":49,"tag":68,"props":15159,"children":15160},{},[15161],{"type":49,"tag":326,"props":15162,"children":15164},{"className":15163},[],[15165],{"type":55,"value":15166},"asyncData",{"type":49,"tag":68,"props":15168,"children":15169},{},[15170],{"type":49,"tag":326,"props":15171,"children":15173},{"className":15172},[],[15174],{"type":55,"value":15175},"nuxtServerInit",{"type":49,"tag":68,"props":15177,"children":15178},{},[15179],{"type":55,"value":15180},"Vuex on the client and server",{"type":49,"tag":68,"props":15182,"children":15183},{},[15184],{"type":55,"value":15185},"Custom plugin for axios",{"type":49,"tag":58,"props":15187,"children":15188},{},[15189],{"type":55,"value":15190},"Some important parts of Nuxt that this diagram does not (yet) touch on are:",{"type":49,"tag":64,"props":15192,"children":15193},{},[15194,15199,15211],{"type":49,"tag":68,"props":15195,"children":15196},{},[15197],{"type":55,"value":15198},"Nuxt auth module (I don't know if this is relevant for my use case)",{"type":49,"tag":68,"props":15200,"children":15201},{},[15202,15204,15209],{"type":55,"value":15203},"Nuxt fetch property (different from the ",{"type":49,"tag":326,"props":15205,"children":15207},{"className":15206},[],[15208],{"type":55,"value":15074},{"type":55,"value":15210}," web API)",{"type":49,"tag":68,"props":15212,"children":15213},{},[15214],{"type":55,"value":15215},"Nuxt middleware (I'm also not sure if this would be helpful for anything I am doing in this example project)",{"type":49,"tag":430,"props":15217,"children":15219},{"id":15218},"user-story-i-a-user-tries-to-open-posts-is-redirected-to-login-logs-in-then-navigate-to-posts-and-sees-blog-posts",[15220,15222,15227,15229,15235,15237,15242],{"type":55,"value":15221},"User story I.: A user tries to open ",{"type":49,"tag":326,"props":15223,"children":15225},{"className":15224},[],[15226],{"type":55,"value":15059},{"type":55,"value":15228},", is redirected to ",{"type":49,"tag":326,"props":15230,"children":15232},{"className":15231},[],[15233],{"type":55,"value":15234},"/login",{"type":55,"value":15236},", logs in, then navigate to ",{"type":49,"tag":326,"props":15238,"children":15240},{"className":15239},[],[15241],{"type":55,"value":15059},{"type":55,"value":15243}," and sees blog posts",{"type":49,"tag":8994,"props":15245,"children":15246},{},[15247,15260,15288,15320,15339,15344,15349,15390,15395],{"type":49,"tag":68,"props":15248,"children":15249},{},[15250,15252,15258],{"type":55,"value":15251},"User navigates to ",{"type":49,"tag":326,"props":15253,"children":15255},{"className":15254},[],[15256],{"type":55,"value":15257},"http://domain.com/",{"type":55,"value":15259},". This request is handled by the Nuxt server.",{"type":49,"tag":68,"props":15261,"children":15262},{},[15263,15264,15269,15271,15278,15280,15286],{"type":55,"value":413},{"type":49,"tag":326,"props":15265,"children":15267},{"className":15266},[],[15268],{"type":55,"value":15175},{"type":55,"value":15270}," action is called (",{"type":49,"tag":80,"props":15272,"children":15275},{"href":15273,"rel":15274},"https://nuxtjs.org/docs/2.x/directory-structure/store#the-nuxtserverinit-action",[84],[15276],{"type":55,"value":15277},"read more on nuxtServerInit",{"type":55,"value":15279},"). This is a special Vuex action that, if defined in ",{"type":49,"tag":326,"props":15281,"children":15283},{"className":15282},[],[15284],{"type":55,"value":15285},"store/index.js",{"type":55,"value":15287},", will be called once per request to the Nuxt Server (when a page is initially visited or refreshed in the browser).",{"type":49,"tag":68,"props":15289,"children":15290},{},[15291,15296,15298,15303,15305,15311,15313,15318],{"type":49,"tag":326,"props":15292,"children":15294},{"className":15293},[],[15295],{"type":55,"value":15175},{"type":55,"value":15297}," dispatches a Vuex action in the ",{"type":49,"tag":326,"props":15299,"children":15301},{"className":15300},[],[15302],{"type":55,"value":14650},{"type":55,"value":15304}," module called ",{"type":49,"tag":326,"props":15306,"children":15308},{"className":15307},[],[15309],{"type":55,"value":15310},"fetchData",{"type":55,"value":15312},". This action makes an GET request to ",{"type":49,"tag":326,"props":15314,"children":15316},{"className":15315},[],[15317],{"type":55,"value":14611},{"type":55,"value":15319}," in the Django application.",{"type":49,"tag":68,"props":15321,"children":15322},{},[15323,15325,15330,15332,15338],{"type":55,"value":15324},"An API call to ",{"type":49,"tag":326,"props":15326,"children":15328},{"className":15327},[],[15329],{"type":55,"value":14611},{"type":55,"value":15331}," is made to the Django backend directly from the Nuxt container over the docker network (",{"type":49,"tag":326,"props":15333,"children":15335},{"className":15334},[],[15336],{"type":55,"value":15337},"backend:8000",{"type":55,"value":616},{"type":49,"tag":68,"props":15340,"children":15341},{},[15342],{"type":55,"value":15343},"If the request is made by an anonymous user (no user is logged in), a 403 response is returned to the Nuxt server and no account data is set in the Vuex store (on the server).",{"type":49,"tag":68,"props":15345,"children":15346},{},[15347],{"type":55,"value":15348},"Since the user is currently not logged in, the request returns a 403 response.",{"type":49,"tag":68,"props":15350,"children":15351},{},[15352,15358,15360,15365,15367,15373,15375,15380,15382,15388],{"type":49,"tag":326,"props":15353,"children":15355},{"className":15354},[],[15356],{"type":55,"value":15357},"authMiddleware",{"type":55,"value":15359}," (on the Nuxt server) redirects the user to ",{"type":49,"tag":326,"props":15361,"children":15363},{"className":15362},[],[15364],{"type":55,"value":15234},{"type":55,"value":15366}," based on the value of ",{"type":49,"tag":326,"props":15368,"children":15370},{"className":15369},[],[15371],{"type":55,"value":15372},"authenticated",{"type":55,"value":15374}," in the Vuex store. The Original request for ",{"type":49,"tag":326,"props":15376,"children":15378},{"className":15377},[],[15379],{"type":55,"value":15059},{"type":55,"value":15381}," returns a fully-rendered ",{"type":49,"tag":326,"props":15383,"children":15385},{"className":15384},[],[15386],{"type":55,"value":15387},"/login/",{"type":55,"value":15389}," page instead.",{"type":49,"tag":68,"props":15391,"children":15392},{},[15393],{"type":55,"value":15394},"User is now on the Login page",{"type":49,"tag":68,"props":15396,"children":15397},{},[15398,15399,15405,15407,15413],{"type":55,"value":413},{"type":49,"tag":326,"props":15400,"children":15402},{"className":15401},[],[15403],{"type":55,"value":15404},"created",{"type":55,"value":15406}," hook for the Login page makes a GET request to ",{"type":49,"tag":326,"props":15408,"children":15410},{"className":15409},[],[15411],{"type":55,"value":15412},"/api/login-set-cookie/",{"type":55,"value":745},{"type":49,"tag":58,"props":15415,"children":15416},{},[15417,15419,15425],{"type":55,"value":15418},"10, 11. This endpoint calls a simple view that is decorated with ",{"type":49,"tag":326,"props":15420,"children":15422},{"className":15421},[],[15423],{"type":55,"value":15424},"@ensure_csrf_token",{"type":55,"value":745},{"type":49,"tag":8994,"props":15427,"children":15428},{"start":1180},[15429,15442,15478],{"type":49,"tag":68,"props":15430,"children":15431},{},[15432,15434,15440],{"type":55,"value":15433},"When the response returns to the browser, the ",{"type":49,"tag":326,"props":15435,"children":15437},{"className":15436},[],[15438],{"type":55,"value":15439},"csrftoken",{"type":55,"value":15441}," is set in the browser.",{"type":49,"tag":68,"props":15443,"children":15444},{},[15445,15447,15453,15455,15460,15462,15468,15470,15476],{"type":55,"value":15446},"The $apiCall function is defined in ",{"type":49,"tag":326,"props":15448,"children":15450},{"className":15449},[],[15451],{"type":55,"value":15452},"plugins/axios.js",{"type":55,"value":15454},", and it adds the ",{"type":49,"tag":326,"props":15456,"children":15458},{"className":15457},[],[15459],{"type":55,"value":15439},{"type":55,"value":15461}," cookie to the ",{"type":49,"tag":326,"props":15463,"children":15465},{"className":15464},[],[15466],{"type":55,"value":15467},"X-CSRFToken",{"type":55,"value":15469}," header of API requests. This is important for POST request where the CSRF token is required. When the user fills out their email and password in the login form, the $apiCall function is called with ",{"type":49,"tag":326,"props":15471,"children":15473},{"className":15472},[],[15474],{"type":55,"value":15475},"/api/login/",{"type":55,"value":15477}," and the email/password as credentials.",{"type":49,"tag":68,"props":15479,"children":15480},{},[15481,15483,15488],{"type":55,"value":15482},"The email and password are sent as data in the POST request to ",{"type":49,"tag":326,"props":15484,"children":15486},{"className":15485},[],[15487],{"type":55,"value":15475},{"type":55,"value":745},{"type":49,"tag":58,"props":15490,"children":15491},{},[15492,15494,15499,15501,15507,15509,15515,15516,15522,15523,15529,15530,15535,15537,15542,15544,15550],{"type":55,"value":15493},"15, 16. The ",{"type":49,"tag":326,"props":15495,"children":15497},{"className":15496},[],[15498],{"type":55,"value":15475},{"type":55,"value":15500}," URL calls the ",{"type":49,"tag":326,"props":15502,"children":15504},{"className":15503},[],[15505],{"type":55,"value":15506},"login_view",{"type":55,"value":15508}," which makes use of two functions from ",{"type":49,"tag":326,"props":15510,"children":15512},{"className":15511},[],[15513],{"type":55,"value":15514},"django.contrib.auth",{"type":55,"value":78},{"type":49,"tag":326,"props":15517,"children":15519},{"className":15518},[],[15520],{"type":55,"value":15521},"authenticate",{"type":55,"value":715},{"type":49,"tag":326,"props":15524,"children":15526},{"className":15525},[],[15527],{"type":55,"value":15528},"login",{"type":55,"value":8561},{"type":49,"tag":326,"props":15531,"children":15533},{"className":15532},[],[15534],{"type":55,"value":15521},{"type":55,"value":15536}," gets a user from the provided email/password, and the ",{"type":49,"tag":326,"props":15538,"children":15540},{"className":15539},[],[15541],{"type":55,"value":15528},{"type":55,"value":15543}," function sets an HttpOnly ",{"type":49,"tag":326,"props":15545,"children":15547},{"className":15546},[],[15548],{"type":55,"value":15549},"sessionid",{"type":55,"value":15551}," session cookie on the response.",{"type":49,"tag":8994,"props":15553,"children":15554},{"start":1232},[15555,15574,15594],{"type":49,"tag":68,"props":15556,"children":15557},{},[15558,15560,15565,15567,15572],{"type":55,"value":15559},"The HttpOnly ",{"type":49,"tag":326,"props":15561,"children":15563},{"className":15562},[],[15564],{"type":55,"value":15549},{"type":55,"value":15566}," cookie is automatically set on the browser when the ",{"type":49,"tag":326,"props":15568,"children":15570},{"className":15569},[],[15571],{"type":55,"value":15475},{"type":55,"value":15573}," request returns successfully.",{"type":49,"tag":68,"props":15575,"children":15576},{},[15577,15579,15584,15586,15592],{"type":55,"value":15578},"When this ",{"type":49,"tag":326,"props":15580,"children":15582},{"className":15581},[],[15583],{"type":55,"value":15475},{"type":55,"value":15585}," request returns successfully, a value in the ",{"type":49,"tag":326,"props":15587,"children":15589},{"className":15588},[],[15590],{"type":55,"value":15591},"auth",{"type":55,"value":15593}," Vuex module is set to keep track of the current user's logged in state.",{"type":49,"tag":68,"props":15595,"children":15596},{},[15597,15599,15604],{"type":55,"value":15598},"Next, a GET request is made to ",{"type":49,"tag":326,"props":15600,"children":15602},{"className":15601},[],[15603],{"type":55,"value":14611},{"type":55,"value":745},{"type":49,"tag":58,"props":15606,"children":15607},{},[15608,15610,15615],{"type":55,"value":15609},"20, 21. Since the ",{"type":49,"tag":326,"props":15611,"children":15613},{"className":15612},[],[15614],{"type":55,"value":15549},{"type":55,"value":15616}," cookie is set and sent along with the request automatically, this request will succeed.",{"type":49,"tag":8994,"props":15618,"children":15619},{"start":4631},[15620,15638,15650,15669],{"type":49,"tag":68,"props":15621,"children":15622},{},[15623,15624,15629,15631,15636],{"type":55,"value":14598},{"type":49,"tag":326,"props":15625,"children":15627},{"className":15626},[],[15628],{"type":55,"value":14611},{"type":55,"value":15630}," request returns, the user's account information is saved to the ",{"type":49,"tag":326,"props":15632,"children":15634},{"className":15633},[],[15635],{"type":55,"value":14650},{"type":55,"value":15637}," Vuex module. At this point, the client may redirect automatically to the home page, or user account page, dashboard, etc.",{"type":49,"tag":68,"props":15639,"children":15640},{},[15641,15643,15648],{"type":55,"value":15642},"Now logged in, the user navigates (again via Vue router) to ",{"type":49,"tag":326,"props":15644,"children":15646},{"className":15645},[],[15647],{"type":55,"value":15059},{"type":55,"value":15649},", a page that shows a paginated view of all blog posts.",{"type":49,"tag":68,"props":15651,"children":15652},{},[15653,15655,15660,15662,15668],{"type":55,"value":15654},"This page has an ",{"type":49,"tag":326,"props":15656,"children":15658},{"className":15657},[],[15659],{"type":55,"value":15166},{"type":55,"value":15661}," method which is called when the page component is created and it dispatches a Vuex action ",{"type":49,"tag":326,"props":15663,"children":15665},{"className":15664},[],[15666],{"type":55,"value":15667},"posts/fetchData",{"type":55,"value":745},{"type":49,"tag":68,"props":15670,"children":15671},{},[15672,15674,15680],{"type":55,"value":15673},"This Vuex action makes a GET request to ",{"type":49,"tag":326,"props":15675,"children":15677},{"className":15676},[],[15678],{"type":55,"value":15679},"/api/posts/",{"type":55,"value":745},{"type":49,"tag":58,"props":15682,"children":15683},{},[15684,15686,15691,15693,15699],{"type":55,"value":15685},"26, 27. ",{"type":49,"tag":326,"props":15687,"children":15689},{"className":15688},[],[15690],{"type":55,"value":15679},{"type":55,"value":15692}," uses a ",{"type":49,"tag":326,"props":15694,"children":15696},{"className":15695},[],[15697],{"type":55,"value":15698},"ModelViewSet",{"type":55,"value":15700}," and returns a paginated list of blog posts",{"type":49,"tag":8994,"props":15702,"children":15703},{"start":6006},[15704],{"type":49,"tag":68,"props":15705,"children":15706},{},[15707,15708,15713,15715,15721],{"type":55,"value":14598},{"type":49,"tag":326,"props":15709,"children":15711},{"className":15710},[],[15712],{"type":55,"value":15679},{"type":55,"value":15714}," request returns successfully, the blog post data is saved to the ",{"type":49,"tag":326,"props":15716,"children":15718},{"className":15717},[],[15719],{"type":55,"value":15720},"blog",{"type":55,"value":15722}," Vuex module.",{"type":49,"tag":430,"props":15724,"children":15726},{"id":15725},"user-story-ii-logged-in-user-opens-new-browser-window-and-revisits-posts",[15727,15729],{"type":55,"value":15728},"User story II.: Logged in user opens new browser window and revisits ",{"type":49,"tag":326,"props":15730,"children":15732},{"className":15731},[],[15733],{"type":55,"value":15059},{"type":49,"tag":8994,"props":15735,"children":15736},{"start":10142},[15737,15748,15758,15776,15808,15826,15841,15857,15883,15907],{"type":49,"tag":68,"props":15738,"children":15739},{},[15740,15742,15747],{"type":55,"value":15741},"The user closes their browser and then opens a new browser window and navigates to ",{"type":49,"tag":326,"props":15743,"children":15745},{"className":15744},[],[15746],{"type":55,"value":15059},{"type":55,"value":745},{"type":49,"tag":68,"props":15749,"children":15750},{},[15751,15756],{"type":49,"tag":326,"props":15752,"children":15754},{"className":15753},[],[15755],{"type":55,"value":15175},{"type":55,"value":15757}," is called as usual,",{"type":49,"tag":68,"props":15759,"children":15760},{},[15761,15762,15768,15770,15775],{"type":55,"value":413},{"type":49,"tag":326,"props":15763,"children":15765},{"className":15764},[],[15766],{"type":55,"value":15767},"user/fetchData",{"type":55,"value":15769}," action is called. This action makes a GET request to ",{"type":49,"tag":326,"props":15771,"children":15773},{"className":15772},[],[15774],{"type":55,"value":14611},{"type":55,"value":745},{"type":49,"tag":68,"props":15777,"children":15778},{},[15779,15780,15785,15787,15792,15794,15799,15801,15806],{"type":55,"value":413},{"type":49,"tag":326,"props":15781,"children":15783},{"className":15782},[],[15784],{"type":55,"value":14611},{"type":55,"value":15786}," request returns successfully. The ",{"type":49,"tag":326,"props":15788,"children":15790},{"className":15789},[],[15791],{"type":55,"value":15549},{"type":55,"value":15793}," cookie is passed along from the browser to the API request that is made from the Nuxt server to the backend API (",{"type":49,"tag":326,"props":15795,"children":15797},{"className":15796},[],[15798],{"type":55,"value":14611},{"type":55,"value":15800},").  User account data is then set on the Vuex ",{"type":49,"tag":326,"props":15802,"children":15804},{"className":15803},[],[15805],{"type":55,"value":14650},{"type":55,"value":15807}," module.",{"type":49,"tag":68,"props":15809,"children":15810},{},[15811,15812,15817,15819,15824],{"type":55,"value":413},{"type":49,"tag":326,"props":15813,"children":15815},{"className":15814},[],[15816],{"type":55,"value":15166},{"type":55,"value":15818}," method for the ",{"type":49,"tag":326,"props":15820,"children":15822},{"className":15821},[],[15823],{"type":55,"value":15059},{"type":55,"value":15825}," pages is called.",{"type":49,"tag":68,"props":15827,"children":15828},{},[15829,15834,15836],{"type":49,"tag":326,"props":15830,"children":15832},{"className":15831},[],[15833],{"type":55,"value":15166},{"type":55,"value":15835}," dispatches a Vuex action ",{"type":49,"tag":326,"props":15837,"children":15839},{"className":15838},[],[15840],{"type":55,"value":15667},{"type":49,"tag":68,"props":15842,"children":15843},{},[15844,15849,15851,15856],{"type":49,"tag":326,"props":15845,"children":15847},{"className":15846},[],[15848],{"type":55,"value":15667},{"type":55,"value":15850}," makes an API request to ",{"type":49,"tag":326,"props":15852,"children":15854},{"className":15853},[],[15855],{"type":55,"value":15679},{"type":55,"value":745},{"type":49,"tag":68,"props":15858,"children":15859},{},[15860,15861,15866,15868,15873,15875,15881],{"type":55,"value":413},{"type":49,"tag":326,"props":15862,"children":15864},{"className":15863},[],[15865],{"type":55,"value":15679},{"type":55,"value":15867}," request is handled by a ",{"type":49,"tag":326,"props":15869,"children":15871},{"className":15870},[],[15872],{"type":55,"value":15698},{"type":55,"value":15874}," for the ",{"type":49,"tag":326,"props":15876,"children":15878},{"className":15877},[],[15879],{"type":55,"value":15880},"Post",{"type":55,"value":15882}," model that gets blog posts and then sets them to the Vuex store (on the server) when the request returns a response (to the Nuxt server).",{"type":49,"tag":68,"props":15884,"children":15885},{},[15886,15888,15893,15894,15899,15900,15905],{"type":55,"value":15887},"Once the async data fetching is compete (",{"type":49,"tag":326,"props":15889,"children":15891},{"className":15890},[],[15892],{"type":55,"value":15175},{"type":55,"value":715},{"type":49,"tag":326,"props":15895,"children":15897},{"className":15896},[],[15898],{"type":55,"value":15166},{"type":55,"value":15874},{"type":49,"tag":326,"props":15901,"children":15903},{"className":15902},[],[15904],{"type":55,"value":15059},{"type":55,"value":15906}," page), the page HTML is rendered using the Vuex store data stored on the server. The Vuex data is sent back with the rendered HTML (I think this is how it works).",{"type":49,"tag":68,"props":15908,"children":15909},{},[15910],{"type":55,"value":15911},"Finally, the user sees the list of blog posts. The page is loaded \"at once\"; there is no waiting for data to load after loading the page initially.",{"type":49,"tag":50,"props":15913,"children":15915},{"id":15914},"discussion",[15916],{"type":55,"value":15917},"Discussion",{"type":49,"tag":430,"props":15919,"children":15921},{"id":15920},"complexity",[15922],{"type":55,"value":15923},"Complexity",{"type":49,"tag":58,"props":15925,"children":15926},{},[15927],{"type":55,"value":15928},"Is this authentication process overly complicated? When I make these diagrams, I try to make simple concept as detailed as possible, but there are a lot of distinct actions being taken in many different parts of the application and getting them all into one diagram was tricky.",{"type":49,"tag":430,"props":15930,"children":15932},{"id":15931},"httponly-session-cookies",[15933],{"type":55,"value":15934},"HttpOnly Session Cookies",{"type":49,"tag":58,"props":15936,"children":15937},{},[15938,15940,15946],{"type":55,"value":15939},"Session authentication is the officially recommended way to do authentication with Django REST Framework for clients that run in the browser. However, there seem to be lots of people using JWT with DRF and Javascript clients that run in the browser. The main argument against doing this is that the JWT must be stored in a Javascript-accessible store (localStorage or Cookies) so it can be passed with each request. Many people are also interested in trying to store JWT for authentication in HttpOnly cookies to harden client-side security. I'm very curious to know if anyone is actually doing this, and what the implementation looks like. While ",{"type":49,"tag":326,"props":15941,"children":15943},{"className":15942},[],[15944],{"type":55,"value":15945},"djangorestframework_simplejwt",{"type":55,"value":15947}," doesn't support HttpOnly, there seems to be lots of interest in doing this. I think it might be possible with a special middleware, so let me know if anyone is interested in proof-of-concept/diagram for that.",{"type":49,"tag":58,"props":15949,"children":15950},{},[15951],{"type":55,"value":15952},"Some use cases for JWT and other token authentication methods with DRF might include native mobile apps or Desktop apps. For most cases, I think session authentication with Django's built in session cookies for DRF authentication is the best option. JWTs also have no clear solution for logging out, which may be important for some security considerations. The concept of stateless authentication is interesting, but for most use cases I would argue that it is not worth doing. Let me know if anyone has thoughts on this, I'm curious to see what everyone thinks.",{"type":49,"tag":430,"props":15954,"children":15956},{"id":15955},"next-steps",[15957],{"type":55,"value":15958},"Next Steps",{"type":49,"tag":58,"props":15960,"children":15961},{},[15962],{"type":55,"value":15963},"My next steps for this project/repo are to deploy this to a production environment as soon as I have time to do so. My local setup has been working well, and I think it should work well for a simple DigitalOcean docker swarm deployment like I have done with other Django + Vue projects.",{"type":49,"tag":58,"props":15965,"children":15966},{},[15967],{"type":55,"value":15968},"I also want to add the create, update and delete functionality for posts, improve error handling with API calls, add form validation, and maybe write some tests with Jest.",{"type":49,"tag":50,"props":15970,"children":15972},{"id":15971},"questions",[15973],{"type":55,"value":15974},"Questions",{"type":49,"tag":58,"props":15976,"children":15977},{},[15978],{"type":55,"value":15979},"Here are some questions and areas that I still need to investigate.",{"type":49,"tag":430,"props":15981,"children":15983},{"id":15982},"nuxt-composition-api",[15984],{"type":55,"value":15985},"Nuxt Composition API",{"type":49,"tag":58,"props":15987,"children":15988},{},[15989],{"type":55,"value":15990},"I have seen that there is a Composition API module for Nuxt. I have only just now started looking at Composition API examples and documentation for \"vanilla\" Vue, but I have heard that the Nuxt Composition API module has some additional features specifically for use with Nuxt, so I'm curious to learn what these are.",{"type":49,"tag":430,"props":15992,"children":15994},{"id":15993},"nuxt-v3-and-vue-3",[15995],{"type":55,"value":15996},"Nuxt v3 and Vue 3",{"type":49,"tag":58,"props":15998,"children":15999},{},[16000],{"type":55,"value":16001},"Nuxt looks like it has plans to support Vue 3, so I am interested to learn more about Vue 3 as it is adopted by Vue frameworks such as Nuxt and Quasar.",{"type":49,"tag":430,"props":16003,"children":16005},{"id":16004},"nuxts-fetch-method-server-middleware-nuxt-auth-module",[16006],{"type":55,"value":16007},"Nuxt's fetch method, server middleware, Nuxt auth module",{"type":49,"tag":58,"props":16009,"children":16010},{},[16011],{"type":55,"value":16012},"I think I am using server middleware correctly, it can be improved by redirecting to the initial requested route after successful login. I'm not sure if I should use the Nuxt auth module in this application, I have read that it doesn't support HttpOnly cookie use cases, but I could be wrong.",{"title":8,"searchDepth":1079,"depth":1079,"links":16014},[16015,16016,16022,16028,16033],{"id":14059,"depth":1079,"text":14062},{"id":14969,"depth":1079,"text":14972,"children":16017},[16018,16019,16020,16021],{"id":14980,"depth":1088,"text":14983},{"id":15019,"depth":1088,"text":15022},{"id":15079,"depth":1088,"text":15082},{"id":15095,"depth":1088,"text":15098},{"id":14090,"depth":1079,"text":14093,"children":16023},[16024,16026],{"id":15218,"depth":1088,"text":16025},"User story I.: A user tries to open /posts, is redirected to /login, logs in, then navigate to /posts and sees blog posts",{"id":15725,"depth":1088,"text":16027},"User story II.: Logged in user opens new browser window and revisits /posts",{"id":15914,"depth":1079,"text":15917,"children":16029},[16030,16031,16032],{"id":15920,"depth":1088,"text":15923},{"id":15931,"depth":1088,"text":15934},{"id":15955,"depth":1088,"text":15958},{"id":15971,"depth":1079,"text":15974,"children":16034},[16035,16036,16037],{"id":15982,"depth":1088,"text":15985},{"id":15993,"depth":1088,"text":15996},{"id":16004,"depth":1088,"text":16007},"content:2021:01:01:session-authentication-with-django-django-rest-framework-and-nuxt.md","2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt.md","2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt",{"_path":16042,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":16043,"description":16044,"date":16045,"image":16046,"tags":16047,"body":16048,"_type":7809,"_id":16636,"_source":7811,"_file":16637,"_stem":16638,"_extension":7814},"/2020/12/27/building-web-applications-with-django-drf-and-nuxt","Building web applications with Django, Django REST Framework, Nuxt.js and docker","This article documents my progress combining the Django web framework with Nuxt JS to build applications that have both great SEO and a smooth SPA user experience.","2020-12-27T00:00:00.000Z","/static/django_nuxt_app_diagram.png",[14,13929,14911,14037,24],{"type":46,"children":16049,"toc":16629},[16050,16055,16085,16095,16100,16106,16112,16117,16144,16149,16154,16159,16171,16176,16181,16187,16222,16242,16545,16549,16554,16559,16565,16596,16601,16606,16619,16624],{"type":49,"tag":58,"props":16051,"children":16052},{},[16053],{"type":55,"value":16054},"Over the holidays between lots of big meals and many naps, I tried to tackle one more goal of mine before this year come to an end: building an application with Django and Nuxt.js.",{"type":49,"tag":58,"props":16056,"children":16057},{},[16058,16060,16066,16068,16074,16076,16083],{"type":55,"value":16059},"This year I rebuilt my personal blog (",{"type":49,"tag":80,"props":16061,"children":16064},{"href":16062,"rel":16063},"https://briancaffey.github.io/",[84],[16065],{"type":55,"value":15042},{"type":55,"value":16067},") with Nuxt.js, the ",{"type":49,"tag":326,"props":16069,"children":16071},{"className":16070},[],[16072],{"type":55,"value":16073},"@nuxt/content",{"type":55,"value":16075}," headless git-based CMS and TailwindCSS. It is statically generated with Nuxt's full-static mode and has been really enjoyable to work with. I have also learned a lot more about SEO and how Nuxt helps improve Vue applications' SEO. I have also been working a lot with Django and Vue.js applications where Django serves as an API to a Vue.js SPA. This combination of technologies works well for a lot of use cases, but it falls short in SEO. Nuxt also provides a great way to organize large Vue.js projects which I have been finding very helpful. For these reasons, combining Django and Nuxt has been something that I have wanted to try for a while, so this article will share some of my experiences in recent efforts to build with these two frameworks. I took ",{"type":49,"tag":80,"props":16077,"children":16080},{"href":16078,"rel":16079},"https://gitlab.com/briancaffey/django-nuxt-starter/-/blob/develop/STEP_BY_STEP.md",[84],[16081],{"type":55,"value":16082},"detailed notes of each step of the project setup",{"type":55,"value":16084}," starting from an empty repository, and I put together a diagram of my understanding of how data flows in the application.",{"type":49,"tag":58,"props":16086,"children":16087},{},[16088,16090],{"type":55,"value":16089},"Here's the link to the project repository that I'll be referencing: ",{"type":49,"tag":80,"props":16091,"children":16093},{"href":14929,"rel":16092},[84],[16094],{"type":55,"value":14929},{"type":49,"tag":58,"props":16096,"children":16097},{},[16098],{"type":55,"value":16099},"This article will focus on explaining the project through the diagram shown below. I added two types of labels: letters and numbers. The letters will introduce each component of the application and its role in the application as a whole. The numbers summarize how data flows through the different components in my sample blog application.",{"type":49,"tag":58,"props":16101,"children":16102},{},[16103],{"type":49,"tag":1601,"props":16104,"children":16105},{"alt":14093,"src":16046},[],{"type":49,"tag":50,"props":16107,"children":16109},{"id":16108},"diagram-components",[16110],{"type":55,"value":16111},"Diagram components",{"type":49,"tag":58,"props":16113,"children":16114},{},[16115],{"type":55,"value":16116},"A. Your computer - Possibly also your development machine which is running the application in docker containers with docker-compose.",{"type":49,"tag":58,"props":16118,"children":16119},{},[16120,16122,16128,16129,16135,16136,16142],{"type":55,"value":16121},"B. NGINX - This is the \"front desk\" of the application that does a few different things. It is the first component that web requests come to. It serves as a reverse proxy which does path-based routing. It looks at the URL request and determines where to send it. For example: ",{"type":49,"tag":326,"props":16123,"children":16125},{"className":16124},[],[16126],{"type":55,"value":16127},"/api/posts/1",{"type":55,"value":873},{"type":49,"tag":326,"props":16130,"children":16132},{"className":16131},[],[16133],{"type":55,"value":16134},"/dashboard/",{"type":55,"value":873},{"type":49,"tag":326,"props":16137,"children":16139},{"className":16138},[],[16140],{"type":55,"value":16141},"/admin/",{"type":55,"value":16143}," could all be routed differently depending on the NGINX configuration file. We will look at this again in the next section. This  component, like most of the other things in the diagram, runs in a container. NGINX can also serve static files for our Django app and do TLS termination to make our application available over a secure HTTPS connection.",{"type":49,"tag":58,"props":16145,"children":16146},{},[16147],{"type":55,"value":16148},"C. Nuxt.JS server - The first \"S\" in SSR (server side rendering). It is a Node.js process that renders HTML from Vue components that we define in our Nuxt app, as well as data fetched from other servers/APIs before returning HTML back to the client.",{"type":49,"tag":58,"props":16150,"children":16151},{},[16152],{"type":55,"value":16153},"D. Django server - This runs the WSGI application with a gunicorn process in a container.",{"type":49,"tag":58,"props":16155,"children":16156},{},[16157],{"type":55,"value":16158},"E. Django REST Framework is a Django package the facilitates the creation of REST API endpoints. This is part of the Django application, it primarily takes care of data serialization (which can be thought of as translating between JSON and Python objects that represent rows of data in our Postgres database)",{"type":49,"tag":58,"props":16160,"children":16161},{},[16162,16164,16170],{"type":55,"value":16163},"F. This is the Postgres database, also a containerized service. It is on the same docker network as the Django/gunicorn application, so the Django application can connect to the Postgres database using the hostname ",{"type":49,"tag":326,"props":16165,"children":16167},{"className":16166},[],[16168],{"type":55,"value":16169},"postgres",{"type":55,"value":745},{"type":49,"tag":58,"props":16172,"children":16173},{},[16174],{"type":55,"value":16175},"G. docker-compose is used to orchestrate the docker network, containers and volumes that make up the application.",{"type":49,"tag":58,"props":16177,"children":16178},{},[16179],{"type":55,"value":16180},"H. This box represents the docker network that allows for easy networking between services. We will come back to this the significance of this in the next section.",{"type":49,"tag":50,"props":16182,"children":16184},{"id":16183},"data-flow-in-the-application",[16185],{"type":55,"value":16186},"Data flow in the application",{"type":49,"tag":58,"props":16188,"children":16189},{},[16190,16192,16198,16200,16205,16207,16213,16215,16221],{"type":55,"value":16191},"The simple application I have built for this demonstration is a blog. There is only a list view and a detail view for simple blog post model with three fields: title, body and created date. For the list view, the frontend (Nuxt) route is ",{"type":49,"tag":326,"props":16193,"children":16195},{"className":16194},[],[16196],{"type":55,"value":16197},"/posts/",{"type":55,"value":16199}," and the backend route is ",{"type":49,"tag":326,"props":16201,"children":16203},{"className":16202},[],[16204],{"type":55,"value":15679},{"type":55,"value":16206}," for the detail view the frontend route is ",{"type":49,"tag":326,"props":16208,"children":16210},{"className":16209},[],[16211],{"type":55,"value":16212},"/posts/_id",{"type":55,"value":16214}," and the API route is ",{"type":49,"tag":326,"props":16216,"children":16218},{"className":16217},[],[16219],{"type":55,"value":16220},"/api/posts/_id/",{"type":55,"value":745},{"type":49,"tag":58,"props":16223,"children":16224},{},[16225,16227,16233,16235,16241],{"type":55,"value":16226},"The data flow shown here will walk through what happens when a user visits ",{"type":49,"tag":326,"props":16228,"children":16230},{"className":16229},[],[16231],{"type":55,"value":16232},"http://localhost/posts/",{"type":55,"value":16234},", and then show what happens when the user clicks on one of the listed posts to see the detail view of the post (",{"type":49,"tag":326,"props":16236,"children":16238},{"className":16237},[],[16239],{"type":55,"value":16240},"http://localhost/posts/2",{"type":55,"value":3213},{"type":49,"tag":8994,"props":16243,"children":16245},{"start":16244},0,[16246,16257,16269,16287,16299,16350,16378,16397,16402,16407,16418,16509],{"type":49,"tag":68,"props":16247,"children":16248},{},[16249,16255],{"type":49,"tag":326,"props":16250,"children":16252},{"className":16251},[],[16253],{"type":55,"value":16254},"docker-compose up",{"type":55,"value":16256}," is one command that is used to start the entire application in local development. This exposes the NGINX process on port 80 of the host machine (your laptop).",{"type":49,"tag":68,"props":16258,"children":16259},{},[16260,16262,16267],{"type":55,"value":16261},"When the application is running on your machine and you navigate to ",{"type":49,"tag":326,"props":16263,"children":16265},{"className":16264},[],[16266],{"type":55,"value":16232},{"type":55,"value":16268},", the request is first handled by NGINX.",{"type":49,"tag":68,"props":16270,"children":16271},{},[16272,16274,16279,16280,16285],{"type":55,"value":16273},"As we mentioned earlier, NGINX's path-based routing sends all requests that do not start with ",{"type":49,"tag":326,"props":16275,"children":16277},{"className":16276},[],[16278],{"type":55,"value":3196},{"type":55,"value":8634},{"type":49,"tag":326,"props":16281,"children":16283},{"className":16282},[],[16284],{"type":55,"value":3203},{"type":55,"value":16286}," to the Nuxt.js server.",{"type":49,"tag":68,"props":16288,"children":16289},{},[16290,16292,16297],{"type":55,"value":16291},"When the request gets to the Nuxt server, the Nuxt lifecycle methods start. The important one that I'm using so far is ",{"type":49,"tag":326,"props":16293,"children":16295},{"className":16294},[],[16296],{"type":55,"value":15166},{"type":55,"value":16298},". This property is used to request data that will be used in the rendering of our HTML response.",{"type":49,"tag":68,"props":16300,"children":16301},{},[16302,16304,16309,16311,16316,16318,16324,16326,16332,16334,16340,16342,16348],{"type":55,"value":16303},"Inside of ",{"type":49,"tag":326,"props":16305,"children":16307},{"className":16306},[],[16308],{"type":55,"value":15166},{"type":55,"value":16310},", the application uses axios to make a request to ",{"type":49,"tag":326,"props":16312,"children":16314},{"className":16313},[],[16315],{"type":55,"value":15679},{"type":55,"value":16317}," (for example). In ",{"type":49,"tag":326,"props":16319,"children":16321},{"className":16320},[],[16322],{"type":55,"value":16323},"nuxt.config.js",{"type":55,"value":16325},", the ",{"type":49,"tag":326,"props":16327,"children":16329},{"className":16328},[],[16330],{"type":55,"value":16331},"privateRuntimeConfig",{"type":55,"value":16333}," sets a baseUrl value for axios to ",{"type":49,"tag":326,"props":16335,"children":16337},{"className":16336},[],[16338],{"type":55,"value":16339},"http://backend:8000",{"type":55,"value":16341},". Since the Nuxt server is on the same docker network as the backend Django/gunicorn server, the Nuxt server is able to resolve ",{"type":49,"tag":326,"props":16343,"children":16345},{"className":16344},[],[16346],{"type":55,"value":16347},"http://backend",{"type":55,"value":16349}," to the address of the backend server.",{"type":49,"tag":68,"props":16351,"children":16352},{},[16353,16355,16361,16363,16369,16371,16377],{"type":55,"value":16354},"Django processes this endpoint, using the ",{"type":49,"tag":326,"props":16356,"children":16358},{"className":16357},[],[16359],{"type":55,"value":16360},"PostViewSet",{"type":55,"value":16362},", the views of which have been added to ",{"type":49,"tag":326,"props":16364,"children":16366},{"className":16365},[],[16367],{"type":55,"value":16368},"urlpatterns",{"type":55,"value":16370}," in ",{"type":49,"tag":326,"props":16372,"children":16374},{"className":16373},[],[16375],{"type":55,"value":16376},"blog/urls.py",{"type":55,"value":745},{"type":49,"tag":68,"props":16379,"children":16380},{},[16381,16382,16387,16389,16395],{"type":55,"value":413},{"type":49,"tag":326,"props":16383,"children":16385},{"className":16384},[],[16386],{"type":55,"value":16360},{"type":55,"value":16388}," makes a database query on the ",{"type":49,"tag":326,"props":16390,"children":16392},{"className":16391},[],[16393],{"type":55,"value":16394},"posts",{"type":55,"value":16396}," which is used to serialize the data.",{"type":49,"tag":68,"props":16398,"children":16399},{},[16400],{"type":55,"value":16401},"The Django server returns the response to the original axios call.",{"type":49,"tag":68,"props":16403,"children":16404},{},[16405],{"type":55,"value":16406},"The data returned from Django is used to render the HTML response.",{"type":49,"tag":68,"props":16408,"children":16409},{},[16410,16412,16417],{"type":55,"value":16411},"The HTML response from the Nuxt server is sent back to the browser that originally navigated to ",{"type":49,"tag":326,"props":16413,"children":16415},{"className":16414},[],[16416],{"type":55,"value":16232},{"type":55,"value":745},{"type":49,"tag":68,"props":16419,"children":16420},{},[16421,16423,16429,16431,16437,16439,16445,16447,16453,16455,16461,16463,16468,16470,16476,16478,16484,16486,16492,16494,16500,16502,16507],{"type":55,"value":16422},"The user is presented with page that lists blog posts. Each blog posts lists to a detail view. When a blog post (let's say the post with ",{"type":49,"tag":326,"props":16424,"children":16426},{"className":16425},[],[16427],{"type":55,"value":16428},"id",{"type":55,"value":16430}," of 2) is clicked on, a request for ",{"type":49,"tag":326,"props":16432,"children":16434},{"className":16433},[],[16435],{"type":55,"value":16436},"/posts/2/",{"type":55,"value":16438}," is made directly to the Django backend. The ",{"type":49,"tag":326,"props":16440,"children":16442},{"className":16441},[],[16443],{"type":55,"value":16444},"browserBaseURL",{"type":55,"value":16446}," value in the ",{"type":49,"tag":326,"props":16448,"children":16450},{"className":16449},[],[16451],{"type":55,"value":16452},"axios",{"type":55,"value":16454}," settings under ",{"type":49,"tag":326,"props":16456,"children":16458},{"className":16457},[],[16459],{"type":55,"value":16460},"publicRuntimeConfig",{"type":55,"value":16462}," defined in ",{"type":49,"tag":326,"props":16464,"children":16466},{"className":16465},[],[16467],{"type":55,"value":16323},{"type":55,"value":16469}," is set to ",{"type":49,"tag":326,"props":16471,"children":16473},{"className":16472},[],[16474],{"type":55,"value":16475},"http://localhost",{"type":55,"value":16477},", so the request is made to ",{"type":49,"tag":326,"props":16479,"children":16481},{"className":16480},[],[16482],{"type":55,"value":16483},"http://localhost/api/posts/2/",{"type":55,"value":16485},". To clarify, since we are making this request using axios in the browser, we can't make a request to ",{"type":49,"tag":326,"props":16487,"children":16489},{"className":16488},[],[16490],{"type":55,"value":16491},"http://backend:8000/api/posts/2/",{"type":55,"value":16493}," like we did in step 4 (",{"type":49,"tag":326,"props":16495,"children":16497},{"className":16496},[],[16498],{"type":55,"value":16499},"http://backend:8000/api/posts/",{"type":55,"value":16501},") because the browser doesn't know how to resolve the ",{"type":49,"tag":326,"props":16503,"children":16505},{"className":16504},[],[16506],{"type":55,"value":1951},{"type":55,"value":16508}," hostname.",{"type":49,"tag":68,"props":16510,"children":16511},{},[16512,16514,16519,16521,16527,16529,16535,16537,16543],{"type":55,"value":16513},"This request to ",{"type":49,"tag":326,"props":16515,"children":16517},{"className":16516},[],[16518],{"type":55,"value":16483},{"type":55,"value":16520},", like all others, first goes to NGINX which sends it to the backend since the path starts with ",{"type":49,"tag":326,"props":16522,"children":16524},{"className":16523},[],[16525],{"type":55,"value":16526},"/api/",{"type":55,"value":16528},". At this point the application functions like a regular Vue SPA making axios calls to a backend service. This is because we used ",{"type":49,"tag":326,"props":16530,"children":16532},{"className":16531},[],[16533],{"type":55,"value":16534},"\u003Cnuxt-link>",{"type":55,"value":16536}," for the posts listed in the posts list view. If we used ",{"type":49,"tag":326,"props":16538,"children":16540},{"className":16539},[],[16541],{"type":55,"value":16542},"\u003Ca>",{"type":55,"value":16544}," tags, we would go through the same process as in step 4 where the HTML is rendered on the Nuxt server and sent back to the browser all at once.",{"type":49,"tag":50,"props":16546,"children":16547},{"id":15914},[16548],{"type":55,"value":15917},{"type":49,"tag":58,"props":16550,"children":16551},{},[16552],{"type":55,"value":16553},"My main takeaway is that using Nuxt and Django together can give you good SEO and a great SPA experience at the same time. Using Django alone, or Django with traditional non SSR Vue makes this harder to do. Being a progressive framework, there are a lot of ways to use Vue with any other backend. From what I have heard, most people use Vue via CDN similar to how jQuery was and still is delivered for use in the browser.",{"type":49,"tag":58,"props":16555,"children":16556},{},[16557],{"type":55,"value":16558},"There is additional work in setting up 3 servers for a single application (Nuxt, Django and NGINX), but the tradeoff is that I am (at least I feel) very productive writing frontend logic in Vue and backend logic with DRF. I have never liked working with Django templates and I used to know a lot more about them than I do now.",{"type":49,"tag":50,"props":16560,"children":16562},{"id":16561},"spotlight-for-baserowios-awesome-open-source-django-nuxt-application",[16563],{"type":55,"value":16564},"Spotlight for baserow.io's awesome open-source Django Nuxt application",{"type":49,"tag":58,"props":16566,"children":16567},{},[16568,16570,16577,16579,16586,16588,16594],{"type":55,"value":16569},"Lastly I want to mention that there are some great resources in the ",{"type":49,"tag":80,"props":16571,"children":16574},{"href":16572,"rel":16573},"https://github.com/nuxt-community/awesome-nuxt",[84],[16575],{"type":55,"value":16576},"nuxt-community/awesome-nuxt",{"type":55,"value":16578}," GitHub repo. There's one project that really stood out to me when I searched for \"django\" projects in the README, and that project is called ",{"type":49,"tag":80,"props":16580,"children":16583},{"href":16581,"rel":16582},"https://baserow.io/",[84],[16584],{"type":55,"value":16585},"baserow.io",{"type":55,"value":16587}," (repo: ",{"type":49,"tag":80,"props":16589,"children":16592},{"href":16590,"rel":16591},"https://gitlab.com/bramw/baserow",[84],[16593],{"type":55,"value":16590},{"type":55,"value":16595},"). Please check this repo our if you are interested in Django and Nuxt. This company is building an open source no-code database, similar to Airtable which I have worked with before.",{"type":49,"tag":58,"props":16597,"children":16598},{},[16599],{"type":55,"value":16600},"Their entire product is open source and I have been very impressed with what I have seen. Please go give that project a star or consider becoming a Github sponsor if you are interested. I'm not affiliated with that project in any way, but I'll be referencing how they use Django and Nuxt to build their application.",{"type":49,"tag":50,"props":16602,"children":16603},{"id":15955},[16604],{"type":55,"value":16605},"Next steps",{"type":49,"tag":58,"props":16607,"children":16608},{},[16609,16611,16617],{"type":55,"value":16610},"There is a still a lot I have to learn about Nuxt. I'm still very new to the Framework and this is my first time using Nuxt's SSR mode. Nuxt seems to have its own way of doing lots of things that I'm used to doing in Vue. There is a very supportive community and well-maintained official packages to help with lots of things, like the ",{"type":49,"tag":326,"props":16612,"children":16614},{"className":16613},[],[16615],{"type":55,"value":16616},"@nuxt/axios",{"type":55,"value":16618}," package that I'm using.",{"type":49,"tag":58,"props":16620,"children":16621},{},[16622],{"type":55,"value":16623},"My next step is to keep expanding my blog application. One thing I didn't mention is authentication. I plan on using Django session authentication for authenticating request to Django. It seems that it already works correctly in my application (logging in through Django admin and then navigating to Nuxt routes that make Django requests are working only when I'm logged in.) I think I have an idea about how Vuex, authentication and route guards will work together, but I haven't gotten there yet. If anyone has some good reference projects or recommendations on how to expand on what I already have, please let me know!",{"type":49,"tag":58,"props":16625,"children":16626},{},[16627],{"type":55,"value":16628},"I know that Nuxt has an auth module, so I need to see if that is relevant for what I want need in my application. I also need to continue reading the Nuxt documentation. I still don't know what I don't know about Nuxt and the plugins and modules that it makes available. I also noticed that Nuxt has it's own version of the Vue 3 Composition API, something I am just now starting to learn more about, so that it another area I'll need to dig into eventually.",{"title":8,"searchDepth":1079,"depth":1079,"links":16630},[16631,16632,16633,16634,16635],{"id":16108,"depth":1079,"text":16111},{"id":16183,"depth":1079,"text":16186},{"id":15914,"depth":1079,"text":15917},{"id":16561,"depth":1079,"text":16564},{"id":15955,"depth":1079,"text":16605},"content:2020:12:27:building-web-applications-with-django-drf-and-nuxt.md","2020/12/27/building-web-applications-with-django-drf-and-nuxt.md","2020/12/27/building-web-applications-with-django-drf-and-nuxt",{"_path":16640,"_dir":16641,"_draft":7,"_partial":7,"_locale":8,"title":16642,"description":16643,"date":16644,"image":16645,"tags":16646,"body":16649,"_type":7809,"_id":16866,"_source":7811,"_file":16867,"_stem":16868,"_extension":7814},"/2020/11/29/weekend-project-update-open-sec-data","29","Weekend project update: Open SEC Data","This project uses Django, DRF and Celery to read public SEC filings from sec.gov, build it into an API which is consumed through a Vue.js application.","2020-11-29T00:00:00.000Z","/static/sec-update.jpg",[14,13929,3995,16647,16648,24,3261],"api","gitlab",{"type":46,"children":16650,"toc":16864},[16651,16656,16691,16705,16710,16794,16799],{"type":49,"tag":58,"props":16652,"children":16653},{},[16654],{"type":55,"value":16655},"Here's an early look at a project I have been working on to practice some Django and Vue.js concepts: Open SEC Data.",{"type":49,"tag":64,"props":16657,"children":16658},{},[16659,16670,16680],{"type":49,"tag":68,"props":16660,"children":16661},{},[16662,16668],{"type":49,"tag":80,"props":16663,"children":16666},{"href":16664,"rel":16665},"https://opensecdata.ga",[84],[16667],{"type":55,"value":16664},{"type":55,"value":16669}," (project staging website, deployed to docker swarm cluster running on DigitalOcean)",{"type":49,"tag":68,"props":16671,"children":16672},{},[16673,16678],{"type":49,"tag":80,"props":16674,"children":16676},{"href":14083,"rel":16675},[84],[16677],{"type":55,"value":14083},{"type":55,"value":16679}," (main repository, requires GitLab account)",{"type":49,"tag":68,"props":16681,"children":16682},{},[16683,16689],{"type":49,"tag":80,"props":16684,"children":16687},{"href":16685,"rel":16686},"https://github.com/briancaffey/sec-filings-app",[84],[16688],{"type":55,"value":16685},{"type":55,"value":16690}," (mirror, no account required to view)",{"type":49,"tag":58,"props":16692,"children":16693},{},[16694,16696,16703],{"type":55,"value":16695},"This project uses Django, DRF and Celery to read public SEC filings from ",{"type":49,"tag":80,"props":16697,"children":16700},{"href":16698,"rel":16699},"https://www.sec.gov/Archives/edgar/full-index/",[84],[16701],{"type":55,"value":16702},"sec.gov",{"type":55,"value":16704},", build it into an API which is consumed through a Vue.js application. I'm currently focused on 13F filings which are required for large US investment funds managing over $100 million USD. There is data dating back to 1993 and it is published quarterly.",{"type":49,"tag":58,"props":16706,"children":16707},{},[16708],{"type":55,"value":16709},"Here are some of the things I'm focusing on in this project in no particular order:",{"type":49,"tag":64,"props":16711,"children":16712},{},[16713,16718,16723,16728,16733,16738,16743,16764,16784,16789],{"type":49,"tag":68,"props":16714,"children":16715},{},[16716],{"type":55,"value":16717},"Getting better at Django REST Framework. This project has been helping me apply some of the parts of DRF that I have found difficult. I'm currently using ViewSets which feels function-based views inside of class-based views. They are flexible, but I would like to add more abstraction with filtering",{"type":49,"tag":68,"props":16719,"children":16720},{},[16721],{"type":55,"value":16722},"Django admin. While this project primarily uses Django as a REST API with Django REST Framework, I have tried to take advantage of the Django admin to build out helpful views that can be used to spot check the data I'm creating. Most of my API is read-only, this makes things pretty simple.",{"type":49,"tag":68,"props":16724,"children":16725},{},[16726],{"type":55,"value":16727},"Moderately complex paginated data tables with Vue. I work with lots of paginated table data, and I think there is a better way to do abstract some of the repeated logic that I use (getting and setting current page, rows per page). I'm using Vuex, and I have heard of module factories, but I'm thinking that there will be a better way to do this when Vue 3 officially comes to Quasar Framework (Quasar is a Vue.js framework).",{"type":49,"tag":68,"props":16729,"children":16730},{},[16731],{"type":55,"value":16732},"Session authentication with DRF. There are a lot of guides showing how to use JWT and Token Authentication for DRF with Javascript frontends. The DRF recommends using Session Authentication for such use cases as a web-base Javascript client, so I hope I can promote some best practices around how to use Django's built-in session authentication for use with the Django REST Framework using an HttpOnly session cookie. I also understand that all security decisions have trade-offs, and I'm trying to understand what trade-offs come with handling authentication in this way.",{"type":49,"tag":68,"props":16734,"children":16735},{},[16736],{"type":55,"value":16737},"Social authentication. I have previously setup social authentication with Google, Facebook and GitHub using Python Social Auth. I think it is a great package, and it adds a lot of flexibility with it's concept of pipelines, but I haven't done much with these yet, so I'm hoping to dig in further and better understand how I can make better use of social authentication in my app. This app uses Linkedin 0Auth2 with a custom user model. Logging in with Linkedin account gives you the ability to request an API Token (Django REST Framework's Token) to access the public API.",{"type":49,"tag":68,"props":16739,"children":16740},{},[16741],{"type":55,"value":16742},"Automatic API documentation with OpenAPI. Swagger/OpenAPI seems like nice way to document and API, so I'm hoping to build best practices around how to document a DRF API automatically with OpenAPI and Swagger UI.",{"type":49,"tag":68,"props":16744,"children":16745},{},[16746,16748,16754,16756,16762],{"type":55,"value":16747},"CI/CD with GitLab and docker swarm. I will admit that I am huge GitLab fan. I love how flexible their CI/CD pipelines are. Being a docker fan as well, I chose to use docker swarm for this project to keep things simple and straightforward. I think one under-appreciate feature of docker is being able to set ",{"type":49,"tag":326,"props":16749,"children":16751},{"className":16750},[],[16752],{"type":55,"value":16753},"DOCKER_HOST",{"type":55,"value":16755}," to an SSH connection, such as ",{"type":49,"tag":326,"props":16757,"children":16759},{"className":16758},[],[16760],{"type":55,"value":16761},"ssh://root@123.456.789.10",{"type":55,"value":16763},". This let's you control the remote docker host without needing to SSH to it first, and it is also how I'm able to deploy and run management commands \"manually\" through the GitLab UI.",{"type":49,"tag":68,"props":16765,"children":16766},{},[16767,16769,16775,16776,16782],{"type":55,"value":16768},"Productive development environment. To start the project, you only need to run docker-compose up (after copying ",{"type":49,"tag":326,"props":16770,"children":16772},{"className":16771},[],[16773],{"type":55,"value":16774},".env.template",{"type":55,"value":12789},{"type":49,"tag":326,"props":16777,"children":16779},{"className":16778},[],[16780],{"type":55,"value":16781},".env",{"type":55,"value":16783}," in the root directory for storing sensitive data outside of git such as LinkedIn OAuth2 keys). The development environment is very similar to how this project runs in production with some additional utilities for monitoring and debugging such as pgadmin4, flower (for celery), redis commander (a GUI for viewing redis databases), Django debug toolbar (a must have for any Django project, I believe), runserver_plus with Werkzeug, and others. Also, the backend and frontend hot reload automatically with the help of webpack for Vue and watchdog for Django and Celery.",{"type":49,"tag":68,"props":16785,"children":16786},{},[16787],{"type":55,"value":16788},"Automatic TLS certificate generation with Traefik. For a simple project in docker swarm, I'm really happy with how simple it is to request TLS certificates from Let's Encrypt automatically with Traefik. There are no scripts, cron jobs or one-time setup jobs, it just seems to work out of the box if configured correctly.",{"type":49,"tag":68,"props":16790,"children":16791},{},[16792],{"type":55,"value":16793},"Testing with pytest. I have only been trying to test most of my API views so far. I really like using factory with pytest, so I use that in most of my tests.",{"type":49,"tag":58,"props":16795,"children":16796},{},[16797],{"type":55,"value":16798},"That's all I have for now. I have a long list of questions, things I want to improve, add and experiment with, here are just a few that come to mind:",{"type":49,"tag":64,"props":16800,"children":16801},{},[16802,16807,16812,16825,16830,16835,16840,16845],{"type":49,"tag":68,"props":16803,"children":16804},{},[16805],{"type":55,"value":16806},"Frontend testing. I don't have any component testing or e2d tests, so this would be good to add eventually. Since I'm using a component library and my app uses these components directly, I'm not exactly sure how much testing I should be doing.",{"type":49,"tag":68,"props":16808,"children":16809},{},[16810],{"type":55,"value":16811},"Data verification/validation. There are a lot of site that do provide similar data, WhaleWisdom is the biggest one that I know of. Once I get more data built on the site it would be good to spot check some of the values. There are some nuances to the filing data that I haven't addressed, such as Amendment filings and additions.",{"type":49,"tag":68,"props":16813,"children":16814},{},[16815,16817,16824],{"type":55,"value":16816},"Calculating period changes. One of the features that I'm not sure how best to implement is the ability to sort holdings for a filer in a given period on the percent increase from the last period. One way would be to add these as additional fields to the Holding model and then calculate these values as I process the data in celery. If I process the data from recent periods to later periods, I will have to update these values once the previous period has been processed, so it would be an additional check to do. I'll probably post this question here in more detail later. Here's ",{"type":49,"tag":80,"props":16818,"children":16821},{"href":16819,"rel":16820},"https://whalewisdom.com/filer/ubs-ag#tabholdings_tab_link",[84],[16822],{"type":55,"value":16823},"an example of what this means from WhaleWisdom",{"type":55,"value":745},{"type":49,"tag":68,"props":16826,"children":16827},{},[16828],{"type":55,"value":16829},"Accessing LinkedIn profile data to populate fields on my CustomUser model.",{"type":49,"tag":68,"props":16831,"children":16832},{},[16833],{"type":55,"value":16834},"Scaling? I have a lot more experience with deploying projects to AWS which is built around the ability to scale. I don't know a project on DigitalOcean would be scaled automatically. A single node docker swarm cluster while take some time to process all of the data. I would probably be better of scaling vertically with much bigger droplets and higher celery concurrency.",{"type":49,"tag":68,"props":16836,"children":16837},{},[16838],{"type":55,"value":16839},"Docker swarm secrets. I'm currently using environment variables to pass secrets stored in GitLab CI when I build images and deploy to docker swarm. I would like to learn how to properly use swarm secrets and work them into my CI/CD pipeline.",{"type":49,"tag":68,"props":16841,"children":16842},{},[16843],{"type":55,"value":16844},"As I mentioned above, I'm also interested in updating this project to Vue3 and to apply some of its new features to this project.",{"type":49,"tag":68,"props":16846,"children":16847},{},[16848,16850,16855,16857,16863],{"type":55,"value":16849},"Use pipenv, poetry or some other way of pinning secondary python dependencies. Does anyone have a recommendation on how best to do this with docker. I have always thought that docker ",{"type":49,"tag":126,"props":16851,"children":16852},{},[16853],{"type":55,"value":16854},"is",{"type":55,"value":16856}," the virtual environment, but I realize that some versions of indirect dependencies may change when pip installing without using a lockfile similar to ",{"type":49,"tag":326,"props":16858,"children":16860},{"className":16859},[],[16861],{"type":55,"value":16862},"package-lock.json",{"type":55,"value":745},{"title":8,"searchDepth":1079,"depth":1079,"links":16865},[],"content:2020:11:29:weekend-project-update-open-sec-data.md","2020/11/29/weekend-project-update-open-sec-data.md","2020/11/29/weekend-project-update-open-sec-data",{"_path":16870,"_dir":7817,"_draft":7,"_partial":7,"_locale":8,"title":16871,"description":16872,"layout":16873,"date":16874,"comments":44,"image":16875,"tags":16876,"body":16877,"_type":7809,"_id":17580,"_source":7811,"_file":17581,"_stem":17582,"_extension":7814},"/2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies","How to authenticate Django REST Framework API calls from a (Vue) JS client using Session Authentication and HttpOnly cookies","This article will describe an authentication strategy using Django REST Framework with a Javascript frontend application. I'll be demonstrating this with Vue.js (Qusar Framework, using Vue 2), but the concepts should transfer to any other Javascript framework.","post","2020-11-27T00:00:00.000Z","/static/padlocks.jpg",[14,13929,13931,16647],{"type":46,"children":16878,"toc":17574},[16879,16883,16895,16922,16936,16941,16949,16976,16982,16987,17461,17465,17470,17475,17480,17485,17490,17494,17499,17522,17527],{"type":49,"tag":58,"props":16880,"children":16881},{},[16882],{"type":55,"value":16872},{"type":49,"tag":58,"props":16884,"children":16885},{},[16886,16888,16894],{"type":55,"value":16887},"Here's a GitLab repository for a project that I will be referencing throughout this article: ",{"type":49,"tag":80,"props":16889,"children":16892},{"href":16890,"rel":16891},"https://gitlab.com/verbose-equals-true/django-postgres-vue-gitlab-ecs",[84],[16893],{"type":55,"value":16890},{"type":55,"value":745},{"type":49,"tag":58,"props":16896,"children":16897},{},[16898,16900,16907,16909,16920],{"type":55,"value":16899},"When I first started learning about how to do authentication from a Vue client, I found ",{"type":49,"tag":80,"props":16901,"children":16904},{"href":16902,"rel":16903},"https://blog.sqreen.com/authentication-best-practices-vue/",[84],[16905],{"type":55,"value":16906},"this article from Sqreen",{"type":55,"value":16908}," which describes how to use JWT to authenticate a Vue application. The example uses a mocked backend, but it is a good proxy for what you would have if you were to use a library like ",{"type":49,"tag":80,"props":16910,"children":16913},{"href":16911,"rel":16912},"https://github.com/SimpleJWT/django-rest-framework-simplejwt",[84],[16914],{"type":49,"tag":326,"props":16915,"children":16917},{"className":16916},[],[16918],{"type":55,"value":16919},"django-rest-framework-simplejwt",{"type":55,"value":16921},", which I have previously used with success in Django projects.",{"type":49,"tag":58,"props":16923,"children":16924},{},[16925,16927,16934],{"type":55,"value":16926},"JWT is an option for doing authentication with DRF ",{"type":49,"tag":80,"props":16928,"children":16931},{"href":16929,"rel":16930},"https://www.django-rest-framework.org/api-guide/authentication/#json-web-token-authentication",[84],[16932],{"type":55,"value":16933},"listed in the authentication documentation",{"type":55,"value":16935},", but the documentation doesn't recommend when or how to use JWT authentication.",{"type":49,"tag":58,"props":16937,"children":16938},{},[16939],{"type":55,"value":16940},"Session authentication is mentioned as well:",{"type":49,"tag":2910,"props":16942,"children":16943},{},[16944],{"type":49,"tag":58,"props":16945,"children":16946},{},[16947],{"type":55,"value":16948},"This authentication scheme uses Django's default session backend for authentication. Session authentication is appropriate for AJAX clients that are running in the same session context as your website.",{"type":49,"tag":58,"props":16950,"children":16951},{},[16952,16954,16959,16961,16967,16968,16974],{"type":55,"value":16953},"In my project, both in local development and in production environments, I serve the API and the Javascript clients on the same domain. ",{"type":49,"tag":326,"props":16955,"children":16957},{"className":16956},[],[16958],{"type":55,"value":3196},{"type":55,"value":16960}," requests go to the API, and all other request paths route to the frontend client. In other scenarios such as using ",{"type":49,"tag":326,"props":16962,"children":16964},{"className":16963},[],[16965],{"type":55,"value":16966},"https://mysite.com",{"type":55,"value":715},{"type":49,"tag":326,"props":16969,"children":16971},{"className":16970},[],[16972],{"type":55,"value":16973},"https://api.mysite.com",{"type":55,"value":16975}," for hosting a frontend and API an different subdomains, there would need to be additional considerations for CORS, but since I have the frontend and the backend being served on the same domain (and same subdomain), this isn't a concern. You might need to watch out for this if your requirements are different.",{"type":49,"tag":50,"props":16977,"children":16979},{"id":16978},"the-authentication-flow",[16980],{"type":55,"value":16981},"The authentication flow",{"type":49,"tag":58,"props":16983,"children":16984},{},[16985],{"type":55,"value":16986},"Now let's describe the login process at a high level.",{"type":49,"tag":8994,"props":16988,"children":16989},{},[16990,17003,17022,17058,17099,17155,17210,17274,17288,17332,17358,17394],{"type":49,"tag":68,"props":16991,"children":16992},{},[16993,16995,17001],{"type":55,"value":16994},"A user navigates to your site. There is currently nothing in the browser's ",{"type":49,"tag":326,"props":16996,"children":16998},{"className":16997},[],[16999],{"type":55,"value":17000},"localStorage",{"type":55,"value":17002}," or cookies related to authentication.",{"type":49,"tag":68,"props":17004,"children":17005},{},[17006,17008,17014,17016,17021],{"type":55,"value":17007},"The user navigates to the ",{"type":49,"tag":326,"props":17009,"children":17011},{"className":17010},[],[17012],{"type":55,"value":17013},"Login",{"type":55,"value":17015}," page at ",{"type":49,"tag":326,"props":17017,"children":17019},{"className":17018},[],[17020],{"type":55,"value":15234},{"type":55,"value":745},{"type":49,"tag":68,"props":17023,"children":17024},{},[17025,17027,17033,17035,17040,17042,17048,17050,17056],{"type":55,"value":17026},"Loading this Vue component makes a ",{"type":49,"tag":326,"props":17028,"children":17030},{"className":17029},[],[17031],{"type":55,"value":17032},"GET",{"type":55,"value":17034}," request to a special endpoint in our Django backend ",{"type":49,"tag":326,"props":17036,"children":17038},{"className":17037},[],[17039],{"type":55,"value":15412},{"type":55,"value":17041},". This request returns a simple JSON message: ",{"type":49,"tag":326,"props":17043,"children":17045},{"className":17044},[],[17046],{"type":55,"value":17047},"\"CSRF cookie set\"",{"type":55,"value":17049},", and as the message says, the response sets a ",{"type":49,"tag":326,"props":17051,"children":17053},{"className":17052},[],[17054],{"type":55,"value":17055},"csrf",{"type":55,"value":17057}," cookie on our browser.",{"type":49,"tag":68,"props":17059,"children":17060},{},[17061,17063,17068,17070,17076,17078,17083,17085,17090,17092,17097],{"type":55,"value":17062},"Once the CSRF cookie is set by the response from ",{"type":49,"tag":326,"props":17064,"children":17066},{"className":17065},[],[17067],{"type":55,"value":15412},{"type":55,"value":17069},", the user is presented with a login form and enters account credentials (email and password in my example, where email is the ",{"type":49,"tag":326,"props":17071,"children":17073},{"className":17072},[],[17074],{"type":55,"value":17075},"USERNAME_FIELD",{"type":55,"value":17077}," on my custom user model). Clicking \"Login\" dispatches a Vuex action that uses Axios to send a send a request to ",{"type":49,"tag":326,"props":17079,"children":17081},{"className":17080},[],[17082],{"type":55,"value":15475},{"type":55,"value":17084}," with the ",{"type":49,"tag":326,"props":17086,"children":17088},{"className":17087},[],[17089],{"type":55,"value":17055},{"type":55,"value":17091}," cookie set in a ",{"type":49,"tag":326,"props":17093,"children":17095},{"className":17094},[],[17096],{"type":55,"value":15467},{"type":55,"value":17098}," header.",{"type":49,"tag":68,"props":17100,"children":17101},{},[17102,17107,17109,17114,17116,17121,17122,17127,17128,17133,17134,17139,17141,17146,17148,17153],{"type":49,"tag":326,"props":17103,"children":17105},{"className":17104},[],[17106],{"type":55,"value":15475},{"type":55,"value":17108}," is handled by the ",{"type":49,"tag":326,"props":17110,"children":17112},{"className":17111},[],[17113],{"type":55,"value":15506},{"type":55,"value":17115}," view which uses two important functions from ",{"type":49,"tag":326,"props":17117,"children":17119},{"className":17118},[],[17120],{"type":55,"value":15514},{"type":55,"value":78},{"type":49,"tag":326,"props":17123,"children":17125},{"className":17124},[],[17126],{"type":55,"value":15521},{"type":55,"value":715},{"type":49,"tag":326,"props":17129,"children":17131},{"className":17130},[],[17132],{"type":55,"value":15528},{"type":55,"value":8561},{"type":49,"tag":326,"props":17135,"children":17137},{"className":17136},[],[17138],{"type":55,"value":15521},{"type":55,"value":17140}," gets the user from the provided credentials, and ",{"type":49,"tag":326,"props":17142,"children":17144},{"className":17143},[],[17145],{"type":55,"value":15528},{"type":55,"value":17147}," sets a ",{"type":49,"tag":326,"props":17149,"children":17151},{"className":17150},[],[17152],{"type":55,"value":15549},{"type":55,"value":17154}," HttpOnly cookie on the response.",{"type":49,"tag":68,"props":17156,"children":17157},{},[17158,17160,17165,17167,17172,17174,17179,17180,17186,17188,17194,17196,17201,17203,17209],{"type":55,"value":17159},"When the response from ",{"type":49,"tag":326,"props":17161,"children":17163},{"className":17162},[],[17164],{"type":55,"value":15475},{"type":55,"value":17166}," comes back, two things happen: first the ",{"type":49,"tag":326,"props":17168,"children":17170},{"className":17169},[],[17171],{"type":55,"value":15549},{"type":55,"value":17173}," HttpOnly cookie is set on our browser. Second, we set a value in both Vuex and localStorage named ",{"type":49,"tag":326,"props":17175,"children":17177},{"className":17176},[],[17178],{"type":55,"value":15372},{"type":55,"value":12789},{"type":49,"tag":326,"props":17181,"children":17183},{"className":17182},[],[17184],{"type":55,"value":17185},"success",{"type":55,"value":17187},". We are not storing any sensitive information in this value. Instead, we are using this value to signal to the rest of our Vue application that the user has authenticated. Storing this in Vuex allows us to use global Vuex ",{"type":49,"tag":326,"props":17189,"children":17191},{"className":17190},[],[17192],{"type":55,"value":17193},"getters",{"type":55,"value":17195}," so that we can change component state and other logic where authentication is concerned, such as route guards (for Vue router). We store it in localStorage so that when a new browser tab is opened, we can set the value of ",{"type":49,"tag":326,"props":17197,"children":17199},{"className":17198},[],[17200],{"type":55,"value":15372},{"type":55,"value":17202}," in Vuex based on the value in localStorage. (",{"type":49,"tag":326,"props":17204,"children":17206},{"className":17205},[],[17207],{"type":55,"value":17208},"authenticated: localStorage.getItem(\"authenticated\") || \"\",",{"type":55,"value":616},{"type":49,"tag":68,"props":17211,"children":17212},{},[17213,17215,17220,17222,17228,17230,17236,17238,17243,17245,17251,17253,17258,17260,17265,17266,17272],{"type":55,"value":17214},"Since the ",{"type":49,"tag":326,"props":17216,"children":17218},{"className":17217},[],[17219],{"type":55,"value":15549},{"type":55,"value":17221}," cookie is HttpOnly, we can't use Javascript to interact with it, so when we want to logout the user we can't just delete the cookie. To logout the user, we make a request to ",{"type":49,"tag":326,"props":17223,"children":17225},{"className":17224},[],[17226],{"type":55,"value":17227},"/api/logout/",{"type":55,"value":17229}," when the user clicks on the logout button. The view for this endpoint does ",{"type":49,"tag":326,"props":17231,"children":17233},{"className":17232},[],[17234],{"type":55,"value":17235},"logout(request)",{"type":55,"value":17237},". This returns a response with a new value for the ",{"type":49,"tag":326,"props":17239,"children":17241},{"className":17240},[],[17242],{"type":55,"value":15549},{"type":55,"value":17244}," cookie: ",{"type":49,"tag":326,"props":17246,"children":17248},{"className":17247},[],[17249],{"type":55,"value":17250},"Set-Cookie: sessionid=\"\"; expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; Path=/; SameSite=Lax",{"type":55,"value":17252},". Since the cookie's expiration is in the past, it is removed entirely. We also remove the ",{"type":49,"tag":326,"props":17254,"children":17256},{"className":17255},[],[17257],{"type":55,"value":15372},{"type":55,"value":17259}," localStorage item and set the Vuex store value of ",{"type":49,"tag":326,"props":17261,"children":17263},{"className":17262},[],[17264],{"type":55,"value":15372},{"type":55,"value":12789},{"type":49,"tag":326,"props":17267,"children":17269},{"className":17268},[],[17270],{"type":55,"value":17271},"''",{"type":55,"value":17273}," (which is falsey). This lets the Vue application know that user has been logged out. One consideration for this is that your user can't logout while offline.",{"type":49,"tag":68,"props":17275,"children":17276},{},[17277,17279,17286],{"type":55,"value":17278},"This repo also implements social authentication with the fantastic Python Social Auth library. I used Facebook, Google and GitHub, but there are lots of other providers you can choose from depending on what you need. This is a lengthy topic, and I recommend that you read ",{"type":49,"tag":80,"props":17280,"children":17283},{"href":17281,"rel":17282},"https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end",[84],[17284],{"type":55,"value":17285},"How to Integrate OAuth 2 Into Your Django/DRF Back-end Without Going Insane",{"type":55,"value":17287}," on which I have based my implementation. Here's the short story of how this works. First, a user clicks on one of the social sign-in links. These links are the same for sign-in and sign-up.",{"type":49,"tag":68,"props":17289,"children":17290},{},[17291,17293,17299,17300,17306,17308,17314,17316,17322,17324,17330],{"type":55,"value":17292},"The link has a few parts, here's an example: ",{"type":49,"tag":326,"props":17294,"children":17296},{"className":17295},[],[17297],{"type":55,"value":17298},"https://github.com/login/oauth/authorize?client_id=r66bdfgsfsbferfef4&redirect_uri=http:%2F%2Flocalhost%2Fauth%2Fgithub%2Fcallback&login=&scope=user:email&state=ewori4t95k3vdzem",{"type":55,"value":1931},{"type":49,"tag":326,"props":17301,"children":17303},{"className":17302},[],[17304],{"type":55,"value":17305},"client_id",{"type":55,"value":17307}," is the app we created to allow our users to sign in. When you create this app, you specify the ",{"type":49,"tag":326,"props":17309,"children":17311},{"className":17310},[],[17312],{"type":55,"value":17313},"redirect_uri",{"type":55,"value":17315}," in the configuration, and you reference that here as well. ",{"type":49,"tag":326,"props":17317,"children":17319},{"className":17318},[],[17320],{"type":55,"value":17321},"scope",{"type":55,"value":17323}," specifies scope of access we are requesting from the user's social account. ",{"type":49,"tag":326,"props":17325,"children":17327},{"className":17326},[],[17328],{"type":55,"value":17329},"state",{"type":55,"value":17331}," is used for security.",{"type":49,"tag":68,"props":17333,"children":17334},{},[17335,17337,17342,17343,17349,17351,17356],{"type":55,"value":17336},"When you click on the link above, you are redirected to GitHub and asked if you want to grant my GitHub application access to your account's associated email address. Clicking on \"Authorize\" then redirects you back to the ",{"type":49,"tag":326,"props":17338,"children":17340},{"className":17339},[],[17341],{"type":55,"value":17313},{"type":55,"value":78},{"type":49,"tag":326,"props":17344,"children":17346},{"className":17345},[],[17347],{"type":55,"value":17348},"http://localhost/auth/github/callback?code=veroi3409e203ej&state=ewori4t95k3vdzem",{"type":55,"value":17350},". Notice the ",{"type":49,"tag":326,"props":17352,"children":17354},{"className":17353},[],[17355],{"type":55,"value":326},{"type":55,"value":17357}," parameter.",{"type":49,"tag":68,"props":17359,"children":17360},{},[17361,17363,17369,17371,17377,17379,17385,17387,17393],{"type":55,"value":17362},"When you navigate to ",{"type":49,"tag":326,"props":17364,"children":17366},{"className":17365},[],[17367],{"type":55,"value":17368},"/auth/github/callback",{"type":55,"value":17370}," on the Vue application, you see a message: \"Logging in with GitHub...\". On this page's ",{"type":49,"tag":326,"props":17372,"children":17374},{"className":17373},[],[17375],{"type":55,"value":17376},"mounted",{"type":55,"value":17378}," method we call ",{"type":49,"tag":326,"props":17380,"children":17382},{"className":17381},[],[17383],{"type":55,"value":17384},"handleOauthCallback",{"type":55,"value":17386}," which makes a request to our Django application: ",{"type":49,"tag":326,"props":17388,"children":17390},{"className":17389},[],[17391],{"type":55,"value":17392},"/api/social/github/?code=veroi3409e203ej",{"type":55,"value":745},{"type":49,"tag":68,"props":17395,"children":17396},{},[17397,17399,17405,17407,17413,17415,17420,17422,17428,17430,17436,17438,17444,17446,17451,17453,17459],{"type":55,"value":17398},"This API endpoint uses the ",{"type":49,"tag":326,"props":17400,"children":17402},{"className":17401},[],[17403],{"type":55,"value":17404},"exchange_token",{"type":55,"value":17406}," view which is where Python Social Auth starts to do the heavy lifting. First, we need to make an API request to GitHub (",{"type":49,"tag":326,"props":17408,"children":17410},{"className":17409},[],[17411],{"type":55,"value":17412},"https://github.com/login/oauth/access_token",{"type":55,"value":17414},") with the ",{"type":49,"tag":326,"props":17416,"children":17418},{"className":17417},[],[17419],{"type":55,"value":326},{"type":55,"value":17421}," as a URL parameter, then we pass the access code that this API call returns into Python Social Auth's ",{"type":49,"tag":326,"props":17423,"children":17425},{"className":17424},[],[17426],{"type":55,"value":17427},"do_auth",{"type":55,"value":17429}," function to get our Django user. Finally, similar to the email/password login approach described above, we call ",{"type":49,"tag":326,"props":17431,"children":17433},{"className":17432},[],[17434],{"type":55,"value":17435},"login(request, user)",{"type":55,"value":17437}," and return a simple JSON response: ",{"type":49,"tag":326,"props":17439,"children":17441},{"className":17440},[],[17442],{"type":55,"value":17443},"{\"detail\": \"success\"}",{"type":55,"value":17445},". This will set the ",{"type":49,"tag":326,"props":17447,"children":17449},{"className":17448},[],[17450],{"type":55,"value":15549},{"type":55,"value":17452}," automatically when the response returns, and we can dispatch the same Vuex action ",{"type":49,"tag":326,"props":17454,"children":17456},{"className":17455},[],[17457],{"type":55,"value":17458},"AUTH_SUCCESS",{"type":55,"value":17460}," to tell Vuex that a user has been logged in.",{"type":49,"tag":50,"props":17462,"children":17463},{"id":15914},[17464],{"type":55,"value":15917},{"type":49,"tag":58,"props":17466,"children":17467},{},[17468],{"type":55,"value":17469},"Using the default Django session authentication mechanism has some nice advantages. It allows us to easily navigate between our Javascript SPA which uses Django REST Framework, regular Django admin views that you may also be using, as well as the Django admin.",{"type":49,"tag":58,"props":17471,"children":17472},{},[17473],{"type":55,"value":17474},"Using DRF's token authentication is still possible if you choose to use Session authentication for your JS frontend. For example, you may wish to allow users to make authenticated API requests to your public API using DRF Token Authentication.",{"type":49,"tag":58,"props":17476,"children":17477},{},[17478],{"type":55,"value":17479},"JWT is a really interesting concept and important to know about, but it doesn't seem like a practical solution for any of my use cases with Django APIs or frontends. You also can't really \"logout\" a user if you are using this solution for authentication.",{"type":49,"tag":58,"props":17481,"children":17482},{},[17483],{"type":55,"value":17484},"What I have described here is pretty simple scenario. It assumes that there is only one type of user and that there are no additional steps needed to make your account \"active\". Doing this would require additional logic on the Vue/Vuex side as well as the backend logic, including the User model. I also don't make use of any data from the social providers except for the user's email address.",{"type":49,"tag":58,"props":17486,"children":17487},{},[17488],{"type":55,"value":17489},"Another thing to be aware of with this scenario is that a user can register with social authentication first, and then reset their password and login with email (I haven't implemented this client-side on this project yet). Or, you can login with an email account that was created through the Django admin and then login with a social account tied to that email. There are a lot of options for each backend in Python social auth, making it a very flexible library for handling social authentication.",{"type":49,"tag":50,"props":17491,"children":17492},{"id":15955},[17493],{"type":55,"value":15958},{"type":49,"tag":58,"props":17495,"children":17496},{},[17497],{"type":55,"value":17498},"There is a lot more work to do on this example project regarding authentication, but I hope it can help point some people in the right direction. Here are some areas that I would like to work on next:",{"type":49,"tag":64,"props":17500,"children":17501},{},[17502,17507,17512,17517],{"type":49,"tag":68,"props":17503,"children":17504},{},[17505],{"type":55,"value":17506},"Error handling for a bad authentication attempt",{"type":49,"tag":68,"props":17508,"children":17509},{},[17510],{"type":55,"value":17511},"A signup form with email confirmation, handling cases where the user trying to signup may already have signed in with social authentication",{"type":49,"tag":68,"props":17513,"children":17514},{},[17515],{"type":55,"value":17516},"Password reset with email",{"type":49,"tag":68,"props":17518,"children":17519},{},[17520],{"type":55,"value":17521},"Making use of Python Social Auth settings and options, including pipelines.",{"type":49,"tag":50,"props":17523,"children":17525},{"id":17524},"resources",[17526],{"type":55,"value":2049},{"type":49,"tag":64,"props":17528,"children":17529},{},[17530,17538,17547,17556,17565],{"type":49,"tag":68,"props":17531,"children":17532},{},[17533],{"type":49,"tag":80,"props":17534,"children":17536},{"href":17281,"rel":17535},[84],[17537],{"type":55,"value":17281},{"type":49,"tag":68,"props":17539,"children":17540},{},[17541],{"type":49,"tag":80,"props":17542,"children":17545},{"href":17543,"rel":17544},"https://yoongkang.com/blog/cookie-based-authentication-spa-django/",[84],[17546],{"type":55,"value":17543},{"type":49,"tag":68,"props":17548,"children":17549},{},[17550],{"type":49,"tag":80,"props":17551,"children":17554},{"href":17552,"rel":17553},"https://github.com/encode/django-rest-framework/issues/7273",[84],[17555],{"type":55,"value":17552},{"type":49,"tag":68,"props":17557,"children":17558},{},[17559],{"type":49,"tag":80,"props":17560,"children":17563},{"href":17561,"rel":17562},"https://github.com/SimpleJWT/django-rest-framework-simplejwt/issues/71",[84],[17564],{"type":55,"value":17561},{"type":49,"tag":68,"props":17566,"children":17567},{},[17568],{"type":49,"tag":80,"props":17569,"children":17572},{"href":17570,"rel":17571},"http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/",[84],[17573],{"type":55,"value":17570},{"title":8,"searchDepth":1079,"depth":1079,"links":17575},[17576,17577,17578,17579],{"id":16978,"depth":1079,"text":16981},{"id":15914,"depth":1079,"text":15917},{"id":15955,"depth":1079,"text":15958},{"id":17524,"depth":1079,"text":2049},"content:2020:11:27:how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies.md","2020/11/27/how-to-authenticate-django-rest-framework-from-vue-app-with-session-authentication-httponly-cookies",{"_path":17584,"_dir":17585,"_draft":7,"_partial":7,"_locale":8,"title":17586,"description":17587,"layout":16873,"date":17588,"comments":44,"image":17589,"tags":17590,"body":17596,"_type":7809,"_id":22038,"_source":7811,"_file":22039,"_stem":22040,"_extension":7814},"/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","09","Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray","A guide to deploying Django applications with docker using popular open-source tools","2020-08-09T00:00:00.000Z","/static/shark.jpg",[14,24,17591,13929,16648,17592,17593,17594,17595],"digital-ocean","rex-ray","traefik","nginx","swarm",{"type":46,"children":17597,"toc":22012},[17598,17630,17635,17643,17655,17660,17666,17671,17737,17769,17775,17819,17825,17862,17867,17872,17877,17883,17896,17972,17978,18000,18006,18011,18019,18030,18036,18048,18053,18061,18082,18087,18095,18108,18116,18121,18130,18158,18205,18223,18234,18403,18429,18466,18542,18550,18575,18669,18677,18698,18785,18798,18804,18840,18848,18876,18917,18923,18928,18936,18944,18981,18986,18994,19006,19025,19033,19053,19061,19081,19090,19116,19345,19420,19464,19505,19513,19534,19539,19546,19564,19576,19583,19603,19613,19646,19650,19856,19874,19881,19893,19930,19974,19986,20033,20049,20134,20353,20382,20387,20392,20405,20423,20434,20625,20644,20677,20685,20757,20765,20785,20811,20819,20898,20910,21053,21058,21072,21092,21100,21105,21113,21151,21185,21190,21197,21211,21216,21234,21239,21247,21252,21279,21298,21328,21333,21652,21660,21684,21769,21781,21789,21801,21808,21820,21828,21846,21854,21859,21867,21872,21877,21885,21904,21910,21915,21931,21939,21944,21948,21953,21959,21964,21970,21975,21981,21986,21992,21997,22003,22008],{"type":49,"tag":58,"props":17599,"children":17600},{},[17601,17603,17610,17612,17619,17621,17628],{"type":55,"value":17602},"I recently wrote two articles about deploying Django applications to AWS serverless environments: one on ",{"type":49,"tag":80,"props":17604,"children":17607},{"href":17605,"rel":17606},"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html",[84],[17608],{"type":55,"value":17609},"AWS Fargate",{"type":55,"value":17611}," (CloudFront, ALB and ECS Fargate containers) and one on ",{"type":49,"tag":80,"props":17613,"children":17616},{"href":17614,"rel":17615},"https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html",[84],[17617],{"type":55,"value":17618},"AWS Lambda",{"type":55,"value":17620}," (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of ",{"type":49,"tag":80,"props":17622,"children":17625},{"href":17623,"rel":17624},"https://aws.amazon.com/cdk/",[84],[17626],{"type":55,"value":17627},"AWS Cloud Development Kit (CDK)",{"type":55,"value":17629},", an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to \"just use a VPS\" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!",{"type":49,"tag":58,"props":17631,"children":17632},{},[17633],{"type":55,"value":17634},"In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets).",{"type":49,"tag":2910,"props":17636,"children":17637},{},[17638],{"type":49,"tag":58,"props":17639,"children":17640},{},[17641],{"type":55,"value":17642},"I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes.",{"type":49,"tag":58,"props":17644,"children":17645},{},[17646,17648,17654],{"type":55,"value":17647},"Here's a link to my project that I'll be referencing: ",{"type":49,"tag":80,"props":17649,"children":17652},{"href":17650,"rel":17651},"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik",[84],[17653],{"type":55,"value":17650},{"type":55,"value":745},{"type":49,"tag":58,"props":17656,"children":17657},{},[17658],{"type":55,"value":17659},"The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article.",{"type":49,"tag":50,"props":17661,"children":17663},{"id":17662},"overview",[17664],{"type":55,"value":17665},"Overview",{"type":49,"tag":58,"props":17667,"children":17668},{},[17669],{"type":55,"value":17670},"Here are some of the key parts of the project that I'll go over:",{"type":49,"tag":64,"props":17672,"children":17673},{},[17674,17679,17684,17689,17694,17699,17712,17717,17722,17727,17732],{"type":49,"tag":68,"props":17675,"children":17676},{},[17677],{"type":55,"value":17678},"DigitalOcean and GitLab setup",{"type":49,"tag":68,"props":17680,"children":17681},{},[17682],{"type":55,"value":17683},"Creating an A Record that points to our Droplet IP",{"type":49,"tag":68,"props":17685,"children":17686},{},[17687],{"type":55,"value":17688},"Using a prebuilt VM image that ships with docker and docker-compose",{"type":49,"tag":68,"props":17690,"children":17691},{},[17692],{"type":55,"value":17693},"Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes",{"type":49,"tag":68,"props":17695,"children":17696},{},[17697],{"type":55,"value":17698},"Setting up a docker swarm cluster",{"type":49,"tag":68,"props":17700,"children":17701},{},[17702,17704,17710],{"type":55,"value":17703},"Setting up a ",{"type":49,"tag":326,"props":17705,"children":17707},{"className":17706},[],[17708],{"type":55,"value":17709},".gitlab-ci.yml",{"type":55,"value":17711}," file to build images and push them to a private GitLab CI project registry",{"type":49,"tag":68,"props":17713,"children":17714},{},[17715],{"type":55,"value":17716},"Writing a docker-compose file to configure the services (containers) that will support the application",{"type":49,"tag":68,"props":17718,"children":17719},{},[17720],{"type":55,"value":17721},"Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH",{"type":49,"tag":68,"props":17723,"children":17724},{},[17725],{"type":55,"value":17726},"Django project settings and management commands for our Postgres database and static files",{"type":49,"tag":68,"props":17728,"children":17729},{},[17730],{"type":55,"value":17731},"Monitoring, logging and debugging",{"type":49,"tag":68,"props":17733,"children":17734},{},[17735],{"type":55,"value":17736},"Destroying the environment + cleanup",{"type":49,"tag":58,"props":17738,"children":17739},{},[17740,17742,17749,17751,17758,17760,17767],{"type":55,"value":17741},"Before I dig into all of this, I recommend that you check out ",{"type":49,"tag":80,"props":17743,"children":17746},{"href":17744,"rel":17745},"https://mattsegal.dev/django-prod-architectures.html",[84],[17747],{"type":55,"value":17748},"this article about Django production architectures by Matt Segal",{"type":55,"value":17750},". This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. ",{"type":49,"tag":80,"props":17752,"children":17755},{"href":17753,"rel":17754},"https://mattsegal.dev",[84],[17756],{"type":55,"value":17757},"mattsegal.dev",{"type":55,"value":17759}," has lots of good content related to Django, I also recommend checking out ",{"type":49,"tag":80,"props":17761,"children":17764},{"href":17762,"rel":17763},"https://mattsegal.dev/nginx-django-reverse-proxy-config.html",[84],[17765],{"type":55,"value":17766},"this article about how NGINX is used with Django",{"type":55,"value":17768},". Thanks for the great resources, Matt!",{"type":49,"tag":50,"props":17770,"children":17772},{"id":17771},"digitalocean-setup",[17773],{"type":55,"value":17774},"DigitalOcean setup",{"type":49,"tag":64,"props":17776,"children":17777},{},[17778,17783,17794,17805],{"type":49,"tag":68,"props":17779,"children":17780},{},[17781],{"type":55,"value":17782},"Sign up for a new DigitalOcean account if you don't already have one",{"type":49,"tag":68,"props":17784,"children":17785},{},[17786,17788],{"type":55,"value":17787},"Create a DigitalOcean project ",{"type":49,"tag":80,"props":17789,"children":17792},{"href":17790,"rel":17791},"https://cloud.digitalocean.com/projects/new",[84],[17793],{"type":55,"value":17790},{"type":49,"tag":68,"props":17795,"children":17796},{},[17797,17799],{"type":55,"value":17798},"Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) ",{"type":49,"tag":80,"props":17800,"children":17803},{"href":17801,"rel":17802},"https://cloud.digitalocean.com/account/api/tokens",[84],[17804],{"type":55,"value":17801},{"type":49,"tag":68,"props":17806,"children":17807},{},[17808,17810,17817],{"type":55,"value":17809},"Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see ",{"type":49,"tag":80,"props":17811,"children":17814},{"href":17812,"rel":17813},"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/",[84],[17815],{"type":55,"value":17816},"this article",{"type":55,"value":17818}," for more information)",{"type":49,"tag":50,"props":17820,"children":17822},{"id":17821},"prebuilt-docker-vm-image",[17823],{"type":55,"value":17824},"Prebuilt Docker VM image",{"type":49,"tag":58,"props":17826,"children":17827},{},[17828,17830,17837,17839,17845,17847,17852,17854,17860],{"type":55,"value":17829},"From the ",{"type":49,"tag":80,"props":17831,"children":17834},{"href":17832,"rel":17833},"https://cloud.digitalocean.com/droplets/new",[84],[17835],{"type":55,"value":17836},"Create Droplets",{"type":55,"value":17838}," page, select ",{"type":49,"tag":326,"props":17840,"children":17842},{"className":17841},[],[17843],{"type":55,"value":17844},"Marketplace",{"type":55,"value":17846}," and search for ",{"type":49,"tag":326,"props":17848,"children":17850},{"className":17849},[],[17851],{"type":55,"value":24},{"type":55,"value":17853},". Select the ",{"type":49,"tag":326,"props":17855,"children":17857},{"className":17856},[],[17858],{"type":55,"value":17859},"Docker 5:19.03.1~3 18.04",{"type":55,"value":17861}," image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed.",{"type":49,"tag":58,"props":17863,"children":17864},{},[17865],{"type":55,"value":17866},"Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options.",{"type":49,"tag":58,"props":17868,"children":17869},{},[17870],{"type":55,"value":17871},"For Authentication, select the SSH key that you created earlier.",{"type":49,"tag":58,"props":17873,"children":17874},{},[17875],{"type":55,"value":17876},"Take note of the Droplet's IP address; we will use this in the next step.",{"type":49,"tag":50,"props":17878,"children":17880},{"id":17879},"gitlab-setup",[17881],{"type":55,"value":17882},"GitLab setup",{"type":49,"tag":58,"props":17884,"children":17885},{},[17886,17888,17894],{"type":55,"value":17887},"Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to ",{"type":49,"tag":326,"props":17889,"children":17891},{"className":17890},[],[17892],{"type":55,"value":17893},"Settings > CI/CD > Variables",{"type":55,"value":17895}," in your GitLab project and add the following environment variables:",{"type":49,"tag":64,"props":17897,"children":17898},{},[17899,17923,17934,17945,17956],{"type":49,"tag":68,"props":17900,"children":17901},{},[17902,17907,17909,17915,17917],{"type":49,"tag":326,"props":17903,"children":17905},{"className":17904},[],[17906],{"type":55,"value":13154},{"type":55,"value":17908},": the value should start with ",{"type":49,"tag":326,"props":17910,"children":17912},{"className":17911},[],[17913],{"type":55,"value":17914},"-----BEGIN RSA PRIVATE KEY-----",{"type":55,"value":17916}," and end with ",{"type":49,"tag":326,"props":17918,"children":17920},{"className":17919},[],[17921],{"type":55,"value":17922},"-----END RSA PRIVATE KEY-----",{"type":49,"tag":68,"props":17924,"children":17925},{},[17926,17932],{"type":49,"tag":326,"props":17927,"children":17929},{"className":17928},[],[17930],{"type":55,"value":17931},"DROPLET_IP",{"type":55,"value":17933},": the IP address of the droplet you just created",{"type":49,"tag":68,"props":17935,"children":17936},{},[17937,17943],{"type":49,"tag":326,"props":17938,"children":17940},{"className":17939},[],[17941],{"type":55,"value":17942},"POSTGRES_PASSWORD",{"type":55,"value":17944},": a secure password that we will use for our Postgres database (we will share this with our Django application later on)",{"type":49,"tag":68,"props":17946,"children":17947},{},[17948,17954],{"type":49,"tag":326,"props":17949,"children":17951},{"className":17950},[],[17952],{"type":55,"value":17953},"SECRET_KEY",{"type":55,"value":17955},": a random secret key to use for our Django application.",{"type":49,"tag":68,"props":17957,"children":17958},{},[17959,17965,17967],{"type":49,"tag":326,"props":17960,"children":17962},{"className":17961},[],[17963],{"type":55,"value":17964},"DEBUG",{"type":55,"value":17966},": the number ",{"type":49,"tag":326,"props":17968,"children":17970},{"className":17969},[],[17971],{"type":55,"value":8397},{"type":49,"tag":50,"props":17973,"children":17975},{"id":17974},"a-record",[17976],{"type":55,"value":17977},"A Record",{"type":49,"tag":58,"props":17979,"children":17980},{},[17981,17983,17989,17991,17998],{"type":55,"value":17982},"By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free ",{"type":49,"tag":326,"props":17984,"children":17986},{"className":17985},[],[17987],{"type":55,"value":17988},".tk",{"type":55,"value":17990}," domain from ",{"type":49,"tag":80,"props":17992,"children":17995},{"href":17993,"rel":17994},"https://www.freenom.com/en/freeandpaiddomains.html",[84],[17996],{"type":55,"value":17997},"freenom",{"type":55,"value":17999},". I have used this before and it is a great option for testing things out.",{"type":49,"tag":50,"props":18001,"children":18003},{"id":18002},"ssh-into-your-digitalocean-droplet",[18004],{"type":55,"value":18005},"SSH into your DigitalOcean Droplet",{"type":49,"tag":58,"props":18007,"children":18008},{},[18009],{"type":55,"value":18010},"You can do this with the following command:",{"type":49,"tag":1050,"props":18012,"children":18014},{"code":18013},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n",[18015],{"type":49,"tag":326,"props":18016,"children":18017},{"__ignoreMap":8},[18018],{"type":55,"value":18013},{"type":49,"tag":58,"props":18020,"children":18021},{},[18022,18028],{"type":49,"tag":326,"props":18023,"children":18025},{"className":18024},[],[18026],{"type":55,"value":18027},"a1_rsa",{"type":55,"value":18029}," is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly.",{"type":49,"tag":50,"props":18031,"children":18033},{"id":18032},"add-the-rex-ray-docker-plugin",[18034],{"type":55,"value":18035},"Add the REX-Ray docker plugin",{"type":49,"tag":58,"props":18037,"children":18038},{},[18039,18041,18047],{"type":55,"value":18040},"This step is very simple, you can follow along with this short guide: ",{"type":49,"tag":80,"props":18042,"children":18045},{"href":18043,"rel":18044},"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container",[84],[18046],{"type":55,"value":18043},{"type":55,"value":745},{"type":49,"tag":58,"props":18049,"children":18050},{},[18051],{"type":55,"value":18052},"There is basically one command to run:",{"type":49,"tag":1050,"props":18054,"children":18056},{"code":18055},"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n",[18057],{"type":49,"tag":326,"props":18058,"children":18059},{"__ignoreMap":8},[18060],{"type":55,"value":18055},{"type":49,"tag":58,"props":18062,"children":18063},{},[18064,18066,18072,18074,18080],{"type":55,"value":18065},"You will need to make sure that you replace ",{"type":49,"tag":326,"props":18067,"children":18069},{"className":18068},[],[18070],{"type":55,"value":18071},"YOUR_DIGITALOCEAN_TOKEN",{"type":55,"value":18073}," with the personal access token you added earlier. Also, ",{"type":49,"tag":326,"props":18075,"children":18077},{"className":18076},[],[18078],{"type":55,"value":18079},"DOBS_REGION",{"type":55,"value":18081}," should be the region you selected for your Droplet earlier.",{"type":49,"tag":58,"props":18083,"children":18084},{},[18085],{"type":55,"value":18086},"Check that the plugin was installed correctly with:",{"type":49,"tag":1050,"props":18088,"children":18090},{"code":18089},"docker plugin ls\n",[18091],{"type":49,"tag":326,"props":18092,"children":18093},{"__ignoreMap":8},[18094],{"type":55,"value":18089},{"type":49,"tag":58,"props":18096,"children":18097},{},[18098,18100,18107],{"type":55,"value":18099},"Here's a quick intro to REX-Ray from ",{"type":49,"tag":80,"props":18101,"children":18104},{"href":18102,"rel":18103},"https://rexray.readthedocs.io/en/stable/",[84],[18105],{"type":55,"value":18106},"rexray.readthedocs.io",{"type":55,"value":6694},{"type":49,"tag":2910,"props":18109,"children":18110},{},[18111],{"type":49,"tag":58,"props":18112,"children":18113},{},[18114],{"type":55,"value":18115},"REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster.",{"type":49,"tag":58,"props":18117,"children":18118},{},[18119],{"type":55,"value":18120},"In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article.",{"type":49,"tag":50,"props":18122,"children":18124},{"id":18123},"gitlab-ciyml",[18125],{"type":49,"tag":326,"props":18126,"children":18128},{"className":18127},[],[18129],{"type":55,"value":17709},{"type":49,"tag":58,"props":18131,"children":18132},{},[18133,18138,18140,18147,18149,18156],{"type":49,"tag":326,"props":18134,"children":18136},{"className":18135},[],[18137],{"type":55,"value":17709},{"type":55,"value":18139}," is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over ",{"type":49,"tag":80,"props":18141,"children":18144},{"href":18142,"rel":18143},"https://docs.gitlab.com/ee/ci/yaml/",[84],[18145],{"type":55,"value":18146},"this page from the GitLab documentation",{"type":55,"value":18148}," which goes over all of the configuration options with many examples. Also, ",{"type":49,"tag":80,"props":18150,"children":18153},{"href":18151,"rel":18152},"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",[84],[18154],{"type":55,"value":18155},"this documentation page",{"type":55,"value":18157}," covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly.",{"type":49,"tag":58,"props":18159,"children":18160},{},[18161,18163,18168,18170,18176,18177,18183,18184,18190,18192,18197,18198,18203],{"type":55,"value":18162},"CI/CD pipelines that I define with ",{"type":49,"tag":326,"props":18164,"children":18166},{"className":18165},[],[18167],{"type":55,"value":17709},{"type":55,"value":18169}," typically contain three stages: ",{"type":49,"tag":326,"props":18171,"children":18173},{"className":18172},[],[18174],{"type":55,"value":18175},"test",{"type":55,"value":873},{"type":49,"tag":326,"props":18178,"children":18180},{"className":18179},[],[18181],{"type":55,"value":18182},"build",{"type":55,"value":715},{"type":49,"tag":326,"props":18185,"children":18187},{"className":18186},[],[18188],{"type":55,"value":18189},"deploy",{"type":55,"value":18191},". We will focus on the ",{"type":49,"tag":326,"props":18193,"children":18195},{"className":18194},[],[18196],{"type":55,"value":18182},{"type":55,"value":715},{"type":49,"tag":326,"props":18199,"children":18201},{"className":18200},[],[18202],{"type":55,"value":18189},{"type":55,"value":18204}," stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest).",{"type":49,"tag":58,"props":18206,"children":18207},{},[18208,18214,18216,18221],{"type":49,"tag":326,"props":18209,"children":18211},{"className":18210},[],[18212],{"type":55,"value":18213},"build-backend",{"type":55,"value":18215}," is the name of a GitLab CI job that builds and tags a docker image from the source code in the ",{"type":49,"tag":326,"props":18217,"children":18219},{"className":18218},[],[18220],{"type":55,"value":1951},{"type":55,"value":18222}," directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later.",{"type":49,"tag":58,"props":18224,"children":18225},{},[18226,18228,18233],{"type":55,"value":18227},"Here's the YAML code for ",{"type":49,"tag":326,"props":18229,"children":18231},{"className":18230},[],[18232],{"type":55,"value":18213},{"type":55,"value":6694},{"type":49,"tag":1050,"props":18235,"children":18239},{"code":18236,"language":18237,"meta":8,"className":18238,"style":8},"build-backend:\n  stage: build\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  before_script:\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - |\n      docker build \\\n        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n        -f backend/docker/Dockerfile.prod \\\n        ./backend/\n    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n","yml","language-yml shiki shiki-themes github-light github-dark monokai",[18240],{"type":49,"tag":326,"props":18241,"children":18242},{"__ignoreMap":8},[18243,18254,18271,18288,18300,18312,18324,18336,18348,18359,18367,18375,18383,18391],{"type":49,"tag":1060,"props":18244,"children":18245},{"class":1062,"line":1063},[18246,18250],{"type":49,"tag":1060,"props":18247,"children":18248},{"style":3839},[18249],{"type":55,"value":18213},{"type":49,"tag":1060,"props":18251,"children":18252},{"style":1073},[18253],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18255,"children":18256},{"class":1062,"line":1079},[18257,18262,18266],{"type":49,"tag":1060,"props":18258,"children":18259},{"style":3839},[18260],{"type":55,"value":18261},"  stage",{"type":49,"tag":1060,"props":18263,"children":18264},{"style":1073},[18265],{"type":55,"value":78},{"type":49,"tag":1060,"props":18267,"children":18268},{"style":2215},[18269],{"type":55,"value":18270},"build\n",{"type":49,"tag":1060,"props":18272,"children":18273},{"class":1062,"line":1088},[18274,18279,18283],{"type":49,"tag":1060,"props":18275,"children":18276},{"style":3839},[18277],{"type":55,"value":18278},"  image",{"type":49,"tag":1060,"props":18280,"children":18281},{"style":1073},[18282],{"type":55,"value":78},{"type":49,"tag":1060,"props":18284,"children":18285},{"style":2215},[18286],{"type":55,"value":18287},"docker:19.03.1\n",{"type":49,"tag":1060,"props":18289,"children":18290},{"class":1062,"line":1097},[18291,18296],{"type":49,"tag":1060,"props":18292,"children":18293},{"style":3839},[18294],{"type":55,"value":18295},"  services",{"type":49,"tag":1060,"props":18297,"children":18298},{"style":1073},[18299],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18301,"children":18302},{"class":1062,"line":1111},[18303,18307],{"type":49,"tag":1060,"props":18304,"children":18305},{"style":1073},[18306],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18308,"children":18309},{"style":2215},[18310],{"type":55,"value":18311},"docker:19.03.5-dind\n",{"type":49,"tag":1060,"props":18313,"children":18314},{"class":1062,"line":1120},[18315,18320],{"type":49,"tag":1060,"props":18316,"children":18317},{"style":3839},[18318],{"type":55,"value":18319},"  before_script",{"type":49,"tag":1060,"props":18321,"children":18322},{"style":1073},[18323],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18325,"children":18326},{"class":1062,"line":1128},[18327,18331],{"type":49,"tag":1060,"props":18328,"children":18329},{"style":1073},[18330],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18332,"children":18333},{"style":2215},[18334],{"type":55,"value":18335},"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n",{"type":49,"tag":1060,"props":18337,"children":18338},{"class":1062,"line":1141},[18339,18344],{"type":49,"tag":1060,"props":18340,"children":18341},{"style":3839},[18342],{"type":55,"value":18343},"  script",{"type":49,"tag":1060,"props":18345,"children":18346},{"style":1073},[18347],{"type":55,"value":6862},{"type":49,"tag":1060,"props":18349,"children":18350},{"class":1062,"line":1150},[18351,18355],{"type":49,"tag":1060,"props":18352,"children":18353},{"style":1073},[18354],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18356,"children":18357},{"style":2194},[18358],{"type":55,"value":3884},{"type":49,"tag":1060,"props":18360,"children":18361},{"class":1062,"line":1158},[18362],{"type":49,"tag":1060,"props":18363,"children":18364},{"style":2215},[18365],{"type":55,"value":18366},"      docker build \\\n",{"type":49,"tag":1060,"props":18368,"children":18369},{"class":1062,"line":1171},[18370],{"type":49,"tag":1060,"props":18371,"children":18372},{"style":2215},[18373],{"type":55,"value":18374},"        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n",{"type":49,"tag":1060,"props":18376,"children":18377},{"class":1062,"line":1180},[18378],{"type":49,"tag":1060,"props":18379,"children":18380},{"style":2215},[18381],{"type":55,"value":18382},"        -f backend/docker/Dockerfile.prod \\\n",{"type":49,"tag":1060,"props":18384,"children":18385},{"class":1062,"line":1188},[18386],{"type":49,"tag":1060,"props":18387,"children":18388},{"style":2215},[18389],{"type":55,"value":18390},"        ./backend/\n",{"type":49,"tag":1060,"props":18392,"children":18393},{"class":1062,"line":1201},[18394,18398],{"type":49,"tag":1060,"props":18395,"children":18396},{"style":1073},[18397],{"type":55,"value":6899},{"type":49,"tag":1060,"props":18399,"children":18400},{"style":2215},[18401],{"type":55,"value":18402},"docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n",{"type":49,"tag":58,"props":18404,"children":18405},{},[18406,18412,18414,18420,18422,18427],{"type":49,"tag":326,"props":18407,"children":18409},{"className":18408},[],[18410],{"type":55,"value":18411},"build-nginx",{"type":55,"value":18413}," is almost identical, but the ",{"type":49,"tag":326,"props":18415,"children":18417},{"className":18416},[],[18418],{"type":55,"value":18419},"docker build",{"type":55,"value":18421}," arguments are slightly different. There are three arguments for the ",{"type":49,"tag":326,"props":18423,"children":18425},{"className":18424},[],[18426],{"type":55,"value":18419},{"type":55,"value":18428}," command that I'm using here:",{"type":49,"tag":8994,"props":18430,"children":18431},{},[18432,18443,18454],{"type":49,"tag":68,"props":18433,"children":18434},{},[18435,18441],{"type":49,"tag":326,"props":18436,"children":18438},{"className":18437},[],[18439],{"type":55,"value":18440},"-t",{"type":55,"value":18442},": the tag to tag the built image with",{"type":49,"tag":68,"props":18444,"children":18445},{},[18446,18452],{"type":49,"tag":326,"props":18447,"children":18449},{"className":18448},[],[18450],{"type":55,"value":18451},"-f",{"type":55,"value":18453},": the Dockerfile to be used for building the image",{"type":49,"tag":68,"props":18455,"children":18456},{},[18457,18459,18464],{"type":55,"value":18458},"the ",{"type":49,"tag":326,"props":18460,"children":18462},{"className":18461},[],[18463],{"type":55,"value":14059},{"type":55,"value":18465}," that is sent to the docker daemon when we build the image",{"type":49,"tag":58,"props":18467,"children":18468},{},[18469,18474,18476,18482,18483,18489,18490,18496,18498,18504,18506,18511,18513,18519,18521,18526,18528,18533,18535,18540],{"type":49,"tag":326,"props":18470,"children":18472},{"className":18471},[],[18473],{"type":55,"value":18440},{"type":55,"value":18475}," makes use of two predefined GitLab CI variables: ",{"type":49,"tag":326,"props":18477,"children":18479},{"className":18478},[],[18480],{"type":55,"value":18481},"CI_REGISTRY_IMAGE",{"type":55,"value":715},{"type":49,"tag":326,"props":18484,"children":18486},{"className":18485},[],[18487],{"type":55,"value":18488},"CI_COMMIT_SHORT_SHA",{"type":55,"value":8561},{"type":49,"tag":326,"props":18491,"children":18493},{"className":18492},[],[18494],{"type":55,"value":18495},"$CI_REGISTRY_IMAGE",{"type":55,"value":18497}," is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: ",{"type":49,"tag":326,"props":18499,"children":18501},{"className":18500},[],[18502],{"type":55,"value":18503},"registry.gitlab.com/\u003Cgitlab_username>/\u003Cproject_name>",{"type":55,"value":18505},", and ",{"type":49,"tag":326,"props":18507,"children":18509},{"className":18508},[],[18510],{"type":55,"value":18488},{"type":55,"value":18512}," is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the ",{"type":49,"tag":326,"props":18514,"children":18516},{"className":18515},[],[18517],{"type":55,"value":18518},"tag",{"type":55,"value":18520},", even though we pass in more than just this value. We combine these two values with ",{"type":49,"tag":326,"props":18522,"children":18524},{"className":18523},[],[18525],{"type":55,"value":3744},{"type":55,"value":18527}," and the name of the image we are building, such as ",{"type":49,"tag":326,"props":18529,"children":18531},{"className":18530},[],[18532],{"type":55,"value":1951},{"type":55,"value":18534},", so the full value being passed to ",{"type":49,"tag":326,"props":18536,"children":18538},{"className":18537},[],[18539],{"type":55,"value":18440},{"type":55,"value":18541}," is:",{"type":49,"tag":1050,"props":18543,"children":18545},{"code":18544},"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n",[18546],{"type":49,"tag":326,"props":18547,"children":18548},{"__ignoreMap":8},[18549],{"type":55,"value":18544},{"type":49,"tag":58,"props":18551,"children":18552},{},[18553,18558,18560,18566,18568,18573],{"type":49,"tag":326,"props":18554,"children":18556},{"className":18555},[],[18557],{"type":55,"value":18451},{"type":55,"value":18559}," is the path to the ",{"type":49,"tag":326,"props":18561,"children":18563},{"className":18562},[],[18564],{"type":55,"value":18565},"Dockerfile",{"type":55,"value":18567}," we are using relative to the directory where we are running the ",{"type":49,"tag":326,"props":18569,"children":18571},{"className":18570},[],[18572],{"type":55,"value":18419},{"type":55,"value":18574}," command, which is the root directory of the project.",{"type":49,"tag":58,"props":18576,"children":18577},{},[18578,18580,18585,18587,18593,18594,18600,18602,18607,18608,18613,18614,18619,18621,18626,18628,18633,18635,18640,18641,18646,18648,18653,18655,18660,18662,18667],{"type":55,"value":18579},"The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with ",{"type":49,"tag":326,"props":18581,"children":18583},{"className":18582},[],[18584],{"type":55,"value":18419},{"type":55,"value":18586},", we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as ",{"type":49,"tag":326,"props":18588,"children":18590},{"className":18589},[],[18591],{"type":55,"value":18592},"ADD",{"type":55,"value":715},{"type":49,"tag":326,"props":18595,"children":18597},{"className":18596},[],[18598],{"type":55,"value":18599},"COPY",{"type":55,"value":18601}," -- we will get to these soon). There's a key difference between the ",{"type":49,"tag":326,"props":18603,"children":18605},{"className":18604},[],[18606],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":18609,"children":18611},{"className":18610},[],[18612],{"type":55,"value":17594},{"type":55,"value":1909},{"type":49,"tag":326,"props":18615,"children":18617},{"className":18616},[],[18618],{"type":55,"value":18419},{"type":55,"value":18620}," commands: the context for ",{"type":49,"tag":326,"props":18622,"children":18624},{"className":18623},[],[18625],{"type":55,"value":1951},{"type":55,"value":18627}," is ",{"type":49,"tag":326,"props":18629,"children":18631},{"className":18630},[],[18632],{"type":55,"value":1951},{"type":55,"value":18634},", but the context for ",{"type":49,"tag":326,"props":18636,"children":18638},{"className":18637},[],[18639],{"type":55,"value":17594},{"type":55,"value":18627},{"type":49,"tag":326,"props":18642,"children":18644},{"className":18643},[],[18645],{"type":55,"value":745},{"type":55,"value":18647}," (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the ",{"type":49,"tag":326,"props":18649,"children":18651},{"className":18650},[],[18652],{"type":55,"value":17594},{"type":55,"value":18654}," and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the ",{"type":49,"tag":326,"props":18656,"children":18658},{"className":18657},[],[18659],{"type":55,"value":18419},{"type":55,"value":18661}," command to hang. The first line of output from a ",{"type":49,"tag":326,"props":18663,"children":18665},{"className":18664},[],[18666],{"type":55,"value":18419},{"type":55,"value":18668}," command should be something like this:",{"type":49,"tag":1050,"props":18670,"children":18672},{"code":18671},"Sending build context to Docker daemon  24.58kB\n",[18673],{"type":49,"tag":326,"props":18674,"children":18675},{"__ignoreMap":8},[18676],{"type":55,"value":18671},{"type":49,"tag":58,"props":18678,"children":18679},{},[18680,18682,18688,18690,18696],{"type":55,"value":18681},"If this number is too high, you should use a ",{"type":49,"tag":326,"props":18683,"children":18685},{"className":18684},[],[18686],{"type":55,"value":18687},".dockerignore",{"type":55,"value":18689}," file that ignores any files or directories you don't want to send to the docker daemon (similar to how ",{"type":49,"tag":326,"props":18691,"children":18693},{"className":18692},[],[18694],{"type":55,"value":18695},".gitignore",{"type":55,"value":18697}," works with git).",{"type":49,"tag":58,"props":18699,"children":18700},{},[18701,18703,18709,18711,18717,18719,18725,18726,18732,18734,18740,18742,18748,18750,18756,18758,18763,18764,18769,18771,18776,18778,18783],{"type":55,"value":18702},"To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the ",{"type":49,"tag":326,"props":18704,"children":18706},{"className":18705},[],[18707],{"type":55,"value":18708},"docker login",{"type":55,"value":18710}," command in the ",{"type":49,"tag":326,"props":18712,"children":18714},{"className":18713},[],[18715],{"type":55,"value":18716},"before_script",{"type":55,"value":18718}," as well two other predefined GitLab CI variables: ",{"type":49,"tag":326,"props":18720,"children":18722},{"className":18721},[],[18723],{"type":55,"value":18724},"CI_JOB_TOKEN",{"type":55,"value":715},{"type":49,"tag":326,"props":18727,"children":18729},{"className":18728},[],[18730],{"type":55,"value":18731},"CI_REGISTRY",{"type":55,"value":18733},". This all happens using a special service called ",{"type":49,"tag":326,"props":18735,"children":18737},{"className":18736},[],[18738],{"type":55,"value":18739},"docker-in-docker",{"type":55,"value":18741}," which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key ",{"type":49,"tag":326,"props":18743,"children":18745},{"className":18744},[],[18746],{"type":55,"value":18747},"image",{"type":55,"value":18749}," -- and can define additional containers -- the ",{"type":49,"tag":326,"props":18751,"children":18753},{"className":18752},[],[18754],{"type":55,"value":18755},"services",{"type":55,"value":18757}," key -- to help with the CI job). Once the two images for ",{"type":49,"tag":326,"props":18759,"children":18761},{"className":18760},[],[18762],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":18765,"children":18767},{"className":18766},[],[18768],{"type":55,"value":17594},{"type":55,"value":18770}," have been built and pushed, our GitLab CI pipeline moves on to the next stage: ",{"type":49,"tag":326,"props":18772,"children":18774},{"className":18773},[],[18775],{"type":55,"value":18189},{"type":55,"value":18777},". In the ",{"type":49,"tag":326,"props":18779,"children":18781},{"className":18780},[],[18782],{"type":55,"value":18189},{"type":55,"value":18784}," stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:",{"type":49,"tag":8994,"props":18786,"children":18787},{},[18788,18793],{"type":49,"tag":68,"props":18789,"children":18790},{},[18791],{"type":55,"value":18792},"initialize a single-node docker swarm cluster on our Droplet and",{"type":49,"tag":68,"props":18794,"children":18795},{},[18796],{"type":55,"value":18797},"create a docker network that our cluster's services (containers) will use",{"type":49,"tag":50,"props":18799,"children":18801},{"id":18800},"setup-a-docker-swarm-cluster",[18802],{"type":55,"value":18803},"Setup a docker swarm cluster",{"type":49,"tag":58,"props":18805,"children":18806},{},[18807,18809,18815,18817,18822,18824,18830,18832,18838],{"type":55,"value":18808},"To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above (",{"type":49,"tag":326,"props":18810,"children":18812},{"className":18811},[],[18813],{"type":55,"value":18814},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91",{"type":55,"value":18816}," where ",{"type":49,"tag":326,"props":18818,"children":18820},{"className":18819},[],[18821],{"type":55,"value":18027},{"type":55,"value":18823}," is the name of the private key file -- you can ignore the ",{"type":49,"tag":326,"props":18825,"children":18827},{"className":18826},[],[18828],{"type":55,"value":18829},"-i ~/.ssh/a1_rsa",{"type":55,"value":18831}," part if you are using an SSH key called ",{"type":49,"tag":326,"props":18833,"children":18835},{"className":18834},[],[18836],{"type":55,"value":18837},"id_rsa",{"type":55,"value":18839},"), and run the following command:",{"type":49,"tag":1050,"props":18841,"children":18843},{"code":18842},"docker swarm init --advertise-addr DROPLET_IP\n",[18844],{"type":49,"tag":326,"props":18845,"children":18846},{"__ignoreMap":8},[18847],{"type":55,"value":18842},{"type":49,"tag":58,"props":18849,"children":18850},{},[18851,18853,18858,18860,18866,18868,18874],{"type":55,"value":18852},"Replace ",{"type":49,"tag":326,"props":18854,"children":18856},{"className":18855},[],[18857],{"type":55,"value":17931},{"type":55,"value":18859}," with your Droplet's IP address (e.g. ",{"type":49,"tag":326,"props":18861,"children":18863},{"className":18862},[],[18864],{"type":55,"value":18865},"123.45.578.91",{"type":55,"value":18867},"). Check out ",{"type":49,"tag":80,"props":18869,"children":18872},{"href":18870,"rel":18871},"https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04",[84],[18873],{"type":55,"value":17816},{"type":55,"value":18875}," for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here.",{"type":49,"tag":58,"props":18877,"children":18878},{},[18879,18881,18886,18888,18894,18896,18901,18903,18908,18910,18915],{"type":55,"value":18880},"Docker swarm uses docker-compose files, but using docker swarm is very different from running ",{"type":49,"tag":326,"props":18882,"children":18884},{"className":18883},[],[18885],{"type":55,"value":16254},{"type":55,"value":18887},", a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using ",{"type":49,"tag":326,"props":18889,"children":18891},{"className":18890},[],[18892],{"type":55,"value":18893},"docker-compose",{"type":55,"value":18895}," (the command) in production. Many people do this, and several official tutorials will often end with \"now just run ",{"type":49,"tag":326,"props":18897,"children":18899},{"className":18898},[],[18900],{"type":55,"value":16254},{"type":55,"value":18902}," and you are done\". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran ",{"type":49,"tag":326,"props":18904,"children":18906},{"className":18905},[],[18907],{"type":55,"value":16254},{"type":55,"value":18909},". It is pretty easy and it works very similarly in both local and production environments, but this guide will be using ",{"type":49,"tag":326,"props":18911,"children":18913},{"className":18912},[],[18914],{"type":55,"value":18893},{"type":55,"value":18916}," in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use.",{"type":49,"tag":50,"props":18918,"children":18920},{"id":18919},"defining-an-overlay-network",[18921],{"type":55,"value":18922},"Defining an overlay network",{"type":49,"tag":58,"props":18924,"children":18925},{},[18926],{"type":55,"value":18927},"SSH into your droplet and run the following command:",{"type":49,"tag":1050,"props":18929,"children":18931},{"code":18930},"docker network create --driver=overlay traefik-public\n",[18932],{"type":49,"tag":326,"props":18933,"children":18934},{"__ignoreMap":8},[18935],{"type":55,"value":18930},{"type":49,"tag":2910,"props":18937,"children":18938},{},[18939],{"type":49,"tag":58,"props":18940,"children":18941},{},[18942],{"type":55,"value":18943},"Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out.",{"type":49,"tag":58,"props":18945,"children":18946},{},[18947,18949,18955,18957,18962,18964,18970,18972,18979],{"type":55,"value":18948},"Let's go over one more docker concept that will helpful in the next few steps. When you run ",{"type":49,"tag":326,"props":18950,"children":18952},{"className":18951},[],[18953],{"type":55,"value":18954},"docker ps",{"type":55,"value":18956}," on your local machine, the docker CLI first looks to see if the ",{"type":49,"tag":326,"props":18958,"children":18960},{"className":18959},[],[18961],{"type":55,"value":16753},{"type":55,"value":18963}," environment variable is set. If it is not, then docker defaults to ",{"type":49,"tag":326,"props":18965,"children":18967},{"className":18966},[],[18968],{"type":55,"value":18969},"unix:///var/run/docker.sock",{"type":55,"value":18971},", a UNIX socket. Check out ",{"type":49,"tag":80,"props":18973,"children":18976},{"href":18974,"rel":18975},"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock",[84],[18977],{"type":55,"value":18978},"this SO post",{"type":55,"value":18980}," titled \"Can anyone explain docker.sock?\"",{"type":49,"tag":58,"props":18982,"children":18983},{},[18984],{"type":55,"value":18985},"We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:",{"type":49,"tag":1050,"props":18987,"children":18989},{"code":18988},"DOCKER_HOST=ssh://root@$DOCKER_IP\n",[18990],{"type":49,"tag":326,"props":18991,"children":18992},{"__ignoreMap":8},[18993],{"type":55,"value":18988},{"type":49,"tag":58,"props":18995,"children":18996},{},[18997,18999,19005],{"type":55,"value":18998},"See this article for a more in-depth discussion: ",{"type":49,"tag":80,"props":19000,"children":19003},{"href":19001,"rel":19002},"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow",[84],[19004],{"type":55,"value":19001},{"type":55,"value":745},{"type":49,"tag":58,"props":19007,"children":19008},{},[19009,19011,19016,19018,19023],{"type":55,"value":19010},"You can try this out locally. Run a container locally, check it with ",{"type":49,"tag":326,"props":19012,"children":19014},{"className":19013},[],[19015],{"type":55,"value":18954},{"type":55,"value":19017},", then export the ",{"type":49,"tag":326,"props":19019,"children":19021},{"className":19020},[],[19022],{"type":55,"value":16753},{"type":55,"value":19024}," environment variable with the following command:",{"type":49,"tag":1050,"props":19026,"children":19028},{"code":19027},"export DOCKER_HOST=ssh://root@123.45.678.91\n",[19029],{"type":49,"tag":326,"props":19030,"children":19031},{"__ignoreMap":8},[19032],{"type":55,"value":19027},{"type":49,"tag":58,"props":19034,"children":19035},{},[19036,19038,19044,19046,19051],{"type":55,"value":19037},"Replacing ",{"type":49,"tag":326,"props":19039,"children":19041},{"className":19040},[],[19042],{"type":55,"value":19043},"123.45.678.91",{"type":55,"value":19045}," with your Droplet IP. Run ",{"type":49,"tag":326,"props":19047,"children":19049},{"className":19048},[],[19050],{"type":55,"value":18954},{"type":55,"value":19052}," again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:",{"type":49,"tag":1050,"props":19054,"children":19056},{"code":19055},"unset DOCKER_HOST\n",[19057],{"type":49,"tag":326,"props":19058,"children":19059},{"__ignoreMap":8},[19060],{"type":55,"value":19055},{"type":49,"tag":58,"props":19062,"children":19063},{},[19064,19066,19071,19073,19079],{"type":55,"value":19065},"Running ",{"type":49,"tag":326,"props":19067,"children":19069},{"className":19068},[],[19070],{"type":55,"value":18954},{"type":55,"value":19072}," again you should see the containers on your machine. We will be using this idea in the next step when we look at the ",{"type":49,"tag":326,"props":19074,"children":19076},{"className":19075},[],[19077],{"type":55,"value":19078},"docker stack deploy",{"type":55,"value":19080}," command.",{"type":49,"tag":50,"props":19082,"children":19084},{"id":19083},"docker-stack-deploy",[19085],{"type":49,"tag":326,"props":19086,"children":19088},{"className":19087},[],[19089],{"type":55,"value":19078},{"type":49,"tag":58,"props":19091,"children":19092},{},[19093,19095,19100,19102,19107,19109,19115],{"type":55,"value":19094},"Now that we have done our one-time-setup steps, let's look at the ",{"type":49,"tag":326,"props":19096,"children":19098},{"className":19097},[],[19099],{"type":55,"value":18189},{"type":55,"value":19101}," stage of ",{"type":49,"tag":326,"props":19103,"children":19105},{"className":19104},[],[19106],{"type":55,"value":17709},{"type":55,"value":19108},", the GitLab CI job that will get our containers running on our Droplet. First, let's break down the ",{"type":49,"tag":326,"props":19110,"children":19112},{"className":19111},[],[19113],{"type":55,"value":19114},"deploy-digital-ocean",{"type":55,"value":13378},{"type":49,"tag":1050,"props":19117,"children":19119},{"code":19118,"language":18237,"meta":8,"className":18238,"style":8},"deploy-digital-ocean:\n  stage: deploy\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  variables:\n    DOCKER_HOST: 'ssh://root@$DROPLET_IP'\n  before_script:\n    - apk update && apk add openssh-client bash\n    - mkdir -p ~/.ssh\n    - echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n    - chmod 600 ~/.ssh/id_rsa\n    - eval \"$(ssh-agent -s)\"\n    - ssh-add ~/.ssh/id_rsa\n    - ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - docker stack deploy -c stack.yml my-stack --with-registry-auth\n",[19120],{"type":49,"tag":326,"props":19121,"children":19122},{"__ignoreMap":8},[19123,19134,19150,19165,19176,19187,19199,19216,19227,19239,19251,19263,19275,19287,19299,19311,19322,19333],{"type":49,"tag":1060,"props":19124,"children":19125},{"class":1062,"line":1063},[19126,19130],{"type":49,"tag":1060,"props":19127,"children":19128},{"style":3839},[19129],{"type":55,"value":19114},{"type":49,"tag":1060,"props":19131,"children":19132},{"style":1073},[19133],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19135,"children":19136},{"class":1062,"line":1079},[19137,19141,19145],{"type":49,"tag":1060,"props":19138,"children":19139},{"style":3839},[19140],{"type":55,"value":18261},{"type":49,"tag":1060,"props":19142,"children":19143},{"style":1073},[19144],{"type":55,"value":78},{"type":49,"tag":1060,"props":19146,"children":19147},{"style":2215},[19148],{"type":55,"value":19149},"deploy\n",{"type":49,"tag":1060,"props":19151,"children":19152},{"class":1062,"line":1088},[19153,19157,19161],{"type":49,"tag":1060,"props":19154,"children":19155},{"style":3839},[19156],{"type":55,"value":18278},{"type":49,"tag":1060,"props":19158,"children":19159},{"style":1073},[19160],{"type":55,"value":78},{"type":49,"tag":1060,"props":19162,"children":19163},{"style":2215},[19164],{"type":55,"value":18287},{"type":49,"tag":1060,"props":19166,"children":19167},{"class":1062,"line":1097},[19168,19172],{"type":49,"tag":1060,"props":19169,"children":19170},{"style":3839},[19171],{"type":55,"value":18295},{"type":49,"tag":1060,"props":19173,"children":19174},{"style":1073},[19175],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19177,"children":19178},{"class":1062,"line":1111},[19179,19183],{"type":49,"tag":1060,"props":19180,"children":19181},{"style":1073},[19182],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19184,"children":19185},{"style":2215},[19186],{"type":55,"value":18311},{"type":49,"tag":1060,"props":19188,"children":19189},{"class":1062,"line":1120},[19190,19195],{"type":49,"tag":1060,"props":19191,"children":19192},{"style":3839},[19193],{"type":55,"value":19194},"  variables",{"type":49,"tag":1060,"props":19196,"children":19197},{"style":1073},[19198],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19200,"children":19201},{"class":1062,"line":1128},[19202,19207,19211],{"type":49,"tag":1060,"props":19203,"children":19204},{"style":3839},[19205],{"type":55,"value":19206},"    DOCKER_HOST",{"type":49,"tag":1060,"props":19208,"children":19209},{"style":1073},[19210],{"type":55,"value":78},{"type":49,"tag":1060,"props":19212,"children":19213},{"style":2215},[19214],{"type":55,"value":19215},"'ssh://root@$DROPLET_IP'\n",{"type":49,"tag":1060,"props":19217,"children":19218},{"class":1062,"line":1141},[19219,19223],{"type":49,"tag":1060,"props":19220,"children":19221},{"style":3839},[19222],{"type":55,"value":18319},{"type":49,"tag":1060,"props":19224,"children":19225},{"style":1073},[19226],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19228,"children":19229},{"class":1062,"line":1150},[19230,19234],{"type":49,"tag":1060,"props":19231,"children":19232},{"style":1073},[19233],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19235,"children":19236},{"style":2215},[19237],{"type":55,"value":19238},"apk update && apk add openssh-client bash\n",{"type":49,"tag":1060,"props":19240,"children":19241},{"class":1062,"line":1158},[19242,19246],{"type":49,"tag":1060,"props":19243,"children":19244},{"style":1073},[19245],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19247,"children":19248},{"style":2215},[19249],{"type":55,"value":19250},"mkdir -p ~/.ssh\n",{"type":49,"tag":1060,"props":19252,"children":19253},{"class":1062,"line":1171},[19254,19258],{"type":49,"tag":1060,"props":19255,"children":19256},{"style":1073},[19257],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19259,"children":19260},{"style":2215},[19261],{"type":55,"value":19262},"echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":19264,"children":19265},{"class":1062,"line":1180},[19266,19270],{"type":49,"tag":1060,"props":19267,"children":19268},{"style":1073},[19269],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19271,"children":19272},{"style":2215},[19273],{"type":55,"value":19274},"chmod 600 ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":19276,"children":19277},{"class":1062,"line":1188},[19278,19282],{"type":49,"tag":1060,"props":19279,"children":19280},{"style":1073},[19281],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19283,"children":19284},{"style":2215},[19285],{"type":55,"value":19286},"eval \"$(ssh-agent -s)\"\n",{"type":49,"tag":1060,"props":19288,"children":19289},{"class":1062,"line":1201},[19290,19294],{"type":49,"tag":1060,"props":19291,"children":19292},{"style":1073},[19293],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19295,"children":19296},{"style":2215},[19297],{"type":55,"value":19298},"ssh-add ~/.ssh/id_rsa\n",{"type":49,"tag":1060,"props":19300,"children":19301},{"class":1062,"line":1210},[19302,19306],{"type":49,"tag":1060,"props":19303,"children":19304},{"style":1073},[19305],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19307,"children":19308},{"style":2215},[19309],{"type":55,"value":19310},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n",{"type":49,"tag":1060,"props":19312,"children":19313},{"class":1062,"line":1218},[19314,19318],{"type":49,"tag":1060,"props":19315,"children":19316},{"style":1073},[19317],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19319,"children":19320},{"style":2215},[19321],{"type":55,"value":18335},{"type":49,"tag":1060,"props":19323,"children":19324},{"class":1062,"line":1232},[19325,19329],{"type":49,"tag":1060,"props":19326,"children":19327},{"style":3839},[19328],{"type":55,"value":18343},{"type":49,"tag":1060,"props":19330,"children":19331},{"style":1073},[19332],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19334,"children":19335},{"class":1062,"line":1241},[19336,19340],{"type":49,"tag":1060,"props":19337,"children":19338},{"style":1073},[19339],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19341,"children":19342},{"style":2215},[19343],{"type":55,"value":19344},"docker stack deploy -c stack.yml my-stack --with-registry-auth\n",{"type":49,"tag":58,"props":19346,"children":19347},{},[19348,19350,19355,19356,19361,19363,19368,19370,19375,19376,19382,19384,19389,19391,19397,19399,19405,19406,19411,19413,19419],{"type":55,"value":19349},"This job uses the same ",{"type":49,"tag":326,"props":19351,"children":19353},{"className":19352},[],[19354],{"type":55,"value":18747},{"type":55,"value":715},{"type":49,"tag":326,"props":19357,"children":19359},{"className":19358},[],[19360],{"type":55,"value":18755},{"type":55,"value":19362}," that our ",{"type":49,"tag":326,"props":19364,"children":19366},{"className":19365},[],[19367],{"type":55,"value":18182},{"type":55,"value":19369}," stage jobs used. Notice that we set ",{"type":49,"tag":326,"props":19371,"children":19373},{"className":19372},[],[19374],{"type":55,"value":16753},{"type":55,"value":12789},{"type":49,"tag":326,"props":19377,"children":19379},{"className":19378},[],[19380],{"type":55,"value":19381},"\"ssh://root@$DROPLET_IP\"",{"type":55,"value":19383},", this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The ",{"type":49,"tag":326,"props":19385,"children":19387},{"className":19386},[],[19388],{"type":55,"value":18716},{"type":55,"value":19390}," has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, ",{"type":49,"tag":326,"props":19392,"children":19394},{"className":19393},[],[19395],{"type":55,"value":19396},"docker:19.03.1",{"type":55,"value":19398}," is based on Alpine Linus. This version of Linux is super light weight and doesn't come with ",{"type":49,"tag":326,"props":19400,"children":19402},{"className":19401},[],[19403],{"type":55,"value":19404},"openssh-client",{"type":55,"value":8634},{"type":49,"tag":326,"props":19407,"children":19409},{"className":19408},[],[19410],{"type":55,"value":2728},{"type":55,"value":19412},", so our first step is to install these with the Alpine package manager, ",{"type":49,"tag":326,"props":19414,"children":19416},{"className":19415},[],[19417],{"type":55,"value":19418},"apk",{"type":55,"value":6694},{"type":49,"tag":1050,"props":19421,"children":19424},{"code":19238,"language":19422,"meta":8,"className":19423,"style":8},"sh","language-sh shiki shiki-themes github-light github-dark monokai",[19425],{"type":49,"tag":326,"props":19426,"children":19427},{"__ignoreMap":8},[19428],{"type":49,"tag":1060,"props":19429,"children":19430},{"class":1062,"line":1063},[19431,19435,19440,19445,19449,19454,19459],{"type":49,"tag":1060,"props":19432,"children":19433},{"style":1067},[19434],{"type":55,"value":19418},{"type":49,"tag":1060,"props":19436,"children":19437},{"style":2215},[19438],{"type":55,"value":19439}," update",{"type":49,"tag":1060,"props":19441,"children":19442},{"style":1073},[19443],{"type":55,"value":19444}," && ",{"type":49,"tag":1060,"props":19446,"children":19447},{"style":1067},[19448],{"type":55,"value":19418},{"type":49,"tag":1060,"props":19450,"children":19451},{"style":2215},[19452],{"type":55,"value":19453}," add",{"type":49,"tag":1060,"props":19455,"children":19456},{"style":2215},[19457],{"type":55,"value":19458}," openssh-client",{"type":49,"tag":1060,"props":19460,"children":19461},{"style":2215},[19462],{"type":55,"value":19463}," bash\n",{"type":49,"tag":58,"props":19465,"children":19466},{},[19467,19469,19474,19476,19481,19483,19489,19491,19497,19498,19504],{"type":55,"value":19468},"Next, we add the ",{"type":49,"tag":326,"props":19470,"children":19472},{"className":19471},[],[19473],{"type":55,"value":13154},{"type":55,"value":19475}," environment variable into the body of the ",{"type":49,"tag":326,"props":19477,"children":19479},{"className":19478},[],[19480],{"type":55,"value":18837},{"type":55,"value":19482}," private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from ",{"type":49,"tag":326,"props":19484,"children":19486},{"className":19485},[],[19487],{"type":55,"value":19488},"man ssh-agent",{"type":55,"value":19490}," that provides a little bit more context into why we need to run ",{"type":49,"tag":326,"props":19492,"children":19494},{"className":19493},[],[19495],{"type":55,"value":19496},"eval \"$(ssh-agent -s)\"",{"type":55,"value":715},{"type":49,"tag":326,"props":19499,"children":19501},{"className":19500},[],[19502],{"type":55,"value":19503},"ssh-add ~/.ssh/id_rsa",{"type":55,"value":6694},{"type":49,"tag":1050,"props":19506,"children":19508},{"code":19507},"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n",[19509],{"type":49,"tag":326,"props":19510,"children":19511},{"__ignoreMap":8},[19512],{"type":55,"value":19507},{"type":49,"tag":58,"props":19514,"children":19515},{},[19516,19518,19524,19526,19532],{"type":55,"value":19517},"Next, ",{"type":49,"tag":326,"props":19519,"children":19521},{"className":19520},[],[19522],{"type":55,"value":19523},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts",{"type":55,"value":19525}," tells our SSH agent about our Droplet so that it doesn't prompt us with a ",{"type":49,"tag":326,"props":19527,"children":19529},{"className":19528},[],[19530],{"type":55,"value":19531},"Do you want to add this server to known hosts? (yes/no)",{"type":55,"value":19533},", or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH.",{"type":49,"tag":58,"props":19535,"children":19536},{},[19537],{"type":55,"value":19538},"Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:",{"type":49,"tag":1050,"props":19540,"children":19541},{"code":18335},[19542],{"type":49,"tag":326,"props":19543,"children":19544},{"__ignoreMap":8},[19545],{"type":55,"value":18335},{"type":49,"tag":58,"props":19547,"children":19548},{},[19549,19551,19556,19557,19562],{"type":55,"value":19550},"This essentially gives our DigitalOcean Droplet access to the ",{"type":49,"tag":326,"props":19552,"children":19554},{"className":19553},[],[19555],{"type":55,"value":1951},{"type":55,"value":715},{"type":49,"tag":326,"props":19558,"children":19560},{"className":19559},[],[19561],{"type":55,"value":17594},{"type":55,"value":19563}," images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images.",{"type":49,"tag":58,"props":19565,"children":19566},{},[19567,19569,19574],{"type":55,"value":19568},"The last command in the ",{"type":49,"tag":326,"props":19570,"children":19572},{"className":19571},[],[19573],{"type":55,"value":19114},{"type":55,"value":19575}," job is:",{"type":49,"tag":1050,"props":19577,"children":19578},{"code":19344},[19579],{"type":49,"tag":326,"props":19580,"children":19581},{"__ignoreMap":8},[19582],{"type":55,"value":19344},{"type":49,"tag":58,"props":19584,"children":19585},{},[19586,19588,19594,19595,19601],{"type":55,"value":19587},"Check out this link from the docker docs on docker stacks ",{"type":49,"tag":80,"props":19589,"children":19592},{"href":19590,"rel":19591},"https://docs.docker.com/engine/swarm/stack-deploy/",[84],[19593],{"type":55,"value":19590},{"type":55,"value":8561},{"type":49,"tag":326,"props":19596,"children":19598},{"className":19597},[],[19599],{"type":55,"value":19600},"--with-registry-auth",{"type":55,"value":19602}," is important, our command will complete if this is not included, but our application won't start.",{"type":49,"tag":50,"props":19604,"children":19606},{"id":19605},"stackyml",[19607],{"type":49,"tag":326,"props":19608,"children":19610},{"className":19609},[],[19611],{"type":55,"value":19612},"stack.yml",{"type":49,"tag":58,"props":19614,"children":19615},{},[19616,19618,19623,19625,19630,19632,19637,19639,19644],{"type":55,"value":19617},"Now we are ready to tackle the last big file in our repo: ",{"type":49,"tag":326,"props":19619,"children":19621},{"className":19620},[],[19622],{"type":55,"value":19612},{"type":55,"value":19624},". This is a the docker-compose file that we use to deploy our project. The only reason we needed to run ",{"type":49,"tag":326,"props":19626,"children":19628},{"className":19627},[],[19629],{"type":55,"value":18708},{"type":55,"value":19631}," above is because ",{"type":49,"tag":326,"props":19633,"children":19635},{"className":19634},[],[19636],{"type":55,"value":19612},{"type":55,"value":19638}," references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the ",{"type":49,"tag":326,"props":19640,"children":19642},{"className":19641},[],[19643],{"type":55,"value":1951},{"type":55,"value":19645}," service:",{"type":49,"tag":430,"props":19647,"children":19648},{"id":1951},[19649],{"type":55,"value":1951},{"type":49,"tag":1050,"props":19651,"children":19653},{"code":19652,"language":18237,"meta":8,"className":18238,"style":8},"version: '3.4'\nservices:\n  backend:\n  image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n  networks:\n    - main\n  environment:\n    - POSTGRES_PASSWORD\n    - SECRET_KEY\n    - DEBUG\n  volumes:\n    - backendassets:/code/assets\n  depends_on:\n    - postgres\n    - redis\n    - web\n",[19654],{"type":49,"tag":326,"props":19655,"children":19656},{"__ignoreMap":8},[19657,19674,19685,19696,19712,19724,19736,19748,19760,19772,19784,19796,19808,19820,19832,19844],{"type":49,"tag":1060,"props":19658,"children":19659},{"class":1062,"line":1063},[19660,19665,19669],{"type":49,"tag":1060,"props":19661,"children":19662},{"style":3839},[19663],{"type":55,"value":19664},"version",{"type":49,"tag":1060,"props":19666,"children":19667},{"style":1073},[19668],{"type":55,"value":78},{"type":49,"tag":1060,"props":19670,"children":19671},{"style":2215},[19672],{"type":55,"value":19673},"'3.4'\n",{"type":49,"tag":1060,"props":19675,"children":19676},{"class":1062,"line":1079},[19677,19681],{"type":49,"tag":1060,"props":19678,"children":19679},{"style":3839},[19680],{"type":55,"value":18755},{"type":49,"tag":1060,"props":19682,"children":19683},{"style":1073},[19684],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19686,"children":19687},{"class":1062,"line":1088},[19688,19692],{"type":49,"tag":1060,"props":19689,"children":19690},{"style":3839},[19691],{"type":55,"value":4018},{"type":49,"tag":1060,"props":19693,"children":19694},{"style":1073},[19695],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19697,"children":19698},{"class":1062,"line":1097},[19699,19703,19707],{"type":49,"tag":1060,"props":19700,"children":19701},{"style":3839},[19702],{"type":55,"value":18278},{"type":49,"tag":1060,"props":19704,"children":19705},{"style":1073},[19706],{"type":55,"value":78},{"type":49,"tag":1060,"props":19708,"children":19709},{"style":2215},[19710],{"type":55,"value":19711},"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n",{"type":49,"tag":1060,"props":19713,"children":19714},{"class":1062,"line":1111},[19715,19720],{"type":49,"tag":1060,"props":19716,"children":19717},{"style":3839},[19718],{"type":55,"value":19719},"  networks",{"type":49,"tag":1060,"props":19721,"children":19722},{"style":1073},[19723],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19725,"children":19726},{"class":1062,"line":1120},[19727,19731],{"type":49,"tag":1060,"props":19728,"children":19729},{"style":1073},[19730],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19732,"children":19733},{"style":2215},[19734],{"type":55,"value":19735},"main\n",{"type":49,"tag":1060,"props":19737,"children":19738},{"class":1062,"line":1128},[19739,19744],{"type":49,"tag":1060,"props":19740,"children":19741},{"style":3839},[19742],{"type":55,"value":19743},"  environment",{"type":49,"tag":1060,"props":19745,"children":19746},{"style":1073},[19747],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19749,"children":19750},{"class":1062,"line":1141},[19751,19755],{"type":49,"tag":1060,"props":19752,"children":19753},{"style":1073},[19754],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19756,"children":19757},{"style":2215},[19758],{"type":55,"value":19759},"POSTGRES_PASSWORD\n",{"type":49,"tag":1060,"props":19761,"children":19762},{"class":1062,"line":1150},[19763,19767],{"type":49,"tag":1060,"props":19764,"children":19765},{"style":1073},[19766],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19768,"children":19769},{"style":2215},[19770],{"type":55,"value":19771},"SECRET_KEY\n",{"type":49,"tag":1060,"props":19773,"children":19774},{"class":1062,"line":1158},[19775,19779],{"type":49,"tag":1060,"props":19776,"children":19777},{"style":1073},[19778],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19780,"children":19781},{"style":2215},[19782],{"type":55,"value":19783},"DEBUG\n",{"type":49,"tag":1060,"props":19785,"children":19786},{"class":1062,"line":1171},[19787,19792],{"type":49,"tag":1060,"props":19788,"children":19789},{"style":3839},[19790],{"type":55,"value":19791},"  volumes",{"type":49,"tag":1060,"props":19793,"children":19794},{"style":1073},[19795],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19797,"children":19798},{"class":1062,"line":1180},[19799,19803],{"type":49,"tag":1060,"props":19800,"children":19801},{"style":1073},[19802],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19804,"children":19805},{"style":2215},[19806],{"type":55,"value":19807},"backendassets:/code/assets\n",{"type":49,"tag":1060,"props":19809,"children":19810},{"class":1062,"line":1188},[19811,19816],{"type":49,"tag":1060,"props":19812,"children":19813},{"style":3839},[19814],{"type":55,"value":19815},"  depends_on",{"type":49,"tag":1060,"props":19817,"children":19818},{"style":1073},[19819],{"type":55,"value":6862},{"type":49,"tag":1060,"props":19821,"children":19822},{"class":1062,"line":1201},[19823,19827],{"type":49,"tag":1060,"props":19824,"children":19825},{"style":1073},[19826],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19828,"children":19829},{"style":2215},[19830],{"type":55,"value":19831},"postgres\n",{"type":49,"tag":1060,"props":19833,"children":19834},{"class":1062,"line":1210},[19835,19839],{"type":49,"tag":1060,"props":19836,"children":19837},{"style":1073},[19838],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19840,"children":19841},{"style":2215},[19842],{"type":55,"value":19843},"redis\n",{"type":49,"tag":1060,"props":19845,"children":19846},{"class":1062,"line":1218},[19847,19851],{"type":49,"tag":1060,"props":19848,"children":19849},{"style":1073},[19850],{"type":55,"value":6899},{"type":49,"tag":1060,"props":19852,"children":19853},{"style":2215},[19854],{"type":55,"value":19855},"web\n",{"type":49,"tag":58,"props":19857,"children":19858},{},[19859,19860,19865,19867,19872],{"type":55,"value":413},{"type":49,"tag":326,"props":19861,"children":19863},{"className":19862},[],[19864],{"type":55,"value":18747},{"type":55,"value":19866}," is essentially what we defined in ",{"type":49,"tag":326,"props":19868,"children":19870},{"className":19869},[],[19871],{"type":55,"value":17709},{"type":55,"value":19873},", but the syntax is slightly different:",{"type":49,"tag":1050,"props":19875,"children":19876},{"code":19711},[19877],{"type":49,"tag":326,"props":19878,"children":19879},{"__ignoreMap":8},[19880],{"type":55,"value":19711},{"type":49,"tag":58,"props":19882,"children":19883},{},[19884,19886,19891],{"type":55,"value":19885},"We pass environment variables that we defined in GitLab CI via the ",{"type":49,"tag":326,"props":19887,"children":19889},{"className":19888},[],[19890],{"type":55,"value":5113},{"type":55,"value":19892}," key.",{"type":49,"tag":58,"props":19894,"children":19895},{},[19896,19898,19904,19906,19912,19914,19920,19922,19928],{"type":55,"value":19897},"The volume ",{"type":49,"tag":326,"props":19899,"children":19901},{"className":19900},[],[19902],{"type":55,"value":19903},"backendassets",{"type":55,"value":19905}," is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at ",{"type":49,"tag":326,"props":19907,"children":19909},{"className":19908},[],[19910],{"type":55,"value":19911},"/code/assets",{"type":55,"value":19913}," and then define our ",{"type":49,"tag":326,"props":19915,"children":19917},{"className":19916},[],[19918],{"type":55,"value":19919},"STATIC_ROOT",{"type":55,"value":19921}," in Django's ",{"type":49,"tag":326,"props":19923,"children":19925},{"className":19924},[],[19926],{"type":55,"value":19927},"settings.py",{"type":55,"value":19929}," to be:",{"type":49,"tag":1050,"props":19931,"children":19935},{"code":19932,"language":19933,"meta":8,"className":19934,"style":8},"os.path.join(BASE_DIR, \"assets\", \"static\")\n","py","language-py shiki shiki-themes github-light github-dark monokai",[19936],{"type":49,"tag":326,"props":19937,"children":19938},{"__ignoreMap":8},[19939],{"type":49,"tag":1060,"props":19940,"children":19941},{"class":1062,"line":1063},[19942,19947,19952,19956,19961,19965,19970],{"type":49,"tag":1060,"props":19943,"children":19944},{"style":1073},[19945],{"type":55,"value":19946},"os.path.join(",{"type":49,"tag":1060,"props":19948,"children":19949},{"style":2287},[19950],{"type":55,"value":19951},"BASE_DIR",{"type":49,"tag":1060,"props":19953,"children":19954},{"style":1073},[19955],{"type":55,"value":873},{"type":49,"tag":1060,"props":19957,"children":19958},{"style":2215},[19959],{"type":55,"value":19960},"\"assets\"",{"type":49,"tag":1060,"props":19962,"children":19963},{"style":1073},[19964],{"type":55,"value":873},{"type":49,"tag":1060,"props":19966,"children":19967},{"style":2215},[19968],{"type":55,"value":19969},"\"static\"",{"type":49,"tag":1060,"props":19971,"children":19972},{"style":1073},[19973],{"type":55,"value":5126},{"type":49,"tag":58,"props":19975,"children":19976},{},[19977,19979,19984],{"type":55,"value":19978},"Later, when we run ",{"type":49,"tag":326,"props":19980,"children":19982},{"className":19981},[],[19983],{"type":55,"value":3316},{"type":55,"value":19985},", files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application.",{"type":49,"tag":58,"props":19987,"children":19988},{},[19989,19995,19996,20001,20003,20008,20010,20016,20018,20023,20025,20031],{"type":49,"tag":326,"props":19990,"children":19992},{"className":19991},[],[19993],{"type":55,"value":19994},"network",{"type":55,"value":715},{"type":49,"tag":326,"props":19997,"children":19999},{"className":19998},[],[20000],{"type":55,"value":8673},{"type":55,"value":20002}," related to to the other services that this application will communicate with. ",{"type":49,"tag":326,"props":20004,"children":20006},{"className":20005},[],[20007],{"type":55,"value":816},{"type":55,"value":20009}," is a network defined in the ",{"type":49,"tag":326,"props":20011,"children":20013},{"className":20012},[],[20014],{"type":55,"value":20015},"networks",{"type":55,"value":20017}," part of ",{"type":49,"tag":326,"props":20019,"children":20021},{"className":20020},[],[20022],{"type":55,"value":19612},{"type":55,"value":20024},", notice that we reference the ",{"type":49,"tag":326,"props":20026,"children":20028},{"className":20027},[],[20029],{"type":55,"value":20030},"traefik-public",{"type":55,"value":20032}," network here that we created earlier, as well.",{"type":49,"tag":2910,"props":20034,"children":20035},{},[20036],{"type":49,"tag":58,"props":20037,"children":20038},{},[20039,20041,20047],{"type":55,"value":20040},"Depends on helps with service startup order, but it is a better practice to use ",{"type":49,"tag":326,"props":20042,"children":20044},{"className":20043},[],[20045],{"type":55,"value":20046},"./wait-for-it.sh",{"type":55,"value":20048},". However, I have never had any issues related to startup order. I'll try adding this later to make things more robust.",{"type":49,"tag":58,"props":20050,"children":20051},{},[20052,20057,20058,20063,20065,20070,20072,20077,20078,20083,20085,20090,20091,20096,20097,20102,20104,20109,20111,20117,20119,20125,20127,20132],{"type":49,"tag":326,"props":20053,"children":20055},{"className":20054},[],[20056],{"type":55,"value":16169},{"type":55,"value":715},{"type":49,"tag":326,"props":20059,"children":20061},{"className":20060},[],[20062],{"type":55,"value":3151},{"type":55,"value":20064}," will start before ",{"type":49,"tag":326,"props":20066,"children":20068},{"className":20067},[],[20069],{"type":55,"value":1951},{"type":55,"value":20071},". Our Django application will communicate to these services by their hostnames: ",{"type":49,"tag":326,"props":20073,"children":20075},{"className":20074},[],[20076],{"type":55,"value":16169},{"type":55,"value":715},{"type":49,"tag":326,"props":20079,"children":20081},{"className":20080},[],[20082],{"type":55,"value":3151},{"type":55,"value":20084},". The fact that ",{"type":49,"tag":326,"props":20086,"children":20088},{"className":20087},[],[20089],{"type":55,"value":1951},{"type":55,"value":873},{"type":49,"tag":326,"props":20092,"children":20094},{"className":20093},[],[20095],{"type":55,"value":16169},{"type":55,"value":715},{"type":49,"tag":326,"props":20098,"children":20100},{"className":20099},[],[20101],{"type":55,"value":3151},{"type":55,"value":20103}," are all on the same network (",{"type":49,"tag":326,"props":20105,"children":20107},{"className":20106},[],[20108],{"type":55,"value":816},{"type":55,"value":20110},") means that they can resolve each other by these names. For example, the connection string to redis will look like: ",{"type":49,"tag":326,"props":20112,"children":20114},{"className":20113},[],[20115],{"type":55,"value":20116},"redis://redis:6379",{"type":55,"value":20118},". Let's look at the ",{"type":49,"tag":326,"props":20120,"children":20122},{"className":20121},[],[20123],{"type":55,"value":20124},"DATABASES",{"type":55,"value":20126}," configuration in ",{"type":49,"tag":326,"props":20128,"children":20130},{"className":20129},[],[20131],{"type":55,"value":19927},{"type":55,"value":20133}," to see how we connect to Postgres:",{"type":49,"tag":1050,"props":20135,"children":20137},{"code":20136,"language":19933,"meta":8,"className":19934,"style":8},"DATABASES = {\n    \"default\": {\n        \"ENGINE\": \"django.db.backends.postgresql_psycopg2\",\n        \"NAME\": os.environ.get(\"POSTGRES_NAME\", \"postgres\"),\n        \"USER\": os.environ.get(\"POSTGRES_USERNAME\", \"postgres\"),\n        \"PASSWORD\": os.environ.get(\"POSTGRES_PASSWORD\", \"postgres\"),\n        \"HOST\": os.environ.get(\"POSTGRES_SERVICE_HOST\", \"postgres\"),\n        \"PORT\": os.environ.get(\"POSTGRES_SERVICE_PORT\", 5432),\n    }\n}\n",[20138],{"type":49,"tag":326,"props":20139,"children":20140},{"__ignoreMap":8},[20141,20156,20169,20190,20222,20251,20280,20309,20339,20346],{"type":49,"tag":1060,"props":20142,"children":20143},{"class":1062,"line":1063},[20144,20148,20152],{"type":49,"tag":1060,"props":20145,"children":20146},{"style":2287},[20147],{"type":55,"value":20124},{"type":49,"tag":1060,"props":20149,"children":20150},{"style":2194},[20151],{"type":55,"value":2197},{"type":49,"tag":1060,"props":20153,"children":20154},{"style":1073},[20155],{"type":55,"value":4010},{"type":49,"tag":1060,"props":20157,"children":20158},{"class":1062,"line":1079},[20159,20164],{"type":49,"tag":1060,"props":20160,"children":20161},{"style":2215},[20162],{"type":55,"value":20163},"    \"default\"",{"type":49,"tag":1060,"props":20165,"children":20166},{"style":1073},[20167],{"type":55,"value":20168},": {\n",{"type":49,"tag":1060,"props":20170,"children":20171},{"class":1062,"line":1088},[20172,20177,20181,20186],{"type":49,"tag":1060,"props":20173,"children":20174},{"style":2215},[20175],{"type":55,"value":20176},"        \"ENGINE\"",{"type":49,"tag":1060,"props":20178,"children":20179},{"style":1073},[20180],{"type":55,"value":78},{"type":49,"tag":1060,"props":20182,"children":20183},{"style":2215},[20184],{"type":55,"value":20185},"\"django.db.backends.postgresql_psycopg2\"",{"type":49,"tag":1060,"props":20187,"children":20188},{"style":1073},[20189],{"type":55,"value":2497},{"type":49,"tag":1060,"props":20191,"children":20192},{"class":1062,"line":1097},[20193,20198,20203,20208,20212,20217],{"type":49,"tag":1060,"props":20194,"children":20195},{"style":2215},[20196],{"type":55,"value":20197},"        \"NAME\"",{"type":49,"tag":1060,"props":20199,"children":20200},{"style":1073},[20201],{"type":55,"value":20202},": os.environ.get(",{"type":49,"tag":1060,"props":20204,"children":20205},{"style":2215},[20206],{"type":55,"value":20207},"\"POSTGRES_NAME\"",{"type":49,"tag":1060,"props":20209,"children":20210},{"style":1073},[20211],{"type":55,"value":873},{"type":49,"tag":1060,"props":20213,"children":20214},{"style":2215},[20215],{"type":55,"value":20216},"\"postgres\"",{"type":49,"tag":1060,"props":20218,"children":20219},{"style":1073},[20220],{"type":55,"value":20221},"),\n",{"type":49,"tag":1060,"props":20223,"children":20224},{"class":1062,"line":1111},[20225,20230,20234,20239,20243,20247],{"type":49,"tag":1060,"props":20226,"children":20227},{"style":2215},[20228],{"type":55,"value":20229},"        \"USER\"",{"type":49,"tag":1060,"props":20231,"children":20232},{"style":1073},[20233],{"type":55,"value":20202},{"type":49,"tag":1060,"props":20235,"children":20236},{"style":2215},[20237],{"type":55,"value":20238},"\"POSTGRES_USERNAME\"",{"type":49,"tag":1060,"props":20240,"children":20241},{"style":1073},[20242],{"type":55,"value":873},{"type":49,"tag":1060,"props":20244,"children":20245},{"style":2215},[20246],{"type":55,"value":20216},{"type":49,"tag":1060,"props":20248,"children":20249},{"style":1073},[20250],{"type":55,"value":20221},{"type":49,"tag":1060,"props":20252,"children":20253},{"class":1062,"line":1120},[20254,20259,20263,20268,20272,20276],{"type":49,"tag":1060,"props":20255,"children":20256},{"style":2215},[20257],{"type":55,"value":20258},"        \"PASSWORD\"",{"type":49,"tag":1060,"props":20260,"children":20261},{"style":1073},[20262],{"type":55,"value":20202},{"type":49,"tag":1060,"props":20264,"children":20265},{"style":2215},[20266],{"type":55,"value":20267},"\"POSTGRES_PASSWORD\"",{"type":49,"tag":1060,"props":20269,"children":20270},{"style":1073},[20271],{"type":55,"value":873},{"type":49,"tag":1060,"props":20273,"children":20274},{"style":2215},[20275],{"type":55,"value":20216},{"type":49,"tag":1060,"props":20277,"children":20278},{"style":1073},[20279],{"type":55,"value":20221},{"type":49,"tag":1060,"props":20281,"children":20282},{"class":1062,"line":1128},[20283,20288,20292,20297,20301,20305],{"type":49,"tag":1060,"props":20284,"children":20285},{"style":2215},[20286],{"type":55,"value":20287},"        \"HOST\"",{"type":49,"tag":1060,"props":20289,"children":20290},{"style":1073},[20291],{"type":55,"value":20202},{"type":49,"tag":1060,"props":20293,"children":20294},{"style":2215},[20295],{"type":55,"value":20296},"\"POSTGRES_SERVICE_HOST\"",{"type":49,"tag":1060,"props":20298,"children":20299},{"style":1073},[20300],{"type":55,"value":873},{"type":49,"tag":1060,"props":20302,"children":20303},{"style":2215},[20304],{"type":55,"value":20216},{"type":49,"tag":1060,"props":20306,"children":20307},{"style":1073},[20308],{"type":55,"value":20221},{"type":49,"tag":1060,"props":20310,"children":20311},{"class":1062,"line":1141},[20312,20317,20321,20326,20330,20335],{"type":49,"tag":1060,"props":20313,"children":20314},{"style":2215},[20315],{"type":55,"value":20316},"        \"PORT\"",{"type":49,"tag":1060,"props":20318,"children":20319},{"style":1073},[20320],{"type":55,"value":20202},{"type":49,"tag":1060,"props":20322,"children":20323},{"style":2215},[20324],{"type":55,"value":20325},"\"POSTGRES_SERVICE_PORT\"",{"type":49,"tag":1060,"props":20327,"children":20328},{"style":1073},[20329],{"type":55,"value":873},{"type":49,"tag":1060,"props":20331,"children":20332},{"style":2287},[20333],{"type":55,"value":20334},"5432",{"type":49,"tag":1060,"props":20336,"children":20337},{"style":1073},[20338],{"type":55,"value":20221},{"type":49,"tag":1060,"props":20340,"children":20341},{"class":1062,"line":1150},[20342],{"type":49,"tag":1060,"props":20343,"children":20344},{"style":1073},[20345],{"type":55,"value":3100},{"type":49,"tag":1060,"props":20347,"children":20348},{"class":1062,"line":1158},[20349],{"type":49,"tag":1060,"props":20350,"children":20351},{"style":1073},[20352],{"type":55,"value":3675},{"type":49,"tag":58,"props":20354,"children":20355},{},[20356,20358,20364,20366,20372,20374,20380],{"type":55,"value":20357},"I have defined the ",{"type":49,"tag":326,"props":20359,"children":20361},{"className":20360},[],[20362],{"type":55,"value":20363},"HOST",{"type":55,"value":20365}," to be based on the environment variable ",{"type":49,"tag":326,"props":20367,"children":20369},{"className":20368},[],[20370],{"type":55,"value":20371},"POSTGRES_HOST",{"type":55,"value":20373},", but I have not defined this environment variable, so why didn't I just say ",{"type":49,"tag":326,"props":20375,"children":20377},{"className":20376},[],[20378],{"type":55,"value":20379},"\"HOST\": \"postgres\"",{"type":55,"value":20381},"? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values.",{"type":49,"tag":58,"props":20383,"children":20384},{},[20385],{"type":55,"value":20386},"I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself.",{"type":49,"tag":430,"props":20388,"children":20389},{"id":17594},[20390],{"type":55,"value":20391},"NGINX",{"type":49,"tag":58,"props":20393,"children":20394},{},[20395,20397,20403],{"type":55,"value":20396},"The next service we should go over is ",{"type":49,"tag":326,"props":20398,"children":20400},{"className":20399},[],[20401],{"type":55,"value":20402},"web",{"type":55,"value":20404},", the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:",{"type":49,"tag":8994,"props":20406,"children":20407},{},[20408,20413,20418],{"type":49,"tag":68,"props":20409,"children":20410},{},[20411],{"type":55,"value":20412},"Reverse proxy",{"type":49,"tag":68,"props":20414,"children":20415},{},[20416],{"type":55,"value":20417},"Serve static files for Django",{"type":49,"tag":68,"props":20419,"children":20420},{},[20421],{"type":55,"value":20422},"Serve a frontend Javascript application",{"type":49,"tag":58,"props":20424,"children":20425},{},[20426,20428,20433],{"type":55,"value":20427},"Here's the definition of this service in ",{"type":49,"tag":326,"props":20429,"children":20431},{"className":20430},[],[20432],{"type":55,"value":19612},{"type":55,"value":6694},{"type":49,"tag":1050,"props":20435,"children":20437},{"code":20436,"language":18237,"meta":8,"className":18238,"style":8},"services:\n  web:\n    image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n    networks:\n      - traefik-public\n      - main\n    volumes:\n      - backendassets:/usr/src/app/assets\n    deploy:\n      labels:\n        - 'traefik.enable=true'\n        - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n        - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n        - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n        - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",[20438],{"type":49,"tag":326,"props":20439,"children":20440},{"__ignoreMap":8},[20441,20452,20464,20481,20493,20505,20516,20528,20540,20552,20564,20577,20589,20601,20613],{"type":49,"tag":1060,"props":20442,"children":20443},{"class":1062,"line":1063},[20444,20448],{"type":49,"tag":1060,"props":20445,"children":20446},{"style":3839},[20447],{"type":55,"value":18755},{"type":49,"tag":1060,"props":20449,"children":20450},{"style":1073},[20451],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20453,"children":20454},{"class":1062,"line":1079},[20455,20460],{"type":49,"tag":1060,"props":20456,"children":20457},{"style":3839},[20458],{"type":55,"value":20459},"  web",{"type":49,"tag":1060,"props":20461,"children":20462},{"style":1073},[20463],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20465,"children":20466},{"class":1062,"line":1088},[20467,20472,20476],{"type":49,"tag":1060,"props":20468,"children":20469},{"style":3839},[20470],{"type":55,"value":20471},"    image",{"type":49,"tag":1060,"props":20473,"children":20474},{"style":1073},[20475],{"type":55,"value":78},{"type":49,"tag":1060,"props":20477,"children":20478},{"style":2215},[20479],{"type":55,"value":20480},"${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n",{"type":49,"tag":1060,"props":20482,"children":20483},{"class":1062,"line":1097},[20484,20489],{"type":49,"tag":1060,"props":20485,"children":20486},{"style":3839},[20487],{"type":55,"value":20488},"    networks",{"type":49,"tag":1060,"props":20490,"children":20491},{"style":1073},[20492],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20494,"children":20495},{"class":1062,"line":1111},[20496,20500],{"type":49,"tag":1060,"props":20497,"children":20498},{"style":1073},[20499],{"type":55,"value":3836},{"type":49,"tag":1060,"props":20501,"children":20502},{"style":2215},[20503],{"type":55,"value":20504},"traefik-public\n",{"type":49,"tag":1060,"props":20506,"children":20507},{"class":1062,"line":1120},[20508,20512],{"type":49,"tag":1060,"props":20509,"children":20510},{"style":1073},[20511],{"type":55,"value":3836},{"type":49,"tag":1060,"props":20513,"children":20514},{"style":2215},[20515],{"type":55,"value":19735},{"type":49,"tag":1060,"props":20517,"children":20518},{"class":1062,"line":1128},[20519,20524],{"type":49,"tag":1060,"props":20520,"children":20521},{"style":3839},[20522],{"type":55,"value":20523},"    volumes",{"type":49,"tag":1060,"props":20525,"children":20526},{"style":1073},[20527],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20529,"children":20530},{"class":1062,"line":1141},[20531,20535],{"type":49,"tag":1060,"props":20532,"children":20533},{"style":1073},[20534],{"type":55,"value":3836},{"type":49,"tag":1060,"props":20536,"children":20537},{"style":2215},[20538],{"type":55,"value":20539},"backendassets:/usr/src/app/assets\n",{"type":49,"tag":1060,"props":20541,"children":20542},{"class":1062,"line":1150},[20543,20548],{"type":49,"tag":1060,"props":20544,"children":20545},{"style":3839},[20546],{"type":55,"value":20547},"    deploy",{"type":49,"tag":1060,"props":20549,"children":20550},{"style":1073},[20551],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20553,"children":20554},{"class":1062,"line":1158},[20555,20560],{"type":49,"tag":1060,"props":20556,"children":20557},{"style":3839},[20558],{"type":55,"value":20559},"      labels",{"type":49,"tag":1060,"props":20561,"children":20562},{"style":1073},[20563],{"type":55,"value":6862},{"type":49,"tag":1060,"props":20565,"children":20566},{"class":1062,"line":1171},[20567,20572],{"type":49,"tag":1060,"props":20568,"children":20569},{"style":1073},[20570],{"type":55,"value":20571},"        - ",{"type":49,"tag":1060,"props":20573,"children":20574},{"style":2215},[20575],{"type":55,"value":20576},"'traefik.enable=true'\n",{"type":49,"tag":1060,"props":20578,"children":20579},{"class":1062,"line":1180},[20580,20584],{"type":49,"tag":1060,"props":20581,"children":20582},{"style":1073},[20583],{"type":55,"value":20571},{"type":49,"tag":1060,"props":20585,"children":20586},{"style":2215},[20587],{"type":55,"value":20588},"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n",{"type":49,"tag":1060,"props":20590,"children":20591},{"class":1062,"line":1188},[20592,20596],{"type":49,"tag":1060,"props":20593,"children":20594},{"style":1073},[20595],{"type":55,"value":20571},{"type":49,"tag":1060,"props":20597,"children":20598},{"style":2215},[20599],{"type":55,"value":20600},"'traefik.http.routers.nginx-web.entrypoints=websecure'\n",{"type":49,"tag":1060,"props":20602,"children":20603},{"class":1062,"line":1201},[20604,20608],{"type":49,"tag":1060,"props":20605,"children":20606},{"style":1073},[20607],{"type":55,"value":20571},{"type":49,"tag":1060,"props":20609,"children":20610},{"style":2215},[20611],{"type":55,"value":20612},"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n",{"type":49,"tag":1060,"props":20614,"children":20615},{"class":1062,"line":1210},[20616,20620],{"type":49,"tag":1060,"props":20617,"children":20618},{"style":1073},[20619],{"type":55,"value":20571},{"type":49,"tag":1060,"props":20621,"children":20622},{"style":2215},[20623],{"type":55,"value":20624},"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",{"type":49,"tag":58,"props":20626,"children":20627},{},[20628,20630,20635,20637,20642],{"type":55,"value":20629},"For now, ignore the contents under the ",{"type":49,"tag":326,"props":20631,"children":20633},{"className":20632},[],[20634],{"type":55,"value":18189},{"type":55,"value":20636}," key; we will cover this next when we go over the ",{"type":49,"tag":326,"props":20638,"children":20640},{"className":20639},[],[20641],{"type":55,"value":17593},{"type":55,"value":20643}," service.",{"type":49,"tag":58,"props":20645,"children":20646},{},[20647,20649,20654,20655,20660,20662,20667,20669,20675],{"type":55,"value":20648},"NGINX acts as a reverse proxy when it sends request starting with ",{"type":49,"tag":326,"props":20650,"children":20652},{"className":20651},[],[20653],{"type":55,"value":8632},{"type":55,"value":8634},{"type":49,"tag":326,"props":20656,"children":20658},{"className":20657},[],[20659],{"type":55,"value":8640},{"type":55,"value":20661}," to the ",{"type":49,"tag":326,"props":20663,"children":20665},{"className":20664},[],[20666],{"type":55,"value":1951},{"type":55,"value":20668}," container. Two blocks in ",{"type":49,"tag":326,"props":20670,"children":20672},{"className":20671},[],[20673],{"type":55,"value":20674},"prod.conf",{"type":55,"value":20676}," enable this behavior:",{"type":49,"tag":1050,"props":20678,"children":20680},{"code":20679},"  upstream backend {\n    server backend:8000;\n  }\n",[20681],{"type":49,"tag":326,"props":20682,"children":20683},{"__ignoreMap":8},[20684],{"type":55,"value":20679},{"type":49,"tag":58,"props":20686,"children":20687},{},[20688,20690,20695,20697,20702,20703,20708,20710,20715,20717,20722,20724,20729,20731,20736,20737,20742,20744,20749,20751,20756],{"type":55,"value":20689},"This hostname ",{"type":49,"tag":326,"props":20691,"children":20693},{"className":20692},[],[20694],{"type":55,"value":1951},{"type":55,"value":20696}," is defined as ",{"type":49,"tag":326,"props":20698,"children":20700},{"className":20699},[],[20701],{"type":55,"value":15337},{"type":55,"value":8561},{"type":49,"tag":326,"props":20704,"children":20706},{"className":20705},[],[20707],{"type":55,"value":15337},{"type":55,"value":20709}," can be resolved by the ",{"type":49,"tag":326,"props":20711,"children":20713},{"className":20712},[],[20714],{"type":55,"value":20402},{"type":55,"value":20716}," service because it is on the same ",{"type":49,"tag":326,"props":20718,"children":20720},{"className":20719},[],[20721],{"type":55,"value":816},{"type":55,"value":20723}," network that ",{"type":49,"tag":326,"props":20725,"children":20727},{"className":20726},[],[20728],{"type":55,"value":1951},{"type":55,"value":20730}," is on. If either of the ",{"type":49,"tag":326,"props":20732,"children":20734},{"className":20733},[],[20735],{"type":55,"value":20402},{"type":55,"value":8634},{"type":49,"tag":326,"props":20738,"children":20740},{"className":20739},[],[20741],{"type":55,"value":1951},{"type":55,"value":20743}," wasn't on the ",{"type":49,"tag":326,"props":20745,"children":20747},{"className":20746},[],[20748],{"type":55,"value":816},{"type":55,"value":20750}," network, NGINX would not be able to make sense of ",{"type":49,"tag":326,"props":20752,"children":20754},{"className":20753},[],[20755],{"type":55,"value":15337},{"type":55,"value":745},{"type":49,"tag":1050,"props":20758,"children":20760},{"code":20759},"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n",[20761],{"type":49,"tag":326,"props":20762,"children":20763},{"__ignoreMap":8},[20764],{"type":55,"value":20759},{"type":49,"tag":58,"props":20766,"children":20767},{},[20768,20770,20775,20777,20783],{"type":55,"value":20769},"This block does that actual request forwarding. ",{"type":49,"tag":326,"props":20771,"children":20773},{"className":20772},[],[20774],{"type":55,"value":16347},{"type":55,"value":20776}," references the ",{"type":49,"tag":326,"props":20778,"children":20780},{"className":20779},[],[20781],{"type":55,"value":20782},"upstream backend {}",{"type":55,"value":20784}," block defined above.",{"type":49,"tag":58,"props":20786,"children":20787},{},[20788,20789,20794,20796,20802,20804,20809],{"type":55,"value":19897},{"type":49,"tag":326,"props":20790,"children":20792},{"className":20791},[],[20793],{"type":55,"value":19903},{"type":55,"value":20795}," is referenced here and mounts to ",{"type":49,"tag":326,"props":20797,"children":20799},{"className":20798},[],[20800],{"type":55,"value":20801},"/usr/src/app/assets",{"type":55,"value":20803},". This path is then referenced in ",{"type":49,"tag":326,"props":20805,"children":20807},{"className":20806},[],[20808],{"type":55,"value":20674},{"type":55,"value":20810},", the NGINX configuration file that is used in our custom NGINX-based image:",{"type":49,"tag":1050,"props":20812,"children":20814},{"code":20813},"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n",[20815],{"type":49,"tag":326,"props":20816,"children":20817},{"__ignoreMap":8},[20818],{"type":55,"value":20813},{"type":49,"tag":58,"props":20820,"children":20821},{},[20822,20824,20829,20831,20837,20839,20845,20847,20853,20855,20860,20862,20868,20870,20875,20877,20882,20884,20889,20891,20896],{"type":55,"value":20823},"In this block of ",{"type":49,"tag":326,"props":20825,"children":20827},{"className":20826},[],[20828],{"type":55,"value":20674},{"type":55,"value":20830},", we tell NGINX to serve files from ",{"type":49,"tag":326,"props":20832,"children":20834},{"className":20833},[],[20835],{"type":55,"value":20836},"/usr/src/app/assets/static",{"type":55,"value":20838}," for requests that start with ",{"type":49,"tag":326,"props":20840,"children":20842},{"className":20841},[],[20843],{"type":55,"value":20844},"/static",{"type":55,"value":20846},". A request made to ",{"type":49,"tag":326,"props":20848,"children":20850},{"className":20849},[],[20851],{"type":55,"value":20852},"https://mysite.com/static/base.css",{"type":55,"value":20854}," would return a file located at ",{"type":49,"tag":326,"props":20856,"children":20858},{"className":20857},[],[20859],{"type":55,"value":20836},{"type":55,"value":20861}," if that file existed. Remember, when we run the ",{"type":49,"tag":326,"props":20863,"children":20865},{"className":20864},[],[20866],{"type":55,"value":20867},"collecstatic",{"type":55,"value":20869}," management command in our Django container, it will collect our static files to ",{"type":49,"tag":326,"props":20871,"children":20873},{"className":20872},[],[20874],{"type":55,"value":19903},{"type":55,"value":20876},". Since ",{"type":49,"tag":326,"props":20878,"children":20880},{"className":20879},[],[20881],{"type":55,"value":19903},{"type":55,"value":20883}," is mounted to the ",{"type":49,"tag":326,"props":20885,"children":20887},{"className":20886},[],[20888],{"type":55,"value":20402},{"type":55,"value":20890}," service at ",{"type":49,"tag":326,"props":20892,"children":20894},{"className":20893},[],[20895],{"type":55,"value":20801},{"type":55,"value":20897},", NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container.",{"type":49,"tag":58,"props":20899,"children":20900},{},[20901,20903,20908],{"type":55,"value":20902},"Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the ",{"type":49,"tag":326,"props":20904,"children":20906},{"className":20905},[],[20907],{"type":55,"value":17594},{"type":55,"value":20909}," container:",{"type":49,"tag":1050,"props":20911,"children":20914},{"code":20912,"language":18565,"meta":8,"className":20913,"style":8},"# # build stage\n# FROM node:10-alpine as build-stage\n# WORKDIR /app/\n# COPY frontend/package.json /app/\n# RUN npm cache verify\n# RUN npm install\n# COPY frontend /app/\n# RUN npm run build\n\n# production stage\n# FROM nginx:1.19.1-alpine as production-stage\nFROM nginx:1.19.1-alpine\nCOPY nginx/prod/prod.conf /etc/nginx/nginx.conf\nCOPY nginx/prod/index.html /dist/\n# COPY --from=build-stage /app/dist /dist/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n","language-Dockerfile shiki shiki-themes github-light github-dark monokai",[20915],{"type":49,"tag":326,"props":20916,"children":20917},{"__ignoreMap":8},[20918,20926,20934,20942,20950,20958,20966,20974,20982,20989,20997,21005,21013,21021,21029,21037,21045],{"type":49,"tag":1060,"props":20919,"children":20920},{"class":1062,"line":1063},[20921],{"type":49,"tag":1060,"props":20922,"children":20923},{},[20924],{"type":55,"value":20925},"# # build stage\n",{"type":49,"tag":1060,"props":20927,"children":20928},{"class":1062,"line":1079},[20929],{"type":49,"tag":1060,"props":20930,"children":20931},{},[20932],{"type":55,"value":20933},"# FROM node:10-alpine as build-stage\n",{"type":49,"tag":1060,"props":20935,"children":20936},{"class":1062,"line":1088},[20937],{"type":49,"tag":1060,"props":20938,"children":20939},{},[20940],{"type":55,"value":20941},"# WORKDIR /app/\n",{"type":49,"tag":1060,"props":20943,"children":20944},{"class":1062,"line":1097},[20945],{"type":49,"tag":1060,"props":20946,"children":20947},{},[20948],{"type":55,"value":20949},"# COPY frontend/package.json /app/\n",{"type":49,"tag":1060,"props":20951,"children":20952},{"class":1062,"line":1111},[20953],{"type":49,"tag":1060,"props":20954,"children":20955},{},[20956],{"type":55,"value":20957},"# RUN npm cache verify\n",{"type":49,"tag":1060,"props":20959,"children":20960},{"class":1062,"line":1120},[20961],{"type":49,"tag":1060,"props":20962,"children":20963},{},[20964],{"type":55,"value":20965},"# RUN npm install\n",{"type":49,"tag":1060,"props":20967,"children":20968},{"class":1062,"line":1128},[20969],{"type":49,"tag":1060,"props":20970,"children":20971},{},[20972],{"type":55,"value":20973},"# COPY frontend /app/\n",{"type":49,"tag":1060,"props":20975,"children":20976},{"class":1062,"line":1141},[20977],{"type":49,"tag":1060,"props":20978,"children":20979},{},[20980],{"type":55,"value":20981},"# RUN npm run build\n",{"type":49,"tag":1060,"props":20983,"children":20984},{"class":1062,"line":1150},[20985],{"type":49,"tag":1060,"props":20986,"children":20987},{"emptyLinePlaceholder":44},[20988],{"type":55,"value":1094},{"type":49,"tag":1060,"props":20990,"children":20991},{"class":1062,"line":1158},[20992],{"type":49,"tag":1060,"props":20993,"children":20994},{},[20995],{"type":55,"value":20996},"# production stage\n",{"type":49,"tag":1060,"props":20998,"children":20999},{"class":1062,"line":1171},[21000],{"type":49,"tag":1060,"props":21001,"children":21002},{},[21003],{"type":55,"value":21004},"# FROM nginx:1.19.1-alpine as production-stage\n",{"type":49,"tag":1060,"props":21006,"children":21007},{"class":1062,"line":1180},[21008],{"type":49,"tag":1060,"props":21009,"children":21010},{},[21011],{"type":55,"value":21012},"FROM nginx:1.19.1-alpine\n",{"type":49,"tag":1060,"props":21014,"children":21015},{"class":1062,"line":1188},[21016],{"type":49,"tag":1060,"props":21017,"children":21018},{},[21019],{"type":55,"value":21020},"COPY nginx/prod/prod.conf /etc/nginx/nginx.conf\n",{"type":49,"tag":1060,"props":21022,"children":21023},{"class":1062,"line":1201},[21024],{"type":49,"tag":1060,"props":21025,"children":21026},{},[21027],{"type":55,"value":21028},"COPY nginx/prod/index.html /dist/\n",{"type":49,"tag":1060,"props":21030,"children":21031},{"class":1062,"line":1210},[21032],{"type":49,"tag":1060,"props":21033,"children":21034},{},[21035],{"type":55,"value":21036},"# COPY --from=build-stage /app/dist /dist/\n",{"type":49,"tag":1060,"props":21038,"children":21039},{"class":1062,"line":1218},[21040],{"type":49,"tag":1060,"props":21041,"children":21042},{},[21043],{"type":55,"value":21044},"EXPOSE 80\n",{"type":49,"tag":1060,"props":21046,"children":21047},{"class":1062,"line":1232},[21048],{"type":49,"tag":1060,"props":21049,"children":21050},{},[21051],{"type":55,"value":21052},"CMD [\"nginx\", \"-g\", \"daemon off;\"]\n",{"type":49,"tag":58,"props":21054,"children":21055},{},[21056],{"type":55,"value":21057},"Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:",{"type":49,"tag":1050,"props":21059,"children":21061},{"code":21060,"language":18565,"meta":8,"className":20913,"style":8},"COPY --from=build-stage /app/dist /dist/\n",[21062],{"type":49,"tag":326,"props":21063,"children":21064},{"__ignoreMap":8},[21065],{"type":49,"tag":1060,"props":21066,"children":21067},{"class":1062,"line":1063},[21068],{"type":49,"tag":1060,"props":21069,"children":21070},{},[21071],{"type":55,"value":21060},{"type":49,"tag":58,"props":21073,"children":21074},{},[21075,21077,21083,21085,21090],{"type":55,"value":21076},"This would copy the build files for our Javascript application into the ",{"type":49,"tag":326,"props":21078,"children":21080},{"className":21079},[],[21081],{"type":55,"value":21082},"/dist/",{"type":55,"value":21084}," folder of our NGINX container. Another few declarations and blocks in ",{"type":49,"tag":326,"props":21086,"children":21088},{"className":21087},[],[21089],{"type":55,"value":20674},{"type":55,"value":21091}," allow all other requests to be served by the contents of this folder:",{"type":49,"tag":1050,"props":21093,"children":21095},{"code":21094},"    root /dist/;\n    index index.html;\n",[21096],{"type":49,"tag":326,"props":21097,"children":21098},{"__ignoreMap":8},[21099],{"type":55,"value":21094},{"type":49,"tag":58,"props":21101,"children":21102},{},[21103],{"type":55,"value":21104},"This sets the root and the index document for our NGINX webserver.",{"type":49,"tag":1050,"props":21106,"children":21108},{"code":21107},"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n",[21109],{"type":49,"tag":326,"props":21110,"children":21111},{"__ignoreMap":8},[21112],{"type":55,"value":21107},{"type":49,"tag":58,"props":21114,"children":21115},{},[21116,21118,21123,21125,21130,21132,21137,21138,21143,21144,21149],{"type":55,"value":21117},"These two blocks route all other requests to the frontend Javascript app's ",{"type":49,"tag":326,"props":21119,"children":21121},{"className":21120},[],[21122],{"type":55,"value":14354},{"type":55,"value":21124}," file location in ",{"type":49,"tag":326,"props":21126,"children":21128},{"className":21127},[],[21129],{"type":55,"value":21082},{"type":55,"value":21131}," (any request that doesn't start with ",{"type":49,"tag":326,"props":21133,"children":21135},{"className":21134},[],[21136],{"type":55,"value":20844},{"type":55,"value":873},{"type":49,"tag":326,"props":21139,"children":21141},{"className":21140},[],[21142],{"type":55,"value":8632},{"type":55,"value":8634},{"type":49,"tag":326,"props":21145,"children":21147},{"className":21146},[],[21148],{"type":55,"value":8640},{"type":55,"value":21150},"). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path.",{"type":49,"tag":58,"props":21152,"children":21153},{},[21154,21156,21161,21163,21169,21171,21177,21179,21184],{"type":55,"value":21155},"Lastly, the ",{"type":49,"tag":326,"props":21157,"children":21159},{"className":21158},[],[21160],{"type":55,"value":20402},{"type":55,"value":21162}," service's ",{"type":49,"tag":326,"props":21164,"children":21166},{"className":21165},[],[21167],{"type":55,"value":21168},"deployment",{"type":55,"value":21170}," key has some ",{"type":49,"tag":326,"props":21172,"children":21174},{"className":21173},[],[21175],{"type":55,"value":21176},"labels",{"type":55,"value":21178}," defined for Traefik. Let's come back to these after having a look at the ",{"type":49,"tag":326,"props":21180,"children":21182},{"className":21181},[],[21183],{"type":55,"value":17593},{"type":55,"value":20643},{"type":49,"tag":430,"props":21186,"children":21187},{"id":17593},[21188],{"type":55,"value":21189},"Traefik",{"type":49,"tag":58,"props":21191,"children":21192},{},[21193],{"type":49,"tag":1601,"props":21194,"children":21196},{"alt":8926,"src":21195},"https://docs.traefik.io/assets/img/traefik-architecture.png",[],{"type":49,"tag":2910,"props":21198,"children":21199},{},[21200],{"type":49,"tag":58,"props":21201,"children":21202},{},[21203,21205],{"type":55,"value":21204},"Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- ",{"type":49,"tag":80,"props":21206,"children":21209},{"href":21207,"rel":21208},"https://docs.traefik.io/",[84],[21210],{"type":55,"value":21207},{"type":49,"tag":58,"props":21212,"children":21213},{},[21214],{"type":55,"value":21215},"Traefik has three main functions in my application:",{"type":49,"tag":8994,"props":21217,"children":21218},{},[21219,21224,21229],{"type":49,"tag":68,"props":21220,"children":21221},{},[21222],{"type":55,"value":21223},"Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS",{"type":49,"tag":68,"props":21225,"children":21226},{},[21227],{"type":55,"value":21228},"Do TLS termination",{"type":49,"tag":68,"props":21230,"children":21231},{},[21232],{"type":55,"value":21233},"Route all requests to NGINX",{"type":49,"tag":58,"props":21235,"children":21236},{},[21237],{"type":55,"value":21238},"The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed \"fun and easy\", especially when it comes to requesting certificates.",{"type":49,"tag":2910,"props":21240,"children":21241},{},[21242],{"type":49,"tag":58,"props":21243,"children":21244},{},[21245],{"type":55,"value":21246},"I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs.",{"type":49,"tag":58,"props":21248,"children":21249},{},[21250],{"type":55,"value":21251},"There are two main ways to set up Traefik:",{"type":49,"tag":8994,"props":21253,"children":21254},{},[21255,21274],{"type":49,"tag":68,"props":21256,"children":21257},{},[21258,21260,21266,21268,21273],{"type":55,"value":21259},"write a ",{"type":49,"tag":326,"props":21261,"children":21263},{"className":21262},[],[21264],{"type":55,"value":21265},"traefik.toml",{"type":55,"value":21267}," file and build this into your own custom image (similar to what we do with NGINX and ",{"type":49,"tag":326,"props":21269,"children":21271},{"className":21270},[],[21272],{"type":55,"value":20674},{"type":55,"value":616},{"type":49,"tag":68,"props":21275,"children":21276},{},[21277],{"type":55,"value":21278},"use a base image and specify all configure options through command line arguments.",{"type":49,"tag":58,"props":21280,"children":21281},{},[21282,21284,21289,21291,21296],{"type":55,"value":21283},"I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in ",{"type":49,"tag":326,"props":21285,"children":21287},{"className":21286},[],[21288],{"type":55,"value":19612},{"type":55,"value":21290}," (for now all the values I'm using in the ",{"type":49,"tag":326,"props":21292,"children":21294},{"className":21293},[],[21295],{"type":55,"value":17593},{"type":55,"value":21297}," service are hard-coded, this is one more item for my ToDo list on this project).",{"type":49,"tag":58,"props":21299,"children":21300},{},[21301,21303,21308,21310,21317,21319,21326],{"type":55,"value":21302},"I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses ",{"type":49,"tag":326,"props":21304,"children":21306},{"className":21305},[],[21307],{"type":55,"value":16254},{"type":55,"value":21309},". There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled ",{"type":49,"tag":80,"props":21311,"children":21314},{"href":21312,"rel":21313},"https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/",[84],[21315],{"type":55,"value":21316},"How to install Traefik 2.x on a Docker Swarm",{"type":55,"value":21318}," helped me a lot in figuring out how to get everything working. Thank you for the great article, ",{"type":49,"tag":80,"props":21320,"children":21323},{"href":21321,"rel":21322},"https://github.com/creekorful",[84],[21324],{"type":55,"value":21325},"AloÃ¯s",{"type":55,"value":21327},"!",{"type":49,"tag":58,"props":21329,"children":21330},{},[21331],{"type":55,"value":21332},"Here's the code that sets up the traefik service:",{"type":49,"tag":1050,"props":21334,"children":21336},{"code":21335,"language":18237,"meta":8,"className":18238,"style":8},"services:\n  traefik:\n    image: traefik:v2.0.2\n    ports:\n      - '80:80'\n      - '443:443'\n    command:\n      - '--providers.docker.endpoint=unix:///var/run/docker.sock'\n      - '--providers.docker.swarmMode=true'\n      - '--providers.docker.exposedbydefault=false'\n      - '--providers.docker.network=traefik-public'\n      - '--entrypoints.web.address=:80'\n      - '--entrypoints.websecure.address=:443'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n      - '--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n      - '--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n    volumes:\n      - letsencrypt:/letsencrypt\n      - /var/run/docker.sock:/var/run/docker.sock\n    networks:\n      - traefik-public\n    deploy:\n      placement:\n        constraints:\n          - node.role == manager\n",[21337],{"type":49,"tag":326,"props":21338,"children":21339},{"__ignoreMap":8},[21340,21351,21363,21379,21391,21403,21415,21427,21439,21451,21463,21475,21487,21499,21511,21523,21535,21547,21558,21570,21582,21593,21604,21615,21627,21639],{"type":49,"tag":1060,"props":21341,"children":21342},{"class":1062,"line":1063},[21343,21347],{"type":49,"tag":1060,"props":21344,"children":21345},{"style":3839},[21346],{"type":55,"value":18755},{"type":49,"tag":1060,"props":21348,"children":21349},{"style":1073},[21350],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21352,"children":21353},{"class":1062,"line":1079},[21354,21359],{"type":49,"tag":1060,"props":21355,"children":21356},{"style":3839},[21357],{"type":55,"value":21358},"  traefik",{"type":49,"tag":1060,"props":21360,"children":21361},{"style":1073},[21362],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21364,"children":21365},{"class":1062,"line":1088},[21366,21370,21374],{"type":49,"tag":1060,"props":21367,"children":21368},{"style":3839},[21369],{"type":55,"value":20471},{"type":49,"tag":1060,"props":21371,"children":21372},{"style":1073},[21373],{"type":55,"value":78},{"type":49,"tag":1060,"props":21375,"children":21376},{"style":2215},[21377],{"type":55,"value":21378},"traefik:v2.0.2\n",{"type":49,"tag":1060,"props":21380,"children":21381},{"class":1062,"line":1097},[21382,21387],{"type":49,"tag":1060,"props":21383,"children":21384},{"style":3839},[21385],{"type":55,"value":21386},"    ports",{"type":49,"tag":1060,"props":21388,"children":21389},{"style":1073},[21390],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21392,"children":21393},{"class":1062,"line":1111},[21394,21398],{"type":49,"tag":1060,"props":21395,"children":21396},{"style":1073},[21397],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21399,"children":21400},{"style":2215},[21401],{"type":55,"value":21402},"'80:80'\n",{"type":49,"tag":1060,"props":21404,"children":21405},{"class":1062,"line":1120},[21406,21410],{"type":49,"tag":1060,"props":21407,"children":21408},{"style":1073},[21409],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21411,"children":21412},{"style":2215},[21413],{"type":55,"value":21414},"'443:443'\n",{"type":49,"tag":1060,"props":21416,"children":21417},{"class":1062,"line":1128},[21418,21423],{"type":49,"tag":1060,"props":21419,"children":21420},{"style":3839},[21421],{"type":55,"value":21422},"    command",{"type":49,"tag":1060,"props":21424,"children":21425},{"style":1073},[21426],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21428,"children":21429},{"class":1062,"line":1141},[21430,21434],{"type":49,"tag":1060,"props":21431,"children":21432},{"style":1073},[21433],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21435,"children":21436},{"style":2215},[21437],{"type":55,"value":21438},"'--providers.docker.endpoint=unix:///var/run/docker.sock'\n",{"type":49,"tag":1060,"props":21440,"children":21441},{"class":1062,"line":1150},[21442,21446],{"type":49,"tag":1060,"props":21443,"children":21444},{"style":1073},[21445],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21447,"children":21448},{"style":2215},[21449],{"type":55,"value":21450},"'--providers.docker.swarmMode=true'\n",{"type":49,"tag":1060,"props":21452,"children":21453},{"class":1062,"line":1158},[21454,21458],{"type":49,"tag":1060,"props":21455,"children":21456},{"style":1073},[21457],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21459,"children":21460},{"style":2215},[21461],{"type":55,"value":21462},"'--providers.docker.exposedbydefault=false'\n",{"type":49,"tag":1060,"props":21464,"children":21465},{"class":1062,"line":1171},[21466,21470],{"type":49,"tag":1060,"props":21467,"children":21468},{"style":1073},[21469],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21471,"children":21472},{"style":2215},[21473],{"type":55,"value":21474},"'--providers.docker.network=traefik-public'\n",{"type":49,"tag":1060,"props":21476,"children":21477},{"class":1062,"line":1180},[21478,21482],{"type":49,"tag":1060,"props":21479,"children":21480},{"style":1073},[21481],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21483,"children":21484},{"style":2215},[21485],{"type":55,"value":21486},"'--entrypoints.web.address=:80'\n",{"type":49,"tag":1060,"props":21488,"children":21489},{"class":1062,"line":1188},[21490,21494],{"type":49,"tag":1060,"props":21491,"children":21492},{"style":1073},[21493],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21495,"children":21496},{"style":2215},[21497],{"type":55,"value":21498},"'--entrypoints.websecure.address=:443'\n",{"type":49,"tag":1060,"props":21500,"children":21501},{"class":1062,"line":1201},[21502,21506],{"type":49,"tag":1060,"props":21503,"children":21504},{"style":1073},[21505],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21507,"children":21508},{"style":2215},[21509],{"type":55,"value":21510},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n",{"type":49,"tag":1060,"props":21512,"children":21513},{"class":1062,"line":1210},[21514,21518],{"type":49,"tag":1060,"props":21515,"children":21516},{"style":1073},[21517],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21519,"children":21520},{"style":2215},[21521],{"type":55,"value":21522},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n",{"type":49,"tag":1060,"props":21524,"children":21525},{"class":1062,"line":1218},[21526,21530],{"type":49,"tag":1060,"props":21527,"children":21528},{"style":1073},[21529],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21531,"children":21532},{"style":2215},[21533],{"type":55,"value":21534},"'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n",{"type":49,"tag":1060,"props":21536,"children":21537},{"class":1062,"line":1232},[21538,21542],{"type":49,"tag":1060,"props":21539,"children":21540},{"style":1073},[21541],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21543,"children":21544},{"style":2215},[21545],{"type":55,"value":21546},"'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n",{"type":49,"tag":1060,"props":21548,"children":21549},{"class":1062,"line":1241},[21550,21554],{"type":49,"tag":1060,"props":21551,"children":21552},{"style":3839},[21553],{"type":55,"value":20523},{"type":49,"tag":1060,"props":21555,"children":21556},{"style":1073},[21557],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21559,"children":21560},{"class":1062,"line":1249},[21561,21565],{"type":49,"tag":1060,"props":21562,"children":21563},{"style":1073},[21564],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21566,"children":21567},{"style":2215},[21568],{"type":55,"value":21569},"letsencrypt:/letsencrypt\n",{"type":49,"tag":1060,"props":21571,"children":21572},{"class":1062,"line":1262},[21573,21577],{"type":49,"tag":1060,"props":21574,"children":21575},{"style":1073},[21576],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21578,"children":21579},{"style":2215},[21580],{"type":55,"value":21581},"/var/run/docker.sock:/var/run/docker.sock\n",{"type":49,"tag":1060,"props":21583,"children":21584},{"class":1062,"line":4581},[21585,21589],{"type":49,"tag":1060,"props":21586,"children":21587},{"style":3839},[21588],{"type":55,"value":20488},{"type":49,"tag":1060,"props":21590,"children":21591},{"style":1073},[21592],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21594,"children":21595},{"class":1062,"line":4631},[21596,21600],{"type":49,"tag":1060,"props":21597,"children":21598},{"style":1073},[21599],{"type":55,"value":3836},{"type":49,"tag":1060,"props":21601,"children":21602},{"style":2215},[21603],{"type":55,"value":20504},{"type":49,"tag":1060,"props":21605,"children":21606},{"class":1062,"line":4682},[21607,21611],{"type":49,"tag":1060,"props":21608,"children":21609},{"style":3839},[21610],{"type":55,"value":20547},{"type":49,"tag":1060,"props":21612,"children":21613},{"style":1073},[21614],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21616,"children":21617},{"class":1062,"line":4709},[21618,21623],{"type":49,"tag":1060,"props":21619,"children":21620},{"style":3839},[21621],{"type":55,"value":21622},"      placement",{"type":49,"tag":1060,"props":21624,"children":21625},{"style":1073},[21626],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21628,"children":21629},{"class":1062,"line":5979},[21630,21635],{"type":49,"tag":1060,"props":21631,"children":21632},{"style":3839},[21633],{"type":55,"value":21634},"        constraints",{"type":49,"tag":1060,"props":21636,"children":21637},{"style":1073},[21638],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21640,"children":21641},{"class":1062,"line":5988},[21642,21647],{"type":49,"tag":1060,"props":21643,"children":21644},{"style":1073},[21645],{"type":55,"value":21646},"          - ",{"type":49,"tag":1060,"props":21648,"children":21649},{"style":2215},[21650],{"type":55,"value":21651},"node.role == manager\n",{"type":49,"tag":2910,"props":21653,"children":21654},{},[21655],{"type":49,"tag":58,"props":21656,"children":21657},{},[21658],{"type":55,"value":21659},"The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad.",{"type":49,"tag":58,"props":21661,"children":21662},{},[21663,21668,21669,21675,21677,21682],{"type":49,"tag":326,"props":21664,"children":21666},{"className":21665},[],[21667],{"type":55,"value":20402},{"type":55,"value":715},{"type":49,"tag":326,"props":21670,"children":21672},{"className":21671},[],[21673],{"type":55,"value":21674},"websecure",{"type":55,"value":21676}," refer to values declared on the ",{"type":49,"tag":326,"props":21678,"children":21680},{"className":21679},[],[21681],{"type":55,"value":20402},{"type":55,"value":21683}," service. Let's take a look at those values:",{"type":49,"tag":1050,"props":21685,"children":21687},{"code":21686,"language":3823,"meta":8,"className":3824,"style":8},"deploy:\n  labels:\n    - 'traefik.enable=true'\n    - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n    - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n    - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n    - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",[21688],{"type":49,"tag":326,"props":21689,"children":21690},{"__ignoreMap":8},[21691,21702,21714,21725,21736,21747,21758],{"type":49,"tag":1060,"props":21692,"children":21693},{"class":1062,"line":1063},[21694,21698],{"type":49,"tag":1060,"props":21695,"children":21696},{"style":3839},[21697],{"type":55,"value":18189},{"type":49,"tag":1060,"props":21699,"children":21700},{"style":1073},[21701],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21703,"children":21704},{"class":1062,"line":1079},[21705,21710],{"type":49,"tag":1060,"props":21706,"children":21707},{"style":3839},[21708],{"type":55,"value":21709},"  labels",{"type":49,"tag":1060,"props":21711,"children":21712},{"style":1073},[21713],{"type":55,"value":6862},{"type":49,"tag":1060,"props":21715,"children":21716},{"class":1062,"line":1088},[21717,21721],{"type":49,"tag":1060,"props":21718,"children":21719},{"style":1073},[21720],{"type":55,"value":6899},{"type":49,"tag":1060,"props":21722,"children":21723},{"style":2215},[21724],{"type":55,"value":20576},{"type":49,"tag":1060,"props":21726,"children":21727},{"class":1062,"line":1097},[21728,21732],{"type":49,"tag":1060,"props":21729,"children":21730},{"style":1073},[21731],{"type":55,"value":6899},{"type":49,"tag":1060,"props":21733,"children":21734},{"style":2215},[21735],{"type":55,"value":20588},{"type":49,"tag":1060,"props":21737,"children":21738},{"class":1062,"line":1111},[21739,21743],{"type":49,"tag":1060,"props":21740,"children":21741},{"style":1073},[21742],{"type":55,"value":6899},{"type":49,"tag":1060,"props":21744,"children":21745},{"style":2215},[21746],{"type":55,"value":20600},{"type":49,"tag":1060,"props":21748,"children":21749},{"class":1062,"line":1120},[21750,21754],{"type":49,"tag":1060,"props":21751,"children":21752},{"style":1073},[21753],{"type":55,"value":6899},{"type":49,"tag":1060,"props":21755,"children":21756},{"style":2215},[21757],{"type":55,"value":20612},{"type":49,"tag":1060,"props":21759,"children":21760},{"class":1062,"line":1128},[21761,21765],{"type":49,"tag":1060,"props":21762,"children":21763},{"style":1073},[21764],{"type":55,"value":6899},{"type":49,"tag":1060,"props":21766,"children":21767},{"style":2215},[21768],{"type":55,"value":20624},{"type":49,"tag":58,"props":21770,"children":21771},{},[21772,21774,21779],{"type":55,"value":21773},"I still need to setup HTTP -> HTTPS redirecting, so for now only ",{"type":49,"tag":326,"props":21775,"children":21777},{"className":21776},[],[21778],{"type":55,"value":21674},{"type":55,"value":21780}," is defined, but AloÃ¯s explains this clearly in his article.",{"type":49,"tag":2910,"props":21782,"children":21783},{},[21784],{"type":49,"tag":58,"props":21785,"children":21786},{},[21787],{"type":55,"value":21788},"For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK.",{"type":49,"tag":58,"props":21790,"children":21791},{},[21792,21794,21799],{"type":55,"value":21793},"That wraps up our overview of ",{"type":49,"tag":326,"props":21795,"children":21797},{"className":21796},[],[21798],{"type":55,"value":19612},{"type":55,"value":21800},", we left off with the following command:",{"type":49,"tag":1050,"props":21802,"children":21803},{"code":19344},[21804],{"type":49,"tag":326,"props":21805,"children":21806},{"__ignoreMap":8},[21807],{"type":55,"value":19344},{"type":49,"tag":58,"props":21809,"children":21810},{},[21811,21813,21818],{"type":55,"value":21812},"We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the ",{"type":49,"tag":326,"props":21814,"children":21816},{"className":21815},[],[21817],{"type":55,"value":16753},{"type":55,"value":21819}," environment variable that I showed you earlier and run these commands from your local terminal:",{"type":49,"tag":1050,"props":21821,"children":21823},{"code":21822},"docker stack ps my-stack --no-trunc\n",[21824],{"type":49,"tag":326,"props":21825,"children":21826},{"__ignoreMap":8},[21827],{"type":55,"value":21822},{"type":49,"tag":58,"props":21829,"children":21830},{},[21831,21837,21839,21845],{"type":49,"tag":326,"props":21832,"children":21834},{"className":21833},[],[21835],{"type":55,"value":21836},"--no-trunc",{"type":55,"value":21838}," is important because important error messages tend to be cut off. This option will show the full version of each column returned by ",{"type":49,"tag":326,"props":21840,"children":21842},{"className":21841},[],[21843],{"type":55,"value":21844},"docker stack ps",{"type":55,"value":745},{"type":49,"tag":1050,"props":21847,"children":21849},{"code":21848},"docker service ls\n",[21850],{"type":49,"tag":326,"props":21851,"children":21852},{"__ignoreMap":8},[21853],{"type":55,"value":21848},{"type":49,"tag":58,"props":21855,"children":21856},{},[21857],{"type":55,"value":21858},"This command shows some the active services on our Droplet.",{"type":49,"tag":1050,"props":21860,"children":21862},{"code":21861},"docker ps\n",[21863],{"type":49,"tag":326,"props":21864,"children":21865},{"__ignoreMap":8},[21866],{"type":55,"value":21861},{"type":49,"tag":58,"props":21868,"children":21869},{},[21870],{"type":55,"value":21871},"This command is useful for shelling into a container to run commands and poke around for debugging.",{"type":49,"tag":58,"props":21873,"children":21874},{},[21875],{"type":55,"value":21876},"You can get the Container ID of a running container and access it with the following command:",{"type":49,"tag":1050,"props":21878,"children":21880},{"code":21879},"docker exec -it 0da8370ab283 bash\n",[21881],{"type":49,"tag":326,"props":21882,"children":21883},{"__ignoreMap":8},[21884],{"type":55,"value":21879},{"type":49,"tag":58,"props":21886,"children":21887},{},[21888,21890,21895,21897,21903],{"type":55,"value":21889},"This assumes that ",{"type":49,"tag":326,"props":21891,"children":21893},{"className":21892},[],[21894],{"type":55,"value":2728},{"type":55,"value":21896}," is installed on the container with ID ",{"type":49,"tag":326,"props":21898,"children":21900},{"className":21899},[],[21901],{"type":55,"value":21902},"0da8370ab283",{"type":55,"value":745},{"type":49,"tag":50,"props":21905,"children":21907},{"id":21906},"management-commands",[21908],{"type":55,"value":21909},"Management commands",{"type":49,"tag":58,"props":21911,"children":21912},{},[21913],{"type":55,"value":21914},"Once the site is deployed we stil need to run a few commands to set up our Djnago application:",{"type":49,"tag":8994,"props":21916,"children":21917},{},[21918,21922,21926],{"type":49,"tag":68,"props":21919,"children":21920},{},[21921],{"type":55,"value":3316},{"type":49,"tag":68,"props":21923,"children":21924},{},[21925],{"type":55,"value":3323},{"type":49,"tag":68,"props":21927,"children":21928},{},[21929],{"type":55,"value":21930},"createsuperuser",{"type":49,"tag":2910,"props":21932,"children":21933},{},[21934],{"type":49,"tag":58,"props":21935,"children":21936},{},[21937],{"type":55,"value":21938},"One other ToDo is to figure out how to run these commands through manual GitLab CI jobs.",{"type":49,"tag":58,"props":21940,"children":21941},{},[21942],{"type":55,"value":21943},"That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean.",{"type":49,"tag":50,"props":21945,"children":21946},{"id":15955},[21947],{"type":55,"value":16605},{"type":49,"tag":58,"props":21949,"children":21950},{},[21951],{"type":55,"value":21952},"Here are some ideas about the next steps I could take on this project.",{"type":49,"tag":430,"props":21954,"children":21956},{"id":21955},"local-environment",[21957],{"type":55,"value":21958},"Local environment",{"type":49,"tag":58,"props":21960,"children":21961},{},[21962],{"type":55,"value":21963},"I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings.",{"type":49,"tag":430,"props":21965,"children":21967},{"id":21966},"infrastructure-as-code-setup",[21968],{"type":55,"value":21969},"Infrastructure as Code setup",{"type":49,"tag":58,"props":21971,"children":21972},{},[21973],{"type":55,"value":21974},"There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK.",{"type":49,"tag":430,"props":21976,"children":21978},{"id":21977},"scaling-out-docker-swarm-services-across-multiple-machines",[21979],{"type":55,"value":21980},"Scaling out docker swarm services across multiple machines",{"type":49,"tag":58,"props":21982,"children":21983},{},[21984],{"type":55,"value":21985},"I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads.",{"type":49,"tag":430,"props":21987,"children":21989},{"id":21988},"kubernetes-on-digitalocean",[21990],{"type":55,"value":21991},"Kubernetes on DigitalOcean",{"type":49,"tag":58,"props":21993,"children":21994},{},[21995],{"type":55,"value":21996},"DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP.",{"type":49,"tag":430,"props":21998,"children":22000},{"id":21999},"deploying-locally-without-using-gitlab-ci",[22001],{"type":55,"value":22002},"Deploying locally, without using GitLab CI",{"type":49,"tag":58,"props":22004,"children":22005},{},[22006],{"type":55,"value":22007},"CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages.",{"type":49,"tag":7749,"props":22009,"children":22010},{},[22011],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":22013},[22014,22015,22016,22017,22018,22019,22020,22021,22022,22023,22024,22025,22030,22031],{"id":17662,"depth":1079,"text":17665},{"id":17771,"depth":1079,"text":17774},{"id":17821,"depth":1079,"text":17824},{"id":17879,"depth":1079,"text":17882},{"id":17974,"depth":1079,"text":17977},{"id":18002,"depth":1079,"text":18005},{"id":18032,"depth":1079,"text":18035},{"id":18123,"depth":1079,"text":17709},{"id":18800,"depth":1079,"text":18803},{"id":18919,"depth":1079,"text":18922},{"id":19083,"depth":1079,"text":19078},{"id":19605,"depth":1079,"text":19612,"children":22026},[22027,22028,22029],{"id":1951,"depth":1088,"text":1951},{"id":17594,"depth":1088,"text":20391},{"id":17593,"depth":1088,"text":21189},{"id":21906,"depth":1079,"text":21909},{"id":15955,"depth":1079,"text":16605,"children":22032},[22033,22034,22035,22036,22037],{"id":21955,"depth":1088,"text":21958},{"id":21966,"depth":1088,"text":21969},{"id":21977,"depth":1088,"text":21980},{"id":21988,"depth":1088,"text":21991},{"id":21999,"depth":1088,"text":22002},"content:2020:08:09:digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx",{"_path":22042,"_dir":14905,"_draft":7,"_partial":7,"_locale":8,"title":22043,"description":8,"layout":16873,"date":22044,"comments":44,"image":22045,"tags":22046,"body":22049,"_type":7809,"_id":27002,"_source":7811,"_file":27003,"_stem":27004,"_extension":7814},"/2020/08/01/django-and-lambda-with-cdk-and-api-gateway","Deploying serverless Django applications to AWS with CDK on a tiny budget using Lambda, API Gateway, awsgi and the Lambda proxy pattern","2020-08-01T00:00:00.000Z","/static/djambda.png",[22047,14,20,22048,15],"serverless","lambda",{"type":46,"children":22050,"toc":26987},[22051,22055,22060,22066,22071,22077,22082,22095,22100,22112,22126,22132,22170,22352,22366,22416,22693,22717,22721,22734,22821,22878,22883,22896,22901,22977,22982,23205,23210,23633,23727,23743,23761,23841,23875,24113,24118,24123,24128,24493,24506,24544,24555,24960,24965,25044,25050,25081,25086,25377,25382,25413,25418,25720,25733,25741,25778,25812,25835,25884,25890,25903,25954,25974,25986,25992,26004,26012,26038,26067,26102,26132,26138,26143,26156,26162,26175,26187,26195,26240,26253,26261,26273,26281,26286,26294,26306,26319,26327,26340,26347,26352,26376,26384,26390,26395,26603,26616,26847,26860,26864,26869,26978,26983],{"type":49,"tag":50,"props":22052,"children":22053},{"id":52},[22054],{"type":55,"value":56},{"type":49,"tag":58,"props":22056,"children":22057},{},[22058],{"type":55,"value":22059},"One way to deploy Django apps to AWS on a budget is to use the Lambda proxy pattern. The main idea is this: web requests are made to API Gateway that calls a Lambda outside of our VPC (proxy Lambda), which then invokes a second lambda (Django Lambda) inside of our VPC so that it can access VPC resources, namely RDS. The handler for the Django Lambda translates the API Gateway event into a WSGI-compatible request, processes the request and returns the response to the user back through the proxy Lambda. The big caveat is that you can't easily access the internet in Django's request/response cycle without network address translation (NAT) services which add additional costs. One other caveat is that there is high latency associated with the initial request. There are three cold starts to wait for: the cold start for the proxy Lambda, the cold start for the Django Lambda and the cold start for the Aurora Postgres Serverless database. Here's an architecture diagram:",{"type":49,"tag":58,"props":22061,"children":22062},{},[22063],{"type":49,"tag":1601,"props":22064,"children":22065},{"alt":8926,"src":22045},[],{"type":49,"tag":58,"props":22067,"children":22068},{},[22069],{"type":55,"value":22070},"Route53 and CloudFront (1 and 2), discuessed later on, are optional. Starting with 5, API Gateway requests are passed to a proxy lambda (6) which calls a Lambda in a VPC that contains our Django code and special Django handler (7). This function can access RDS (8) and S3 (4) via a VPC Gateway Endpoint (9), but it cannot access the internet.",{"type":49,"tag":50,"props":22072,"children":22074},{"id":22073},"why",[22075],{"type":55,"value":22076},"Why?",{"type":49,"tag":58,"props":22078,"children":22079},{},[22080],{"type":55,"value":22081},"There are a few different reasons for why I put this project together. Before I get into these reasons, here is a little bit of background on how I typically deploy web apps and the motivations for this project.",{"type":49,"tag":58,"props":22083,"children":22084},{},[22085,22087,22093],{"type":55,"value":22086},"Django is my web framework of choice, and I'm most comfortable working with Django in docker containers. I previously wrote an article about ",{"type":49,"tag":80,"props":22088,"children":22090},{"href":17605,"rel":22089},[84],[22091],{"type":55,"value":22092},"deploying Django applications with AWS Fargate",{"type":55,"value":22094},". This approach technically is \"serverless\", but it requires the use of \"always on\" services: an Application Load Balancer, NAT Gateways and long-running Fargate tasks to run gunicorn processes for our Django application. Even if you choose to run workloads in public subnets and don't use NAT Gateways or NAT instances, the costs are prohbitively high for many types of Django projects: personal projects, proof-of-concept projects, internal projects, toy projects, etc.",{"type":49,"tag":58,"props":22096,"children":22097},{},[22098],{"type":55,"value":22099},"The other serverless compute platform on AWS is Lambda. There is a popular framework for deploying serverless Django applications on Lambda called Zappa. I have been meaning to try out Zappa for a while now, and I still haven't used it, but it provided a good reference for how to do \"serverless Django\". I'll come back to Zappa in more detail later, but the main reason I didn't want to use it for my serverless Django project is because I already have a great deployment and Infrastructure as Code tool: CDK.",{"type":49,"tag":58,"props":22101,"children":22102},{},[22103,22105,22111],{"type":55,"value":22104},"CDK, or Cloud Development Kit, is a tool that allows you define and deploy AWS infrastructure using any popular programming language, Python in my case. It uses CloudFormation in the background, and it has great support for lots of AWS services. If you are looking for an introuction to CDK, check out ",{"type":49,"tag":80,"props":22106,"children":22109},{"href":22107,"rel":22108},"https://cdkworkshop.com/",[84],[22110],{"type":55,"value":22107},{"type":55,"value":745},{"type":49,"tag":58,"props":22113,"children":22114},{},[22115,22117,22124],{"type":55,"value":22116},"Zappa makes it really easy to deploy serveless Django applications with Django, but it requires that you ",{"type":49,"tag":80,"props":22118,"children":22121},{"href":22119,"rel":22120},"https://github.com/Miserlou/Zappa#running-tasks-in-a-vpc",[84],[22122],{"type":55,"value":22123},"setup NAT and other VPC resources before using it with RDS",{"type":55,"value":22125},". Since CDK is really good at setting up these kinds of resources, as well as the resources that Zappa creates (including Lambda functions and API Gateway), I wanted to know how far I could get in setting up a servless Django application only using CDK. I also didn't want everything abstracted away by a high level framework; I'm interested in a lower level view to get more familiar with how serverless technologies work. It's important to note that the biggest motivation of all is to learn try something out of my comfort zone, make mistakes and get feedback.",{"type":49,"tag":50,"props":22127,"children":22129},{"id":22128},"django-lambda-djambda",[22130],{"type":55,"value":22131},"Django + Lambda = djambda",{"type":49,"tag":58,"props":22133,"children":22134},{},[22135,22137,22144,22146,22153,22154,22160,22162,22168],{"type":55,"value":22136},"The name for this project came pretty easily. I created ",{"type":49,"tag":80,"props":22138,"children":22141},{"href":22139,"rel":22140},"https://gitlab.com/briancaffey/djambda",[84],[22142],{"type":55,"value":22143},"a repo on GitLab called djambda",{"type":55,"value":22145}," and then discovered ",{"type":49,"tag":80,"props":22147,"children":22150},{"href":22148,"rel":22149},"https://github.com/netsome/djambda",[84],[22151],{"type":55,"value":22152},"a similar project by the same name on GitHub: netsome/djambda",{"type":55,"value":1931},{"type":49,"tag":326,"props":22155,"children":22157},{"className":22156},[],[22158],{"type":55,"value":22159},"netsome/djambda",{"type":55,"value":22161}," project uses Terraform, and I encourage you to check it out and leave it a GitHub star. Before I came across this project, I hacked together a very basic djambda protoype using some code from Zappa's handler. A ",{"type":49,"tag":326,"props":22163,"children":22165},{"className":22164},[],[22166],{"type":55,"value":22167},"handler",{"type":55,"value":22169}," is the name for the function that is called in your Lambda function's code when the Lambda function is invoked. Here's some pseudo code that shows how Zappa's handler works:",{"type":49,"tag":1050,"props":22171,"children":22173},{"code":22172,"language":19933,"meta":8,"className":19934,"style":8},"from werkzeug.wrappers import Response\n\ndef handler(event, context):\n    with Response.from_app(wsgi_app, wsgi_request(event)) as response:\n        zappa_returndict = dict()\n        zappa_returndict['body'] = response.data\n        zappa_returndict['statusCode'] = response.status_code\n        return zappa_returndict\n",[22174],{"type":49,"tag":326,"props":22175,"children":22176},{"__ignoreMap":8},[22177,22200,22207,22243,22265,22287,22314,22339],{"type":49,"tag":1060,"props":22178,"children":22179},{"class":1062,"line":1063},[22180,22185,22190,22195],{"type":49,"tag":1060,"props":22181,"children":22182},{"style":2194},[22183],{"type":55,"value":22184},"from",{"type":49,"tag":1060,"props":22186,"children":22187},{"style":1073},[22188],{"type":55,"value":22189}," werkzeug.wrappers ",{"type":49,"tag":1060,"props":22191,"children":22192},{"style":2194},[22193],{"type":55,"value":22194},"import",{"type":49,"tag":1060,"props":22196,"children":22197},{"style":1073},[22198],{"type":55,"value":22199}," Response\n",{"type":49,"tag":1060,"props":22201,"children":22202},{"class":1062,"line":1079},[22203],{"type":49,"tag":1060,"props":22204,"children":22205},{"emptyLinePlaceholder":44},[22206],{"type":55,"value":1094},{"type":49,"tag":1060,"props":22208,"children":22209},{"class":1062,"line":1088},[22210,22215,22220,22224,22230,22234,22238],{"type":49,"tag":1060,"props":22211,"children":22212},{"style":2182},[22213],{"type":55,"value":22214},"def",{"type":49,"tag":1060,"props":22216,"children":22217},{"style":1067},[22218],{"type":55,"value":22219}," handler",{"type":49,"tag":1060,"props":22221,"children":22222},{"style":1073},[22223],{"type":55,"value":2284},{"type":49,"tag":1060,"props":22225,"children":22227},{"style":22226},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[22228],{"type":55,"value":22229},"event",{"type":49,"tag":1060,"props":22231,"children":22232},{"style":1073},[22233],{"type":55,"value":873},{"type":49,"tag":1060,"props":22235,"children":22236},{"style":22226},[22237],{"type":55,"value":14059},{"type":49,"tag":1060,"props":22239,"children":22240},{"style":1073},[22241],{"type":55,"value":22242},"):\n",{"type":49,"tag":1060,"props":22244,"children":22245},{"class":1062,"line":1097},[22246,22251,22256,22260],{"type":49,"tag":1060,"props":22247,"children":22248},{"style":2194},[22249],{"type":55,"value":22250},"    with",{"type":49,"tag":1060,"props":22252,"children":22253},{"style":1073},[22254],{"type":55,"value":22255}," Response.from_app(wsgi_app, wsgi_request(event)) ",{"type":49,"tag":1060,"props":22257,"children":22258},{"style":2194},[22259],{"type":55,"value":5178},{"type":49,"tag":1060,"props":22261,"children":22262},{"style":1073},[22263],{"type":55,"value":22264}," response:\n",{"type":49,"tag":1060,"props":22266,"children":22267},{"class":1062,"line":1111},[22268,22273,22277,22282],{"type":49,"tag":1060,"props":22269,"children":22270},{"style":1073},[22271],{"type":55,"value":22272},"        zappa_returndict ",{"type":49,"tag":1060,"props":22274,"children":22275},{"style":2194},[22276],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22278,"children":22279},{"style":5200},[22280],{"type":55,"value":22281}," dict",{"type":49,"tag":1060,"props":22283,"children":22284},{"style":1073},[22285],{"type":55,"value":22286},"()\n",{"type":49,"tag":1060,"props":22288,"children":22289},{"class":1062,"line":1120},[22290,22295,22300,22305,22309],{"type":49,"tag":1060,"props":22291,"children":22292},{"style":1073},[22293],{"type":55,"value":22294},"        zappa_returndict[",{"type":49,"tag":1060,"props":22296,"children":22297},{"style":2215},[22298],{"type":55,"value":22299},"'body'",{"type":49,"tag":1060,"props":22301,"children":22302},{"style":1073},[22303],{"type":55,"value":22304},"] ",{"type":49,"tag":1060,"props":22306,"children":22307},{"style":2194},[22308],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22310,"children":22311},{"style":1073},[22312],{"type":55,"value":22313}," response.data\n",{"type":49,"tag":1060,"props":22315,"children":22316},{"class":1062,"line":1128},[22317,22321,22326,22330,22334],{"type":49,"tag":1060,"props":22318,"children":22319},{"style":1073},[22320],{"type":55,"value":22294},{"type":49,"tag":1060,"props":22322,"children":22323},{"style":2215},[22324],{"type":55,"value":22325},"'statusCode'",{"type":49,"tag":1060,"props":22327,"children":22328},{"style":1073},[22329],{"type":55,"value":22304},{"type":49,"tag":1060,"props":22331,"children":22332},{"style":2194},[22333],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22335,"children":22336},{"style":1073},[22337],{"type":55,"value":22338}," response.status_code\n",{"type":49,"tag":1060,"props":22340,"children":22341},{"class":1062,"line":1141},[22342,22347],{"type":49,"tag":1060,"props":22343,"children":22344},{"style":2194},[22345],{"type":55,"value":22346},"        return",{"type":49,"tag":1060,"props":22348,"children":22349},{"style":1073},[22350],{"type":55,"value":22351}," zappa_returndict\n",{"type":49,"tag":58,"props":22353,"children":22354},{},[22355,22357,22364],{"type":55,"value":22356},"For reference, ",{"type":49,"tag":80,"props":22358,"children":22361},{"href":22359,"rel":22360},"https://github.com/Miserlou/Zappa/blob/master/zappa/handler.py#L540",[84],[22362],{"type":55,"value":22363},"here is the link to the line in Zappa's source code that starts processing API Gateway requests",{"type":55,"value":22365}," on which the above psuedo code is loosly based.",{"type":49,"tag":58,"props":22367,"children":22368},{},[22369,22370,22375,22377,22384,22386,22392,22394,22400,22402,22407,22409,22414],{"type":55,"value":413},{"type":49,"tag":326,"props":22371,"children":22373},{"className":22372},[],[22374],{"type":55,"value":22159},{"type":55,"value":22376}," project makes use of a package called ",{"type":49,"tag":80,"props":22378,"children":22381},{"href":22379,"rel":22380},"https://github.com/slank/awsgi",[84],[22382],{"type":55,"value":22383},"awsgi",{"type":55,"value":22385}," that has active contributions from people at AWS. Similar to djambda, it is a mashup of words (acronyms): (",{"type":49,"tag":326,"props":22387,"children":22389},{"className":22388},[],[22390],{"type":55,"value":22391},"AWS",{"type":55,"value":22393}," + ",{"type":49,"tag":326,"props":22395,"children":22397},{"className":22396},[],[22398],{"type":55,"value":22399},"wsgi",{"type":55,"value":22401}," = ",{"type":49,"tag":326,"props":22403,"children":22405},{"className":22404},[],[22406],{"type":55,"value":22383},{"type":55,"value":22408},"). It does most of the work that Zappa's handler does, so I replaced the adapted Zappa handler code with a very elagant handler (borrowed from ",{"type":49,"tag":326,"props":22410,"children":22412},{"className":22411},[],[22413],{"type":55,"value":22159},{"type":55,"value":22415},"):",{"type":49,"tag":1050,"props":22417,"children":22419},{"code":22418,"language":19933,"meta":8,"className":19934,"style":8},"# djambda/src/djambda/awsgi.py\nimport io\n\nimport awsgi\nfrom django.core import management\n\nfrom .wsgi import application\n\n\ndef lambda_handler(event, context):\n    if \"manage\" in event:\n        output = io.StringIO()\n        management.call_command(*event[\"manage\"].split(\" \"), stdout=output)\n        return {\"output\": output.getvalue()}\n    else:\n        return awsgi.response(application, event, context)\n",[22420],{"type":49,"tag":326,"props":22421,"children":22422},{"__ignoreMap":8},[22423,22431,22443,22450,22462,22483,22490,22511,22518,22525,22557,22579,22596,22647,22669,22681],{"type":49,"tag":1060,"props":22424,"children":22425},{"class":1062,"line":1063},[22426],{"type":49,"tag":1060,"props":22427,"children":22428},{"style":3039},[22429],{"type":55,"value":22430},"# djambda/src/djambda/awsgi.py\n",{"type":49,"tag":1060,"props":22432,"children":22433},{"class":1062,"line":1079},[22434,22438],{"type":49,"tag":1060,"props":22435,"children":22436},{"style":2194},[22437],{"type":55,"value":22194},{"type":49,"tag":1060,"props":22439,"children":22440},{"style":1073},[22441],{"type":55,"value":22442}," io\n",{"type":49,"tag":1060,"props":22444,"children":22445},{"class":1062,"line":1088},[22446],{"type":49,"tag":1060,"props":22447,"children":22448},{"emptyLinePlaceholder":44},[22449],{"type":55,"value":1094},{"type":49,"tag":1060,"props":22451,"children":22452},{"class":1062,"line":1097},[22453,22457],{"type":49,"tag":1060,"props":22454,"children":22455},{"style":2194},[22456],{"type":55,"value":22194},{"type":49,"tag":1060,"props":22458,"children":22459},{"style":1073},[22460],{"type":55,"value":22461}," awsgi\n",{"type":49,"tag":1060,"props":22463,"children":22464},{"class":1062,"line":1111},[22465,22469,22474,22478],{"type":49,"tag":1060,"props":22466,"children":22467},{"style":2194},[22468],{"type":55,"value":22184},{"type":49,"tag":1060,"props":22470,"children":22471},{"style":1073},[22472],{"type":55,"value":22473}," django.core ",{"type":49,"tag":1060,"props":22475,"children":22476},{"style":2194},[22477],{"type":55,"value":22194},{"type":49,"tag":1060,"props":22479,"children":22480},{"style":1073},[22481],{"type":55,"value":22482}," management\n",{"type":49,"tag":1060,"props":22484,"children":22485},{"class":1062,"line":1120},[22486],{"type":49,"tag":1060,"props":22487,"children":22488},{"emptyLinePlaceholder":44},[22489],{"type":55,"value":1094},{"type":49,"tag":1060,"props":22491,"children":22492},{"class":1062,"line":1128},[22493,22497,22502,22506],{"type":49,"tag":1060,"props":22494,"children":22495},{"style":2194},[22496],{"type":55,"value":22184},{"type":49,"tag":1060,"props":22498,"children":22499},{"style":1073},[22500],{"type":55,"value":22501}," .wsgi ",{"type":49,"tag":1060,"props":22503,"children":22504},{"style":2194},[22505],{"type":55,"value":22194},{"type":49,"tag":1060,"props":22507,"children":22508},{"style":1073},[22509],{"type":55,"value":22510}," application\n",{"type":49,"tag":1060,"props":22512,"children":22513},{"class":1062,"line":1141},[22514],{"type":49,"tag":1060,"props":22515,"children":22516},{"emptyLinePlaceholder":44},[22517],{"type":55,"value":1094},{"type":49,"tag":1060,"props":22519,"children":22520},{"class":1062,"line":1150},[22521],{"type":49,"tag":1060,"props":22522,"children":22523},{"emptyLinePlaceholder":44},[22524],{"type":55,"value":1094},{"type":49,"tag":1060,"props":22526,"children":22527},{"class":1062,"line":1158},[22528,22532,22537,22541,22545,22549,22553],{"type":49,"tag":1060,"props":22529,"children":22530},{"style":2182},[22531],{"type":55,"value":22214},{"type":49,"tag":1060,"props":22533,"children":22534},{"style":1067},[22535],{"type":55,"value":22536}," lambda_handler",{"type":49,"tag":1060,"props":22538,"children":22539},{"style":1073},[22540],{"type":55,"value":2284},{"type":49,"tag":1060,"props":22542,"children":22543},{"style":22226},[22544],{"type":55,"value":22229},{"type":49,"tag":1060,"props":22546,"children":22547},{"style":1073},[22548],{"type":55,"value":873},{"type":49,"tag":1060,"props":22550,"children":22551},{"style":22226},[22552],{"type":55,"value":14059},{"type":49,"tag":1060,"props":22554,"children":22555},{"style":1073},[22556],{"type":55,"value":22242},{"type":49,"tag":1060,"props":22558,"children":22559},{"class":1062,"line":1171},[22560,22564,22569,22574],{"type":49,"tag":1060,"props":22561,"children":22562},{"style":2194},[22563],{"type":55,"value":3050},{"type":49,"tag":1060,"props":22565,"children":22566},{"style":2215},[22567],{"type":55,"value":22568}," \"manage\"",{"type":49,"tag":1060,"props":22570,"children":22571},{"style":2194},[22572],{"type":55,"value":22573}," in",{"type":49,"tag":1060,"props":22575,"children":22576},{"style":1073},[22577],{"type":55,"value":22578}," event:\n",{"type":49,"tag":1060,"props":22580,"children":22581},{"class":1062,"line":1180},[22582,22587,22591],{"type":49,"tag":1060,"props":22583,"children":22584},{"style":1073},[22585],{"type":55,"value":22586},"        output ",{"type":49,"tag":1060,"props":22588,"children":22589},{"style":2194},[22590],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22592,"children":22593},{"style":1073},[22594],{"type":55,"value":22595}," io.StringIO()\n",{"type":49,"tag":1060,"props":22597,"children":22598},{"class":1062,"line":1188},[22599,22604,22609,22614,22619,22624,22629,22633,22638,22642],{"type":49,"tag":1060,"props":22600,"children":22601},{"style":1073},[22602],{"type":55,"value":22603},"        management.call_command(",{"type":49,"tag":1060,"props":22605,"children":22606},{"style":2194},[22607],{"type":55,"value":22608},"*",{"type":49,"tag":1060,"props":22610,"children":22611},{"style":1073},[22612],{"type":55,"value":22613},"event[",{"type":49,"tag":1060,"props":22615,"children":22616},{"style":2215},[22617],{"type":55,"value":22618},"\"manage\"",{"type":49,"tag":1060,"props":22620,"children":22621},{"style":1073},[22622],{"type":55,"value":22623},"].split(",{"type":49,"tag":1060,"props":22625,"children":22626},{"style":2215},[22627],{"type":55,"value":22628},"\" \"",{"type":49,"tag":1060,"props":22630,"children":22631},{"style":1073},[22632],{"type":55,"value":2295},{"type":49,"tag":1060,"props":22634,"children":22636},{"style":22635},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[22637],{"type":55,"value":3426},{"type":49,"tag":1060,"props":22639,"children":22640},{"style":2194},[22641],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22643,"children":22644},{"style":1073},[22645],{"type":55,"value":22646},"output)\n",{"type":49,"tag":1060,"props":22648,"children":22649},{"class":1062,"line":1201},[22650,22654,22659,22664],{"type":49,"tag":1060,"props":22651,"children":22652},{"style":2194},[22653],{"type":55,"value":22346},{"type":49,"tag":1060,"props":22655,"children":22656},{"style":1073},[22657],{"type":55,"value":22658}," {",{"type":49,"tag":1060,"props":22660,"children":22661},{"style":2215},[22662],{"type":55,"value":22663},"\"output\"",{"type":49,"tag":1060,"props":22665,"children":22666},{"style":1073},[22667],{"type":55,"value":22668},": output.getvalue()}\n",{"type":49,"tag":1060,"props":22670,"children":22671},{"class":1062,"line":1210},[22672,22677],{"type":49,"tag":1060,"props":22673,"children":22674},{"style":2194},[22675],{"type":55,"value":22676},"    else",{"type":49,"tag":1060,"props":22678,"children":22679},{"style":1073},[22680],{"type":55,"value":6862},{"type":49,"tag":1060,"props":22682,"children":22683},{"class":1062,"line":1218},[22684,22688],{"type":49,"tag":1060,"props":22685,"children":22686},{"style":2194},[22687],{"type":55,"value":22346},{"type":49,"tag":1060,"props":22689,"children":22690},{"style":1073},[22691],{"type":55,"value":22692}," awsgi.response(application, event, context)\n",{"type":49,"tag":58,"props":22694,"children":22695},{},[22696,22698,22703,22704,22709,22710,22715],{"type":55,"value":22697},"This handler can takes care of translating API Gateway requests to WSGI requests as well as management commands such as ",{"type":49,"tag":326,"props":22699,"children":22701},{"className":22700},[],[22702],{"type":55,"value":3323},{"type":55,"value":873},{"type":49,"tag":326,"props":22705,"children":22707},{"className":22706},[],[22708],{"type":55,"value":21930},{"type":55,"value":873},{"type":49,"tag":326,"props":22711,"children":22713},{"className":22712},[],[22714],{"type":55,"value":3316},{"type":55,"value":22716}," and other custom management commands. Let's talk about the management commands first as they relate to the two main AWS services that our Django application uses: RDS and S3. Then we will talk about API Gateway, the proxy Lambda and how the Lambda proxy pattern works.",{"type":49,"tag":50,"props":22718,"children":22719},{"id":1929},[22720],{"type":55,"value":2027},{"type":49,"tag":58,"props":22722,"children":22723},{},[22724,22726,22732],{"type":55,"value":22725},"To run the management commands for our application, we can use the AWS CLI to invoke the Lambda function with a payload that will trigger the ",{"type":49,"tag":326,"props":22727,"children":22729},{"className":22728},[],[22730],{"type":55,"value":22731},"if \"manage\" in event:",{"type":55,"value":22733}," code block from the above handler:",{"type":49,"tag":1050,"props":22735,"children":22737},{"code":22736,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name my-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"migrate --no-input\"}' \\\n    resp.json\n",[22738],{"type":49,"tag":326,"props":22739,"children":22740},{"__ignoreMap":8},[22741,22762,22779,22796,22813],{"type":49,"tag":1060,"props":22742,"children":22743},{"class":1062,"line":1063},[22744,22748,22753,22758],{"type":49,"tag":1060,"props":22745,"children":22746},{"style":1067},[22747],{"type":55,"value":20},{"type":49,"tag":1060,"props":22749,"children":22750},{"style":2215},[22751],{"type":55,"value":22752}," lambda",{"type":49,"tag":1060,"props":22754,"children":22755},{"style":2215},[22756],{"type":55,"value":22757}," invoke",{"type":49,"tag":1060,"props":22759,"children":22760},{"style":2287},[22761],{"type":55,"value":10239},{"type":49,"tag":1060,"props":22763,"children":22764},{"class":1062,"line":1079},[22765,22770,22775],{"type":49,"tag":1060,"props":22766,"children":22767},{"style":2287},[22768],{"type":55,"value":22769},"    --function-name",{"type":49,"tag":1060,"props":22771,"children":22772},{"style":2215},[22773],{"type":55,"value":22774}," my-djambda-lambda",{"type":49,"tag":1060,"props":22776,"children":22777},{"style":2287},[22778],{"type":55,"value":10239},{"type":49,"tag":1060,"props":22780,"children":22781},{"class":1062,"line":1088},[22782,22787,22792],{"type":49,"tag":1060,"props":22783,"children":22784},{"style":2287},[22785],{"type":55,"value":22786},"    --invocation-type",{"type":49,"tag":1060,"props":22788,"children":22789},{"style":2215},[22790],{"type":55,"value":22791}," RequestResponse",{"type":49,"tag":1060,"props":22793,"children":22794},{"style":2287},[22795],{"type":55,"value":10239},{"type":49,"tag":1060,"props":22797,"children":22798},{"class":1062,"line":1097},[22799,22804,22809],{"type":49,"tag":1060,"props":22800,"children":22801},{"style":2287},[22802],{"type":55,"value":22803},"    --payload",{"type":49,"tag":1060,"props":22805,"children":22806},{"style":2215},[22807],{"type":55,"value":22808}," '{\"manage\": \"migrate --no-input\"}'",{"type":49,"tag":1060,"props":22810,"children":22811},{"style":2287},[22812],{"type":55,"value":10239},{"type":49,"tag":1060,"props":22814,"children":22815},{"class":1062,"line":1111},[22816],{"type":49,"tag":1060,"props":22817,"children":22818},{"style":2215},[22819],{"type":55,"value":22820},"    resp.json\n",{"type":49,"tag":58,"props":22822,"children":22823},{},[22824,22826,22831,22833,22839,22841,22847,22849,22855,22857,22862,22863,22869,22871,22876],{"type":55,"value":22825},"This will run the ",{"type":49,"tag":326,"props":22827,"children":22829},{"className":22828},[],[22830],{"type":55,"value":3323},{"type":55,"value":22832}," command by connecting to RDS from our Django application with a special version of ",{"type":49,"tag":326,"props":22834,"children":22836},{"className":22835},[],[22837],{"type":55,"value":22838},"psycopg2",{"type":55,"value":22840}," called ",{"type":49,"tag":326,"props":22842,"children":22844},{"className":22843},[],[22845],{"type":55,"value":22846},"aws-psycopg2",{"type":55,"value":22848}," (check ",{"type":49,"tag":326,"props":22850,"children":22852},{"className":22851},[],[22853],{"type":55,"value":22854},"django/requirements.txt",{"type":55,"value":22856}," for this dependency). ",{"type":49,"tag":326,"props":22858,"children":22860},{"className":22859},[],[22861],{"type":55,"value":22838},{"type":55,"value":715},{"type":49,"tag":326,"props":22864,"children":22866},{"className":22865},[],[22867],{"type":55,"value":22868},"psycopg2-binary",{"type":55,"value":22870}," both gave error messages when trying to access the database, but the ",{"type":49,"tag":326,"props":22872,"children":22874},{"className":22873},[],[22875],{"type":55,"value":22846},{"type":55,"value":22877}," package had no issues.",{"type":49,"tag":58,"props":22879,"children":22880},{},[22881],{"type":55,"value":22882},"RDS can sometimes be the most expensive part of a project on AWS. To reduce costs, we are using Aurora Postgres Serverless. This AWS service is ideal for small, infrequently-used projects that are in development. The database \"goes to sleep\" after a period of inactivity (5 minutes, I think). When new requests to the database are made, it can take up to 30 seconds for the database to wake up. For this reason, we need the timeout of the Django Lambda to be able to clear the wakeup period of the Aurora Postgres Serverless database.",{"type":49,"tag":58,"props":22884,"children":22885},{},[22886,22888,22894],{"type":55,"value":22887},"Since our Lambda function is in public subnet of our VPC and our RDS Aurora database cluster is in an isolated VPC, we need to make sure that the Lambda function can talk to the RDS cluster. CDK makes this really easy. I'll highlight a few important permission related parts of ",{"type":49,"tag":326,"props":22889,"children":22891},{"className":22890},[],[22892],{"type":55,"value":22893},"awscdk/vpc.py",{"type":55,"value":22895},", the code that defines the nested CloudFormation stack where we define our VPC and resources related to our application (including API Gateway, which is technically not located in our VPC).",{"type":49,"tag":58,"props":22897,"children":22898},{},[22899],{"type":55,"value":22900},"First, we define a new security group for our Django Lambda:",{"type":49,"tag":1050,"props":22902,"children":22904},{"code":22903,"language":19933,"meta":8,"className":19934,"style":8},"        self.lambda_security_group = ec2.SecurityGroup(\n            self, \"LambdaSecurityGroup\", vpc=self.vpc\n        )\n",[22905],{"type":49,"tag":326,"props":22906,"children":22907},{"__ignoreMap":8},[22908,22930,22969],{"type":49,"tag":1060,"props":22909,"children":22910},{"class":1062,"line":1063},[22911,22916,22921,22925],{"type":49,"tag":1060,"props":22912,"children":22913},{"style":3797},[22914],{"type":55,"value":22915},"        self",{"type":49,"tag":1060,"props":22917,"children":22918},{"style":1073},[22919],{"type":55,"value":22920},".lambda_security_group ",{"type":49,"tag":1060,"props":22922,"children":22923},{"style":2194},[22924],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22926,"children":22927},{"style":1073},[22928],{"type":55,"value":22929}," ec2.SecurityGroup(\n",{"type":49,"tag":1060,"props":22931,"children":22932},{"class":1062,"line":1079},[22933,22938,22942,22947,22951,22955,22959,22964],{"type":49,"tag":1060,"props":22934,"children":22935},{"style":3797},[22936],{"type":55,"value":22937},"            self",{"type":49,"tag":1060,"props":22939,"children":22940},{"style":1073},[22941],{"type":55,"value":873},{"type":49,"tag":1060,"props":22943,"children":22944},{"style":2215},[22945],{"type":55,"value":22946},"\"LambdaSecurityGroup\"",{"type":49,"tag":1060,"props":22948,"children":22949},{"style":1073},[22950],{"type":55,"value":873},{"type":49,"tag":1060,"props":22952,"children":22953},{"style":22635},[22954],{"type":55,"value":2091},{"type":49,"tag":1060,"props":22956,"children":22957},{"style":2194},[22958],{"type":55,"value":3068},{"type":49,"tag":1060,"props":22960,"children":22961},{"style":3797},[22962],{"type":55,"value":22963},"self",{"type":49,"tag":1060,"props":22965,"children":22966},{"style":1073},[22967],{"type":55,"value":22968},".vpc\n",{"type":49,"tag":1060,"props":22970,"children":22971},{"class":1062,"line":1088},[22972],{"type":49,"tag":1060,"props":22973,"children":22974},{"style":1073},[22975],{"type":55,"value":22976},"        )\n",{"type":49,"tag":58,"props":22978,"children":22979},{},[22980],{"type":55,"value":22981},"Then, we reference this security group in the list of security group ingresses for our database cluster's security group:",{"type":49,"tag":1050,"props":22983,"children":22985},{"code":22984,"language":19933,"meta":8,"className":19934,"style":8},"        self.db_security_group = ec2.CfnSecurityGroup(\n            self,\n            \"DBSecurityGroup\",\n            vpc_id=self.vpc.vpc_id,\n            group_description=\"DBSecurityGroup\",\n            security_group_ingress=[\n                ec2.CfnSecurityGroup.IngressProperty(\n                    ip_protocol=\"tcp\",\n                    to_port=5432,\n                    from_port=5432,\n                    source_security_group_id=self.lambda_security_group.security_group_id,\n                )\n            ],\n        )\n",[22986],{"type":49,"tag":326,"props":22987,"children":22988},{"__ignoreMap":8},[22989,23010,23021,23033,23054,23075,23092,23100,23121,23141,23161,23182,23190,23198],{"type":49,"tag":1060,"props":22990,"children":22991},{"class":1062,"line":1063},[22992,22996,23001,23005],{"type":49,"tag":1060,"props":22993,"children":22994},{"style":3797},[22995],{"type":55,"value":22915},{"type":49,"tag":1060,"props":22997,"children":22998},{"style":1073},[22999],{"type":55,"value":23000},".db_security_group ",{"type":49,"tag":1060,"props":23002,"children":23003},{"style":2194},[23004],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23006,"children":23007},{"style":1073},[23008],{"type":55,"value":23009}," ec2.CfnSecurityGroup(\n",{"type":49,"tag":1060,"props":23011,"children":23012},{"class":1062,"line":1079},[23013,23017],{"type":49,"tag":1060,"props":23014,"children":23015},{"style":3797},[23016],{"type":55,"value":22937},{"type":49,"tag":1060,"props":23018,"children":23019},{"style":1073},[23020],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23022,"children":23023},{"class":1062,"line":1088},[23024,23029],{"type":49,"tag":1060,"props":23025,"children":23026},{"style":2215},[23027],{"type":55,"value":23028},"            \"DBSecurityGroup\"",{"type":49,"tag":1060,"props":23030,"children":23031},{"style":1073},[23032],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23034,"children":23035},{"class":1062,"line":1097},[23036,23041,23045,23049],{"type":49,"tag":1060,"props":23037,"children":23038},{"style":22635},[23039],{"type":55,"value":23040},"            vpc_id",{"type":49,"tag":1060,"props":23042,"children":23043},{"style":2194},[23044],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23046,"children":23047},{"style":3797},[23048],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23050,"children":23051},{"style":1073},[23052],{"type":55,"value":23053},".vpc.vpc_id,\n",{"type":49,"tag":1060,"props":23055,"children":23056},{"class":1062,"line":1111},[23057,23062,23066,23071],{"type":49,"tag":1060,"props":23058,"children":23059},{"style":22635},[23060],{"type":55,"value":23061},"            group_description",{"type":49,"tag":1060,"props":23063,"children":23064},{"style":2194},[23065],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23067,"children":23068},{"style":2215},[23069],{"type":55,"value":23070},"\"DBSecurityGroup\"",{"type":49,"tag":1060,"props":23072,"children":23073},{"style":1073},[23074],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23076,"children":23077},{"class":1062,"line":1120},[23078,23083,23087],{"type":49,"tag":1060,"props":23079,"children":23080},{"style":22635},[23081],{"type":55,"value":23082},"            security_group_ingress",{"type":49,"tag":1060,"props":23084,"children":23085},{"style":2194},[23086],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23088,"children":23089},{"style":1073},[23090],{"type":55,"value":23091},"[\n",{"type":49,"tag":1060,"props":23093,"children":23094},{"class":1062,"line":1128},[23095],{"type":49,"tag":1060,"props":23096,"children":23097},{"style":1073},[23098],{"type":55,"value":23099},"                ec2.CfnSecurityGroup.IngressProperty(\n",{"type":49,"tag":1060,"props":23101,"children":23102},{"class":1062,"line":1141},[23103,23108,23112,23117],{"type":49,"tag":1060,"props":23104,"children":23105},{"style":22635},[23106],{"type":55,"value":23107},"                    ip_protocol",{"type":49,"tag":1060,"props":23109,"children":23110},{"style":2194},[23111],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23113,"children":23114},{"style":2215},[23115],{"type":55,"value":23116},"\"tcp\"",{"type":49,"tag":1060,"props":23118,"children":23119},{"style":1073},[23120],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23122,"children":23123},{"class":1062,"line":1150},[23124,23129,23133,23137],{"type":49,"tag":1060,"props":23125,"children":23126},{"style":22635},[23127],{"type":55,"value":23128},"                    to_port",{"type":49,"tag":1060,"props":23130,"children":23131},{"style":2194},[23132],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23134,"children":23135},{"style":2287},[23136],{"type":55,"value":20334},{"type":49,"tag":1060,"props":23138,"children":23139},{"style":1073},[23140],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23142,"children":23143},{"class":1062,"line":1158},[23144,23149,23153,23157],{"type":49,"tag":1060,"props":23145,"children":23146},{"style":22635},[23147],{"type":55,"value":23148},"                    from_port",{"type":49,"tag":1060,"props":23150,"children":23151},{"style":2194},[23152],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23154,"children":23155},{"style":2287},[23156],{"type":55,"value":20334},{"type":49,"tag":1060,"props":23158,"children":23159},{"style":1073},[23160],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23162,"children":23163},{"class":1062,"line":1171},[23164,23169,23173,23177],{"type":49,"tag":1060,"props":23165,"children":23166},{"style":22635},[23167],{"type":55,"value":23168},"                    source_security_group_id",{"type":49,"tag":1060,"props":23170,"children":23171},{"style":2194},[23172],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23174,"children":23175},{"style":3797},[23176],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23178,"children":23179},{"style":1073},[23180],{"type":55,"value":23181},".lambda_security_group.security_group_id,\n",{"type":49,"tag":1060,"props":23183,"children":23184},{"class":1062,"line":1180},[23185],{"type":49,"tag":1060,"props":23186,"children":23187},{"style":1073},[23188],{"type":55,"value":23189},"                )\n",{"type":49,"tag":1060,"props":23191,"children":23192},{"class":1062,"line":1188},[23193],{"type":49,"tag":1060,"props":23194,"children":23195},{"style":1073},[23196],{"type":55,"value":23197},"            ],\n",{"type":49,"tag":1060,"props":23199,"children":23200},{"class":1062,"line":1201},[23201],{"type":49,"tag":1060,"props":23202,"children":23203},{"style":1073},[23204],{"type":55,"value":22976},{"type":49,"tag":58,"props":23206,"children":23207},{},[23208],{"type":55,"value":23209},"Now let's take a look at the code for the Django lambda itself:",{"type":49,"tag":1050,"props":23211,"children":23213},{"code":23212,"language":19933,"meta":8,"className":19934,"style":8},"        self.djambda_lambda = _lambda.Function(\n            self,\n            \"DjambdaLambda\",\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            code=_lambda.AssetCode('./django'),\n            function_name=f\"{scope.full_app_name}-djambda-lambda\",\n            handler=\"djambda.awsgi.lambda_handler\",\n            layers=[self.djambda_layer],\n            timeout=core.Duration.seconds(60),\n            vpc=self.vpc,\n            vpc_subnets=ec2.SubnetSelection(subnets=self.vpc.isolated_subnets),\n            environment={**self.env_vars},\n            security_groups=[self.lambda_security_group],\n        )\n\n        # Use raw override because Lambda's can't be placed in\n        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n        self.djambda_lambda.node.default_child.add_override(\n            \"Properties.VpcConfig.SubnetIds\",\n            [subnet.subnet_id for subnet in self.vpc.public_subnets],\n        )\n",[23214],{"type":49,"tag":326,"props":23215,"children":23216},{"__ignoreMap":8},[23217,23238,23249,23261,23287,23313,23357,23378,23404,23430,23451,23486,23516,23541,23548,23555,23563,23571,23583,23595,23626],{"type":49,"tag":1060,"props":23218,"children":23219},{"class":1062,"line":1063},[23220,23224,23229,23233],{"type":49,"tag":1060,"props":23221,"children":23222},{"style":3797},[23223],{"type":55,"value":22915},{"type":49,"tag":1060,"props":23225,"children":23226},{"style":1073},[23227],{"type":55,"value":23228},".djambda_lambda ",{"type":49,"tag":1060,"props":23230,"children":23231},{"style":2194},[23232],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23234,"children":23235},{"style":1073},[23236],{"type":55,"value":23237}," _lambda.Function(\n",{"type":49,"tag":1060,"props":23239,"children":23240},{"class":1062,"line":1079},[23241,23245],{"type":49,"tag":1060,"props":23242,"children":23243},{"style":3797},[23244],{"type":55,"value":22937},{"type":49,"tag":1060,"props":23246,"children":23247},{"style":1073},[23248],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23250,"children":23251},{"class":1062,"line":1088},[23252,23257],{"type":49,"tag":1060,"props":23253,"children":23254},{"style":2215},[23255],{"type":55,"value":23256},"            \"DjambdaLambda\"",{"type":49,"tag":1060,"props":23258,"children":23259},{"style":1073},[23260],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23262,"children":23263},{"class":1062,"line":1097},[23264,23269,23273,23278,23283],{"type":49,"tag":1060,"props":23265,"children":23266},{"style":22635},[23267],{"type":55,"value":23268},"            runtime",{"type":49,"tag":1060,"props":23270,"children":23271},{"style":2194},[23272],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23274,"children":23275},{"style":1073},[23276],{"type":55,"value":23277},"_lambda.Runtime.",{"type":49,"tag":1060,"props":23279,"children":23280},{"style":2287},[23281],{"type":55,"value":23282},"PYTHON_3_8",{"type":49,"tag":1060,"props":23284,"children":23285},{"style":1073},[23286],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23288,"children":23289},{"class":1062,"line":1111},[23290,23295,23299,23304,23309],{"type":49,"tag":1060,"props":23291,"children":23292},{"style":22635},[23293],{"type":55,"value":23294},"            code",{"type":49,"tag":1060,"props":23296,"children":23297},{"style":2194},[23298],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23300,"children":23301},{"style":1073},[23302],{"type":55,"value":23303},"_lambda.AssetCode(",{"type":49,"tag":1060,"props":23305,"children":23306},{"style":2215},[23307],{"type":55,"value":23308},"'./django'",{"type":49,"tag":1060,"props":23310,"children":23311},{"style":1073},[23312],{"type":55,"value":20221},{"type":49,"tag":1060,"props":23314,"children":23315},{"class":1062,"line":1120},[23316,23321,23325,23330,23334,23339,23344,23348,23353],{"type":49,"tag":1060,"props":23317,"children":23318},{"style":22635},[23319],{"type":55,"value":23320},"            function_name",{"type":49,"tag":1060,"props":23322,"children":23323},{"style":2194},[23324],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23326,"children":23327},{"style":2182},[23328],{"type":55,"value":23329},"f",{"type":49,"tag":1060,"props":23331,"children":23332},{"style":2215},[23333],{"type":55,"value":10005},{"type":49,"tag":1060,"props":23335,"children":23336},{"style":2287},[23337],{"type":55,"value":23338},"{",{"type":49,"tag":1060,"props":23340,"children":23341},{"style":1073},[23342],{"type":55,"value":23343},"scope.full_app_name",{"type":49,"tag":1060,"props":23345,"children":23346},{"style":2287},[23347],{"type":55,"value":3511},{"type":49,"tag":1060,"props":23349,"children":23350},{"style":2215},[23351],{"type":55,"value":23352},"-djambda-lambda\"",{"type":49,"tag":1060,"props":23354,"children":23355},{"style":1073},[23356],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23358,"children":23359},{"class":1062,"line":1128},[23360,23365,23369,23374],{"type":49,"tag":1060,"props":23361,"children":23362},{"style":22635},[23363],{"type":55,"value":23364},"            handler",{"type":49,"tag":1060,"props":23366,"children":23367},{"style":2194},[23368],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23370,"children":23371},{"style":2215},[23372],{"type":55,"value":23373},"\"djambda.awsgi.lambda_handler\"",{"type":49,"tag":1060,"props":23375,"children":23376},{"style":1073},[23377],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23379,"children":23380},{"class":1062,"line":1141},[23381,23386,23390,23395,23399],{"type":49,"tag":1060,"props":23382,"children":23383},{"style":22635},[23384],{"type":55,"value":23385},"            layers",{"type":49,"tag":1060,"props":23387,"children":23388},{"style":2194},[23389],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23391,"children":23392},{"style":1073},[23393],{"type":55,"value":23394},"[",{"type":49,"tag":1060,"props":23396,"children":23397},{"style":3797},[23398],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23400,"children":23401},{"style":1073},[23402],{"type":55,"value":23403},".djambda_layer],\n",{"type":49,"tag":1060,"props":23405,"children":23406},{"class":1062,"line":1150},[23407,23412,23416,23421,23426],{"type":49,"tag":1060,"props":23408,"children":23409},{"style":22635},[23410],{"type":55,"value":23411},"            timeout",{"type":49,"tag":1060,"props":23413,"children":23414},{"style":2194},[23415],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23417,"children":23418},{"style":1073},[23419],{"type":55,"value":23420},"core.Duration.seconds(",{"type":49,"tag":1060,"props":23422,"children":23423},{"style":2287},[23424],{"type":55,"value":23425},"60",{"type":49,"tag":1060,"props":23427,"children":23428},{"style":1073},[23429],{"type":55,"value":20221},{"type":49,"tag":1060,"props":23431,"children":23432},{"class":1062,"line":1158},[23433,23438,23442,23446],{"type":49,"tag":1060,"props":23434,"children":23435},{"style":22635},[23436],{"type":55,"value":23437},"            vpc",{"type":49,"tag":1060,"props":23439,"children":23440},{"style":2194},[23441],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23443,"children":23444},{"style":3797},[23445],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23447,"children":23448},{"style":1073},[23449],{"type":55,"value":23450},".vpc,\n",{"type":49,"tag":1060,"props":23452,"children":23453},{"class":1062,"line":1171},[23454,23459,23463,23468,23473,23477,23481],{"type":49,"tag":1060,"props":23455,"children":23456},{"style":22635},[23457],{"type":55,"value":23458},"            vpc_subnets",{"type":49,"tag":1060,"props":23460,"children":23461},{"style":2194},[23462],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23464,"children":23465},{"style":1073},[23466],{"type":55,"value":23467},"ec2.SubnetSelection(",{"type":49,"tag":1060,"props":23469,"children":23470},{"style":22635},[23471],{"type":55,"value":23472},"subnets",{"type":49,"tag":1060,"props":23474,"children":23475},{"style":2194},[23476],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23478,"children":23479},{"style":3797},[23480],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23482,"children":23483},{"style":1073},[23484],{"type":55,"value":23485},".vpc.isolated_subnets),\n",{"type":49,"tag":1060,"props":23487,"children":23488},{"class":1062,"line":1180},[23489,23494,23498,23502,23507,23511],{"type":49,"tag":1060,"props":23490,"children":23491},{"style":22635},[23492],{"type":55,"value":23493},"            environment",{"type":49,"tag":1060,"props":23495,"children":23496},{"style":2194},[23497],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23499,"children":23500},{"style":1073},[23501],{"type":55,"value":23338},{"type":49,"tag":1060,"props":23503,"children":23504},{"style":2194},[23505],{"type":55,"value":23506},"**",{"type":49,"tag":1060,"props":23508,"children":23509},{"style":3797},[23510],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23512,"children":23513},{"style":1073},[23514],{"type":55,"value":23515},".env_vars},\n",{"type":49,"tag":1060,"props":23517,"children":23518},{"class":1062,"line":1188},[23519,23524,23528,23532,23536],{"type":49,"tag":1060,"props":23520,"children":23521},{"style":22635},[23522],{"type":55,"value":23523},"            security_groups",{"type":49,"tag":1060,"props":23525,"children":23526},{"style":2194},[23527],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23529,"children":23530},{"style":1073},[23531],{"type":55,"value":23394},{"type":49,"tag":1060,"props":23533,"children":23534},{"style":3797},[23535],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23537,"children":23538},{"style":1073},[23539],{"type":55,"value":23540},".lambda_security_group],\n",{"type":49,"tag":1060,"props":23542,"children":23543},{"class":1062,"line":1201},[23544],{"type":49,"tag":1060,"props":23545,"children":23546},{"style":1073},[23547],{"type":55,"value":22976},{"type":49,"tag":1060,"props":23549,"children":23550},{"class":1062,"line":1210},[23551],{"type":49,"tag":1060,"props":23552,"children":23553},{"emptyLinePlaceholder":44},[23554],{"type":55,"value":1094},{"type":49,"tag":1060,"props":23556,"children":23557},{"class":1062,"line":1218},[23558],{"type":49,"tag":1060,"props":23559,"children":23560},{"style":3039},[23561],{"type":55,"value":23562},"        # Use raw override because Lambda's can't be placed in\n",{"type":49,"tag":1060,"props":23564,"children":23565},{"class":1062,"line":1232},[23566],{"type":49,"tag":1060,"props":23567,"children":23568},{"style":3039},[23569],{"type":55,"value":23570},"        # public subnets using CDK: https://github.com/aws/aws-cdk/issues/8935\n",{"type":49,"tag":1060,"props":23572,"children":23573},{"class":1062,"line":1241},[23574,23578],{"type":49,"tag":1060,"props":23575,"children":23576},{"style":3797},[23577],{"type":55,"value":22915},{"type":49,"tag":1060,"props":23579,"children":23580},{"style":1073},[23581],{"type":55,"value":23582},".djambda_lambda.node.default_child.add_override(\n",{"type":49,"tag":1060,"props":23584,"children":23585},{"class":1062,"line":1249},[23586,23591],{"type":49,"tag":1060,"props":23587,"children":23588},{"style":2215},[23589],{"type":55,"value":23590},"            \"Properties.VpcConfig.SubnetIds\"",{"type":49,"tag":1060,"props":23592,"children":23593},{"style":1073},[23594],{"type":55,"value":2497},{"type":49,"tag":1060,"props":23596,"children":23597},{"class":1062,"line":1262},[23598,23603,23607,23612,23616,23621],{"type":49,"tag":1060,"props":23599,"children":23600},{"style":1073},[23601],{"type":55,"value":23602},"            [subnet.subnet_id ",{"type":49,"tag":1060,"props":23604,"children":23605},{"style":2194},[23606],{"type":55,"value":10063},{"type":49,"tag":1060,"props":23608,"children":23609},{"style":1073},[23610],{"type":55,"value":23611}," subnet ",{"type":49,"tag":1060,"props":23613,"children":23614},{"style":2194},[23615],{"type":55,"value":10073},{"type":49,"tag":1060,"props":23617,"children":23618},{"style":3797},[23619],{"type":55,"value":23620}," self",{"type":49,"tag":1060,"props":23622,"children":23623},{"style":1073},[23624],{"type":55,"value":23625},".vpc.public_subnets],\n",{"type":49,"tag":1060,"props":23627,"children":23628},{"class":1062,"line":4581},[23629],{"type":49,"tag":1060,"props":23630,"children":23631},{"style":1073},[23632],{"type":55,"value":22976},{"type":49,"tag":58,"props":23634,"children":23635},{},[23636,23641,23643,23648,23649,23655,23657,23663,23665,23671,23673,23678,23680,23686,23688,23694,23696,23702,23704,23710,23711,23717,23719,23725],{"type":49,"tag":326,"props":23637,"children":23639},{"className":23638},[],[23640],{"type":55,"value":22048},{"type":55,"value":23642}," is a reserved word in Python, so we import ",{"type":49,"tag":326,"props":23644,"children":23646},{"className":23645},[],[23647],{"type":55,"value":22048},{"type":55,"value":452},{"type":49,"tag":326,"props":23650,"children":23652},{"className":23651},[],[23653],{"type":55,"value":23654},"_lambda",{"type":55,"value":23656}," from ",{"type":49,"tag":326,"props":23658,"children":23660},{"className":23659},[],[23661],{"type":55,"value":23662},"aws_cdk",{"type":55,"value":23664},". Note that we have a reference to the ",{"type":49,"tag":326,"props":23666,"children":23668},{"className":23667},[],[23669],{"type":55,"value":23670},"awsgi.py",{"type":55,"value":23672}," handler function in the ",{"type":49,"tag":326,"props":23674,"children":23676},{"className":23675},[],[23677],{"type":55,"value":22167},{"type":55,"value":23679}," parameter of ",{"type":49,"tag":326,"props":23681,"children":23683},{"className":23682},[],[23684],{"type":55,"value":23685},"self.djambda_lambda",{"type":55,"value":23687},". I initially put the lambda in ",{"type":49,"tag":326,"props":23689,"children":23691},{"className":23690},[],[23692],{"type":55,"value":23693},"isolated_subnets",{"type":55,"value":23695}," because CDK won't let you define a ",{"type":49,"tag":326,"props":23697,"children":23699},{"className":23698},[],[23700],{"type":55,"value":23701},"_lambda.Function",{"type":55,"value":23703}," with ",{"type":49,"tag":326,"props":23705,"children":23707},{"className":23706},[],[23708],{"type":55,"value":23709},"public_subnets",{"type":55,"value":9165},{"type":49,"tag":326,"props":23712,"children":23714},{"className":23713},[],[23715],{"type":55,"value":23716},"vpc_subnets",{"type":55,"value":23718},". We can override this using ",{"type":49,"tag":326,"props":23720,"children":23722},{"className":23721},[],[23723],{"type":55,"value":23724},"add_override",{"type":55,"value":23726}," below the Lambda definition to place it in a public subnet instead.",{"type":49,"tag":2910,"props":23728,"children":23729},{},[23730],{"type":49,"tag":58,"props":23731,"children":23732},{},[23733,23735,23741],{"type":55,"value":23734},"I'm not sure if this is necessary, or if this is recommended. Things get a little bit confusing for me here so I would love some insight if anyone knows what would be best to do here. The VPC construct for CDK doesn't allow you to have private subnets when ",{"type":49,"tag":326,"props":23736,"children":23738},{"className":23737},[],[23739],{"type":55,"value":23740},"nat_gateways=0",{"type":55,"value":23742},". Would I be better off placing the lambda in the isolated subnet with the RDS cluster? Would I still be able to access S3 via the VPC Gateway Endpoint from an isolated subnet?",{"type":49,"tag":58,"props":23744,"children":23745},{},[23746,23748,23753,23755,23760],{"type":55,"value":23747},"Putting aside my uncertainties about the correct way to configure our Lambdas functions in a VPC, let's continue! Here's the Lambda invocation for ",{"type":49,"tag":326,"props":23749,"children":23751},{"className":23750},[],[23752],{"type":55,"value":21930},{"type":55,"value":23754}," that we can run once we have successfully invoked the ",{"type":49,"tag":326,"props":23756,"children":23758},{"className":23757},[],[23759],{"type":55,"value":3323},{"type":55,"value":19080},{"type":49,"tag":1050,"props":23762,"children":23764},{"code":23763,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}' \\\n    resp.json\n",[23765],{"type":49,"tag":326,"props":23766,"children":23767},{"__ignoreMap":8},[23768,23787,23803,23818,23834],{"type":49,"tag":1060,"props":23769,"children":23770},{"class":1062,"line":1063},[23771,23775,23779,23783],{"type":49,"tag":1060,"props":23772,"children":23773},{"style":1067},[23774],{"type":55,"value":20},{"type":49,"tag":1060,"props":23776,"children":23777},{"style":2215},[23778],{"type":55,"value":22752},{"type":49,"tag":1060,"props":23780,"children":23781},{"style":2215},[23782],{"type":55,"value":22757},{"type":49,"tag":1060,"props":23784,"children":23785},{"style":2287},[23786],{"type":55,"value":10239},{"type":49,"tag":1060,"props":23788,"children":23789},{"class":1062,"line":1079},[23790,23794,23799],{"type":49,"tag":1060,"props":23791,"children":23792},{"style":2287},[23793],{"type":55,"value":22769},{"type":49,"tag":1060,"props":23795,"children":23796},{"style":2215},[23797],{"type":55,"value":23798}," dev-mysite-com-djambda-lambda",{"type":49,"tag":1060,"props":23800,"children":23801},{"style":2287},[23802],{"type":55,"value":10239},{"type":49,"tag":1060,"props":23804,"children":23805},{"class":1062,"line":1088},[23806,23810,23814],{"type":49,"tag":1060,"props":23807,"children":23808},{"style":2287},[23809],{"type":55,"value":22786},{"type":49,"tag":1060,"props":23811,"children":23812},{"style":2215},[23813],{"type":55,"value":22791},{"type":49,"tag":1060,"props":23815,"children":23816},{"style":2287},[23817],{"type":55,"value":10239},{"type":49,"tag":1060,"props":23819,"children":23820},{"class":1062,"line":1097},[23821,23825,23830],{"type":49,"tag":1060,"props":23822,"children":23823},{"style":2287},[23824],{"type":55,"value":22803},{"type":49,"tag":1060,"props":23826,"children":23827},{"style":2215},[23828],{"type":55,"value":23829}," '{\"manage\": \"createsuperuser --no-input --username admin --email brian@email.com\"}'",{"type":49,"tag":1060,"props":23831,"children":23832},{"style":2287},[23833],{"type":55,"value":10239},{"type":49,"tag":1060,"props":23835,"children":23836},{"class":1062,"line":1111},[23837],{"type":49,"tag":1060,"props":23838,"children":23839},{"style":2215},[23840],{"type":55,"value":22820},{"type":49,"tag":58,"props":23842,"children":23843},{},[23844,23846,23851,23853,23859,23860,23866,23868,23874],{"type":55,"value":23845},"This assumes that there is an environment variable defined in our Lambda's ",{"type":49,"tag":326,"props":23847,"children":23849},{"className":23848},[],[23850],{"type":55,"value":5113},{"type":55,"value":23852}," variables that we passed in ",{"type":49,"tag":326,"props":23854,"children":23856},{"className":23855},[],[23857],{"type":55,"value":23858},"{**self.env_vars}",{"type":55,"value":9165},{"type":49,"tag":326,"props":23861,"children":23863},{"className":23862},[],[23864],{"type":55,"value":23865},"DJANGO_SUPERUSER_USERNAME",{"type":55,"value":23867},". Here's what we have in ",{"type":49,"tag":326,"props":23869,"children":23871},{"className":23870},[],[23872],{"type":55,"value":23873},"env_vars",{"type":55,"value":6694},{"type":49,"tag":1050,"props":23876,"children":23878},{"code":23877,"language":19933,"meta":8,"className":19934,"style":8},"        self.env_vars = {\n            \"POSTGRES_SERVICE_HOST\": self.rds_cluster.get_att(\n                \"Endpoint.Address\"\n            ).to_string(),\n            \"POSTGRES_PASSWORD\": os.environ.get(\"DB_PASSWORD\", \"db-password\"),\n            \"AWS_STORAGE_BUCKET_NAME\": f\"{scope.full_app_name}-assets\",\n            \"DEBUG\": \"\",\n            \"DJANGO_SUPERUSER_PASSWORD\": os.environ.get(\n                \"DJANGO_SUPERUSER_PASSWORD\", \"Mypassword1!\"\n            ),\n            \"DJANGO_SUPERUSER_USERNAME\": os.environ.get(\n                \"DJANGO_SUPERUSER_USERNAME\", \"admin\"\n            ),\n        }\n",[23879],{"type":49,"tag":326,"props":23880,"children":23881},{"__ignoreMap":8},[23882,23902,23923,23931,23939,23969,24010,24031,24044,24061,24069,24081,24098,24105],{"type":49,"tag":1060,"props":23883,"children":23884},{"class":1062,"line":1063},[23885,23889,23894,23898],{"type":49,"tag":1060,"props":23886,"children":23887},{"style":3797},[23888],{"type":55,"value":22915},{"type":49,"tag":1060,"props":23890,"children":23891},{"style":1073},[23892],{"type":55,"value":23893},".env_vars ",{"type":49,"tag":1060,"props":23895,"children":23896},{"style":2194},[23897],{"type":55,"value":3068},{"type":49,"tag":1060,"props":23899,"children":23900},{"style":1073},[23901],{"type":55,"value":4010},{"type":49,"tag":1060,"props":23903,"children":23904},{"class":1062,"line":1079},[23905,23910,23914,23918],{"type":49,"tag":1060,"props":23906,"children":23907},{"style":2215},[23908],{"type":55,"value":23909},"            \"POSTGRES_SERVICE_HOST\"",{"type":49,"tag":1060,"props":23911,"children":23912},{"style":1073},[23913],{"type":55,"value":78},{"type":49,"tag":1060,"props":23915,"children":23916},{"style":3797},[23917],{"type":55,"value":22963},{"type":49,"tag":1060,"props":23919,"children":23920},{"style":1073},[23921],{"type":55,"value":23922},".rds_cluster.get_att(\n",{"type":49,"tag":1060,"props":23924,"children":23925},{"class":1062,"line":1088},[23926],{"type":49,"tag":1060,"props":23927,"children":23928},{"style":2215},[23929],{"type":55,"value":23930},"                \"Endpoint.Address\"\n",{"type":49,"tag":1060,"props":23932,"children":23933},{"class":1062,"line":1097},[23934],{"type":49,"tag":1060,"props":23935,"children":23936},{"style":1073},[23937],{"type":55,"value":23938},"            ).to_string(),\n",{"type":49,"tag":1060,"props":23940,"children":23941},{"class":1062,"line":1111},[23942,23947,23951,23956,23960,23965],{"type":49,"tag":1060,"props":23943,"children":23944},{"style":2215},[23945],{"type":55,"value":23946},"            \"POSTGRES_PASSWORD\"",{"type":49,"tag":1060,"props":23948,"children":23949},{"style":1073},[23950],{"type":55,"value":20202},{"type":49,"tag":1060,"props":23952,"children":23953},{"style":2215},[23954],{"type":55,"value":23955},"\"DB_PASSWORD\"",{"type":49,"tag":1060,"props":23957,"children":23958},{"style":1073},[23959],{"type":55,"value":873},{"type":49,"tag":1060,"props":23961,"children":23962},{"style":2215},[23963],{"type":55,"value":23964},"\"db-password\"",{"type":49,"tag":1060,"props":23966,"children":23967},{"style":1073},[23968],{"type":55,"value":20221},{"type":49,"tag":1060,"props":23970,"children":23971},{"class":1062,"line":1120},[23972,23977,23981,23985,23989,23993,23997,24001,24006],{"type":49,"tag":1060,"props":23973,"children":23974},{"style":2215},[23975],{"type":55,"value":23976},"            \"AWS_STORAGE_BUCKET_NAME\"",{"type":49,"tag":1060,"props":23978,"children":23979},{"style":1073},[23980],{"type":55,"value":78},{"type":49,"tag":1060,"props":23982,"children":23983},{"style":2182},[23984],{"type":55,"value":23329},{"type":49,"tag":1060,"props":23986,"children":23987},{"style":2215},[23988],{"type":55,"value":10005},{"type":49,"tag":1060,"props":23990,"children":23991},{"style":2287},[23992],{"type":55,"value":23338},{"type":49,"tag":1060,"props":23994,"children":23995},{"style":1073},[23996],{"type":55,"value":23343},{"type":49,"tag":1060,"props":23998,"children":23999},{"style":2287},[24000],{"type":55,"value":3511},{"type":49,"tag":1060,"props":24002,"children":24003},{"style":2215},[24004],{"type":55,"value":24005},"-assets\"",{"type":49,"tag":1060,"props":24007,"children":24008},{"style":1073},[24009],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24011,"children":24012},{"class":1062,"line":1128},[24013,24018,24022,24027],{"type":49,"tag":1060,"props":24014,"children":24015},{"style":2215},[24016],{"type":55,"value":24017},"            \"DEBUG\"",{"type":49,"tag":1060,"props":24019,"children":24020},{"style":1073},[24021],{"type":55,"value":78},{"type":49,"tag":1060,"props":24023,"children":24024},{"style":2215},[24025],{"type":55,"value":24026},"\"\"",{"type":49,"tag":1060,"props":24028,"children":24029},{"style":1073},[24030],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24032,"children":24033},{"class":1062,"line":1141},[24034,24039],{"type":49,"tag":1060,"props":24035,"children":24036},{"style":2215},[24037],{"type":55,"value":24038},"            \"DJANGO_SUPERUSER_PASSWORD\"",{"type":49,"tag":1060,"props":24040,"children":24041},{"style":1073},[24042],{"type":55,"value":24043},": os.environ.get(\n",{"type":49,"tag":1060,"props":24045,"children":24046},{"class":1062,"line":1150},[24047,24052,24056],{"type":49,"tag":1060,"props":24048,"children":24049},{"style":2215},[24050],{"type":55,"value":24051},"                \"DJANGO_SUPERUSER_PASSWORD\"",{"type":49,"tag":1060,"props":24053,"children":24054},{"style":1073},[24055],{"type":55,"value":873},{"type":49,"tag":1060,"props":24057,"children":24058},{"style":2215},[24059],{"type":55,"value":24060},"\"Mypassword1!\"\n",{"type":49,"tag":1060,"props":24062,"children":24063},{"class":1062,"line":1158},[24064],{"type":49,"tag":1060,"props":24065,"children":24066},{"style":1073},[24067],{"type":55,"value":24068},"            ),\n",{"type":49,"tag":1060,"props":24070,"children":24071},{"class":1062,"line":1171},[24072,24077],{"type":49,"tag":1060,"props":24073,"children":24074},{"style":2215},[24075],{"type":55,"value":24076},"            \"DJANGO_SUPERUSER_USERNAME\"",{"type":49,"tag":1060,"props":24078,"children":24079},{"style":1073},[24080],{"type":55,"value":24043},{"type":49,"tag":1060,"props":24082,"children":24083},{"class":1062,"line":1180},[24084,24089,24093],{"type":49,"tag":1060,"props":24085,"children":24086},{"style":2215},[24087],{"type":55,"value":24088},"                \"DJANGO_SUPERUSER_USERNAME\"",{"type":49,"tag":1060,"props":24090,"children":24091},{"style":1073},[24092],{"type":55,"value":873},{"type":49,"tag":1060,"props":24094,"children":24095},{"style":2215},[24096],{"type":55,"value":24097},"\"admin\"\n",{"type":49,"tag":1060,"props":24099,"children":24100},{"class":1062,"line":1188},[24101],{"type":49,"tag":1060,"props":24102,"children":24103},{"style":1073},[24104],{"type":55,"value":24068},{"type":49,"tag":1060,"props":24106,"children":24107},{"class":1062,"line":1201},[24108],{"type":49,"tag":1060,"props":24109,"children":24110},{"style":1073},[24111],{"type":55,"value":24112},"        }\n",{"type":49,"tag":58,"props":24114,"children":24115},{},[24116],{"type":55,"value":24117},"We can use environment variables to set an initial password for our superuser. We also define additionl environment variables that we will use for our datbase connection, and the S3 bucket that we will use for Django's static and media assets.",{"type":49,"tag":50,"props":24119,"children":24121},{"id":24120},"s3",[24122],{"type":55,"value":2012},{"type":49,"tag":58,"props":24124,"children":24125},{},[24126],{"type":55,"value":24127},"To access S3 from our Lambda function in a VPC, we need to use a VPC Gateway Endpoint for S3. This is a free service that enables us to access S3 directly from our VPC without going through the internet, and instead using a private connection . This again has to do with the fact that our Django Lambda can't access the internet because the network interfaces created by Lambda only have private IP addresses and would require NAT in order to connect to resources on the internet. Here's how we define the VPC as well as the VPC Gateway Endpoint using CDK:",{"type":49,"tag":1050,"props":24129,"children":24131},{"code":24130,"language":19933,"meta":8,"className":19934,"style":8},"        self.vpc = ec2.Vpc(\n            self,\n            \"Vpc\",\n            max_azs=2,\n            cidr=\"10.0.0.0/16\",\n            nat_gateways=0,\n            subnet_configuration=[\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.PUBLIC,\n                    name=\"Public\",\n                    cidr_mask=24,\n                ),\n                ec2.SubnetConfiguration(\n                    subnet_type=ec2.SubnetType.ISOLATED,\n                    name=\"Isolated\",\n                    cidr_mask=24,\n                ),\n            ],\n        )\n\n        self.vpc.add_gateway_endpoint(\n            \"S3Gateway\", service=ec2.GatewayVpcEndpointAwsService('s3')\n        )\n",[24132],{"type":49,"tag":326,"props":24133,"children":24134},{"__ignoreMap":8},[24135,24156,24167,24179,24200,24221,24241,24257,24265,24291,24312,24333,24341,24348,24372,24392,24411,24418,24425,24432,24439,24451,24486],{"type":49,"tag":1060,"props":24136,"children":24137},{"class":1062,"line":1063},[24138,24142,24147,24151],{"type":49,"tag":1060,"props":24139,"children":24140},{"style":3797},[24141],{"type":55,"value":22915},{"type":49,"tag":1060,"props":24143,"children":24144},{"style":1073},[24145],{"type":55,"value":24146},".vpc ",{"type":49,"tag":1060,"props":24148,"children":24149},{"style":2194},[24150],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24152,"children":24153},{"style":1073},[24154],{"type":55,"value":24155}," ec2.Vpc(\n",{"type":49,"tag":1060,"props":24157,"children":24158},{"class":1062,"line":1079},[24159,24163],{"type":49,"tag":1060,"props":24160,"children":24161},{"style":3797},[24162],{"type":55,"value":22937},{"type":49,"tag":1060,"props":24164,"children":24165},{"style":1073},[24166],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24168,"children":24169},{"class":1062,"line":1088},[24170,24175],{"type":49,"tag":1060,"props":24171,"children":24172},{"style":2215},[24173],{"type":55,"value":24174},"            \"Vpc\"",{"type":49,"tag":1060,"props":24176,"children":24177},{"style":1073},[24178],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24180,"children":24181},{"class":1062,"line":1097},[24182,24187,24191,24196],{"type":49,"tag":1060,"props":24183,"children":24184},{"style":22635},[24185],{"type":55,"value":24186},"            max_azs",{"type":49,"tag":1060,"props":24188,"children":24189},{"style":2194},[24190],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24192,"children":24193},{"style":2287},[24194],{"type":55,"value":24195},"2",{"type":49,"tag":1060,"props":24197,"children":24198},{"style":1073},[24199],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24201,"children":24202},{"class":1062,"line":1111},[24203,24208,24212,24217],{"type":49,"tag":1060,"props":24204,"children":24205},{"style":22635},[24206],{"type":55,"value":24207},"            cidr",{"type":49,"tag":1060,"props":24209,"children":24210},{"style":2194},[24211],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24213,"children":24214},{"style":2215},[24215],{"type":55,"value":24216},"\"10.0.0.0/16\"",{"type":49,"tag":1060,"props":24218,"children":24219},{"style":1073},[24220],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24222,"children":24223},{"class":1062,"line":1120},[24224,24229,24233,24237],{"type":49,"tag":1060,"props":24225,"children":24226},{"style":22635},[24227],{"type":55,"value":24228},"            nat_gateways",{"type":49,"tag":1060,"props":24230,"children":24231},{"style":2194},[24232],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24234,"children":24235},{"style":2287},[24236],{"type":55,"value":8397},{"type":49,"tag":1060,"props":24238,"children":24239},{"style":1073},[24240],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24242,"children":24243},{"class":1062,"line":1128},[24244,24249,24253],{"type":49,"tag":1060,"props":24245,"children":24246},{"style":22635},[24247],{"type":55,"value":24248},"            subnet_configuration",{"type":49,"tag":1060,"props":24250,"children":24251},{"style":2194},[24252],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24254,"children":24255},{"style":1073},[24256],{"type":55,"value":23091},{"type":49,"tag":1060,"props":24258,"children":24259},{"class":1062,"line":1141},[24260],{"type":49,"tag":1060,"props":24261,"children":24262},{"style":1073},[24263],{"type":55,"value":24264},"                ec2.SubnetConfiguration(\n",{"type":49,"tag":1060,"props":24266,"children":24267},{"class":1062,"line":1150},[24268,24273,24277,24282,24287],{"type":49,"tag":1060,"props":24269,"children":24270},{"style":22635},[24271],{"type":55,"value":24272},"                    subnet_type",{"type":49,"tag":1060,"props":24274,"children":24275},{"style":2194},[24276],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24278,"children":24279},{"style":1073},[24280],{"type":55,"value":24281},"ec2.SubnetType.",{"type":49,"tag":1060,"props":24283,"children":24284},{"style":2287},[24285],{"type":55,"value":24286},"PUBLIC",{"type":49,"tag":1060,"props":24288,"children":24289},{"style":1073},[24290],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24292,"children":24293},{"class":1062,"line":1158},[24294,24299,24303,24308],{"type":49,"tag":1060,"props":24295,"children":24296},{"style":22635},[24297],{"type":55,"value":24298},"                    name",{"type":49,"tag":1060,"props":24300,"children":24301},{"style":2194},[24302],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24304,"children":24305},{"style":2215},[24306],{"type":55,"value":24307},"\"Public\"",{"type":49,"tag":1060,"props":24309,"children":24310},{"style":1073},[24311],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24313,"children":24314},{"class":1062,"line":1171},[24315,24320,24324,24329],{"type":49,"tag":1060,"props":24316,"children":24317},{"style":22635},[24318],{"type":55,"value":24319},"                    cidr_mask",{"type":49,"tag":1060,"props":24321,"children":24322},{"style":2194},[24323],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24325,"children":24326},{"style":2287},[24327],{"type":55,"value":24328},"24",{"type":49,"tag":1060,"props":24330,"children":24331},{"style":1073},[24332],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24334,"children":24335},{"class":1062,"line":1180},[24336],{"type":49,"tag":1060,"props":24337,"children":24338},{"style":1073},[24339],{"type":55,"value":24340},"                ),\n",{"type":49,"tag":1060,"props":24342,"children":24343},{"class":1062,"line":1188},[24344],{"type":49,"tag":1060,"props":24345,"children":24346},{"style":1073},[24347],{"type":55,"value":24264},{"type":49,"tag":1060,"props":24349,"children":24350},{"class":1062,"line":1201},[24351,24355,24359,24363,24368],{"type":49,"tag":1060,"props":24352,"children":24353},{"style":22635},[24354],{"type":55,"value":24272},{"type":49,"tag":1060,"props":24356,"children":24357},{"style":2194},[24358],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24360,"children":24361},{"style":1073},[24362],{"type":55,"value":24281},{"type":49,"tag":1060,"props":24364,"children":24365},{"style":2287},[24366],{"type":55,"value":24367},"ISOLATED",{"type":49,"tag":1060,"props":24369,"children":24370},{"style":1073},[24371],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24373,"children":24374},{"class":1062,"line":1210},[24375,24379,24383,24388],{"type":49,"tag":1060,"props":24376,"children":24377},{"style":22635},[24378],{"type":55,"value":24298},{"type":49,"tag":1060,"props":24380,"children":24381},{"style":2194},[24382],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24384,"children":24385},{"style":2215},[24386],{"type":55,"value":24387},"\"Isolated\"",{"type":49,"tag":1060,"props":24389,"children":24390},{"style":1073},[24391],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24393,"children":24394},{"class":1062,"line":1218},[24395,24399,24403,24407],{"type":49,"tag":1060,"props":24396,"children":24397},{"style":22635},[24398],{"type":55,"value":24319},{"type":49,"tag":1060,"props":24400,"children":24401},{"style":2194},[24402],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24404,"children":24405},{"style":2287},[24406],{"type":55,"value":24328},{"type":49,"tag":1060,"props":24408,"children":24409},{"style":1073},[24410],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24412,"children":24413},{"class":1062,"line":1232},[24414],{"type":49,"tag":1060,"props":24415,"children":24416},{"style":1073},[24417],{"type":55,"value":24340},{"type":49,"tag":1060,"props":24419,"children":24420},{"class":1062,"line":1241},[24421],{"type":49,"tag":1060,"props":24422,"children":24423},{"style":1073},[24424],{"type":55,"value":23197},{"type":49,"tag":1060,"props":24426,"children":24427},{"class":1062,"line":1249},[24428],{"type":49,"tag":1060,"props":24429,"children":24430},{"style":1073},[24431],{"type":55,"value":22976},{"type":49,"tag":1060,"props":24433,"children":24434},{"class":1062,"line":1262},[24435],{"type":49,"tag":1060,"props":24436,"children":24437},{"emptyLinePlaceholder":44},[24438],{"type":55,"value":1094},{"type":49,"tag":1060,"props":24440,"children":24441},{"class":1062,"line":4581},[24442,24446],{"type":49,"tag":1060,"props":24443,"children":24444},{"style":3797},[24445],{"type":55,"value":22915},{"type":49,"tag":1060,"props":24447,"children":24448},{"style":1073},[24449],{"type":55,"value":24450},".vpc.add_gateway_endpoint(\n",{"type":49,"tag":1060,"props":24452,"children":24453},{"class":1062,"line":4631},[24454,24459,24463,24468,24472,24477,24482],{"type":49,"tag":1060,"props":24455,"children":24456},{"style":2215},[24457],{"type":55,"value":24458},"            \"S3Gateway\"",{"type":49,"tag":1060,"props":24460,"children":24461},{"style":1073},[24462],{"type":55,"value":873},{"type":49,"tag":1060,"props":24464,"children":24465},{"style":22635},[24466],{"type":55,"value":24467},"service",{"type":49,"tag":1060,"props":24469,"children":24470},{"style":2194},[24471],{"type":55,"value":3068},{"type":49,"tag":1060,"props":24473,"children":24474},{"style":1073},[24475],{"type":55,"value":24476},"ec2.GatewayVpcEndpointAwsService(",{"type":49,"tag":1060,"props":24478,"children":24479},{"style":2215},[24480],{"type":55,"value":24481},"'s3'",{"type":49,"tag":1060,"props":24483,"children":24484},{"style":1073},[24485],{"type":55,"value":5126},{"type":49,"tag":1060,"props":24487,"children":24488},{"class":1062,"line":4682},[24489],{"type":49,"tag":1060,"props":24490,"children":24491},{"style":1073},[24492],{"type":55,"value":22976},{"type":49,"tag":58,"props":24494,"children":24495},{},[24496,24498,24504],{"type":55,"value":24497},"With this VPC endpoint in place, we are almost ready to run our collectstatic command, but it won't work yet. This is because we haven't given our Lambda function access to write files to the S3 assets bucket for our Django application's static and media files. We can grant this permission with the following snippet from ",{"type":49,"tag":326,"props":24499,"children":24501},{"className":24500},[],[24502],{"type":55,"value":24503},"awscdk/app_stack.py",{"type":55,"value":24505},", the file that defines the root CloudFormation stack for our application:",{"type":49,"tag":1050,"props":24507,"children":24509},{"code":24508,"language":19933,"meta":8,"className":19934,"style":8},"        self.backend_assets_bucket.grant_read_write(\n            self.vpc_stack.djambda_lambda\n        )\n",[24510],{"type":49,"tag":326,"props":24511,"children":24512},{"__ignoreMap":8},[24513,24525,24537],{"type":49,"tag":1060,"props":24514,"children":24515},{"class":1062,"line":1063},[24516,24520],{"type":49,"tag":1060,"props":24517,"children":24518},{"style":3797},[24519],{"type":55,"value":22915},{"type":49,"tag":1060,"props":24521,"children":24522},{"style":1073},[24523],{"type":55,"value":24524},".backend_assets_bucket.grant_read_write(\n",{"type":49,"tag":1060,"props":24526,"children":24527},{"class":1062,"line":1079},[24528,24532],{"type":49,"tag":1060,"props":24529,"children":24530},{"style":3797},[24531],{"type":55,"value":22937},{"type":49,"tag":1060,"props":24533,"children":24534},{"style":1073},[24535],{"type":55,"value":24536},".vpc_stack.djambda_lambda\n",{"type":49,"tag":1060,"props":24538,"children":24539},{"class":1062,"line":1088},[24540],{"type":49,"tag":1060,"props":24541,"children":24542},{"style":1073},[24543],{"type":55,"value":22976},{"type":49,"tag":58,"props":24545,"children":24546},{},[24547,24549,24554],{"type":55,"value":24548},"Finally, we need to add the following settings to ",{"type":49,"tag":326,"props":24550,"children":24552},{"className":24551},[],[24553],{"type":55,"value":19927},{"type":55,"value":6694},{"type":49,"tag":1050,"props":24556,"children":24558},{"code":24557,"language":19933,"meta":8,"className":19934,"style":8},"STATIC_URL = '/static/'\nSTATIC_ROOT = os.path.join(BASE_DIR, 'static')\nSTATICFILES_STORAGE = \"djambda.storage_backends.StaticStorage\"\n\nAWS_DEFAULT_ACL = None\nAWS_STORAGE_BUCKET_NAME = os.environ.get(\n    \"AWS_STORAGE_BUCKET_NAME\", \"bucketname\"\n)\nAWS_S3_OBJECT_PARAMETERS = {\n    \"CacheControl\": \"max-age=86400\",\n}\nAWS_PRIVATE_MEDIA_LOCATION = \"media/private\"\nAWS_STATIC_LOCATION = \"static\"\nPRIVATE_FILE_STORAGE = \"backend.storage_backends.PrivateMediaStorage\"\nAWS_S3_CUSTOM_DOMAIN = f\"{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com\"\n\nif not DEBUG:\n    MEDIA_ROOT = \"media\"\n    MEDIA_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{MEDIA_ROOT}/\"\n    STATIC_URL = f\"https://{AWS_S3_CUSTOM_DOMAIN}/{AWS_STATIC_LOCATION}/\"\n    FORCE_SCRIPT_NAME = \"/prod\"\n",[24559],{"type":49,"tag":326,"props":24560,"children":24561},{"__ignoreMap":8},[24562,24579,24612,24629,24636,24653,24670,24687,24694,24710,24731,24738,24755,24772,24789,24820,24827,24849,24866,24906,24943],{"type":49,"tag":1060,"props":24563,"children":24564},{"class":1062,"line":1063},[24565,24570,24574],{"type":49,"tag":1060,"props":24566,"children":24567},{"style":2287},[24568],{"type":55,"value":24569},"STATIC_URL",{"type":49,"tag":1060,"props":24571,"children":24572},{"style":2194},[24573],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24575,"children":24576},{"style":2215},[24577],{"type":55,"value":24578}," '/static/'\n",{"type":49,"tag":1060,"props":24580,"children":24581},{"class":1062,"line":1079},[24582,24586,24590,24595,24599,24603,24608],{"type":49,"tag":1060,"props":24583,"children":24584},{"style":2287},[24585],{"type":55,"value":19919},{"type":49,"tag":1060,"props":24587,"children":24588},{"style":2194},[24589],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24591,"children":24592},{"style":1073},[24593],{"type":55,"value":24594}," os.path.join(",{"type":49,"tag":1060,"props":24596,"children":24597},{"style":2287},[24598],{"type":55,"value":19951},{"type":49,"tag":1060,"props":24600,"children":24601},{"style":1073},[24602],{"type":55,"value":873},{"type":49,"tag":1060,"props":24604,"children":24605},{"style":2215},[24606],{"type":55,"value":24607},"'static'",{"type":49,"tag":1060,"props":24609,"children":24610},{"style":1073},[24611],{"type":55,"value":5126},{"type":49,"tag":1060,"props":24613,"children":24614},{"class":1062,"line":1088},[24615,24620,24624],{"type":49,"tag":1060,"props":24616,"children":24617},{"style":2287},[24618],{"type":55,"value":24619},"STATICFILES_STORAGE",{"type":49,"tag":1060,"props":24621,"children":24622},{"style":2194},[24623],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24625,"children":24626},{"style":2215},[24627],{"type":55,"value":24628}," \"djambda.storage_backends.StaticStorage\"\n",{"type":49,"tag":1060,"props":24630,"children":24631},{"class":1062,"line":1097},[24632],{"type":49,"tag":1060,"props":24633,"children":24634},{"emptyLinePlaceholder":44},[24635],{"type":55,"value":1094},{"type":49,"tag":1060,"props":24637,"children":24638},{"class":1062,"line":1111},[24639,24644,24648],{"type":49,"tag":1060,"props":24640,"children":24641},{"style":2287},[24642],{"type":55,"value":24643},"AWS_DEFAULT_ACL",{"type":49,"tag":1060,"props":24645,"children":24646},{"style":2194},[24647],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24649,"children":24650},{"style":2287},[24651],{"type":55,"value":24652}," None\n",{"type":49,"tag":1060,"props":24654,"children":24655},{"class":1062,"line":1120},[24656,24661,24665],{"type":49,"tag":1060,"props":24657,"children":24658},{"style":2287},[24659],{"type":55,"value":24660},"AWS_STORAGE_BUCKET_NAME",{"type":49,"tag":1060,"props":24662,"children":24663},{"style":2194},[24664],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24666,"children":24667},{"style":1073},[24668],{"type":55,"value":24669}," os.environ.get(\n",{"type":49,"tag":1060,"props":24671,"children":24672},{"class":1062,"line":1128},[24673,24678,24682],{"type":49,"tag":1060,"props":24674,"children":24675},{"style":2215},[24676],{"type":55,"value":24677},"    \"AWS_STORAGE_BUCKET_NAME\"",{"type":49,"tag":1060,"props":24679,"children":24680},{"style":1073},[24681],{"type":55,"value":873},{"type":49,"tag":1060,"props":24683,"children":24684},{"style":2215},[24685],{"type":55,"value":24686},"\"bucketname\"\n",{"type":49,"tag":1060,"props":24688,"children":24689},{"class":1062,"line":1141},[24690],{"type":49,"tag":1060,"props":24691,"children":24692},{"style":1073},[24693],{"type":55,"value":5126},{"type":49,"tag":1060,"props":24695,"children":24696},{"class":1062,"line":1150},[24697,24702,24706],{"type":49,"tag":1060,"props":24698,"children":24699},{"style":2287},[24700],{"type":55,"value":24701},"AWS_S3_OBJECT_PARAMETERS",{"type":49,"tag":1060,"props":24703,"children":24704},{"style":2194},[24705],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24707,"children":24708},{"style":1073},[24709],{"type":55,"value":4010},{"type":49,"tag":1060,"props":24711,"children":24712},{"class":1062,"line":1158},[24713,24718,24722,24727],{"type":49,"tag":1060,"props":24714,"children":24715},{"style":2215},[24716],{"type":55,"value":24717},"    \"CacheControl\"",{"type":49,"tag":1060,"props":24719,"children":24720},{"style":1073},[24721],{"type":55,"value":78},{"type":49,"tag":1060,"props":24723,"children":24724},{"style":2215},[24725],{"type":55,"value":24726},"\"max-age=86400\"",{"type":49,"tag":1060,"props":24728,"children":24729},{"style":1073},[24730],{"type":55,"value":2497},{"type":49,"tag":1060,"props":24732,"children":24733},{"class":1062,"line":1171},[24734],{"type":49,"tag":1060,"props":24735,"children":24736},{"style":1073},[24737],{"type":55,"value":3675},{"type":49,"tag":1060,"props":24739,"children":24740},{"class":1062,"line":1180},[24741,24746,24750],{"type":49,"tag":1060,"props":24742,"children":24743},{"style":2287},[24744],{"type":55,"value":24745},"AWS_PRIVATE_MEDIA_LOCATION",{"type":49,"tag":1060,"props":24747,"children":24748},{"style":2194},[24749],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24751,"children":24752},{"style":2215},[24753],{"type":55,"value":24754}," \"media/private\"\n",{"type":49,"tag":1060,"props":24756,"children":24757},{"class":1062,"line":1188},[24758,24763,24767],{"type":49,"tag":1060,"props":24759,"children":24760},{"style":2287},[24761],{"type":55,"value":24762},"AWS_STATIC_LOCATION",{"type":49,"tag":1060,"props":24764,"children":24765},{"style":2194},[24766],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24768,"children":24769},{"style":2215},[24770],{"type":55,"value":24771}," \"static\"\n",{"type":49,"tag":1060,"props":24773,"children":24774},{"class":1062,"line":1201},[24775,24780,24784],{"type":49,"tag":1060,"props":24776,"children":24777},{"style":2287},[24778],{"type":55,"value":24779},"PRIVATE_FILE_STORAGE",{"type":49,"tag":1060,"props":24781,"children":24782},{"style":2194},[24783],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24785,"children":24786},{"style":2215},[24787],{"type":55,"value":24788}," \"backend.storage_backends.PrivateMediaStorage\"\n",{"type":49,"tag":1060,"props":24790,"children":24791},{"class":1062,"line":1210},[24792,24797,24801,24806,24810,24815],{"type":49,"tag":1060,"props":24793,"children":24794},{"style":2287},[24795],{"type":55,"value":24796},"AWS_S3_CUSTOM_DOMAIN",{"type":49,"tag":1060,"props":24798,"children":24799},{"style":2194},[24800],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24802,"children":24803},{"style":2182},[24804],{"type":55,"value":24805}," f",{"type":49,"tag":1060,"props":24807,"children":24808},{"style":2215},[24809],{"type":55,"value":10005},{"type":49,"tag":1060,"props":24811,"children":24812},{"style":2287},[24813],{"type":55,"value":24814},"{AWS_STORAGE_BUCKET_NAME}",{"type":49,"tag":1060,"props":24816,"children":24817},{"style":2215},[24818],{"type":55,"value":24819},".s3.amazonaws.com\"\n",{"type":49,"tag":1060,"props":24821,"children":24822},{"class":1062,"line":1218},[24823],{"type":49,"tag":1060,"props":24824,"children":24825},{"emptyLinePlaceholder":44},[24826],{"type":55,"value":1094},{"type":49,"tag":1060,"props":24828,"children":24829},{"class":1062,"line":1232},[24830,24835,24840,24845],{"type":49,"tag":1060,"props":24831,"children":24832},{"style":2194},[24833],{"type":55,"value":24834},"if",{"type":49,"tag":1060,"props":24836,"children":24837},{"style":2194},[24838],{"type":55,"value":24839}," not",{"type":49,"tag":1060,"props":24841,"children":24842},{"style":2287},[24843],{"type":55,"value":24844}," DEBUG",{"type":49,"tag":1060,"props":24846,"children":24847},{"style":1073},[24848],{"type":55,"value":6862},{"type":49,"tag":1060,"props":24850,"children":24851},{"class":1062,"line":1241},[24852,24857,24861],{"type":49,"tag":1060,"props":24853,"children":24854},{"style":2287},[24855],{"type":55,"value":24856},"    MEDIA_ROOT",{"type":49,"tag":1060,"props":24858,"children":24859},{"style":2194},[24860],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24862,"children":24863},{"style":2215},[24864],{"type":55,"value":24865}," \"media\"\n",{"type":49,"tag":1060,"props":24867,"children":24868},{"class":1062,"line":1249},[24869,24874,24878,24882,24887,24892,24896,24901],{"type":49,"tag":1060,"props":24870,"children":24871},{"style":2287},[24872],{"type":55,"value":24873},"    MEDIA_URL",{"type":49,"tag":1060,"props":24875,"children":24876},{"style":2194},[24877],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24879,"children":24880},{"style":2182},[24881],{"type":55,"value":24805},{"type":49,"tag":1060,"props":24883,"children":24884},{"style":2215},[24885],{"type":55,"value":24886},"\"https://",{"type":49,"tag":1060,"props":24888,"children":24889},{"style":2287},[24890],{"type":55,"value":24891},"{AWS_S3_CUSTOM_DOMAIN}",{"type":49,"tag":1060,"props":24893,"children":24894},{"style":2215},[24895],{"type":55,"value":3744},{"type":49,"tag":1060,"props":24897,"children":24898},{"style":2287},[24899],{"type":55,"value":24900},"{MEDIA_ROOT}",{"type":49,"tag":1060,"props":24902,"children":24903},{"style":2215},[24904],{"type":55,"value":24905},"/\"\n",{"type":49,"tag":1060,"props":24907,"children":24908},{"class":1062,"line":1262},[24909,24914,24918,24922,24926,24930,24934,24939],{"type":49,"tag":1060,"props":24910,"children":24911},{"style":2287},[24912],{"type":55,"value":24913},"    STATIC_URL",{"type":49,"tag":1060,"props":24915,"children":24916},{"style":2194},[24917],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24919,"children":24920},{"style":2182},[24921],{"type":55,"value":24805},{"type":49,"tag":1060,"props":24923,"children":24924},{"style":2215},[24925],{"type":55,"value":24886},{"type":49,"tag":1060,"props":24927,"children":24928},{"style":2287},[24929],{"type":55,"value":24891},{"type":49,"tag":1060,"props":24931,"children":24932},{"style":2215},[24933],{"type":55,"value":3744},{"type":49,"tag":1060,"props":24935,"children":24936},{"style":2287},[24937],{"type":55,"value":24938},"{AWS_STATIC_LOCATION}",{"type":49,"tag":1060,"props":24940,"children":24941},{"style":2215},[24942],{"type":55,"value":24905},{"type":49,"tag":1060,"props":24944,"children":24945},{"class":1062,"line":4581},[24946,24951,24955],{"type":49,"tag":1060,"props":24947,"children":24948},{"style":2287},[24949],{"type":55,"value":24950},"    FORCE_SCRIPT_NAME",{"type":49,"tag":1060,"props":24952,"children":24953},{"style":2194},[24954],{"type":55,"value":2197},{"type":49,"tag":1060,"props":24956,"children":24957},{"style":2215},[24958],{"type":55,"value":24959}," \"/prod\"\n",{"type":49,"tag":58,"props":24961,"children":24962},{},[24963],{"type":55,"value":24964},"We can run the collectstatic command with the following Lambda invocation:",{"type":49,"tag":1050,"props":24966,"children":24968},{"code":24967,"language":2728,"meta":8,"className":2729,"style":8},"aws lambda invoke \\\n    --function-name dev-mysite-com-djambda-lambda \\\n    --invocation-type RequestResponse \\\n    --payload '{\"manage\": \"collectstatic --no-input\"}' \\\n    resp.json\n",[24969],{"type":49,"tag":326,"props":24970,"children":24971},{"__ignoreMap":8},[24972,24991,25006,25021,25037],{"type":49,"tag":1060,"props":24973,"children":24974},{"class":1062,"line":1063},[24975,24979,24983,24987],{"type":49,"tag":1060,"props":24976,"children":24977},{"style":1067},[24978],{"type":55,"value":20},{"type":49,"tag":1060,"props":24980,"children":24981},{"style":2215},[24982],{"type":55,"value":22752},{"type":49,"tag":1060,"props":24984,"children":24985},{"style":2215},[24986],{"type":55,"value":22757},{"type":49,"tag":1060,"props":24988,"children":24989},{"style":2287},[24990],{"type":55,"value":10239},{"type":49,"tag":1060,"props":24992,"children":24993},{"class":1062,"line":1079},[24994,24998,25002],{"type":49,"tag":1060,"props":24995,"children":24996},{"style":2287},[24997],{"type":55,"value":22769},{"type":49,"tag":1060,"props":24999,"children":25000},{"style":2215},[25001],{"type":55,"value":23798},{"type":49,"tag":1060,"props":25003,"children":25004},{"style":2287},[25005],{"type":55,"value":10239},{"type":49,"tag":1060,"props":25007,"children":25008},{"class":1062,"line":1088},[25009,25013,25017],{"type":49,"tag":1060,"props":25010,"children":25011},{"style":2287},[25012],{"type":55,"value":22786},{"type":49,"tag":1060,"props":25014,"children":25015},{"style":2215},[25016],{"type":55,"value":22791},{"type":49,"tag":1060,"props":25018,"children":25019},{"style":2287},[25020],{"type":55,"value":10239},{"type":49,"tag":1060,"props":25022,"children":25023},{"class":1062,"line":1097},[25024,25028,25033],{"type":49,"tag":1060,"props":25025,"children":25026},{"style":2287},[25027],{"type":55,"value":22803},{"type":49,"tag":1060,"props":25029,"children":25030},{"style":2215},[25031],{"type":55,"value":25032}," '{\"manage\": \"collectstatic --no-input\"}'",{"type":49,"tag":1060,"props":25034,"children":25035},{"style":2287},[25036],{"type":55,"value":10239},{"type":49,"tag":1060,"props":25038,"children":25039},{"class":1062,"line":1111},[25040],{"type":49,"tag":1060,"props":25041,"children":25042},{"style":2215},[25043],{"type":55,"value":22820},{"type":49,"tag":50,"props":25045,"children":25047},{"id":25046},"api-gateway-and-the-lambda-proxy-pattern",[25048],{"type":55,"value":25049},"API Gateway and the Lambda proxy pattern",{"type":49,"tag":58,"props":25051,"children":25052},{},[25053,25055,25062,25064,25070,25072,25079],{"type":55,"value":25054},"I first read about the Lambda proxy pattern in an article titled ",{"type":49,"tag":80,"props":25056,"children":25059},{"href":25057,"rel":25058},"https://serverlessfirst.com/lambda-vpc-internet-access-no-nat-gateway/",[84],[25060],{"type":55,"value":25061},"How to access VPC and internet resources from Lambda without paying for a NAT Gateway",{"type":55,"value":25063}," on Paul Swail's website ",{"type":49,"tag":80,"props":25065,"children":25068},{"href":25066,"rel":25067},"https://serverlessfirst.com/",[84],[25069],{"type":55,"value":25066},{"type":55,"value":25071},". This site has tons of great serverless content, check out the ",{"type":49,"tag":80,"props":25073,"children":25076},{"href":25074,"rel":25075},"https://serverlessfirst.com/articles/",[84],[25077],{"type":55,"value":25078},"list of articles",{"type":55,"value":25080},". Thank you Paul for putting out great serverless resources!",{"type":49,"tag":58,"props":25082,"children":25083},{},[25084],{"type":55,"value":25085},"Let's take a look at the Proxy Lambda function next. The function itself is pretty straightforward:",{"type":49,"tag":1050,"props":25087,"children":25089},{"code":25088,"language":19933,"meta":8,"className":19934,"style":8},"import json\nimport os\nimport boto3\n\nlambda_client = boto3.client('lambda', region_name='us-east-1')\n\n\ndef handler(event, context):\n    invoke_response = lambda_client.invoke(\n        FunctionName=os.environ.get(\"FUNCTION_NAME\", None),\n        InvocationType='RequestResponse',\n        Payload=json.dumps(event),\n    )\n\n    data = invoke_response['Payload'].read()\n\n    return data\n",[25090],{"type":49,"tag":326,"props":25091,"children":25092},{"__ignoreMap":8},[25093,25105,25117,25129,25136,25180,25187,25194,25225,25242,25277,25298,25315,25323,25330,25357,25364],{"type":49,"tag":1060,"props":25094,"children":25095},{"class":1062,"line":1063},[25096,25100],{"type":49,"tag":1060,"props":25097,"children":25098},{"style":2194},[25099],{"type":55,"value":22194},{"type":49,"tag":1060,"props":25101,"children":25102},{"style":1073},[25103],{"type":55,"value":25104}," json\n",{"type":49,"tag":1060,"props":25106,"children":25107},{"class":1062,"line":1079},[25108,25112],{"type":49,"tag":1060,"props":25109,"children":25110},{"style":2194},[25111],{"type":55,"value":22194},{"type":49,"tag":1060,"props":25113,"children":25114},{"style":1073},[25115],{"type":55,"value":25116}," os\n",{"type":49,"tag":1060,"props":25118,"children":25119},{"class":1062,"line":1088},[25120,25124],{"type":49,"tag":1060,"props":25121,"children":25122},{"style":2194},[25123],{"type":55,"value":22194},{"type":49,"tag":1060,"props":25125,"children":25126},{"style":1073},[25127],{"type":55,"value":25128}," boto3\n",{"type":49,"tag":1060,"props":25130,"children":25131},{"class":1062,"line":1097},[25132],{"type":49,"tag":1060,"props":25133,"children":25134},{"emptyLinePlaceholder":44},[25135],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25137,"children":25138},{"class":1062,"line":1111},[25139,25144,25148,25153,25158,25162,25167,25171,25176],{"type":49,"tag":1060,"props":25140,"children":25141},{"style":1073},[25142],{"type":55,"value":25143},"lambda_client ",{"type":49,"tag":1060,"props":25145,"children":25146},{"style":2194},[25147],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25149,"children":25150},{"style":1073},[25151],{"type":55,"value":25152}," boto3.client(",{"type":49,"tag":1060,"props":25154,"children":25155},{"style":2215},[25156],{"type":55,"value":25157},"'lambda'",{"type":49,"tag":1060,"props":25159,"children":25160},{"style":1073},[25161],{"type":55,"value":873},{"type":49,"tag":1060,"props":25163,"children":25164},{"style":22635},[25165],{"type":55,"value":25166},"region_name",{"type":49,"tag":1060,"props":25168,"children":25169},{"style":2194},[25170],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25172,"children":25173},{"style":2215},[25174],{"type":55,"value":25175},"'us-east-1'",{"type":49,"tag":1060,"props":25177,"children":25178},{"style":1073},[25179],{"type":55,"value":5126},{"type":49,"tag":1060,"props":25181,"children":25182},{"class":1062,"line":1120},[25183],{"type":49,"tag":1060,"props":25184,"children":25185},{"emptyLinePlaceholder":44},[25186],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25188,"children":25189},{"class":1062,"line":1128},[25190],{"type":49,"tag":1060,"props":25191,"children":25192},{"emptyLinePlaceholder":44},[25193],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25195,"children":25196},{"class":1062,"line":1141},[25197,25201,25205,25209,25213,25217,25221],{"type":49,"tag":1060,"props":25198,"children":25199},{"style":2182},[25200],{"type":55,"value":22214},{"type":49,"tag":1060,"props":25202,"children":25203},{"style":1067},[25204],{"type":55,"value":22219},{"type":49,"tag":1060,"props":25206,"children":25207},{"style":1073},[25208],{"type":55,"value":2284},{"type":49,"tag":1060,"props":25210,"children":25211},{"style":22226},[25212],{"type":55,"value":22229},{"type":49,"tag":1060,"props":25214,"children":25215},{"style":1073},[25216],{"type":55,"value":873},{"type":49,"tag":1060,"props":25218,"children":25219},{"style":22226},[25220],{"type":55,"value":14059},{"type":49,"tag":1060,"props":25222,"children":25223},{"style":1073},[25224],{"type":55,"value":22242},{"type":49,"tag":1060,"props":25226,"children":25227},{"class":1062,"line":1150},[25228,25233,25237],{"type":49,"tag":1060,"props":25229,"children":25230},{"style":1073},[25231],{"type":55,"value":25232},"    invoke_response ",{"type":49,"tag":1060,"props":25234,"children":25235},{"style":2194},[25236],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25238,"children":25239},{"style":1073},[25240],{"type":55,"value":25241}," lambda_client.invoke(\n",{"type":49,"tag":1060,"props":25243,"children":25244},{"class":1062,"line":1158},[25245,25250,25254,25259,25264,25268,25273],{"type":49,"tag":1060,"props":25246,"children":25247},{"style":22635},[25248],{"type":55,"value":25249},"        FunctionName",{"type":49,"tag":1060,"props":25251,"children":25252},{"style":2194},[25253],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25255,"children":25256},{"style":1073},[25257],{"type":55,"value":25258},"os.environ.get(",{"type":49,"tag":1060,"props":25260,"children":25261},{"style":2215},[25262],{"type":55,"value":25263},"\"FUNCTION_NAME\"",{"type":49,"tag":1060,"props":25265,"children":25266},{"style":1073},[25267],{"type":55,"value":873},{"type":49,"tag":1060,"props":25269,"children":25270},{"style":2287},[25271],{"type":55,"value":25272},"None",{"type":49,"tag":1060,"props":25274,"children":25275},{"style":1073},[25276],{"type":55,"value":20221},{"type":49,"tag":1060,"props":25278,"children":25279},{"class":1062,"line":1171},[25280,25285,25289,25294],{"type":49,"tag":1060,"props":25281,"children":25282},{"style":22635},[25283],{"type":55,"value":25284},"        InvocationType",{"type":49,"tag":1060,"props":25286,"children":25287},{"style":2194},[25288],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25290,"children":25291},{"style":2215},[25292],{"type":55,"value":25293},"'RequestResponse'",{"type":49,"tag":1060,"props":25295,"children":25296},{"style":1073},[25297],{"type":55,"value":2497},{"type":49,"tag":1060,"props":25299,"children":25300},{"class":1062,"line":1180},[25301,25306,25310],{"type":49,"tag":1060,"props":25302,"children":25303},{"style":22635},[25304],{"type":55,"value":25305},"        Payload",{"type":49,"tag":1060,"props":25307,"children":25308},{"style":2194},[25309],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25311,"children":25312},{"style":1073},[25313],{"type":55,"value":25314},"json.dumps(event),\n",{"type":49,"tag":1060,"props":25316,"children":25317},{"class":1062,"line":1188},[25318],{"type":49,"tag":1060,"props":25319,"children":25320},{"style":1073},[25321],{"type":55,"value":25322},"    )\n",{"type":49,"tag":1060,"props":25324,"children":25325},{"class":1062,"line":1201},[25326],{"type":49,"tag":1060,"props":25327,"children":25328},{"emptyLinePlaceholder":44},[25329],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25331,"children":25332},{"class":1062,"line":1210},[25333,25338,25342,25347,25352],{"type":49,"tag":1060,"props":25334,"children":25335},{"style":1073},[25336],{"type":55,"value":25337},"    data ",{"type":49,"tag":1060,"props":25339,"children":25340},{"style":2194},[25341],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25343,"children":25344},{"style":1073},[25345],{"type":55,"value":25346}," invoke_response[",{"type":49,"tag":1060,"props":25348,"children":25349},{"style":2215},[25350],{"type":55,"value":25351},"'Payload'",{"type":49,"tag":1060,"props":25353,"children":25354},{"style":1073},[25355],{"type":55,"value":25356},"].read()\n",{"type":49,"tag":1060,"props":25358,"children":25359},{"class":1062,"line":1218},[25360],{"type":49,"tag":1060,"props":25361,"children":25362},{"emptyLinePlaceholder":44},[25363],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25365,"children":25366},{"class":1062,"line":1232},[25367,25372],{"type":49,"tag":1060,"props":25368,"children":25369},{"style":2194},[25370],{"type":55,"value":25371},"    return",{"type":49,"tag":1060,"props":25373,"children":25374},{"style":1073},[25375],{"type":55,"value":25376}," data\n",{"type":49,"tag":58,"props":25378,"children":25379},{},[25380],{"type":55,"value":25381},"There are just a few things to setup in our CDK code to make the proxy pattern work:",{"type":49,"tag":8994,"props":25383,"children":25384},{},[25385,25390,25395],{"type":49,"tag":68,"props":25386,"children":25387},{},[25388],{"type":55,"value":25389},"Define the Lambda function",{"type":49,"tag":68,"props":25391,"children":25392},{},[25393],{"type":55,"value":25394},"Give the proxy Lambda permission to invoke the Django Lambda",{"type":49,"tag":68,"props":25396,"children":25397},{},[25398,25400,25406,25408],{"type":55,"value":25399},"Define a ",{"type":49,"tag":326,"props":25401,"children":25403},{"className":25402},[],[25404],{"type":55,"value":25405},"LambdaRestApi",{"type":55,"value":25407}," construct with the Proxy Lambda as the ",{"type":49,"tag":326,"props":25409,"children":25411},{"className":25410},[],[25412],{"type":55,"value":22167},{"type":49,"tag":58,"props":25414,"children":25415},{},[25416],{"type":55,"value":25417},"Here's what that code looks like:",{"type":49,"tag":1050,"props":25419,"children":25421},{"code":25420,"language":19933,"meta":8,"className":19934,"style":8},"        self.proxy_lambda = _lambda.Function(\n            self,\n            \"ProxyLambda\",\n            code=_lambda.AssetCode(\"./awslambda\"),\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            layers=[self.djambda_layer],\n            handler=\"proxy_lambda.handler\",\n            timeout=core.Duration.seconds(60),\n            environment={\"FUNCTION_NAME\": self.djambda_lambda.function_name},\n        )\n\n        self.djambda_lambda.grant_invoke(self.proxy_lambda)\n\n        self.apigw = apigw.LambdaRestApi(\n            self, 'DjambdaEndpoint', handler=self.proxy_lambda,\n        )\n",[25422],{"type":49,"tag":326,"props":25423,"children":25424},{"__ignoreMap":8},[25425,25445,25456,25468,25492,25515,25538,25558,25581,25613,25620,25627,25648,25655,25676,25713],{"type":49,"tag":1060,"props":25426,"children":25427},{"class":1062,"line":1063},[25428,25432,25437,25441],{"type":49,"tag":1060,"props":25429,"children":25430},{"style":3797},[25431],{"type":55,"value":22915},{"type":49,"tag":1060,"props":25433,"children":25434},{"style":1073},[25435],{"type":55,"value":25436},".proxy_lambda ",{"type":49,"tag":1060,"props":25438,"children":25439},{"style":2194},[25440],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25442,"children":25443},{"style":1073},[25444],{"type":55,"value":23237},{"type":49,"tag":1060,"props":25446,"children":25447},{"class":1062,"line":1079},[25448,25452],{"type":49,"tag":1060,"props":25449,"children":25450},{"style":3797},[25451],{"type":55,"value":22937},{"type":49,"tag":1060,"props":25453,"children":25454},{"style":1073},[25455],{"type":55,"value":2497},{"type":49,"tag":1060,"props":25457,"children":25458},{"class":1062,"line":1088},[25459,25464],{"type":49,"tag":1060,"props":25460,"children":25461},{"style":2215},[25462],{"type":55,"value":25463},"            \"ProxyLambda\"",{"type":49,"tag":1060,"props":25465,"children":25466},{"style":1073},[25467],{"type":55,"value":2497},{"type":49,"tag":1060,"props":25469,"children":25470},{"class":1062,"line":1097},[25471,25475,25479,25483,25488],{"type":49,"tag":1060,"props":25472,"children":25473},{"style":22635},[25474],{"type":55,"value":23294},{"type":49,"tag":1060,"props":25476,"children":25477},{"style":2194},[25478],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25480,"children":25481},{"style":1073},[25482],{"type":55,"value":23303},{"type":49,"tag":1060,"props":25484,"children":25485},{"style":2215},[25486],{"type":55,"value":25487},"\"./awslambda\"",{"type":49,"tag":1060,"props":25489,"children":25490},{"style":1073},[25491],{"type":55,"value":20221},{"type":49,"tag":1060,"props":25493,"children":25494},{"class":1062,"line":1111},[25495,25499,25503,25507,25511],{"type":49,"tag":1060,"props":25496,"children":25497},{"style":22635},[25498],{"type":55,"value":23268},{"type":49,"tag":1060,"props":25500,"children":25501},{"style":2194},[25502],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25504,"children":25505},{"style":1073},[25506],{"type":55,"value":23277},{"type":49,"tag":1060,"props":25508,"children":25509},{"style":2287},[25510],{"type":55,"value":23282},{"type":49,"tag":1060,"props":25512,"children":25513},{"style":1073},[25514],{"type":55,"value":2497},{"type":49,"tag":1060,"props":25516,"children":25517},{"class":1062,"line":1120},[25518,25522,25526,25530,25534],{"type":49,"tag":1060,"props":25519,"children":25520},{"style":22635},[25521],{"type":55,"value":23385},{"type":49,"tag":1060,"props":25523,"children":25524},{"style":2194},[25525],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25527,"children":25528},{"style":1073},[25529],{"type":55,"value":23394},{"type":49,"tag":1060,"props":25531,"children":25532},{"style":3797},[25533],{"type":55,"value":22963},{"type":49,"tag":1060,"props":25535,"children":25536},{"style":1073},[25537],{"type":55,"value":23403},{"type":49,"tag":1060,"props":25539,"children":25540},{"class":1062,"line":1128},[25541,25545,25549,25554],{"type":49,"tag":1060,"props":25542,"children":25543},{"style":22635},[25544],{"type":55,"value":23364},{"type":49,"tag":1060,"props":25546,"children":25547},{"style":2194},[25548],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25550,"children":25551},{"style":2215},[25552],{"type":55,"value":25553},"\"proxy_lambda.handler\"",{"type":49,"tag":1060,"props":25555,"children":25556},{"style":1073},[25557],{"type":55,"value":2497},{"type":49,"tag":1060,"props":25559,"children":25560},{"class":1062,"line":1141},[25561,25565,25569,25573,25577],{"type":49,"tag":1060,"props":25562,"children":25563},{"style":22635},[25564],{"type":55,"value":23411},{"type":49,"tag":1060,"props":25566,"children":25567},{"style":2194},[25568],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25570,"children":25571},{"style":1073},[25572],{"type":55,"value":23420},{"type":49,"tag":1060,"props":25574,"children":25575},{"style":2287},[25576],{"type":55,"value":23425},{"type":49,"tag":1060,"props":25578,"children":25579},{"style":1073},[25580],{"type":55,"value":20221},{"type":49,"tag":1060,"props":25582,"children":25583},{"class":1062,"line":1150},[25584,25588,25592,25596,25600,25604,25608],{"type":49,"tag":1060,"props":25585,"children":25586},{"style":22635},[25587],{"type":55,"value":23493},{"type":49,"tag":1060,"props":25589,"children":25590},{"style":2194},[25591],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25593,"children":25594},{"style":1073},[25595],{"type":55,"value":23338},{"type":49,"tag":1060,"props":25597,"children":25598},{"style":2215},[25599],{"type":55,"value":25263},{"type":49,"tag":1060,"props":25601,"children":25602},{"style":1073},[25603],{"type":55,"value":78},{"type":49,"tag":1060,"props":25605,"children":25606},{"style":3797},[25607],{"type":55,"value":22963},{"type":49,"tag":1060,"props":25609,"children":25610},{"style":1073},[25611],{"type":55,"value":25612},".djambda_lambda.function_name},\n",{"type":49,"tag":1060,"props":25614,"children":25615},{"class":1062,"line":1158},[25616],{"type":49,"tag":1060,"props":25617,"children":25618},{"style":1073},[25619],{"type":55,"value":22976},{"type":49,"tag":1060,"props":25621,"children":25622},{"class":1062,"line":1171},[25623],{"type":49,"tag":1060,"props":25624,"children":25625},{"emptyLinePlaceholder":44},[25626],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25628,"children":25629},{"class":1062,"line":1180},[25630,25634,25639,25643],{"type":49,"tag":1060,"props":25631,"children":25632},{"style":3797},[25633],{"type":55,"value":22915},{"type":49,"tag":1060,"props":25635,"children":25636},{"style":1073},[25637],{"type":55,"value":25638},".djambda_lambda.grant_invoke(",{"type":49,"tag":1060,"props":25640,"children":25641},{"style":3797},[25642],{"type":55,"value":22963},{"type":49,"tag":1060,"props":25644,"children":25645},{"style":1073},[25646],{"type":55,"value":25647},".proxy_lambda)\n",{"type":49,"tag":1060,"props":25649,"children":25650},{"class":1062,"line":1188},[25651],{"type":49,"tag":1060,"props":25652,"children":25653},{"emptyLinePlaceholder":44},[25654],{"type":55,"value":1094},{"type":49,"tag":1060,"props":25656,"children":25657},{"class":1062,"line":1201},[25658,25662,25667,25671],{"type":49,"tag":1060,"props":25659,"children":25660},{"style":3797},[25661],{"type":55,"value":22915},{"type":49,"tag":1060,"props":25663,"children":25664},{"style":1073},[25665],{"type":55,"value":25666},".apigw ",{"type":49,"tag":1060,"props":25668,"children":25669},{"style":2194},[25670],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25672,"children":25673},{"style":1073},[25674],{"type":55,"value":25675}," apigw.LambdaRestApi(\n",{"type":49,"tag":1060,"props":25677,"children":25678},{"class":1062,"line":1210},[25679,25683,25687,25692,25696,25700,25704,25708],{"type":49,"tag":1060,"props":25680,"children":25681},{"style":3797},[25682],{"type":55,"value":22937},{"type":49,"tag":1060,"props":25684,"children":25685},{"style":1073},[25686],{"type":55,"value":873},{"type":49,"tag":1060,"props":25688,"children":25689},{"style":2215},[25690],{"type":55,"value":25691},"'DjambdaEndpoint'",{"type":49,"tag":1060,"props":25693,"children":25694},{"style":1073},[25695],{"type":55,"value":873},{"type":49,"tag":1060,"props":25697,"children":25698},{"style":22635},[25699],{"type":55,"value":22167},{"type":49,"tag":1060,"props":25701,"children":25702},{"style":2194},[25703],{"type":55,"value":3068},{"type":49,"tag":1060,"props":25705,"children":25706},{"style":3797},[25707],{"type":55,"value":22963},{"type":49,"tag":1060,"props":25709,"children":25710},{"style":1073},[25711],{"type":55,"value":25712},".proxy_lambda,\n",{"type":49,"tag":1060,"props":25714,"children":25715},{"class":1062,"line":1218},[25716],{"type":49,"tag":1060,"props":25717,"children":25718},{"style":1073},[25719],{"type":55,"value":22976},{"type":49,"tag":58,"props":25721,"children":25722},{},[25723,25725,25731],{"type":55,"value":25724},"That's it! We can now access our Django project at the API Gateway ",{"type":49,"tag":326,"props":25726,"children":25728},{"className":25727},[],[25729],{"type":55,"value":25730},"execute-api",{"type":55,"value":25732}," endpoint. This is a special URL that has the format:",{"type":49,"tag":1050,"props":25734,"children":25736},{"code":25735},"https://abc123.execute-api.us-east-1.amazonaws.com/prod\n",[25737],{"type":49,"tag":326,"props":25738,"children":25739},{"__ignoreMap":8},[25740],{"type":55,"value":25735},{"type":49,"tag":64,"props":25742,"children":25743},{},[25744,25755,25767],{"type":49,"tag":68,"props":25745,"children":25746},{},[25747,25753],{"type":49,"tag":326,"props":25748,"children":25750},{"className":25749},[],[25751],{"type":55,"value":25752},"abc123",{"type":55,"value":25754}," is the id of the API Gateway that we created (you can find the value of this id in the API Gateway section of the AWS management console)]",{"type":49,"tag":68,"props":25756,"children":25757},{},[25758,25760,25765],{"type":55,"value":25759},"The region ",{"type":49,"tag":326,"props":25761,"children":25763},{"className":25762},[],[25764],{"type":55,"value":13111},{"type":55,"value":25766}," is the region where you deployed the API Gateway",{"type":49,"tag":68,"props":25768,"children":25769},{},[25770,25776],{"type":49,"tag":326,"props":25771,"children":25773},{"className":25772},[],[25774],{"type":55,"value":25775},"/prod",{"type":55,"value":25777}," is the stage name",{"type":49,"tag":58,"props":25779,"children":25780},{},[25781,25783,25788,25790,25795,25797,25802,25804,25810],{"type":55,"value":25782},"The stage name part is a little confusing for me. It is meant to be a URL suffix that indicates production, staging, etc., but I typically separate environments at the level of the CloudFormation stack, so all of my environments use the ",{"type":49,"tag":326,"props":25784,"children":25786},{"className":25785},[],[25787],{"type":55,"value":25775},{"type":55,"value":25789}," suffix. In order for Django to work properly, we need to tell it that our site will be served at this ",{"type":49,"tag":326,"props":25791,"children":25793},{"className":25792},[],[25794],{"type":55,"value":25775},{"type":55,"value":25796}," path (for example ",{"type":49,"tag":326,"props":25798,"children":25800},{"className":25799},[],[25801],{"type":55,"value":8640},{"type":55,"value":25803}," will now be served at ",{"type":49,"tag":326,"props":25805,"children":25807},{"className":25806},[],[25808],{"type":55,"value":25809},"/prod/admin",{"type":55,"value":25811},") by setting a special value in our settings module:",{"type":49,"tag":1050,"props":25813,"children":25815},{"code":25814,"language":19933,"meta":8,"className":19934,"style":8},"FORCE_SCRIPT_NAME = \"/prod\"\n",[25816],{"type":49,"tag":326,"props":25817,"children":25818},{"__ignoreMap":8},[25819],{"type":49,"tag":1060,"props":25820,"children":25821},{"class":1062,"line":1063},[25822,25827,25831],{"type":49,"tag":1060,"props":25823,"children":25824},{"style":2287},[25825],{"type":55,"value":25826},"FORCE_SCRIPT_NAME",{"type":49,"tag":1060,"props":25828,"children":25829},{"style":2194},[25830],{"type":55,"value":2197},{"type":49,"tag":1060,"props":25832,"children":25833},{"style":2215},[25834],{"type":55,"value":24959},{"type":49,"tag":58,"props":25836,"children":25837},{},[25838,25840,25846,25848,25853,25855,25860,25862,25867,25869,25875,25877,25882],{"type":55,"value":25839},"This will make dealing with URLs easier, mostly because we don't actually have to change anything in our ",{"type":49,"tag":326,"props":25841,"children":25843},{"className":25842},[],[25844],{"type":55,"value":25845},"urls.py",{"type":55,"value":25847},". I tried adding ",{"type":49,"tag":326,"props":25849,"children":25851},{"className":25850},[],[25852],{"type":55,"value":25775},{"type":55,"value":25854}," to my URL paths in ",{"type":49,"tag":326,"props":25856,"children":25858},{"className":25857},[],[25859],{"type":55,"value":25845},{"type":55,"value":25861},", but the Django admin doesn't work properly because going to ",{"type":49,"tag":326,"props":25863,"children":25865},{"className":25864},[],[25866],{"type":55,"value":25809},{"type":55,"value":25868}," will redirect you to ",{"type":49,"tag":326,"props":25870,"children":25872},{"className":25871},[],[25873],{"type":55,"value":25874},"/admin/login",{"type":55,"value":25876}," which will thrown an error with API Gateway since our application must be on the ",{"type":49,"tag":326,"props":25878,"children":25880},{"className":25879},[],[25881],{"type":55,"value":25775},{"type":55,"value":25883}," subpath.",{"type":49,"tag":50,"props":25885,"children":25887},{"id":25886},"setting-a-custom-url-for-api-gateway",[25888],{"type":55,"value":25889},"Setting a custom URL for API Gateway",{"type":49,"tag":58,"props":25891,"children":25892},{},[25893,25895,25901],{"type":55,"value":25894},"If you don't mind having a URL in the form of ",{"type":49,"tag":326,"props":25896,"children":25898},{"className":25897},[],[25899],{"type":55,"value":25900},"https://abc123.execute-api.us-east-1.amazonaws.com/prod",{"type":55,"value":25902},", then everything should be good to go. If you do want a custom URL for API Gateway, there are only two things you need to do:",{"type":49,"tag":8994,"props":25904,"children":25905},{},[25906,25911,25930,25935],{"type":49,"tag":68,"props":25907,"children":25908},{},[25909],{"type":55,"value":25910},"Get a domain and hosted zone set up in Route53 (this typically costs about $12/year)",{"type":49,"tag":68,"props":25912,"children":25913},{},[25914,25916,25921,25922,25928],{"type":55,"value":25915},"Add the ",{"type":49,"tag":326,"props":25917,"children":25919},{"className":25918},[],[25920],{"type":55,"value":13132},{"type":55,"value":6280},{"type":49,"tag":326,"props":25923,"children":25925},{"className":25924},[],[25926],{"type":55,"value":25927},"HOSTED_ZONE_ID",{"type":55,"value":25929}," to environment variables (see below for how to do this)",{"type":49,"tag":68,"props":25931,"children":25932},{},[25933],{"type":55,"value":25934},"Define an ACM certificate in our CDK code and",{"type":49,"tag":68,"props":25936,"children":25937},{},[25938,25939,25944,25946,25952],{"type":55,"value":13588},{"type":49,"tag":326,"props":25940,"children":25942},{"className":25941},[],[25943],{"type":55,"value":25405},{"type":55,"value":25945},"'s ",{"type":49,"tag":326,"props":25947,"children":25949},{"className":25948},[],[25950],{"type":55,"value":25951},"add_domain_name",{"type":55,"value":25953}," method to add the domain name and certificate to the API Gateway endpoint.",{"type":49,"tag":58,"props":25955,"children":25956},{},[25957,25959,25966,25968,25973],{"type":55,"value":25958},"Here's a ",{"type":49,"tag":80,"props":25960,"children":25963},{"href":25961,"rel":25962},"https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_apigateway/LambdaRestApi.html#aws_cdk.aws_apigateway.LambdaRestApi.add_domain_name",[84],[25964],{"type":55,"value":25965},"link to the CDK Python documentation",{"type":55,"value":25967}," on ",{"type":49,"tag":326,"props":25969,"children":25971},{"className":25970},[],[25972],{"type":55,"value":25951},{"type":55,"value":745},{"type":49,"tag":58,"props":25975,"children":25976},{},[25977,25979,25984],{"type":55,"value":25978},"When you configure a custom domain name, you don't need to set the ",{"type":49,"tag":326,"props":25980,"children":25982},{"className":25981},[],[25983],{"type":55,"value":25826},{"type":55,"value":25985}," setting in Django settings.",{"type":49,"tag":50,"props":25987,"children":25989},{"id":25988},"project-directory-structure",[25990],{"type":55,"value":25991},"Project directory structure",{"type":49,"tag":58,"props":25993,"children":25994},{},[25995,25997,26003],{"type":55,"value":25996},"Let's take a quick look at the structure of the project using ",{"type":49,"tag":326,"props":25998,"children":26000},{"className":25999},[],[26001],{"type":55,"value":26002},"tree",{"type":55,"value":6694},{"type":49,"tag":1050,"props":26005,"children":26007},{"code":26006},"tree -L 3 .\n.\nâââ awscdk\nâ   âââ app.py\nâ   âââ awscdk\nâ   â   âââ app_stack.py  \u003C----------------- CDK application overview\nâ   â   âââ backend_assets.py\nâ   â   âââ cert.py\nâ   â   âââ cloudfront.py\nâ   â   âââ hosted_zone.py\nâ   â   âââ __init__.py\nâ   â   âââ static_site_bucket.py\nâ   â   âââ vpc.py \u003C------------------------ VPC, Lambdas, API Gateway and more\nâ   âââ cdk.json                             defined here\nâ   âââ README.md\nâ   âââ requirements.txt\nâ   âââ setup.py\nâ   âââ source.bat\nâââ awslambda\nâ   âââ proxy_lambda.py \u003C------------------- Proxy Lambda\nâââ django\nâ   âââ core \u003C------------------------------ A sample Django app\nâ   â   âââ admin.py\nâ   â   âââ apps.py\nâ   â   âââ __init__.py\nâ   â   âââ migrations\nâ   â   âââ models.py\nâ   â   âââ tests.py\nâ   â   âââ urls.py\nâ   â   âââ views.py\nâ   âââ djambda\nâ   â   âââ asgi.py\nâ   â   âââ awsgi.py \u003C---------------------- Django Lambda handler\nâ   â   âââ __init__.py\nâ   â   âââ settings.py \u003C------------------- Django settings (RDS connections, S3 static/media)\nâ   â   âââ storage_backends.py\nâ   â   âââ urls.py\nâ   â   âââ wsgi.py\nâ   âââ manage.py\nâ   âââ requirements.txt\nâââ layers \u003C-------------------------------- Lambda Layers (python dependencies)\nâ   âââ django                               Note: This folder is not committed to git\nâ       âââ python\nâââ ARTICLE.md \u003C---------------------------- This article\nâââ gitlab-ci.yml\nâââ .variables \u003C---------------------------- Environment variables needed for deployment\nâââ README.md\n",[26008],{"type":49,"tag":326,"props":26009,"children":26010},{"__ignoreMap":8},[26011],{"type":55,"value":26006},{"type":49,"tag":58,"props":26013,"children":26014},{},[26015,26017,26023,26024,26030,26031,26036],{"type":55,"value":26016},"The three top level folders are ",{"type":49,"tag":326,"props":26018,"children":26020},{"className":26019},[],[26021],{"type":55,"value":26022},"awscdk",{"type":55,"value":873},{"type":49,"tag":326,"props":26025,"children":26027},{"className":26026},[],[26028],{"type":55,"value":26029},"awslambda",{"type":55,"value":715},{"type":49,"tag":326,"props":26032,"children":26034},{"className":26033},[],[26035],{"type":55,"value":14},{"type":55,"value":26037},". To deploy our CDK code, we run the following command from the root of the project:",{"type":49,"tag":1050,"props":26039,"children":26041},{"code":26040,"language":2728,"meta":8,"className":2729,"style":8},"cdk deploy --app awscdk/app.py\n",[26042],{"type":49,"tag":326,"props":26043,"children":26044},{"__ignoreMap":8},[26045],{"type":49,"tag":1060,"props":26046,"children":26047},{"class":1062,"line":1063},[26048,26052,26057,26062],{"type":49,"tag":1060,"props":26049,"children":26050},{"style":1067},[26051],{"type":55,"value":15},{"type":49,"tag":1060,"props":26053,"children":26054},{"style":2215},[26055],{"type":55,"value":26056}," deploy",{"type":49,"tag":1060,"props":26058,"children":26059},{"style":2287},[26060],{"type":55,"value":26061}," --app",{"type":49,"tag":1060,"props":26063,"children":26064},{"style":2215},[26065],{"type":55,"value":26066}," awscdk/app.py\n",{"type":49,"tag":58,"props":26068,"children":26069},{},[26070,26072,26078,26080,26086,26088,26094,26095,26100],{"type":55,"value":26071},"We can also run ",{"type":49,"tag":326,"props":26073,"children":26075},{"className":26074},[],[26076],{"type":55,"value":26077},"cdk synth --app awscdk/app.py",{"type":55,"value":26079}," to preview changes to our CDK code by reviewing the CloudFormation templates generated by ",{"type":49,"tag":326,"props":26081,"children":26083},{"className":26082},[],[26084],{"type":55,"value":26085},"cdk synth",{"type":55,"value":26087},". Running the ",{"type":49,"tag":326,"props":26089,"children":26091},{"className":26090},[],[26092],{"type":55,"value":26093},"cdk deploy",{"type":55,"value":715},{"type":49,"tag":326,"props":26096,"children":26098},{"className":26097},[],[26099],{"type":55,"value":26085},{"type":55,"value":26101}," commands at root of the project means that we need to specificy lambda code assets from the root of the project as well. This is why the Django application's Lambda function references the code with:",{"type":49,"tag":1050,"props":26103,"children":26105},{"code":26104,"language":19933,"meta":8,"className":19934,"style":8},"code=_lambda.AssetCode('./django'),\n",[26106],{"type":49,"tag":326,"props":26107,"children":26108},{"__ignoreMap":8},[26109],{"type":49,"tag":1060,"props":26110,"children":26111},{"class":1062,"line":1063},[26112,26116,26120,26124,26128],{"type":49,"tag":1060,"props":26113,"children":26114},{"style":1073},[26115],{"type":55,"value":326},{"type":49,"tag":1060,"props":26117,"children":26118},{"style":2194},[26119],{"type":55,"value":3068},{"type":49,"tag":1060,"props":26121,"children":26122},{"style":1073},[26123],{"type":55,"value":23303},{"type":49,"tag":1060,"props":26125,"children":26126},{"style":2215},[26127],{"type":55,"value":23308},{"type":49,"tag":1060,"props":26129,"children":26130},{"style":1073},[26131],{"type":55,"value":20221},{"type":49,"tag":50,"props":26133,"children":26135},{"id":26134},"deploying",[26136],{"type":55,"value":26137},"Deploying",{"type":49,"tag":58,"props":26139,"children":26140},{},[26141],{"type":55,"value":26142},"CDK is easy to use both locally and in a CI/CD tool such as GitLab CI, my CI/CD tool of choice. There are a few things to coordinate when deploying in both of these environments:",{"type":49,"tag":8994,"props":26144,"children":26145},{},[26146,26151],{"type":49,"tag":68,"props":26147,"children":26148},{},[26149],{"type":55,"value":26150},"Environment variables",{"type":49,"tag":68,"props":26152,"children":26153},{},[26154],{"type":55,"value":26155},"Dependencies",{"type":49,"tag":430,"props":26157,"children":26159},{"id":26158},"deploying-from-a-terminal",[26160],{"type":55,"value":26161},"Deploying from a terminal",{"type":49,"tag":58,"props":26163,"children":26164},{},[26165,26167,26173],{"type":55,"value":26166},"If you are new to CDK, you will need to make sure that you have ran the ",{"type":49,"tag":326,"props":26168,"children":26170},{"className":26169},[],[26171],{"type":55,"value":26172},"cdk bootstrap",{"type":55,"value":26174}," command at least once on your account. This command sets up a CloudFormation stack that CDK uses internally to manage deployments.",{"type":49,"tag":58,"props":26176,"children":26177},{},[26178,26180,26186],{"type":55,"value":26179},"The environment variables needed for deployment are defined in ",{"type":49,"tag":326,"props":26181,"children":26183},{"className":26182},[],[26184],{"type":55,"value":26185},".variables.template",{"type":55,"value":6694},{"type":49,"tag":1050,"props":26188,"children":26190},{"code":26189},"export APP_NAME=\nexport AWS_ACCESS_KEY_ID=\nexport AWS_ACCOUNT_ID=\nexport AWS_DEFAULT_REGION=\nexport AWS_SECRET_ACCESS_KEY=\nexport DOMAIN_NAME=\nexport HOSTED_ZONE_ID=\n",[26191],{"type":49,"tag":326,"props":26192,"children":26193},{"__ignoreMap":8},[26194],{"type":55,"value":26189},{"type":49,"tag":64,"props":26196,"children":26197},{},[26198,26224],{"type":49,"tag":68,"props":26199,"children":26200},{},[26201,26207,26209,26215,26217,26222],{"type":49,"tag":326,"props":26202,"children":26204},{"className":26203},[],[26205],{"type":55,"value":26206},"APP_NAME",{"type":55,"value":26208}," should be a URL compatible name, such as ",{"type":49,"tag":326,"props":26210,"children":26212},{"className":26211},[],[26213],{"type":55,"value":26214},"my-app",{"type":55,"value":26216}," (don't put ",{"type":49,"tag":326,"props":26218,"children":26220},{"className":26219},[],[26221],{"type":55,"value":745},{"type":55,"value":26223}," in this variable)",{"type":49,"tag":68,"props":26225,"children":26226},{},[26227,26232,26233,26238],{"type":49,"tag":326,"props":26228,"children":26230},{"className":26229},[],[26231],{"type":55,"value":13132},{"type":55,"value":715},{"type":49,"tag":326,"props":26234,"children":26236},{"className":26235},[],[26237],{"type":55,"value":25927},{"type":55,"value":26239}," are needed for adding a custom domain name to API Gateway",{"type":49,"tag":58,"props":26241,"children":26242},{},[26243,26245,26251],{"type":55,"value":26244},"Copy this template into a file in the root of the project called ",{"type":49,"tag":326,"props":26246,"children":26248},{"className":26247},[],[26249],{"type":55,"value":26250},".variables",{"type":55,"value":26252}," and set these environment variables with the following command:",{"type":49,"tag":1050,"props":26254,"children":26256},{"code":26255},". .variables\n",[26257],{"type":49,"tag":326,"props":26258,"children":26259},{"__ignoreMap":8},[26260],{"type":55,"value":26255},{"type":49,"tag":58,"props":26262,"children":26263},{},[26264,26266,26271],{"type":55,"value":26265},"Next, we need to install our Python dependencies locally with the ",{"type":49,"tag":326,"props":26267,"children":26269},{"className":26268},[],[26270],{"type":55,"value":18440},{"type":55,"value":26272}," target flag so that the Lambda layers we define in CDK can find the files needed to be packaged into our Lambda layer and made available to our Lambda function at runtime. Install dependencies to the target directory by running the following command from the root of the project:",{"type":49,"tag":1050,"props":26274,"children":26276},{"code":26275},"pip install -r django/requirements.txt -t layers/django/python\n",[26277],{"type":49,"tag":326,"props":26278,"children":26279},{"__ignoreMap":8},[26280],{"type":55,"value":26275},{"type":49,"tag":58,"props":26282,"children":26283},{},[26284],{"type":55,"value":26285},"Now we can deploy our serverless application to AWS using CDK. First, activate the CDK Python virtual environment with:",{"type":49,"tag":1050,"props":26287,"children":26289},{"code":26288},"source awscdk/.env/bin/activate\n",[26290],{"type":49,"tag":326,"props":26291,"children":26292},{"__ignoreMap":8},[26293],{"type":55,"value":26288},{"type":49,"tag":58,"props":26295,"children":26296},{},[26297,26299,26305],{"type":55,"value":26298},"Also make sure that you are using a version of Node.js greater or equal to 10. I do this with ",{"type":49,"tag":326,"props":26300,"children":26302},{"className":26301},[],[26303],{"type":55,"value":26304},"nvm use 13",{"type":55,"value":745},{"type":49,"tag":58,"props":26307,"children":26308},{},[26309,26311,26317],{"type":55,"value":26310},"Make sure that all of the dependencies defined in ",{"type":49,"tag":326,"props":26312,"children":26314},{"className":26313},[],[26315],{"type":55,"value":26316},"awscdk/setup.py",{"type":55,"value":26318}," are up-to-date. Make sure that there are no issues witht the CDK code by running:",{"type":49,"tag":1050,"props":26320,"children":26322},{"code":26321},"cdk synth --app awscdk/app.py\n",[26323],{"type":49,"tag":326,"props":26324,"children":26325},{"__ignoreMap":8},[26326],{"type":55,"value":26321},{"type":49,"tag":58,"props":26328,"children":26329},{},[26330,26332,26338],{"type":55,"value":26331},"Inspect the contents of ",{"type":49,"tag":326,"props":26333,"children":26335},{"className":26334},[],[26336],{"type":55,"value":26337},"cdk.out",{"type":55,"value":26339},"; these are the CloudFormation templates generated by CDK that will be used to deploy all of our resources. If everything looks good to go, deploy with the following command:",{"type":49,"tag":1050,"props":26341,"children":26342},{"code":26321},[26343],{"type":49,"tag":326,"props":26344,"children":26345},{"__ignoreMap":8},[26346],{"type":55,"value":26321},{"type":49,"tag":58,"props":26348,"children":26349},{},[26350],{"type":55,"value":26351},"Follow the output of this command and ensure that it completes successfully. You can also follow along in the CloudFormation section of the AWS management console to make sure that things are deploying properly.",{"type":49,"tag":58,"props":26353,"children":26354},{},[26355,26357,26362,26363,26368,26369,26374],{"type":55,"value":26356},"Once everything has finished deploying, you will need to run ",{"type":49,"tag":326,"props":26358,"children":26360},{"className":26359},[],[26361],{"type":55,"value":3323},{"type":55,"value":873},{"type":49,"tag":326,"props":26364,"children":26366},{"className":26365},[],[26367],{"type":55,"value":21930},{"type":55,"value":715},{"type":49,"tag":326,"props":26370,"children":26372},{"className":26371},[],[26373],{"type":55,"value":20867},{"type":55,"value":26375}," after the first deployment.",{"type":49,"tag":2910,"props":26377,"children":26378},{},[26379],{"type":49,"tag":58,"props":26380,"children":26381},{},[26382],{"type":55,"value":26383},"TODO: consolidate these steps with a Makefile or bash script",{"type":49,"tag":430,"props":26385,"children":26387},{"id":26386},"deploying-with-gitlab-ci",[26388],{"type":55,"value":26389},"Deploying with GitLab CI",{"type":49,"tag":58,"props":26391,"children":26392},{},[26393],{"type":55,"value":26394},"Deploying locally is fine, but it is better to run CDK commands from a CI/CD process so we can keep track of the commits, pipeline results, commit messages, etc. The process is very similar to everything we do locally, but you will need to add environment variables to the GitLab project's Settings > CI/CD > Variables. I have broken out dependency installation into a separate stage. This is not entirely necessary, but it helps keep things easy to follow:",{"type":49,"tag":1050,"props":26396,"children":26398},{"code":26397,"language":3823,"meta":8,"className":3824,"style":8},"pip_install:\n  stage: build\n  artifacts:\n    paths:\n      - layers/django/python\n  script:\n    - pip install -r django/requirements.txt -t layers/django/python\n\ncdk_deploy:\n  stage: deploy\n  before_script:\n    - apt-get -qq update && apt-get -y install nodejs npm\n    - npm i -g aws-cdk\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n",[26399],{"type":49,"tag":326,"props":26400,"children":26401},{"__ignoreMap":8},[26402,26414,26429,26441,26453,26465,26476,26487,26494,26506,26521,26532,26544,26556,26568,26579,26591],{"type":49,"tag":1060,"props":26403,"children":26404},{"class":1062,"line":1063},[26405,26410],{"type":49,"tag":1060,"props":26406,"children":26407},{"style":3839},[26408],{"type":55,"value":26409},"pip_install",{"type":49,"tag":1060,"props":26411,"children":26412},{"style":1073},[26413],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26415,"children":26416},{"class":1062,"line":1079},[26417,26421,26425],{"type":49,"tag":1060,"props":26418,"children":26419},{"style":3839},[26420],{"type":55,"value":18261},{"type":49,"tag":1060,"props":26422,"children":26423},{"style":1073},[26424],{"type":55,"value":78},{"type":49,"tag":1060,"props":26426,"children":26427},{"style":2215},[26428],{"type":55,"value":18270},{"type":49,"tag":1060,"props":26430,"children":26431},{"class":1062,"line":1088},[26432,26437],{"type":49,"tag":1060,"props":26433,"children":26434},{"style":3839},[26435],{"type":55,"value":26436},"  artifacts",{"type":49,"tag":1060,"props":26438,"children":26439},{"style":1073},[26440],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26442,"children":26443},{"class":1062,"line":1097},[26444,26449],{"type":49,"tag":1060,"props":26445,"children":26446},{"style":3839},[26447],{"type":55,"value":26448},"    paths",{"type":49,"tag":1060,"props":26450,"children":26451},{"style":1073},[26452],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26454,"children":26455},{"class":1062,"line":1111},[26456,26460],{"type":49,"tag":1060,"props":26457,"children":26458},{"style":1073},[26459],{"type":55,"value":3836},{"type":49,"tag":1060,"props":26461,"children":26462},{"style":2215},[26463],{"type":55,"value":26464},"layers/django/python\n",{"type":49,"tag":1060,"props":26466,"children":26467},{"class":1062,"line":1120},[26468,26472],{"type":49,"tag":1060,"props":26469,"children":26470},{"style":3839},[26471],{"type":55,"value":18343},{"type":49,"tag":1060,"props":26473,"children":26474},{"style":1073},[26475],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26477,"children":26478},{"class":1062,"line":1128},[26479,26483],{"type":49,"tag":1060,"props":26480,"children":26481},{"style":1073},[26482],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26484,"children":26485},{"style":2215},[26486],{"type":55,"value":26275},{"type":49,"tag":1060,"props":26488,"children":26489},{"class":1062,"line":1141},[26490],{"type":49,"tag":1060,"props":26491,"children":26492},{"emptyLinePlaceholder":44},[26493],{"type":55,"value":1094},{"type":49,"tag":1060,"props":26495,"children":26496},{"class":1062,"line":1150},[26497,26502],{"type":49,"tag":1060,"props":26498,"children":26499},{"style":3839},[26500],{"type":55,"value":26501},"cdk_deploy",{"type":49,"tag":1060,"props":26503,"children":26504},{"style":1073},[26505],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26507,"children":26508},{"class":1062,"line":1158},[26509,26513,26517],{"type":49,"tag":1060,"props":26510,"children":26511},{"style":3839},[26512],{"type":55,"value":18261},{"type":49,"tag":1060,"props":26514,"children":26515},{"style":1073},[26516],{"type":55,"value":78},{"type":49,"tag":1060,"props":26518,"children":26519},{"style":2215},[26520],{"type":55,"value":19149},{"type":49,"tag":1060,"props":26522,"children":26523},{"class":1062,"line":1171},[26524,26528],{"type":49,"tag":1060,"props":26525,"children":26526},{"style":3839},[26527],{"type":55,"value":18319},{"type":49,"tag":1060,"props":26529,"children":26530},{"style":1073},[26531],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26533,"children":26534},{"class":1062,"line":1180},[26535,26539],{"type":49,"tag":1060,"props":26536,"children":26537},{"style":1073},[26538],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26540,"children":26541},{"style":2215},[26542],{"type":55,"value":26543},"apt-get -qq update && apt-get -y install nodejs npm\n",{"type":49,"tag":1060,"props":26545,"children":26546},{"class":1062,"line":1188},[26547,26551],{"type":49,"tag":1060,"props":26548,"children":26549},{"style":1073},[26550],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26552,"children":26553},{"style":2215},[26554],{"type":55,"value":26555},"npm i -g aws-cdk\n",{"type":49,"tag":1060,"props":26557,"children":26558},{"class":1062,"line":1201},[26559,26563],{"type":49,"tag":1060,"props":26560,"children":26561},{"style":1073},[26562],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26564,"children":26565},{"style":2215},[26566],{"type":55,"value":26567},"pip3 install -e awscdk\n",{"type":49,"tag":1060,"props":26569,"children":26570},{"class":1062,"line":1210},[26571,26575],{"type":49,"tag":1060,"props":26572,"children":26573},{"style":3839},[26574],{"type":55,"value":18343},{"type":49,"tag":1060,"props":26576,"children":26577},{"style":1073},[26578],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26580,"children":26581},{"class":1062,"line":1218},[26582,26586],{"type":49,"tag":1060,"props":26583,"children":26584},{"style":1073},[26585],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26587,"children":26588},{"style":2215},[26589],{"type":55,"value":26590},"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n",{"type":49,"tag":1060,"props":26592,"children":26593},{"class":1062,"line":1232},[26594,26598],{"type":49,"tag":1060,"props":26595,"children":26596},{"style":1073},[26597],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26599,"children":26600},{"style":2215},[26601],{"type":55,"value":26602},"cdk deploy --app awscdk/app.py --require-approval never\n",{"type":49,"tag":58,"props":26604,"children":26605},{},[26606,26608,26614],{"type":55,"value":26607},"For management commands, we use a ",{"type":49,"tag":326,"props":26609,"children":26611},{"className":26610},[],[26612],{"type":55,"value":26613},".base_task",{"type":55,"value":26615}," template and reuse this for each command:",{"type":49,"tag":1050,"props":26617,"children":26619},{"code":26618,"language":3823,"meta":8,"className":3824,"style":8},".base_task: &task\n  image: python:3.8\n  stage: deploy\n  rules:\n    - when: manual\n  before_script:\n    - pip install awscli\n  after_script:\n    - cat invoke_response.json\n\nmigrate:\n  \u003C\u003C: *task\n  script:\n    - |\n      aws lambda invoke \\\n        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n        --payload '{\"manage\": \"migrate --no-input\"}' \\\n        invoke_response.json\n",[26620],{"type":49,"tag":326,"props":26621,"children":26622},{"__ignoreMap":8},[26623,26644,26660,26675,26687,26708,26719,26731,26743,26755,26762,26773,26793,26804,26815,26823,26831,26839],{"type":49,"tag":1060,"props":26624,"children":26625},{"class":1062,"line":1063},[26626,26630,26634,26639],{"type":49,"tag":1060,"props":26627,"children":26628},{"style":3839},[26629],{"type":55,"value":26613},{"type":49,"tag":1060,"props":26631,"children":26632},{"style":1073},[26633],{"type":55,"value":78},{"type":49,"tag":1060,"props":26635,"children":26636},{"style":2194},[26637],{"type":55,"value":26638},"&",{"type":49,"tag":1060,"props":26640,"children":26641},{"style":3992},[26642],{"type":55,"value":26643},"task\n",{"type":49,"tag":1060,"props":26645,"children":26646},{"class":1062,"line":1079},[26647,26651,26655],{"type":49,"tag":1060,"props":26648,"children":26649},{"style":3839},[26650],{"type":55,"value":18278},{"type":49,"tag":1060,"props":26652,"children":26653},{"style":1073},[26654],{"type":55,"value":78},{"type":49,"tag":1060,"props":26656,"children":26657},{"style":2215},[26658],{"type":55,"value":26659},"python:3.8\n",{"type":49,"tag":1060,"props":26661,"children":26662},{"class":1062,"line":1088},[26663,26667,26671],{"type":49,"tag":1060,"props":26664,"children":26665},{"style":3839},[26666],{"type":55,"value":18261},{"type":49,"tag":1060,"props":26668,"children":26669},{"style":1073},[26670],{"type":55,"value":78},{"type":49,"tag":1060,"props":26672,"children":26673},{"style":2215},[26674],{"type":55,"value":19149},{"type":49,"tag":1060,"props":26676,"children":26677},{"class":1062,"line":1097},[26678,26683],{"type":49,"tag":1060,"props":26679,"children":26680},{"style":3839},[26681],{"type":55,"value":26682},"  rules",{"type":49,"tag":1060,"props":26684,"children":26685},{"style":1073},[26686],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26688,"children":26689},{"class":1062,"line":1111},[26690,26694,26699,26703],{"type":49,"tag":1060,"props":26691,"children":26692},{"style":1073},[26693],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26695,"children":26696},{"style":3839},[26697],{"type":55,"value":26698},"when",{"type":49,"tag":1060,"props":26700,"children":26701},{"style":1073},[26702],{"type":55,"value":78},{"type":49,"tag":1060,"props":26704,"children":26705},{"style":2215},[26706],{"type":55,"value":26707},"manual\n",{"type":49,"tag":1060,"props":26709,"children":26710},{"class":1062,"line":1120},[26711,26715],{"type":49,"tag":1060,"props":26712,"children":26713},{"style":3839},[26714],{"type":55,"value":18319},{"type":49,"tag":1060,"props":26716,"children":26717},{"style":1073},[26718],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26720,"children":26721},{"class":1062,"line":1128},[26722,26726],{"type":49,"tag":1060,"props":26723,"children":26724},{"style":1073},[26725],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26727,"children":26728},{"style":2215},[26729],{"type":55,"value":26730},"pip install awscli\n",{"type":49,"tag":1060,"props":26732,"children":26733},{"class":1062,"line":1141},[26734,26739],{"type":49,"tag":1060,"props":26735,"children":26736},{"style":3839},[26737],{"type":55,"value":26738},"  after_script",{"type":49,"tag":1060,"props":26740,"children":26741},{"style":1073},[26742],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26744,"children":26745},{"class":1062,"line":1150},[26746,26750],{"type":49,"tag":1060,"props":26747,"children":26748},{"style":1073},[26749],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26751,"children":26752},{"style":2215},[26753],{"type":55,"value":26754},"cat invoke_response.json\n",{"type":49,"tag":1060,"props":26756,"children":26757},{"class":1062,"line":1158},[26758],{"type":49,"tag":1060,"props":26759,"children":26760},{"emptyLinePlaceholder":44},[26761],{"type":55,"value":1094},{"type":49,"tag":1060,"props":26763,"children":26764},{"class":1062,"line":1171},[26765,26769],{"type":49,"tag":1060,"props":26766,"children":26767},{"style":3839},[26768],{"type":55,"value":3323},{"type":49,"tag":1060,"props":26770,"children":26771},{"style":1073},[26772],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26774,"children":26775},{"class":1062,"line":1180},[26776,26781,26785,26789],{"type":49,"tag":1060,"props":26777,"children":26778},{"style":2287},[26779],{"type":55,"value":26780},"  \u003C\u003C",{"type":49,"tag":1060,"props":26782,"children":26783},{"style":1073},[26784],{"type":55,"value":78},{"type":49,"tag":1060,"props":26786,"children":26787},{"style":2194},[26788],{"type":55,"value":22608},{"type":49,"tag":1060,"props":26790,"children":26791},{"style":1073},[26792],{"type":55,"value":26643},{"type":49,"tag":1060,"props":26794,"children":26795},{"class":1062,"line":1188},[26796,26800],{"type":49,"tag":1060,"props":26797,"children":26798},{"style":3839},[26799],{"type":55,"value":18343},{"type":49,"tag":1060,"props":26801,"children":26802},{"style":1073},[26803],{"type":55,"value":6862},{"type":49,"tag":1060,"props":26805,"children":26806},{"class":1062,"line":1201},[26807,26811],{"type":49,"tag":1060,"props":26808,"children":26809},{"style":1073},[26810],{"type":55,"value":6899},{"type":49,"tag":1060,"props":26812,"children":26813},{"style":2194},[26814],{"type":55,"value":3884},{"type":49,"tag":1060,"props":26816,"children":26817},{"class":1062,"line":1210},[26818],{"type":49,"tag":1060,"props":26819,"children":26820},{"style":2215},[26821],{"type":55,"value":26822},"      aws lambda invoke \\\n",{"type":49,"tag":1060,"props":26824,"children":26825},{"class":1062,"line":1218},[26826],{"type":49,"tag":1060,"props":26827,"children":26828},{"style":2215},[26829],{"type":55,"value":26830},"        --function-name ${ENVIRONMENT}-${APP_NAME}-djambda-lambda \\\n",{"type":49,"tag":1060,"props":26832,"children":26833},{"class":1062,"line":1232},[26834],{"type":49,"tag":1060,"props":26835,"children":26836},{"style":2215},[26837],{"type":55,"value":26838},"        --payload '{\"manage\": \"migrate --no-input\"}' \\\n",{"type":49,"tag":1060,"props":26840,"children":26841},{"class":1062,"line":1241},[26842],{"type":49,"tag":1060,"props":26843,"children":26844},{"style":2215},[26845],{"type":55,"value":26846},"        invoke_response.json\n",{"type":49,"tag":58,"props":26848,"children":26849},{},[26850,26852,26858],{"type":55,"value":26851},"These are ",{"type":49,"tag":326,"props":26853,"children":26855},{"className":26854},[],[26856],{"type":55,"value":26857},"manual",{"type":55,"value":26859}," commands, and can be started through the GitLab CI interface by pressing the \"Play\" button on the pipeline.",{"type":49,"tag":50,"props":26861,"children":26862},{"id":15955},[26863],{"type":55,"value":15958},{"type":49,"tag":58,"props":26865,"children":26866},{},[26867],{"type":55,"value":26868},"I still have lots of ideas and things to try out with this Django/Lambda architecture. Here are a few things that would be good to try:",{"type":49,"tag":64,"props":26870,"children":26871},{},[26872,26892,26905,26918,26939,26967],{"type":49,"tag":68,"props":26873,"children":26874},{},[26875,26877,26883,26884,26890],{"type":55,"value":26876},"Using another Lambda function that proxies web requests to a Lambda outside of the VPC for basic network requests using either ",{"type":49,"tag":326,"props":26878,"children":26880},{"className":26879},[],[26881],{"type":55,"value":26882},"urllib.request",{"type":55,"value":8634},{"type":49,"tag":326,"props":26885,"children":26887},{"className":26886},[],[26888],{"type":55,"value":26889},"requests",{"type":55,"value":26891},". This would be the easiest way to add simple internet access without needing a NAT Gateway",{"type":49,"tag":68,"props":26893,"children":26894},{},[26895,26897,26903],{"type":55,"value":26896},"Use a NAT provider to add a cheap NAT instance using a ",{"type":49,"tag":326,"props":26898,"children":26900},{"className":26899},[],[26901],{"type":55,"value":26902},"t3a.nano",{"type":55,"value":26904}," instance ( about $5.00/month) to allow for internet access in the Django request/response cycle",{"type":49,"tag":68,"props":26906,"children":26907},{},[26908,26910,26916],{"type":55,"value":26909},"Figure out a good solution for async processing. Zappa has a ",{"type":49,"tag":326,"props":26911,"children":26913},{"className":26912},[],[26914],{"type":55,"value":26915},"@task",{"type":55,"value":26917}," wrapper that allows you to run tasks asynchronously in separate Lambda functions. It would be interesting to experiment with direct invocation of async tasks as well as task queueing with SQS. Using SQS would involve a VPC Endpoint which does cost extra, or we could setup a dedicated SQS proxy function to do this in a way similar to how we would handle requests.",{"type":49,"tag":68,"props":26919,"children":26920},{},[26921,26923,26928,26930,26937],{"type":55,"value":26922},"Lambda tuning. I'm pretty new to using Lambda and I would like to better understand how to fine-tune Lambda settings. There are lots of options in the ",{"type":49,"tag":326,"props":26924,"children":26926},{"className":26925},[],[26927],{"type":55,"value":23701},{"type":55,"value":26929}," construct, which would be a good place to start. This would be especially important for async tasks that require high memeory. From the ",{"type":49,"tag":80,"props":26931,"children":26934},{"href":26932,"rel":26933},"https://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf",[84],[26935],{"type":55,"value":26936},"Lambda Developer Guide",{"type":55,"value":26938}," it looks like memory can be configured from 128 MB to 3,008 MB in 64 MB increments.",{"type":49,"tag":68,"props":26940,"children":26941},{},[26942,26944,26949,26951,26957,26959,26965],{"type":55,"value":26943},"I typically setup Vue.js frontends with S3/CloudFront and use Django only for the admin and API with Django REST Framework. From what I understand, API Gateway uses CloudFront in the backround to do custom domains, but you don't have access to this CloudFront distribution. You can add the ",{"type":49,"tag":326,"props":26945,"children":26947},{"className":26946},[],[26948],{"type":55,"value":25730},{"type":55,"value":26950}," URL as a Custom Origin for a single CloudFront distribution, or keep a CloudFront distribution separate from the API Gateway custom domain and serve these on different subdomains, such as ",{"type":49,"tag":326,"props":26952,"children":26954},{"className":26953},[],[26955],{"type":55,"value":26956},"api.mysite.com",{"type":55,"value":26958}," for the API Gateway domain name and ",{"type":49,"tag":326,"props":26960,"children":26962},{"className":26961},[],[26963],{"type":55,"value":26964},"mysite.com",{"type":55,"value":26966}," for the CloudFront distribution serving Vue.js files.",{"type":49,"tag":68,"props":26968,"children":26969},{},[26970,26972],{"type":55,"value":26971},"Pricing. I'm still unsure about exactly how much this setup costs. The only major costs should be Aurora Postgres Serverless if it is used heavily, but I'm still not sure about how the pricing for this service works. Here's an in-depth article from Jeremy Daly that has more information on Aurora Serverless: ",{"type":49,"tag":80,"props":26973,"children":26976},{"href":26974,"rel":26975},"https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/",[84],[26977],{"type":55,"value":26974},{"type":49,"tag":58,"props":26979,"children":26980},{},[26981],{"type":55,"value":26982},"Thanks for reading!",{"type":49,"tag":7749,"props":26984,"children":26985},{},[26986],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":26988},[26989,26990,26991,26992,26993,26994,26995,26996,26997,27001],{"id":52,"depth":1079,"text":56},{"id":22073,"depth":1079,"text":22076},{"id":22128,"depth":1079,"text":22131},{"id":1929,"depth":1079,"text":2027},{"id":24120,"depth":1079,"text":2012},{"id":25046,"depth":1079,"text":25049},{"id":25886,"depth":1079,"text":25889},{"id":25988,"depth":1079,"text":25991},{"id":26134,"depth":1079,"text":26137,"children":26998},[26999,27000],{"id":26158,"depth":1088,"text":26161},{"id":26386,"depth":1088,"text":26389},{"id":15955,"depth":1079,"text":15958},"content:2020:08:01:django-and-lambda-with-cdk-and-api-gateway.md","2020/08/01/django-and-lambda-with-cdk-and-api-gateway.md","2020/08/01/django-and-lambda-with-cdk-and-api-gateway",{"_path":27006,"_dir":14031,"_draft":7,"_partial":7,"_locale":8,"title":27007,"description":8,"layout":16873,"date":27008,"comments":44,"image":27009,"tags":27010,"body":27011,"_type":7809,"_id":32584,"_source":7811,"_file":32585,"_stem":32586,"_extension":7814},"/2020/06/02/django-postgres-vue-gitlab-ecs","Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications","2020-06-02T00:00:00.000Z","/static/architecture_verbose_equals_true.png",[22,14,16648,13929,15],{"type":46,"children":27012,"toc":32545},[27013,27035,27041,27054,27095,27100,27106,27111,27182,27188,27194,27198,27212,27217,27222,27227,27232,27237,27242,27247,27252,27257,27262,27267,27272,27277,27282,27287,27292,27297,27302,27307,27312,27317,27322,27327,27332,27337,27342,27347,27352,27357,27362,27367,27371,27409,27415,27456,27460,27483,27490,27556,27562,27636,27642,27679,27685,27700,27705,27711,27786,27792,27860,27872,27878,27883,27889,27909,27915,27920,27943,27949,27968,27973,28020,28026,28039,28067,28099,28105,28110,28122,28127,28133,28151,28171,28319,28330,29047,29059,29131,29143,29226,29234,29260,29271,29305,29327,29346,29575,29602,29708,29716,29726,29736,29742,29753,29890,29926,29969,29989,29995,30015,30098,30138,30157,30168,30180,30189,30207,30216,30228,30237,30277,30286,30319,30328,30333,30342,30347,30356,30369,30382,30417,30437,30447,30459,30467,30472,30480,30520,30529,30534,30555,30565,30577,30586,30591,30600,30613,30679,30688,30699,30708,30713,30740,30749,30754,30763,30786,30808,30813,30819,30832,30865,30870,30876,30881,30887,30892,30912,30917,30935,30941,30946,30952,30957,30980,31012,31017,31029,31042,31047,31085,31090,31095,31107,31112,31132,31137,31222,31227,31556,31584,31589,31968,31973,32467,32473,32506,32511,32541],{"type":49,"tag":2910,"props":27014,"children":27015},{},[27016],{"type":49,"tag":58,"props":27017,"children":27018},{},[27019,27021,27027,27029],{"type":55,"value":27020},"This article was originally posted on ",{"type":49,"tag":80,"props":27022,"children":27025},{"href":27023,"rel":27024},"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i",[84],[27026],{"type":55,"value":27023},{"type":55,"value":27028},". It is also available on the documentation site for the project: ",{"type":49,"tag":80,"props":27030,"children":27033},{"href":27031,"rel":27032},"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/",[84],[27034],{"type":55,"value":27031},{"type":49,"tag":1757,"props":27036,"children":27038},{"id":27037},"project-overview",[27039],{"type":55,"value":27040},"Project Overview",{"type":49,"tag":58,"props":27042,"children":27043},{},[27044,27046,27052],{"type":55,"value":27045},"This is an overview of a Proof-of-Concept web application I'm working on called ",{"type":49,"tag":326,"props":27047,"children":27049},{"className":27048},[],[27050],{"type":55,"value":27051},"django-postgres-vue-gitlab-ecs",{"type":55,"value":27053},". This project aims to demonstrate the development and deployment of a web application using some of my favorite tools, languages and frameworks including:",{"type":49,"tag":64,"props":27055,"children":27056},{},[27057,27062,27067,27072,27077,27082,27086],{"type":49,"tag":68,"props":27058,"children":27059},{},[27060],{"type":55,"value":27061},"Python",{"type":49,"tag":68,"props":27063,"children":27064},{},[27065],{"type":55,"value":27066},"Django",{"type":49,"tag":68,"props":27068,"children":27069},{},[27070],{"type":55,"value":27071},"JavaScript",{"type":49,"tag":68,"props":27073,"children":27074},{},[27075],{"type":55,"value":27076},"Vue.js/Quasar Framework",{"type":49,"tag":68,"props":27078,"children":27079},{},[27080],{"type":55,"value":27081},"GitLab",{"type":49,"tag":68,"props":27083,"children":27084},{},[27085],{"type":55,"value":22391},{"type":49,"tag":68,"props":27087,"children":27088},{},[27089,27091],{"type":55,"value":27090},"and last but not least, ",{"type":49,"tag":72,"props":27092,"children":27093},{},[27094],{"type":55,"value":17627},{"type":49,"tag":58,"props":27096,"children":27097},{},[27098],{"type":55,"value":27099},"This README will start by describing some features of the application I'm building and how the different technologies are used together. I also share my experience in adopting CDK for managing cloud infrastructure on AWS. Finally, I discuss my solution to a specific question I have been trying to answer: what's the best way to scale Celery workers to zero to reduce Total Cost of Ownership?",{"type":49,"tag":50,"props":27101,"children":27103},{"id":27102},"development-philosophies-and-best-practices",[27104],{"type":55,"value":27105},"Development Philosophies and Best Practices",{"type":49,"tag":58,"props":27107,"children":27108},{},[27109],{"type":55,"value":27110},"Here are some of the best practices that this project aims to use:",{"type":49,"tag":64,"props":27112,"children":27113},{},[27114,27119,27123,27128,27133,27138,27143,27155,27160,27165,27170],{"type":49,"tag":68,"props":27115,"children":27116},{},[27117],{"type":55,"value":27118},"Open-source, MIT-Licensed",{"type":49,"tag":68,"props":27120,"children":27121},{},[27122],{"type":55,"value":406},{"type":49,"tag":68,"props":27124,"children":27125},{},[27126],{"type":55,"value":27127},"Infrastructure as Code",{"type":49,"tag":68,"props":27129,"children":27130},{},[27131],{"type":55,"value":27132},"Containerization with Docker",{"type":49,"tag":68,"props":27134,"children":27135},{},[27136],{"type":55,"value":27137},"Testing",{"type":49,"tag":68,"props":27139,"children":27140},{},[27141],{"type":55,"value":27142},"GitOps",{"type":49,"tag":68,"props":27144,"children":27145},{},[27146,27148],{"type":55,"value":27147},"Serverless* ",{"type":49,"tag":72,"props":27149,"children":27150},{},[27151],{"type":49,"tag":1060,"props":27152,"children":27153},{},[27154],{"type":55,"value":8405},{"type":49,"tag":68,"props":27156,"children":27157},{},[27158],{"type":55,"value":27159},"Project documentation",{"type":49,"tag":68,"props":27161,"children":27162},{},[27163],{"type":55,"value":27164},"Cost containment and tracking",{"type":49,"tag":68,"props":27166,"children":27167},{},[27168],{"type":55,"value":27169},"KISS & DRY",{"type":49,"tag":68,"props":27171,"children":27172},{},[27173,27175,27180],{"type":55,"value":27174},"Initial AWS console interaction is strictly limited to what can ",{"type":49,"tag":126,"props":27176,"children":27177},{},[27178],{"type":55,"value":27179},"only",{"type":55,"value":27181}," be done through the AWS console, otherwise AWS CDK and AWS CLI (preferably in CI/CD pipelines) are the primary means of interacting with AWS resources and the AWS Console is treated as a \"read-only\" convenience.",{"type":49,"tag":50,"props":27183,"children":27185},{"id":27184},"topics",[27186],{"type":55,"value":27187},"Topics",{"type":49,"tag":58,"props":27189,"children":27190},{},[27191],{"type":49,"tag":1601,"props":27192,"children":27193},{"alt":8926,"src":27009},[],{"type":49,"tag":430,"props":27195,"children":27196},{"id":14123},[27197],{"type":55,"value":14126},{"type":49,"tag":2910,"props":27199,"children":27200},{},[27201],{"type":49,"tag":58,"props":27202,"children":27203},{},[27204,27206],{"type":55,"value":27205},"This diagram was created with draw.io. Here's the link to the a read-only version of the diagram on draw.io: ",{"type":49,"tag":80,"props":27207,"children":27210},{"href":27208,"rel":27209},"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing",[84],[27211],{"type":55,"value":27208},{"type":49,"tag":58,"props":27213,"children":27214},{},[27215],{"type":55,"value":27216},"1 - GitLab is used to host the source code, test the source code and deploy the application to AWS.",{"type":49,"tag":58,"props":27218,"children":27219},{},[27220],{"type":55,"value":27221},"2 - Unit testing (see .gitlab-ci.yml)",{"type":49,"tag":58,"props":27223,"children":27224},{},[27225],{"type":55,"value":27226},"2a - Pytest",{"type":49,"tag":58,"props":27228,"children":27229},{},[27230],{"type":55,"value":27231},"2b - Jest",{"type":49,"tag":58,"props":27233,"children":27234},{},[27235],{"type":55,"value":27236},"2c - Cypress",{"type":49,"tag":58,"props":27238,"children":27239},{},[27240],{"type":55,"value":27241},"3 - Deployment phase (see /gitlab-ci/aws/cdk.yml)",{"type":49,"tag":58,"props":27243,"children":27244},{},[27245],{"type":55,"value":27246},"3a - Quasar PWA assets are built if there are changes in the quasar directory",{"type":49,"tag":58,"props":27248,"children":27249},{},[27250],{"type":55,"value":27251},"3b - AWS Cloud Development Kit (CDK) defines all infrastructure in AWS (4a - 12)",{"type":49,"tag":58,"props":27253,"children":27254},{},[27255],{"type":55,"value":27256},"3c - AWS CLI is used to run Fargate tasks through manual GitLab CI jobs",{"type":49,"tag":58,"props":27258,"children":27259},{},[27260],{"type":55,"value":27261},"4 - CDK Assets (ECR and S3 buckets that CDK uses internally to manage build assets and artifacts)",{"type":49,"tag":58,"props":27263,"children":27264},{},[27265],{"type":55,"value":27266},"4a - Elastic Container Repository is used to manage the Django docker image used in various parts of the application",{"type":49,"tag":58,"props":27268,"children":27269},{},[27270],{"type":55,"value":27271},"4b - S3 bucket used to store files associated with CDK and CloudFormation",{"type":49,"tag":58,"props":27273,"children":27274},{},[27275],{"type":55,"value":27276},"5 - Route53 is used to route traffic to the CloudFront distribution",{"type":49,"tag":58,"props":27278,"children":27279},{},[27280],{"type":55,"value":27281},"6 - CloudFront distribution that serves as the \"front desk\" of the application. It routes requests to to the correct CloudFront Origin",{"type":49,"tag":58,"props":27283,"children":27284},{},[27285],{"type":55,"value":27286},"7 - CloudFront Origin Configurations",{"type":49,"tag":58,"props":27288,"children":27289},{},[27290],{"type":55,"value":27291},"7a - S3 bucket for Quasar PWA assets",{"type":49,"tag":58,"props":27293,"children":27294},{},[27295],{"type":55,"value":27296},"7b - Application Load Balancer for Django application (/api/, /admin/, /flower/, /ws/, /graphql/)",{"type":49,"tag":58,"props":27298,"children":27299},{},[27300],{"type":55,"value":27301},"7c - S3 bucket for Django assets (static files, public media and private media)",{"type":49,"tag":58,"props":27303,"children":27304},{},[27305],{"type":55,"value":27306},"8 - Web server and websocket servers",{"type":49,"tag":58,"props":27308,"children":27309},{},[27310],{"type":55,"value":27311},"8a - Fargate service running uvicorn process (REST, GraphQL, Django Channels)",{"type":49,"tag":58,"props":27313,"children":27314},{},[27315],{"type":55,"value":27316},"8b - Autoscaling Group for Fargate Service that serves Django API",{"type":49,"tag":58,"props":27318,"children":27319},{},[27320],{"type":55,"value":27321},"9 - Celery and celery worker autoscaling",{"type":49,"tag":58,"props":27323,"children":27324},{},[27325],{"type":55,"value":27326},"9a - Fargate service that is autoscaled between 0 and N Fargate tasks for a given celery queue",{"type":49,"tag":58,"props":27328,"children":27329},{},[27330],{"type":55,"value":27331},"9b - Scheduled Event that triggers a Lambda to make a request to Django backend which collects celery queue metrics and published\nmetrics to CloudWatch using boto3",{"type":49,"tag":58,"props":27333,"children":27334},{},[27335],{"type":55,"value":27336},"9c - Lambda event the makes a request to /api/celery-metrics/",{"type":49,"tag":58,"props":27338,"children":27339},{},[27340],{"type":55,"value":27341},"9d - CloudWatch alarm that is used to scale the Fargate service for a celery queue",{"type":49,"tag":58,"props":27343,"children":27344},{},[27345],{"type":55,"value":27346},"9e - Autoscaling group for celery Fargate service",{"type":49,"tag":58,"props":27348,"children":27349},{},[27350],{"type":55,"value":27351},"10 - Fargate tasks that run Django management commands such as migrate and collectstatic. These are triggered from manual GitLab CI\njobs using the AWS CLI (3c)",{"type":49,"tag":58,"props":27353,"children":27354},{},[27355],{"type":55,"value":27356},"11 - ElastiCache for Redis, used for Caching, Celery Broker, Channels Layer, etc.",{"type":49,"tag":58,"props":27358,"children":27359},{},[27360],{"type":55,"value":27361},"12 - Aurora Postgres Serverless",{"type":49,"tag":58,"props":27363,"children":27364},{},[27365],{"type":55,"value":27366},"Here's a list of some of the major topics covered:",{"type":49,"tag":430,"props":27368,"children":27369},{"id":6972},[27370],{"type":55,"value":6975},{"type":49,"tag":64,"props":27372,"children":27373},{},[27374,27384,27389,27394,27399,27404],{"type":49,"tag":68,"props":27375,"children":27376},{},[27377,27379],{"type":55,"value":27378},"Setting up a local development environment using docker with one easy command: ",{"type":49,"tag":326,"props":27380,"children":27382},{"className":27381},[],[27383],{"type":55,"value":16254},{"type":49,"tag":68,"props":27385,"children":27386},{},[27387],{"type":55,"value":27388},"Hot-reloading for all parts of the application in local development",{"type":49,"tag":68,"props":27390,"children":27391},{},[27392],{"type":55,"value":27393},"Structuring a Django application (apps, settings modules, environment variables)",{"type":49,"tag":68,"props":27395,"children":27396},{},[27397],{"type":55,"value":27398},"Automatic code formatting with black and prettier",{"type":49,"tag":68,"props":27400,"children":27401},{},[27402],{"type":55,"value":27403},"Monitoring services (flower, pgadmin4, redis-commander)",{"type":49,"tag":68,"props":27405,"children":27406},{},[27407],{"type":55,"value":27408},"VSCode settings and extensions",{"type":49,"tag":430,"props":27410,"children":27412},{"id":27411},"gitlab-ci",[27413],{"type":55,"value":27414},"GitLab CI",{"type":49,"tag":64,"props":27416,"children":27417},{},[27418,27423,27428,27433,27438,27451],{"type":49,"tag":68,"props":27419,"children":27420},{},[27421],{"type":55,"value":27422},"GitLab CI for running unit and integration tests",{"type":49,"tag":68,"props":27424,"children":27425},{},[27426],{"type":55,"value":27427},"GitLab CI configuration for deployment to multiple environments (dev, prod) using AWS CDK",{"type":49,"tag":68,"props":27429,"children":27430},{},[27431],{"type":55,"value":27432},"GitLab CI scheduled jobs for updating all project dependencies through automated merge requests with Renovate",{"type":49,"tag":68,"props":27434,"children":27435},{},[27436],{"type":55,"value":27437},"GitLab CI manual jobs for running admin and management commands (database migrations, collectstatic, etc.)",{"type":49,"tag":68,"props":27439,"children":27440},{},[27441,27443,27449],{"type":55,"value":27442},"How to deploy to multiple environments (master -> staging, tags -> prod pattern as well as optional ephemeral environments per commit) using the new GitLab CI ",{"type":49,"tag":326,"props":27444,"children":27446},{"className":27445},[],[27447],{"type":55,"value":27448},"rules",{"type":55,"value":27450}," syntax",{"type":49,"tag":68,"props":27452,"children":27453},{},[27454],{"type":55,"value":27455},"Recording Cypress test videos with GitLab CI artifacts for manual review",{"type":49,"tag":430,"props":27457,"children":27458},{"id":20},[27459],{"type":55,"value":22391},{"type":49,"tag":64,"props":27461,"children":27462},{},[27463,27468,27473,27478],{"type":49,"tag":68,"props":27464,"children":27465},{},[27466],{"type":55,"value":27467},"Initial account setup",{"type":49,"tag":68,"props":27469,"children":27470},{},[27471],{"type":55,"value":27472},"Generating keys used in GitLab CI for deployment",{"type":49,"tag":68,"props":27474,"children":27475},{},[27476],{"type":55,"value":27477},"Opting in to new ARN format for ECS services and tasks (used for resource tagging) and container insights",{"type":49,"tag":68,"props":27479,"children":27480},{},[27481],{"type":55,"value":27482},"AWS Cloud Development Kit (CDK) for Infrastructure as Code to manage all AWS resources with CloudFormation Stacks - Nested stacks for grouping related resources under parent tasks (one parent task represent on environment for the application, such as production)",{"type":49,"tag":27484,"props":27485,"children":27487},"h4",{"id":27486},"aws-resources",[27488],{"type":55,"value":27489},"AWS Resources",{"type":49,"tag":64,"props":27491,"children":27492},{},[27493,27498,27511,27516,27521,27526,27531,27536,27541,27546,27551],{"type":49,"tag":68,"props":27494,"children":27495},{},[27496],{"type":55,"value":27497},"Automated provisioning of Amazon Certificate Manager certificates for TLS (HTTPS)",{"type":49,"tag":68,"props":27499,"children":27500},{},[27501,27503,27510],{"type":55,"value":27502},"Multi-AZ VPC with security groups and NACLs (no NAT Gateways/NAT instances used* ",{"type":49,"tag":72,"props":27504,"children":27505},{},[27506],{"type":49,"tag":1060,"props":27507,"children":27508},{},[27509],{"type":55,"value":24195},{"type":55,"value":616},{"type":49,"tag":68,"props":27512,"children":27513},{},[27514],{"type":55,"value":27515},"S3 buckets for static site hosting and Django static and media assets",{"type":49,"tag":68,"props":27517,"children":27518},{},[27519],{"type":55,"value":27520},"CloudFront for serving Vue.js SPA (PWA) static assets, Django static/media files and proxy to Application Load Balancer which forwards to ECS",{"type":49,"tag":68,"props":27522,"children":27523},{},[27524],{"type":55,"value":27525},"Fargate for multiple Django processes: gunicorn for backend API, daphne for Django Channels, celery for asynchronous tasks and celery beat for scheduled tasks",{"type":49,"tag":68,"props":27527,"children":27528},{},[27529],{"type":55,"value":27530},"Autoscaling (between 0 and N Fargate tasks) for infrequent, compute/memory intensive and long-running celery tasks with custom CloudWatch metrics",{"type":49,"tag":68,"props":27532,"children":27533},{},[27534],{"type":55,"value":27535},"Hosted Redis with ElastiCache for celery broker, application caching, django-constance, etc.",{"type":49,"tag":68,"props":27537,"children":27538},{},[27539],{"type":55,"value":27540},"Aurora Postgres and Aurora Postgres Serverless for cost savings in staging environments",{"type":49,"tag":68,"props":27542,"children":27543},{},[27544],{"type":55,"value":27545},"CDK Assets for automating S3 asset deployment and automated container building during deployment with AWS CDK",{"type":49,"tag":68,"props":27547,"children":27548},{},[27549],{"type":55,"value":27550},"Thorough resource tagging by both application and environment (dev, prod, etc.) for comprehensive cost tracking",{"type":49,"tag":68,"props":27552,"children":27553},{},[27554],{"type":55,"value":27555},"Optional bastion host for SSH access to bring up a Django shell in a container running on a container instance (this requires an EC2 instance)",{"type":49,"tag":430,"props":27557,"children":27559},{"id":27558},"django-application",[27560],{"type":55,"value":27561},"Django Application",{"type":49,"tag":64,"props":27563,"children":27564},{},[27565,27570,27575,27580,27593,27598,27603,27616,27621,27626,27631],{"type":49,"tag":68,"props":27566,"children":27567},{},[27568],{"type":55,"value":27569},"Django REST Framework",{"type":49,"tag":68,"props":27571,"children":27572},{},[27573],{"type":55,"value":27574},"JWT-based authentication with django-rest-framework-simplejwt",{"type":49,"tag":68,"props":27576,"children":27577},{},[27578],{"type":55,"value":27579},"Custom user model with email as username",{"type":49,"tag":68,"props":27581,"children":27582},{},[27583,27585,27591],{"type":55,"value":27584},"Social authentication with ",{"type":49,"tag":326,"props":27586,"children":27588},{"className":27587},[],[27589],{"type":55,"value":27590},"python-social-auth",{"type":55,"value":27592}," (Google, Facebook, GitHub)",{"type":49,"tag":68,"props":27594,"children":27595},{},[27596],{"type":55,"value":27597},"Pytest for unit testing",{"type":49,"tag":68,"props":27599,"children":27600},{},[27601],{"type":55,"value":27602},"Settings broken into separate modules (development, ci, production)",{"type":49,"tag":68,"props":27604,"children":27605},{},[27606,27608,27614],{"type":55,"value":27607},"Django apps organized in ",{"type":49,"tag":326,"props":27609,"children":27611},{"className":27610},[],[27612],{"type":55,"value":27613},"apps",{"type":55,"value":27615}," directory",{"type":49,"tag":68,"props":27617,"children":27618},{},[27619],{"type":55,"value":27620},"S3 for static assets, public media and private media files in production, local file system for assets in local development",{"type":49,"tag":68,"props":27622,"children":27623},{},[27624],{"type":55,"value":27625},"Multiple Celery queues for asynchronous tasks",{"type":49,"tag":68,"props":27627,"children":27628},{},[27629],{"type":55,"value":27630},"Django Channels for websocket support with daphne",{"type":49,"tag":68,"props":27632,"children":27633},{},[27634],{"type":55,"value":27635},"Graphene for GraphQL",{"type":49,"tag":430,"props":27637,"children":27639},{"id":27638},"vuejs-application",[27640],{"type":55,"value":27641},"Vue.js application",{"type":49,"tag":64,"props":27643,"children":27644},{},[27645,27650,27655,27660,27665,27670,27674],{"type":49,"tag":68,"props":27646,"children":27647},{},[27648],{"type":55,"value":27649},"Quasar Framework for creating a Vue.js app with multiple build targets (SPA, PWA, Electron, SSR and Cordova)",{"type":49,"tag":68,"props":27651,"children":27652},{},[27653],{"type":55,"value":27654},"Internationalization",{"type":49,"tag":68,"props":27656,"children":27657},{},[27658],{"type":55,"value":27659},"Dark/Light mode",{"type":49,"tag":68,"props":27661,"children":27662},{},[27663],{"type":55,"value":27664},"Vuex for state management",{"type":49,"tag":68,"props":27666,"children":27667},{},[27668],{"type":55,"value":27669},"vue-router",{"type":49,"tag":68,"props":27671,"children":27672},{},[27673],{"type":55,"value":16452},{"type":49,"tag":68,"props":27675,"children":27676},{},[27677],{"type":55,"value":27678},"Vue Apollo",{"type":49,"tag":430,"props":27680,"children":27682},{"id":27681},"aws-django-vuejs",[27683],{"type":55,"value":27684},"AWS â© Django â© Vue.js",{"type":49,"tag":58,"props":27686,"children":27687},{},[27688,27690,27698],{"type":55,"value":27689},"CloudFront is used as a CDN and proxy in order to serve the frontend Vue.js PWA* ",{"type":49,"tag":72,"props":27691,"children":27692},{},[27693],{"type":49,"tag":1060,"props":27694,"children":27695},{},[27696],{"type":55,"value":27697},"3",{"type":55,"value":27699},", static and media assets, Django API and other monitoring services all on the same URL with environments namespaced by subdomain (or a combination of domain and subdomains by production and non-production environments, respectively). The PWA uses Workbox to route certain URL paths to network only (not served by the local cache).",{"type":49,"tag":58,"props":27701,"children":27702},{},[27703],{"type":55,"value":27704},"Here are some examples:",{"type":49,"tag":27484,"props":27706,"children":27708},{"id":27707},"staging-environment-urls",[27709],{"type":55,"value":27710},"Staging environment URLs",{"type":49,"tag":64,"props":27712,"children":27713},{},[27714,27725,27736,27747,27758,27769],{"type":49,"tag":68,"props":27715,"children":27716},{},[27717,27723],{"type":49,"tag":326,"props":27718,"children":27720},{"className":27719},[],[27721],{"type":55,"value":27722},"https://dev.mysite.com/api/*",{"type":55,"value":27724}," - Django REST Framework",{"type":49,"tag":68,"props":27726,"children":27727},{},[27728,27734],{"type":49,"tag":326,"props":27729,"children":27731},{"className":27730},[],[27732],{"type":55,"value":27733},"https://dev.mysite.com/admin/*",{"type":55,"value":27735}," - Django Admin",{"type":49,"tag":68,"props":27737,"children":27738},{},[27739,27745],{"type":49,"tag":326,"props":27740,"children":27742},{"className":27741},[],[27743],{"type":55,"value":27744},"https://dev.mysite.com/graphql/",{"type":55,"value":27746}," - Graphene/GraphQL",{"type":49,"tag":68,"props":27748,"children":27749},{},[27750,27756],{"type":49,"tag":326,"props":27751,"children":27753},{"className":27752},[],[27754],{"type":55,"value":27755},"https://dev.mysite.com/flower/*",{"type":55,"value":27757}," - Flower (Celery monitoring utility)",{"type":49,"tag":68,"props":27759,"children":27760},{},[27761,27767],{"type":49,"tag":326,"props":27762,"children":27764},{"className":27763},[],[27765],{"type":55,"value":27766},"https://dev.mysite.com/media/private/private-file.csv",{"type":55,"value":27768}," - private media files",{"type":49,"tag":68,"props":27770,"children":27771},{},[27772,27778,27780,27785],{"type":49,"tag":326,"props":27773,"children":27775},{"className":27774},[],[27776],{"type":55,"value":27777},"https://dev.mysite.com/*",{"type":55,"value":27779}," - Vue.js PWA (all other routes load ",{"type":49,"tag":326,"props":27781,"children":27783},{"className":27782},[],[27784],{"type":55,"value":14354},{"type":55,"value":616},{"type":49,"tag":27484,"props":27787,"children":27789},{"id":27788},"production-environment-urls",[27790],{"type":55,"value":27791},"Production environment URLs",{"type":49,"tag":64,"props":27793,"children":27794},{},[27795,27805,27815,27825,27835,27845],{"type":49,"tag":68,"props":27796,"children":27797},{},[27798,27804],{"type":49,"tag":326,"props":27799,"children":27801},{"className":27800},[],[27802],{"type":55,"value":27803},"https://mysite.com/api/*",{"type":55,"value":27724},{"type":49,"tag":68,"props":27806,"children":27807},{},[27808,27814],{"type":49,"tag":326,"props":27809,"children":27811},{"className":27810},[],[27812],{"type":55,"value":27813},"https://mysite.com/admin/*",{"type":55,"value":27735},{"type":49,"tag":68,"props":27816,"children":27817},{},[27818,27824],{"type":49,"tag":326,"props":27819,"children":27821},{"className":27820},[],[27822],{"type":55,"value":27823},"https://mysite.com/graphql/",{"type":55,"value":27746},{"type":49,"tag":68,"props":27826,"children":27827},{},[27828,27834],{"type":49,"tag":326,"props":27829,"children":27831},{"className":27830},[],[27832],{"type":55,"value":27833},"https://mysite.com/flower/*",{"type":55,"value":27757},{"type":49,"tag":68,"props":27836,"children":27837},{},[27838,27844],{"type":49,"tag":326,"props":27839,"children":27841},{"className":27840},[],[27842],{"type":55,"value":27843},"https://mysite.com/media/private/private-file.csv",{"type":55,"value":27768},{"type":49,"tag":68,"props":27846,"children":27847},{},[27848,27853,27854,27859],{"type":49,"tag":326,"props":27849,"children":27851},{"className":27850},[],[27852],{"type":55,"value":16966},{"type":55,"value":27779},{"type":49,"tag":326,"props":27855,"children":27857},{"className":27856},[],[27858],{"type":55,"value":14354},{"type":55,"value":616},{"type":49,"tag":58,"props":27861,"children":27862},{},[27863,27865,27871],{"type":55,"value":27864},"Alternatively, the production domain name could be configured to use a dedicated subdomain such as ",{"type":49,"tag":326,"props":27866,"children":27868},{"className":27867},[],[27869],{"type":55,"value":27870},"https://app.mysite.com",{"type":55,"value":745},{"type":49,"tag":430,"props":27873,"children":27875},{"id":27874},"sample-application-logic",[27876],{"type":55,"value":27877},"Sample application logic",{"type":49,"tag":58,"props":27879,"children":27880},{},[27881],{"type":55,"value":27882},"While this is mostly a Proof-of-Concept project that focuses on architecture, I have included some light-weight examples of what you can do with this application. These examples are all WIP.",{"type":49,"tag":27484,"props":27884,"children":27886},{"id":27885},"social-authentication",[27887],{"type":55,"value":27888},"Social Authentication",{"type":49,"tag":64,"props":27890,"children":27891},{},[27892,27904],{"type":49,"tag":68,"props":27893,"children":27894},{},[27895,27897,27902],{"type":55,"value":27896},"Uses ",{"type":49,"tag":326,"props":27898,"children":27900},{"className":27899},[],[27901],{"type":55,"value":27590},{"type":55,"value":27903}," to allow users to Sign Up/Login with Google, Facebook and GitHub accounts",{"type":49,"tag":68,"props":27905,"children":27906},{},[27907],{"type":55,"value":27908},"Makes use of the custom user model",{"type":49,"tag":27484,"props":27910,"children":27912},{"id":27911},"credit-card-statement-app",[27913],{"type":55,"value":27914},"Credit Card Statement App",{"type":49,"tag":58,"props":27916,"children":27917},{},[27918],{"type":55,"value":27919},"This is a simple application for users to upload credit card statements in CSV format.",{"type":49,"tag":64,"props":27921,"children":27922},{},[27923,27928,27933,27938],{"type":49,"tag":68,"props":27924,"children":27925},{},[27926],{"type":55,"value":27927},"Credit card transactions in CSV files are created using bulk inserts via the Django ORM in a celery task",{"type":49,"tag":68,"props":27929,"children":27930},{},[27931],{"type":55,"value":27932},"CSV files are saved in private S3 storage",{"type":49,"tag":68,"props":27934,"children":27935},{},[27936],{"type":55,"value":27937},"Basic visualization of spend over time",{"type":49,"tag":68,"props":27939,"children":27940},{},[27941],{"type":55,"value":27942},"Download consolidated CSV file",{"type":49,"tag":27484,"props":27944,"children":27946},{"id":27945},"hacker-news-clone",[27947],{"type":55,"value":27948},"Hacker News Clone",{"type":49,"tag":64,"props":27950,"children":27951},{},[27952,27963],{"type":49,"tag":68,"props":27953,"children":27954},{},[27955,27957],{"type":55,"value":27956},"An implementation of the application from this tutorial: ",{"type":49,"tag":80,"props":27958,"children":27961},{"href":27959,"rel":27960},"https://www.howtographql.com/graphql-python/0-introduction/",[84],[27962],{"type":55,"value":27959},{"type":49,"tag":68,"props":27964,"children":27965},{},[27966],{"type":55,"value":27967},"Uses Vue Apollo GraphQL client",{"type":49,"tag":430,"props":27969,"children":27971},{"id":27970},"testing",[27972],{"type":55,"value":27137},{"type":49,"tag":64,"props":27974,"children":27975},{},[27976,27981,27986,27991,27996,28007],{"type":49,"tag":68,"props":27977,"children":27978},{},[27979],{"type":55,"value":27980},"Unit testing with pytest and Jest",{"type":49,"tag":68,"props":27982,"children":27983},{},[27984],{"type":55,"value":27985},"Test coverage reports",{"type":49,"tag":68,"props":27987,"children":27988},{},[27989],{"type":55,"value":27990},"Integration testing with Cypress",{"type":49,"tag":68,"props":27992,"children":27993},{},[27994],{"type":55,"value":27995},"Capture integration test run recordings as GitLab CI job artifacts",{"type":49,"tag":68,"props":27997,"children":27998},{},[27999,28001],{"type":55,"value":28000},"Testing GitLab CI jobs locally with ",{"type":49,"tag":326,"props":28002,"children":28004},{"className":28003},[],[28005],{"type":55,"value":28006},"gitlab-runner",{"type":49,"tag":68,"props":28008,"children":28009},{},[28010,28012],{"type":55,"value":28011},"Tests for CDK?* ",{"type":49,"tag":72,"props":28013,"children":28014},{},[28015],{"type":49,"tag":1060,"props":28016,"children":28017},{},[28018],{"type":55,"value":28019},"4",{"type":49,"tag":430,"props":28021,"children":28023},{"id":28022},"caveats-questions-confusion-and-footnotes",[28024],{"type":55,"value":28025},"Caveats, Questions, Confusion and Footnotes",{"type":49,"tag":8994,"props":28027,"children":28028},{},[28029,28034],{"type":49,"tag":68,"props":28030,"children":28031},{},[28032],{"type":55,"value":28033},"In the context of this project, it is serverless in the sense that AWS Fargate is serverless: there are no EC2 instances to manage. It is not serverless in the way that Zappa can deploy a Django application as an AWS Lambda function with one invocation per request. There are \"always on\" processes that listen for incoming requests. I'm interested in trying Zappa, but I'm confused about how CDK, zappa-cli, SAM and Serverless Framework would all play together. Aurora Postgres Serverless is another nice \"serverless\" aspect of this project and contributes significantly to cost savings.",{"type":49,"tag":68,"props":28035,"children":28036},{},[28037],{"type":55,"value":28038},"This project currently uses no NAT Gateways. The Fargate services and tasks running Django processes (gunicorn, celery, daphne as well as migration, collectstatic and other management commands) are launched in public subnets and the databases (RDS and ElastiCache) are placed in private subnets. This is primarily done to avoid the cost of running a NAT Gateway.",{"type":49,"tag":64,"props":28040,"children":28041},{},[28042,28054],{"type":49,"tag":68,"props":28043,"children":28044},{},[28045,28047,28053],{"type":55,"value":28046},"I think it would fairly easy to switch to using a NAT Gatway to add an additional layer of security that is recommended in this article: ",{"type":49,"tag":80,"props":28048,"children":28051},{"href":28049,"rel":28050},"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/",[84],[28052],{"type":55,"value":28049},{"type":55,"value":745},{"type":49,"tag":68,"props":28055,"children":28056},{},[28057,28059,28065],{"type":55,"value":28058},"I asked a question about this on the Stack Exchange Information Security forum: ",{"type":49,"tag":80,"props":28060,"children":28063},{"href":28061,"rel":28062},"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job",[84],[28064],{"type":55,"value":28061},{"type":55,"value":28066},"\nI'm curious to know if this is a reasonable tradeoff to make, as well as how secure the proposed solution is (using security groups and network ACLs).",{"type":49,"tag":8994,"props":28068,"children":28069},{"start":1088},[28070,28082],{"type":49,"tag":68,"props":28071,"children":28072},{},[28073,28075,28080],{"type":55,"value":28074},"I'm not focusing on SEO in this project. I'm using ",{"type":49,"tag":326,"props":28076,"children":28078},{"className":28077},[],[28079],{"type":55,"value":14354},{"type":55,"value":28081}," as the error document for the S3 website that CloudFront uses as the default behavior. This means that nested routes for the PWA have 404 response codes. I have heard about using lambda@edge to rewrite the the response code, I'm also curious about using this project in SSR mode (and also \"serverless-side rendering\"), but for now that is outside of the scope of what I want to do with this project.",{"type":49,"tag":68,"props":28083,"children":28084},{},[28085,28090,28092,28098],{"type":49,"tag":72,"props":28086,"children":28087},{},[28088],{"type":55,"value":28089},"CDK is an awesome tool!",{"type":55,"value":28091}," Here is a great introduction by Nathan Peck, Senior Developer Advocate at Amazon Web Services: ",{"type":49,"tag":80,"props":28093,"children":28096},{"href":28094,"rel":28095},"https://www.youtube.com/watch?v=184S7ki6fJA",[84],[28097],{"type":55,"value":28094},{"type":55,"value":745},{"type":49,"tag":50,"props":28100,"children":28102},{"id":28101},"my-experience-with-aws-cdk",[28103],{"type":55,"value":28104},"My experience with AWS CDK",{"type":49,"tag":58,"props":28106,"children":28107},{},[28108],{"type":55,"value":28109},"Having worked with CloudFormation for almost a year, I was not looking forward to learning a another Infrastructure as Code (IaC) tool. I struggled with CloudFormation and the whole concept of using an extended version of YAML to define infrastructure for multiple environments. I have limited experience with Terraform, but learning another DSL seemed like a lateral move that didn't seem worth it. I'm glad I did spend time learning and using CloudFormation, because CDK is an abstraction layer over CloudFormation. Here are some of my thoughts on adopting CDK.",{"type":49,"tag":430,"props":28111,"children":28113},{"id":28112},"start-here-httpscdkworkshopcom",[28114,28116],{"type":55,"value":28115},"Start here: ",{"type":49,"tag":80,"props":28117,"children":28120},{"href":28118,"rel":28119},"https://cdkworkshop.com",[84],[28121],{"type":55,"value":28118},{"type":49,"tag":58,"props":28123,"children":28124},{},[28125],{"type":55,"value":28126},"This is a great resource that was my first exposure to CDK. It focuses on using Lambda, DynamoDB and API Gateway, three technologies that I haven't used in production environments. In my mind this stack is the antithesis of the stack paradigm I am most experienced with: EC2, RDS and ELB. Regardless, I went ahead with it and was pretty much instantly hooked on CDK.",{"type":49,"tag":430,"props":28128,"children":28130},{"id":28129},"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing",[28131],{"type":55,"value":28132},"The stack is defined by a small number of inputs used for namespacing",{"type":49,"tag":58,"props":28134,"children":28135},{},[28136,28142,28144,28149],{"type":49,"tag":326,"props":28137,"children":28139},{"className":28138},[],[28140],{"type":55,"value":28141},"awscdk/app.py",{"type":55,"value":28143}," is the entrypoint for ",{"type":49,"tag":326,"props":28145,"children":28147},{"className":28146},[],[28148],{"type":55,"value":15},{"type":55,"value":28150}," commands. Here's what it contains:",{"type":49,"tag":58,"props":28152,"children":28153},{},[28154,28156,28162,28164,28169],{"type":55,"value":28155},"Here are the main parameters for ",{"type":49,"tag":326,"props":28157,"children":28159},{"className":28158},[],[28160],{"type":55,"value":28161},"ApplicationStack",{"type":55,"value":28163},", which represents all of the resources for a specific environment environment. Each value is composed of environment variables set in GitLab CI when ",{"type":49,"tag":326,"props":28165,"children":28167},{"className":28166},[],[28168],{"type":55,"value":26093},{"type":55,"value":28170}," is called:",{"type":49,"tag":64,"props":28172,"children":28173},{},[28174,28212,28223,28247,28279,28310],{"type":49,"tag":68,"props":28175,"children":28176},{},[28177,28183,28185,28190,28191,28197,28198,28204,28205,28210],{"type":49,"tag":326,"props":28178,"children":28180},{"className":28179},[],[28181],{"type":55,"value":28182},"environment_name",{"type":55,"value":28184}," - Possible examples could be ",{"type":49,"tag":326,"props":28186,"children":28188},{"className":28187},[],[28189],{"type":55,"value":34},{"type":55,"value":873},{"type":49,"tag":326,"props":28192,"children":28194},{"className":28193},[],[28195],{"type":55,"value":28196},"qa",{"type":55,"value":873},{"type":49,"tag":326,"props":28199,"children":28201},{"className":28200},[],[28202],{"type":55,"value":28203},"some-feature-branch",{"type":55,"value":873},{"type":49,"tag":326,"props":28206,"children":28208},{"className":28207},[],[28209],{"type":55,"value":1360},{"type":55,"value":28211},", etc.",{"type":49,"tag":68,"props":28213,"children":28214},{},[28215,28221],{"type":49,"tag":326,"props":28216,"children":28218},{"className":28217},[],[28219],{"type":55,"value":28220},"base_domain_name",{"type":55,"value":28222}," - The domain name of the Hosted Zone that needs to be setup manually in Route53",{"type":49,"tag":68,"props":28224,"children":28225},{},[28226,28232,28234,28240,28242],{"type":49,"tag":326,"props":28227,"children":28229},{"className":28228},[],[28230],{"type":55,"value":28231},"full_domain_name",{"type":55,"value":28233}," - ",{"type":49,"tag":326,"props":28235,"children":28237},{"className":28236},[],[28238],{"type":55,"value":28239},"f\"{environment_name}.{base_domain_name}\"",{"type":55,"value":28241}," or optionally just ",{"type":49,"tag":326,"props":28243,"children":28245},{"className":28244},[],[28246],{"type":55,"value":28220},{"type":49,"tag":68,"props":28248,"children":28249},{},[28250,28256,28258,28263,28265,28270,28272,28277],{"type":49,"tag":326,"props":28251,"children":28253},{"className":28252},[],[28254],{"type":55,"value":28255},"base_app_name",{"type":55,"value":28257}," - Based on the ",{"type":49,"tag":326,"props":28259,"children":28261},{"className":28260},[],[28262],{"type":55,"value":28220},{"type":55,"value":28264},", but ",{"type":49,"tag":326,"props":28266,"children":28268},{"className":28267},[],[28269],{"type":55,"value":745},{"type":55,"value":28271}," is replaced with ",{"type":49,"tag":326,"props":28273,"children":28275},{"className":28274},[],[28276],{"type":55,"value":10180},{"type":55,"value":28278}," in order to be used for naming certain AWS resources, used for resources tagging so we can easily look at the costs of all environments for our application with one tag.",{"type":49,"tag":68,"props":28280,"children":28281},{},[28282,28288,28290,28295,28296,28301,28303,28308],{"type":49,"tag":326,"props":28283,"children":28285},{"className":28284},[],[28286],{"type":55,"value":28287},"full_app_name",{"type":55,"value":28289}," - Base on ",{"type":49,"tag":326,"props":28291,"children":28293},{"className":28292},[],[28294],{"type":55,"value":28231},{"type":55,"value":873},{"type":49,"tag":326,"props":28297,"children":28299},{"className":28298},[],[28300],{"type":55,"value":745},{"type":55,"value":28302}," replaced with ",{"type":49,"tag":326,"props":28304,"children":28306},{"className":28305},[],[28307],{"type":55,"value":10180},{"type":55,"value":28309}," as well.",{"type":49,"tag":68,"props":28311,"children":28312},{},[28313],{"type":49,"tag":326,"props":28314,"children":28316},{"className":28315},[],[28317],{"type":55,"value":28318},"aws_region",{"type":49,"tag":58,"props":28320,"children":28321},{},[28322,28324,28329],{"type":55,"value":28323},"Expand to the following to view ",{"type":49,"tag":326,"props":28325,"children":28327},{"className":28326},[],[28328],{"type":55,"value":28141},{"type":55,"value":6694},{"type":49,"tag":28331,"props":28332,"children":28333},"details",{},[28334],{"type":49,"tag":1050,"props":28335,"children":28339},{"code":28336,"language":28337,"meta":8,"className":28338,"style":8},"#!/usr/bin/env python3\nimport os\n\nfrom aws_cdk import core\n\nfrom awscdk.cdk_app_root import ApplicationStack\n\n# naming conventions, also used for ACM certs, DNS Records, resource naming\n# Dynamically generated resource names created in CDK are used in GitLab CI\n# such as cluster name, task definitions, etc.\nenvironment_name = f\"{os.environ.get('ENVIRONMENT', 'dev')}\"\nbase_domain_name = os.environ.get(\"DOMAIN_NAME\", \"mysite.com\")\n# if the the production environent subdomain should nott be included in the URL\n# redefine `full_domain_name` to `base_domain_name` for that environment\nfull_domain_name = f\"{environment_name}.{base_domain_name}\"  # dev.mysite.com\n# if environment_name == \"prod\":\n#     full_domain_name = base_domain_name\nbase_app_name = os.environ.get(\"APP_NAME\", \"mysite-com\")\nfull_app_name = f\"{environment_name}-{base_app_name}\"  # dev-mysite-com\naws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n\n\napp = core.App()\nstack = ApplicationStack(\n    app,\n    f\"{full_app_name}-stack\",\n    environment_name=environment_name,\n    base_domain_name=base_domain_name,\n    full_domain_name=full_domain_name,\n    base_app_name=base_app_name,\n    full_app_name=full_app_name,\n    env={\"region\": aws_region},\n)\n\n# in order to be able to tag ECS resources, you need to go to\n# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n# and enable at least Service and Task. Optionally enable\n# CloudWatch Container Insights\nstack.node.apply_aspect(core.Tag(\"StackName\", full_app_name))\nstack.node.apply_aspect(core.Tag(\"StackName\", base_app_name))\n\napp.synth()\n","python","language-python shiki shiki-themes github-light github-dark monokai",[28340],{"type":49,"tag":326,"props":28341,"children":28342},{"__ignoreMap":8},[28343,28351,28362,28369,28390,28397,28418,28425,28433,28441,28449,28503,28538,28546,28554,28611,28619,28627,28661,28718,28752,28759,28766,28783,28800,28808,28841,28858,28875,28892,28909,28926,28952,28959,28966,28974,28982,28990,28998,29016,29032,29039],{"type":49,"tag":1060,"props":28344,"children":28345},{"class":1062,"line":1063},[28346],{"type":49,"tag":1060,"props":28347,"children":28348},{"style":3039},[28349],{"type":55,"value":28350},"#!/usr/bin/env python3\n",{"type":49,"tag":1060,"props":28352,"children":28353},{"class":1062,"line":1079},[28354,28358],{"type":49,"tag":1060,"props":28355,"children":28356},{"style":2194},[28357],{"type":55,"value":22194},{"type":49,"tag":1060,"props":28359,"children":28360},{"style":1073},[28361],{"type":55,"value":25116},{"type":49,"tag":1060,"props":28363,"children":28364},{"class":1062,"line":1088},[28365],{"type":49,"tag":1060,"props":28366,"children":28367},{"emptyLinePlaceholder":44},[28368],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28370,"children":28371},{"class":1062,"line":1097},[28372,28376,28381,28385],{"type":49,"tag":1060,"props":28373,"children":28374},{"style":2194},[28375],{"type":55,"value":22184},{"type":49,"tag":1060,"props":28377,"children":28378},{"style":1073},[28379],{"type":55,"value":28380}," aws_cdk ",{"type":49,"tag":1060,"props":28382,"children":28383},{"style":2194},[28384],{"type":55,"value":22194},{"type":49,"tag":1060,"props":28386,"children":28387},{"style":1073},[28388],{"type":55,"value":28389}," core\n",{"type":49,"tag":1060,"props":28391,"children":28392},{"class":1062,"line":1111},[28393],{"type":49,"tag":1060,"props":28394,"children":28395},{"emptyLinePlaceholder":44},[28396],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28398,"children":28399},{"class":1062,"line":1120},[28400,28404,28409,28413],{"type":49,"tag":1060,"props":28401,"children":28402},{"style":2194},[28403],{"type":55,"value":22184},{"type":49,"tag":1060,"props":28405,"children":28406},{"style":1073},[28407],{"type":55,"value":28408}," awscdk.cdk_app_root ",{"type":49,"tag":1060,"props":28410,"children":28411},{"style":2194},[28412],{"type":55,"value":22194},{"type":49,"tag":1060,"props":28414,"children":28415},{"style":1073},[28416],{"type":55,"value":28417}," ApplicationStack\n",{"type":49,"tag":1060,"props":28419,"children":28420},{"class":1062,"line":1128},[28421],{"type":49,"tag":1060,"props":28422,"children":28423},{"emptyLinePlaceholder":44},[28424],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28426,"children":28427},{"class":1062,"line":1141},[28428],{"type":49,"tag":1060,"props":28429,"children":28430},{"style":3039},[28431],{"type":55,"value":28432},"# naming conventions, also used for ACM certs, DNS Records, resource naming\n",{"type":49,"tag":1060,"props":28434,"children":28435},{"class":1062,"line":1150},[28436],{"type":49,"tag":1060,"props":28437,"children":28438},{"style":3039},[28439],{"type":55,"value":28440},"# Dynamically generated resource names created in CDK are used in GitLab CI\n",{"type":49,"tag":1060,"props":28442,"children":28443},{"class":1062,"line":1158},[28444],{"type":49,"tag":1060,"props":28445,"children":28446},{"style":3039},[28447],{"type":55,"value":28448},"# such as cluster name, task definitions, etc.\n",{"type":49,"tag":1060,"props":28450,"children":28451},{"class":1062,"line":1171},[28452,28457,28461,28465,28469,28473,28477,28482,28486,28491,28495,28499],{"type":49,"tag":1060,"props":28453,"children":28454},{"style":1073},[28455],{"type":55,"value":28456},"environment_name ",{"type":49,"tag":1060,"props":28458,"children":28459},{"style":2194},[28460],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28462,"children":28463},{"style":2182},[28464],{"type":55,"value":24805},{"type":49,"tag":1060,"props":28466,"children":28467},{"style":2215},[28468],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28470,"children":28471},{"style":2287},[28472],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28474,"children":28475},{"style":1073},[28476],{"type":55,"value":25258},{"type":49,"tag":1060,"props":28478,"children":28479},{"style":2215},[28480],{"type":55,"value":28481},"'ENVIRONMENT'",{"type":49,"tag":1060,"props":28483,"children":28484},{"style":1073},[28485],{"type":55,"value":873},{"type":49,"tag":1060,"props":28487,"children":28488},{"style":2215},[28489],{"type":55,"value":28490},"'dev'",{"type":49,"tag":1060,"props":28492,"children":28493},{"style":1073},[28494],{"type":55,"value":616},{"type":49,"tag":1060,"props":28496,"children":28497},{"style":2287},[28498],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28500,"children":28501},{"style":2215},[28502],{"type":55,"value":10025},{"type":49,"tag":1060,"props":28504,"children":28505},{"class":1062,"line":1180},[28506,28511,28515,28520,28525,28529,28534],{"type":49,"tag":1060,"props":28507,"children":28508},{"style":1073},[28509],{"type":55,"value":28510},"base_domain_name ",{"type":49,"tag":1060,"props":28512,"children":28513},{"style":2194},[28514],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28516,"children":28517},{"style":1073},[28518],{"type":55,"value":28519}," os.environ.get(",{"type":49,"tag":1060,"props":28521,"children":28522},{"style":2215},[28523],{"type":55,"value":28524},"\"DOMAIN_NAME\"",{"type":49,"tag":1060,"props":28526,"children":28527},{"style":1073},[28528],{"type":55,"value":873},{"type":49,"tag":1060,"props":28530,"children":28531},{"style":2215},[28532],{"type":55,"value":28533},"\"mysite.com\"",{"type":49,"tag":1060,"props":28535,"children":28536},{"style":1073},[28537],{"type":55,"value":5126},{"type":49,"tag":1060,"props":28539,"children":28540},{"class":1062,"line":1188},[28541],{"type":49,"tag":1060,"props":28542,"children":28543},{"style":3039},[28544],{"type":55,"value":28545},"# if the the production environent subdomain should nott be included in the URL\n",{"type":49,"tag":1060,"props":28547,"children":28548},{"class":1062,"line":1201},[28549],{"type":49,"tag":1060,"props":28550,"children":28551},{"style":3039},[28552],{"type":55,"value":28553},"# redefine `full_domain_name` to `base_domain_name` for that environment\n",{"type":49,"tag":1060,"props":28555,"children":28556},{"class":1062,"line":1210},[28557,28562,28566,28570,28574,28578,28582,28586,28590,28594,28598,28602,28606],{"type":49,"tag":1060,"props":28558,"children":28559},{"style":1073},[28560],{"type":55,"value":28561},"full_domain_name ",{"type":49,"tag":1060,"props":28563,"children":28564},{"style":2194},[28565],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28567,"children":28568},{"style":2182},[28569],{"type":55,"value":24805},{"type":49,"tag":1060,"props":28571,"children":28572},{"style":2215},[28573],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28575,"children":28576},{"style":2287},[28577],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28579,"children":28580},{"style":1073},[28581],{"type":55,"value":28182},{"type":49,"tag":1060,"props":28583,"children":28584},{"style":2287},[28585],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28587,"children":28588},{"style":2215},[28589],{"type":55,"value":745},{"type":49,"tag":1060,"props":28591,"children":28592},{"style":2287},[28593],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28595,"children":28596},{"style":1073},[28597],{"type":55,"value":28220},{"type":49,"tag":1060,"props":28599,"children":28600},{"style":2287},[28601],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28603,"children":28604},{"style":2215},[28605],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28607,"children":28608},{"style":3039},[28609],{"type":55,"value":28610},"  # dev.mysite.com\n",{"type":49,"tag":1060,"props":28612,"children":28613},{"class":1062,"line":1218},[28614],{"type":49,"tag":1060,"props":28615,"children":28616},{"style":3039},[28617],{"type":55,"value":28618},"# if environment_name == \"prod\":\n",{"type":49,"tag":1060,"props":28620,"children":28621},{"class":1062,"line":1232},[28622],{"type":49,"tag":1060,"props":28623,"children":28624},{"style":3039},[28625],{"type":55,"value":28626},"#     full_domain_name = base_domain_name\n",{"type":49,"tag":1060,"props":28628,"children":28629},{"class":1062,"line":1241},[28630,28635,28639,28643,28648,28652,28657],{"type":49,"tag":1060,"props":28631,"children":28632},{"style":1073},[28633],{"type":55,"value":28634},"base_app_name ",{"type":49,"tag":1060,"props":28636,"children":28637},{"style":2194},[28638],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28640,"children":28641},{"style":1073},[28642],{"type":55,"value":28519},{"type":49,"tag":1060,"props":28644,"children":28645},{"style":2215},[28646],{"type":55,"value":28647},"\"APP_NAME\"",{"type":49,"tag":1060,"props":28649,"children":28650},{"style":1073},[28651],{"type":55,"value":873},{"type":49,"tag":1060,"props":28653,"children":28654},{"style":2215},[28655],{"type":55,"value":28656},"\"mysite-com\"",{"type":49,"tag":1060,"props":28658,"children":28659},{"style":1073},[28660],{"type":55,"value":5126},{"type":49,"tag":1060,"props":28662,"children":28663},{"class":1062,"line":1249},[28664,28669,28673,28677,28681,28685,28689,28693,28697,28701,28705,28709,28713],{"type":49,"tag":1060,"props":28665,"children":28666},{"style":1073},[28667],{"type":55,"value":28668},"full_app_name ",{"type":49,"tag":1060,"props":28670,"children":28671},{"style":2194},[28672],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28674,"children":28675},{"style":2182},[28676],{"type":55,"value":24805},{"type":49,"tag":1060,"props":28678,"children":28679},{"style":2215},[28680],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28682,"children":28683},{"style":2287},[28684],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28686,"children":28687},{"style":1073},[28688],{"type":55,"value":28182},{"type":49,"tag":1060,"props":28690,"children":28691},{"style":2287},[28692],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28694,"children":28695},{"style":2215},[28696],{"type":55,"value":10180},{"type":49,"tag":1060,"props":28698,"children":28699},{"style":2287},[28700],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28702,"children":28703},{"style":1073},[28704],{"type":55,"value":28255},{"type":49,"tag":1060,"props":28706,"children":28707},{"style":2287},[28708],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28710,"children":28711},{"style":2215},[28712],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28714,"children":28715},{"style":3039},[28716],{"type":55,"value":28717},"  # dev-mysite-com\n",{"type":49,"tag":1060,"props":28719,"children":28720},{"class":1062,"line":1262},[28721,28726,28730,28734,28739,28743,28748],{"type":49,"tag":1060,"props":28722,"children":28723},{"style":1073},[28724],{"type":55,"value":28725},"aws_region ",{"type":49,"tag":1060,"props":28727,"children":28728},{"style":2194},[28729],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28731,"children":28732},{"style":1073},[28733],{"type":55,"value":28519},{"type":49,"tag":1060,"props":28735,"children":28736},{"style":2215},[28737],{"type":55,"value":28738},"\"AWS_DEFAULT_REGION\"",{"type":49,"tag":1060,"props":28740,"children":28741},{"style":1073},[28742],{"type":55,"value":873},{"type":49,"tag":1060,"props":28744,"children":28745},{"style":2215},[28746],{"type":55,"value":28747},"\"us-east-1\"",{"type":49,"tag":1060,"props":28749,"children":28750},{"style":1073},[28751],{"type":55,"value":5126},{"type":49,"tag":1060,"props":28753,"children":28754},{"class":1062,"line":4581},[28755],{"type":49,"tag":1060,"props":28756,"children":28757},{"emptyLinePlaceholder":44},[28758],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28760,"children":28761},{"class":1062,"line":4631},[28762],{"type":49,"tag":1060,"props":28763,"children":28764},{"emptyLinePlaceholder":44},[28765],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28767,"children":28768},{"class":1062,"line":4682},[28769,28774,28778],{"type":49,"tag":1060,"props":28770,"children":28771},{"style":1073},[28772],{"type":55,"value":28773},"app ",{"type":49,"tag":1060,"props":28775,"children":28776},{"style":2194},[28777],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28779,"children":28780},{"style":1073},[28781],{"type":55,"value":28782}," core.App()\n",{"type":49,"tag":1060,"props":28784,"children":28785},{"class":1062,"line":4709},[28786,28791,28795],{"type":49,"tag":1060,"props":28787,"children":28788},{"style":1073},[28789],{"type":55,"value":28790},"stack ",{"type":49,"tag":1060,"props":28792,"children":28793},{"style":2194},[28794],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28796,"children":28797},{"style":1073},[28798],{"type":55,"value":28799}," ApplicationStack(\n",{"type":49,"tag":1060,"props":28801,"children":28802},{"class":1062,"line":5979},[28803],{"type":49,"tag":1060,"props":28804,"children":28805},{"style":1073},[28806],{"type":55,"value":28807},"    app,\n",{"type":49,"tag":1060,"props":28809,"children":28810},{"class":1062,"line":5988},[28811,28816,28820,28824,28828,28832,28837],{"type":49,"tag":1060,"props":28812,"children":28813},{"style":2182},[28814],{"type":55,"value":28815},"    f",{"type":49,"tag":1060,"props":28817,"children":28818},{"style":2215},[28819],{"type":55,"value":10005},{"type":49,"tag":1060,"props":28821,"children":28822},{"style":2287},[28823],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28825,"children":28826},{"style":1073},[28827],{"type":55,"value":28287},{"type":49,"tag":1060,"props":28829,"children":28830},{"style":2287},[28831],{"type":55,"value":3511},{"type":49,"tag":1060,"props":28833,"children":28834},{"style":2215},[28835],{"type":55,"value":28836},"-stack\"",{"type":49,"tag":1060,"props":28838,"children":28839},{"style":1073},[28840],{"type":55,"value":2497},{"type":49,"tag":1060,"props":28842,"children":28843},{"class":1062,"line":5997},[28844,28849,28853],{"type":49,"tag":1060,"props":28845,"children":28846},{"style":22635},[28847],{"type":55,"value":28848},"    environment_name",{"type":49,"tag":1060,"props":28850,"children":28851},{"style":2194},[28852],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28854,"children":28855},{"style":1073},[28856],{"type":55,"value":28857},"environment_name,\n",{"type":49,"tag":1060,"props":28859,"children":28860},{"class":1062,"line":6006},[28861,28866,28870],{"type":49,"tag":1060,"props":28862,"children":28863},{"style":22635},[28864],{"type":55,"value":28865},"    base_domain_name",{"type":49,"tag":1060,"props":28867,"children":28868},{"style":2194},[28869],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28871,"children":28872},{"style":1073},[28873],{"type":55,"value":28874},"base_domain_name,\n",{"type":49,"tag":1060,"props":28876,"children":28877},{"class":1062,"line":10142},[28878,28883,28887],{"type":49,"tag":1060,"props":28879,"children":28880},{"style":22635},[28881],{"type":55,"value":28882},"    full_domain_name",{"type":49,"tag":1060,"props":28884,"children":28885},{"style":2194},[28886],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28888,"children":28889},{"style":1073},[28890],{"type":55,"value":28891},"full_domain_name,\n",{"type":49,"tag":1060,"props":28893,"children":28894},{"class":1062,"line":10151},[28895,28900,28904],{"type":49,"tag":1060,"props":28896,"children":28897},{"style":22635},[28898],{"type":55,"value":28899},"    base_app_name",{"type":49,"tag":1060,"props":28901,"children":28902},{"style":2194},[28903],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28905,"children":28906},{"style":1073},[28907],{"type":55,"value":28908},"base_app_name,\n",{"type":49,"tag":1060,"props":28910,"children":28911},{"class":1062,"line":10160},[28912,28917,28921],{"type":49,"tag":1060,"props":28913,"children":28914},{"style":22635},[28915],{"type":55,"value":28916},"    full_app_name",{"type":49,"tag":1060,"props":28918,"children":28919},{"style":2194},[28920],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28922,"children":28923},{"style":1073},[28924],{"type":55,"value":28925},"full_app_name,\n",{"type":49,"tag":1060,"props":28927,"children":28928},{"class":1062,"line":10188},[28929,28934,28938,28942,28947],{"type":49,"tag":1060,"props":28930,"children":28931},{"style":22635},[28932],{"type":55,"value":28933},"    env",{"type":49,"tag":1060,"props":28935,"children":28936},{"style":2194},[28937],{"type":55,"value":3068},{"type":49,"tag":1060,"props":28939,"children":28940},{"style":1073},[28941],{"type":55,"value":23338},{"type":49,"tag":1060,"props":28943,"children":28944},{"style":2215},[28945],{"type":55,"value":28946},"\"region\"",{"type":49,"tag":1060,"props":28948,"children":28949},{"style":1073},[28950],{"type":55,"value":28951},": aws_region},\n",{"type":49,"tag":1060,"props":28953,"children":28954},{"class":1062,"line":10196},[28955],{"type":49,"tag":1060,"props":28956,"children":28957},{"style":1073},[28958],{"type":55,"value":5126},{"type":49,"tag":1060,"props":28960,"children":28961},{"class":1062,"line":10205},[28962],{"type":49,"tag":1060,"props":28963,"children":28964},{"emptyLinePlaceholder":44},[28965],{"type":55,"value":1094},{"type":49,"tag":1060,"props":28967,"children":28968},{"class":1062,"line":10242},[28969],{"type":49,"tag":1060,"props":28970,"children":28971},{"style":3039},[28972],{"type":55,"value":28973},"# in order to be able to tag ECS resources, you need to go to\n",{"type":49,"tag":1060,"props":28975,"children":28976},{"class":1062,"line":10261},[28977],{"type":49,"tag":1060,"props":28978,"children":28979},{"style":3039},[28980],{"type":55,"value":28981},"# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n",{"type":49,"tag":1060,"props":28983,"children":28984},{"class":1062,"line":10270},[28985],{"type":49,"tag":1060,"props":28986,"children":28987},{"style":3039},[28988],{"type":55,"value":28989},"# and enable at least Service and Task. Optionally enable\n",{"type":49,"tag":1060,"props":28991,"children":28992},{"class":1062,"line":10278},[28993],{"type":49,"tag":1060,"props":28994,"children":28995},{"style":3039},[28996],{"type":55,"value":28997},"# CloudWatch Container Insights\n",{"type":49,"tag":1060,"props":28999,"children":29000},{"class":1062,"line":10287},[29001,29006,29011],{"type":49,"tag":1060,"props":29002,"children":29003},{"style":1073},[29004],{"type":55,"value":29005},"stack.node.apply_aspect(core.Tag(",{"type":49,"tag":1060,"props":29007,"children":29008},{"style":2215},[29009],{"type":55,"value":29010},"\"StackName\"",{"type":49,"tag":1060,"props":29012,"children":29013},{"style":1073},[29014],{"type":55,"value":29015},", full_app_name))\n",{"type":49,"tag":1060,"props":29017,"children":29018},{"class":1062,"line":10319},[29019,29023,29027],{"type":49,"tag":1060,"props":29020,"children":29021},{"style":1073},[29022],{"type":55,"value":29005},{"type":49,"tag":1060,"props":29024,"children":29025},{"style":2215},[29026],{"type":55,"value":29010},{"type":49,"tag":1060,"props":29028,"children":29029},{"style":1073},[29030],{"type":55,"value":29031},", base_app_name))\n",{"type":49,"tag":1060,"props":29033,"children":29034},{"class":1062,"line":10332},[29035],{"type":49,"tag":1060,"props":29036,"children":29037},{"emptyLinePlaceholder":44},[29038],{"type":55,"value":1094},{"type":49,"tag":1060,"props":29040,"children":29041},{"class":1062,"line":10356},[29042],{"type":49,"tag":1060,"props":29043,"children":29044},{"style":1073},[29045],{"type":55,"value":29046},"app.synth()\n",{"type":49,"tag":430,"props":29048,"children":29050},{"id":29049},"using-cdk-synth-in-development",[29051,29052,29057],{"type":55,"value":12732},{"type":49,"tag":326,"props":29053,"children":29055},{"className":29054},[],[29056],{"type":55,"value":26085},{"type":55,"value":29058}," in development",{"type":49,"tag":58,"props":29060,"children":29061},{},[29062,29064,29070,29072,29078,29080,29086,29087,29093,29094,29100,29102,29108,29110,29116,29118,29123,29125,29130],{"type":55,"value":29063},"When I first started using CDK, I defined a root stack containing multiple CDK constructs that each included groups of related CDK resources. For example, I had an ",{"type":49,"tag":326,"props":29065,"children":29067},{"className":29066},[],[29068],{"type":55,"value":29069},"RDSConstruct",{"type":55,"value":29071}," that contained a ",{"type":49,"tag":326,"props":29073,"children":29075},{"className":29074},[],[29076],{"type":55,"value":29077},"Secret",{"type":55,"value":29079},", a ",{"type":49,"tag":326,"props":29081,"children":29083},{"className":29082},[],[29084],{"type":55,"value":29085},"StringParameter",{"type":55,"value":29079},{"type":49,"tag":326,"props":29088,"children":29090},{"className":29089},[],[29091],{"type":55,"value":29092},"CfnSecurityGroup",{"type":55,"value":29079},{"type":49,"tag":326,"props":29095,"children":29097},{"className":29096},[],[29098],{"type":55,"value":29099},"CfnDBSubnetGroup",{"type":55,"value":29101}," and a ",{"type":49,"tag":326,"props":29103,"children":29105},{"className":29104},[],[29106],{"type":55,"value":29107},"CfnDBCluster",{"type":55,"value":29109},". Whenever I added a new section of CDK code, I would run ",{"type":49,"tag":326,"props":29111,"children":29113},{"className":29112},[],[29114],{"type":55,"value":29115},"cdk synth > stack.yml",{"type":55,"value":29117}," to generate a \"snapshot\" of my infrastructure in one file. ",{"type":49,"tag":326,"props":29119,"children":29121},{"className":29120},[],[29122],{"type":55,"value":19612},{"type":55,"value":29124}," was committed in my repo, and I could easily see how changes in CDK code changed the resulting CloudFormation YAML by repeating this ",{"type":49,"tag":326,"props":29126,"children":29128},{"className":29127},[],[29129],{"type":55,"value":26085},{"type":55,"value":19080},{"type":49,"tag":430,"props":29132,"children":29134},{"id":29133},"nestedstacks",[29135,29141],{"type":49,"tag":326,"props":29136,"children":29138},{"className":29137},[],[29139],{"type":55,"value":29140},"NestedStack",{"type":55,"value":29142},"s",{"type":49,"tag":58,"props":29144,"children":29145},{},[29146,29151,29153,29158,29160,29166,29167,29173,29175,29180,29181,29187,29189,29195,29197,29202,29204,29209,29211,29217,29219,29224],{"type":49,"tag":326,"props":29147,"children":29149},{"className":29148},[],[29150],{"type":55,"value":19612},{"type":55,"value":29152}," grew larger and larger as I added more resources in my main \"master stack\" or \"skeleton stack\", and I realized that I was going to reach the hard limit of 200 resources per CloudFormation stack. Refactoring to use ",{"type":49,"tag":326,"props":29154,"children":29156},{"className":29155},[],[29157],{"type":55,"value":29140},{"type":55,"value":29159},"s was pretty straightforward, all I had to do was replace ",{"type":49,"tag":326,"props":29161,"children":29163},{"className":29162},[],[29164],{"type":55,"value":29165},"core.Construct",{"type":55,"value":23703},{"type":49,"tag":326,"props":29168,"children":29170},{"className":29169},[],[29171],{"type":55,"value":29172},"cloudformation.NestedStack",{"type":55,"value":29174},". With nested stacks, running ",{"type":49,"tag":326,"props":29176,"children":29178},{"className":29177},[],[29179],{"type":55,"value":29115},{"type":55,"value":20776},{"type":49,"tag":326,"props":29182,"children":29184},{"className":29183},[],[29185],{"type":55,"value":29186},"AWS::CloudFormation::Stack",{"type":55,"value":29188},"s that are created, with ",{"type":49,"tag":326,"props":29190,"children":29192},{"className":29191},[],[29193],{"type":55,"value":29194},"TemplateURL",{"type":55,"value":29196}," and parameters from other stacks. It is more useful to look into contents of ",{"type":49,"tag":326,"props":29198,"children":29200},{"className":29199},[],[29201],{"type":55,"value":26337},{"type":55,"value":29203}," when working with ",{"type":49,"tag":326,"props":29205,"children":29207},{"className":29206},[],[29208],{"type":55,"value":29140},{"type":55,"value":29210},"s. The following command (executed from the root of the project) update the contents of the ",{"type":49,"tag":326,"props":29212,"children":29214},{"className":29213},[],[29215],{"type":55,"value":29216},"awscdk/cdk.out",{"type":55,"value":29218}," directory with templates for each of the ",{"type":49,"tag":326,"props":29220,"children":29222},{"className":29221},[],[29223],{"type":55,"value":29140},{"type":55,"value":29225},"s:",{"type":49,"tag":1050,"props":29227,"children":29229},{"code":29228},"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n",[29230],{"type":49,"tag":326,"props":29231,"children":29232},{"__ignoreMap":8},[29233],{"type":55,"value":29228},{"type":49,"tag":58,"props":29235,"children":29236},{},[29237,29239,29244,29245,29250,29252,29258],{"type":55,"value":29238},"The result is JSON, not YAML, and ",{"type":49,"tag":326,"props":29240,"children":29242},{"className":29241},[],[29243],{"type":55,"value":26337},{"type":55,"value":18627},{"type":49,"tag":326,"props":29246,"children":29248},{"className":29247},[],[29249],{"type":55,"value":18695},{"type":55,"value":29251},"d, but it can still be helpful in verifying that your CDK code is generating the correct CloudFormation templates. (",{"type":49,"tag":326,"props":29253,"children":29255},{"className":29254},[],[29256],{"type":55,"value":29257},"cdk diff",{"type":55,"value":29259}," may be the best option for seeing how CDK code changes will change your infrastructure).",{"type":49,"tag":430,"props":29261,"children":29263},{"id":29262},"cdk-deploy-and-cdk-in-gitlab-ci-pipelines",[29264,29269],{"type":49,"tag":326,"props":29265,"children":29267},{"className":29266},[],[29268],{"type":55,"value":26093},{"type":55,"value":29270}," and CDK in GitLab CI pipelines",{"type":49,"tag":58,"props":29272,"children":29273},{},[29274,29276,29281,29282,29288,29290,29296,29298,29304],{"type":55,"value":29275},"I like how ",{"type":49,"tag":326,"props":29277,"children":29279},{"className":29278},[],[29280],{"type":55,"value":26093},{"type":55,"value":1909},{"type":49,"tag":326,"props":29283,"children":29285},{"className":29284},[],[29286],{"type":55,"value":29287},"tail",{"type":55,"value":29289},"s the output of CloudFormation events until the stack update finishes or fails. I previously had been using the AWS CLI to call ",{"type":49,"tag":326,"props":29291,"children":29293},{"className":29292},[],[29294],{"type":55,"value":29295},"aws cloudformation update-stack",{"type":55,"value":29297},". This command kicks off a stack update and the GitLab pipeline will succeed regardless of the success of failure of the ",{"type":49,"tag":326,"props":29299,"children":29301},{"className":29300},[],[29302],{"type":55,"value":29303},"update-stack",{"type":55,"value":19080},{"type":49,"tag":2910,"props":29306,"children":29307},{},[29308],{"type":49,"tag":58,"props":29309,"children":29310},{},[29311,29313,29318,29320,29325],{"type":55,"value":29312},"With CDK, the CI pipeline that calls ",{"type":49,"tag":326,"props":29314,"children":29316},{"className":29315},[],[29317],{"type":55,"value":26093},{"type":55,"value":29319}," fails if ",{"type":49,"tag":326,"props":29321,"children":29323},{"className":29322},[],[29324],{"type":55,"value":26093},{"type":55,"value":29326}," results in a stack rollback.",{"type":49,"tag":58,"props":29328,"children":29329},{},[29330,29332,29337,29339,29344],{"type":55,"value":29331},"I couldn't find any examples of how to run ",{"type":49,"tag":326,"props":29333,"children":29335},{"className":29334},[],[29336],{"type":55,"value":26093},{"type":55,"value":29338}," in a GitLab CI pipeline (using the Python version of CDK, or any version of CDK). It would be nice if there was an official image maintained for the different languages that are ready to run CDK deploy. Here's how I got ",{"type":49,"tag":326,"props":29340,"children":29342},{"className":29341},[],[29343],{"type":55,"value":26093},{"type":55,"value":29345}," working correctly in my CI/CD pipline:",{"type":49,"tag":1050,"props":29347,"children":29349},{"code":29348,"language":3823,"meta":8,"className":3824,"style":8},"cdk deploy:\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  stage: deploy\n  only:\n    - master\n  variables:\n    ENVIRONMENT: dev\n    DOCKER_TLS_CERTDIR: ''\n  before_script:\n    - apk add nodejs-current npm\n    - npm i -g aws-cdk\n    - apk add --no-cache python3\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n",[29350],{"type":49,"tag":326,"props":29351,"children":29352},{"__ignoreMap":8},[29353,29364,29379,29390,29401,29416,29428,29440,29451,29468,29485,29496,29508,29519,29531,29542,29553,29564],{"type":49,"tag":1060,"props":29354,"children":29355},{"class":1062,"line":1063},[29356,29360],{"type":49,"tag":1060,"props":29357,"children":29358},{"style":3839},[29359],{"type":55,"value":26093},{"type":49,"tag":1060,"props":29361,"children":29362},{"style":1073},[29363],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29365,"children":29366},{"class":1062,"line":1079},[29367,29371,29375],{"type":49,"tag":1060,"props":29368,"children":29369},{"style":3839},[29370],{"type":55,"value":18278},{"type":49,"tag":1060,"props":29372,"children":29373},{"style":1073},[29374],{"type":55,"value":78},{"type":49,"tag":1060,"props":29376,"children":29377},{"style":2215},[29378],{"type":55,"value":18287},{"type":49,"tag":1060,"props":29380,"children":29381},{"class":1062,"line":1088},[29382,29386],{"type":49,"tag":1060,"props":29383,"children":29384},{"style":3839},[29385],{"type":55,"value":18295},{"type":49,"tag":1060,"props":29387,"children":29388},{"style":1073},[29389],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29391,"children":29392},{"class":1062,"line":1097},[29393,29397],{"type":49,"tag":1060,"props":29394,"children":29395},{"style":1073},[29396],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29398,"children":29399},{"style":2215},[29400],{"type":55,"value":18311},{"type":49,"tag":1060,"props":29402,"children":29403},{"class":1062,"line":1111},[29404,29408,29412],{"type":49,"tag":1060,"props":29405,"children":29406},{"style":3839},[29407],{"type":55,"value":18261},{"type":49,"tag":1060,"props":29409,"children":29410},{"style":1073},[29411],{"type":55,"value":78},{"type":49,"tag":1060,"props":29413,"children":29414},{"style":2215},[29415],{"type":55,"value":19149},{"type":49,"tag":1060,"props":29417,"children":29418},{"class":1062,"line":1120},[29419,29424],{"type":49,"tag":1060,"props":29420,"children":29421},{"style":3839},[29422],{"type":55,"value":29423},"  only",{"type":49,"tag":1060,"props":29425,"children":29426},{"style":1073},[29427],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29429,"children":29430},{"class":1062,"line":1128},[29431,29435],{"type":49,"tag":1060,"props":29432,"children":29433},{"style":1073},[29434],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29436,"children":29437},{"style":2215},[29438],{"type":55,"value":29439},"master\n",{"type":49,"tag":1060,"props":29441,"children":29442},{"class":1062,"line":1141},[29443,29447],{"type":49,"tag":1060,"props":29444,"children":29445},{"style":3839},[29446],{"type":55,"value":19194},{"type":49,"tag":1060,"props":29448,"children":29449},{"style":1073},[29450],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29452,"children":29453},{"class":1062,"line":1150},[29454,29459,29463],{"type":49,"tag":1060,"props":29455,"children":29456},{"style":3839},[29457],{"type":55,"value":29458},"    ENVIRONMENT",{"type":49,"tag":1060,"props":29460,"children":29461},{"style":1073},[29462],{"type":55,"value":78},{"type":49,"tag":1060,"props":29464,"children":29465},{"style":2215},[29466],{"type":55,"value":29467},"dev\n",{"type":49,"tag":1060,"props":29469,"children":29470},{"class":1062,"line":1158},[29471,29476,29480],{"type":49,"tag":1060,"props":29472,"children":29473},{"style":3839},[29474],{"type":55,"value":29475},"    DOCKER_TLS_CERTDIR",{"type":49,"tag":1060,"props":29477,"children":29478},{"style":1073},[29479],{"type":55,"value":78},{"type":49,"tag":1060,"props":29481,"children":29482},{"style":2215},[29483],{"type":55,"value":29484},"''\n",{"type":49,"tag":1060,"props":29486,"children":29487},{"class":1062,"line":1171},[29488,29492],{"type":49,"tag":1060,"props":29489,"children":29490},{"style":3839},[29491],{"type":55,"value":18319},{"type":49,"tag":1060,"props":29493,"children":29494},{"style":1073},[29495],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29497,"children":29498},{"class":1062,"line":1180},[29499,29503],{"type":49,"tag":1060,"props":29500,"children":29501},{"style":1073},[29502],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29504,"children":29505},{"style":2215},[29506],{"type":55,"value":29507},"apk add nodejs-current npm\n",{"type":49,"tag":1060,"props":29509,"children":29510},{"class":1062,"line":1188},[29511,29515],{"type":49,"tag":1060,"props":29512,"children":29513},{"style":1073},[29514],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29516,"children":29517},{"style":2215},[29518],{"type":55,"value":26555},{"type":49,"tag":1060,"props":29520,"children":29521},{"class":1062,"line":1201},[29522,29526],{"type":49,"tag":1060,"props":29523,"children":29524},{"style":1073},[29525],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29527,"children":29528},{"style":2215},[29529],{"type":55,"value":29530},"apk add --no-cache python3\n",{"type":49,"tag":1060,"props":29532,"children":29533},{"class":1062,"line":1210},[29534,29538],{"type":49,"tag":1060,"props":29535,"children":29536},{"style":1073},[29537],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29539,"children":29540},{"style":2215},[29541],{"type":55,"value":26567},{"type":49,"tag":1060,"props":29543,"children":29544},{"class":1062,"line":1218},[29545,29549],{"type":49,"tag":1060,"props":29546,"children":29547},{"style":3839},[29548],{"type":55,"value":18343},{"type":49,"tag":1060,"props":29550,"children":29551},{"style":1073},[29552],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29554,"children":29555},{"class":1062,"line":1232},[29556,29560],{"type":49,"tag":1060,"props":29557,"children":29558},{"style":1073},[29559],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29561,"children":29562},{"style":2215},[29563],{"type":55,"value":26590},{"type":49,"tag":1060,"props":29565,"children":29566},{"class":1062,"line":1241},[29567,29571],{"type":49,"tag":1060,"props":29568,"children":29569},{"style":1073},[29570],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29572,"children":29573},{"style":2215},[29574],{"type":55,"value":26602},{"type":49,"tag":58,"props":29576,"children":29577},{},[29578,29580,29585,29587,29592,29594,29600],{"type":55,"value":29579},"I have all of my CDK code in a top level directory called ",{"type":49,"tag":326,"props":29581,"children":29583},{"className":29582},[],[29584],{"type":55,"value":26022},{"type":55,"value":29586},", my Django code is in the top level ",{"type":49,"tag":326,"props":29588,"children":29590},{"className":29589},[],[29591],{"type":55,"value":1951},{"type":55,"value":29593}," directory and my frontend code is in the top level ",{"type":49,"tag":326,"props":29595,"children":29597},{"className":29596},[],[29598],{"type":55,"value":29599},"quasar",{"type":55,"value":29601}," directory. This directory structure is important, I'll come back to it shortly. Here are some things to note about this GitLab CI job definition:",{"type":49,"tag":64,"props":29603,"children":29604},{},[29605,29655,29681],{"type":49,"tag":68,"props":29606,"children":29607},{},[29608,29610,29615,29617,29623,29625,29630,29632,29638,29640,29646,29648,29653],{"type":55,"value":29609},"It uses the base ",{"type":49,"tag":326,"props":29611,"children":29613},{"className":29612},[],[29614],{"type":55,"value":24},{"type":55,"value":29616}," image with ",{"type":49,"tag":326,"props":29618,"children":29620},{"className":29619},[],[29621],{"type":55,"value":29622},"docker:dind",{"type":55,"value":29624}," as a dependent service. This is necessary only if you hare using CDK constructs that build docker images and make use of ",{"type":49,"tag":326,"props":29626,"children":29628},{"className":29627},[],[29629],{"type":55,"value":26172},{"type":55,"value":29631},", such as the ",{"type":49,"tag":326,"props":29633,"children":29635},{"className":29634},[],[29636],{"type":55,"value":29637},"aws_ecs.AssetImage",{"type":55,"value":29639}," that I use to define ",{"type":49,"tag":326,"props":29641,"children":29643},{"className":29642},[],[29644],{"type":55,"value":29645},"self.image",{"type":55,"value":29647}," in the ",{"type":49,"tag":326,"props":29649,"children":29651},{"className":29650},[],[29652],{"type":55,"value":28161},{"type":55,"value":29654}," class that defines that main stack of my application.",{"type":49,"tag":68,"props":29656,"children":29657},{},[29658,29660,29665,29667,29672,29674,29679],{"type":55,"value":29659},"It requires node, npm python and pip, so these all need to be installed via ",{"type":49,"tag":326,"props":29661,"children":29663},{"className":29662},[],[29664],{"type":55,"value":19418},{"type":55,"value":29666},", the package manager for Alpine Linux. These are done in the ",{"type":49,"tag":326,"props":29668,"children":29670},{"className":29669},[],[29671],{"type":55,"value":18716},{"type":55,"value":29673},", the setup for the main \"script\" where ",{"type":49,"tag":326,"props":29675,"children":29677},{"className":29676},[],[29678],{"type":55,"value":26093},{"type":55,"value":29680}," is called.",{"type":49,"tag":68,"props":29682,"children":29683},{},[29684,29686,29692,29694,29699,29701,29706],{"type":55,"value":29685},"The main ",{"type":49,"tag":326,"props":29687,"children":29689},{"className":29688},[],[29690],{"type":55,"value":29691},"script",{"type":55,"value":29693}," section calls ",{"type":49,"tag":326,"props":29695,"children":29697},{"className":29696},[],[29698],{"type":55,"value":26172},{"type":55,"value":29700},". You only need to call ",{"type":49,"tag":326,"props":29702,"children":29704},{"className":29703},[],[29705],{"type":55,"value":26172},{"type":55,"value":29707}," once to initialize resources that CDK will use, so placing it here in my CI script is more of a reminder that we are using CDK assets (S3 buckets and ECR images); calling it again once it has been called initially on your AWS account does nothing, and you will see a message that communicates this:",{"type":49,"tag":1050,"props":29709,"children":29711},{"code":29710}," $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n  â³  Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n  â  Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n",[29712],{"type":49,"tag":326,"props":29713,"children":29714},{"__ignoreMap":8},[29715],{"type":55,"value":29710},{"type":49,"tag":430,"props":29717,"children":29719},{"id":29718},"cdk-bootstap",[29720],{"type":49,"tag":326,"props":29721,"children":29723},{"className":29722},[],[29724],{"type":55,"value":29725},"cdk bootstap",{"type":49,"tag":58,"props":29727,"children":29728},{},[29729,29734],{"type":49,"tag":326,"props":29730,"children":29732},{"className":29731},[],[29733],{"type":55,"value":26172},{"type":55,"value":29735}," is one of my favorite features of CDK. As I mentioned earlier, it is used with S3 and ECR.",{"type":49,"tag":27484,"props":29737,"children":29739},{"id":29738},"s3-assets",[29740],{"type":55,"value":29741},"S3 Assets",{"type":49,"tag":58,"props":29743,"children":29744},{},[29745,29747,29752],{"type":55,"value":29746},"With S3, it allows you to populate the contents of an S3 bucket. Here's an example from ",{"type":49,"tag":326,"props":29748,"children":29750},{"className":29749},[],[29751],{"type":55,"value":28161},{"type":55,"value":6694},{"type":49,"tag":1050,"props":29754,"children":29756},{"code":29755,"language":28337,"meta":8,"className":28338,"style":8},"        if os.path.isdir(\"./quasar/dist/pwa\"):\n            s3_deployment.BucketDeployment(\n                self,\n                \"BucketDeployment\",\n                destination_bucket=self.static_site_bucket,\n                sources=[s3_deployment.Source.asset(\"./quasar/dist/pwa\")],\n                distribution=self.cloudfront.distribution,\n            )\n",[29757],{"type":49,"tag":326,"props":29758,"children":29759},{"__ignoreMap":8},[29760,29782,29790,29802,29814,29835,29861,29882],{"type":49,"tag":1060,"props":29761,"children":29762},{"class":1062,"line":1063},[29763,29768,29773,29778],{"type":49,"tag":1060,"props":29764,"children":29765},{"style":2194},[29766],{"type":55,"value":29767},"        if",{"type":49,"tag":1060,"props":29769,"children":29770},{"style":1073},[29771],{"type":55,"value":29772}," os.path.isdir(",{"type":49,"tag":1060,"props":29774,"children":29775},{"style":2215},[29776],{"type":55,"value":29777},"\"./quasar/dist/pwa\"",{"type":49,"tag":1060,"props":29779,"children":29780},{"style":1073},[29781],{"type":55,"value":22242},{"type":49,"tag":1060,"props":29783,"children":29784},{"class":1062,"line":1079},[29785],{"type":49,"tag":1060,"props":29786,"children":29787},{"style":1073},[29788],{"type":55,"value":29789},"            s3_deployment.BucketDeployment(\n",{"type":49,"tag":1060,"props":29791,"children":29792},{"class":1062,"line":1088},[29793,29798],{"type":49,"tag":1060,"props":29794,"children":29795},{"style":3797},[29796],{"type":55,"value":29797},"                self",{"type":49,"tag":1060,"props":29799,"children":29800},{"style":1073},[29801],{"type":55,"value":2497},{"type":49,"tag":1060,"props":29803,"children":29804},{"class":1062,"line":1097},[29805,29810],{"type":49,"tag":1060,"props":29806,"children":29807},{"style":2215},[29808],{"type":55,"value":29809},"                \"BucketDeployment\"",{"type":49,"tag":1060,"props":29811,"children":29812},{"style":1073},[29813],{"type":55,"value":2497},{"type":49,"tag":1060,"props":29815,"children":29816},{"class":1062,"line":1111},[29817,29822,29826,29830],{"type":49,"tag":1060,"props":29818,"children":29819},{"style":22635},[29820],{"type":55,"value":29821},"                destination_bucket",{"type":49,"tag":1060,"props":29823,"children":29824},{"style":2194},[29825],{"type":55,"value":3068},{"type":49,"tag":1060,"props":29827,"children":29828},{"style":3797},[29829],{"type":55,"value":22963},{"type":49,"tag":1060,"props":29831,"children":29832},{"style":1073},[29833],{"type":55,"value":29834},".static_site_bucket,\n",{"type":49,"tag":1060,"props":29836,"children":29837},{"class":1062,"line":1120},[29838,29843,29847,29852,29856],{"type":49,"tag":1060,"props":29839,"children":29840},{"style":22635},[29841],{"type":55,"value":29842},"                sources",{"type":49,"tag":1060,"props":29844,"children":29845},{"style":2194},[29846],{"type":55,"value":3068},{"type":49,"tag":1060,"props":29848,"children":29849},{"style":1073},[29850],{"type":55,"value":29851},"[s3_deployment.Source.asset(",{"type":49,"tag":1060,"props":29853,"children":29854},{"style":2215},[29855],{"type":55,"value":29777},{"type":49,"tag":1060,"props":29857,"children":29858},{"style":1073},[29859],{"type":55,"value":29860},")],\n",{"type":49,"tag":1060,"props":29862,"children":29863},{"class":1062,"line":1128},[29864,29869,29873,29877],{"type":49,"tag":1060,"props":29865,"children":29866},{"style":22635},[29867],{"type":55,"value":29868},"                distribution",{"type":49,"tag":1060,"props":29870,"children":29871},{"style":2194},[29872],{"type":55,"value":3068},{"type":49,"tag":1060,"props":29874,"children":29875},{"style":3797},[29876],{"type":55,"value":22963},{"type":49,"tag":1060,"props":29878,"children":29879},{"style":1073},[29880],{"type":55,"value":29881},".cloudfront.distribution,\n",{"type":49,"tag":1060,"props":29883,"children":29884},{"class":1062,"line":1141},[29885],{"type":49,"tag":1060,"props":29886,"children":29887},{"style":1073},[29888],{"type":55,"value":29889},"            )\n",{"type":49,"tag":58,"props":29891,"children":29892},{},[29893,29895,29901,29903,29909,29911,29917,29919,29924],{"type":55,"value":29894},"If the directory ",{"type":49,"tag":326,"props":29896,"children":29898},{"className":29897},[],[29899],{"type":55,"value":29900},"./quasar/dist/pwa",{"type":55,"value":29902}," exists, CDK will upload the contents of that directory to the ",{"type":49,"tag":326,"props":29904,"children":29906},{"className":29905},[],[29907],{"type":55,"value":29908},"static_site_bucket",{"type":55,"value":29910}," and then invalidate the cache for ",{"type":49,"tag":326,"props":29912,"children":29914},{"className":29913},[],[29915],{"type":55,"value":29916},"self.cloudfront.distribution",{"type":55,"value":29918},", all in one shot. ",{"type":49,"tag":326,"props":29920,"children":29922},{"className":29921},[],[29923],{"type":55,"value":29900},{"type":55,"value":29925}," is the directory where assets from my frontend PWA are placed when compiled. GitLab CI passes these files between the jobs using artifacts:",{"type":49,"tag":1050,"props":29927,"children":29929},{"code":29928,"language":3823,"meta":8,"className":3824,"style":8},"artifacts:\n  paths:\n    - quasar/dist/pwa\n",[29930],{"type":49,"tag":326,"props":29931,"children":29932},{"__ignoreMap":8},[29933,29945,29957],{"type":49,"tag":1060,"props":29934,"children":29935},{"class":1062,"line":1063},[29936,29941],{"type":49,"tag":1060,"props":29937,"children":29938},{"style":3839},[29939],{"type":55,"value":29940},"artifacts",{"type":49,"tag":1060,"props":29942,"children":29943},{"style":1073},[29944],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29946,"children":29947},{"class":1062,"line":1079},[29948,29953],{"type":49,"tag":1060,"props":29949,"children":29950},{"style":3839},[29951],{"type":55,"value":29952},"  paths",{"type":49,"tag":1060,"props":29954,"children":29955},{"style":1073},[29956],{"type":55,"value":6862},{"type":49,"tag":1060,"props":29958,"children":29959},{"class":1062,"line":1088},[29960,29964],{"type":49,"tag":1060,"props":29961,"children":29962},{"style":1073},[29963],{"type":55,"value":6899},{"type":49,"tag":1060,"props":29965,"children":29966},{"style":2215},[29967],{"type":55,"value":29968},"quasar/dist/pwa\n",{"type":49,"tag":58,"props":29970,"children":29971},{},[29972,29974,29979,29981,29987],{"type":55,"value":29973},"The job to build PWA assets can be set to only run when there are changes in the ",{"type":49,"tag":326,"props":29975,"children":29977},{"className":29976},[],[29978],{"type":55,"value":29599},{"type":55,"value":29980}," directory, so the ",{"type":49,"tag":326,"props":29982,"children":29984},{"className":29983},[],[29985],{"type":55,"value":29986},".quasar/dist/pwa",{"type":55,"value":29988}," directory will only exist if the job is executed. This helps speed up our CI/CD pipeline.",{"type":49,"tag":27484,"props":29990,"children":29992},{"id":29991},"ecr-assets",[29993],{"type":55,"value":29994},"ECR Assets",{"type":49,"tag":58,"props":29996,"children":29997},{},[29998,30000,30006,30008,30013],{"type":55,"value":29999},"I use ",{"type":49,"tag":326,"props":30001,"children":30003},{"className":30002},[],[30004],{"type":55,"value":30005},"cdk boostrap",{"type":55,"value":30007}," and CDK assets in a similar way for building and pushing my application container. In ",{"type":49,"tag":326,"props":30009,"children":30011},{"className":30010},[],[30012],{"type":55,"value":28161},{"type":55,"value":30014},", I define the following:",{"type":49,"tag":1050,"props":30016,"children":30018},{"code":30017,"language":28337,"meta":8,"className":28338,"style":8},"        self.image = ecs.AssetImage(\n            \"./backend\", file=\"scripts/prod/Dockerfile\", target=\"production\",\n        )\n",[30019],{"type":49,"tag":326,"props":30020,"children":30021},{"__ignoreMap":8},[30022,30043,30091],{"type":49,"tag":1060,"props":30023,"children":30024},{"class":1062,"line":1063},[30025,30029,30034,30038],{"type":49,"tag":1060,"props":30026,"children":30027},{"style":3797},[30028],{"type":55,"value":22915},{"type":49,"tag":1060,"props":30030,"children":30031},{"style":1073},[30032],{"type":55,"value":30033},".image ",{"type":49,"tag":1060,"props":30035,"children":30036},{"style":2194},[30037],{"type":55,"value":3068},{"type":49,"tag":1060,"props":30039,"children":30040},{"style":1073},[30041],{"type":55,"value":30042}," ecs.AssetImage(\n",{"type":49,"tag":1060,"props":30044,"children":30045},{"class":1062,"line":1079},[30046,30051,30055,30060,30064,30069,30073,30078,30082,30087],{"type":49,"tag":1060,"props":30047,"children":30048},{"style":2215},[30049],{"type":55,"value":30050},"            \"./backend\"",{"type":49,"tag":1060,"props":30052,"children":30053},{"style":1073},[30054],{"type":55,"value":873},{"type":49,"tag":1060,"props":30056,"children":30057},{"style":22635},[30058],{"type":55,"value":30059},"file",{"type":49,"tag":1060,"props":30061,"children":30062},{"style":2194},[30063],{"type":55,"value":3068},{"type":49,"tag":1060,"props":30065,"children":30066},{"style":2215},[30067],{"type":55,"value":30068},"\"scripts/prod/Dockerfile\"",{"type":49,"tag":1060,"props":30070,"children":30071},{"style":1073},[30072],{"type":55,"value":873},{"type":49,"tag":1060,"props":30074,"children":30075},{"style":22635},[30076],{"type":55,"value":30077},"target",{"type":49,"tag":1060,"props":30079,"children":30080},{"style":2194},[30081],{"type":55,"value":3068},{"type":49,"tag":1060,"props":30083,"children":30084},{"style":2215},[30085],{"type":55,"value":30086},"\"production\"",{"type":49,"tag":1060,"props":30088,"children":30089},{"style":1073},[30090],{"type":55,"value":2497},{"type":49,"tag":1060,"props":30092,"children":30093},{"class":1062,"line":1088},[30094],{"type":49,"tag":1060,"props":30095,"children":30096},{"style":1073},[30097],{"type":55,"value":22976},{"type":49,"tag":58,"props":30099,"children":30100},{},[30101,30103,30108,30110,30116,30117,30123,30124,30129,30131,30136],{"type":55,"value":30102},"This image is then referenced by multiple ",{"type":49,"tag":326,"props":30104,"children":30106},{"className":30105},[],[30107],{"type":55,"value":29140},{"type":55,"value":30109},"s that define Fargate services and tasks (",{"type":49,"tag":326,"props":30111,"children":30113},{"className":30112},[],[30114],{"type":55,"value":30115},"gunicorn",{"type":55,"value":873},{"type":49,"tag":326,"props":30118,"children":30120},{"className":30119},[],[30121],{"type":55,"value":30122},"daphne",{"type":55,"value":873},{"type":49,"tag":326,"props":30125,"children":30127},{"className":30126},[],[30128],{"type":55,"value":3261},{"type":55,"value":30130}," workers, etc.) This keeps our CDK code DRY.. Don't Repeat Yourself! Similarly, we aren't rebuilding, pushing and pulling the backend container when there are no changes to the code in ",{"type":49,"tag":326,"props":30132,"children":30134},{"className":30133},[],[30135],{"type":55,"value":1951},{"type":55,"value":30137}," directory.",{"type":49,"tag":58,"props":30139,"children":30140},{},[30141,30143,30149,30151,30156],{"type":55,"value":30142},"I'm not setting up an ECR image repository for my application, but I believe there is a way to do this. One question that I have about using ",{"type":49,"tag":326,"props":30144,"children":30146},{"className":30145},[],[30147],{"type":55,"value":30148},"ecs.AssetImage",{"type":55,"value":30150}," is about image lifecycle management. I know that you can implement rules about how many images you want to keep in an ECR image repository, but ",{"type":49,"tag":72,"props":30152,"children":30153},{},[30154],{"type":55,"value":30155},"I'm not sure how this works with CDK Image Assets",{"type":55,"value":745},{"type":49,"tag":430,"props":30158,"children":30160},{"id":30159},"quick-tour-of-applicationstack",[30161,30163],{"type":55,"value":30162},"Quick tour of ",{"type":49,"tag":326,"props":30164,"children":30166},{"className":30165},[],[30167],{"type":55,"value":28161},{"type":49,"tag":58,"props":30169,"children":30170},{},[30171,30173,30178],{"type":55,"value":30172},"Here's a very quick look at the structure of my CDK code, focusing on the ",{"type":49,"tag":326,"props":30174,"children":30176},{"className":30175},[],[30177],{"type":55,"value":28161},{"type":55,"value":30179},", the \"master stack\" or \"skeleton stack\" that contains.",{"type":49,"tag":27484,"props":30181,"children":30183},{"id":30182},"hosted_zone",[30184],{"type":49,"tag":326,"props":30185,"children":30187},{"className":30186},[],[30188],{"type":55,"value":30182},{"type":49,"tag":58,"props":30190,"children":30191},{},[30192,30194,30199,30200,30205],{"type":55,"value":30193},"We get the hosted zone using the ",{"type":49,"tag":326,"props":30195,"children":30197},{"className":30196},[],[30198],{"type":55,"value":13132},{"type":55,"value":715},{"type":49,"tag":326,"props":30201,"children":30203},{"className":30202},[],[30204],{"type":55,"value":25927},{"type":55,"value":30206},". This is not a nested stack.",{"type":49,"tag":27484,"props":30208,"children":30210},{"id":30209},"site_certificate",[30211],{"type":49,"tag":326,"props":30212,"children":30214},{"className":30213},[],[30215],{"type":55,"value":30209},{"type":49,"tag":58,"props":30217,"children":30218},{},[30219,30221,30226],{"type":55,"value":30220},"The ACM Certificate that will be used for the given environment. This references the ",{"type":49,"tag":326,"props":30222,"children":30224},{"className":30223},[],[30225],{"type":55,"value":28231},{"type":55,"value":30227}," (environment + application).",{"type":49,"tag":27484,"props":30229,"children":30231},{"id":30230},"vpc_stack",[30232],{"type":49,"tag":326,"props":30233,"children":30235},{"className":30234},[],[30236],{"type":55,"value":30230},{"type":49,"tag":58,"props":30238,"children":30239},{},[30240,30242,30247,30249,30255,30257,30262,30263,30269,30271,30276],{"type":55,"value":30241},"A ",{"type":49,"tag":326,"props":30243,"children":30245},{"className":30244},[],[30246],{"type":55,"value":29140},{"type":55,"value":30248}," for defining VPC resources. This construct generates lots of CloudFormation resources. I currently have ",{"type":49,"tag":326,"props":30250,"children":30252},{"className":30251},[],[30253],{"type":55,"value":30254},"nat_gateways",{"type":55,"value":30256}," set to zero, and I'm ",{"type":49,"tag":326,"props":30258,"children":30260},{"className":30259},[],[30261],{"type":55,"value":24286},{"type":55,"value":715},{"type":49,"tag":326,"props":30264,"children":30266},{"className":30265},[],[30267],{"type":55,"value":30268},"PRIVATE",{"type":55,"value":30270}," subnets spread over 2 AZs. As I mentioned earlier, this is primarily for cost considerations and it is a best practice to use the tiered security model and run our Fargate tasks in private subnets instead of public subnets. I think I need to add NACL resources in this ",{"type":49,"tag":326,"props":30272,"children":30274},{"className":30273},[],[30275],{"type":55,"value":29140},{"type":55,"value":745},{"type":49,"tag":27484,"props":30278,"children":30280},{"id":30279},"alb_stack",[30281],{"type":49,"tag":326,"props":30282,"children":30284},{"className":30283},[],[30285],{"type":55,"value":30279},{"type":49,"tag":58,"props":30287,"children":30288},{},[30289,30291,30297,30298,30304,30306,30311,30313,30318],{"type":55,"value":30290},"This defines the load balancer, configures that will send traffic to our Fargate services (such as our Django API). I was a little bit unclear about needing a ",{"type":49,"tag":326,"props":30292,"children":30294},{"className":30293},[],[30295],{"type":55,"value":30296},"listener",{"type":55,"value":715},{"type":49,"tag":326,"props":30299,"children":30301},{"className":30300},[],[30302],{"type":55,"value":30303},"https_listener",{"type":55,"value":30305},". I might be able to get away with removing the ",{"type":49,"tag":326,"props":30307,"children":30309},{"className":30308},[],[30310],{"type":55,"value":30296},{"type":55,"value":30312}," and only using ",{"type":49,"tag":326,"props":30314,"children":30316},{"className":30315},[],[30317],{"type":55,"value":30303},{"type":55,"value":745},{"type":49,"tag":27484,"props":30320,"children":30322},{"id":30321},"static_site_stack",[30323],{"type":49,"tag":326,"props":30324,"children":30326},{"className":30325},[],[30327],{"type":55,"value":30321},{"type":49,"tag":58,"props":30329,"children":30330},{},[30331],{"type":55,"value":30332},"This stack defines the S3 bucket and policies that will be used for hosting our static site (Quasar PWA).",{"type":49,"tag":27484,"props":30334,"children":30336},{"id":30335},"backend_assets",[30337],{"type":49,"tag":326,"props":30338,"children":30340},{"className":30339},[],[30341],{"type":55,"value":30335},{"type":49,"tag":58,"props":30343,"children":30344},{},[30345],{"type":55,"value":30346},"This stack defines the bucket and policies for managing the bucket that holds static and media assets for Django.",{"type":49,"tag":27484,"props":30348,"children":30350},{"id":30349},"cloudfront",[30351],{"type":49,"tag":326,"props":30352,"children":30354},{"className":30353},[],[30355],{"type":55,"value":30349},{"type":49,"tag":58,"props":30357,"children":30358},{},[30359,30361,30367],{"type":55,"value":30360},"This defines the CloudFront distribution that ties together several different parts of the application. It is the \"front desk\" of the application, and acts as a CDN and proxy. There is a separate CloudFront distribution for each environment (dev, staging, production). This stack also defines the Route53 ",{"type":49,"tag":326,"props":30362,"children":30364},{"className":30363},[],[30365],{"type":55,"value":30366},"ARecord",{"type":55,"value":30368}," that will be used to send traffic to a specific subdomain to the correct CloudFront distribution.",{"type":49,"tag":58,"props":30370,"children":30371},{},[30372,30374,30380],{"type":55,"value":30373},"There are three ",{"type":49,"tag":326,"props":30375,"children":30377},{"className":30376},[],[30378],{"type":55,"value":30379},"origin_configs",{"type":55,"value":30381}," for each distribution:",{"type":49,"tag":8994,"props":30383,"children":30384},{},[30385,30396,30406],{"type":49,"tag":68,"props":30386,"children":30387},{},[30388,30394],{"type":49,"tag":326,"props":30389,"children":30391},{"className":30390},[],[30392],{"type":55,"value":30393},"CustomOriginConfig",{"type":55,"value":30395}," for the ALB",{"type":49,"tag":68,"props":30397,"children":30398},{},[30399,30404],{"type":49,"tag":326,"props":30400,"children":30402},{"className":30401},[],[30403],{"type":55,"value":30393},{"type":55,"value":30405}," for the S3 bucket website",{"type":49,"tag":68,"props":30407,"children":30408},{},[30409,30415],{"type":49,"tag":326,"props":30410,"children":30412},{"className":30411},[],[30413],{"type":55,"value":30414},"S3OriginConfig",{"type":55,"value":30416}," for the Django static assets",{"type":49,"tag":58,"props":30418,"children":30419},{},[30420,30422,30427,30429,30435],{"type":55,"value":30421},"Note that these ",{"type":49,"tag":326,"props":30423,"children":30425},{"className":30424},[],[30426],{"type":55,"value":30379},{"type":55,"value":30428}," each have different ",{"type":49,"tag":326,"props":30430,"children":30432},{"className":30431},[],[30433],{"type":55,"value":30434},"behaviors",{"type":55,"value":30436},", and that list comprehension is used to keep this code DRY.",{"type":49,"tag":27484,"props":30438,"children":30440},{"id":30439},"bucketdeployment",[30441],{"type":49,"tag":326,"props":30442,"children":30444},{"className":30443},[],[30445],{"type":55,"value":30446},"BucketDeployment",{"type":49,"tag":58,"props":30448,"children":30449},{},[30450,30452,30457],{"type":55,"value":30451},"This will deploy our static site assets to the S3 bucket defined in ",{"type":49,"tag":326,"props":30453,"children":30455},{"className":30454},[],[30456],{"type":55,"value":30321},{"type":55,"value":30458}," if the static site assets are present at the time of deployment. If they are not present, this means that there were no changes made to the frontend site.",{"type":49,"tag":27484,"props":30460,"children":30461},{"id":21},[30462],{"type":49,"tag":326,"props":30463,"children":30465},{"className":30464},[],[30466],{"type":55,"value":21},{"type":49,"tag":58,"props":30468,"children":30469},{},[30470],{"type":55,"value":30471},"Defines the ECS Cluster.",{"type":49,"tag":27484,"props":30473,"children":30474},{"id":1929},[30475],{"type":49,"tag":326,"props":30476,"children":30478},{"className":30477},[],[30479],{"type":55,"value":1929},{"type":49,"tag":58,"props":30481,"children":30482},{},[30483,30485,30491,30493,30498,30500,30506,30507,30512,30513,30519],{"type":55,"value":30484},"There is no L2 construct for ",{"type":49,"tag":326,"props":30486,"children":30488},{"className":30487},[],[30489],{"type":55,"value":30490},"DBCluster",{"type":55,"value":30492},", so I used ",{"type":49,"tag":326,"props":30494,"children":30496},{"className":30495},[],[30497],{"type":55,"value":29107},{"type":55,"value":30499}," in order to use the Aurora Postgres ",{"type":49,"tag":326,"props":30501,"children":30503},{"className":30502},[],[30504],{"type":55,"value":30505},"engine",{"type":55,"value":6280},{"type":49,"tag":326,"props":30508,"children":30510},{"className":30509},[],[30511],{"type":55,"value":22047},{"type":55,"value":1909},{"type":49,"tag":326,"props":30514,"children":30516},{"className":30515},[],[30517],{"type":55,"value":30518},"engine_mode",{"type":55,"value":745},{"type":49,"tag":27484,"props":30521,"children":30523},{"id":30522},"elasticache",[30524],{"type":49,"tag":326,"props":30525,"children":30527},{"className":30526},[],[30528],{"type":55,"value":30522},{"type":49,"tag":58,"props":30530,"children":30531},{},[30532],{"type":55,"value":30533},"I also had to use L1 constructs for ElastiCache, but this one is pretty straightforward.",{"type":49,"tag":58,"props":30535,"children":30536},{},[30537,30539,30545,30547,30553],{"type":55,"value":30538},"For both RDS and ElastiCache I used the ",{"type":49,"tag":326,"props":30540,"children":30542},{"className":30541},[],[30543],{"type":55,"value":30544},"vpc_default_security_group",{"type":55,"value":30546}," as the ",{"type":49,"tag":326,"props":30548,"children":30550},{"className":30549},[],[30551],{"type":55,"value":30552},"source_security_group",{"type":55,"value":30554},". It might be a better idea to define another security group altogether, but this approach works.",{"type":49,"tag":27484,"props":30556,"children":30558},{"id":30557},"assetimage",[30559],{"type":49,"tag":326,"props":30560,"children":30562},{"className":30561},[],[30563],{"type":55,"value":30564},"AssetImage",{"type":49,"tag":58,"props":30566,"children":30567},{},[30568,30570,30575],{"type":55,"value":30569},"The docker image that references Django application code in the ",{"type":49,"tag":326,"props":30571,"children":30573},{"className":30572},[],[30574],{"type":55,"value":1951},{"type":55,"value":30576}," directory. This image is referenced in Fargate services and tasks.",{"type":49,"tag":27484,"props":30578,"children":30580},{"id":30579},"variables",[30581],{"type":49,"tag":326,"props":30582,"children":30584},{"className":30583},[],[30585],{"type":55,"value":30579},{"type":49,"tag":58,"props":30587,"children":30588},{},[30589],{"type":55,"value":30590},"This section defines and organizes all of the environment variables and secrets for my application.",{"type":49,"tag":27484,"props":30592,"children":30594},{"id":30593},"backend_service",[30595],{"type":49,"tag":326,"props":30596,"children":30598},{"className":30597},[],[30599],{"type":55,"value":30593},{"type":49,"tag":58,"props":30601,"children":30602},{},[30603,30605,30611],{"type":55,"value":30604},"It might be a better idea to replace this with ",{"type":49,"tag":326,"props":30606,"children":30608},{"className":30607},[],[30609],{"type":55,"value":30610},"NetworkLoadBalancedFargateService",{"type":55,"value":30612},", but instead I implemented this with lower-level constructs just to be clear about what I'm doing. To add a load balanced service, here is what I did:",{"type":49,"tag":8994,"props":30614,"children":30615},{},[30616,30621,30633,30646,30651,30656,30674],{"type":49,"tag":68,"props":30617,"children":30618},{},[30619],{"type":55,"value":30620},"Define the Fargate task",{"type":49,"tag":68,"props":30622,"children":30623},{},[30624,30626,30632],{"type":55,"value":30625},"Add the container to this task with other information (secrets, logging, ",{"type":49,"tag":326,"props":30627,"children":30629},{"className":30628},[],[30630],{"type":55,"value":30631},"command",{"type":55,"value":8407},{"type":49,"tag":68,"props":30634,"children":30635},{},[30636,30638,30644],{"type":55,"value":30637},"Give the task role permissions it needs such as access to Secrets, S3 permissions. (It might be a good idea to refactor this into a function that can be called on ",{"type":49,"tag":326,"props":30639,"children":30641},{"className":30640},[],[30642],{"type":55,"value":30643},"task_role",{"type":55,"value":30645},", but for now I am explicitly granting all permissions)",{"type":49,"tag":68,"props":30647,"children":30648},{},[30649],{"type":55,"value":30650},"Create and add a port mapping",{"type":49,"tag":68,"props":30652,"children":30653},{},[30654],{"type":55,"value":30655},"Define an ECS Fargate Service that reference the previously defined Fargate task, configure security group",{"type":49,"tag":68,"props":30657,"children":30658},{},[30659,30661,30666,30668,30673],{"type":55,"value":30660},"Add the service as a target to the ",{"type":49,"tag":326,"props":30662,"children":30664},{"className":30663},[],[30665],{"type":55,"value":30303},{"type":55,"value":30667}," defined previously in ",{"type":49,"tag":326,"props":30669,"children":30671},{"className":30670},[],[30672],{"type":55,"value":30279},{"type":55,"value":745},{"type":49,"tag":68,"props":30675,"children":30676},{},[30677],{"type":55,"value":30678},"Optionally configure autoscaling for the Fargate service",{"type":49,"tag":27484,"props":30680,"children":30682},{"id":30681},"flower_service",[30683],{"type":49,"tag":326,"props":30684,"children":30686},{"className":30685},[],[30687],{"type":55,"value":30681},{"type":49,"tag":58,"props":30689,"children":30690},{},[30691,30693],{"type":55,"value":30692},"Flower is a monitoring utility for Celery. I had trouble getting this to work correctly, but I managed to make it work by adding a simple nginx container that passes traffic to the flower container running in the same task. ",{"type":49,"tag":80,"props":30694,"children":30697},{"href":30695,"rel":30696},"https://flower.readthedocs.io/en/latest/reverse-proxy.html",[84],[30698],{"type":55,"value":30695},{"type":49,"tag":27484,"props":30700,"children":30702},{"id":30701},"celery_default_service",[30703],{"type":49,"tag":326,"props":30704,"children":30706},{"className":30705},[],[30707],{"type":55,"value":30701},{"type":49,"tag":58,"props":30709,"children":30710},{},[30711],{"type":55,"value":30712},"This stack defines the default celery queue. This is discussed later in more detail, but the basic idea is to:",{"type":49,"tag":8994,"props":30714,"children":30715},{},[30716,30720,30725,30730,30735],{"type":49,"tag":68,"props":30717,"children":30718},{},[30719],{"type":55,"value":30620},{"type":49,"tag":68,"props":30721,"children":30722},{},[30723],{"type":55,"value":30724},"Add the container",{"type":49,"tag":68,"props":30726,"children":30727},{},[30728],{"type":55,"value":30729},"Define the Fargate service",{"type":49,"tag":68,"props":30731,"children":30732},{},[30733],{"type":55,"value":30734},"Grant permissions",{"type":49,"tag":68,"props":30736,"children":30737},{},[30738],{"type":55,"value":30739},"Configure autoscaling",{"type":49,"tag":27484,"props":30741,"children":30743},{"id":30742},"celery_autoscaling",[30744],{"type":49,"tag":326,"props":30745,"children":30747},{"className":30746},[],[30748],{"type":55,"value":30742},{"type":49,"tag":58,"props":30750,"children":30751},{},[30752],{"type":55,"value":30753},"This stack defines the Lambda function and schedule on which this Lambda is called. This stack is discussed in more detail later on.",{"type":49,"tag":27484,"props":30755,"children":30757},{"id":30756},"backend_tasks",[30758],{"type":49,"tag":326,"props":30759,"children":30761},{"className":30760},[],[30762],{"type":55,"value":30756},{"type":49,"tag":58,"props":30764,"children":30765},{},[30766,30768,30773,30774,30779,30780,30785],{"type":55,"value":30767},"These are administrative tasks that are executed by running manual GitLab CI jobs such as ",{"type":49,"tag":326,"props":30769,"children":30771},{"className":30770},[],[30772],{"type":55,"value":3323},{"type":55,"value":873},{"type":49,"tag":326,"props":30775,"children":30777},{"className":30776},[],[30778],{"type":55,"value":3316},{"type":55,"value":715},{"type":49,"tag":326,"props":30781,"children":30783},{"className":30782},[],[30784],{"type":55,"value":21930},{"type":55,"value":745},{"type":49,"tag":50,"props":30787,"children":30789},{"id":30788},"why-x-why-not-y",[30790,30792,30798,30800,30806],{"type":55,"value":30791},"Why ",{"type":49,"tag":326,"props":30793,"children":30795},{"className":30794},[],[30796],{"type":55,"value":30797},"X",{"type":55,"value":30799},"? Why not ",{"type":49,"tag":326,"props":30801,"children":30803},{"className":30802},[],[30804],{"type":55,"value":30805},"Y",{"type":55,"value":30807},"?",{"type":49,"tag":58,"props":30809,"children":30810},{},[30811],{"type":55,"value":30812},"This section will compare some of the technology choices I have made in this project to other popular alternatives.",{"type":49,"tag":430,"props":30814,"children":30816},{"id":30815},"why-ecs-why-not-kubernetes",[30817],{"type":55,"value":30818},"Why ECS? Why not Kubernetes?",{"type":49,"tag":58,"props":30820,"children":30821},{},[30822,30824,30830],{"type":55,"value":30823},"I like Kubernetes. I have never used it to support production workloads, but I have explored it in a limited capacity. I have set up this project in Kubernetes locally using ",{"type":49,"tag":326,"props":30825,"children":30827},{"className":30826},[],[30828],{"type":55,"value":30829},"minikube",{"type":55,"value":30831},", there is an article on this in the documentation. There are also lots of options for how you do Kubernetes, here are a few off of the top of my head:",{"type":49,"tag":64,"props":30833,"children":30834},{},[30835,30840,30845,30850,30855,30860],{"type":49,"tag":68,"props":30836,"children":30837},{},[30838],{"type":55,"value":30839},"KOPS",{"type":49,"tag":68,"props":30841,"children":30842},{},[30843],{"type":55,"value":30844},"EKS",{"type":49,"tag":68,"props":30846,"children":30847},{},[30848],{"type":55,"value":30849},"k3s",{"type":49,"tag":68,"props":30851,"children":30852},{},[30853],{"type":55,"value":30854},"cdk8s",{"type":49,"tag":68,"props":30856,"children":30857},{},[30858],{"type":55,"value":30859},"Kubernetes on Fargate",{"type":49,"tag":68,"props":30861,"children":30862},{},[30863],{"type":55,"value":30864},"\"Kuberetes the Hard Way\"",{"type":49,"tag":58,"props":30866,"children":30867},{},[30868],{"type":55,"value":30869},"With any of these options you are probably going to want to use Helm to do deployments, which adds another layer of abstraction that also has several different ways to be managed. On the other hand, ECS is \"just ECS\"; there are not a lot of other considerations to make when running workloads in ECS. You have to choose between the two available launch types: EC2 and Fargate. Comparisons of ECS and Kubernetes often mention that ECS integrates nicely with other AWS Services, something I have generally found to be true in setting up this project. Granting permissions to S3 buckets or CloudWatch, or using security groups to give ECS tasks access to certain resources in your VPC are some examples of what this \"tight integration\" has meant for me so far.",{"type":49,"tag":430,"props":30871,"children":30873},{"id":30872},"why-django-why-not-flask",[30874],{"type":55,"value":30875},"Why Django? Why not Flask?",{"type":49,"tag":58,"props":30877,"children":30878},{},[30879],{"type":55,"value":30880},"I like Django for lots of reasons. I get why people say it can be \"overkill\", and there are definitely lots of parts of Django that don't use. I use Django primarily for the ORM, migrations system and the Django Admin. I also use the Django REST Framework, which gives me another big productivity boost when building APIs. I dislike Django Forms and Django templates, but that wasn't always the case. Before that, I disliked JavaScript frameworks and single page applications. That changes when I started working with Vue.js and Quasar.",{"type":49,"tag":430,"props":30882,"children":30884},{"id":30883},"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react",[30885],{"type":55,"value":30886},"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?",{"type":49,"tag":58,"props":30888,"children":30889},{},[30890],{"type":55,"value":30891},"Quasar Framework is a few different things, and just like Vue.js itself, Quasar can be incrementally adopted. Primarily, Quasar is a CLI for creating Vue.js projects. It offers some opinions on how to organize files and folders. It handles SPA, PWA, SSR, Electron, Cordova and other build targets. It implements the MaterialUI spec and it has an awesome and active community (but Django, GitLab and AWS do, too!)",{"type":49,"tag":58,"props":30893,"children":30894},{},[30895,30897,30903,30905,30910],{"type":55,"value":30896},"Quasar does things a little bit differently than vanilla Vue.js. There is no ",{"type":49,"tag":326,"props":30898,"children":30900},{"className":30899},[],[30901],{"type":55,"value":30902},"main.js",{"type":55,"value":30904}," file in a typical Quasar application. Instead, bootfiles are used to initialize things that would typically go into ",{"type":49,"tag":326,"props":30906,"children":30908},{"className":30907},[],[30909],{"type":55,"value":30902},{"type":55,"value":30911},". I believe this helps Quasar manage multiple build targets easily.",{"type":49,"tag":58,"props":30913,"children":30914},{},[30915],{"type":55,"value":30916},"I really haven't worked a lot with Nuxt.js, but I would probably be drawn to it if Quasar was not an option. I like how it helps structure your application. In the same way that Django is \"batteries included\", Quasar is also very much \"batteries included\".",{"type":49,"tag":58,"props":30918,"children":30919},{},[30920,30922,30927,30928,30934],{"type":55,"value":30921},"I think React is neat, but I have similar feelings between React and Vue that I have between Django and Flask. One requires you make more decisions and therefore has a heavy mental load. The biggest example of this is the tight integration of an official router and state management system for Vue (",{"type":49,"tag":326,"props":30923,"children":30925},{"className":30924},[],[30926],{"type":55,"value":27669},{"type":55,"value":715},{"type":49,"tag":326,"props":30929,"children":30931},{"className":30930},[],[30932],{"type":55,"value":30933},"vuex",{"type":55,"value":3213},{"type":49,"tag":430,"props":30936,"children":30938},{"id":30937},"why-celery-why-not-heuy-or-django-rq",[30939],{"type":55,"value":30940},"Why Celery? Why not Heuy or django-rq?",{"type":49,"tag":58,"props":30942,"children":30943},{},[30944],{"type":55,"value":30945},"I think celery is probably the most heavy-weight option for managing asynchronous tasks in Django. It is very flexible and \"pluggable\" which makes it slightly more challenging to get setup. I would be interested in trying another option, but celery is a mature option that has a large community of users.",{"type":49,"tag":50,"props":30947,"children":30949},{"id":30948},"scaling-celery-workers-to-zero",[30950],{"type":55,"value":30951},"Scaling Celery workers to zero",{"type":49,"tag":58,"props":30953,"children":30954},{},[30955],{"type":55,"value":30956},"Django is used in a few different ways in this application:",{"type":49,"tag":64,"props":30958,"children":30959},{},[30960,30965,30970,30975],{"type":49,"tag":68,"props":30961,"children":30962},{},[30963],{"type":55,"value":30964},"a backend API supported by Django REST Framework, Postgres and static files stored in AWS S3, served over CloudFront",{"type":49,"tag":68,"props":30966,"children":30967},{},[30968],{"type":55,"value":30969},"a websocket server supported by Django Channels",{"type":49,"tag":68,"props":30971,"children":30972},{},[30973],{"type":55,"value":30974},"an administrative backend that is automatically generated by Django (Django Admin)",{"type":49,"tag":68,"props":30976,"children":30977},{},[30978],{"type":55,"value":30979},"asynchronous task workers supported by Celery",{"type":49,"tag":58,"props":30981,"children":30982},{},[30983,30985,30990,30992,30997,30998,31004,31005,31010],{"type":55,"value":30984},"The API server, websocket server and Django admin can technically be served by the same ",{"type":49,"tag":326,"props":30986,"children":30988},{"className":30987},[],[30989],{"type":55,"value":30122},{"type":55,"value":30991}," process. In terms of our application and AWS architecture, this means that requests for URLs starting with ",{"type":49,"tag":326,"props":30993,"children":30995},{"className":30994},[],[30996],{"type":55,"value":16526},{"type":55,"value":873},{"type":49,"tag":326,"props":30999,"children":31001},{"className":31000},[],[31002],{"type":55,"value":31003},"/ws/",{"type":55,"value":715},{"type":49,"tag":326,"props":31006,"children":31008},{"className":31007},[],[31009],{"type":55,"value":16141},{"type":55,"value":31011}," can all be sent to the same Fargate service target group.",{"type":49,"tag":58,"props":31013,"children":31014},{},[31015],{"type":55,"value":31016},"Alternatively, we could split these up into two or three different process that can then be scaled individually.",{"type":49,"tag":58,"props":31018,"children":31019},{},[31020,31022,31028],{"type":55,"value":31021},"Celery processes should be run as separate processes. If you have multiple queues, you may have workers that are dedicated to processing tasks from certain queues which run as individual Fargate tasks, each with certain CPU and memory allocations and other celery settings, such as ",{"type":49,"tag":326,"props":31023,"children":31025},{"className":31024},[],[31026],{"type":55,"value":31027},"max_concurrency",{"type":55,"value":745},{"type":49,"tag":58,"props":31030,"children":31031},{},[31032,31034,31040],{"type":55,"value":31033},"To manage the total cost of ownership, I wanted to know how to scale Celery workers between 0 and ",{"type":49,"tag":326,"props":31035,"children":31037},{"className":31036},[],[31038],{"type":55,"value":31039},"N",{"type":55,"value":31041},". A celery worker is typically an \"always on\" process that watches for new messages that arrive in the queue and then processes message specified (the messages delivered to the queue contain information on which function to call, and what arguments that function should be called with.",{"type":49,"tag":58,"props":31043,"children":31044},{},[31045],{"type":55,"value":31046},"Let's image that we have a celery task to process with the following properties:",{"type":49,"tag":64,"props":31048,"children":31049},{},[31050,31055,31060,31065,31070,31075,31080],{"type":49,"tag":68,"props":31051,"children":31052},{},[31053],{"type":55,"value":31054},"It takes a long time to process (between 15 minutes and 1 or 2 hours)",{"type":49,"tag":68,"props":31056,"children":31057},{},[31058],{"type":55,"value":31059},"It has lots of dependencies (such as pandas, scikit-learn, etc.)",{"type":49,"tag":68,"props":31061,"children":31062},{},[31063],{"type":55,"value":31064},"It requires a high amount of CPU and memory",{"type":49,"tag":68,"props":31066,"children":31067},{},[31068],{"type":55,"value":31069},"It cannot easily be broken down into smaller sub-tasks",{"type":49,"tag":68,"props":31071,"children":31072},{},[31073],{"type":55,"value":31074},"The time and frequency at which this task will be called is not predictable",{"type":49,"tag":68,"props":31076,"children":31077},{},[31078],{"type":55,"value":31079},"A 2 - 3 minute delay between calling the task and starting work on the task is acceptable",{"type":49,"tag":68,"props":31081,"children":31082},{},[31083],{"type":55,"value":31084},"This task might not be very easy to process with AWS Lambda without lots of additional logic, if not impossible.",{"type":49,"tag":58,"props":31086,"children":31087},{},[31088],{"type":55,"value":31089},"To manage our project's TCO, we want scale down the number of Fargate tasks that process the queue this task is sent to. If there are no messages queued for this worker and no messages currently being processed by any of the workers for the queue, the number of Fargate tasks (celery workers) should be scaled down.",{"type":49,"tag":58,"props":31091,"children":31092},{},[31093],{"type":55,"value":31094},"I haven't done much with autoscaling on AWS before, but I found that CDK provides some very nice abstractions that make scaling with Fargate task very straightforward.",{"type":49,"tag":58,"props":31096,"children":31097},{},[31098,31100,31105],{"type":55,"value":31099},"ECS allows you to scale based on some built in metrics, such as CPU Utilization. Scaling between 0 and ",{"type":49,"tag":326,"props":31101,"children":31103},{"className":31102},[],[31104],{"type":55,"value":31039},{"type":55,"value":31106}," workers based on CPU utilization metrics wouldn't work because there would be no CPU utilization after the Fargate tasks are scaled to zero; messages in the queue would remain unprocessed and no new workers would be brought online.",{"type":49,"tag":58,"props":31108,"children":31109},{},[31110],{"type":55,"value":31111},"Using the number of tasks in the queue would be a better option. I tried a few different options to get this to work.",{"type":49,"tag":58,"props":31113,"children":31114},{},[31115,31117,31123,31124,31130],{"type":55,"value":31116},"First, I tried using one of the high-level constructs (L3 construct) from ",{"type":49,"tag":326,"props":31118,"children":31120},{"className":31119},[],[31121],{"type":55,"value":31122},"ecs_patterns",{"type":55,"value":22840},{"type":49,"tag":326,"props":31125,"children":31127},{"className":31126},[],[31128],{"type":55,"value":31129},"QueueProcessingFargateService",{"type":55,"value":31131},", but this would require that I replace Redis with SQS as the broker to be used with Celery. Some people prefer to use SQS, but I like having the ability to inspect and control, which requires a broker like Redis and is not possible with SQS.",{"type":49,"tag":58,"props":31133,"children":31134},{},[31135],{"type":55,"value":31136},"My current solution involves:",{"type":49,"tag":8994,"props":31138,"children":31139},{},[31140,31160,31173,31190,31210],{"type":49,"tag":68,"props":31141,"children":31142},{},[31143,31145,31151,31153,31159],{"type":55,"value":31144},"Creating a CloudWatch metric (the namespace is ",{"type":49,"tag":326,"props":31146,"children":31148},{"className":31147},[],[31149],{"type":55,"value":31150},"FULL_APP_NAME",{"type":55,"value":31152}," and the metric name is the name of the queue, ",{"type":49,"tag":326,"props":31154,"children":31156},{"className":31155},[],[31157],{"type":55,"value":31158},"default",{"type":55,"value":616},{"type":49,"tag":68,"props":31161,"children":31162},{},[31163,31165,31171],{"type":55,"value":31164},"Calling ",{"type":49,"tag":326,"props":31166,"children":31168},{"className":31167},[],[31169],{"type":55,"value":31170},"auto_scale_task_count",{"type":55,"value":31172}," on the Fargate service to create a an \"autoscaling Fargate task\"",{"type":49,"tag":68,"props":31174,"children":31175},{},[31176,31177,31183,31185],{"type":55,"value":31164},{"type":49,"tag":326,"props":31178,"children":31180},{"className":31179},[],[31181],{"type":55,"value":31182},"scale_on_metric",{"type":55,"value":31184}," on the \"autoscaling Fargate task\" with the CloudWatch metric created in ",{"type":49,"tag":326,"props":31186,"children":31188},{"className":31187},[],[31189],{"type":55,"value":8405},{"type":49,"tag":68,"props":31191,"children":31192},{},[31193,31194,31200,31202,31208],{"type":55,"value":17703},{"type":49,"tag":326,"props":31195,"children":31197},{"className":31196},[],[31198],{"type":55,"value":31199},"celery-metrics",{"type":55,"value":31201}," API endpoint on my Django API server that, when ",{"type":49,"tag":326,"props":31203,"children":31205},{"className":31204},[],[31206],{"type":55,"value":31207},"POST",{"type":55,"value":31209},"ed to, collects celery metrics per queue and publishes these metrics to CloudWatch.",{"type":49,"tag":68,"props":31211,"children":31212},{},[31213,31215,31220],{"type":55,"value":31214},"Scheduling a Lambda function to post to the ",{"type":49,"tag":326,"props":31216,"children":31218},{"className":31217},[],[31219],{"type":55,"value":31199},{"type":55,"value":31221}," endpoint every 5 minutes.",{"type":49,"tag":58,"props":31223,"children":31224},{},[31225],{"type":55,"value":31226},"Here's the code that takes care of steps 1, 2 and 3:",{"type":49,"tag":1050,"props":31228,"children":31230},{"code":31229,"language":28337,"meta":8,"className":28338,"style":8},"        self.default_celery_queue_cw_metric = cw.Metric(\n            namespace=scope.full_app_name, metric_name=\"default\"\n        )\n\n        self.celery_default_queue_asg = self.celery_default_worker_service.auto_scale_task_count(\n            min_capacity=0, max_capacity=2\n        )\n\n        self.celery_default_queue_asg.scale_on_metric(\n            \"CeleryDefaultQueueAutoscaling\",\n            metric=self.default_celery_queue_cw_metric,\n            scaling_steps=[\n                aas.ScalingInterval(change=-1, lower=0),\n                aas.ScalingInterval(change=1, lower=1),\n            ],\n            adjustment_type=aas.AdjustmentType.CHANGE_IN_CAPACITY,\n        )\n",[31231],{"type":49,"tag":326,"props":31232,"children":31233},{"__ignoreMap":8},[31234,31255,31286,31293,31300,31325,31359,31366,31373,31385,31397,31418,31434,31477,31516,31523,31549],{"type":49,"tag":1060,"props":31235,"children":31236},{"class":1062,"line":1063},[31237,31241,31246,31250],{"type":49,"tag":1060,"props":31238,"children":31239},{"style":3797},[31240],{"type":55,"value":22915},{"type":49,"tag":1060,"props":31242,"children":31243},{"style":1073},[31244],{"type":55,"value":31245},".default_celery_queue_cw_metric ",{"type":49,"tag":1060,"props":31247,"children":31248},{"style":2194},[31249],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31251,"children":31252},{"style":1073},[31253],{"type":55,"value":31254}," cw.Metric(\n",{"type":49,"tag":1060,"props":31256,"children":31257},{"class":1062,"line":1079},[31258,31263,31267,31272,31277,31281],{"type":49,"tag":1060,"props":31259,"children":31260},{"style":22635},[31261],{"type":55,"value":31262},"            namespace",{"type":49,"tag":1060,"props":31264,"children":31265},{"style":2194},[31266],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31268,"children":31269},{"style":1073},[31270],{"type":55,"value":31271},"scope.full_app_name, ",{"type":49,"tag":1060,"props":31273,"children":31274},{"style":22635},[31275],{"type":55,"value":31276},"metric_name",{"type":49,"tag":1060,"props":31278,"children":31279},{"style":2194},[31280],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31282,"children":31283},{"style":2215},[31284],{"type":55,"value":31285},"\"default\"\n",{"type":49,"tag":1060,"props":31287,"children":31288},{"class":1062,"line":1088},[31289],{"type":49,"tag":1060,"props":31290,"children":31291},{"style":1073},[31292],{"type":55,"value":22976},{"type":49,"tag":1060,"props":31294,"children":31295},{"class":1062,"line":1097},[31296],{"type":49,"tag":1060,"props":31297,"children":31298},{"emptyLinePlaceholder":44},[31299],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31301,"children":31302},{"class":1062,"line":1111},[31303,31307,31312,31316,31320],{"type":49,"tag":1060,"props":31304,"children":31305},{"style":3797},[31306],{"type":55,"value":22915},{"type":49,"tag":1060,"props":31308,"children":31309},{"style":1073},[31310],{"type":55,"value":31311},".celery_default_queue_asg ",{"type":49,"tag":1060,"props":31313,"children":31314},{"style":2194},[31315],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31317,"children":31318},{"style":3797},[31319],{"type":55,"value":23620},{"type":49,"tag":1060,"props":31321,"children":31322},{"style":1073},[31323],{"type":55,"value":31324},".celery_default_worker_service.auto_scale_task_count(\n",{"type":49,"tag":1060,"props":31326,"children":31327},{"class":1062,"line":1120},[31328,31333,31337,31341,31345,31350,31354],{"type":49,"tag":1060,"props":31329,"children":31330},{"style":22635},[31331],{"type":55,"value":31332},"            min_capacity",{"type":49,"tag":1060,"props":31334,"children":31335},{"style":2194},[31336],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31338,"children":31339},{"style":2287},[31340],{"type":55,"value":8397},{"type":49,"tag":1060,"props":31342,"children":31343},{"style":1073},[31344],{"type":55,"value":873},{"type":49,"tag":1060,"props":31346,"children":31347},{"style":22635},[31348],{"type":55,"value":31349},"max_capacity",{"type":49,"tag":1060,"props":31351,"children":31352},{"style":2194},[31353],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31355,"children":31356},{"style":2287},[31357],{"type":55,"value":31358},"2\n",{"type":49,"tag":1060,"props":31360,"children":31361},{"class":1062,"line":1128},[31362],{"type":49,"tag":1060,"props":31363,"children":31364},{"style":1073},[31365],{"type":55,"value":22976},{"type":49,"tag":1060,"props":31367,"children":31368},{"class":1062,"line":1141},[31369],{"type":49,"tag":1060,"props":31370,"children":31371},{"emptyLinePlaceholder":44},[31372],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31374,"children":31375},{"class":1062,"line":1150},[31376,31380],{"type":49,"tag":1060,"props":31377,"children":31378},{"style":3797},[31379],{"type":55,"value":22915},{"type":49,"tag":1060,"props":31381,"children":31382},{"style":1073},[31383],{"type":55,"value":31384},".celery_default_queue_asg.scale_on_metric(\n",{"type":49,"tag":1060,"props":31386,"children":31387},{"class":1062,"line":1158},[31388,31393],{"type":49,"tag":1060,"props":31389,"children":31390},{"style":2215},[31391],{"type":55,"value":31392},"            \"CeleryDefaultQueueAutoscaling\"",{"type":49,"tag":1060,"props":31394,"children":31395},{"style":1073},[31396],{"type":55,"value":2497},{"type":49,"tag":1060,"props":31398,"children":31399},{"class":1062,"line":1171},[31400,31405,31409,31413],{"type":49,"tag":1060,"props":31401,"children":31402},{"style":22635},[31403],{"type":55,"value":31404},"            metric",{"type":49,"tag":1060,"props":31406,"children":31407},{"style":2194},[31408],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31410,"children":31411},{"style":3797},[31412],{"type":55,"value":22963},{"type":49,"tag":1060,"props":31414,"children":31415},{"style":1073},[31416],{"type":55,"value":31417},".default_celery_queue_cw_metric,\n",{"type":49,"tag":1060,"props":31419,"children":31420},{"class":1062,"line":1180},[31421,31426,31430],{"type":49,"tag":1060,"props":31422,"children":31423},{"style":22635},[31424],{"type":55,"value":31425},"            scaling_steps",{"type":49,"tag":1060,"props":31427,"children":31428},{"style":2194},[31429],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31431,"children":31432},{"style":1073},[31433],{"type":55,"value":23091},{"type":49,"tag":1060,"props":31435,"children":31436},{"class":1062,"line":1188},[31437,31442,31447,31452,31456,31460,31465,31469,31473],{"type":49,"tag":1060,"props":31438,"children":31439},{"style":1073},[31440],{"type":55,"value":31441},"                aas.ScalingInterval(",{"type":49,"tag":1060,"props":31443,"children":31444},{"style":22635},[31445],{"type":55,"value":31446},"change",{"type":49,"tag":1060,"props":31448,"children":31449},{"style":2194},[31450],{"type":55,"value":31451},"=-",{"type":49,"tag":1060,"props":31453,"children":31454},{"style":2287},[31455],{"type":55,"value":8405},{"type":49,"tag":1060,"props":31457,"children":31458},{"style":1073},[31459],{"type":55,"value":873},{"type":49,"tag":1060,"props":31461,"children":31462},{"style":22635},[31463],{"type":55,"value":31464},"lower",{"type":49,"tag":1060,"props":31466,"children":31467},{"style":2194},[31468],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31470,"children":31471},{"style":2287},[31472],{"type":55,"value":8397},{"type":49,"tag":1060,"props":31474,"children":31475},{"style":1073},[31476],{"type":55,"value":20221},{"type":49,"tag":1060,"props":31478,"children":31479},{"class":1062,"line":1201},[31480,31484,31488,31492,31496,31500,31504,31508,31512],{"type":49,"tag":1060,"props":31481,"children":31482},{"style":1073},[31483],{"type":55,"value":31441},{"type":49,"tag":1060,"props":31485,"children":31486},{"style":22635},[31487],{"type":55,"value":31446},{"type":49,"tag":1060,"props":31489,"children":31490},{"style":2194},[31491],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31493,"children":31494},{"style":2287},[31495],{"type":55,"value":8405},{"type":49,"tag":1060,"props":31497,"children":31498},{"style":1073},[31499],{"type":55,"value":873},{"type":49,"tag":1060,"props":31501,"children":31502},{"style":22635},[31503],{"type":55,"value":31464},{"type":49,"tag":1060,"props":31505,"children":31506},{"style":2194},[31507],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31509,"children":31510},{"style":2287},[31511],{"type":55,"value":8405},{"type":49,"tag":1060,"props":31513,"children":31514},{"style":1073},[31515],{"type":55,"value":20221},{"type":49,"tag":1060,"props":31517,"children":31518},{"class":1062,"line":1210},[31519],{"type":49,"tag":1060,"props":31520,"children":31521},{"style":1073},[31522],{"type":55,"value":23197},{"type":49,"tag":1060,"props":31524,"children":31525},{"class":1062,"line":1218},[31526,31531,31535,31540,31545],{"type":49,"tag":1060,"props":31527,"children":31528},{"style":22635},[31529],{"type":55,"value":31530},"            adjustment_type",{"type":49,"tag":1060,"props":31532,"children":31533},{"style":2194},[31534],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31536,"children":31537},{"style":1073},[31538],{"type":55,"value":31539},"aas.AdjustmentType.",{"type":49,"tag":1060,"props":31541,"children":31542},{"style":2287},[31543],{"type":55,"value":31544},"CHANGE_IN_CAPACITY",{"type":49,"tag":1060,"props":31546,"children":31547},{"style":1073},[31548],{"type":55,"value":2497},{"type":49,"tag":1060,"props":31550,"children":31551},{"class":1062,"line":1232},[31552],{"type":49,"tag":1060,"props":31553,"children":31554},{"style":1073},[31555],{"type":55,"value":22976},{"type":49,"tag":58,"props":31557,"children":31558},{},[31559,31561,31567,31569,31575,31577,31583],{"type":55,"value":31560},"Step 4 inspects active and reserved tasks, filters the tasks by the ",{"type":49,"tag":326,"props":31562,"children":31564},{"className":31563},[],[31565],{"type":55,"value":31566},"routing_key",{"type":55,"value":31568}," (which is the same as the queue name) and the combines this with any queued tasks by calling ",{"type":49,"tag":326,"props":31570,"children":31572},{"className":31571},[],[31573],{"type":55,"value":31574},"llen(queue_name)",{"type":55,"value":31576},". Finally, the queue names and combined active, reserved and queued task totals are sent to CloudWatch via boto3. The code for this is in ",{"type":49,"tag":326,"props":31578,"children":31580},{"className":31579},[],[31581],{"type":55,"value":31582},"backend/apps/core/utils/celery_utils.py",{"type":55,"value":745},{"type":49,"tag":58,"props":31585,"children":31586},{},[31587],{"type":55,"value":31588},"Here's the code for the Lambda function in step 5:",{"type":49,"tag":1050,"props":31590,"children":31592},{"code":31591,"language":28337,"meta":8,"className":28338,"style":8},"import json\nimport os\nimport urllib.request\n\nFULL_DOMAIN_NAME = os.environ.get(\"FULL_DOMAIN_NAME\")\nCELERY_METRICS_PATH = \"api/celery-metrics/\"\n\nCELERY_METRICS_URL = f\"https://{FULL_DOMAIN_NAME}/{CELERY_METRICS_PATH}\"\nCELERY_METRICS_TOKEN = os.environ.get(\"CELERY_METRICS_TOKEN\")\n\n\ndef lambda_handler(event, context):\n    data = {\"celery_metrics_token\": CELERY_METRICS_TOKEN}\n    params = json.dumps(data).encode('utf8')\n    req = urllib.request.Request(\n        CELERY_METRICS_URL,\n        data=params,\n        headers={'content-type': 'application/json'},\n    )\n    response = urllib.request.urlopen(req)\n    return response.read()\n",[31593],{"type":49,"tag":326,"props":31594,"children":31595},{"__ignoreMap":8},[31596,31607,31618,31630,31637,31662,31679,31686,31724,31749,31756,31763,31794,31826,31851,31868,31880,31897,31932,31939,31956],{"type":49,"tag":1060,"props":31597,"children":31598},{"class":1062,"line":1063},[31599,31603],{"type":49,"tag":1060,"props":31600,"children":31601},{"style":2194},[31602],{"type":55,"value":22194},{"type":49,"tag":1060,"props":31604,"children":31605},{"style":1073},[31606],{"type":55,"value":25104},{"type":49,"tag":1060,"props":31608,"children":31609},{"class":1062,"line":1079},[31610,31614],{"type":49,"tag":1060,"props":31611,"children":31612},{"style":2194},[31613],{"type":55,"value":22194},{"type":49,"tag":1060,"props":31615,"children":31616},{"style":1073},[31617],{"type":55,"value":25116},{"type":49,"tag":1060,"props":31619,"children":31620},{"class":1062,"line":1088},[31621,31625],{"type":49,"tag":1060,"props":31622,"children":31623},{"style":2194},[31624],{"type":55,"value":22194},{"type":49,"tag":1060,"props":31626,"children":31627},{"style":1073},[31628],{"type":55,"value":31629}," urllib.request\n",{"type":49,"tag":1060,"props":31631,"children":31632},{"class":1062,"line":1097},[31633],{"type":49,"tag":1060,"props":31634,"children":31635},{"emptyLinePlaceholder":44},[31636],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31638,"children":31639},{"class":1062,"line":1111},[31640,31645,31649,31653,31658],{"type":49,"tag":1060,"props":31641,"children":31642},{"style":2287},[31643],{"type":55,"value":31644},"FULL_DOMAIN_NAME",{"type":49,"tag":1060,"props":31646,"children":31647},{"style":2194},[31648],{"type":55,"value":2197},{"type":49,"tag":1060,"props":31650,"children":31651},{"style":1073},[31652],{"type":55,"value":28519},{"type":49,"tag":1060,"props":31654,"children":31655},{"style":2215},[31656],{"type":55,"value":31657},"\"FULL_DOMAIN_NAME\"",{"type":49,"tag":1060,"props":31659,"children":31660},{"style":1073},[31661],{"type":55,"value":5126},{"type":49,"tag":1060,"props":31663,"children":31664},{"class":1062,"line":1120},[31665,31670,31674],{"type":49,"tag":1060,"props":31666,"children":31667},{"style":2287},[31668],{"type":55,"value":31669},"CELERY_METRICS_PATH",{"type":49,"tag":1060,"props":31671,"children":31672},{"style":2194},[31673],{"type":55,"value":2197},{"type":49,"tag":1060,"props":31675,"children":31676},{"style":2215},[31677],{"type":55,"value":31678}," \"api/celery-metrics/\"\n",{"type":49,"tag":1060,"props":31680,"children":31681},{"class":1062,"line":1128},[31682],{"type":49,"tag":1060,"props":31683,"children":31684},{"emptyLinePlaceholder":44},[31685],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31687,"children":31688},{"class":1062,"line":1141},[31689,31694,31698,31702,31706,31711,31715,31720],{"type":49,"tag":1060,"props":31690,"children":31691},{"style":2287},[31692],{"type":55,"value":31693},"CELERY_METRICS_URL",{"type":49,"tag":1060,"props":31695,"children":31696},{"style":2194},[31697],{"type":55,"value":2197},{"type":49,"tag":1060,"props":31699,"children":31700},{"style":2182},[31701],{"type":55,"value":24805},{"type":49,"tag":1060,"props":31703,"children":31704},{"style":2215},[31705],{"type":55,"value":24886},{"type":49,"tag":1060,"props":31707,"children":31708},{"style":2287},[31709],{"type":55,"value":31710},"{FULL_DOMAIN_NAME}",{"type":49,"tag":1060,"props":31712,"children":31713},{"style":2215},[31714],{"type":55,"value":3744},{"type":49,"tag":1060,"props":31716,"children":31717},{"style":2287},[31718],{"type":55,"value":31719},"{CELERY_METRICS_PATH}",{"type":49,"tag":1060,"props":31721,"children":31722},{"style":2215},[31723],{"type":55,"value":10025},{"type":49,"tag":1060,"props":31725,"children":31726},{"class":1062,"line":1150},[31727,31732,31736,31740,31745],{"type":49,"tag":1060,"props":31728,"children":31729},{"style":2287},[31730],{"type":55,"value":31731},"CELERY_METRICS_TOKEN",{"type":49,"tag":1060,"props":31733,"children":31734},{"style":2194},[31735],{"type":55,"value":2197},{"type":49,"tag":1060,"props":31737,"children":31738},{"style":1073},[31739],{"type":55,"value":28519},{"type":49,"tag":1060,"props":31741,"children":31742},{"style":2215},[31743],{"type":55,"value":31744},"\"CELERY_METRICS_TOKEN\"",{"type":49,"tag":1060,"props":31746,"children":31747},{"style":1073},[31748],{"type":55,"value":5126},{"type":49,"tag":1060,"props":31750,"children":31751},{"class":1062,"line":1158},[31752],{"type":49,"tag":1060,"props":31753,"children":31754},{"emptyLinePlaceholder":44},[31755],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31757,"children":31758},{"class":1062,"line":1171},[31759],{"type":49,"tag":1060,"props":31760,"children":31761},{"emptyLinePlaceholder":44},[31762],{"type":55,"value":1094},{"type":49,"tag":1060,"props":31764,"children":31765},{"class":1062,"line":1180},[31766,31770,31774,31778,31782,31786,31790],{"type":49,"tag":1060,"props":31767,"children":31768},{"style":2182},[31769],{"type":55,"value":22214},{"type":49,"tag":1060,"props":31771,"children":31772},{"style":1067},[31773],{"type":55,"value":22536},{"type":49,"tag":1060,"props":31775,"children":31776},{"style":1073},[31777],{"type":55,"value":2284},{"type":49,"tag":1060,"props":31779,"children":31780},{"style":22226},[31781],{"type":55,"value":22229},{"type":49,"tag":1060,"props":31783,"children":31784},{"style":1073},[31785],{"type":55,"value":873},{"type":49,"tag":1060,"props":31787,"children":31788},{"style":22226},[31789],{"type":55,"value":14059},{"type":49,"tag":1060,"props":31791,"children":31792},{"style":1073},[31793],{"type":55,"value":22242},{"type":49,"tag":1060,"props":31795,"children":31796},{"class":1062,"line":1188},[31797,31801,31805,31809,31814,31818,31822],{"type":49,"tag":1060,"props":31798,"children":31799},{"style":1073},[31800],{"type":55,"value":25337},{"type":49,"tag":1060,"props":31802,"children":31803},{"style":2194},[31804],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31806,"children":31807},{"style":1073},[31808],{"type":55,"value":22658},{"type":49,"tag":1060,"props":31810,"children":31811},{"style":2215},[31812],{"type":55,"value":31813},"\"celery_metrics_token\"",{"type":49,"tag":1060,"props":31815,"children":31816},{"style":1073},[31817],{"type":55,"value":78},{"type":49,"tag":1060,"props":31819,"children":31820},{"style":2287},[31821],{"type":55,"value":31731},{"type":49,"tag":1060,"props":31823,"children":31824},{"style":1073},[31825],{"type":55,"value":3675},{"type":49,"tag":1060,"props":31827,"children":31828},{"class":1062,"line":1201},[31829,31834,31838,31843,31847],{"type":49,"tag":1060,"props":31830,"children":31831},{"style":1073},[31832],{"type":55,"value":31833},"    params ",{"type":49,"tag":1060,"props":31835,"children":31836},{"style":2194},[31837],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31839,"children":31840},{"style":1073},[31841],{"type":55,"value":31842}," json.dumps(data).encode(",{"type":49,"tag":1060,"props":31844,"children":31845},{"style":2215},[31846],{"type":55,"value":6517},{"type":49,"tag":1060,"props":31848,"children":31849},{"style":1073},[31850],{"type":55,"value":5126},{"type":49,"tag":1060,"props":31852,"children":31853},{"class":1062,"line":1210},[31854,31859,31863],{"type":49,"tag":1060,"props":31855,"children":31856},{"style":1073},[31857],{"type":55,"value":31858},"    req ",{"type":49,"tag":1060,"props":31860,"children":31861},{"style":2194},[31862],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31864,"children":31865},{"style":1073},[31866],{"type":55,"value":31867}," urllib.request.Request(\n",{"type":49,"tag":1060,"props":31869,"children":31870},{"class":1062,"line":1218},[31871,31876],{"type":49,"tag":1060,"props":31872,"children":31873},{"style":2287},[31874],{"type":55,"value":31875},"        CELERY_METRICS_URL",{"type":49,"tag":1060,"props":31877,"children":31878},{"style":1073},[31879],{"type":55,"value":2497},{"type":49,"tag":1060,"props":31881,"children":31882},{"class":1062,"line":1232},[31883,31888,31892],{"type":49,"tag":1060,"props":31884,"children":31885},{"style":22635},[31886],{"type":55,"value":31887},"        data",{"type":49,"tag":1060,"props":31889,"children":31890},{"style":2194},[31891],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31893,"children":31894},{"style":1073},[31895],{"type":55,"value":31896},"params,\n",{"type":49,"tag":1060,"props":31898,"children":31899},{"class":1062,"line":1241},[31900,31905,31909,31913,31918,31922,31927],{"type":49,"tag":1060,"props":31901,"children":31902},{"style":22635},[31903],{"type":55,"value":31904},"        headers",{"type":49,"tag":1060,"props":31906,"children":31907},{"style":2194},[31908],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31910,"children":31911},{"style":1073},[31912],{"type":55,"value":23338},{"type":49,"tag":1060,"props":31914,"children":31915},{"style":2215},[31916],{"type":55,"value":31917},"'content-type'",{"type":49,"tag":1060,"props":31919,"children":31920},{"style":1073},[31921],{"type":55,"value":78},{"type":49,"tag":1060,"props":31923,"children":31924},{"style":2215},[31925],{"type":55,"value":31926},"'application/json'",{"type":49,"tag":1060,"props":31928,"children":31929},{"style":1073},[31930],{"type":55,"value":31931},"},\n",{"type":49,"tag":1060,"props":31933,"children":31934},{"class":1062,"line":1249},[31935],{"type":49,"tag":1060,"props":31936,"children":31937},{"style":1073},[31938],{"type":55,"value":25322},{"type":49,"tag":1060,"props":31940,"children":31941},{"class":1062,"line":1262},[31942,31947,31951],{"type":49,"tag":1060,"props":31943,"children":31944},{"style":1073},[31945],{"type":55,"value":31946},"    response ",{"type":49,"tag":1060,"props":31948,"children":31949},{"style":2194},[31950],{"type":55,"value":3068},{"type":49,"tag":1060,"props":31952,"children":31953},{"style":1073},[31954],{"type":55,"value":31955}," urllib.request.urlopen(req)\n",{"type":49,"tag":1060,"props":31957,"children":31958},{"class":1062,"line":4581},[31959,31963],{"type":49,"tag":1060,"props":31960,"children":31961},{"style":2194},[31962],{"type":55,"value":25371},{"type":49,"tag":1060,"props":31964,"children":31965},{"style":1073},[31966],{"type":55,"value":31967}," response.read()\n",{"type":49,"tag":58,"props":31969,"children":31970},{},[31971],{"type":55,"value":31972},"Finally, here is the code for defining the lambda function and scheduled invocation of the lambda function:",{"type":49,"tag":1050,"props":31974,"children":31976},{"code":31975,"language":28337,"meta":8,"className":28338,"style":8},"class CeleryAutoscalingStack(cloudformation.NestedStack):\n    def __init__(self, scope: core.Construct, id: str, **kwargs) -> None:\n        super().__init__(\n            scope, id, **kwargs,\n        )\n\n        self.lambda_function = aws_lambda.Function(\n            self,\n            \"CeleryMetricsLambdaFunction\",\n            code=aws_lambda.Code.asset(\"awslambda\"),\n            handler=\"publish_celery_metrics.lambda_handler\",\n            runtime=aws_lambda.Runtime.PYTHON_3_7,\n            environment=scope.variables.regular_variables,\n        )\n\n        self.celery_default_cw_metric_schedule = events.Rule(\n            self,\n            \"CeleryDefaultCWMetricSchedule\",\n            schedule=events.Schedule.rate(core.Duration.minutes(5)),\n            targets=[\n                events_targets.LambdaFunction(handler=self.lambda_function)\n            ],\n        )\n\n        # TODO: refactor this to loop through CloudWatch metrics multiple celery queues\n        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n            scope.backend_service.backend_task.task_role\n        )\n",[31977],{"type":49,"tag":326,"props":31978,"children":31979},{"__ignoreMap":8},[31980,32014,32087,32110,32135,32142,32149,32170,32181,32193,32218,32238,32263,32279,32286,32293,32314,32325,32337,32364,32380,32405,32412,32419,32426,32444,32452,32460],{"type":49,"tag":1060,"props":31981,"children":31982},{"class":1062,"line":1063},[31983,31988,31993,31997,32002,32006,32010],{"type":49,"tag":1060,"props":31984,"children":31985},{"style":2182},[31986],{"type":55,"value":31987},"class",{"type":49,"tag":1060,"props":31989,"children":31990},{"style":3992},[31991],{"type":55,"value":31992}," CeleryAutoscalingStack",{"type":49,"tag":1060,"props":31994,"children":31995},{"style":1073},[31996],{"type":55,"value":2284},{"type":49,"tag":1060,"props":31998,"children":32000},{"style":31999},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[32001],{"type":55,"value":18},{"type":49,"tag":1060,"props":32003,"children":32004},{"style":1073},[32005],{"type":55,"value":745},{"type":49,"tag":1060,"props":32007,"children":32008},{"style":31999},[32009],{"type":55,"value":29140},{"type":49,"tag":1060,"props":32011,"children":32012},{"style":1073},[32013],{"type":55,"value":22242},{"type":49,"tag":1060,"props":32015,"children":32016},{"class":1062,"line":1079},[32017,32022,32027,32031,32035,32039,32043,32048,32052,32056,32061,32065,32069,32074,32079,32083],{"type":49,"tag":1060,"props":32018,"children":32019},{"style":2182},[32020],{"type":55,"value":32021},"    def",{"type":49,"tag":1060,"props":32023,"children":32024},{"style":9965},[32025],{"type":55,"value":32026}," __init__",{"type":49,"tag":1060,"props":32028,"children":32029},{"style":1073},[32030],{"type":55,"value":2284},{"type":49,"tag":1060,"props":32032,"children":32033},{"style":22226},[32034],{"type":55,"value":22963},{"type":49,"tag":1060,"props":32036,"children":32037},{"style":1073},[32038],{"type":55,"value":873},{"type":49,"tag":1060,"props":32040,"children":32041},{"style":22226},[32042],{"type":55,"value":17321},{"type":49,"tag":1060,"props":32044,"children":32045},{"style":1073},[32046],{"type":55,"value":32047},": core.Construct, ",{"type":49,"tag":1060,"props":32049,"children":32050},{"style":22226},[32051],{"type":55,"value":16428},{"type":49,"tag":1060,"props":32053,"children":32054},{"style":1073},[32055],{"type":55,"value":78},{"type":49,"tag":1060,"props":32057,"children":32058},{"style":5200},[32059],{"type":55,"value":32060},"str",{"type":49,"tag":1060,"props":32062,"children":32063},{"style":1073},[32064],{"type":55,"value":873},{"type":49,"tag":1060,"props":32066,"children":32067},{"style":2194},[32068],{"type":55,"value":23506},{"type":49,"tag":1060,"props":32070,"children":32071},{"style":22226},[32072],{"type":55,"value":32073},"kwargs",{"type":49,"tag":1060,"props":32075,"children":32076},{"style":1073},[32077],{"type":55,"value":32078},") -> ",{"type":49,"tag":1060,"props":32080,"children":32081},{"style":2287},[32082],{"type":55,"value":25272},{"type":49,"tag":1060,"props":32084,"children":32085},{"style":1073},[32086],{"type":55,"value":6862},{"type":49,"tag":1060,"props":32088,"children":32089},{"class":1062,"line":1088},[32090,32095,32100,32105],{"type":49,"tag":1060,"props":32091,"children":32092},{"style":5200},[32093],{"type":55,"value":32094},"        super",{"type":49,"tag":1060,"props":32096,"children":32097},{"style":1073},[32098],{"type":55,"value":32099},"().",{"type":49,"tag":1060,"props":32101,"children":32102},{"style":9965},[32103],{"type":55,"value":32104},"__init__",{"type":49,"tag":1060,"props":32106,"children":32107},{"style":1073},[32108],{"type":55,"value":32109},"(\n",{"type":49,"tag":1060,"props":32111,"children":32112},{"class":1062,"line":1097},[32113,32118,32122,32126,32130],{"type":49,"tag":1060,"props":32114,"children":32115},{"style":1073},[32116],{"type":55,"value":32117},"            scope, ",{"type":49,"tag":1060,"props":32119,"children":32120},{"style":9965},[32121],{"type":55,"value":16428},{"type":49,"tag":1060,"props":32123,"children":32124},{"style":1073},[32125],{"type":55,"value":873},{"type":49,"tag":1060,"props":32127,"children":32128},{"style":2194},[32129],{"type":55,"value":23506},{"type":49,"tag":1060,"props":32131,"children":32132},{"style":1073},[32133],{"type":55,"value":32134},"kwargs,\n",{"type":49,"tag":1060,"props":32136,"children":32137},{"class":1062,"line":1111},[32138],{"type":49,"tag":1060,"props":32139,"children":32140},{"style":1073},[32141],{"type":55,"value":22976},{"type":49,"tag":1060,"props":32143,"children":32144},{"class":1062,"line":1120},[32145],{"type":49,"tag":1060,"props":32146,"children":32147},{"emptyLinePlaceholder":44},[32148],{"type":55,"value":1094},{"type":49,"tag":1060,"props":32150,"children":32151},{"class":1062,"line":1128},[32152,32156,32161,32165],{"type":49,"tag":1060,"props":32153,"children":32154},{"style":3797},[32155],{"type":55,"value":22915},{"type":49,"tag":1060,"props":32157,"children":32158},{"style":1073},[32159],{"type":55,"value":32160},".lambda_function ",{"type":49,"tag":1060,"props":32162,"children":32163},{"style":2194},[32164],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32166,"children":32167},{"style":1073},[32168],{"type":55,"value":32169}," aws_lambda.Function(\n",{"type":49,"tag":1060,"props":32171,"children":32172},{"class":1062,"line":1141},[32173,32177],{"type":49,"tag":1060,"props":32174,"children":32175},{"style":3797},[32176],{"type":55,"value":22937},{"type":49,"tag":1060,"props":32178,"children":32179},{"style":1073},[32180],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32182,"children":32183},{"class":1062,"line":1150},[32184,32189],{"type":49,"tag":1060,"props":32185,"children":32186},{"style":2215},[32187],{"type":55,"value":32188},"            \"CeleryMetricsLambdaFunction\"",{"type":49,"tag":1060,"props":32190,"children":32191},{"style":1073},[32192],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32194,"children":32195},{"class":1062,"line":1158},[32196,32200,32204,32209,32214],{"type":49,"tag":1060,"props":32197,"children":32198},{"style":22635},[32199],{"type":55,"value":23294},{"type":49,"tag":1060,"props":32201,"children":32202},{"style":2194},[32203],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32205,"children":32206},{"style":1073},[32207],{"type":55,"value":32208},"aws_lambda.Code.asset(",{"type":49,"tag":1060,"props":32210,"children":32211},{"style":2215},[32212],{"type":55,"value":32213},"\"awslambda\"",{"type":49,"tag":1060,"props":32215,"children":32216},{"style":1073},[32217],{"type":55,"value":20221},{"type":49,"tag":1060,"props":32219,"children":32220},{"class":1062,"line":1171},[32221,32225,32229,32234],{"type":49,"tag":1060,"props":32222,"children":32223},{"style":22635},[32224],{"type":55,"value":23364},{"type":49,"tag":1060,"props":32226,"children":32227},{"style":2194},[32228],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32230,"children":32231},{"style":2215},[32232],{"type":55,"value":32233},"\"publish_celery_metrics.lambda_handler\"",{"type":49,"tag":1060,"props":32235,"children":32236},{"style":1073},[32237],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32239,"children":32240},{"class":1062,"line":1180},[32241,32245,32249,32254,32259],{"type":49,"tag":1060,"props":32242,"children":32243},{"style":22635},[32244],{"type":55,"value":23268},{"type":49,"tag":1060,"props":32246,"children":32247},{"style":2194},[32248],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32250,"children":32251},{"style":1073},[32252],{"type":55,"value":32253},"aws_lambda.Runtime.",{"type":49,"tag":1060,"props":32255,"children":32256},{"style":2287},[32257],{"type":55,"value":32258},"PYTHON_3_7",{"type":49,"tag":1060,"props":32260,"children":32261},{"style":1073},[32262],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32264,"children":32265},{"class":1062,"line":1188},[32266,32270,32274],{"type":49,"tag":1060,"props":32267,"children":32268},{"style":22635},[32269],{"type":55,"value":23493},{"type":49,"tag":1060,"props":32271,"children":32272},{"style":2194},[32273],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32275,"children":32276},{"style":1073},[32277],{"type":55,"value":32278},"scope.variables.regular_variables,\n",{"type":49,"tag":1060,"props":32280,"children":32281},{"class":1062,"line":1201},[32282],{"type":49,"tag":1060,"props":32283,"children":32284},{"style":1073},[32285],{"type":55,"value":22976},{"type":49,"tag":1060,"props":32287,"children":32288},{"class":1062,"line":1210},[32289],{"type":49,"tag":1060,"props":32290,"children":32291},{"emptyLinePlaceholder":44},[32292],{"type":55,"value":1094},{"type":49,"tag":1060,"props":32294,"children":32295},{"class":1062,"line":1218},[32296,32300,32305,32309],{"type":49,"tag":1060,"props":32297,"children":32298},{"style":3797},[32299],{"type":55,"value":22915},{"type":49,"tag":1060,"props":32301,"children":32302},{"style":1073},[32303],{"type":55,"value":32304},".celery_default_cw_metric_schedule ",{"type":49,"tag":1060,"props":32306,"children":32307},{"style":2194},[32308],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32310,"children":32311},{"style":1073},[32312],{"type":55,"value":32313}," events.Rule(\n",{"type":49,"tag":1060,"props":32315,"children":32316},{"class":1062,"line":1232},[32317,32321],{"type":49,"tag":1060,"props":32318,"children":32319},{"style":3797},[32320],{"type":55,"value":22937},{"type":49,"tag":1060,"props":32322,"children":32323},{"style":1073},[32324],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32326,"children":32327},{"class":1062,"line":1241},[32328,32333],{"type":49,"tag":1060,"props":32329,"children":32330},{"style":2215},[32331],{"type":55,"value":32332},"            \"CeleryDefaultCWMetricSchedule\"",{"type":49,"tag":1060,"props":32334,"children":32335},{"style":1073},[32336],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32338,"children":32339},{"class":1062,"line":1249},[32340,32345,32349,32354,32359],{"type":49,"tag":1060,"props":32341,"children":32342},{"style":22635},[32343],{"type":55,"value":32344},"            schedule",{"type":49,"tag":1060,"props":32346,"children":32347},{"style":2194},[32348],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32350,"children":32351},{"style":1073},[32352],{"type":55,"value":32353},"events.Schedule.rate(core.Duration.minutes(",{"type":49,"tag":1060,"props":32355,"children":32356},{"style":2287},[32357],{"type":55,"value":32358},"5",{"type":49,"tag":1060,"props":32360,"children":32361},{"style":1073},[32362],{"type":55,"value":32363},")),\n",{"type":49,"tag":1060,"props":32365,"children":32366},{"class":1062,"line":1262},[32367,32372,32376],{"type":49,"tag":1060,"props":32368,"children":32369},{"style":22635},[32370],{"type":55,"value":32371},"            targets",{"type":49,"tag":1060,"props":32373,"children":32374},{"style":2194},[32375],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32377,"children":32378},{"style":1073},[32379],{"type":55,"value":23091},{"type":49,"tag":1060,"props":32381,"children":32382},{"class":1062,"line":4581},[32383,32388,32392,32396,32400],{"type":49,"tag":1060,"props":32384,"children":32385},{"style":1073},[32386],{"type":55,"value":32387},"                events_targets.LambdaFunction(",{"type":49,"tag":1060,"props":32389,"children":32390},{"style":22635},[32391],{"type":55,"value":22167},{"type":49,"tag":1060,"props":32393,"children":32394},{"style":2194},[32395],{"type":55,"value":3068},{"type":49,"tag":1060,"props":32397,"children":32398},{"style":3797},[32399],{"type":55,"value":22963},{"type":49,"tag":1060,"props":32401,"children":32402},{"style":1073},[32403],{"type":55,"value":32404},".lambda_function)\n",{"type":49,"tag":1060,"props":32406,"children":32407},{"class":1062,"line":4631},[32408],{"type":49,"tag":1060,"props":32409,"children":32410},{"style":1073},[32411],{"type":55,"value":23197},{"type":49,"tag":1060,"props":32413,"children":32414},{"class":1062,"line":4682},[32415],{"type":49,"tag":1060,"props":32416,"children":32417},{"style":1073},[32418],{"type":55,"value":22976},{"type":49,"tag":1060,"props":32420,"children":32421},{"class":1062,"line":4709},[32422],{"type":49,"tag":1060,"props":32423,"children":32424},{"emptyLinePlaceholder":44},[32425],{"type":55,"value":1094},{"type":49,"tag":1060,"props":32427,"children":32428},{"class":1062,"line":5979},[32429,32434,32439],{"type":49,"tag":1060,"props":32430,"children":32431},{"style":3039},[32432],{"type":55,"value":32433},"        # ",{"type":49,"tag":1060,"props":32435,"children":32436},{"style":2194},[32437],{"type":55,"value":32438},"TODO",{"type":49,"tag":1060,"props":32440,"children":32441},{"style":3039},[32442],{"type":55,"value":32443},": refactor this to loop through CloudWatch metrics multiple celery queues\n",{"type":49,"tag":1060,"props":32445,"children":32446},{"class":1062,"line":5988},[32447],{"type":49,"tag":1060,"props":32448,"children":32449},{"style":1073},[32450],{"type":55,"value":32451},"        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n",{"type":49,"tag":1060,"props":32453,"children":32454},{"class":1062,"line":5997},[32455],{"type":49,"tag":1060,"props":32456,"children":32457},{"style":1073},[32458],{"type":55,"value":32459},"            scope.backend_service.backend_task.task_role\n",{"type":49,"tag":1060,"props":32461,"children":32462},{"class":1062,"line":6006},[32463],{"type":49,"tag":1060,"props":32464,"children":32465},{"style":1073},[32466],{"type":55,"value":22976},{"type":49,"tag":50,"props":32468,"children":32470},{"id":32469},"miscellaneous-grievances",[32471],{"type":55,"value":32472},"Miscellaneous Grievances",{"type":49,"tag":64,"props":32474,"children":32475},{},[32476,32481,32493],{"type":49,"tag":68,"props":32477,"children":32478},{},[32479],{"type":55,"value":32480},"Fargate tasks cannot access Secrets that use JSON template",{"type":49,"tag":68,"props":32482,"children":32483},{},[32484,32486,32491],{"type":55,"value":32485},"You cannot select ",{"type":49,"tag":326,"props":32487,"children":32489},{"className":32488},[],[32490],{"type":55,"value":2899},{"type":55,"value":32492}," on a CDK-created ECS cluster. This option seems to only be available from the ECS Wizard in the AWS Console",{"type":49,"tag":68,"props":32494,"children":32495},{},[32496,32498,32504],{"type":55,"value":32497},"It's not super clear how to package dependencies in Lambda with CDK. Here's an interesting approach that I would like to try: ",{"type":49,"tag":80,"props":32499,"children":32502},{"href":32500,"rel":32501},"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487",[84],[32503],{"type":55,"value":32500},{"type":55,"value":32505},". The Lambda functions I'm using don't require anything outside of the standard library, but if they did it would require some additional work to make sure dependencies can be added as Lambda Layers.",{"type":49,"tag":50,"props":32507,"children":32509},{"id":32508},"todo",[32510],{"type":55,"value":32438},{"type":49,"tag":64,"props":32512,"children":32513},{},[32514,32519,32524,32529],{"type":49,"tag":68,"props":32515,"children":32516},{},[32517],{"type":55,"value":32518},"Create an IAM role template that can be used to create an IAM role that has access to setup infrastructure through CDK. Currently I'm using an admin account which is not a best practice.",{"type":49,"tag":68,"props":32520,"children":32521},{},[32522],{"type":55,"value":32523},"Move this Wiki Article to the project documentation site and main README",{"type":49,"tag":68,"props":32525,"children":32526},{},[32527],{"type":55,"value":32528},"Expand on each topic, replace existing documentation",{"type":49,"tag":68,"props":32530,"children":32531},{},[32532,32534,32539],{"type":55,"value":32533},"Add a summary of each ",{"type":49,"tag":326,"props":32535,"children":32537},{"className":32536},[],[32538],{"type":55,"value":29140},{"type":55,"value":32540}," from CDK code",{"type":49,"tag":7749,"props":32542,"children":32543},{},[32544],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":32546},[32547,32548,32560,32574,32581,32582,32583],{"id":27102,"depth":1079,"text":27105},{"id":27184,"depth":1079,"text":27187,"children":32549},[32550,32551,32552,32553,32554,32555,32556,32557,32558,32559],{"id":14123,"depth":1088,"text":14126},{"id":6972,"depth":1088,"text":6975},{"id":27411,"depth":1088,"text":27414},{"id":20,"depth":1088,"text":22391},{"id":27558,"depth":1088,"text":27561},{"id":27638,"depth":1088,"text":27641},{"id":27681,"depth":1088,"text":27684},{"id":27874,"depth":1088,"text":27877},{"id":27970,"depth":1088,"text":27137},{"id":28022,"depth":1088,"text":28025},{"id":28101,"depth":1079,"text":28104,"children":32561},[32562,32564,32565,32567,32569,32571,32572],{"id":28112,"depth":1088,"text":32563},"Start here: https://cdkworkshop.com",{"id":28129,"depth":1088,"text":28132},{"id":29049,"depth":1088,"text":32566},"Using cdk synth in development",{"id":29133,"depth":1088,"text":32568},"NestedStacks",{"id":29262,"depth":1088,"text":32570},"cdk deploy and CDK in GitLab CI pipelines",{"id":29718,"depth":1088,"text":29725},{"id":30159,"depth":1088,"text":32573},"Quick tour of ApplicationStack",{"id":30788,"depth":1079,"text":32575,"children":32576},"Why X? Why not Y?",[32577,32578,32579,32580],{"id":30815,"depth":1088,"text":30818},{"id":30872,"depth":1088,"text":30875},{"id":30883,"depth":1088,"text":30886},{"id":30937,"depth":1088,"text":30940},{"id":30948,"depth":1079,"text":30951},{"id":32469,"depth":1079,"text":32472},{"id":32508,"depth":1079,"text":32438},"content:2020:06:02:django-postgres-vue-gitlab-ecs.md","2020/06/02/django-postgres-vue-gitlab-ecs.md","2020/06/02/django-postgres-vue-gitlab-ecs",{"_path":32588,"_dir":17585,"_draft":7,"_partial":7,"_locale":8,"title":32589,"description":32590,"layout":16873,"date":32591,"comments":44,"image":32592,"tags":32593,"body":32594,"_type":7809,"_id":32686,"_source":7811,"_file":32687,"_stem":32688,"_extension":7814},"/2019/01/09/django-docker-vue-nginx-drf-traefik-celery","Setup, Development and Deployment of a web app using Django, VueJS, VuePress, Docker, nginx, traefik and GitLab","This project is currently deployed on https://verbose-equals-true.tk. The source code is available at https://gitlab.com/briancaffey/verbose-equals-true.","2019-01-09T00:00:00.000Z","/static/technologies.png",[14,13929,24,16648],{"type":46,"children":32595,"toc":32684},[32596,32616,32621,32660,32665,32672],{"type":49,"tag":58,"props":32597,"children":32598},{},[32599,32601,32607,32609,32615],{"type":55,"value":32600},"This project is currently deployed on ",{"type":49,"tag":80,"props":32602,"children":32605},{"href":32603,"rel":32604},"https://verbose-equals-true.tk",[84],[32606],{"type":55,"value":32603},{"type":55,"value":32608},". The source code is available at ",{"type":49,"tag":80,"props":32610,"children":32613},{"href":32611,"rel":32612},"https://gitlab.com/briancaffey/verbose-equals-true",[84],[32614],{"type":55,"value":32611},{"type":55,"value":745},{"type":49,"tag":58,"props":32617,"children":32618},{},[32619],{"type":55,"value":32620},"The goal of this project is to explain how to setup a project starting with a fresh installation of 16.04. Setup includes local development environment, GitLab CI/CD, VSCode settings and configuration of the different containers that make up the application:",{"type":49,"tag":64,"props":32622,"children":32623},{},[32624,32628,32633,32637,32641,32646,32650,32655],{"type":49,"tag":68,"props":32625,"children":32626},{},[32627],{"type":55,"value":27066},{"type":49,"tag":68,"props":32629,"children":32630},{},[32631],{"type":55,"value":32632},"Node (for local development with VueJS)",{"type":49,"tag":68,"props":32634,"children":32635},{},[32636],{"type":55,"value":17594},{"type":49,"tag":68,"props":32638,"children":32639},{},[32640],{"type":55,"value":21189},{"type":49,"tag":68,"props":32642,"children":32643},{},[32644],{"type":55,"value":32645},"Postgres",{"type":49,"tag":68,"props":32647,"children":32648},{},[32649],{"type":55,"value":3264},{"type":49,"tag":68,"props":32651,"children":32652},{},[32653],{"type":55,"value":32654},"flower",{"type":49,"tag":68,"props":32656,"children":32657},{},[32658],{"type":55,"value":32659},"portainer",{"type":49,"tag":58,"props":32661,"children":32662},{},[32663],{"type":55,"value":32664},"Here's an overview of the architecture used in the application:",{"type":49,"tag":58,"props":32666,"children":32667},{},[32668],{"type":49,"tag":1601,"props":32669,"children":32671},{"alt":8926,"src":32670},"/static/architecture.png",[],{"type":49,"tag":58,"props":32673,"children":32674},{},[32675,32677,32683],{"type":55,"value":32676},"Extensive documentation for this project can be found at ",{"type":49,"tag":80,"props":32678,"children":32681},{"href":32679,"rel":32680},"https://verbose-equals-true.tk/docs",[84],[32682],{"type":55,"value":32679},{"type":55,"value":745},{"title":8,"searchDepth":1079,"depth":1079,"links":32685},[],"content:2019:01:09:django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery",{"_path":32690,"_dir":32691,"_draft":7,"_partial":7,"_locale":8,"title":32692,"description":8,"layout":16873,"date":32693,"comments":44,"image":32694,"disqus_id":32695,"tags":32696,"body":32702,"_type":7809,"_id":42045,"_source":7811,"_file":42046,"_stem":42047,"_extension":7814},"/2018/02/19/leaflet-maps-with-django","19","Display, filter and export geographical data in a Django app with Leaflet, Mapbox, DataTables, Bootstrap 4 and Travis-CI","2018-02-19T00:00:00.000Z","/static/map_homepage.png","/2018/02/19/leaflet-maps-with-django.html",[32697,14,32698,32699,32700,32701],"leaflet","mapbox","data-tables","bootstrap","travis-ci",{"type":46,"children":32703,"toc":42033},[32704,32711,32722,32735,32743,32755,32777,32782,32927,32932,32937,32943,32948,32960,33154,33159,33165,33177,33189,33194,33609,33622,33670,33682,33960,33965,33970,33974,35093,35097,35103,35116,35121,35491,35503,35507,35795,35799,35825,35846,35860,35879,35885,35898,35986,36005,36025,36498,36503,36516,36520,36618,36622,36635,36641,36676,36681,37198,37226,37262,38038,38050,38249,38255,38260,38290,38596,38608,38612,39525,39529,39565,39585,39593,39619,39624,39895,39900,39928,39934,39939,39947,39954,39959,40343,40348,40356,40369,40483,40495,40956,41063,41068,41074,41079,41099,41298,41303,41326,41339,41345,41350,41376,41384,41777,41785,41999,42004,42012,42017,42029],{"type":49,"tag":58,"props":32705,"children":32706},{},[32707],{"type":49,"tag":1601,"props":32708,"children":32710},{"alt":8926,"src":32709},"/static/map_entire.png",[],{"type":49,"tag":430,"props":32712,"children":32714},{"id":32713},"live-demo-on-digitalocean",[32715],{"type":49,"tag":80,"props":32716,"children":32719},{"href":32717,"rel":32718},"http://159.89.235.193/books/",[84],[32720],{"type":55,"value":32721},"Live Demo on DigitalOcean",{"type":49,"tag":58,"props":32723,"children":32724},{},[32725,32727,32734],{"type":55,"value":32726},"This post is a review of my first attempt at using geographical data in a Django project. I have been interested in working with map APIs, and I once looked into the Google Maps API. For this project I chose to use ",{"type":49,"tag":80,"props":32728,"children":32731},{"href":32729,"rel":32730},"http://leafletjs.com/",[84],[32732],{"type":55,"value":32733},"Leaflet",{"type":55,"value":6694},{"type":49,"tag":2910,"props":32736,"children":32737},{},[32738],{"type":49,"tag":58,"props":32739,"children":32740},{},[32741],{"type":55,"value":32742},"an open-source JavaScript library for mobile-friendly interactive maps",{"type":49,"tag":58,"props":32744,"children":32745},{},[32746,32748,32754],{"type":55,"value":32747},"Getting started with Leaflet is easy. All you need to do is request a public Mapbox API key which is free (with no credit card required). You can get a key from ",{"type":49,"tag":80,"props":32749,"children":32752},{"href":32750,"rel":32751},"https://www.mapbox.com/account/access-tokens/",[84],[32753],{"type":55,"value":32750},{"type":55,"value":745},{"type":49,"tag":58,"props":32756,"children":32757},{},[32758,32760,32767,32769,32775],{"type":55,"value":32759},"Then you will follow steps on the ",{"type":49,"tag":80,"props":32761,"children":32764},{"href":32762,"rel":32763},"http://leafletjs.com/examples/quick-start/",[84],[32765],{"type":55,"value":32766},"quickstart guide",{"type":55,"value":32768}," and replace ",{"type":49,"tag":326,"props":32770,"children":32772},{"className":32771},[],[32773],{"type":55,"value":32774},"your.mapbox.access.token",{"type":55,"value":32776}," with your Mapbox API key.",{"type":49,"tag":58,"props":32778,"children":32779},{},[32780],{"type":55,"value":32781},"{% raw %}",{"type":49,"tag":1050,"props":32783,"children":32787},{"code":32784,"language":32785,"meta":8,"className":32786,"style":8},"L.tileLayer(\n  'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',\n  {\n    attribution:\n      'Map data &copy; \u003Ca href=\"http://openstreetmap.org\">OpenStreetMap\u003C/a> contributors, \u003Ca href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA\u003C/a>, Imagery Â© \u003Ca href=\"http://mapbox.com\">Mapbox\u003C/a>',\n    maxZoom: 18,\n    id: 'mapbox.streets',\n    accessToken: 'your.mapbox.access.token',\n  }\n).addTo(mymap)\n","javascript","language-javascript shiki shiki-themes github-light github-dark monokai",[32788],{"type":49,"tag":326,"props":32789,"children":32790},{"__ignoreMap":8},[32791,32812,32824,32832,32840,32852,32869,32886,32903,32910],{"type":49,"tag":1060,"props":32792,"children":32793},{"class":1062,"line":1063},[32794,32799,32803,32808],{"type":49,"tag":1060,"props":32795,"children":32796},{"style":2188},[32797],{"type":55,"value":32798},"L",{"type":49,"tag":1060,"props":32800,"children":32801},{"style":1073},[32802],{"type":55,"value":745},{"type":49,"tag":1060,"props":32804,"children":32805},{"style":1067},[32806],{"type":55,"value":32807},"tileLayer",{"type":49,"tag":1060,"props":32809,"children":32810},{"style":1073},[32811],{"type":55,"value":32109},{"type":49,"tag":1060,"props":32813,"children":32814},{"class":1062,"line":1079},[32815,32820],{"type":49,"tag":1060,"props":32816,"children":32817},{"style":2215},[32818],{"type":55,"value":32819},"  'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'",{"type":49,"tag":1060,"props":32821,"children":32822},{"style":1073},[32823],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32825,"children":32826},{"class":1062,"line":1088},[32827],{"type":49,"tag":1060,"props":32828,"children":32829},{"style":1073},[32830],{"type":55,"value":32831},"  {\n",{"type":49,"tag":1060,"props":32833,"children":32834},{"class":1062,"line":1097},[32835],{"type":49,"tag":1060,"props":32836,"children":32837},{"style":1073},[32838],{"type":55,"value":32839},"    attribution:\n",{"type":49,"tag":1060,"props":32841,"children":32842},{"class":1062,"line":1111},[32843,32848],{"type":49,"tag":1060,"props":32844,"children":32845},{"style":2215},[32846],{"type":55,"value":32847},"      'Map data &copy; \u003Ca href=\"http://openstreetmap.org\">OpenStreetMap\u003C/a> contributors, \u003Ca href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA\u003C/a>, Imagery Â© \u003Ca href=\"http://mapbox.com\">Mapbox\u003C/a>'",{"type":49,"tag":1060,"props":32849,"children":32850},{"style":1073},[32851],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32853,"children":32854},{"class":1062,"line":1120},[32855,32860,32865],{"type":49,"tag":1060,"props":32856,"children":32857},{"style":1073},[32858],{"type":55,"value":32859},"    maxZoom: ",{"type":49,"tag":1060,"props":32861,"children":32862},{"style":2287},[32863],{"type":55,"value":32864},"18",{"type":49,"tag":1060,"props":32866,"children":32867},{"style":1073},[32868],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32870,"children":32871},{"class":1062,"line":1128},[32872,32877,32882],{"type":49,"tag":1060,"props":32873,"children":32874},{"style":1073},[32875],{"type":55,"value":32876},"    id: ",{"type":49,"tag":1060,"props":32878,"children":32879},{"style":2215},[32880],{"type":55,"value":32881},"'mapbox.streets'",{"type":49,"tag":1060,"props":32883,"children":32884},{"style":1073},[32885],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32887,"children":32888},{"class":1062,"line":1141},[32889,32894,32899],{"type":49,"tag":1060,"props":32890,"children":32891},{"style":1073},[32892],{"type":55,"value":32893},"    accessToken: ",{"type":49,"tag":1060,"props":32895,"children":32896},{"style":2215},[32897],{"type":55,"value":32898},"'your.mapbox.access.token'",{"type":49,"tag":1060,"props":32900,"children":32901},{"style":1073},[32902],{"type":55,"value":2497},{"type":49,"tag":1060,"props":32904,"children":32905},{"class":1062,"line":1150},[32906],{"type":49,"tag":1060,"props":32907,"children":32908},{"style":1073},[32909],{"type":55,"value":4075},{"type":49,"tag":1060,"props":32911,"children":32912},{"class":1062,"line":1158},[32913,32917,32922],{"type":49,"tag":1060,"props":32914,"children":32915},{"style":1073},[32916],{"type":55,"value":3213},{"type":49,"tag":1060,"props":32918,"children":32919},{"style":1067},[32920],{"type":55,"value":32921},"addTo",{"type":49,"tag":1060,"props":32923,"children":32924},{"style":1073},[32925],{"type":55,"value":32926},"(mymap)\n",{"type":49,"tag":58,"props":32928,"children":32929},{},[32930],{"type":55,"value":32931},"{% endraw %}",{"type":49,"tag":58,"props":32933,"children":32934},{},[32935],{"type":55,"value":32936},"I'll come back to using Leaflet later on, and also show how to use Leaflet plugins that can be used to add functionality such as aggregating markers on a map.",{"type":49,"tag":50,"props":32938,"children":32940},{"id":32939},"django-model",[32941],{"type":55,"value":32942},"Django model",{"type":49,"tag":58,"props":32944,"children":32945},{},[32946],{"type":55,"value":32947},"Next, let's look at the Django setup. For now I'm simply working with a local project and SQLite3 backend.",{"type":49,"tag":58,"props":32949,"children":32950},{},[32951,32953,32959],{"type":55,"value":32952},"To store latitude and longitude data, we can use ",{"type":49,"tag":326,"props":32954,"children":32956},{"className":32955},[],[32957],{"type":55,"value":32958},"DecimalField",{"type":55,"value":6694},{"type":49,"tag":1050,"props":32961,"children":32963},{"code":32962,"language":28337,"meta":8,"className":28338,"style":8},"class Book(models.Model):\n    title = models.CharField(max_length=300)\n    lat = models.DecimalField(max_digits=9, decimal_places=6)\n    lon = models.DecimalField(max_digits=9, decimal_places=6)\n    [...]\n",[32964],{"type":49,"tag":326,"props":32965,"children":32966},{"__ignoreMap":8},[32967,33001,33036,33089,33137],{"type":49,"tag":1060,"props":32968,"children":32969},{"class":1062,"line":1063},[32970,32974,32979,32983,32988,32992,32997],{"type":49,"tag":1060,"props":32971,"children":32972},{"style":2182},[32973],{"type":55,"value":31987},{"type":49,"tag":1060,"props":32975,"children":32976},{"style":3992},[32977],{"type":55,"value":32978}," Book",{"type":49,"tag":1060,"props":32980,"children":32981},{"style":1073},[32982],{"type":55,"value":2284},{"type":49,"tag":1060,"props":32984,"children":32985},{"style":31999},[32986],{"type":55,"value":32987},"models",{"type":49,"tag":1060,"props":32989,"children":32990},{"style":1073},[32991],{"type":55,"value":745},{"type":49,"tag":1060,"props":32993,"children":32994},{"style":31999},[32995],{"type":55,"value":32996},"Model",{"type":49,"tag":1060,"props":32998,"children":32999},{"style":1073},[33000],{"type":55,"value":22242},{"type":49,"tag":1060,"props":33002,"children":33003},{"class":1062,"line":1079},[33004,33009,33013,33018,33023,33027,33032],{"type":49,"tag":1060,"props":33005,"children":33006},{"style":1073},[33007],{"type":55,"value":33008},"    title ",{"type":49,"tag":1060,"props":33010,"children":33011},{"style":2194},[33012],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33014,"children":33015},{"style":1073},[33016],{"type":55,"value":33017}," models.CharField(",{"type":49,"tag":1060,"props":33019,"children":33020},{"style":22635},[33021],{"type":55,"value":33022},"max_length",{"type":49,"tag":1060,"props":33024,"children":33025},{"style":2194},[33026],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33028,"children":33029},{"style":2287},[33030],{"type":55,"value":33031},"300",{"type":49,"tag":1060,"props":33033,"children":33034},{"style":1073},[33035],{"type":55,"value":5126},{"type":49,"tag":1060,"props":33037,"children":33038},{"class":1062,"line":1088},[33039,33044,33048,33053,33058,33062,33067,33071,33076,33080,33085],{"type":49,"tag":1060,"props":33040,"children":33041},{"style":1073},[33042],{"type":55,"value":33043},"    lat ",{"type":49,"tag":1060,"props":33045,"children":33046},{"style":2194},[33047],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33049,"children":33050},{"style":1073},[33051],{"type":55,"value":33052}," models.DecimalField(",{"type":49,"tag":1060,"props":33054,"children":33055},{"style":22635},[33056],{"type":55,"value":33057},"max_digits",{"type":49,"tag":1060,"props":33059,"children":33060},{"style":2194},[33061],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33063,"children":33064},{"style":2287},[33065],{"type":55,"value":33066},"9",{"type":49,"tag":1060,"props":33068,"children":33069},{"style":1073},[33070],{"type":55,"value":873},{"type":49,"tag":1060,"props":33072,"children":33073},{"style":22635},[33074],{"type":55,"value":33075},"decimal_places",{"type":49,"tag":1060,"props":33077,"children":33078},{"style":2194},[33079],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33081,"children":33082},{"style":2287},[33083],{"type":55,"value":33084},"6",{"type":49,"tag":1060,"props":33086,"children":33087},{"style":1073},[33088],{"type":55,"value":5126},{"type":49,"tag":1060,"props":33090,"children":33091},{"class":1062,"line":1097},[33092,33097,33101,33105,33109,33113,33117,33121,33125,33129,33133],{"type":49,"tag":1060,"props":33093,"children":33094},{"style":1073},[33095],{"type":55,"value":33096},"    lon ",{"type":49,"tag":1060,"props":33098,"children":33099},{"style":2194},[33100],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33102,"children":33103},{"style":1073},[33104],{"type":55,"value":33052},{"type":49,"tag":1060,"props":33106,"children":33107},{"style":22635},[33108],{"type":55,"value":33057},{"type":49,"tag":1060,"props":33110,"children":33111},{"style":2194},[33112],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33114,"children":33115},{"style":2287},[33116],{"type":55,"value":33066},{"type":49,"tag":1060,"props":33118,"children":33119},{"style":1073},[33120],{"type":55,"value":873},{"type":49,"tag":1060,"props":33122,"children":33123},{"style":22635},[33124],{"type":55,"value":33075},{"type":49,"tag":1060,"props":33126,"children":33127},{"style":2194},[33128],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33130,"children":33131},{"style":2287},[33132],{"type":55,"value":33084},{"type":49,"tag":1060,"props":33134,"children":33135},{"style":1073},[33136],{"type":55,"value":5126},{"type":49,"tag":1060,"props":33138,"children":33139},{"class":1062,"line":1111},[33140,33145,33149],{"type":49,"tag":1060,"props":33141,"children":33142},{"style":1073},[33143],{"type":55,"value":33144},"    [",{"type":49,"tag":1060,"props":33146,"children":33147},{"style":2287},[33148],{"type":55,"value":3078},{"type":49,"tag":1060,"props":33150,"children":33151},{"style":1073},[33152],{"type":55,"value":33153},"]\n",{"type":49,"tag":58,"props":33155,"children":33156},{},[33157],{"type":55,"value":33158},"This allows us to store numbers to six decimal places. The difference between 0 and 0.00001 is about 3 feet, so this gives us plenty of accuracy for our geographical coordinate data.",{"type":49,"tag":50,"props":33160,"children":33162},{"id":33161},"plotting-books-on-a-map",[33163],{"type":55,"value":33164},"Plotting books on a map",{"type":49,"tag":58,"props":33166,"children":33167},{},[33168,33170,33175],{"type":55,"value":33169},"Plotting our books on a map is fairly straightforward, but there were a few obstacles to work around. Initially I setup an additional endpoint that returned an AJAX response with the longitude, latitude, title and link for each book. The ",{"type":49,"tag":326,"props":33171,"children":33173},{"className":33172},[],[33174],{"type":55,"value":17185},{"type":55,"value":33176}," function in the AJAX call then passed the returned JSON into a function that populated the book data in the map.",{"type":49,"tag":58,"props":33178,"children":33179},{},[33180,33181,33187],{"type":55,"value":29685},{"type":49,"tag":326,"props":33182,"children":33184},{"className":33183},[],[33185],{"type":55,"value":33186},"books",{"type":55,"value":33188}," page displays book data in two places: on the map and on the DataTable below the map. Since I was already making one database query for DataTables, I decided to reuse this data for the map and not use a separate request and database query. There are a few helpful idioms in Python and JavaScript to accomplish this.",{"type":49,"tag":58,"props":33190,"children":33191},{},[33192],{"type":55,"value":33193},"First, let's look at the request with some added comments:",{"type":49,"tag":1050,"props":33195,"children":33197},{"code":33196,"language":28337,"meta":8,"className":28338,"style":8},"def all_books(request):\n    \"\"\"\n    Main view for books. request.GET parameters are used to filter books\n    \"\"\"\n    books = Book.objects.all()\n    form = QueryForm(request.GET or None)\n    paramDict = request.GET\n\n    books = filter_books(books, paramDict)\n\n    page_count = books.aggregate(Sum('pages'))\n\n    # This takes the first book query an reformats the data so it can be read\n    # by the map script on the frontend.\n    map_books = [{'loc':[float(book.lon), float(book.lat)],\n                  'title':book.title,\n                  'url':book.get_absolute_url()} for book in books]\n    context = {\n        'books':books,\n        # Here, we apply `json.dumps`, `escapejs` and `marksafe` for security\n        # and proper formatting\n        'map_books': mark_safe(escapejs(json.dumps(map_books))),\n        'page_count':page_count['pages__sum'],\n        'form':form}\n    return render(request, 'books/books.html', context)\n\n",[33198],{"type":49,"tag":326,"props":33199,"children":33200},{"__ignoreMap":8},[33201,33226,33234,33242,33249,33266,33301,33323,33330,33346,33353,33380,33387,33395,33403,33449,33462,33493,33509,33522,33530,33538,33551,33574,33587],{"type":49,"tag":1060,"props":33202,"children":33203},{"class":1062,"line":1063},[33204,33208,33213,33217,33222],{"type":49,"tag":1060,"props":33205,"children":33206},{"style":2182},[33207],{"type":55,"value":22214},{"type":49,"tag":1060,"props":33209,"children":33210},{"style":1067},[33211],{"type":55,"value":33212}," all_books",{"type":49,"tag":1060,"props":33214,"children":33215},{"style":1073},[33216],{"type":55,"value":2284},{"type":49,"tag":1060,"props":33218,"children":33219},{"style":22226},[33220],{"type":55,"value":33221},"request",{"type":49,"tag":1060,"props":33223,"children":33224},{"style":1073},[33225],{"type":55,"value":22242},{"type":49,"tag":1060,"props":33227,"children":33228},{"class":1062,"line":1079},[33229],{"type":49,"tag":1060,"props":33230,"children":33231},{"style":2215},[33232],{"type":55,"value":33233},"    \"\"\"\n",{"type":49,"tag":1060,"props":33235,"children":33236},{"class":1062,"line":1088},[33237],{"type":49,"tag":1060,"props":33238,"children":33239},{"style":2215},[33240],{"type":55,"value":33241},"    Main view for books. request.GET parameters are used to filter books\n",{"type":49,"tag":1060,"props":33243,"children":33244},{"class":1062,"line":1097},[33245],{"type":49,"tag":1060,"props":33246,"children":33247},{"style":2215},[33248],{"type":55,"value":33233},{"type":49,"tag":1060,"props":33250,"children":33251},{"class":1062,"line":1111},[33252,33257,33261],{"type":49,"tag":1060,"props":33253,"children":33254},{"style":1073},[33255],{"type":55,"value":33256},"    books ",{"type":49,"tag":1060,"props":33258,"children":33259},{"style":2194},[33260],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33262,"children":33263},{"style":1073},[33264],{"type":55,"value":33265}," Book.objects.all()\n",{"type":49,"tag":1060,"props":33267,"children":33268},{"class":1062,"line":1120},[33269,33274,33278,33283,33287,33292,33297],{"type":49,"tag":1060,"props":33270,"children":33271},{"style":1073},[33272],{"type":55,"value":33273},"    form ",{"type":49,"tag":1060,"props":33275,"children":33276},{"style":2194},[33277],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33279,"children":33280},{"style":1073},[33281],{"type":55,"value":33282}," QueryForm(request.",{"type":49,"tag":1060,"props":33284,"children":33285},{"style":2287},[33286],{"type":55,"value":17032},{"type":49,"tag":1060,"props":33288,"children":33289},{"style":2194},[33290],{"type":55,"value":33291}," or",{"type":49,"tag":1060,"props":33293,"children":33294},{"style":2287},[33295],{"type":55,"value":33296}," None",{"type":49,"tag":1060,"props":33298,"children":33299},{"style":1073},[33300],{"type":55,"value":5126},{"type":49,"tag":1060,"props":33302,"children":33303},{"class":1062,"line":1128},[33304,33309,33313,33318],{"type":49,"tag":1060,"props":33305,"children":33306},{"style":1073},[33307],{"type":55,"value":33308},"    paramDict ",{"type":49,"tag":1060,"props":33310,"children":33311},{"style":2194},[33312],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33314,"children":33315},{"style":1073},[33316],{"type":55,"value":33317}," request.",{"type":49,"tag":1060,"props":33319,"children":33320},{"style":2287},[33321],{"type":55,"value":33322},"GET\n",{"type":49,"tag":1060,"props":33324,"children":33325},{"class":1062,"line":1141},[33326],{"type":49,"tag":1060,"props":33327,"children":33328},{"emptyLinePlaceholder":44},[33329],{"type":55,"value":1094},{"type":49,"tag":1060,"props":33331,"children":33332},{"class":1062,"line":1150},[33333,33337,33341],{"type":49,"tag":1060,"props":33334,"children":33335},{"style":1073},[33336],{"type":55,"value":33256},{"type":49,"tag":1060,"props":33338,"children":33339},{"style":2194},[33340],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33342,"children":33343},{"style":1073},[33344],{"type":55,"value":33345}," filter_books(books, paramDict)\n",{"type":49,"tag":1060,"props":33347,"children":33348},{"class":1062,"line":1158},[33349],{"type":49,"tag":1060,"props":33350,"children":33351},{"emptyLinePlaceholder":44},[33352],{"type":55,"value":1094},{"type":49,"tag":1060,"props":33354,"children":33355},{"class":1062,"line":1171},[33356,33361,33365,33370,33375],{"type":49,"tag":1060,"props":33357,"children":33358},{"style":1073},[33359],{"type":55,"value":33360},"    page_count ",{"type":49,"tag":1060,"props":33362,"children":33363},{"style":2194},[33364],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33366,"children":33367},{"style":1073},[33368],{"type":55,"value":33369}," books.aggregate(Sum(",{"type":49,"tag":1060,"props":33371,"children":33372},{"style":2215},[33373],{"type":55,"value":33374},"'pages'",{"type":49,"tag":1060,"props":33376,"children":33377},{"style":1073},[33378],{"type":55,"value":33379},"))\n",{"type":49,"tag":1060,"props":33381,"children":33382},{"class":1062,"line":1180},[33383],{"type":49,"tag":1060,"props":33384,"children":33385},{"emptyLinePlaceholder":44},[33386],{"type":55,"value":1094},{"type":49,"tag":1060,"props":33388,"children":33389},{"class":1062,"line":1188},[33390],{"type":49,"tag":1060,"props":33391,"children":33392},{"style":3039},[33393],{"type":55,"value":33394},"    # This takes the first book query an reformats the data so it can be read\n",{"type":49,"tag":1060,"props":33396,"children":33397},{"class":1062,"line":1201},[33398],{"type":49,"tag":1060,"props":33399,"children":33400},{"style":3039},[33401],{"type":55,"value":33402},"    # by the map script on the frontend.\n",{"type":49,"tag":1060,"props":33404,"children":33405},{"class":1062,"line":1210},[33406,33411,33415,33420,33425,33430,33435,33440,33444],{"type":49,"tag":1060,"props":33407,"children":33408},{"style":1073},[33409],{"type":55,"value":33410},"    map_books ",{"type":49,"tag":1060,"props":33412,"children":33413},{"style":2194},[33414],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33416,"children":33417},{"style":1073},[33418],{"type":55,"value":33419}," [{",{"type":49,"tag":1060,"props":33421,"children":33422},{"style":2215},[33423],{"type":55,"value":33424},"'loc'",{"type":49,"tag":1060,"props":33426,"children":33427},{"style":1073},[33428],{"type":55,"value":33429},":[",{"type":49,"tag":1060,"props":33431,"children":33432},{"style":5200},[33433],{"type":55,"value":33434},"float",{"type":49,"tag":1060,"props":33436,"children":33437},{"style":1073},[33438],{"type":55,"value":33439},"(book.lon), ",{"type":49,"tag":1060,"props":33441,"children":33442},{"style":5200},[33443],{"type":55,"value":33434},{"type":49,"tag":1060,"props":33445,"children":33446},{"style":1073},[33447],{"type":55,"value":33448},"(book.lat)],\n",{"type":49,"tag":1060,"props":33450,"children":33451},{"class":1062,"line":1218},[33452,33457],{"type":49,"tag":1060,"props":33453,"children":33454},{"style":2215},[33455],{"type":55,"value":33456},"                  'title'",{"type":49,"tag":1060,"props":33458,"children":33459},{"style":1073},[33460],{"type":55,"value":33461},":book.title,\n",{"type":49,"tag":1060,"props":33463,"children":33464},{"class":1062,"line":1232},[33465,33470,33475,33479,33484,33488],{"type":49,"tag":1060,"props":33466,"children":33467},{"style":2215},[33468],{"type":55,"value":33469},"                  'url'",{"type":49,"tag":1060,"props":33471,"children":33472},{"style":1073},[33473],{"type":55,"value":33474},":book.get_absolute_url()} ",{"type":49,"tag":1060,"props":33476,"children":33477},{"style":2194},[33478],{"type":55,"value":10063},{"type":49,"tag":1060,"props":33480,"children":33481},{"style":1073},[33482],{"type":55,"value":33483}," book ",{"type":49,"tag":1060,"props":33485,"children":33486},{"style":2194},[33487],{"type":55,"value":10073},{"type":49,"tag":1060,"props":33489,"children":33490},{"style":1073},[33491],{"type":55,"value":33492}," books]\n",{"type":49,"tag":1060,"props":33494,"children":33495},{"class":1062,"line":1241},[33496,33501,33505],{"type":49,"tag":1060,"props":33497,"children":33498},{"style":1073},[33499],{"type":55,"value":33500},"    context ",{"type":49,"tag":1060,"props":33502,"children":33503},{"style":2194},[33504],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33506,"children":33507},{"style":1073},[33508],{"type":55,"value":4010},{"type":49,"tag":1060,"props":33510,"children":33511},{"class":1062,"line":1249},[33512,33517],{"type":49,"tag":1060,"props":33513,"children":33514},{"style":2215},[33515],{"type":55,"value":33516},"        'books'",{"type":49,"tag":1060,"props":33518,"children":33519},{"style":1073},[33520],{"type":55,"value":33521},":books,\n",{"type":49,"tag":1060,"props":33523,"children":33524},{"class":1062,"line":1262},[33525],{"type":49,"tag":1060,"props":33526,"children":33527},{"style":3039},[33528],{"type":55,"value":33529},"        # Here, we apply `json.dumps`, `escapejs` and `marksafe` for security\n",{"type":49,"tag":1060,"props":33531,"children":33532},{"class":1062,"line":4581},[33533],{"type":49,"tag":1060,"props":33534,"children":33535},{"style":3039},[33536],{"type":55,"value":33537},"        # and proper formatting\n",{"type":49,"tag":1060,"props":33539,"children":33540},{"class":1062,"line":4631},[33541,33546],{"type":49,"tag":1060,"props":33542,"children":33543},{"style":2215},[33544],{"type":55,"value":33545},"        'map_books'",{"type":49,"tag":1060,"props":33547,"children":33548},{"style":1073},[33549],{"type":55,"value":33550},": mark_safe(escapejs(json.dumps(map_books))),\n",{"type":49,"tag":1060,"props":33552,"children":33553},{"class":1062,"line":4682},[33554,33559,33564,33569],{"type":49,"tag":1060,"props":33555,"children":33556},{"style":2215},[33557],{"type":55,"value":33558},"        'page_count'",{"type":49,"tag":1060,"props":33560,"children":33561},{"style":1073},[33562],{"type":55,"value":33563},":page_count[",{"type":49,"tag":1060,"props":33565,"children":33566},{"style":2215},[33567],{"type":55,"value":33568},"'pages__sum'",{"type":49,"tag":1060,"props":33570,"children":33571},{"style":1073},[33572],{"type":55,"value":33573},"],\n",{"type":49,"tag":1060,"props":33575,"children":33576},{"class":1062,"line":4709},[33577,33582],{"type":49,"tag":1060,"props":33578,"children":33579},{"style":2215},[33580],{"type":55,"value":33581},"        'form'",{"type":49,"tag":1060,"props":33583,"children":33584},{"style":1073},[33585],{"type":55,"value":33586},":form}\n",{"type":49,"tag":1060,"props":33588,"children":33589},{"class":1062,"line":5979},[33590,33594,33599,33604],{"type":49,"tag":1060,"props":33591,"children":33592},{"style":2194},[33593],{"type":55,"value":25371},{"type":49,"tag":1060,"props":33595,"children":33596},{"style":1073},[33597],{"type":55,"value":33598}," render(request, ",{"type":49,"tag":1060,"props":33600,"children":33601},{"style":2215},[33602],{"type":55,"value":33603},"'books/books.html'",{"type":49,"tag":1060,"props":33605,"children":33606},{"style":1073},[33607],{"type":55,"value":33608},", context)\n",{"type":49,"tag":58,"props":33610,"children":33611},{},[33612,33614,33620],{"type":55,"value":33613},"On the frontend, I passed the ",{"type":49,"tag":326,"props":33615,"children":33617},{"className":33616},[],[33618],{"type":55,"value":33619},"map_books",{"type":55,"value":33621}," variable to the template like this:",{"type":49,"tag":1050,"props":33623,"children":33625},{"code":33624,"language":32785,"meta":8,"className":32786,"style":8},"var map_books = JSON.parse('{{ map_books }}')\n",[33626],{"type":49,"tag":326,"props":33627,"children":33628},{"__ignoreMap":8},[33629],{"type":49,"tag":1060,"props":33630,"children":33631},{"class":1062,"line":1063},[33632,33636,33641,33645,33649,33653,33657,33661,33666],{"type":49,"tag":1060,"props":33633,"children":33634},{"style":2182},[33635],{"type":55,"value":6448},{"type":49,"tag":1060,"props":33637,"children":33638},{"style":1073},[33639],{"type":55,"value":33640}," map_books ",{"type":49,"tag":1060,"props":33642,"children":33643},{"style":2194},[33644],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33646,"children":33647},{"style":2188},[33648],{"type":55,"value":6462},{"type":49,"tag":1060,"props":33650,"children":33651},{"style":1073},[33652],{"type":55,"value":745},{"type":49,"tag":1060,"props":33654,"children":33655},{"style":1067},[33656],{"type":55,"value":6471},{"type":49,"tag":1060,"props":33658,"children":33659},{"style":1073},[33660],{"type":55,"value":2284},{"type":49,"tag":1060,"props":33662,"children":33663},{"style":2215},[33664],{"type":55,"value":33665},"'{{ map_books }}'",{"type":49,"tag":1060,"props":33667,"children":33668},{"style":1073},[33669],{"type":55,"value":5126},{"type":49,"tag":58,"props":33671,"children":33672},{},[33673,33675,33680],{"type":55,"value":33674},"Now that I have ",{"type":49,"tag":326,"props":33676,"children":33678},{"className":33677},[],[33679],{"type":55,"value":33619},{"type":55,"value":33681}," as a JavaScript object, I can simply pass it into the map function that populates data in the Leaflet map. Here's the function that does that:",{"type":49,"tag":1050,"props":33683,"children":33685},{"code":33684,"language":32785,"meta":8,"className":32786,"style":8},"function populateMap(data) {\n  for (i in data) {\n    var title = data[i].title, //value searched\n      loc = data[i].loc, //position found\n      url = data[i].url,\n      marker = new L.Marker(new L.latLng(loc), { title: title, icon: bookIcon }) //se property searched\n    marker.bindPopup('\u003Cp>\u003Ca href=\"' + url + '\">' + title + '\u003C/a>\u003C/p>')\n    markersLayer.addLayer(marker)\n  }\n}\n",[33686],{"type":49,"tag":326,"props":33687,"children":33688},{"__ignoreMap":8},[33689,33715,33737,33764,33786,33803,33865,33928,33946,33953],{"type":49,"tag":1060,"props":33690,"children":33691},{"class":1062,"line":1063},[33692,33697,33702,33706,33710],{"type":49,"tag":1060,"props":33693,"children":33694},{"style":2182},[33695],{"type":55,"value":33696},"function",{"type":49,"tag":1060,"props":33698,"children":33699},{"style":1067},[33700],{"type":55,"value":33701}," populateMap",{"type":49,"tag":1060,"props":33703,"children":33704},{"style":1073},[33705],{"type":55,"value":2284},{"type":49,"tag":1060,"props":33707,"children":33708},{"style":22635},[33709],{"type":55,"value":3995},{"type":49,"tag":1060,"props":33711,"children":33712},{"style":1073},[33713],{"type":55,"value":33714},") {\n",{"type":49,"tag":1060,"props":33716,"children":33717},{"class":1062,"line":1079},[33718,33723,33728,33732],{"type":49,"tag":1060,"props":33719,"children":33720},{"style":2194},[33721],{"type":55,"value":33722},"  for",{"type":49,"tag":1060,"props":33724,"children":33725},{"style":1073},[33726],{"type":55,"value":33727}," (i ",{"type":49,"tag":1060,"props":33729,"children":33730},{"style":2194},[33731],{"type":55,"value":10073},{"type":49,"tag":1060,"props":33733,"children":33734},{"style":1073},[33735],{"type":55,"value":33736}," data) {\n",{"type":49,"tag":1060,"props":33738,"children":33739},{"class":1062,"line":1088},[33740,33745,33750,33754,33759],{"type":49,"tag":1060,"props":33741,"children":33742},{"style":2182},[33743],{"type":55,"value":33744},"    var",{"type":49,"tag":1060,"props":33746,"children":33747},{"style":1073},[33748],{"type":55,"value":33749}," title ",{"type":49,"tag":1060,"props":33751,"children":33752},{"style":2194},[33753],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33755,"children":33756},{"style":1073},[33757],{"type":55,"value":33758}," data[i].title, ",{"type":49,"tag":1060,"props":33760,"children":33761},{"style":3039},[33762],{"type":55,"value":33763},"//value searched\n",{"type":49,"tag":1060,"props":33765,"children":33766},{"class":1062,"line":1097},[33767,33772,33776,33781],{"type":49,"tag":1060,"props":33768,"children":33769},{"style":1073},[33770],{"type":55,"value":33771},"      loc ",{"type":49,"tag":1060,"props":33773,"children":33774},{"style":2194},[33775],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33777,"children":33778},{"style":1073},[33779],{"type":55,"value":33780}," data[i].loc, ",{"type":49,"tag":1060,"props":33782,"children":33783},{"style":3039},[33784],{"type":55,"value":33785},"//position found\n",{"type":49,"tag":1060,"props":33787,"children":33788},{"class":1062,"line":1111},[33789,33794,33798],{"type":49,"tag":1060,"props":33790,"children":33791},{"style":1073},[33792],{"type":55,"value":33793},"      url ",{"type":49,"tag":1060,"props":33795,"children":33796},{"style":2194},[33797],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33799,"children":33800},{"style":1073},[33801],{"type":55,"value":33802}," data[i].url,\n",{"type":49,"tag":1060,"props":33804,"children":33805},{"class":1062,"line":1120},[33806,33811,33815,33819,33824,33828,33833,33837,33842,33846,33850,33855,33860],{"type":49,"tag":1060,"props":33807,"children":33808},{"style":1073},[33809],{"type":55,"value":33810},"      marker ",{"type":49,"tag":1060,"props":33812,"children":33813},{"style":2194},[33814],{"type":55,"value":3068},{"type":49,"tag":1060,"props":33816,"children":33817},{"style":2194},[33818],{"type":55,"value":2202},{"type":49,"tag":1060,"props":33820,"children":33821},{"style":2188},[33822],{"type":55,"value":33823}," L",{"type":49,"tag":1060,"props":33825,"children":33826},{"style":1073},[33827],{"type":55,"value":745},{"type":49,"tag":1060,"props":33829,"children":33830},{"style":1067},[33831],{"type":55,"value":33832},"Marker",{"type":49,"tag":1060,"props":33834,"children":33835},{"style":1073},[33836],{"type":55,"value":2284},{"type":49,"tag":1060,"props":33838,"children":33839},{"style":2194},[33840],{"type":55,"value":33841},"new",{"type":49,"tag":1060,"props":33843,"children":33844},{"style":2188},[33845],{"type":55,"value":33823},{"type":49,"tag":1060,"props":33847,"children":33848},{"style":1073},[33849],{"type":55,"value":745},{"type":49,"tag":1060,"props":33851,"children":33852},{"style":1067},[33853],{"type":55,"value":33854},"latLng",{"type":49,"tag":1060,"props":33856,"children":33857},{"style":1073},[33858],{"type":55,"value":33859},"(loc), { title: title, icon: bookIcon }) ",{"type":49,"tag":1060,"props":33861,"children":33862},{"style":3039},[33863],{"type":55,"value":33864},"//se property searched\n",{"type":49,"tag":1060,"props":33866,"children":33867},{"class":1062,"line":1128},[33868,33873,33878,33882,33887,33892,33897,33902,33907,33911,33915,33919,33924],{"type":49,"tag":1060,"props":33869,"children":33870},{"style":1073},[33871],{"type":55,"value":33872},"    marker.",{"type":49,"tag":1060,"props":33874,"children":33875},{"style":1067},[33876],{"type":55,"value":33877},"bindPopup",{"type":49,"tag":1060,"props":33879,"children":33880},{"style":1073},[33881],{"type":55,"value":2284},{"type":49,"tag":1060,"props":33883,"children":33884},{"style":2215},[33885],{"type":55,"value":33886},"'\u003Cp>\u003Ca href=\"'",{"type":49,"tag":1060,"props":33888,"children":33889},{"style":2194},[33890],{"type":55,"value":33891}," +",{"type":49,"tag":1060,"props":33893,"children":33894},{"style":1073},[33895],{"type":55,"value":33896}," url ",{"type":49,"tag":1060,"props":33898,"children":33899},{"style":2194},[33900],{"type":55,"value":33901},"+",{"type":49,"tag":1060,"props":33903,"children":33904},{"style":2215},[33905],{"type":55,"value":33906}," '\">'",{"type":49,"tag":1060,"props":33908,"children":33909},{"style":2194},[33910],{"type":55,"value":33891},{"type":49,"tag":1060,"props":33912,"children":33913},{"style":1073},[33914],{"type":55,"value":33749},{"type":49,"tag":1060,"props":33916,"children":33917},{"style":2194},[33918],{"type":55,"value":33901},{"type":49,"tag":1060,"props":33920,"children":33921},{"style":2215},[33922],{"type":55,"value":33923}," '\u003C/a>\u003C/p>'",{"type":49,"tag":1060,"props":33925,"children":33926},{"style":1073},[33927],{"type":55,"value":5126},{"type":49,"tag":1060,"props":33929,"children":33930},{"class":1062,"line":1141},[33931,33936,33941],{"type":49,"tag":1060,"props":33932,"children":33933},{"style":1073},[33934],{"type":55,"value":33935},"    markersLayer.",{"type":49,"tag":1060,"props":33937,"children":33938},{"style":1067},[33939],{"type":55,"value":33940},"addLayer",{"type":49,"tag":1060,"props":33942,"children":33943},{"style":1073},[33944],{"type":55,"value":33945},"(marker)\n",{"type":49,"tag":1060,"props":33947,"children":33948},{"class":1062,"line":1150},[33949],{"type":49,"tag":1060,"props":33950,"children":33951},{"style":1073},[33952],{"type":55,"value":4075},{"type":49,"tag":1060,"props":33954,"children":33955},{"class":1062,"line":1158},[33956],{"type":49,"tag":1060,"props":33957,"children":33958},{"style":1073},[33959],{"type":55,"value":3675},{"type":49,"tag":58,"props":33961,"children":33962},{},[33963],{"type":55,"value":33964},"This adds our markers to the map, and also passes link and title data to the popup box when a marker is clicked.",{"type":49,"tag":58,"props":33966,"children":33967},{},[33968],{"type":55,"value":33969},"Here's the entire script that is used to populate map data:",{"type":49,"tag":58,"props":33971,"children":33972},{},[33973],{"type":55,"value":32781},{"type":49,"tag":1050,"props":33975,"children":33979},{"code":33976,"language":33977,"meta":8,"className":33978,"style":8},"\u003Cscript>\n  var mymap = new L.Map('mapid', { zoom: 9, center: new L.latLng([40, 13]) }) //set center from first location\n\n  L.tileLayer(\n    'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',\n    {\n      attribution:\n        'Map data &copy; \u003Ca href=\"http://openstreetmap.org\">OpenStreetMap\u003C/a> contributors, \u003Ca href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA\u003C/a>, Imagery Â© \u003Ca href=\"http://mapbox.com\">Mapbox\u003C/a>',\n      maxZoom: 18,\n      id: 'mapbox.streets',\n      accessToken:\n        'pk.eyJ1IjoiYnJpYW5jYWZmZXkiLCJhIjoiY2pkczJycjl5MmhqbTMzbzQ3bHJuaHA3aiJ9.cvRYYPNjQJVpFjdUcmIHzA',\n    }\n  ).addTo(mymap)\n\n  var bookIcon = L.icon({\n    iconUrl: '/static/images/marker-icon.png',\n    iconSize: [35, 35], // size of the icon\n    iconAnchor: [17, 35], // point of the icon which will correspond to marker's location\n    popupAnchor: [0, -30], // point from which the popup should open relative to the iconAnchor\n  })\n\n  var markersLayer = L.markerClusterGroup()\n\n  mymap.addLayer(markersLayer)\n\n  var controlSearch = new L.Control.Search({\n    position: 'topright',\n    layer: markersLayer,\n    initial: false,\n    zoom: 12,\n    marker: false,\n  })\n\n  mymap.addControl(controlSearch)\n\n  function populateMap(data) {\n    for (i in data) {\n      var title = data[i].title, //value searched\n        loc = data[i].loc, //position found\n        url = data[i].url,\n        marker = new L.Marker(new L.latLng(loc), {\n          title: title,\n          icon: bookIcon,\n        }) //se property searched\n      marker.bindPopup('\u003Cp>\u003Ca href=\"' + url + '\">' + title + '\u003C/a>\u003C/p>')\n      markersLayer.addLayer(marker)\n    }\n  }\n\n  // use context variable instead of making AJAX call\n  var map_books = JSON.parse('{{ map_books }}')\n  var new_lat = map_books[0].loc[0]\n  var new_lon = map_books[0].loc[1]\n  mymap.setView([0, 0], 2)\n  populateMap(map_books)\n\u003C/script>\n","html","language-html shiki shiki-themes github-light github-dark monokai",[33980],{"type":49,"tag":326,"props":33981,"children":33982},{"__ignoreMap":8},[33983,33999,34101,34108,34128,34140,34148,34156,34168,34184,34200,34208,34220,34227,34243,34250,34284,34301,34332,34362,34396,34404,34411,34444,34451,34468,34475,34513,34530,34538,34554,34571,34587,34594,34601,34618,34625,34649,34669,34693,34713,34729,34782,34790,34798,34810,34866,34882,34889,34896,34903,34911,34950,34988,35024,35064,35077],{"type":49,"tag":1060,"props":33984,"children":33985},{"class":1062,"line":1063},[33986,33990,33994],{"type":49,"tag":1060,"props":33987,"children":33988},{"style":1073},[33989],{"type":55,"value":5197},{"type":49,"tag":1060,"props":33991,"children":33992},{"style":3839},[33993],{"type":55,"value":29691},{"type":49,"tag":1060,"props":33995,"children":33996},{"style":1073},[33997],{"type":55,"value":33998},">\n",{"type":49,"tag":1060,"props":34000,"children":34001},{"class":1062,"line":1079},[34002,34007,34012,34016,34020,34024,34028,34033,34037,34042,34047,34051,34056,34060,34064,34068,34072,34077,34082,34086,34091,34096],{"type":49,"tag":1060,"props":34003,"children":34004},{"style":2182},[34005],{"type":55,"value":34006},"  var",{"type":49,"tag":1060,"props":34008,"children":34009},{"style":1073},[34010],{"type":55,"value":34011}," mymap ",{"type":49,"tag":1060,"props":34013,"children":34014},{"style":2194},[34015],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34017,"children":34018},{"style":2194},[34019],{"type":55,"value":2202},{"type":49,"tag":1060,"props":34021,"children":34022},{"style":2188},[34023],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34025,"children":34026},{"style":1073},[34027],{"type":55,"value":745},{"type":49,"tag":1060,"props":34029,"children":34030},{"style":1067},[34031],{"type":55,"value":34032},"Map",{"type":49,"tag":1060,"props":34034,"children":34035},{"style":1073},[34036],{"type":55,"value":2284},{"type":49,"tag":1060,"props":34038,"children":34039},{"style":2215},[34040],{"type":55,"value":34041},"'mapid'",{"type":49,"tag":1060,"props":34043,"children":34044},{"style":1073},[34045],{"type":55,"value":34046},", { zoom: ",{"type":49,"tag":1060,"props":34048,"children":34049},{"style":2287},[34050],{"type":55,"value":33066},{"type":49,"tag":1060,"props":34052,"children":34053},{"style":1073},[34054],{"type":55,"value":34055},", center: ",{"type":49,"tag":1060,"props":34057,"children":34058},{"style":2194},[34059],{"type":55,"value":33841},{"type":49,"tag":1060,"props":34061,"children":34062},{"style":2188},[34063],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34065,"children":34066},{"style":1073},[34067],{"type":55,"value":745},{"type":49,"tag":1060,"props":34069,"children":34070},{"style":1067},[34071],{"type":55,"value":33854},{"type":49,"tag":1060,"props":34073,"children":34074},{"style":1073},[34075],{"type":55,"value":34076},"([",{"type":49,"tag":1060,"props":34078,"children":34079},{"style":2287},[34080],{"type":55,"value":34081},"40",{"type":49,"tag":1060,"props":34083,"children":34084},{"style":1073},[34085],{"type":55,"value":873},{"type":49,"tag":1060,"props":34087,"children":34088},{"style":2287},[34089],{"type":55,"value":34090},"13",{"type":49,"tag":1060,"props":34092,"children":34093},{"style":1073},[34094],{"type":55,"value":34095},"]) }) ",{"type":49,"tag":1060,"props":34097,"children":34098},{"style":3039},[34099],{"type":55,"value":34100},"//set center from first location\n",{"type":49,"tag":1060,"props":34102,"children":34103},{"class":1062,"line":1088},[34104],{"type":49,"tag":1060,"props":34105,"children":34106},{"emptyLinePlaceholder":44},[34107],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34109,"children":34110},{"class":1062,"line":1097},[34111,34116,34120,34124],{"type":49,"tag":1060,"props":34112,"children":34113},{"style":2188},[34114],{"type":55,"value":34115},"  L",{"type":49,"tag":1060,"props":34117,"children":34118},{"style":1073},[34119],{"type":55,"value":745},{"type":49,"tag":1060,"props":34121,"children":34122},{"style":1067},[34123],{"type":55,"value":32807},{"type":49,"tag":1060,"props":34125,"children":34126},{"style":1073},[34127],{"type":55,"value":32109},{"type":49,"tag":1060,"props":34129,"children":34130},{"class":1062,"line":1111},[34131,34136],{"type":49,"tag":1060,"props":34132,"children":34133},{"style":2215},[34134],{"type":55,"value":34135},"    'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'",{"type":49,"tag":1060,"props":34137,"children":34138},{"style":1073},[34139],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34141,"children":34142},{"class":1062,"line":1120},[34143],{"type":49,"tag":1060,"props":34144,"children":34145},{"style":1073},[34146],{"type":55,"value":34147},"    {\n",{"type":49,"tag":1060,"props":34149,"children":34150},{"class":1062,"line":1128},[34151],{"type":49,"tag":1060,"props":34152,"children":34153},{"style":1073},[34154],{"type":55,"value":34155},"      attribution:\n",{"type":49,"tag":1060,"props":34157,"children":34158},{"class":1062,"line":1141},[34159,34164],{"type":49,"tag":1060,"props":34160,"children":34161},{"style":2215},[34162],{"type":55,"value":34163},"        'Map data &copy; \u003Ca href=\"http://openstreetmap.org\">OpenStreetMap\u003C/a> contributors, \u003Ca href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA\u003C/a>, Imagery Â© \u003Ca href=\"http://mapbox.com\">Mapbox\u003C/a>'",{"type":49,"tag":1060,"props":34165,"children":34166},{"style":1073},[34167],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34169,"children":34170},{"class":1062,"line":1150},[34171,34176,34180],{"type":49,"tag":1060,"props":34172,"children":34173},{"style":1073},[34174],{"type":55,"value":34175},"      maxZoom: ",{"type":49,"tag":1060,"props":34177,"children":34178},{"style":2287},[34179],{"type":55,"value":32864},{"type":49,"tag":1060,"props":34181,"children":34182},{"style":1073},[34183],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34185,"children":34186},{"class":1062,"line":1158},[34187,34192,34196],{"type":49,"tag":1060,"props":34188,"children":34189},{"style":1073},[34190],{"type":55,"value":34191},"      id: ",{"type":49,"tag":1060,"props":34193,"children":34194},{"style":2215},[34195],{"type":55,"value":32881},{"type":49,"tag":1060,"props":34197,"children":34198},{"style":1073},[34199],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34201,"children":34202},{"class":1062,"line":1171},[34203],{"type":49,"tag":1060,"props":34204,"children":34205},{"style":1073},[34206],{"type":55,"value":34207},"      accessToken:\n",{"type":49,"tag":1060,"props":34209,"children":34210},{"class":1062,"line":1180},[34211,34216],{"type":49,"tag":1060,"props":34212,"children":34213},{"style":2215},[34214],{"type":55,"value":34215},"        'pk.eyJ1IjoiYnJpYW5jYWZmZXkiLCJhIjoiY2pkczJycjl5MmhqbTMzbzQ3bHJuaHA3aiJ9.cvRYYPNjQJVpFjdUcmIHzA'",{"type":49,"tag":1060,"props":34217,"children":34218},{"style":1073},[34219],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34221,"children":34222},{"class":1062,"line":1188},[34223],{"type":49,"tag":1060,"props":34224,"children":34225},{"style":1073},[34226],{"type":55,"value":3100},{"type":49,"tag":1060,"props":34228,"children":34229},{"class":1062,"line":1201},[34230,34235,34239],{"type":49,"tag":1060,"props":34231,"children":34232},{"style":1073},[34233],{"type":55,"value":34234},"  ).",{"type":49,"tag":1060,"props":34236,"children":34237},{"style":1067},[34238],{"type":55,"value":32921},{"type":49,"tag":1060,"props":34240,"children":34241},{"style":1073},[34242],{"type":55,"value":32926},{"type":49,"tag":1060,"props":34244,"children":34245},{"class":1062,"line":1210},[34246],{"type":49,"tag":1060,"props":34247,"children":34248},{"emptyLinePlaceholder":44},[34249],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34251,"children":34252},{"class":1062,"line":1218},[34253,34257,34262,34266,34270,34274,34279],{"type":49,"tag":1060,"props":34254,"children":34255},{"style":2182},[34256],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34258,"children":34259},{"style":1073},[34260],{"type":55,"value":34261}," bookIcon ",{"type":49,"tag":1060,"props":34263,"children":34264},{"style":2194},[34265],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34267,"children":34268},{"style":2188},[34269],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34271,"children":34272},{"style":1073},[34273],{"type":55,"value":745},{"type":49,"tag":1060,"props":34275,"children":34276},{"style":1067},[34277],{"type":55,"value":34278},"icon",{"type":49,"tag":1060,"props":34280,"children":34281},{"style":1073},[34282],{"type":55,"value":34283},"({\n",{"type":49,"tag":1060,"props":34285,"children":34286},{"class":1062,"line":1232},[34287,34292,34297],{"type":49,"tag":1060,"props":34288,"children":34289},{"style":1073},[34290],{"type":55,"value":34291},"    iconUrl: ",{"type":49,"tag":1060,"props":34293,"children":34294},{"style":2215},[34295],{"type":55,"value":34296},"'/static/images/marker-icon.png'",{"type":49,"tag":1060,"props":34298,"children":34299},{"style":1073},[34300],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34302,"children":34303},{"class":1062,"line":1241},[34304,34309,34314,34318,34322,34327],{"type":49,"tag":1060,"props":34305,"children":34306},{"style":1073},[34307],{"type":55,"value":34308},"    iconSize: [",{"type":49,"tag":1060,"props":34310,"children":34311},{"style":2287},[34312],{"type":55,"value":34313},"35",{"type":49,"tag":1060,"props":34315,"children":34316},{"style":1073},[34317],{"type":55,"value":873},{"type":49,"tag":1060,"props":34319,"children":34320},{"style":2287},[34321],{"type":55,"value":34313},{"type":49,"tag":1060,"props":34323,"children":34324},{"style":1073},[34325],{"type":55,"value":34326},"], ",{"type":49,"tag":1060,"props":34328,"children":34329},{"style":3039},[34330],{"type":55,"value":34331},"// size of the icon\n",{"type":49,"tag":1060,"props":34333,"children":34334},{"class":1062,"line":1249},[34335,34340,34345,34349,34353,34357],{"type":49,"tag":1060,"props":34336,"children":34337},{"style":1073},[34338],{"type":55,"value":34339},"    iconAnchor: [",{"type":49,"tag":1060,"props":34341,"children":34342},{"style":2287},[34343],{"type":55,"value":34344},"17",{"type":49,"tag":1060,"props":34346,"children":34347},{"style":1073},[34348],{"type":55,"value":873},{"type":49,"tag":1060,"props":34350,"children":34351},{"style":2287},[34352],{"type":55,"value":34313},{"type":49,"tag":1060,"props":34354,"children":34355},{"style":1073},[34356],{"type":55,"value":34326},{"type":49,"tag":1060,"props":34358,"children":34359},{"style":3039},[34360],{"type":55,"value":34361},"// point of the icon which will correspond to marker's location\n",{"type":49,"tag":1060,"props":34363,"children":34364},{"class":1062,"line":1262},[34365,34370,34374,34378,34382,34387,34391],{"type":49,"tag":1060,"props":34366,"children":34367},{"style":1073},[34368],{"type":55,"value":34369},"    popupAnchor: [",{"type":49,"tag":1060,"props":34371,"children":34372},{"style":2287},[34373],{"type":55,"value":8397},{"type":49,"tag":1060,"props":34375,"children":34376},{"style":1073},[34377],{"type":55,"value":873},{"type":49,"tag":1060,"props":34379,"children":34380},{"style":2194},[34381],{"type":55,"value":10180},{"type":49,"tag":1060,"props":34383,"children":34384},{"style":2287},[34385],{"type":55,"value":34386},"30",{"type":49,"tag":1060,"props":34388,"children":34389},{"style":1073},[34390],{"type":55,"value":34326},{"type":49,"tag":1060,"props":34392,"children":34393},{"style":3039},[34394],{"type":55,"value":34395},"// point from which the popup should open relative to the iconAnchor\n",{"type":49,"tag":1060,"props":34397,"children":34398},{"class":1062,"line":4581},[34399],{"type":49,"tag":1060,"props":34400,"children":34401},{"style":1073},[34402],{"type":55,"value":34403},"  })\n",{"type":49,"tag":1060,"props":34405,"children":34406},{"class":1062,"line":4631},[34407],{"type":49,"tag":1060,"props":34408,"children":34409},{"emptyLinePlaceholder":44},[34410],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34412,"children":34413},{"class":1062,"line":4682},[34414,34418,34423,34427,34431,34435,34440],{"type":49,"tag":1060,"props":34415,"children":34416},{"style":2182},[34417],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34419,"children":34420},{"style":1073},[34421],{"type":55,"value":34422}," markersLayer ",{"type":49,"tag":1060,"props":34424,"children":34425},{"style":2194},[34426],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34428,"children":34429},{"style":2188},[34430],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34432,"children":34433},{"style":1073},[34434],{"type":55,"value":745},{"type":49,"tag":1060,"props":34436,"children":34437},{"style":1067},[34438],{"type":55,"value":34439},"markerClusterGroup",{"type":49,"tag":1060,"props":34441,"children":34442},{"style":1073},[34443],{"type":55,"value":22286},{"type":49,"tag":1060,"props":34445,"children":34446},{"class":1062,"line":4709},[34447],{"type":49,"tag":1060,"props":34448,"children":34449},{"emptyLinePlaceholder":44},[34450],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34452,"children":34453},{"class":1062,"line":5979},[34454,34459,34463],{"type":49,"tag":1060,"props":34455,"children":34456},{"style":1073},[34457],{"type":55,"value":34458},"  mymap.",{"type":49,"tag":1060,"props":34460,"children":34461},{"style":1067},[34462],{"type":55,"value":33940},{"type":49,"tag":1060,"props":34464,"children":34465},{"style":1073},[34466],{"type":55,"value":34467},"(markersLayer)\n",{"type":49,"tag":1060,"props":34469,"children":34470},{"class":1062,"line":5988},[34471],{"type":49,"tag":1060,"props":34472,"children":34473},{"emptyLinePlaceholder":44},[34474],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34476,"children":34477},{"class":1062,"line":5997},[34478,34482,34487,34491,34495,34499,34504,34509],{"type":49,"tag":1060,"props":34479,"children":34480},{"style":2182},[34481],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34483,"children":34484},{"style":1073},[34485],{"type":55,"value":34486}," controlSearch ",{"type":49,"tag":1060,"props":34488,"children":34489},{"style":2194},[34490],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34492,"children":34493},{"style":2194},[34494],{"type":55,"value":2202},{"type":49,"tag":1060,"props":34496,"children":34497},{"style":2188},[34498],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34500,"children":34501},{"style":1073},[34502],{"type":55,"value":34503},".Control.",{"type":49,"tag":1060,"props":34505,"children":34506},{"style":1067},[34507],{"type":55,"value":34508},"Search",{"type":49,"tag":1060,"props":34510,"children":34511},{"style":1073},[34512],{"type":55,"value":34283},{"type":49,"tag":1060,"props":34514,"children":34515},{"class":1062,"line":6006},[34516,34521,34526],{"type":49,"tag":1060,"props":34517,"children":34518},{"style":1073},[34519],{"type":55,"value":34520},"    position: ",{"type":49,"tag":1060,"props":34522,"children":34523},{"style":2215},[34524],{"type":55,"value":34525},"'topright'",{"type":49,"tag":1060,"props":34527,"children":34528},{"style":1073},[34529],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34531,"children":34532},{"class":1062,"line":10142},[34533],{"type":49,"tag":1060,"props":34534,"children":34535},{"style":1073},[34536],{"type":55,"value":34537},"    layer: markersLayer,\n",{"type":49,"tag":1060,"props":34539,"children":34540},{"class":1062,"line":10151},[34541,34546,34550],{"type":49,"tag":1060,"props":34542,"children":34543},{"style":1073},[34544],{"type":55,"value":34545},"    initial: ",{"type":49,"tag":1060,"props":34547,"children":34548},{"style":2287},[34549],{"type":55,"value":2589},{"type":49,"tag":1060,"props":34551,"children":34552},{"style":1073},[34553],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34555,"children":34556},{"class":1062,"line":10160},[34557,34562,34567],{"type":49,"tag":1060,"props":34558,"children":34559},{"style":1073},[34560],{"type":55,"value":34561},"    zoom: ",{"type":49,"tag":1060,"props":34563,"children":34564},{"style":2287},[34565],{"type":55,"value":34566},"12",{"type":49,"tag":1060,"props":34568,"children":34569},{"style":1073},[34570],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34572,"children":34573},{"class":1062,"line":10188},[34574,34579,34583],{"type":49,"tag":1060,"props":34575,"children":34576},{"style":1073},[34577],{"type":55,"value":34578},"    marker: ",{"type":49,"tag":1060,"props":34580,"children":34581},{"style":2287},[34582],{"type":55,"value":2589},{"type":49,"tag":1060,"props":34584,"children":34585},{"style":1073},[34586],{"type":55,"value":2497},{"type":49,"tag":1060,"props":34588,"children":34589},{"class":1062,"line":10196},[34590],{"type":49,"tag":1060,"props":34591,"children":34592},{"style":1073},[34593],{"type":55,"value":34403},{"type":49,"tag":1060,"props":34595,"children":34596},{"class":1062,"line":10205},[34597],{"type":49,"tag":1060,"props":34598,"children":34599},{"emptyLinePlaceholder":44},[34600],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34602,"children":34603},{"class":1062,"line":10242},[34604,34608,34613],{"type":49,"tag":1060,"props":34605,"children":34606},{"style":1073},[34607],{"type":55,"value":34458},{"type":49,"tag":1060,"props":34609,"children":34610},{"style":1067},[34611],{"type":55,"value":34612},"addControl",{"type":49,"tag":1060,"props":34614,"children":34615},{"style":1073},[34616],{"type":55,"value":34617},"(controlSearch)\n",{"type":49,"tag":1060,"props":34619,"children":34620},{"class":1062,"line":10261},[34621],{"type":49,"tag":1060,"props":34622,"children":34623},{"emptyLinePlaceholder":44},[34624],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34626,"children":34627},{"class":1062,"line":10270},[34628,34633,34637,34641,34645],{"type":49,"tag":1060,"props":34629,"children":34630},{"style":2182},[34631],{"type":55,"value":34632},"  function",{"type":49,"tag":1060,"props":34634,"children":34635},{"style":1067},[34636],{"type":55,"value":33701},{"type":49,"tag":1060,"props":34638,"children":34639},{"style":1073},[34640],{"type":55,"value":2284},{"type":49,"tag":1060,"props":34642,"children":34643},{"style":22635},[34644],{"type":55,"value":3995},{"type":49,"tag":1060,"props":34646,"children":34647},{"style":1073},[34648],{"type":55,"value":33714},{"type":49,"tag":1060,"props":34650,"children":34651},{"class":1062,"line":10278},[34652,34657,34661,34665],{"type":49,"tag":1060,"props":34653,"children":34654},{"style":2194},[34655],{"type":55,"value":34656},"    for",{"type":49,"tag":1060,"props":34658,"children":34659},{"style":1073},[34660],{"type":55,"value":33727},{"type":49,"tag":1060,"props":34662,"children":34663},{"style":2194},[34664],{"type":55,"value":10073},{"type":49,"tag":1060,"props":34666,"children":34667},{"style":1073},[34668],{"type":55,"value":33736},{"type":49,"tag":1060,"props":34670,"children":34671},{"class":1062,"line":10287},[34672,34677,34681,34685,34689],{"type":49,"tag":1060,"props":34673,"children":34674},{"style":2182},[34675],{"type":55,"value":34676},"      var",{"type":49,"tag":1060,"props":34678,"children":34679},{"style":1073},[34680],{"type":55,"value":33749},{"type":49,"tag":1060,"props":34682,"children":34683},{"style":2194},[34684],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34686,"children":34687},{"style":1073},[34688],{"type":55,"value":33758},{"type":49,"tag":1060,"props":34690,"children":34691},{"style":3039},[34692],{"type":55,"value":33763},{"type":49,"tag":1060,"props":34694,"children":34695},{"class":1062,"line":10319},[34696,34701,34705,34709],{"type":49,"tag":1060,"props":34697,"children":34698},{"style":1073},[34699],{"type":55,"value":34700},"        loc ",{"type":49,"tag":1060,"props":34702,"children":34703},{"style":2194},[34704],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34706,"children":34707},{"style":1073},[34708],{"type":55,"value":33780},{"type":49,"tag":1060,"props":34710,"children":34711},{"style":3039},[34712],{"type":55,"value":33785},{"type":49,"tag":1060,"props":34714,"children":34715},{"class":1062,"line":10332},[34716,34721,34725],{"type":49,"tag":1060,"props":34717,"children":34718},{"style":1073},[34719],{"type":55,"value":34720},"        url ",{"type":49,"tag":1060,"props":34722,"children":34723},{"style":2194},[34724],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34726,"children":34727},{"style":1073},[34728],{"type":55,"value":33802},{"type":49,"tag":1060,"props":34730,"children":34731},{"class":1062,"line":10356},[34732,34737,34741,34745,34749,34753,34757,34761,34765,34769,34773,34777],{"type":49,"tag":1060,"props":34733,"children":34734},{"style":1073},[34735],{"type":55,"value":34736},"        marker ",{"type":49,"tag":1060,"props":34738,"children":34739},{"style":2194},[34740],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34742,"children":34743},{"style":2194},[34744],{"type":55,"value":2202},{"type":49,"tag":1060,"props":34746,"children":34747},{"style":2188},[34748],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34750,"children":34751},{"style":1073},[34752],{"type":55,"value":745},{"type":49,"tag":1060,"props":34754,"children":34755},{"style":1067},[34756],{"type":55,"value":33832},{"type":49,"tag":1060,"props":34758,"children":34759},{"style":1073},[34760],{"type":55,"value":2284},{"type":49,"tag":1060,"props":34762,"children":34763},{"style":2194},[34764],{"type":55,"value":33841},{"type":49,"tag":1060,"props":34766,"children":34767},{"style":2188},[34768],{"type":55,"value":33823},{"type":49,"tag":1060,"props":34770,"children":34771},{"style":1073},[34772],{"type":55,"value":745},{"type":49,"tag":1060,"props":34774,"children":34775},{"style":1067},[34776],{"type":55,"value":33854},{"type":49,"tag":1060,"props":34778,"children":34779},{"style":1073},[34780],{"type":55,"value":34781},"(loc), {\n",{"type":49,"tag":1060,"props":34783,"children":34784},{"class":1062,"line":10364},[34785],{"type":49,"tag":1060,"props":34786,"children":34787},{"style":1073},[34788],{"type":55,"value":34789},"          title: title,\n",{"type":49,"tag":1060,"props":34791,"children":34792},{"class":1062,"line":10373},[34793],{"type":49,"tag":1060,"props":34794,"children":34795},{"style":1073},[34796],{"type":55,"value":34797},"          icon: bookIcon,\n",{"type":49,"tag":1060,"props":34799,"children":34800},{"class":1062,"line":10395},[34801,34806],{"type":49,"tag":1060,"props":34802,"children":34803},{"style":1073},[34804],{"type":55,"value":34805},"        }) ",{"type":49,"tag":1060,"props":34807,"children":34808},{"style":3039},[34809],{"type":55,"value":33864},{"type":49,"tag":1060,"props":34811,"children":34812},{"class":1062,"line":10403},[34813,34818,34822,34826,34830,34834,34838,34842,34846,34850,34854,34858,34862],{"type":49,"tag":1060,"props":34814,"children":34815},{"style":1073},[34816],{"type":55,"value":34817},"      marker.",{"type":49,"tag":1060,"props":34819,"children":34820},{"style":1067},[34821],{"type":55,"value":33877},{"type":49,"tag":1060,"props":34823,"children":34824},{"style":1073},[34825],{"type":55,"value":2284},{"type":49,"tag":1060,"props":34827,"children":34828},{"style":2215},[34829],{"type":55,"value":33886},{"type":49,"tag":1060,"props":34831,"children":34832},{"style":2194},[34833],{"type":55,"value":33891},{"type":49,"tag":1060,"props":34835,"children":34836},{"style":1073},[34837],{"type":55,"value":33896},{"type":49,"tag":1060,"props":34839,"children":34840},{"style":2194},[34841],{"type":55,"value":33901},{"type":49,"tag":1060,"props":34843,"children":34844},{"style":2215},[34845],{"type":55,"value":33906},{"type":49,"tag":1060,"props":34847,"children":34848},{"style":2194},[34849],{"type":55,"value":33891},{"type":49,"tag":1060,"props":34851,"children":34852},{"style":1073},[34853],{"type":55,"value":33749},{"type":49,"tag":1060,"props":34855,"children":34856},{"style":2194},[34857],{"type":55,"value":33901},{"type":49,"tag":1060,"props":34859,"children":34860},{"style":2215},[34861],{"type":55,"value":33923},{"type":49,"tag":1060,"props":34863,"children":34864},{"style":1073},[34865],{"type":55,"value":5126},{"type":49,"tag":1060,"props":34867,"children":34868},{"class":1062,"line":10412},[34869,34874,34878],{"type":49,"tag":1060,"props":34870,"children":34871},{"style":1073},[34872],{"type":55,"value":34873},"      markersLayer.",{"type":49,"tag":1060,"props":34875,"children":34876},{"style":1067},[34877],{"type":55,"value":33940},{"type":49,"tag":1060,"props":34879,"children":34880},{"style":1073},[34881],{"type":55,"value":33945},{"type":49,"tag":1060,"props":34883,"children":34884},{"class":1062,"line":10438},[34885],{"type":49,"tag":1060,"props":34886,"children":34887},{"style":1073},[34888],{"type":55,"value":3100},{"type":49,"tag":1060,"props":34890,"children":34891},{"class":1062,"line":10455},[34892],{"type":49,"tag":1060,"props":34893,"children":34894},{"style":1073},[34895],{"type":55,"value":4075},{"type":49,"tag":1060,"props":34897,"children":34898},{"class":1062,"line":10492},[34899],{"type":49,"tag":1060,"props":34900,"children":34901},{"emptyLinePlaceholder":44},[34902],{"type":55,"value":1094},{"type":49,"tag":1060,"props":34904,"children":34905},{"class":1062,"line":10513},[34906],{"type":49,"tag":1060,"props":34907,"children":34908},{"style":3039},[34909],{"type":55,"value":34910},"  // use context variable instead of making AJAX call\n",{"type":49,"tag":1060,"props":34912,"children":34913},{"class":1062,"line":10521},[34914,34918,34922,34926,34930,34934,34938,34942,34946],{"type":49,"tag":1060,"props":34915,"children":34916},{"style":2182},[34917],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34919,"children":34920},{"style":1073},[34921],{"type":55,"value":33640},{"type":49,"tag":1060,"props":34923,"children":34924},{"style":2194},[34925],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34927,"children":34928},{"style":2188},[34929],{"type":55,"value":6462},{"type":49,"tag":1060,"props":34931,"children":34932},{"style":1073},[34933],{"type":55,"value":745},{"type":49,"tag":1060,"props":34935,"children":34936},{"style":1067},[34937],{"type":55,"value":6471},{"type":49,"tag":1060,"props":34939,"children":34940},{"style":1073},[34941],{"type":55,"value":2284},{"type":49,"tag":1060,"props":34943,"children":34944},{"style":2215},[34945],{"type":55,"value":33665},{"type":49,"tag":1060,"props":34947,"children":34948},{"style":1073},[34949],{"type":55,"value":5126},{"type":49,"tag":1060,"props":34951,"children":34952},{"class":1062,"line":10530},[34953,34957,34962,34966,34971,34975,34980,34984],{"type":49,"tag":1060,"props":34954,"children":34955},{"style":2182},[34956],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34958,"children":34959},{"style":1073},[34960],{"type":55,"value":34961}," new_lat ",{"type":49,"tag":1060,"props":34963,"children":34964},{"style":2194},[34965],{"type":55,"value":3068},{"type":49,"tag":1060,"props":34967,"children":34968},{"style":1073},[34969],{"type":55,"value":34970}," map_books[",{"type":49,"tag":1060,"props":34972,"children":34973},{"style":2287},[34974],{"type":55,"value":8397},{"type":49,"tag":1060,"props":34976,"children":34977},{"style":1073},[34978],{"type":55,"value":34979},"].loc[",{"type":49,"tag":1060,"props":34981,"children":34982},{"style":2287},[34983],{"type":55,"value":8397},{"type":49,"tag":1060,"props":34985,"children":34986},{"style":1073},[34987],{"type":55,"value":33153},{"type":49,"tag":1060,"props":34989,"children":34990},{"class":1062,"line":10539},[34991,34995,35000,35004,35008,35012,35016,35020],{"type":49,"tag":1060,"props":34992,"children":34993},{"style":2182},[34994],{"type":55,"value":34006},{"type":49,"tag":1060,"props":34996,"children":34997},{"style":1073},[34998],{"type":55,"value":34999}," new_lon ",{"type":49,"tag":1060,"props":35001,"children":35002},{"style":2194},[35003],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35005,"children":35006},{"style":1073},[35007],{"type":55,"value":34970},{"type":49,"tag":1060,"props":35009,"children":35010},{"style":2287},[35011],{"type":55,"value":8397},{"type":49,"tag":1060,"props":35013,"children":35014},{"style":1073},[35015],{"type":55,"value":34979},{"type":49,"tag":1060,"props":35017,"children":35018},{"style":2287},[35019],{"type":55,"value":8405},{"type":49,"tag":1060,"props":35021,"children":35022},{"style":1073},[35023],{"type":55,"value":33153},{"type":49,"tag":1060,"props":35025,"children":35026},{"class":1062,"line":10561},[35027,35031,35036,35040,35044,35048,35052,35056,35060],{"type":49,"tag":1060,"props":35028,"children":35029},{"style":1073},[35030],{"type":55,"value":34458},{"type":49,"tag":1060,"props":35032,"children":35033},{"style":1067},[35034],{"type":55,"value":35035},"setView",{"type":49,"tag":1060,"props":35037,"children":35038},{"style":1073},[35039],{"type":55,"value":34076},{"type":49,"tag":1060,"props":35041,"children":35042},{"style":2287},[35043],{"type":55,"value":8397},{"type":49,"tag":1060,"props":35045,"children":35046},{"style":1073},[35047],{"type":55,"value":873},{"type":49,"tag":1060,"props":35049,"children":35050},{"style":2287},[35051],{"type":55,"value":8397},{"type":49,"tag":1060,"props":35053,"children":35054},{"style":1073},[35055],{"type":55,"value":34326},{"type":49,"tag":1060,"props":35057,"children":35058},{"style":2287},[35059],{"type":55,"value":24195},{"type":49,"tag":1060,"props":35061,"children":35062},{"style":1073},[35063],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35065,"children":35066},{"class":1062,"line":10569},[35067,35072],{"type":49,"tag":1060,"props":35068,"children":35069},{"style":1067},[35070],{"type":55,"value":35071},"  populateMap",{"type":49,"tag":1060,"props":35073,"children":35074},{"style":1073},[35075],{"type":55,"value":35076},"(map_books)\n",{"type":49,"tag":1060,"props":35078,"children":35079},{"class":1062,"line":10611},[35080,35085,35089],{"type":49,"tag":1060,"props":35081,"children":35082},{"style":1073},[35083],{"type":55,"value":35084},"\u003C/",{"type":49,"tag":1060,"props":35086,"children":35087},{"style":3839},[35088],{"type":55,"value":29691},{"type":49,"tag":1060,"props":35090,"children":35091},{"style":1073},[35092],{"type":55,"value":33998},{"type":49,"tag":58,"props":35094,"children":35095},{},[35096],{"type":55,"value":32931},{"type":49,"tag":50,"props":35098,"children":35100},{"id":35099},"login-redirect",[35101],{"type":55,"value":35102},"Login Redirect",{"type":49,"tag":58,"props":35104,"children":35105},{},[35106,35108,35114],{"type":55,"value":35107},"I wanted to include a small note on a simple issue that I previously had trouble with, which is using the ",{"type":49,"tag":326,"props":35109,"children":35111},{"className":35110},[],[35112],{"type":55,"value":35113},"next",{"type":55,"value":35115}," parameter to do a redirect to a page that an unauthenticated user will be redirected to after they successfully login.",{"type":49,"tag":58,"props":35117,"children":35118},{},[35119],{"type":55,"value":35120},"Here's the login view:",{"type":49,"tag":1050,"props":35122,"children":35124},{"code":35123,"language":28337,"meta":8,"className":28338,"style":8},"def login_view(request):\n    next_redirect = request.GET.get('next')\n    form = UserLoginForm(request.POST or None)\n    if form.is_valid():\n        next_redirect = request.POST.get('next')\n        username = form.cleaned_data.get('username')\n        password = form.cleaned_data.get('password')\n        user = authenticate(username=username, password=password)\n        login(request, user)\n        print(next_redirect)\n        if next_redirect != 'None':\n            return redirect(next_redirect)\n        return redirect('books:all')\n    context = { 'form':form, 'next':next_redirect }\n    return render(request, 'accounts/login_form.html', context)\n",[35125],{"type":49,"tag":326,"props":35126,"children":35127},{"__ignoreMap":8},[35128,35152,35186,35218,35230,35262,35288,35312,35356,35364,35377,35403,35416,35437,35471],{"type":49,"tag":1060,"props":35129,"children":35130},{"class":1062,"line":1063},[35131,35135,35140,35144,35148],{"type":49,"tag":1060,"props":35132,"children":35133},{"style":2182},[35134],{"type":55,"value":22214},{"type":49,"tag":1060,"props":35136,"children":35137},{"style":1067},[35138],{"type":55,"value":35139}," login_view",{"type":49,"tag":1060,"props":35141,"children":35142},{"style":1073},[35143],{"type":55,"value":2284},{"type":49,"tag":1060,"props":35145,"children":35146},{"style":22226},[35147],{"type":55,"value":33221},{"type":49,"tag":1060,"props":35149,"children":35150},{"style":1073},[35151],{"type":55,"value":22242},{"type":49,"tag":1060,"props":35153,"children":35154},{"class":1062,"line":1079},[35155,35160,35164,35168,35172,35177,35182],{"type":49,"tag":1060,"props":35156,"children":35157},{"style":1073},[35158],{"type":55,"value":35159},"    next_redirect ",{"type":49,"tag":1060,"props":35161,"children":35162},{"style":2194},[35163],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35165,"children":35166},{"style":1073},[35167],{"type":55,"value":33317},{"type":49,"tag":1060,"props":35169,"children":35170},{"style":2287},[35171],{"type":55,"value":17032},{"type":49,"tag":1060,"props":35173,"children":35174},{"style":1073},[35175],{"type":55,"value":35176},".get(",{"type":49,"tag":1060,"props":35178,"children":35179},{"style":2215},[35180],{"type":55,"value":35181},"'next'",{"type":49,"tag":1060,"props":35183,"children":35184},{"style":1073},[35185],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35187,"children":35188},{"class":1062,"line":1088},[35189,35193,35197,35202,35206,35210,35214],{"type":49,"tag":1060,"props":35190,"children":35191},{"style":1073},[35192],{"type":55,"value":33273},{"type":49,"tag":1060,"props":35194,"children":35195},{"style":2194},[35196],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35198,"children":35199},{"style":1073},[35200],{"type":55,"value":35201}," UserLoginForm(request.",{"type":49,"tag":1060,"props":35203,"children":35204},{"style":2287},[35205],{"type":55,"value":31207},{"type":49,"tag":1060,"props":35207,"children":35208},{"style":2194},[35209],{"type":55,"value":33291},{"type":49,"tag":1060,"props":35211,"children":35212},{"style":2287},[35213],{"type":55,"value":33296},{"type":49,"tag":1060,"props":35215,"children":35216},{"style":1073},[35217],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35219,"children":35220},{"class":1062,"line":1097},[35221,35225],{"type":49,"tag":1060,"props":35222,"children":35223},{"style":2194},[35224],{"type":55,"value":3050},{"type":49,"tag":1060,"props":35226,"children":35227},{"style":1073},[35228],{"type":55,"value":35229}," form.is_valid():\n",{"type":49,"tag":1060,"props":35231,"children":35232},{"class":1062,"line":1111},[35233,35238,35242,35246,35250,35254,35258],{"type":49,"tag":1060,"props":35234,"children":35235},{"style":1073},[35236],{"type":55,"value":35237},"        next_redirect ",{"type":49,"tag":1060,"props":35239,"children":35240},{"style":2194},[35241],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35243,"children":35244},{"style":1073},[35245],{"type":55,"value":33317},{"type":49,"tag":1060,"props":35247,"children":35248},{"style":2287},[35249],{"type":55,"value":31207},{"type":49,"tag":1060,"props":35251,"children":35252},{"style":1073},[35253],{"type":55,"value":35176},{"type":49,"tag":1060,"props":35255,"children":35256},{"style":2215},[35257],{"type":55,"value":35181},{"type":49,"tag":1060,"props":35259,"children":35260},{"style":1073},[35261],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35263,"children":35264},{"class":1062,"line":1120},[35265,35270,35274,35279,35284],{"type":49,"tag":1060,"props":35266,"children":35267},{"style":1073},[35268],{"type":55,"value":35269},"        username ",{"type":49,"tag":1060,"props":35271,"children":35272},{"style":2194},[35273],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35275,"children":35276},{"style":1073},[35277],{"type":55,"value":35278}," form.cleaned_data.get(",{"type":49,"tag":1060,"props":35280,"children":35281},{"style":2215},[35282],{"type":55,"value":35283},"'username'",{"type":49,"tag":1060,"props":35285,"children":35286},{"style":1073},[35287],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35289,"children":35290},{"class":1062,"line":1128},[35291,35296,35300,35304,35308],{"type":49,"tag":1060,"props":35292,"children":35293},{"style":1073},[35294],{"type":55,"value":35295},"        password ",{"type":49,"tag":1060,"props":35297,"children":35298},{"style":2194},[35299],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35301,"children":35302},{"style":1073},[35303],{"type":55,"value":35278},{"type":49,"tag":1060,"props":35305,"children":35306},{"style":2215},[35307],{"type":55,"value":2555},{"type":49,"tag":1060,"props":35309,"children":35310},{"style":1073},[35311],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35313,"children":35314},{"class":1062,"line":1141},[35315,35320,35324,35329,35334,35338,35343,35347,35351],{"type":49,"tag":1060,"props":35316,"children":35317},{"style":1073},[35318],{"type":55,"value":35319},"        user ",{"type":49,"tag":1060,"props":35321,"children":35322},{"style":2194},[35323],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35325,"children":35326},{"style":1073},[35327],{"type":55,"value":35328}," authenticate(",{"type":49,"tag":1060,"props":35330,"children":35331},{"style":22635},[35332],{"type":55,"value":35333},"username",{"type":49,"tag":1060,"props":35335,"children":35336},{"style":2194},[35337],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35339,"children":35340},{"style":1073},[35341],{"type":55,"value":35342},"username, ",{"type":49,"tag":1060,"props":35344,"children":35345},{"style":22635},[35346],{"type":55,"value":2653},{"type":49,"tag":1060,"props":35348,"children":35349},{"style":2194},[35350],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35352,"children":35353},{"style":1073},[35354],{"type":55,"value":35355},"password)\n",{"type":49,"tag":1060,"props":35357,"children":35358},{"class":1062,"line":1150},[35359],{"type":49,"tag":1060,"props":35360,"children":35361},{"style":1073},[35362],{"type":55,"value":35363},"        login(request, user)\n",{"type":49,"tag":1060,"props":35365,"children":35366},{"class":1062,"line":1158},[35367,35372],{"type":49,"tag":1060,"props":35368,"children":35369},{"style":9965},[35370],{"type":55,"value":35371},"        print",{"type":49,"tag":1060,"props":35373,"children":35374},{"style":1073},[35375],{"type":55,"value":35376},"(next_redirect)\n",{"type":49,"tag":1060,"props":35378,"children":35379},{"class":1062,"line":1171},[35380,35384,35389,35394,35399],{"type":49,"tag":1060,"props":35381,"children":35382},{"style":2194},[35383],{"type":55,"value":29767},{"type":49,"tag":1060,"props":35385,"children":35386},{"style":1073},[35387],{"type":55,"value":35388}," next_redirect ",{"type":49,"tag":1060,"props":35390,"children":35391},{"style":2194},[35392],{"type":55,"value":35393},"!=",{"type":49,"tag":1060,"props":35395,"children":35396},{"style":2215},[35397],{"type":55,"value":35398}," 'None'",{"type":49,"tag":1060,"props":35400,"children":35401},{"style":1073},[35402],{"type":55,"value":6862},{"type":49,"tag":1060,"props":35404,"children":35405},{"class":1062,"line":1180},[35406,35411],{"type":49,"tag":1060,"props":35407,"children":35408},{"style":2194},[35409],{"type":55,"value":35410},"            return",{"type":49,"tag":1060,"props":35412,"children":35413},{"style":1073},[35414],{"type":55,"value":35415}," redirect(next_redirect)\n",{"type":49,"tag":1060,"props":35417,"children":35418},{"class":1062,"line":1188},[35419,35423,35428,35433],{"type":49,"tag":1060,"props":35420,"children":35421},{"style":2194},[35422],{"type":55,"value":22346},{"type":49,"tag":1060,"props":35424,"children":35425},{"style":1073},[35426],{"type":55,"value":35427}," redirect(",{"type":49,"tag":1060,"props":35429,"children":35430},{"style":2215},[35431],{"type":55,"value":35432},"'books:all'",{"type":49,"tag":1060,"props":35434,"children":35435},{"style":1073},[35436],{"type":55,"value":5126},{"type":49,"tag":1060,"props":35438,"children":35439},{"class":1062,"line":1201},[35440,35444,35448,35452,35457,35462,35466],{"type":49,"tag":1060,"props":35441,"children":35442},{"style":1073},[35443],{"type":55,"value":33500},{"type":49,"tag":1060,"props":35445,"children":35446},{"style":2194},[35447],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35449,"children":35450},{"style":1073},[35451],{"type":55,"value":3073},{"type":49,"tag":1060,"props":35453,"children":35454},{"style":2215},[35455],{"type":55,"value":35456},"'form'",{"type":49,"tag":1060,"props":35458,"children":35459},{"style":1073},[35460],{"type":55,"value":35461},":form, ",{"type":49,"tag":1060,"props":35463,"children":35464},{"style":2215},[35465],{"type":55,"value":35181},{"type":49,"tag":1060,"props":35467,"children":35468},{"style":1073},[35469],{"type":55,"value":35470},":next_redirect }\n",{"type":49,"tag":1060,"props":35472,"children":35473},{"class":1062,"line":1210},[35474,35478,35482,35487],{"type":49,"tag":1060,"props":35475,"children":35476},{"style":2194},[35477],{"type":55,"value":25371},{"type":49,"tag":1060,"props":35479,"children":35480},{"style":1073},[35481],{"type":55,"value":33598},{"type":49,"tag":1060,"props":35483,"children":35484},{"style":2215},[35485],{"type":55,"value":35486},"'accounts/login_form.html'",{"type":49,"tag":1060,"props":35488,"children":35489},{"style":1073},[35490],{"type":55,"value":33608},{"type":49,"tag":58,"props":35492,"children":35493},{},[35494,35496,35501],{"type":55,"value":35495},"Notice that I pass ",{"type":49,"tag":326,"props":35497,"children":35499},{"className":35498},[],[35500],{"type":55,"value":35113},{"type":55,"value":35502}," as a context variable. I use this in the login form here:",{"type":49,"tag":58,"props":35504,"children":35505},{},[35506],{"type":55,"value":32781},{"type":49,"tag":1050,"props":35508,"children":35510},{"code":35509,"language":33977,"meta":8,"className":33978,"style":8},"\u003Cform method=\"POST\" action=\".\">\n  {% csrf_token %} {{ form | crispy }}\n  \u003Cinput type=\"hidden\" value=\"{{ next }}\" name=\"next\" />\n  \u003Cdiv class=\"login-center\">\n    \u003Cinput class=\"btn btn-success login-center\" type=\"submit\" value=\"Login\" />\n  \u003C/div>\n  \u003Cbr />\n  or \u003Ca href=\"{% url 'accounts:register' %}\">create an account\u003C/a>\n\u003C/form>\n",[35511],{"type":49,"tag":326,"props":35512,"children":35513},{"__ignoreMap":8},[35514,35558,35566,35625,35655,35710,35726,35741,35780],{"type":49,"tag":1060,"props":35515,"children":35516},{"class":1062,"line":1063},[35517,35521,35526,35531,35535,35540,35545,35549,35554],{"type":49,"tag":1060,"props":35518,"children":35519},{"style":1073},[35520],{"type":55,"value":5197},{"type":49,"tag":1060,"props":35522,"children":35523},{"style":3839},[35524],{"type":55,"value":35525},"form",{"type":49,"tag":1060,"props":35527,"children":35528},{"style":1067},[35529],{"type":55,"value":35530}," method",{"type":49,"tag":1060,"props":35532,"children":35533},{"style":1073},[35534],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35536,"children":35537},{"style":2215},[35538],{"type":55,"value":35539},"\"POST\"",{"type":49,"tag":1060,"props":35541,"children":35542},{"style":1067},[35543],{"type":55,"value":35544}," action",{"type":49,"tag":1060,"props":35546,"children":35547},{"style":1073},[35548],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35550,"children":35551},{"style":2215},[35552],{"type":55,"value":35553},"\".\"",{"type":49,"tag":1060,"props":35555,"children":35556},{"style":1073},[35557],{"type":55,"value":33998},{"type":49,"tag":1060,"props":35559,"children":35560},{"class":1062,"line":1079},[35561],{"type":49,"tag":1060,"props":35562,"children":35563},{"style":1073},[35564],{"type":55,"value":35565},"  {% csrf_token %} {{ form | crispy }}\n",{"type":49,"tag":1060,"props":35567,"children":35568},{"class":1062,"line":1088},[35569,35574,35578,35583,35587,35592,35597,35601,35606,35611,35615,35620],{"type":49,"tag":1060,"props":35570,"children":35571},{"style":1073},[35572],{"type":55,"value":35573},"  \u003C",{"type":49,"tag":1060,"props":35575,"children":35576},{"style":3839},[35577],{"type":55,"value":7449},{"type":49,"tag":1060,"props":35579,"children":35580},{"style":1067},[35581],{"type":55,"value":35582}," type",{"type":49,"tag":1060,"props":35584,"children":35585},{"style":1073},[35586],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35588,"children":35589},{"style":2215},[35590],{"type":55,"value":35591},"\"hidden\"",{"type":49,"tag":1060,"props":35593,"children":35594},{"style":1067},[35595],{"type":55,"value":35596}," value",{"type":49,"tag":1060,"props":35598,"children":35599},{"style":1073},[35600],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35602,"children":35603},{"style":2215},[35604],{"type":55,"value":35605},"\"{{ next }}\"",{"type":49,"tag":1060,"props":35607,"children":35608},{"style":1067},[35609],{"type":55,"value":35610}," name",{"type":49,"tag":1060,"props":35612,"children":35613},{"style":1073},[35614],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35616,"children":35617},{"style":2215},[35618],{"type":55,"value":35619},"\"next\"",{"type":49,"tag":1060,"props":35621,"children":35622},{"style":1073},[35623],{"type":55,"value":35624}," />\n",{"type":49,"tag":1060,"props":35626,"children":35627},{"class":1062,"line":1097},[35628,35632,35637,35642,35646,35651],{"type":49,"tag":1060,"props":35629,"children":35630},{"style":1073},[35631],{"type":55,"value":35573},{"type":49,"tag":1060,"props":35633,"children":35634},{"style":3839},[35635],{"type":55,"value":35636},"div",{"type":49,"tag":1060,"props":35638,"children":35639},{"style":1067},[35640],{"type":55,"value":35641}," class",{"type":49,"tag":1060,"props":35643,"children":35644},{"style":1073},[35645],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35647,"children":35648},{"style":2215},[35649],{"type":55,"value":35650},"\"login-center\"",{"type":49,"tag":1060,"props":35652,"children":35653},{"style":1073},[35654],{"type":55,"value":33998},{"type":49,"tag":1060,"props":35656,"children":35657},{"class":1062,"line":1111},[35658,35663,35667,35671,35675,35680,35684,35688,35693,35697,35701,35706],{"type":49,"tag":1060,"props":35659,"children":35660},{"style":1073},[35661],{"type":55,"value":35662},"    \u003C",{"type":49,"tag":1060,"props":35664,"children":35665},{"style":3839},[35666],{"type":55,"value":7449},{"type":49,"tag":1060,"props":35668,"children":35669},{"style":1067},[35670],{"type":55,"value":35641},{"type":49,"tag":1060,"props":35672,"children":35673},{"style":1073},[35674],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35676,"children":35677},{"style":2215},[35678],{"type":55,"value":35679},"\"btn btn-success login-center\"",{"type":49,"tag":1060,"props":35681,"children":35682},{"style":1067},[35683],{"type":55,"value":35582},{"type":49,"tag":1060,"props":35685,"children":35686},{"style":1073},[35687],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35689,"children":35690},{"style":2215},[35691],{"type":55,"value":35692},"\"submit\"",{"type":49,"tag":1060,"props":35694,"children":35695},{"style":1067},[35696],{"type":55,"value":35596},{"type":49,"tag":1060,"props":35698,"children":35699},{"style":1073},[35700],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35702,"children":35703},{"style":2215},[35704],{"type":55,"value":35705},"\"Login\"",{"type":49,"tag":1060,"props":35707,"children":35708},{"style":1073},[35709],{"type":55,"value":35624},{"type":49,"tag":1060,"props":35711,"children":35712},{"class":1062,"line":1120},[35713,35718,35722],{"type":49,"tag":1060,"props":35714,"children":35715},{"style":1073},[35716],{"type":55,"value":35717},"  \u003C/",{"type":49,"tag":1060,"props":35719,"children":35720},{"style":3839},[35721],{"type":55,"value":35636},{"type":49,"tag":1060,"props":35723,"children":35724},{"style":1073},[35725],{"type":55,"value":33998},{"type":49,"tag":1060,"props":35727,"children":35728},{"class":1062,"line":1128},[35729,35733,35737],{"type":49,"tag":1060,"props":35730,"children":35731},{"style":1073},[35732],{"type":55,"value":35573},{"type":49,"tag":1060,"props":35734,"children":35735},{"style":3839},[35736],{"type":55,"value":14172},{"type":49,"tag":1060,"props":35738,"children":35739},{"style":1073},[35740],{"type":55,"value":35624},{"type":49,"tag":1060,"props":35742,"children":35743},{"class":1062,"line":1141},[35744,35749,35753,35758,35762,35767,35772,35776],{"type":49,"tag":1060,"props":35745,"children":35746},{"style":1073},[35747],{"type":55,"value":35748},"  or \u003C",{"type":49,"tag":1060,"props":35750,"children":35751},{"style":3839},[35752],{"type":55,"value":80},{"type":49,"tag":1060,"props":35754,"children":35755},{"style":1067},[35756],{"type":55,"value":35757}," href",{"type":49,"tag":1060,"props":35759,"children":35760},{"style":1073},[35761],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35763,"children":35764},{"style":2215},[35765],{"type":55,"value":35766},"\"{% url 'accounts:register' %}\"",{"type":49,"tag":1060,"props":35768,"children":35769},{"style":1073},[35770],{"type":55,"value":35771},">create an account\u003C/",{"type":49,"tag":1060,"props":35773,"children":35774},{"style":3839},[35775],{"type":55,"value":80},{"type":49,"tag":1060,"props":35777,"children":35778},{"style":1073},[35779],{"type":55,"value":33998},{"type":49,"tag":1060,"props":35781,"children":35782},{"class":1062,"line":1150},[35783,35787,35791],{"type":49,"tag":1060,"props":35784,"children":35785},{"style":1073},[35786],{"type":55,"value":35084},{"type":49,"tag":1060,"props":35788,"children":35789},{"style":3839},[35790],{"type":55,"value":35525},{"type":49,"tag":1060,"props":35792,"children":35793},{"style":1073},[35794],{"type":55,"value":33998},{"type":49,"tag":58,"props":35796,"children":35797},{},[35798],{"type":55,"value":32931},{"type":49,"tag":58,"props":35800,"children":35801},{},[35802,35804,35809,35811,35816,35818,35823],{"type":55,"value":35803},"By passing this as a hidden value to the form, when a ",{"type":49,"tag":326,"props":35805,"children":35807},{"className":35806},[],[35808],{"type":55,"value":31207},{"type":55,"value":35810}," request is made, we are redirected to the value of ",{"type":49,"tag":326,"props":35812,"children":35814},{"className":35813},[],[35815],{"type":55,"value":35113},{"type":55,"value":35817}," if it is not ",{"type":49,"tag":326,"props":35819,"children":35821},{"className":35820},[],[35822],{"type":55,"value":25272},{"type":55,"value":35824},", or if there is no redirect.",{"type":49,"tag":58,"props":35826,"children":35827},{},[35828,35830,35836,35838,35844],{"type":55,"value":35829},"When a ",{"type":49,"tag":326,"props":35831,"children":35833},{"className":35832},[],[35834],{"type":55,"value":35835},"@login_required",{"type":55,"value":35837}," decorator is used, and we want to access a url such as ",{"type":49,"tag":326,"props":35839,"children":35841},{"className":35840},[],[35842],{"type":55,"value":35843},"/books/add",{"type":55,"value":35845},", we are redirected to a url that looks like this:",{"type":49,"tag":1050,"props":35847,"children":35849},{"code":35848,"language":33977,"meta":8,"className":33978,"style":8},"http://localhost:8000/accounts/login/?next=/books/new/\n",[35850],{"type":49,"tag":326,"props":35851,"children":35852},{"__ignoreMap":8},[35853],{"type":49,"tag":1060,"props":35854,"children":35855},{"class":1062,"line":1063},[35856],{"type":49,"tag":1060,"props":35857,"children":35858},{"style":1073},[35859],{"type":55,"value":35848},{"type":49,"tag":58,"props":35861,"children":35862},{},[35863,35865,35870,35872,35877],{"type":55,"value":35864},"In this way we can pass the next parameter from the ",{"type":49,"tag":326,"props":35866,"children":35868},{"className":35867},[],[35869],{"type":55,"value":17032},{"type":55,"value":35871}," request to the ",{"type":49,"tag":326,"props":35873,"children":35875},{"className":35874},[],[35876],{"type":55,"value":31207},{"type":55,"value":35878}," request that is made when the login view is hit.",{"type":49,"tag":50,"props":35880,"children":35882},{"id":35881},"authors",[35883],{"type":55,"value":35884},"Authors",{"type":49,"tag":58,"props":35886,"children":35887},{},[35888,35890,35896],{"type":55,"value":35889},"For illustration purposes, I included an ",{"type":49,"tag":326,"props":35891,"children":35893},{"className":35892},[],[35894],{"type":55,"value":35895},"Author",{"type":55,"value":35897}," model. Since a book can have zero, one or many Authors, I used a many-to-many relationship to link authors to books. Here is how we do this in our Book model:",{"type":49,"tag":1050,"props":35899,"children":35901},{"code":35900,"language":28337,"meta":8,"className":28338,"style":8},"class Book(models.Model):\n    [...other fields...]\n    authors = models.ManyToManyField('authors.Author')\n",[35902],{"type":49,"tag":326,"props":35903,"children":35904},{"__ignoreMap":8},[35905,35936,35960],{"type":49,"tag":1060,"props":35906,"children":35907},{"class":1062,"line":1063},[35908,35912,35916,35920,35924,35928,35932],{"type":49,"tag":1060,"props":35909,"children":35910},{"style":2182},[35911],{"type":55,"value":31987},{"type":49,"tag":1060,"props":35913,"children":35914},{"style":3992},[35915],{"type":55,"value":32978},{"type":49,"tag":1060,"props":35917,"children":35918},{"style":1073},[35919],{"type":55,"value":2284},{"type":49,"tag":1060,"props":35921,"children":35922},{"style":31999},[35923],{"type":55,"value":32987},{"type":49,"tag":1060,"props":35925,"children":35926},{"style":1073},[35927],{"type":55,"value":745},{"type":49,"tag":1060,"props":35929,"children":35930},{"style":31999},[35931],{"type":55,"value":32996},{"type":49,"tag":1060,"props":35933,"children":35934},{"style":1073},[35935],{"type":55,"value":22242},{"type":49,"tag":1060,"props":35937,"children":35938},{"class":1062,"line":1079},[35939,35943,35947,35952,35956],{"type":49,"tag":1060,"props":35940,"children":35941},{"style":1073},[35942],{"type":55,"value":33144},{"type":49,"tag":1060,"props":35944,"children":35945},{"style":2287},[35946],{"type":55,"value":3078},{"type":49,"tag":1060,"props":35948,"children":35949},{"style":1073},[35950],{"type":55,"value":35951},"other fields",{"type":49,"tag":1060,"props":35953,"children":35954},{"style":2287},[35955],{"type":55,"value":3078},{"type":49,"tag":1060,"props":35957,"children":35958},{"style":1073},[35959],{"type":55,"value":33153},{"type":49,"tag":1060,"props":35961,"children":35962},{"class":1062,"line":1088},[35963,35968,35972,35977,35982],{"type":49,"tag":1060,"props":35964,"children":35965},{"style":1073},[35966],{"type":55,"value":35967},"    authors ",{"type":49,"tag":1060,"props":35969,"children":35970},{"style":2194},[35971],{"type":55,"value":3068},{"type":49,"tag":1060,"props":35973,"children":35974},{"style":1073},[35975],{"type":55,"value":35976}," models.ManyToManyField(",{"type":49,"tag":1060,"props":35978,"children":35979},{"style":2215},[35980],{"type":55,"value":35981},"'authors.Author'",{"type":49,"tag":1060,"props":35983,"children":35984},{"style":1073},[35985],{"type":55,"value":5126},{"type":49,"tag":58,"props":35987,"children":35988},{},[35989,35991,35996,35998,36003],{"type":55,"value":35990},"This dot notation with ",{"type":49,"tag":326,"props":35992,"children":35994},{"className":35993},[],[35995],{"type":55,"value":35981},{"type":55,"value":35997}," is important. Previously I would have just imported the ",{"type":49,"tag":326,"props":35999,"children":36001},{"className":36000},[],[36002],{"type":55,"value":35895},{"type":55,"value":36004},"model and then referenced that in the ManyToManyField. However, this can lead to circular import errors which are hard to debug unless you know what a circular import is.",{"type":49,"tag":58,"props":36006,"children":36007},{},[36008,36010,36016,36018,36023],{"type":55,"value":36009},"Now let's look at how to find all ",{"type":49,"tag":326,"props":36011,"children":36013},{"className":36012},[],[36014],{"type":55,"value":36015},"Books",{"type":55,"value":36017}," by a certain author, as well as all ",{"type":49,"tag":326,"props":36019,"children":36021},{"className":36020},[],[36022],{"type":55,"value":35884},{"type":55,"value":36024}," of a given book. Uing the Django shell, we can do the following:",{"type":49,"tag":1050,"props":36026,"children":36028},{"code":36027,"language":28337,"meta":8,"className":28338,"style":8},"from authors.models import Author\nfrom books.models import Book\na = Author.objects.all().first()\na.book_set.values()\n\u003CQuerySet [{'id': 583, 'title': 'None Or Other', 'lat': Decimal('-118.035345'), 'lon': Decimal('34.139729'), 'pages': 1881, 'publish_date': datetime.date(2018, 3, 18), 'website': 'https://www.fleming-mitchell.com/', 'synopsis': 'Option ever large throw dinner worker ahead realize clearly congress as smile size spend expert chair well. Brother item win follow hope coach garden later arrive who if ago voice analysis simply reflect. Amount under data drug kind book fish still information president minute stage dog. Focus full green society parent door according my management sell arrive only send international tonight. Player character financial detail oil check bring pressure possible former. Learn politics compare position large loss exactly probably approach physical international machine as model. ', 'slug': 'none-or-other', 'status': True}, {'id': 601, 'title': 'Teacher Them Step', 'lat': Decimal('-80.268357'), 'lon': Decimal('26.661763'), 'pages': 206, 'publish_date': datetime.date(2018, 2, 27), 'website': 'http://www.rodriguez.net/', 'synopsis': 'Drug fact behavior environment green try account where training brother building particular window even reach. Pressure lawyer dog world thought near institution we get force market can guy receive matter structure research foot of small. Professor production very this practice car wind wish relationship after follow professor news card concern media property have. According majority owner go mention reach store computer project kitchen group quality present several another time school and will. Before during central artist page only health region happen share traditional section well out human. Mention quite short race only education heavy book up recent official here spring oil buy which language information practice. Time mother better peace girl defense rock mr never feeling tax city stock bar tv others right conference skin. ', 'slug': 'teacher-them-step', 'status': True}]>\n",[36029],{"type":49,"tag":326,"props":36030,"children":36031},{"__ignoreMap":8},[36032,36053,36074,36091,36099],{"type":49,"tag":1060,"props":36033,"children":36034},{"class":1062,"line":1063},[36035,36039,36044,36048],{"type":49,"tag":1060,"props":36036,"children":36037},{"style":2194},[36038],{"type":55,"value":22184},{"type":49,"tag":1060,"props":36040,"children":36041},{"style":1073},[36042],{"type":55,"value":36043}," authors.models ",{"type":49,"tag":1060,"props":36045,"children":36046},{"style":2194},[36047],{"type":55,"value":22194},{"type":49,"tag":1060,"props":36049,"children":36050},{"style":1073},[36051],{"type":55,"value":36052}," Author\n",{"type":49,"tag":1060,"props":36054,"children":36055},{"class":1062,"line":1079},[36056,36060,36065,36069],{"type":49,"tag":1060,"props":36057,"children":36058},{"style":2194},[36059],{"type":55,"value":22184},{"type":49,"tag":1060,"props":36061,"children":36062},{"style":1073},[36063],{"type":55,"value":36064}," books.models ",{"type":49,"tag":1060,"props":36066,"children":36067},{"style":2194},[36068],{"type":55,"value":22194},{"type":49,"tag":1060,"props":36070,"children":36071},{"style":1073},[36072],{"type":55,"value":36073}," Book\n",{"type":49,"tag":1060,"props":36075,"children":36076},{"class":1062,"line":1088},[36077,36082,36086],{"type":49,"tag":1060,"props":36078,"children":36079},{"style":1073},[36080],{"type":55,"value":36081},"a ",{"type":49,"tag":1060,"props":36083,"children":36084},{"style":2194},[36085],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36087,"children":36088},{"style":1073},[36089],{"type":55,"value":36090}," Author.objects.all().first()\n",{"type":49,"tag":1060,"props":36092,"children":36093},{"class":1062,"line":1097},[36094],{"type":49,"tag":1060,"props":36095,"children":36096},{"style":1073},[36097],{"type":55,"value":36098},"a.book_set.values()\n",{"type":49,"tag":1060,"props":36100,"children":36101},{"class":1062,"line":1111},[36102,36106,36111,36116,36120,36125,36129,36134,36138,36143,36147,36152,36157,36162,36166,36171,36175,36180,36184,36188,36192,36197,36201,36206,36211,36216,36220,36224,36228,36232,36236,36241,36245,36250,36254,36259,36263,36268,36272,36277,36281,36286,36290,36295,36299,36304,36309,36313,36317,36322,36326,36330,36334,36339,36343,36347,36351,36356,36360,36364,36368,36373,36377,36381,36385,36390,36394,36398,36402,36406,36410,36414,36418,36422,36426,36430,36434,36439,36443,36447,36451,36456,36460,36464,36468,36473,36477,36481,36485,36489,36494],{"type":49,"tag":1060,"props":36103,"children":36104},{"style":2194},[36105],{"type":55,"value":5197},{"type":49,"tag":1060,"props":36107,"children":36108},{"style":1073},[36109],{"type":55,"value":36110},"QuerySet [{",{"type":49,"tag":1060,"props":36112,"children":36113},{"style":2215},[36114],{"type":55,"value":36115},"'id'",{"type":49,"tag":1060,"props":36117,"children":36118},{"style":1073},[36119],{"type":55,"value":78},{"type":49,"tag":1060,"props":36121,"children":36122},{"style":2287},[36123],{"type":55,"value":36124},"583",{"type":49,"tag":1060,"props":36126,"children":36127},{"style":1073},[36128],{"type":55,"value":873},{"type":49,"tag":1060,"props":36130,"children":36131},{"style":2215},[36132],{"type":55,"value":36133},"'title'",{"type":49,"tag":1060,"props":36135,"children":36136},{"style":1073},[36137],{"type":55,"value":78},{"type":49,"tag":1060,"props":36139,"children":36140},{"style":2215},[36141],{"type":55,"value":36142},"'None Or Other'",{"type":49,"tag":1060,"props":36144,"children":36145},{"style":1073},[36146],{"type":55,"value":873},{"type":49,"tag":1060,"props":36148,"children":36149},{"style":2215},[36150],{"type":55,"value":36151},"'lat'",{"type":49,"tag":1060,"props":36153,"children":36154},{"style":1073},[36155],{"type":55,"value":36156},": Decimal(",{"type":49,"tag":1060,"props":36158,"children":36159},{"style":2215},[36160],{"type":55,"value":36161},"'-118.035345'",{"type":49,"tag":1060,"props":36163,"children":36164},{"style":1073},[36165],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36167,"children":36168},{"style":2215},[36169],{"type":55,"value":36170},"'lon'",{"type":49,"tag":1060,"props":36172,"children":36173},{"style":1073},[36174],{"type":55,"value":36156},{"type":49,"tag":1060,"props":36176,"children":36177},{"style":2215},[36178],{"type":55,"value":36179},"'34.139729'",{"type":49,"tag":1060,"props":36181,"children":36182},{"style":1073},[36183],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36185,"children":36186},{"style":2215},[36187],{"type":55,"value":33374},{"type":49,"tag":1060,"props":36189,"children":36190},{"style":1073},[36191],{"type":55,"value":78},{"type":49,"tag":1060,"props":36193,"children":36194},{"style":2287},[36195],{"type":55,"value":36196},"1881",{"type":49,"tag":1060,"props":36198,"children":36199},{"style":1073},[36200],{"type":55,"value":873},{"type":49,"tag":1060,"props":36202,"children":36203},{"style":2215},[36204],{"type":55,"value":36205},"'publish_date'",{"type":49,"tag":1060,"props":36207,"children":36208},{"style":1073},[36209],{"type":55,"value":36210},": datetime.date(",{"type":49,"tag":1060,"props":36212,"children":36213},{"style":2287},[36214],{"type":55,"value":36215},"2018",{"type":49,"tag":1060,"props":36217,"children":36218},{"style":1073},[36219],{"type":55,"value":873},{"type":49,"tag":1060,"props":36221,"children":36222},{"style":2287},[36223],{"type":55,"value":27697},{"type":49,"tag":1060,"props":36225,"children":36226},{"style":1073},[36227],{"type":55,"value":873},{"type":49,"tag":1060,"props":36229,"children":36230},{"style":2287},[36231],{"type":55,"value":32864},{"type":49,"tag":1060,"props":36233,"children":36234},{"style":1073},[36235],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36237,"children":36238},{"style":2215},[36239],{"type":55,"value":36240},"'website'",{"type":49,"tag":1060,"props":36242,"children":36243},{"style":1073},[36244],{"type":55,"value":78},{"type":49,"tag":1060,"props":36246,"children":36247},{"style":2215},[36248],{"type":55,"value":36249},"'https://www.fleming-mitchell.com/'",{"type":49,"tag":1060,"props":36251,"children":36252},{"style":1073},[36253],{"type":55,"value":873},{"type":49,"tag":1060,"props":36255,"children":36256},{"style":2215},[36257],{"type":55,"value":36258},"'synopsis'",{"type":49,"tag":1060,"props":36260,"children":36261},{"style":1073},[36262],{"type":55,"value":78},{"type":49,"tag":1060,"props":36264,"children":36265},{"style":2215},[36266],{"type":55,"value":36267},"'Option ever large throw dinner worker ahead realize clearly congress as smile size spend expert chair well. Brother item win follow hope coach garden later arrive who if ago voice analysis simply reflect. Amount under data drug kind book fish still information president minute stage dog. Focus full green society parent door according my management sell arrive only send international tonight. Player character financial detail oil check bring pressure possible former. Learn politics compare position large loss exactly probably approach physical international machine as model. '",{"type":49,"tag":1060,"props":36269,"children":36270},{"style":1073},[36271],{"type":55,"value":873},{"type":49,"tag":1060,"props":36273,"children":36274},{"style":2215},[36275],{"type":55,"value":36276},"'slug'",{"type":49,"tag":1060,"props":36278,"children":36279},{"style":1073},[36280],{"type":55,"value":78},{"type":49,"tag":1060,"props":36282,"children":36283},{"style":2215},[36284],{"type":55,"value":36285},"'none-or-other'",{"type":49,"tag":1060,"props":36287,"children":36288},{"style":1073},[36289],{"type":55,"value":873},{"type":49,"tag":1060,"props":36291,"children":36292},{"style":2215},[36293],{"type":55,"value":36294},"'status'",{"type":49,"tag":1060,"props":36296,"children":36297},{"style":1073},[36298],{"type":55,"value":78},{"type":49,"tag":1060,"props":36300,"children":36301},{"style":2287},[36302],{"type":55,"value":36303},"True",{"type":49,"tag":1060,"props":36305,"children":36306},{"style":1073},[36307],{"type":55,"value":36308},"}, {",{"type":49,"tag":1060,"props":36310,"children":36311},{"style":2215},[36312],{"type":55,"value":36115},{"type":49,"tag":1060,"props":36314,"children":36315},{"style":1073},[36316],{"type":55,"value":78},{"type":49,"tag":1060,"props":36318,"children":36319},{"style":2287},[36320],{"type":55,"value":36321},"601",{"type":49,"tag":1060,"props":36323,"children":36324},{"style":1073},[36325],{"type":55,"value":873},{"type":49,"tag":1060,"props":36327,"children":36328},{"style":2215},[36329],{"type":55,"value":36133},{"type":49,"tag":1060,"props":36331,"children":36332},{"style":1073},[36333],{"type":55,"value":78},{"type":49,"tag":1060,"props":36335,"children":36336},{"style":2215},[36337],{"type":55,"value":36338},"'Teacher Them Step'",{"type":49,"tag":1060,"props":36340,"children":36341},{"style":1073},[36342],{"type":55,"value":873},{"type":49,"tag":1060,"props":36344,"children":36345},{"style":2215},[36346],{"type":55,"value":36151},{"type":49,"tag":1060,"props":36348,"children":36349},{"style":1073},[36350],{"type":55,"value":36156},{"type":49,"tag":1060,"props":36352,"children":36353},{"style":2215},[36354],{"type":55,"value":36355},"'-80.268357'",{"type":49,"tag":1060,"props":36357,"children":36358},{"style":1073},[36359],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36361,"children":36362},{"style":2215},[36363],{"type":55,"value":36170},{"type":49,"tag":1060,"props":36365,"children":36366},{"style":1073},[36367],{"type":55,"value":36156},{"type":49,"tag":1060,"props":36369,"children":36370},{"style":2215},[36371],{"type":55,"value":36372},"'26.661763'",{"type":49,"tag":1060,"props":36374,"children":36375},{"style":1073},[36376],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36378,"children":36379},{"style":2215},[36380],{"type":55,"value":33374},{"type":49,"tag":1060,"props":36382,"children":36383},{"style":1073},[36384],{"type":55,"value":78},{"type":49,"tag":1060,"props":36386,"children":36387},{"style":2287},[36388],{"type":55,"value":36389},"206",{"type":49,"tag":1060,"props":36391,"children":36392},{"style":1073},[36393],{"type":55,"value":873},{"type":49,"tag":1060,"props":36395,"children":36396},{"style":2215},[36397],{"type":55,"value":36205},{"type":49,"tag":1060,"props":36399,"children":36400},{"style":1073},[36401],{"type":55,"value":36210},{"type":49,"tag":1060,"props":36403,"children":36404},{"style":2287},[36405],{"type":55,"value":36215},{"type":49,"tag":1060,"props":36407,"children":36408},{"style":1073},[36409],{"type":55,"value":873},{"type":49,"tag":1060,"props":36411,"children":36412},{"style":2287},[36413],{"type":55,"value":24195},{"type":49,"tag":1060,"props":36415,"children":36416},{"style":1073},[36417],{"type":55,"value":873},{"type":49,"tag":1060,"props":36419,"children":36420},{"style":2287},[36421],{"type":55,"value":7817},{"type":49,"tag":1060,"props":36423,"children":36424},{"style":1073},[36425],{"type":55,"value":2295},{"type":49,"tag":1060,"props":36427,"children":36428},{"style":2215},[36429],{"type":55,"value":36240},{"type":49,"tag":1060,"props":36431,"children":36432},{"style":1073},[36433],{"type":55,"value":78},{"type":49,"tag":1060,"props":36435,"children":36436},{"style":2215},[36437],{"type":55,"value":36438},"'http://www.rodriguez.net/'",{"type":49,"tag":1060,"props":36440,"children":36441},{"style":1073},[36442],{"type":55,"value":873},{"type":49,"tag":1060,"props":36444,"children":36445},{"style":2215},[36446],{"type":55,"value":36258},{"type":49,"tag":1060,"props":36448,"children":36449},{"style":1073},[36450],{"type":55,"value":78},{"type":49,"tag":1060,"props":36452,"children":36453},{"style":2215},[36454],{"type":55,"value":36455},"'Drug fact behavior environment green try account where training brother building particular window even reach. Pressure lawyer dog world thought near institution we get force market can guy receive matter structure research foot of small. Professor production very this practice car wind wish relationship after follow professor news card concern media property have. According majority owner go mention reach store computer project kitchen group quality present several another time school and will. Before during central artist page only health region happen share traditional section well out human. Mention quite short race only education heavy book up recent official here spring oil buy which language information practice. Time mother better peace girl defense rock mr never feeling tax city stock bar tv others right conference skin. '",{"type":49,"tag":1060,"props":36457,"children":36458},{"style":1073},[36459],{"type":55,"value":873},{"type":49,"tag":1060,"props":36461,"children":36462},{"style":2215},[36463],{"type":55,"value":36276},{"type":49,"tag":1060,"props":36465,"children":36466},{"style":1073},[36467],{"type":55,"value":78},{"type":49,"tag":1060,"props":36469,"children":36470},{"style":2215},[36471],{"type":55,"value":36472},"'teacher-them-step'",{"type":49,"tag":1060,"props":36474,"children":36475},{"style":1073},[36476],{"type":55,"value":873},{"type":49,"tag":1060,"props":36478,"children":36479},{"style":2215},[36480],{"type":55,"value":36294},{"type":49,"tag":1060,"props":36482,"children":36483},{"style":1073},[36484],{"type":55,"value":78},{"type":49,"tag":1060,"props":36486,"children":36487},{"style":2287},[36488],{"type":55,"value":36303},{"type":49,"tag":1060,"props":36490,"children":36491},{"style":1073},[36492],{"type":55,"value":36493},"}]",{"type":49,"tag":1060,"props":36495,"children":36496},{"style":2194},[36497],{"type":55,"value":33998},{"type":49,"tag":58,"props":36499,"children":36500},{},[36501],{"type":55,"value":36502},"This gave us two books by an author.",{"type":49,"tag":58,"props":36504,"children":36505},{},[36506,36508,36514],{"type":55,"value":36507},"Now, let's look at how to find all authors of a given book. For this example, we can get authors directly in the template from a book object. This example come from the ",{"type":49,"tag":326,"props":36509,"children":36511},{"className":36510},[],[36512],{"type":55,"value":36513},"book_detail",{"type":55,"value":36515}," template:",{"type":49,"tag":58,"props":36517,"children":36518},{},[36519],{"type":55,"value":32781},{"type":49,"tag":1050,"props":36521,"children":36523},{"code":36522,"language":33977,"meta":8,"className":33978,"style":8},"\u003Ch3>\n  Authors: {% for author in book.authors.all %}\n  \u003Ca href=\"{% url 'authors:author_detail' id=author.id %}\"\n    >{{ author.full_name }}\u003C/a\n  >\n  {% endfor %}\n\u003C/h3>\n",[36524],{"type":49,"tag":326,"props":36525,"children":36526},{"__ignoreMap":8},[36527,36542,36550,36574,36587,36595,36603],{"type":49,"tag":1060,"props":36528,"children":36529},{"class":1062,"line":1063},[36530,36534,36538],{"type":49,"tag":1060,"props":36531,"children":36532},{"style":1073},[36533],{"type":55,"value":5197},{"type":49,"tag":1060,"props":36535,"children":36536},{"style":3839},[36537],{"type":55,"value":430},{"type":49,"tag":1060,"props":36539,"children":36540},{"style":1073},[36541],{"type":55,"value":33998},{"type":49,"tag":1060,"props":36543,"children":36544},{"class":1062,"line":1079},[36545],{"type":49,"tag":1060,"props":36546,"children":36547},{"style":1073},[36548],{"type":55,"value":36549},"  Authors: {% for author in book.authors.all %}\n",{"type":49,"tag":1060,"props":36551,"children":36552},{"class":1062,"line":1088},[36553,36557,36561,36565,36569],{"type":49,"tag":1060,"props":36554,"children":36555},{"style":1073},[36556],{"type":55,"value":35573},{"type":49,"tag":1060,"props":36558,"children":36559},{"style":3839},[36560],{"type":55,"value":80},{"type":49,"tag":1060,"props":36562,"children":36563},{"style":1067},[36564],{"type":55,"value":35757},{"type":49,"tag":1060,"props":36566,"children":36567},{"style":1073},[36568],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36570,"children":36571},{"style":2215},[36572],{"type":55,"value":36573},"\"{% url 'authors:author_detail' id=author.id %}\"\n",{"type":49,"tag":1060,"props":36575,"children":36576},{"class":1062,"line":1097},[36577,36582],{"type":49,"tag":1060,"props":36578,"children":36579},{"style":1073},[36580],{"type":55,"value":36581},"    >{{ author.full_name }}\u003C/",{"type":49,"tag":1060,"props":36583,"children":36584},{"style":3839},[36585],{"type":55,"value":36586},"a\n",{"type":49,"tag":1060,"props":36588,"children":36589},{"class":1062,"line":1111},[36590],{"type":49,"tag":1060,"props":36591,"children":36592},{"style":1073},[36593],{"type":55,"value":36594},"  >\n",{"type":49,"tag":1060,"props":36596,"children":36597},{"class":1062,"line":1120},[36598],{"type":49,"tag":1060,"props":36599,"children":36600},{"style":1073},[36601],{"type":55,"value":36602},"  {% endfor %}\n",{"type":49,"tag":1060,"props":36604,"children":36605},{"class":1062,"line":1128},[36606,36610,36614],{"type":49,"tag":1060,"props":36607,"children":36608},{"style":1073},[36609],{"type":55,"value":35084},{"type":49,"tag":1060,"props":36611,"children":36612},{"style":3839},[36613],{"type":55,"value":430},{"type":49,"tag":1060,"props":36615,"children":36616},{"style":1073},[36617],{"type":55,"value":33998},{"type":49,"tag":58,"props":36619,"children":36620},{},[36621],{"type":55,"value":32931},{"type":49,"tag":58,"props":36623,"children":36624},{},[36625,36627,36633],{"type":55,"value":36626},"We could just as well access ",{"type":49,"tag":326,"props":36628,"children":36630},{"className":36629},[],[36631],{"type":55,"value":36632},"books.authors.all",{"type":55,"value":36634}," in the view and pass authors in a variable that we can iterate over in the template, but this keeps things simpler without much more code to write.",{"type":49,"tag":50,"props":36636,"children":36638},{"id":36637},"filtering-data",[36639],{"type":55,"value":36640},"Filtering Data",{"type":49,"tag":58,"props":36642,"children":36643},{},[36644,36646,36651,36653,36659,36661,36667,36669,36674],{"type":55,"value":36645},"One other question I wanted to answer with this project is how to do relatively complex data filtering. To do this, I used Django forms to create a form that calls a ",{"type":49,"tag":326,"props":36647,"children":36649},{"className":36648},[],[36650],{"type":55,"value":17032},{"type":55,"value":36652}," request to the same view it came from, which is to say, a filter form on the template for the ",{"type":49,"tag":326,"props":36654,"children":36656},{"className":36655},[],[36657],{"type":55,"value":36658},"all",{"type":55,"value":36660}," books view has a form action with an ",{"type":49,"tag":326,"props":36662,"children":36664},{"className":36663},[],[36665],{"type":55,"value":36666},"action",{"type":55,"value":36668}," value of the url that returns the ",{"type":49,"tag":326,"props":36670,"children":36672},{"className":36671},[],[36673],{"type":55,"value":36658},{"type":55,"value":36675}," view.",{"type":49,"tag":58,"props":36677,"children":36678},{},[36679],{"type":55,"value":36680},"Here's a look at the form I put together for filtering data:",{"type":49,"tag":1050,"props":36682,"children":36684},{"code":36683,"language":28337,"meta":8,"className":28338,"style":8},"class QueryForm(forms.Form):\n\n    publish_date_before = forms.DateField(\n        label='',\n        required=False,\n        # initial = datetime.datetime.now(),\n        widget = forms.TextInput(\n            attrs={\n                'class': 'form-control',\n                'id':'datepicker1',\n                'placeholder':'published before'\n            }))\n\n    publish_date_after = forms.DateField(\n        label='',\n        required=False,\n        # initial = datetime.datetime.now(),\n        widget = forms.TextInput(\n            attrs={\n                'class': 'form-control',\n                'id':'datepicker2',\n                'placeholder':'published after'\n            }))\n\n    keywords = forms.CharField(\n        required=False,\n        label='',\n        widget=forms.TextInput(\n\n            attrs={\n                'class':'form-control',\n                'placeholder':'space-separated words matching title, synopsis, website or tags'\n            }))\n",[36685],{"type":49,"tag":326,"props":36686,"children":36687},{"__ignoreMap":8},[36688,36722,36729,36746,36766,36787,36795,36812,36829,36850,36871,36888,36896,36903,36919,36938,36957,36964,36979,36994,37013,37033,37049,37056,37063,37080,37099,37118,37134,37141,37156,37175,37191],{"type":49,"tag":1060,"props":36689,"children":36690},{"class":1062,"line":1063},[36691,36695,36700,36704,36709,36713,36718],{"type":49,"tag":1060,"props":36692,"children":36693},{"style":2182},[36694],{"type":55,"value":31987},{"type":49,"tag":1060,"props":36696,"children":36697},{"style":3992},[36698],{"type":55,"value":36699}," QueryForm",{"type":49,"tag":1060,"props":36701,"children":36702},{"style":1073},[36703],{"type":55,"value":2284},{"type":49,"tag":1060,"props":36705,"children":36706},{"style":31999},[36707],{"type":55,"value":36708},"forms",{"type":49,"tag":1060,"props":36710,"children":36711},{"style":1073},[36712],{"type":55,"value":745},{"type":49,"tag":1060,"props":36714,"children":36715},{"style":31999},[36716],{"type":55,"value":36717},"Form",{"type":49,"tag":1060,"props":36719,"children":36720},{"style":1073},[36721],{"type":55,"value":22242},{"type":49,"tag":1060,"props":36723,"children":36724},{"class":1062,"line":1079},[36725],{"type":49,"tag":1060,"props":36726,"children":36727},{"emptyLinePlaceholder":44},[36728],{"type":55,"value":1094},{"type":49,"tag":1060,"props":36730,"children":36731},{"class":1062,"line":1088},[36732,36737,36741],{"type":49,"tag":1060,"props":36733,"children":36734},{"style":1073},[36735],{"type":55,"value":36736},"    publish_date_before ",{"type":49,"tag":1060,"props":36738,"children":36739},{"style":2194},[36740],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36742,"children":36743},{"style":1073},[36744],{"type":55,"value":36745}," forms.DateField(\n",{"type":49,"tag":1060,"props":36747,"children":36748},{"class":1062,"line":1097},[36749,36754,36758,36762],{"type":49,"tag":1060,"props":36750,"children":36751},{"style":22635},[36752],{"type":55,"value":36753},"        label",{"type":49,"tag":1060,"props":36755,"children":36756},{"style":2194},[36757],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36759,"children":36760},{"style":2215},[36761],{"type":55,"value":17271},{"type":49,"tag":1060,"props":36763,"children":36764},{"style":1073},[36765],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36767,"children":36768},{"class":1062,"line":1111},[36769,36774,36778,36783],{"type":49,"tag":1060,"props":36770,"children":36771},{"style":22635},[36772],{"type":55,"value":36773},"        required",{"type":49,"tag":1060,"props":36775,"children":36776},{"style":2194},[36777],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36779,"children":36780},{"style":2287},[36781],{"type":55,"value":36782},"False",{"type":49,"tag":1060,"props":36784,"children":36785},{"style":1073},[36786],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36788,"children":36789},{"class":1062,"line":1120},[36790],{"type":49,"tag":1060,"props":36791,"children":36792},{"style":3039},[36793],{"type":55,"value":36794},"        # initial = datetime.datetime.now(),\n",{"type":49,"tag":1060,"props":36796,"children":36797},{"class":1062,"line":1128},[36798,36803,36807],{"type":49,"tag":1060,"props":36799,"children":36800},{"style":22635},[36801],{"type":55,"value":36802},"        widget",{"type":49,"tag":1060,"props":36804,"children":36805},{"style":2194},[36806],{"type":55,"value":2197},{"type":49,"tag":1060,"props":36808,"children":36809},{"style":1073},[36810],{"type":55,"value":36811}," forms.TextInput(\n",{"type":49,"tag":1060,"props":36813,"children":36814},{"class":1062,"line":1141},[36815,36820,36824],{"type":49,"tag":1060,"props":36816,"children":36817},{"style":22635},[36818],{"type":55,"value":36819},"            attrs",{"type":49,"tag":1060,"props":36821,"children":36822},{"style":2194},[36823],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36825,"children":36826},{"style":1073},[36827],{"type":55,"value":36828},"{\n",{"type":49,"tag":1060,"props":36830,"children":36831},{"class":1062,"line":1150},[36832,36837,36841,36846],{"type":49,"tag":1060,"props":36833,"children":36834},{"style":2215},[36835],{"type":55,"value":36836},"                'class'",{"type":49,"tag":1060,"props":36838,"children":36839},{"style":1073},[36840],{"type":55,"value":78},{"type":49,"tag":1060,"props":36842,"children":36843},{"style":2215},[36844],{"type":55,"value":36845},"'form-control'",{"type":49,"tag":1060,"props":36847,"children":36848},{"style":1073},[36849],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36851,"children":36852},{"class":1062,"line":1158},[36853,36858,36862,36867],{"type":49,"tag":1060,"props":36854,"children":36855},{"style":2215},[36856],{"type":55,"value":36857},"                'id'",{"type":49,"tag":1060,"props":36859,"children":36860},{"style":1073},[36861],{"type":55,"value":6694},{"type":49,"tag":1060,"props":36863,"children":36864},{"style":2215},[36865],{"type":55,"value":36866},"'datepicker1'",{"type":49,"tag":1060,"props":36868,"children":36869},{"style":1073},[36870],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36872,"children":36873},{"class":1062,"line":1171},[36874,36879,36883],{"type":49,"tag":1060,"props":36875,"children":36876},{"style":2215},[36877],{"type":55,"value":36878},"                'placeholder'",{"type":49,"tag":1060,"props":36880,"children":36881},{"style":1073},[36882],{"type":55,"value":6694},{"type":49,"tag":1060,"props":36884,"children":36885},{"style":2215},[36886],{"type":55,"value":36887},"'published before'\n",{"type":49,"tag":1060,"props":36889,"children":36890},{"class":1062,"line":1180},[36891],{"type":49,"tag":1060,"props":36892,"children":36893},{"style":1073},[36894],{"type":55,"value":36895},"            }))\n",{"type":49,"tag":1060,"props":36897,"children":36898},{"class":1062,"line":1188},[36899],{"type":49,"tag":1060,"props":36900,"children":36901},{"emptyLinePlaceholder":44},[36902],{"type":55,"value":1094},{"type":49,"tag":1060,"props":36904,"children":36905},{"class":1062,"line":1201},[36906,36911,36915],{"type":49,"tag":1060,"props":36907,"children":36908},{"style":1073},[36909],{"type":55,"value":36910},"    publish_date_after ",{"type":49,"tag":1060,"props":36912,"children":36913},{"style":2194},[36914],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36916,"children":36917},{"style":1073},[36918],{"type":55,"value":36745},{"type":49,"tag":1060,"props":36920,"children":36921},{"class":1062,"line":1210},[36922,36926,36930,36934],{"type":49,"tag":1060,"props":36923,"children":36924},{"style":22635},[36925],{"type":55,"value":36753},{"type":49,"tag":1060,"props":36927,"children":36928},{"style":2194},[36929],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36931,"children":36932},{"style":2215},[36933],{"type":55,"value":17271},{"type":49,"tag":1060,"props":36935,"children":36936},{"style":1073},[36937],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36939,"children":36940},{"class":1062,"line":1218},[36941,36945,36949,36953],{"type":49,"tag":1060,"props":36942,"children":36943},{"style":22635},[36944],{"type":55,"value":36773},{"type":49,"tag":1060,"props":36946,"children":36947},{"style":2194},[36948],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36950,"children":36951},{"style":2287},[36952],{"type":55,"value":36782},{"type":49,"tag":1060,"props":36954,"children":36955},{"style":1073},[36956],{"type":55,"value":2497},{"type":49,"tag":1060,"props":36958,"children":36959},{"class":1062,"line":1232},[36960],{"type":49,"tag":1060,"props":36961,"children":36962},{"style":3039},[36963],{"type":55,"value":36794},{"type":49,"tag":1060,"props":36965,"children":36966},{"class":1062,"line":1241},[36967,36971,36975],{"type":49,"tag":1060,"props":36968,"children":36969},{"style":22635},[36970],{"type":55,"value":36802},{"type":49,"tag":1060,"props":36972,"children":36973},{"style":2194},[36974],{"type":55,"value":2197},{"type":49,"tag":1060,"props":36976,"children":36977},{"style":1073},[36978],{"type":55,"value":36811},{"type":49,"tag":1060,"props":36980,"children":36981},{"class":1062,"line":1249},[36982,36986,36990],{"type":49,"tag":1060,"props":36983,"children":36984},{"style":22635},[36985],{"type":55,"value":36819},{"type":49,"tag":1060,"props":36987,"children":36988},{"style":2194},[36989],{"type":55,"value":3068},{"type":49,"tag":1060,"props":36991,"children":36992},{"style":1073},[36993],{"type":55,"value":36828},{"type":49,"tag":1060,"props":36995,"children":36996},{"class":1062,"line":1262},[36997,37001,37005,37009],{"type":49,"tag":1060,"props":36998,"children":36999},{"style":2215},[37000],{"type":55,"value":36836},{"type":49,"tag":1060,"props":37002,"children":37003},{"style":1073},[37004],{"type":55,"value":78},{"type":49,"tag":1060,"props":37006,"children":37007},{"style":2215},[37008],{"type":55,"value":36845},{"type":49,"tag":1060,"props":37010,"children":37011},{"style":1073},[37012],{"type":55,"value":2497},{"type":49,"tag":1060,"props":37014,"children":37015},{"class":1062,"line":4581},[37016,37020,37024,37029],{"type":49,"tag":1060,"props":37017,"children":37018},{"style":2215},[37019],{"type":55,"value":36857},{"type":49,"tag":1060,"props":37021,"children":37022},{"style":1073},[37023],{"type":55,"value":6694},{"type":49,"tag":1060,"props":37025,"children":37026},{"style":2215},[37027],{"type":55,"value":37028},"'datepicker2'",{"type":49,"tag":1060,"props":37030,"children":37031},{"style":1073},[37032],{"type":55,"value":2497},{"type":49,"tag":1060,"props":37034,"children":37035},{"class":1062,"line":4631},[37036,37040,37044],{"type":49,"tag":1060,"props":37037,"children":37038},{"style":2215},[37039],{"type":55,"value":36878},{"type":49,"tag":1060,"props":37041,"children":37042},{"style":1073},[37043],{"type":55,"value":6694},{"type":49,"tag":1060,"props":37045,"children":37046},{"style":2215},[37047],{"type":55,"value":37048},"'published after'\n",{"type":49,"tag":1060,"props":37050,"children":37051},{"class":1062,"line":4682},[37052],{"type":49,"tag":1060,"props":37053,"children":37054},{"style":1073},[37055],{"type":55,"value":36895},{"type":49,"tag":1060,"props":37057,"children":37058},{"class":1062,"line":4709},[37059],{"type":49,"tag":1060,"props":37060,"children":37061},{"emptyLinePlaceholder":44},[37062],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37064,"children":37065},{"class":1062,"line":5979},[37066,37071,37075],{"type":49,"tag":1060,"props":37067,"children":37068},{"style":1073},[37069],{"type":55,"value":37070},"    keywords ",{"type":49,"tag":1060,"props":37072,"children":37073},{"style":2194},[37074],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37076,"children":37077},{"style":1073},[37078],{"type":55,"value":37079}," forms.CharField(\n",{"type":49,"tag":1060,"props":37081,"children":37082},{"class":1062,"line":5988},[37083,37087,37091,37095],{"type":49,"tag":1060,"props":37084,"children":37085},{"style":22635},[37086],{"type":55,"value":36773},{"type":49,"tag":1060,"props":37088,"children":37089},{"style":2194},[37090],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37092,"children":37093},{"style":2287},[37094],{"type":55,"value":36782},{"type":49,"tag":1060,"props":37096,"children":37097},{"style":1073},[37098],{"type":55,"value":2497},{"type":49,"tag":1060,"props":37100,"children":37101},{"class":1062,"line":5997},[37102,37106,37110,37114],{"type":49,"tag":1060,"props":37103,"children":37104},{"style":22635},[37105],{"type":55,"value":36753},{"type":49,"tag":1060,"props":37107,"children":37108},{"style":2194},[37109],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37111,"children":37112},{"style":2215},[37113],{"type":55,"value":17271},{"type":49,"tag":1060,"props":37115,"children":37116},{"style":1073},[37117],{"type":55,"value":2497},{"type":49,"tag":1060,"props":37119,"children":37120},{"class":1062,"line":6006},[37121,37125,37129],{"type":49,"tag":1060,"props":37122,"children":37123},{"style":22635},[37124],{"type":55,"value":36802},{"type":49,"tag":1060,"props":37126,"children":37127},{"style":2194},[37128],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37130,"children":37131},{"style":1073},[37132],{"type":55,"value":37133},"forms.TextInput(\n",{"type":49,"tag":1060,"props":37135,"children":37136},{"class":1062,"line":10142},[37137],{"type":49,"tag":1060,"props":37138,"children":37139},{"emptyLinePlaceholder":44},[37140],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37142,"children":37143},{"class":1062,"line":10151},[37144,37148,37152],{"type":49,"tag":1060,"props":37145,"children":37146},{"style":22635},[37147],{"type":55,"value":36819},{"type":49,"tag":1060,"props":37149,"children":37150},{"style":2194},[37151],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37153,"children":37154},{"style":1073},[37155],{"type":55,"value":36828},{"type":49,"tag":1060,"props":37157,"children":37158},{"class":1062,"line":10160},[37159,37163,37167,37171],{"type":49,"tag":1060,"props":37160,"children":37161},{"style":2215},[37162],{"type":55,"value":36836},{"type":49,"tag":1060,"props":37164,"children":37165},{"style":1073},[37166],{"type":55,"value":6694},{"type":49,"tag":1060,"props":37168,"children":37169},{"style":2215},[37170],{"type":55,"value":36845},{"type":49,"tag":1060,"props":37172,"children":37173},{"style":1073},[37174],{"type":55,"value":2497},{"type":49,"tag":1060,"props":37176,"children":37177},{"class":1062,"line":10188},[37178,37182,37186],{"type":49,"tag":1060,"props":37179,"children":37180},{"style":2215},[37181],{"type":55,"value":36878},{"type":49,"tag":1060,"props":37183,"children":37184},{"style":1073},[37185],{"type":55,"value":6694},{"type":49,"tag":1060,"props":37187,"children":37188},{"style":2215},[37189],{"type":55,"value":37190},"'space-separated words matching title, synopsis, website or tags'\n",{"type":49,"tag":1060,"props":37192,"children":37193},{"class":1062,"line":10196},[37194],{"type":49,"tag":1060,"props":37195,"children":37196},{"style":1073},[37197],{"type":55,"value":36895},{"type":49,"tag":58,"props":37199,"children":37200},{},[37201,37203,37209,37211,37217,37219,37225],{"type":55,"value":37202},"Here we are using three fields to filter data, a ",{"type":49,"tag":326,"props":37204,"children":37206},{"className":37205},[],[37207],{"type":55,"value":37208},"published_before",{"type":55,"value":37210}," date, a ",{"type":49,"tag":326,"props":37212,"children":37214},{"className":37213},[],[37215],{"type":55,"value":37216},"published_after",{"type":55,"value":37218}," date and a ",{"type":49,"tag":326,"props":37220,"children":37222},{"className":37221},[],[37223],{"type":55,"value":37224},"keywords",{"type":55,"value":14593},{"type":49,"tag":58,"props":37227,"children":37228},{},[37229,37231,37237,37239,37245,37247,37253,37255,37260],{"type":55,"value":37230},"Filtering this data can really clog up code in ",{"type":49,"tag":326,"props":37232,"children":37234},{"className":37233},[],[37235],{"type":55,"value":37236},"views.py",{"type":55,"value":37238},", and I know I was going to need this same code again for filtering data for CSV and XLS file downloads (more on this in a minute), so I decided to wrote a utility function that takes a ",{"type":49,"tag":326,"props":37240,"children":37242},{"className":37241},[],[37243],{"type":55,"value":37244},"Book",{"type":55,"value":37246}," queryset and parameter dictionary (",{"type":49,"tag":326,"props":37248,"children":37250},{"className":37249},[],[37251],{"type":55,"value":37252},"request.GET",{"type":55,"value":37254},"), and returns a filtered ",{"type":49,"tag":326,"props":37256,"children":37258},{"className":37257},[],[37259],{"type":55,"value":37244},{"type":55,"value":37261}," queryset. Here's what that function looks like:",{"type":49,"tag":1050,"props":37263,"children":37265},{"code":37264,"language":28337,"meta":8,"className":28338,"style":8},"from django.db.models import Q\nfrom functools import reduce\nfrom ..models import Book\nimport datetime\n\ndef filter_books(books, paramDict):\n    # paramDict = request.GET\n    params = paramDict.keys()\n\n    # data filtering\n    if any(x!='' for x in paramDict.values()):\n        if paramDict['publish_date_after'] != '':\n            after_date = paramDict['publish_date_after']\n            _after_date = datetime.datetime.strptime(after_date, '%m/%d/%Y')\n\n            books = books.filter(publish_date__gte=_after_date)\n\n        if paramDict['publish_date_before'] != '':\n            before_date = paramDict['publish_date_before']\n            _before_date = datetime.datetime.strptime(before_date, '%m/%d/%Y')\n            books = books.filter(publish_date__lte=_before_date)\n\n        # filters records that contain any of the following keywords\n        if paramDict['keywords'] != '':\n            kws = paramDict['keywords'].split()\n            q_lookups = [Q(title__icontains=kw) for kw in kws] + \\\n                        [Q(synopsis__icontains=kw) for kw in kws] + \\\n                        [Q(website__icontains=kw) for kw in kws]\n            filters = Q()\n            filters |= reduce(lambda x, y: x | y, q_lookups)\n            books = books.filter(filters)\n\n    return books\n",[37266],{"type":49,"tag":326,"props":37267,"children":37268},{"__ignoreMap":8},[37269,37290,37311,37331,37343,37350,37383,37391,37407,37414,37422,37466,37500,37524,37560,37567,37598,37605,37637,37661,37694,37723,37730,37738,37770,37795,37852,37897,37934,37951,38003,38019,38026],{"type":49,"tag":1060,"props":37270,"children":37271},{"class":1062,"line":1063},[37272,37276,37281,37285],{"type":49,"tag":1060,"props":37273,"children":37274},{"style":2194},[37275],{"type":55,"value":22184},{"type":49,"tag":1060,"props":37277,"children":37278},{"style":1073},[37279],{"type":55,"value":37280}," django.db.models ",{"type":49,"tag":1060,"props":37282,"children":37283},{"style":2194},[37284],{"type":55,"value":22194},{"type":49,"tag":1060,"props":37286,"children":37287},{"style":1073},[37288],{"type":55,"value":37289}," Q\n",{"type":49,"tag":1060,"props":37291,"children":37292},{"class":1062,"line":1079},[37293,37297,37302,37306],{"type":49,"tag":1060,"props":37294,"children":37295},{"style":2194},[37296],{"type":55,"value":22184},{"type":49,"tag":1060,"props":37298,"children":37299},{"style":1073},[37300],{"type":55,"value":37301}," functools ",{"type":49,"tag":1060,"props":37303,"children":37304},{"style":2194},[37305],{"type":55,"value":22194},{"type":49,"tag":1060,"props":37307,"children":37308},{"style":6686},[37309],{"type":55,"value":37310}," reduce\n",{"type":49,"tag":1060,"props":37312,"children":37313},{"class":1062,"line":1088},[37314,37318,37323,37327],{"type":49,"tag":1060,"props":37315,"children":37316},{"style":2194},[37317],{"type":55,"value":22184},{"type":49,"tag":1060,"props":37319,"children":37320},{"style":1073},[37321],{"type":55,"value":37322}," ..models ",{"type":49,"tag":1060,"props":37324,"children":37325},{"style":2194},[37326],{"type":55,"value":22194},{"type":49,"tag":1060,"props":37328,"children":37329},{"style":1073},[37330],{"type":55,"value":36073},{"type":49,"tag":1060,"props":37332,"children":37333},{"class":1062,"line":1097},[37334,37338],{"type":49,"tag":1060,"props":37335,"children":37336},{"style":2194},[37337],{"type":55,"value":22194},{"type":49,"tag":1060,"props":37339,"children":37340},{"style":1073},[37341],{"type":55,"value":37342}," datetime\n",{"type":49,"tag":1060,"props":37344,"children":37345},{"class":1062,"line":1111},[37346],{"type":49,"tag":1060,"props":37347,"children":37348},{"emptyLinePlaceholder":44},[37349],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37351,"children":37352},{"class":1062,"line":1120},[37353,37357,37362,37366,37370,37374,37379],{"type":49,"tag":1060,"props":37354,"children":37355},{"style":2182},[37356],{"type":55,"value":22214},{"type":49,"tag":1060,"props":37358,"children":37359},{"style":1067},[37360],{"type":55,"value":37361}," filter_books",{"type":49,"tag":1060,"props":37363,"children":37364},{"style":1073},[37365],{"type":55,"value":2284},{"type":49,"tag":1060,"props":37367,"children":37368},{"style":22226},[37369],{"type":55,"value":33186},{"type":49,"tag":1060,"props":37371,"children":37372},{"style":1073},[37373],{"type":55,"value":873},{"type":49,"tag":1060,"props":37375,"children":37376},{"style":22226},[37377],{"type":55,"value":37378},"paramDict",{"type":49,"tag":1060,"props":37380,"children":37381},{"style":1073},[37382],{"type":55,"value":22242},{"type":49,"tag":1060,"props":37384,"children":37385},{"class":1062,"line":1128},[37386],{"type":49,"tag":1060,"props":37387,"children":37388},{"style":3039},[37389],{"type":55,"value":37390},"    # paramDict = request.GET\n",{"type":49,"tag":1060,"props":37392,"children":37393},{"class":1062,"line":1141},[37394,37398,37402],{"type":49,"tag":1060,"props":37395,"children":37396},{"style":1073},[37397],{"type":55,"value":31833},{"type":49,"tag":1060,"props":37399,"children":37400},{"style":2194},[37401],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37403,"children":37404},{"style":1073},[37405],{"type":55,"value":37406}," paramDict.keys()\n",{"type":49,"tag":1060,"props":37408,"children":37409},{"class":1062,"line":1150},[37410],{"type":49,"tag":1060,"props":37411,"children":37412},{"emptyLinePlaceholder":44},[37413],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37415,"children":37416},{"class":1062,"line":1158},[37417],{"type":49,"tag":1060,"props":37418,"children":37419},{"style":3039},[37420],{"type":55,"value":37421},"    # data filtering\n",{"type":49,"tag":1060,"props":37423,"children":37424},{"class":1062,"line":1171},[37425,37429,37434,37439,37443,37447,37452,37457,37461],{"type":49,"tag":1060,"props":37426,"children":37427},{"style":2194},[37428],{"type":55,"value":3050},{"type":49,"tag":1060,"props":37430,"children":37431},{"style":9965},[37432],{"type":55,"value":37433}," any",{"type":49,"tag":1060,"props":37435,"children":37436},{"style":1073},[37437],{"type":55,"value":37438},"(x",{"type":49,"tag":1060,"props":37440,"children":37441},{"style":2194},[37442],{"type":55,"value":35393},{"type":49,"tag":1060,"props":37444,"children":37445},{"style":2215},[37446],{"type":55,"value":17271},{"type":49,"tag":1060,"props":37448,"children":37449},{"style":2194},[37450],{"type":55,"value":37451}," for",{"type":49,"tag":1060,"props":37453,"children":37454},{"style":1073},[37455],{"type":55,"value":37456}," x ",{"type":49,"tag":1060,"props":37458,"children":37459},{"style":2194},[37460],{"type":55,"value":10073},{"type":49,"tag":1060,"props":37462,"children":37463},{"style":1073},[37464],{"type":55,"value":37465}," paramDict.values()):\n",{"type":49,"tag":1060,"props":37467,"children":37468},{"class":1062,"line":1180},[37469,37473,37478,37483,37487,37491,37496],{"type":49,"tag":1060,"props":37470,"children":37471},{"style":2194},[37472],{"type":55,"value":29767},{"type":49,"tag":1060,"props":37474,"children":37475},{"style":1073},[37476],{"type":55,"value":37477}," paramDict[",{"type":49,"tag":1060,"props":37479,"children":37480},{"style":2215},[37481],{"type":55,"value":37482},"'publish_date_after'",{"type":49,"tag":1060,"props":37484,"children":37485},{"style":1073},[37486],{"type":55,"value":22304},{"type":49,"tag":1060,"props":37488,"children":37489},{"style":2194},[37490],{"type":55,"value":35393},{"type":49,"tag":1060,"props":37492,"children":37493},{"style":2215},[37494],{"type":55,"value":37495}," ''",{"type":49,"tag":1060,"props":37497,"children":37498},{"style":1073},[37499],{"type":55,"value":6862},{"type":49,"tag":1060,"props":37501,"children":37502},{"class":1062,"line":1188},[37503,37508,37512,37516,37520],{"type":49,"tag":1060,"props":37504,"children":37505},{"style":1073},[37506],{"type":55,"value":37507},"            after_date ",{"type":49,"tag":1060,"props":37509,"children":37510},{"style":2194},[37511],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37513,"children":37514},{"style":1073},[37515],{"type":55,"value":37477},{"type":49,"tag":1060,"props":37517,"children":37518},{"style":2215},[37519],{"type":55,"value":37482},{"type":49,"tag":1060,"props":37521,"children":37522},{"style":1073},[37523],{"type":55,"value":33153},{"type":49,"tag":1060,"props":37525,"children":37526},{"class":1062,"line":1201},[37527,37532,37536,37541,37546,37551,37556],{"type":49,"tag":1060,"props":37528,"children":37529},{"style":1073},[37530],{"type":55,"value":37531},"            _after_date ",{"type":49,"tag":1060,"props":37533,"children":37534},{"style":2194},[37535],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37537,"children":37538},{"style":1073},[37539],{"type":55,"value":37540}," datetime.datetime.strptime(after_date, ",{"type":49,"tag":1060,"props":37542,"children":37543},{"style":2215},[37544],{"type":55,"value":37545},"'%m/",{"type":49,"tag":1060,"props":37547,"children":37548},{"style":2287},[37549],{"type":55,"value":37550},"%d",{"type":49,"tag":1060,"props":37552,"children":37553},{"style":2215},[37554],{"type":55,"value":37555},"/%Y'",{"type":49,"tag":1060,"props":37557,"children":37558},{"style":1073},[37559],{"type":55,"value":5126},{"type":49,"tag":1060,"props":37561,"children":37562},{"class":1062,"line":1210},[37563],{"type":49,"tag":1060,"props":37564,"children":37565},{"emptyLinePlaceholder":44},[37566],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37568,"children":37569},{"class":1062,"line":1218},[37570,37575,37579,37584,37589,37593],{"type":49,"tag":1060,"props":37571,"children":37572},{"style":1073},[37573],{"type":55,"value":37574},"            books ",{"type":49,"tag":1060,"props":37576,"children":37577},{"style":2194},[37578],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37580,"children":37581},{"style":1073},[37582],{"type":55,"value":37583}," books.filter(",{"type":49,"tag":1060,"props":37585,"children":37586},{"style":22635},[37587],{"type":55,"value":37588},"publish_date__gte",{"type":49,"tag":1060,"props":37590,"children":37591},{"style":2194},[37592],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37594,"children":37595},{"style":1073},[37596],{"type":55,"value":37597},"_after_date)\n",{"type":49,"tag":1060,"props":37599,"children":37600},{"class":1062,"line":1232},[37601],{"type":49,"tag":1060,"props":37602,"children":37603},{"emptyLinePlaceholder":44},[37604],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37606,"children":37607},{"class":1062,"line":1241},[37608,37612,37616,37621,37625,37629,37633],{"type":49,"tag":1060,"props":37609,"children":37610},{"style":2194},[37611],{"type":55,"value":29767},{"type":49,"tag":1060,"props":37613,"children":37614},{"style":1073},[37615],{"type":55,"value":37477},{"type":49,"tag":1060,"props":37617,"children":37618},{"style":2215},[37619],{"type":55,"value":37620},"'publish_date_before'",{"type":49,"tag":1060,"props":37622,"children":37623},{"style":1073},[37624],{"type":55,"value":22304},{"type":49,"tag":1060,"props":37626,"children":37627},{"style":2194},[37628],{"type":55,"value":35393},{"type":49,"tag":1060,"props":37630,"children":37631},{"style":2215},[37632],{"type":55,"value":37495},{"type":49,"tag":1060,"props":37634,"children":37635},{"style":1073},[37636],{"type":55,"value":6862},{"type":49,"tag":1060,"props":37638,"children":37639},{"class":1062,"line":1249},[37640,37645,37649,37653,37657],{"type":49,"tag":1060,"props":37641,"children":37642},{"style":1073},[37643],{"type":55,"value":37644},"            before_date ",{"type":49,"tag":1060,"props":37646,"children":37647},{"style":2194},[37648],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37650,"children":37651},{"style":1073},[37652],{"type":55,"value":37477},{"type":49,"tag":1060,"props":37654,"children":37655},{"style":2215},[37656],{"type":55,"value":37620},{"type":49,"tag":1060,"props":37658,"children":37659},{"style":1073},[37660],{"type":55,"value":33153},{"type":49,"tag":1060,"props":37662,"children":37663},{"class":1062,"line":1262},[37664,37669,37673,37678,37682,37686,37690],{"type":49,"tag":1060,"props":37665,"children":37666},{"style":1073},[37667],{"type":55,"value":37668},"            _before_date ",{"type":49,"tag":1060,"props":37670,"children":37671},{"style":2194},[37672],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37674,"children":37675},{"style":1073},[37676],{"type":55,"value":37677}," datetime.datetime.strptime(before_date, ",{"type":49,"tag":1060,"props":37679,"children":37680},{"style":2215},[37681],{"type":55,"value":37545},{"type":49,"tag":1060,"props":37683,"children":37684},{"style":2287},[37685],{"type":55,"value":37550},{"type":49,"tag":1060,"props":37687,"children":37688},{"style":2215},[37689],{"type":55,"value":37555},{"type":49,"tag":1060,"props":37691,"children":37692},{"style":1073},[37693],{"type":55,"value":5126},{"type":49,"tag":1060,"props":37695,"children":37696},{"class":1062,"line":4581},[37697,37701,37705,37709,37714,37718],{"type":49,"tag":1060,"props":37698,"children":37699},{"style":1073},[37700],{"type":55,"value":37574},{"type":49,"tag":1060,"props":37702,"children":37703},{"style":2194},[37704],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37706,"children":37707},{"style":1073},[37708],{"type":55,"value":37583},{"type":49,"tag":1060,"props":37710,"children":37711},{"style":22635},[37712],{"type":55,"value":37713},"publish_date__lte",{"type":49,"tag":1060,"props":37715,"children":37716},{"style":2194},[37717],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37719,"children":37720},{"style":1073},[37721],{"type":55,"value":37722},"_before_date)\n",{"type":49,"tag":1060,"props":37724,"children":37725},{"class":1062,"line":4631},[37726],{"type":49,"tag":1060,"props":37727,"children":37728},{"emptyLinePlaceholder":44},[37729],{"type":55,"value":1094},{"type":49,"tag":1060,"props":37731,"children":37732},{"class":1062,"line":4682},[37733],{"type":49,"tag":1060,"props":37734,"children":37735},{"style":3039},[37736],{"type":55,"value":37737},"        # filters records that contain any of the following keywords\n",{"type":49,"tag":1060,"props":37739,"children":37740},{"class":1062,"line":4709},[37741,37745,37749,37754,37758,37762,37766],{"type":49,"tag":1060,"props":37742,"children":37743},{"style":2194},[37744],{"type":55,"value":29767},{"type":49,"tag":1060,"props":37746,"children":37747},{"style":1073},[37748],{"type":55,"value":37477},{"type":49,"tag":1060,"props":37750,"children":37751},{"style":2215},[37752],{"type":55,"value":37753},"'keywords'",{"type":49,"tag":1060,"props":37755,"children":37756},{"style":1073},[37757],{"type":55,"value":22304},{"type":49,"tag":1060,"props":37759,"children":37760},{"style":2194},[37761],{"type":55,"value":35393},{"type":49,"tag":1060,"props":37763,"children":37764},{"style":2215},[37765],{"type":55,"value":37495},{"type":49,"tag":1060,"props":37767,"children":37768},{"style":1073},[37769],{"type":55,"value":6862},{"type":49,"tag":1060,"props":37771,"children":37772},{"class":1062,"line":5979},[37773,37778,37782,37786,37790],{"type":49,"tag":1060,"props":37774,"children":37775},{"style":1073},[37776],{"type":55,"value":37777},"            kws ",{"type":49,"tag":1060,"props":37779,"children":37780},{"style":2194},[37781],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37783,"children":37784},{"style":1073},[37785],{"type":55,"value":37477},{"type":49,"tag":1060,"props":37787,"children":37788},{"style":2215},[37789],{"type":55,"value":37753},{"type":49,"tag":1060,"props":37791,"children":37792},{"style":1073},[37793],{"type":55,"value":37794},"].split()\n",{"type":49,"tag":1060,"props":37796,"children":37797},{"class":1062,"line":5988},[37798,37803,37807,37812,37817,37821,37826,37830,37835,37839,37844,37848],{"type":49,"tag":1060,"props":37799,"children":37800},{"style":1073},[37801],{"type":55,"value":37802},"            q_lookups ",{"type":49,"tag":1060,"props":37804,"children":37805},{"style":2194},[37806],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37808,"children":37809},{"style":1073},[37810],{"type":55,"value":37811}," [Q(",{"type":49,"tag":1060,"props":37813,"children":37814},{"style":22635},[37815],{"type":55,"value":37816},"title__icontains",{"type":49,"tag":1060,"props":37818,"children":37819},{"style":2194},[37820],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37822,"children":37823},{"style":1073},[37824],{"type":55,"value":37825},"kw) ",{"type":49,"tag":1060,"props":37827,"children":37828},{"style":2194},[37829],{"type":55,"value":10063},{"type":49,"tag":1060,"props":37831,"children":37832},{"style":1073},[37833],{"type":55,"value":37834}," kw ",{"type":49,"tag":1060,"props":37836,"children":37837},{"style":2194},[37838],{"type":55,"value":10073},{"type":49,"tag":1060,"props":37840,"children":37841},{"style":1073},[37842],{"type":55,"value":37843}," kws] ",{"type":49,"tag":1060,"props":37845,"children":37846},{"style":2194},[37847],{"type":55,"value":33901},{"type":49,"tag":1060,"props":37849,"children":37850},{"style":1073},[37851],{"type":55,"value":10239},{"type":49,"tag":1060,"props":37853,"children":37854},{"class":1062,"line":5997},[37855,37860,37865,37869,37873,37877,37881,37885,37889,37893],{"type":49,"tag":1060,"props":37856,"children":37857},{"style":1073},[37858],{"type":55,"value":37859},"                        [Q(",{"type":49,"tag":1060,"props":37861,"children":37862},{"style":22635},[37863],{"type":55,"value":37864},"synopsis__icontains",{"type":49,"tag":1060,"props":37866,"children":37867},{"style":2194},[37868],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37870,"children":37871},{"style":1073},[37872],{"type":55,"value":37825},{"type":49,"tag":1060,"props":37874,"children":37875},{"style":2194},[37876],{"type":55,"value":10063},{"type":49,"tag":1060,"props":37878,"children":37879},{"style":1073},[37880],{"type":55,"value":37834},{"type":49,"tag":1060,"props":37882,"children":37883},{"style":2194},[37884],{"type":55,"value":10073},{"type":49,"tag":1060,"props":37886,"children":37887},{"style":1073},[37888],{"type":55,"value":37843},{"type":49,"tag":1060,"props":37890,"children":37891},{"style":2194},[37892],{"type":55,"value":33901},{"type":49,"tag":1060,"props":37894,"children":37895},{"style":1073},[37896],{"type":55,"value":10239},{"type":49,"tag":1060,"props":37898,"children":37899},{"class":1062,"line":6006},[37900,37904,37909,37913,37917,37921,37925,37929],{"type":49,"tag":1060,"props":37901,"children":37902},{"style":1073},[37903],{"type":55,"value":37859},{"type":49,"tag":1060,"props":37905,"children":37906},{"style":22635},[37907],{"type":55,"value":37908},"website__icontains",{"type":49,"tag":1060,"props":37910,"children":37911},{"style":2194},[37912],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37914,"children":37915},{"style":1073},[37916],{"type":55,"value":37825},{"type":49,"tag":1060,"props":37918,"children":37919},{"style":2194},[37920],{"type":55,"value":10063},{"type":49,"tag":1060,"props":37922,"children":37923},{"style":1073},[37924],{"type":55,"value":37834},{"type":49,"tag":1060,"props":37926,"children":37927},{"style":2194},[37928],{"type":55,"value":10073},{"type":49,"tag":1060,"props":37930,"children":37931},{"style":1073},[37932],{"type":55,"value":37933}," kws]\n",{"type":49,"tag":1060,"props":37935,"children":37936},{"class":1062,"line":10142},[37937,37942,37946],{"type":49,"tag":1060,"props":37938,"children":37939},{"style":1073},[37940],{"type":55,"value":37941},"            filters ",{"type":49,"tag":1060,"props":37943,"children":37944},{"style":2194},[37945],{"type":55,"value":3068},{"type":49,"tag":1060,"props":37947,"children":37948},{"style":1073},[37949],{"type":55,"value":37950}," Q()\n",{"type":49,"tag":1060,"props":37952,"children":37953},{"class":1062,"line":10151},[37954,37958,37963,37968,37972,37976,37980,37984,37989,37994,37998],{"type":49,"tag":1060,"props":37955,"children":37956},{"style":1073},[37957],{"type":55,"value":37941},{"type":49,"tag":1060,"props":37959,"children":37960},{"style":2194},[37961],{"type":55,"value":37962},"|=",{"type":49,"tag":1060,"props":37964,"children":37965},{"style":6686},[37966],{"type":55,"value":37967}," reduce",{"type":49,"tag":1060,"props":37969,"children":37970},{"style":1073},[37971],{"type":55,"value":2284},{"type":49,"tag":1060,"props":37973,"children":37974},{"style":2182},[37975],{"type":55,"value":22048},{"type":49,"tag":1060,"props":37977,"children":37978},{"style":22226},[37979],{"type":55,"value":3588},{"type":49,"tag":1060,"props":37981,"children":37982},{"style":1073},[37983],{"type":55,"value":873},{"type":49,"tag":1060,"props":37985,"children":37986},{"style":22226},[37987],{"type":55,"value":37988},"y",{"type":49,"tag":1060,"props":37990,"children":37991},{"style":1073},[37992],{"type":55,"value":37993},": x ",{"type":49,"tag":1060,"props":37995,"children":37996},{"style":2194},[37997],{"type":55,"value":10302},{"type":49,"tag":1060,"props":37999,"children":38000},{"style":1073},[38001],{"type":55,"value":38002}," y, q_lookups)\n",{"type":49,"tag":1060,"props":38004,"children":38005},{"class":1062,"line":10160},[38006,38010,38014],{"type":49,"tag":1060,"props":38007,"children":38008},{"style":1073},[38009],{"type":55,"value":37574},{"type":49,"tag":1060,"props":38011,"children":38012},{"style":2194},[38013],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38015,"children":38016},{"style":1073},[38017],{"type":55,"value":38018}," books.filter(filters)\n",{"type":49,"tag":1060,"props":38020,"children":38021},{"class":1062,"line":10188},[38022],{"type":49,"tag":1060,"props":38023,"children":38024},{"emptyLinePlaceholder":44},[38025],{"type":55,"value":1094},{"type":49,"tag":1060,"props":38027,"children":38028},{"class":1062,"line":10196},[38029,38033],{"type":49,"tag":1060,"props":38030,"children":38031},{"style":2194},[38032],{"type":55,"value":25371},{"type":49,"tag":1060,"props":38034,"children":38035},{"style":1073},[38036],{"type":55,"value":38037}," books\n",{"type":49,"tag":58,"props":38039,"children":38040},{},[38041,38043,38048],{"type":55,"value":38042},"This makes things much more simple in our views. Here's the code in the main ",{"type":49,"tag":326,"props":38044,"children":38046},{"className":38045},[],[38047],{"type":55,"value":33186},{"type":55,"value":38049}," view that uses this filter function, truncated for simplicity:",{"type":49,"tag":1050,"props":38051,"children":38053},{"code":38052,"language":28337,"meta":8,"className":28338,"style":8},"def all_books(request):\n    books = Book.objects.all()\n    form = QueryForm(request.GET or None)\n    paramDict = request.GET\n    books = filter_books(books, paramDict)\n    [...]\n    context = {\n        'books':books,\n        'form':form,\n        [...],}\n    return render(request, 'books/books.html', context)\n",[38054],{"type":49,"tag":326,"props":38055,"children":38056},{"__ignoreMap":8},[38057,38080,38095,38126,38145,38160,38175,38190,38201,38213,38230],{"type":49,"tag":1060,"props":38058,"children":38059},{"class":1062,"line":1063},[38060,38064,38068,38072,38076],{"type":49,"tag":1060,"props":38061,"children":38062},{"style":2182},[38063],{"type":55,"value":22214},{"type":49,"tag":1060,"props":38065,"children":38066},{"style":1067},[38067],{"type":55,"value":33212},{"type":49,"tag":1060,"props":38069,"children":38070},{"style":1073},[38071],{"type":55,"value":2284},{"type":49,"tag":1060,"props":38073,"children":38074},{"style":22226},[38075],{"type":55,"value":33221},{"type":49,"tag":1060,"props":38077,"children":38078},{"style":1073},[38079],{"type":55,"value":22242},{"type":49,"tag":1060,"props":38081,"children":38082},{"class":1062,"line":1079},[38083,38087,38091],{"type":49,"tag":1060,"props":38084,"children":38085},{"style":1073},[38086],{"type":55,"value":33256},{"type":49,"tag":1060,"props":38088,"children":38089},{"style":2194},[38090],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38092,"children":38093},{"style":1073},[38094],{"type":55,"value":33265},{"type":49,"tag":1060,"props":38096,"children":38097},{"class":1062,"line":1088},[38098,38102,38106,38110,38114,38118,38122],{"type":49,"tag":1060,"props":38099,"children":38100},{"style":1073},[38101],{"type":55,"value":33273},{"type":49,"tag":1060,"props":38103,"children":38104},{"style":2194},[38105],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38107,"children":38108},{"style":1073},[38109],{"type":55,"value":33282},{"type":49,"tag":1060,"props":38111,"children":38112},{"style":2287},[38113],{"type":55,"value":17032},{"type":49,"tag":1060,"props":38115,"children":38116},{"style":2194},[38117],{"type":55,"value":33291},{"type":49,"tag":1060,"props":38119,"children":38120},{"style":2287},[38121],{"type":55,"value":33296},{"type":49,"tag":1060,"props":38123,"children":38124},{"style":1073},[38125],{"type":55,"value":5126},{"type":49,"tag":1060,"props":38127,"children":38128},{"class":1062,"line":1097},[38129,38133,38137,38141],{"type":49,"tag":1060,"props":38130,"children":38131},{"style":1073},[38132],{"type":55,"value":33308},{"type":49,"tag":1060,"props":38134,"children":38135},{"style":2194},[38136],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38138,"children":38139},{"style":1073},[38140],{"type":55,"value":33317},{"type":49,"tag":1060,"props":38142,"children":38143},{"style":2287},[38144],{"type":55,"value":33322},{"type":49,"tag":1060,"props":38146,"children":38147},{"class":1062,"line":1111},[38148,38152,38156],{"type":49,"tag":1060,"props":38149,"children":38150},{"style":1073},[38151],{"type":55,"value":33256},{"type":49,"tag":1060,"props":38153,"children":38154},{"style":2194},[38155],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38157,"children":38158},{"style":1073},[38159],{"type":55,"value":33345},{"type":49,"tag":1060,"props":38161,"children":38162},{"class":1062,"line":1120},[38163,38167,38171],{"type":49,"tag":1060,"props":38164,"children":38165},{"style":1073},[38166],{"type":55,"value":33144},{"type":49,"tag":1060,"props":38168,"children":38169},{"style":2287},[38170],{"type":55,"value":3078},{"type":49,"tag":1060,"props":38172,"children":38173},{"style":1073},[38174],{"type":55,"value":33153},{"type":49,"tag":1060,"props":38176,"children":38177},{"class":1062,"line":1128},[38178,38182,38186],{"type":49,"tag":1060,"props":38179,"children":38180},{"style":1073},[38181],{"type":55,"value":33500},{"type":49,"tag":1060,"props":38183,"children":38184},{"style":2194},[38185],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38187,"children":38188},{"style":1073},[38189],{"type":55,"value":4010},{"type":49,"tag":1060,"props":38191,"children":38192},{"class":1062,"line":1141},[38193,38197],{"type":49,"tag":1060,"props":38194,"children":38195},{"style":2215},[38196],{"type":55,"value":33516},{"type":49,"tag":1060,"props":38198,"children":38199},{"style":1073},[38200],{"type":55,"value":33521},{"type":49,"tag":1060,"props":38202,"children":38203},{"class":1062,"line":1150},[38204,38208],{"type":49,"tag":1060,"props":38205,"children":38206},{"style":2215},[38207],{"type":55,"value":33581},{"type":49,"tag":1060,"props":38209,"children":38210},{"style":1073},[38211],{"type":55,"value":38212},":form,\n",{"type":49,"tag":1060,"props":38214,"children":38215},{"class":1062,"line":1158},[38216,38221,38225],{"type":49,"tag":1060,"props":38217,"children":38218},{"style":1073},[38219],{"type":55,"value":38220},"        [",{"type":49,"tag":1060,"props":38222,"children":38223},{"style":2287},[38224],{"type":55,"value":3078},{"type":49,"tag":1060,"props":38226,"children":38227},{"style":1073},[38228],{"type":55,"value":38229},"],}\n",{"type":49,"tag":1060,"props":38231,"children":38232},{"class":1062,"line":1171},[38233,38237,38241,38245],{"type":49,"tag":1060,"props":38234,"children":38235},{"style":2194},[38236],{"type":55,"value":25371},{"type":49,"tag":1060,"props":38238,"children":38239},{"style":1073},[38240],{"type":55,"value":33598},{"type":49,"tag":1060,"props":38242,"children":38243},{"style":2215},[38244],{"type":55,"value":33603},{"type":49,"tag":1060,"props":38246,"children":38247},{"style":1073},[38248],{"type":55,"value":33608},{"type":49,"tag":50,"props":38250,"children":38252},{"id":38251},"exporting-data-as-csv-or-xls",[38253],{"type":55,"value":38254},"Exporting data as CSV or XLS",{"type":49,"tag":58,"props":38256,"children":38257},{},[38258],{"type":55,"value":38259},"One other requirement I gave myself for this project was giving users the option to export data in CSV or XLS file formats.",{"type":49,"tag":58,"props":38261,"children":38262},{},[38263,38265,38272,38274,38280,38282,38289],{"type":55,"value":38264},"With the filter data function, I was able to keep things DRY (Don't Repeart Yourself). This task taught me about a few aspects of HTML5 and forms that I wasn't aware of. First, let's take a look at the CSV export function that I learned about throught ",{"type":49,"tag":80,"props":38266,"children":38269},{"href":38267,"rel":38268},"https://simpleisbetterthancomplex.com/tutorial/2016/07/29/how-to-export-to-excel.html",[84],[38270],{"type":55,"value":38271},"this blog post",{"type":55,"value":38273},", from a great Django blog called ",{"type":49,"tag":80,"props":38275,"children":38277},{"href":38267,"rel":38276},[84],[38278],{"type":55,"value":38279},"Simple is Better than Complex",{"type":55,"value":38281}," by ",{"type":49,"tag":80,"props":38283,"children":38286},{"href":38284,"rel":38285},"https://github.com/vitorfs",[84],[38287],{"type":55,"value":38288},"Vitor Freitas",{"type":55,"value":6694},{"type":49,"tag":1050,"props":38291,"children":38293},{"code":38292,"language":28337,"meta":8,"className":28338,"style":8},"def export_filtered_books_csv(request):\n    response = HttpResponse(content_type='text/csv')\n    response['Content-Disposition'] = 'attachment; filename=\"books.csv\"'\n\n    writer = csv.writer(response)\n    writer.writerow(['Title', 'Synopsis', 'Pages'])\n    books = Book.objects.all()\n    paramDict = request.GET\n    books = filter_books(books, paramDict)\n    books = books.values_list(\n        'title',\n        'synopsis',\n        'pages')\n\n    for book in books:\n        writer.writerow(book)\n\n    return response\n",[38294],{"type":49,"tag":326,"props":38295,"children":38296},{"__ignoreMap":8},[38297,38321,38355,38381,38388,38405,38441,38456,38475,38490,38506,38518,38530,38542,38549,38569,38577,38584],{"type":49,"tag":1060,"props":38298,"children":38299},{"class":1062,"line":1063},[38300,38304,38309,38313,38317],{"type":49,"tag":1060,"props":38301,"children":38302},{"style":2182},[38303],{"type":55,"value":22214},{"type":49,"tag":1060,"props":38305,"children":38306},{"style":1067},[38307],{"type":55,"value":38308}," export_filtered_books_csv",{"type":49,"tag":1060,"props":38310,"children":38311},{"style":1073},[38312],{"type":55,"value":2284},{"type":49,"tag":1060,"props":38314,"children":38315},{"style":22226},[38316],{"type":55,"value":33221},{"type":49,"tag":1060,"props":38318,"children":38319},{"style":1073},[38320],{"type":55,"value":22242},{"type":49,"tag":1060,"props":38322,"children":38323},{"class":1062,"line":1079},[38324,38328,38332,38337,38342,38346,38351],{"type":49,"tag":1060,"props":38325,"children":38326},{"style":1073},[38327],{"type":55,"value":31946},{"type":49,"tag":1060,"props":38329,"children":38330},{"style":2194},[38331],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38333,"children":38334},{"style":1073},[38335],{"type":55,"value":38336}," HttpResponse(",{"type":49,"tag":1060,"props":38338,"children":38339},{"style":22635},[38340],{"type":55,"value":38341},"content_type",{"type":49,"tag":1060,"props":38343,"children":38344},{"style":2194},[38345],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38347,"children":38348},{"style":2215},[38349],{"type":55,"value":38350},"'text/csv'",{"type":49,"tag":1060,"props":38352,"children":38353},{"style":1073},[38354],{"type":55,"value":5126},{"type":49,"tag":1060,"props":38356,"children":38357},{"class":1062,"line":1088},[38358,38363,38368,38372,38376],{"type":49,"tag":1060,"props":38359,"children":38360},{"style":1073},[38361],{"type":55,"value":38362},"    response[",{"type":49,"tag":1060,"props":38364,"children":38365},{"style":2215},[38366],{"type":55,"value":38367},"'Content-Disposition'",{"type":49,"tag":1060,"props":38369,"children":38370},{"style":1073},[38371],{"type":55,"value":22304},{"type":49,"tag":1060,"props":38373,"children":38374},{"style":2194},[38375],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38377,"children":38378},{"style":2215},[38379],{"type":55,"value":38380}," 'attachment; filename=\"books.csv\"'\n",{"type":49,"tag":1060,"props":38382,"children":38383},{"class":1062,"line":1097},[38384],{"type":49,"tag":1060,"props":38385,"children":38386},{"emptyLinePlaceholder":44},[38387],{"type":55,"value":1094},{"type":49,"tag":1060,"props":38389,"children":38390},{"class":1062,"line":1111},[38391,38396,38400],{"type":49,"tag":1060,"props":38392,"children":38393},{"style":1073},[38394],{"type":55,"value":38395},"    writer ",{"type":49,"tag":1060,"props":38397,"children":38398},{"style":2194},[38399],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38401,"children":38402},{"style":1073},[38403],{"type":55,"value":38404}," csv.writer(response)\n",{"type":49,"tag":1060,"props":38406,"children":38407},{"class":1062,"line":1120},[38408,38413,38418,38422,38427,38431,38436],{"type":49,"tag":1060,"props":38409,"children":38410},{"style":1073},[38411],{"type":55,"value":38412},"    writer.writerow([",{"type":49,"tag":1060,"props":38414,"children":38415},{"style":2215},[38416],{"type":55,"value":38417},"'Title'",{"type":49,"tag":1060,"props":38419,"children":38420},{"style":1073},[38421],{"type":55,"value":873},{"type":49,"tag":1060,"props":38423,"children":38424},{"style":2215},[38425],{"type":55,"value":38426},"'Synopsis'",{"type":49,"tag":1060,"props":38428,"children":38429},{"style":1073},[38430],{"type":55,"value":873},{"type":49,"tag":1060,"props":38432,"children":38433},{"style":2215},[38434],{"type":55,"value":38435},"'Pages'",{"type":49,"tag":1060,"props":38437,"children":38438},{"style":1073},[38439],{"type":55,"value":38440},"])\n",{"type":49,"tag":1060,"props":38442,"children":38443},{"class":1062,"line":1128},[38444,38448,38452],{"type":49,"tag":1060,"props":38445,"children":38446},{"style":1073},[38447],{"type":55,"value":33256},{"type":49,"tag":1060,"props":38449,"children":38450},{"style":2194},[38451],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38453,"children":38454},{"style":1073},[38455],{"type":55,"value":33265},{"type":49,"tag":1060,"props":38457,"children":38458},{"class":1062,"line":1141},[38459,38463,38467,38471],{"type":49,"tag":1060,"props":38460,"children":38461},{"style":1073},[38462],{"type":55,"value":33308},{"type":49,"tag":1060,"props":38464,"children":38465},{"style":2194},[38466],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38468,"children":38469},{"style":1073},[38470],{"type":55,"value":33317},{"type":49,"tag":1060,"props":38472,"children":38473},{"style":2287},[38474],{"type":55,"value":33322},{"type":49,"tag":1060,"props":38476,"children":38477},{"class":1062,"line":1150},[38478,38482,38486],{"type":49,"tag":1060,"props":38479,"children":38480},{"style":1073},[38481],{"type":55,"value":33256},{"type":49,"tag":1060,"props":38483,"children":38484},{"style":2194},[38485],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38487,"children":38488},{"style":1073},[38489],{"type":55,"value":33345},{"type":49,"tag":1060,"props":38491,"children":38492},{"class":1062,"line":1158},[38493,38497,38501],{"type":49,"tag":1060,"props":38494,"children":38495},{"style":1073},[38496],{"type":55,"value":33256},{"type":49,"tag":1060,"props":38498,"children":38499},{"style":2194},[38500],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38502,"children":38503},{"style":1073},[38504],{"type":55,"value":38505}," books.values_list(\n",{"type":49,"tag":1060,"props":38507,"children":38508},{"class":1062,"line":1171},[38509,38514],{"type":49,"tag":1060,"props":38510,"children":38511},{"style":2215},[38512],{"type":55,"value":38513},"        'title'",{"type":49,"tag":1060,"props":38515,"children":38516},{"style":1073},[38517],{"type":55,"value":2497},{"type":49,"tag":1060,"props":38519,"children":38520},{"class":1062,"line":1180},[38521,38526],{"type":49,"tag":1060,"props":38522,"children":38523},{"style":2215},[38524],{"type":55,"value":38525},"        'synopsis'",{"type":49,"tag":1060,"props":38527,"children":38528},{"style":1073},[38529],{"type":55,"value":2497},{"type":49,"tag":1060,"props":38531,"children":38532},{"class":1062,"line":1188},[38533,38538],{"type":49,"tag":1060,"props":38534,"children":38535},{"style":2215},[38536],{"type":55,"value":38537},"        'pages'",{"type":49,"tag":1060,"props":38539,"children":38540},{"style":1073},[38541],{"type":55,"value":5126},{"type":49,"tag":1060,"props":38543,"children":38544},{"class":1062,"line":1201},[38545],{"type":49,"tag":1060,"props":38546,"children":38547},{"emptyLinePlaceholder":44},[38548],{"type":55,"value":1094},{"type":49,"tag":1060,"props":38550,"children":38551},{"class":1062,"line":1210},[38552,38556,38560,38564],{"type":49,"tag":1060,"props":38553,"children":38554},{"style":2194},[38555],{"type":55,"value":34656},{"type":49,"tag":1060,"props":38557,"children":38558},{"style":1073},[38559],{"type":55,"value":33483},{"type":49,"tag":1060,"props":38561,"children":38562},{"style":2194},[38563],{"type":55,"value":10073},{"type":49,"tag":1060,"props":38565,"children":38566},{"style":1073},[38567],{"type":55,"value":38568}," books:\n",{"type":49,"tag":1060,"props":38570,"children":38571},{"class":1062,"line":1218},[38572],{"type":49,"tag":1060,"props":38573,"children":38574},{"style":1073},[38575],{"type":55,"value":38576},"        writer.writerow(book)\n",{"type":49,"tag":1060,"props":38578,"children":38579},{"class":1062,"line":1232},[38580],{"type":49,"tag":1060,"props":38581,"children":38582},{"emptyLinePlaceholder":44},[38583],{"type":55,"value":1094},{"type":49,"tag":1060,"props":38585,"children":38586},{"class":1062,"line":1241},[38587,38591],{"type":49,"tag":1060,"props":38588,"children":38589},{"style":2194},[38590],{"type":55,"value":25371},{"type":49,"tag":1060,"props":38592,"children":38593},{"style":1073},[38594],{"type":55,"value":38595}," response\n",{"type":49,"tag":58,"props":38597,"children":38598},{},[38599,38601,38606],{"type":55,"value":38600},"I wanted to put this button in the filter form on the main ",{"type":49,"tag":326,"props":38602,"children":38604},{"className":38603},[],[38605],{"type":55,"value":33186},{"type":55,"value":38607}," page, but I need to place the button outside of the form tag. To get around this, here is the HTML I used:",{"type":49,"tag":58,"props":38609,"children":38610},{},[38611],{"type":55,"value":32781},{"type":49,"tag":1050,"props":38613,"children":38615},{"code":38614,"language":33977,"meta":8,"className":33978,"style":8},"\u003Cform action=\"{% url 'books:csv' %}\">\n  \u003Ca\n    class=\"btn btn-primary\"\n    data-toggle=\"collapse\"\n    href=\"#collapseExample\"\n    aria-expanded=\"false\"\n    aria-controls=\"collapseExample\"\n  >\n    Filter Books\n  \u003C/a>\n  \u003Cinput\n    type=\"submit\"\n    class=\"btn btn-info\"\n    form=\"id_query_form\"\n    formaction=\"{% url 'books:csv' %}\"\n    value=\"Export CSV\"\n  />\n  \u003Cinput\n    type=\"submit\"\n    class=\"btn btn-default\"\n    form=\"id_query_form\"\n    formaction=\"{% url 'books:xls' %}\"\n    value=\"Export XLS\"\n  />\n\u003C/form>\n\n\u003Cform method=\"get\" action=\".\" id=\"id_query_form\">\n  \u003Cp>{{ form.keywords }}\u003C/p>\n  \u003Cdiv class=\"row\">\n    \u003Cdiv class=\"col-md-6\">{{ form.publish_date_before }}\u003C/div>\n    \u003Cdiv class=\"col-md-6\">{{ form.publish_date_after }}\u003C/div>\n  \u003C/div>\n\n  \u003Cp>\u003C/p>\n  \u003Cp>\n    \u003Cinput class=\"btn btn-success\" type=\"submit\" />\n    \u003Cbutton type=\"reset\" class=\"btn btn-info\" value=\"Reset filters\">\n      Reset filters\n    \u003C/button>\n    \u003Cbutton\n      type=\"reset\"\n      class=\"btn btn-warning\"\n      id=\"id_clear_filters\"\n      onclick=\"return resetForm(this.form);\"\n    >\n      Clear Filters\n    \u003C/button>\n  \u003C/p>\n\u003C/form>\n",[38616],{"type":49,"tag":326,"props":38617,"children":38618},{"__ignoreMap":8},[38619,38647,38658,38675,38692,38709,38726,38743,38750,38758,38773,38785,38802,38818,38835,38852,38869,38877,38888,38903,38919,38934,38950,38966,38973,38988,38995,39049,39073,39101,39138,39174,39189,39196,39220,39235,39275,39330,39338,39354,39366,39383,39400,39417,39464,39472,39480,39495,39510],{"type":49,"tag":1060,"props":38620,"children":38621},{"class":1062,"line":1063},[38622,38626,38630,38634,38638,38643],{"type":49,"tag":1060,"props":38623,"children":38624},{"style":1073},[38625],{"type":55,"value":5197},{"type":49,"tag":1060,"props":38627,"children":38628},{"style":3839},[38629],{"type":55,"value":35525},{"type":49,"tag":1060,"props":38631,"children":38632},{"style":1067},[38633],{"type":55,"value":35544},{"type":49,"tag":1060,"props":38635,"children":38636},{"style":1073},[38637],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38639,"children":38640},{"style":2215},[38641],{"type":55,"value":38642},"\"{% url 'books:csv' %}\"",{"type":49,"tag":1060,"props":38644,"children":38645},{"style":1073},[38646],{"type":55,"value":33998},{"type":49,"tag":1060,"props":38648,"children":38649},{"class":1062,"line":1079},[38650,38654],{"type":49,"tag":1060,"props":38651,"children":38652},{"style":1073},[38653],{"type":55,"value":35573},{"type":49,"tag":1060,"props":38655,"children":38656},{"style":3839},[38657],{"type":55,"value":36586},{"type":49,"tag":1060,"props":38659,"children":38660},{"class":1062,"line":1088},[38661,38666,38670],{"type":49,"tag":1060,"props":38662,"children":38663},{"style":1067},[38664],{"type":55,"value":38665},"    class",{"type":49,"tag":1060,"props":38667,"children":38668},{"style":1073},[38669],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38671,"children":38672},{"style":2215},[38673],{"type":55,"value":38674},"\"btn btn-primary\"\n",{"type":49,"tag":1060,"props":38676,"children":38677},{"class":1062,"line":1097},[38678,38683,38687],{"type":49,"tag":1060,"props":38679,"children":38680},{"style":1067},[38681],{"type":55,"value":38682},"    data-toggle",{"type":49,"tag":1060,"props":38684,"children":38685},{"style":1073},[38686],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38688,"children":38689},{"style":2215},[38690],{"type":55,"value":38691},"\"collapse\"\n",{"type":49,"tag":1060,"props":38693,"children":38694},{"class":1062,"line":1111},[38695,38700,38704],{"type":49,"tag":1060,"props":38696,"children":38697},{"style":1067},[38698],{"type":55,"value":38699},"    href",{"type":49,"tag":1060,"props":38701,"children":38702},{"style":1073},[38703],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38705,"children":38706},{"style":2215},[38707],{"type":55,"value":38708},"\"#collapseExample\"\n",{"type":49,"tag":1060,"props":38710,"children":38711},{"class":1062,"line":1120},[38712,38717,38721],{"type":49,"tag":1060,"props":38713,"children":38714},{"style":1067},[38715],{"type":55,"value":38716},"    aria-expanded",{"type":49,"tag":1060,"props":38718,"children":38719},{"style":1073},[38720],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38722,"children":38723},{"style":2215},[38724],{"type":55,"value":38725},"\"false\"\n",{"type":49,"tag":1060,"props":38727,"children":38728},{"class":1062,"line":1128},[38729,38734,38738],{"type":49,"tag":1060,"props":38730,"children":38731},{"style":1067},[38732],{"type":55,"value":38733},"    aria-controls",{"type":49,"tag":1060,"props":38735,"children":38736},{"style":1073},[38737],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38739,"children":38740},{"style":2215},[38741],{"type":55,"value":38742},"\"collapseExample\"\n",{"type":49,"tag":1060,"props":38744,"children":38745},{"class":1062,"line":1141},[38746],{"type":49,"tag":1060,"props":38747,"children":38748},{"style":1073},[38749],{"type":55,"value":36594},{"type":49,"tag":1060,"props":38751,"children":38752},{"class":1062,"line":1150},[38753],{"type":49,"tag":1060,"props":38754,"children":38755},{"style":1073},[38756],{"type":55,"value":38757},"    Filter Books\n",{"type":49,"tag":1060,"props":38759,"children":38760},{"class":1062,"line":1158},[38761,38765,38769],{"type":49,"tag":1060,"props":38762,"children":38763},{"style":1073},[38764],{"type":55,"value":35717},{"type":49,"tag":1060,"props":38766,"children":38767},{"style":3839},[38768],{"type":55,"value":80},{"type":49,"tag":1060,"props":38770,"children":38771},{"style":1073},[38772],{"type":55,"value":33998},{"type":49,"tag":1060,"props":38774,"children":38775},{"class":1062,"line":1171},[38776,38780],{"type":49,"tag":1060,"props":38777,"children":38778},{"style":1073},[38779],{"type":55,"value":35573},{"type":49,"tag":1060,"props":38781,"children":38782},{"style":3839},[38783],{"type":55,"value":38784},"input\n",{"type":49,"tag":1060,"props":38786,"children":38787},{"class":1062,"line":1180},[38788,38793,38797],{"type":49,"tag":1060,"props":38789,"children":38790},{"style":1067},[38791],{"type":55,"value":38792},"    type",{"type":49,"tag":1060,"props":38794,"children":38795},{"style":1073},[38796],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38798,"children":38799},{"style":2215},[38800],{"type":55,"value":38801},"\"submit\"\n",{"type":49,"tag":1060,"props":38803,"children":38804},{"class":1062,"line":1188},[38805,38809,38813],{"type":49,"tag":1060,"props":38806,"children":38807},{"style":1067},[38808],{"type":55,"value":38665},{"type":49,"tag":1060,"props":38810,"children":38811},{"style":1073},[38812],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38814,"children":38815},{"style":2215},[38816],{"type":55,"value":38817},"\"btn btn-info\"\n",{"type":49,"tag":1060,"props":38819,"children":38820},{"class":1062,"line":1201},[38821,38826,38830],{"type":49,"tag":1060,"props":38822,"children":38823},{"style":1067},[38824],{"type":55,"value":38825},"    form",{"type":49,"tag":1060,"props":38827,"children":38828},{"style":1073},[38829],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38831,"children":38832},{"style":2215},[38833],{"type":55,"value":38834},"\"id_query_form\"\n",{"type":49,"tag":1060,"props":38836,"children":38837},{"class":1062,"line":1210},[38838,38843,38847],{"type":49,"tag":1060,"props":38839,"children":38840},{"style":1067},[38841],{"type":55,"value":38842},"    formaction",{"type":49,"tag":1060,"props":38844,"children":38845},{"style":1073},[38846],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38848,"children":38849},{"style":2215},[38850],{"type":55,"value":38851},"\"{% url 'books:csv' %}\"\n",{"type":49,"tag":1060,"props":38853,"children":38854},{"class":1062,"line":1218},[38855,38860,38864],{"type":49,"tag":1060,"props":38856,"children":38857},{"style":1067},[38858],{"type":55,"value":38859},"    value",{"type":49,"tag":1060,"props":38861,"children":38862},{"style":1073},[38863],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38865,"children":38866},{"style":2215},[38867],{"type":55,"value":38868},"\"Export CSV\"\n",{"type":49,"tag":1060,"props":38870,"children":38871},{"class":1062,"line":1232},[38872],{"type":49,"tag":1060,"props":38873,"children":38874},{"style":1073},[38875],{"type":55,"value":38876},"  />\n",{"type":49,"tag":1060,"props":38878,"children":38879},{"class":1062,"line":1241},[38880,38884],{"type":49,"tag":1060,"props":38881,"children":38882},{"style":1073},[38883],{"type":55,"value":35573},{"type":49,"tag":1060,"props":38885,"children":38886},{"style":3839},[38887],{"type":55,"value":38784},{"type":49,"tag":1060,"props":38889,"children":38890},{"class":1062,"line":1249},[38891,38895,38899],{"type":49,"tag":1060,"props":38892,"children":38893},{"style":1067},[38894],{"type":55,"value":38792},{"type":49,"tag":1060,"props":38896,"children":38897},{"style":1073},[38898],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38900,"children":38901},{"style":2215},[38902],{"type":55,"value":38801},{"type":49,"tag":1060,"props":38904,"children":38905},{"class":1062,"line":1262},[38906,38910,38914],{"type":49,"tag":1060,"props":38907,"children":38908},{"style":1067},[38909],{"type":55,"value":38665},{"type":49,"tag":1060,"props":38911,"children":38912},{"style":1073},[38913],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38915,"children":38916},{"style":2215},[38917],{"type":55,"value":38918},"\"btn btn-default\"\n",{"type":49,"tag":1060,"props":38920,"children":38921},{"class":1062,"line":4581},[38922,38926,38930],{"type":49,"tag":1060,"props":38923,"children":38924},{"style":1067},[38925],{"type":55,"value":38825},{"type":49,"tag":1060,"props":38927,"children":38928},{"style":1073},[38929],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38931,"children":38932},{"style":2215},[38933],{"type":55,"value":38834},{"type":49,"tag":1060,"props":38935,"children":38936},{"class":1062,"line":4631},[38937,38941,38945],{"type":49,"tag":1060,"props":38938,"children":38939},{"style":1067},[38940],{"type":55,"value":38842},{"type":49,"tag":1060,"props":38942,"children":38943},{"style":1073},[38944],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38946,"children":38947},{"style":2215},[38948],{"type":55,"value":38949},"\"{% url 'books:xls' %}\"\n",{"type":49,"tag":1060,"props":38951,"children":38952},{"class":1062,"line":4682},[38953,38957,38961],{"type":49,"tag":1060,"props":38954,"children":38955},{"style":1067},[38956],{"type":55,"value":38859},{"type":49,"tag":1060,"props":38958,"children":38959},{"style":1073},[38960],{"type":55,"value":3068},{"type":49,"tag":1060,"props":38962,"children":38963},{"style":2215},[38964],{"type":55,"value":38965},"\"Export XLS\"\n",{"type":49,"tag":1060,"props":38967,"children":38968},{"class":1062,"line":4709},[38969],{"type":49,"tag":1060,"props":38970,"children":38971},{"style":1073},[38972],{"type":55,"value":38876},{"type":49,"tag":1060,"props":38974,"children":38975},{"class":1062,"line":5979},[38976,38980,38984],{"type":49,"tag":1060,"props":38977,"children":38978},{"style":1073},[38979],{"type":55,"value":35084},{"type":49,"tag":1060,"props":38981,"children":38982},{"style":3839},[38983],{"type":55,"value":35525},{"type":49,"tag":1060,"props":38985,"children":38986},{"style":1073},[38987],{"type":55,"value":33998},{"type":49,"tag":1060,"props":38989,"children":38990},{"class":1062,"line":5988},[38991],{"type":49,"tag":1060,"props":38992,"children":38993},{"emptyLinePlaceholder":44},[38994],{"type":55,"value":1094},{"type":49,"tag":1060,"props":38996,"children":38997},{"class":1062,"line":5997},[38998,39002,39006,39010,39014,39019,39023,39027,39031,39036,39040,39045],{"type":49,"tag":1060,"props":38999,"children":39000},{"style":1073},[39001],{"type":55,"value":5197},{"type":49,"tag":1060,"props":39003,"children":39004},{"style":3839},[39005],{"type":55,"value":35525},{"type":49,"tag":1060,"props":39007,"children":39008},{"style":1067},[39009],{"type":55,"value":35530},{"type":49,"tag":1060,"props":39011,"children":39012},{"style":1073},[39013],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39015,"children":39016},{"style":2215},[39017],{"type":55,"value":39018},"\"get\"",{"type":49,"tag":1060,"props":39020,"children":39021},{"style":1067},[39022],{"type":55,"value":35544},{"type":49,"tag":1060,"props":39024,"children":39025},{"style":1073},[39026],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39028,"children":39029},{"style":2215},[39030],{"type":55,"value":35553},{"type":49,"tag":1060,"props":39032,"children":39033},{"style":1067},[39034],{"type":55,"value":39035}," id",{"type":49,"tag":1060,"props":39037,"children":39038},{"style":1073},[39039],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39041,"children":39042},{"style":2215},[39043],{"type":55,"value":39044},"\"id_query_form\"",{"type":49,"tag":1060,"props":39046,"children":39047},{"style":1073},[39048],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39050,"children":39051},{"class":1062,"line":6006},[39052,39056,39060,39065,39069],{"type":49,"tag":1060,"props":39053,"children":39054},{"style":1073},[39055],{"type":55,"value":35573},{"type":49,"tag":1060,"props":39057,"children":39058},{"style":3839},[39059],{"type":55,"value":58},{"type":49,"tag":1060,"props":39061,"children":39062},{"style":1073},[39063],{"type":55,"value":39064},">{{ form.keywords }}\u003C/",{"type":49,"tag":1060,"props":39066,"children":39067},{"style":3839},[39068],{"type":55,"value":58},{"type":49,"tag":1060,"props":39070,"children":39071},{"style":1073},[39072],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39074,"children":39075},{"class":1062,"line":10142},[39076,39080,39084,39088,39092,39097],{"type":49,"tag":1060,"props":39077,"children":39078},{"style":1073},[39079],{"type":55,"value":35573},{"type":49,"tag":1060,"props":39081,"children":39082},{"style":3839},[39083],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39085,"children":39086},{"style":1067},[39087],{"type":55,"value":35641},{"type":49,"tag":1060,"props":39089,"children":39090},{"style":1073},[39091],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39093,"children":39094},{"style":2215},[39095],{"type":55,"value":39096},"\"row\"",{"type":49,"tag":1060,"props":39098,"children":39099},{"style":1073},[39100],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39102,"children":39103},{"class":1062,"line":10151},[39104,39108,39112,39116,39120,39125,39130,39134],{"type":49,"tag":1060,"props":39105,"children":39106},{"style":1073},[39107],{"type":55,"value":35662},{"type":49,"tag":1060,"props":39109,"children":39110},{"style":3839},[39111],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39113,"children":39114},{"style":1067},[39115],{"type":55,"value":35641},{"type":49,"tag":1060,"props":39117,"children":39118},{"style":1073},[39119],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39121,"children":39122},{"style":2215},[39123],{"type":55,"value":39124},"\"col-md-6\"",{"type":49,"tag":1060,"props":39126,"children":39127},{"style":1073},[39128],{"type":55,"value":39129},">{{ form.publish_date_before }}\u003C/",{"type":49,"tag":1060,"props":39131,"children":39132},{"style":3839},[39133],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39135,"children":39136},{"style":1073},[39137],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39139,"children":39140},{"class":1062,"line":10160},[39141,39145,39149,39153,39157,39161,39166,39170],{"type":49,"tag":1060,"props":39142,"children":39143},{"style":1073},[39144],{"type":55,"value":35662},{"type":49,"tag":1060,"props":39146,"children":39147},{"style":3839},[39148],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39150,"children":39151},{"style":1067},[39152],{"type":55,"value":35641},{"type":49,"tag":1060,"props":39154,"children":39155},{"style":1073},[39156],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39158,"children":39159},{"style":2215},[39160],{"type":55,"value":39124},{"type":49,"tag":1060,"props":39162,"children":39163},{"style":1073},[39164],{"type":55,"value":39165},">{{ form.publish_date_after }}\u003C/",{"type":49,"tag":1060,"props":39167,"children":39168},{"style":3839},[39169],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39171,"children":39172},{"style":1073},[39173],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39175,"children":39176},{"class":1062,"line":10188},[39177,39181,39185],{"type":49,"tag":1060,"props":39178,"children":39179},{"style":1073},[39180],{"type":55,"value":35717},{"type":49,"tag":1060,"props":39182,"children":39183},{"style":3839},[39184],{"type":55,"value":35636},{"type":49,"tag":1060,"props":39186,"children":39187},{"style":1073},[39188],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39190,"children":39191},{"class":1062,"line":10196},[39192],{"type":49,"tag":1060,"props":39193,"children":39194},{"emptyLinePlaceholder":44},[39195],{"type":55,"value":1094},{"type":49,"tag":1060,"props":39197,"children":39198},{"class":1062,"line":10205},[39199,39203,39207,39212,39216],{"type":49,"tag":1060,"props":39200,"children":39201},{"style":1073},[39202],{"type":55,"value":35573},{"type":49,"tag":1060,"props":39204,"children":39205},{"style":3839},[39206],{"type":55,"value":58},{"type":49,"tag":1060,"props":39208,"children":39209},{"style":1073},[39210],{"type":55,"value":39211},">\u003C/",{"type":49,"tag":1060,"props":39213,"children":39214},{"style":3839},[39215],{"type":55,"value":58},{"type":49,"tag":1060,"props":39217,"children":39218},{"style":1073},[39219],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39221,"children":39222},{"class":1062,"line":10242},[39223,39227,39231],{"type":49,"tag":1060,"props":39224,"children":39225},{"style":1073},[39226],{"type":55,"value":35573},{"type":49,"tag":1060,"props":39228,"children":39229},{"style":3839},[39230],{"type":55,"value":58},{"type":49,"tag":1060,"props":39232,"children":39233},{"style":1073},[39234],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39236,"children":39237},{"class":1062,"line":10261},[39238,39242,39246,39250,39254,39259,39263,39267,39271],{"type":49,"tag":1060,"props":39239,"children":39240},{"style":1073},[39241],{"type":55,"value":35662},{"type":49,"tag":1060,"props":39243,"children":39244},{"style":3839},[39245],{"type":55,"value":7449},{"type":49,"tag":1060,"props":39247,"children":39248},{"style":1067},[39249],{"type":55,"value":35641},{"type":49,"tag":1060,"props":39251,"children":39252},{"style":1073},[39253],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39255,"children":39256},{"style":2215},[39257],{"type":55,"value":39258},"\"btn btn-success\"",{"type":49,"tag":1060,"props":39260,"children":39261},{"style":1067},[39262],{"type":55,"value":35582},{"type":49,"tag":1060,"props":39264,"children":39265},{"style":1073},[39266],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39268,"children":39269},{"style":2215},[39270],{"type":55,"value":35692},{"type":49,"tag":1060,"props":39272,"children":39273},{"style":1073},[39274],{"type":55,"value":35624},{"type":49,"tag":1060,"props":39276,"children":39277},{"class":1062,"line":10270},[39278,39282,39287,39291,39295,39300,39304,39308,39313,39317,39321,39326],{"type":49,"tag":1060,"props":39279,"children":39280},{"style":1073},[39281],{"type":55,"value":35662},{"type":49,"tag":1060,"props":39283,"children":39284},{"style":3839},[39285],{"type":55,"value":39286},"button",{"type":49,"tag":1060,"props":39288,"children":39289},{"style":1067},[39290],{"type":55,"value":35582},{"type":49,"tag":1060,"props":39292,"children":39293},{"style":1073},[39294],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39296,"children":39297},{"style":2215},[39298],{"type":55,"value":39299},"\"reset\"",{"type":49,"tag":1060,"props":39301,"children":39302},{"style":1067},[39303],{"type":55,"value":35641},{"type":49,"tag":1060,"props":39305,"children":39306},{"style":1073},[39307],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39309,"children":39310},{"style":2215},[39311],{"type":55,"value":39312},"\"btn btn-info\"",{"type":49,"tag":1060,"props":39314,"children":39315},{"style":1067},[39316],{"type":55,"value":35596},{"type":49,"tag":1060,"props":39318,"children":39319},{"style":1073},[39320],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39322,"children":39323},{"style":2215},[39324],{"type":55,"value":39325},"\"Reset filters\"",{"type":49,"tag":1060,"props":39327,"children":39328},{"style":1073},[39329],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39331,"children":39332},{"class":1062,"line":10278},[39333],{"type":49,"tag":1060,"props":39334,"children":39335},{"style":1073},[39336],{"type":55,"value":39337},"      Reset filters\n",{"type":49,"tag":1060,"props":39339,"children":39340},{"class":1062,"line":10287},[39341,39346,39350],{"type":49,"tag":1060,"props":39342,"children":39343},{"style":1073},[39344],{"type":55,"value":39345},"    \u003C/",{"type":49,"tag":1060,"props":39347,"children":39348},{"style":3839},[39349],{"type":55,"value":39286},{"type":49,"tag":1060,"props":39351,"children":39352},{"style":1073},[39353],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39355,"children":39356},{"class":1062,"line":10319},[39357,39361],{"type":49,"tag":1060,"props":39358,"children":39359},{"style":1073},[39360],{"type":55,"value":35662},{"type":49,"tag":1060,"props":39362,"children":39363},{"style":3839},[39364],{"type":55,"value":39365},"button\n",{"type":49,"tag":1060,"props":39367,"children":39368},{"class":1062,"line":10332},[39369,39374,39378],{"type":49,"tag":1060,"props":39370,"children":39371},{"style":1067},[39372],{"type":55,"value":39373},"      type",{"type":49,"tag":1060,"props":39375,"children":39376},{"style":1073},[39377],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39379,"children":39380},{"style":2215},[39381],{"type":55,"value":39382},"\"reset\"\n",{"type":49,"tag":1060,"props":39384,"children":39385},{"class":1062,"line":10356},[39386,39391,39395],{"type":49,"tag":1060,"props":39387,"children":39388},{"style":1067},[39389],{"type":55,"value":39390},"      class",{"type":49,"tag":1060,"props":39392,"children":39393},{"style":1073},[39394],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39396,"children":39397},{"style":2215},[39398],{"type":55,"value":39399},"\"btn btn-warning\"\n",{"type":49,"tag":1060,"props":39401,"children":39402},{"class":1062,"line":10364},[39403,39408,39412],{"type":49,"tag":1060,"props":39404,"children":39405},{"style":1067},[39406],{"type":55,"value":39407},"      id",{"type":49,"tag":1060,"props":39409,"children":39410},{"style":1073},[39411],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39413,"children":39414},{"style":2215},[39415],{"type":55,"value":39416},"\"id_clear_filters\"\n",{"type":49,"tag":1060,"props":39418,"children":39419},{"class":1062,"line":10373},[39420,39425,39429,39433,39438,39443,39447,39451,39455,39459],{"type":49,"tag":1060,"props":39421,"children":39422},{"style":1067},[39423],{"type":55,"value":39424},"      onclick",{"type":49,"tag":1060,"props":39426,"children":39427},{"style":1073},[39428],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39430,"children":39431},{"style":2215},[39432],{"type":55,"value":10005},{"type":49,"tag":1060,"props":39434,"children":39435},{"style":2194},[39436],{"type":55,"value":39437},"return",{"type":49,"tag":1060,"props":39439,"children":39440},{"style":1067},[39441],{"type":55,"value":39442}," resetForm",{"type":49,"tag":1060,"props":39444,"children":39445},{"style":2215},[39446],{"type":55,"value":2284},{"type":49,"tag":1060,"props":39448,"children":39449},{"style":3797},[39450],{"type":55,"value":4165},{"type":49,"tag":1060,"props":39452,"children":39453},{"style":2215},[39454],{"type":55,"value":745},{"type":49,"tag":1060,"props":39456,"children":39457},{"style":1073},[39458],{"type":55,"value":35525},{"type":49,"tag":1060,"props":39460,"children":39461},{"style":2215},[39462],{"type":55,"value":39463},");\"\n",{"type":49,"tag":1060,"props":39465,"children":39466},{"class":1062,"line":10395},[39467],{"type":49,"tag":1060,"props":39468,"children":39469},{"style":1073},[39470],{"type":55,"value":39471},"    >\n",{"type":49,"tag":1060,"props":39473,"children":39474},{"class":1062,"line":10403},[39475],{"type":49,"tag":1060,"props":39476,"children":39477},{"style":1073},[39478],{"type":55,"value":39479},"      Clear Filters\n",{"type":49,"tag":1060,"props":39481,"children":39482},{"class":1062,"line":10412},[39483,39487,39491],{"type":49,"tag":1060,"props":39484,"children":39485},{"style":1073},[39486],{"type":55,"value":39345},{"type":49,"tag":1060,"props":39488,"children":39489},{"style":3839},[39490],{"type":55,"value":39286},{"type":49,"tag":1060,"props":39492,"children":39493},{"style":1073},[39494],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39496,"children":39497},{"class":1062,"line":10438},[39498,39502,39506],{"type":49,"tag":1060,"props":39499,"children":39500},{"style":1073},[39501],{"type":55,"value":35717},{"type":49,"tag":1060,"props":39503,"children":39504},{"style":3839},[39505],{"type":55,"value":58},{"type":49,"tag":1060,"props":39507,"children":39508},{"style":1073},[39509],{"type":55,"value":33998},{"type":49,"tag":1060,"props":39511,"children":39512},{"class":1062,"line":10455},[39513,39517,39521],{"type":49,"tag":1060,"props":39514,"children":39515},{"style":1073},[39516],{"type":55,"value":35084},{"type":49,"tag":1060,"props":39518,"children":39519},{"style":3839},[39520],{"type":55,"value":35525},{"type":49,"tag":1060,"props":39522,"children":39523},{"style":1073},[39524],{"type":55,"value":33998},{"type":49,"tag":58,"props":39526,"children":39527},{},[39528],{"type":55,"value":32931},{"type":49,"tag":58,"props":39530,"children":39531},{},[39532,39534,39539,39541,39547,39549,39555,39557,39563],{"type":55,"value":39533},"There are two forms here, but the first form has an ",{"type":49,"tag":326,"props":39535,"children":39537},{"className":39536},[],[39538],{"type":55,"value":7449},{"type":55,"value":39540}," of ",{"type":49,"tag":326,"props":39542,"children":39544},{"className":39543},[],[39545],{"type":55,"value":39546},"type=submit",{"type":55,"value":39548}," that references another form with ",{"type":49,"tag":326,"props":39550,"children":39552},{"className":39551},[],[39553],{"type":55,"value":39554},"form=\"id_query_form\"",{"type":55,"value":39556},", and this button's action is the url for the ",{"type":49,"tag":326,"props":39558,"children":39560},{"className":39559},[],[39561],{"type":55,"value":39562},"export_filtered_books_csv",{"type":55,"value":39564}," function shown above.",{"type":49,"tag":58,"props":39566,"children":39567},{},[39568,39570,39576,39578,39583],{"type":55,"value":39569},"For the filter function, I make a ",{"type":49,"tag":326,"props":39571,"children":39573},{"className":39572},[],[39574],{"type":55,"value":39575},"utils",{"type":55,"value":39577}," folder in the app I am working with, so the directory structure looks like this (for the ",{"type":49,"tag":326,"props":39579,"children":39581},{"className":39580},[],[39582],{"type":55,"value":33186},{"type":55,"value":39584}," app):",{"type":49,"tag":1050,"props":39586,"children":39588},{"code":39587},".\nâââ admin.py\nâââ apps.py\nâââ forms.py\nâââ __init__.py\nâââ migrations\nâÂ Â  âââ 0001_initial.py\nâÂ Â  âââ 0002_book_authors.py\nâÂ Â  âââ __init__.py\nâââ models.py\nâââ templates\nâÂ Â  âââ books\nâââ tests.py\nâââ urls.py\nâââ utils\nâÂ Â  âââ filter.py\nâÂ Â  âââ __init__.py\nâÂ Â  âââ nearby.py\nâââ views.py\n",[39589],{"type":49,"tag":326,"props":39590,"children":39591},{"__ignoreMap":8},[39592],{"type":55,"value":39587},{"type":49,"tag":58,"props":39594,"children":39595},{},[39596,39598,39604,39605,39611,39612,39618],{"type":55,"value":39597},"I initially had a litte bit of confusion on how to write a simple search query. I wanted a user to be able to enter terms that would return a query set where the items in the query set contained at least on of the terms in at least on of a few different fields (",{"type":49,"tag":326,"props":39599,"children":39601},{"className":39600},[],[39602],{"type":55,"value":39603},"title",{"type":55,"value":873},{"type":49,"tag":326,"props":39606,"children":39608},{"className":39607},[],[39609],{"type":55,"value":39610},"synopsis",{"type":55,"value":873},{"type":49,"tag":326,"props":39613,"children":39615},{"className":39614},[],[39616],{"type":55,"value":39617},"website",{"type":55,"value":3213},{"type":49,"tag":58,"props":39620,"children":39621},{},[39622],{"type":55,"value":39623},"To make this filter, I found a nice idiomatic pattern:",{"type":49,"tag":1050,"props":39625,"children":39627},{"code":39626,"language":28337,"meta":8,"className":28338,"style":8},"if paramDict['keywords'] != '':\n    kws = paramDict['keywords'].split()\n    q_lookups = [Q(title__icontains=kw) for kw in kws] + \\\n                [Q(synopsis__icontains=kw) for kw in kws] + \\\n                [Q(website__icontains=kw) for kw in kws]\n    filters = Q()\n    filters |= reduce(lambda x, y: x | y, q_lookups)\n    books = books.filter(filters)\n",[39628],{"type":49,"tag":326,"props":39629,"children":39630},{"__ignoreMap":8},[39631,39662,39686,39738,39782,39817,39833,39880],{"type":49,"tag":1060,"props":39632,"children":39633},{"class":1062,"line":1063},[39634,39638,39642,39646,39650,39654,39658],{"type":49,"tag":1060,"props":39635,"children":39636},{"style":2194},[39637],{"type":55,"value":24834},{"type":49,"tag":1060,"props":39639,"children":39640},{"style":1073},[39641],{"type":55,"value":37477},{"type":49,"tag":1060,"props":39643,"children":39644},{"style":2215},[39645],{"type":55,"value":37753},{"type":49,"tag":1060,"props":39647,"children":39648},{"style":1073},[39649],{"type":55,"value":22304},{"type":49,"tag":1060,"props":39651,"children":39652},{"style":2194},[39653],{"type":55,"value":35393},{"type":49,"tag":1060,"props":39655,"children":39656},{"style":2215},[39657],{"type":55,"value":37495},{"type":49,"tag":1060,"props":39659,"children":39660},{"style":1073},[39661],{"type":55,"value":6862},{"type":49,"tag":1060,"props":39663,"children":39664},{"class":1062,"line":1079},[39665,39670,39674,39678,39682],{"type":49,"tag":1060,"props":39666,"children":39667},{"style":1073},[39668],{"type":55,"value":39669},"    kws ",{"type":49,"tag":1060,"props":39671,"children":39672},{"style":2194},[39673],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39675,"children":39676},{"style":1073},[39677],{"type":55,"value":37477},{"type":49,"tag":1060,"props":39679,"children":39680},{"style":2215},[39681],{"type":55,"value":37753},{"type":49,"tag":1060,"props":39683,"children":39684},{"style":1073},[39685],{"type":55,"value":37794},{"type":49,"tag":1060,"props":39687,"children":39688},{"class":1062,"line":1088},[39689,39694,39698,39702,39706,39710,39714,39718,39722,39726,39730,39734],{"type":49,"tag":1060,"props":39690,"children":39691},{"style":1073},[39692],{"type":55,"value":39693},"    q_lookups ",{"type":49,"tag":1060,"props":39695,"children":39696},{"style":2194},[39697],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39699,"children":39700},{"style":1073},[39701],{"type":55,"value":37811},{"type":49,"tag":1060,"props":39703,"children":39704},{"style":22635},[39705],{"type":55,"value":37816},{"type":49,"tag":1060,"props":39707,"children":39708},{"style":2194},[39709],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39711,"children":39712},{"style":1073},[39713],{"type":55,"value":37825},{"type":49,"tag":1060,"props":39715,"children":39716},{"style":2194},[39717],{"type":55,"value":10063},{"type":49,"tag":1060,"props":39719,"children":39720},{"style":1073},[39721],{"type":55,"value":37834},{"type":49,"tag":1060,"props":39723,"children":39724},{"style":2194},[39725],{"type":55,"value":10073},{"type":49,"tag":1060,"props":39727,"children":39728},{"style":1073},[39729],{"type":55,"value":37843},{"type":49,"tag":1060,"props":39731,"children":39732},{"style":2194},[39733],{"type":55,"value":33901},{"type":49,"tag":1060,"props":39735,"children":39736},{"style":1073},[39737],{"type":55,"value":10239},{"type":49,"tag":1060,"props":39739,"children":39740},{"class":1062,"line":1097},[39741,39746,39750,39754,39758,39762,39766,39770,39774,39778],{"type":49,"tag":1060,"props":39742,"children":39743},{"style":1073},[39744],{"type":55,"value":39745},"                [Q(",{"type":49,"tag":1060,"props":39747,"children":39748},{"style":22635},[39749],{"type":55,"value":37864},{"type":49,"tag":1060,"props":39751,"children":39752},{"style":2194},[39753],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39755,"children":39756},{"style":1073},[39757],{"type":55,"value":37825},{"type":49,"tag":1060,"props":39759,"children":39760},{"style":2194},[39761],{"type":55,"value":10063},{"type":49,"tag":1060,"props":39763,"children":39764},{"style":1073},[39765],{"type":55,"value":37834},{"type":49,"tag":1060,"props":39767,"children":39768},{"style":2194},[39769],{"type":55,"value":10073},{"type":49,"tag":1060,"props":39771,"children":39772},{"style":1073},[39773],{"type":55,"value":37843},{"type":49,"tag":1060,"props":39775,"children":39776},{"style":2194},[39777],{"type":55,"value":33901},{"type":49,"tag":1060,"props":39779,"children":39780},{"style":1073},[39781],{"type":55,"value":10239},{"type":49,"tag":1060,"props":39783,"children":39784},{"class":1062,"line":1111},[39785,39789,39793,39797,39801,39805,39809,39813],{"type":49,"tag":1060,"props":39786,"children":39787},{"style":1073},[39788],{"type":55,"value":39745},{"type":49,"tag":1060,"props":39790,"children":39791},{"style":22635},[39792],{"type":55,"value":37908},{"type":49,"tag":1060,"props":39794,"children":39795},{"style":2194},[39796],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39798,"children":39799},{"style":1073},[39800],{"type":55,"value":37825},{"type":49,"tag":1060,"props":39802,"children":39803},{"style":2194},[39804],{"type":55,"value":10063},{"type":49,"tag":1060,"props":39806,"children":39807},{"style":1073},[39808],{"type":55,"value":37834},{"type":49,"tag":1060,"props":39810,"children":39811},{"style":2194},[39812],{"type":55,"value":10073},{"type":49,"tag":1060,"props":39814,"children":39815},{"style":1073},[39816],{"type":55,"value":37933},{"type":49,"tag":1060,"props":39818,"children":39819},{"class":1062,"line":1120},[39820,39825,39829],{"type":49,"tag":1060,"props":39821,"children":39822},{"style":1073},[39823],{"type":55,"value":39824},"    filters ",{"type":49,"tag":1060,"props":39826,"children":39827},{"style":2194},[39828],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39830,"children":39831},{"style":1073},[39832],{"type":55,"value":37950},{"type":49,"tag":1060,"props":39834,"children":39835},{"class":1062,"line":1128},[39836,39840,39844,39848,39852,39856,39860,39864,39868,39872,39876],{"type":49,"tag":1060,"props":39837,"children":39838},{"style":1073},[39839],{"type":55,"value":39824},{"type":49,"tag":1060,"props":39841,"children":39842},{"style":2194},[39843],{"type":55,"value":37962},{"type":49,"tag":1060,"props":39845,"children":39846},{"style":6686},[39847],{"type":55,"value":37967},{"type":49,"tag":1060,"props":39849,"children":39850},{"style":1073},[39851],{"type":55,"value":2284},{"type":49,"tag":1060,"props":39853,"children":39854},{"style":2182},[39855],{"type":55,"value":22048},{"type":49,"tag":1060,"props":39857,"children":39858},{"style":22226},[39859],{"type":55,"value":3588},{"type":49,"tag":1060,"props":39861,"children":39862},{"style":1073},[39863],{"type":55,"value":873},{"type":49,"tag":1060,"props":39865,"children":39866},{"style":22226},[39867],{"type":55,"value":37988},{"type":49,"tag":1060,"props":39869,"children":39870},{"style":1073},[39871],{"type":55,"value":37993},{"type":49,"tag":1060,"props":39873,"children":39874},{"style":2194},[39875],{"type":55,"value":10302},{"type":49,"tag":1060,"props":39877,"children":39878},{"style":1073},[39879],{"type":55,"value":38002},{"type":49,"tag":1060,"props":39881,"children":39882},{"class":1062,"line":1141},[39883,39887,39891],{"type":49,"tag":1060,"props":39884,"children":39885},{"style":1073},[39886],{"type":55,"value":33256},{"type":49,"tag":1060,"props":39888,"children":39889},{"style":2194},[39890],{"type":55,"value":3068},{"type":49,"tag":1060,"props":39892,"children":39893},{"style":1073},[39894],{"type":55,"value":38018},{"type":49,"tag":58,"props":39896,"children":39897},{},[39898],{"type":55,"value":39899},"This is good for a small database, but could end up having to do lots of operations, especially if I decided that I want to add more fields to be searched, such as category or tags.",{"type":49,"tag":58,"props":39901,"children":39902},{},[39903,39905,39911,39913,39919,39921,39926],{"type":55,"value":39904},"One option that I have considered to simplify the search query is to make one field called something like ",{"type":49,"tag":326,"props":39906,"children":39908},{"className":39907},[],[39909],{"type":55,"value":39910},"search_string",{"type":55,"value":39912},". This field would be modified on ",{"type":49,"tag":326,"props":39914,"children":39916},{"className":39915},[],[39917],{"type":55,"value":39918},"save",{"type":55,"value":39920},", and it would simply appends the text from all of the fields I'm interested in searching. Then, instead of doing Q lookups for each word over many different fields, I could search each word in ",{"type":49,"tag":326,"props":39922,"children":39924},{"className":39923},[],[39925],{"type":55,"value":37224},{"type":55,"value":39927}," over one field. I haven't implemented this here, but I would like to test this in the future.",{"type":49,"tag":50,"props":39929,"children":39931},{"id":39930},"finding-books-nearby",[39932],{"type":55,"value":39933},"Finding \"Books Nearby\"",{"type":49,"tag":58,"props":39935,"children":39936},{},[39937],{"type":55,"value":39938},"On the pages that show details for each book I wanted to add additional information. I thought it would be interesting to show the 5 books closest to the book we are currently showing. Since we are dealing with coordinate points on a globe, the best way to calculate distance between two points is to use the Halversine formula:",{"type":49,"tag":2910,"props":39940,"children":39941},{},[39942],{"type":49,"tag":58,"props":39943,"children":39944},{},[39945],{"type":55,"value":39946},"The haversine formula determines the great-circle distance between two points on a sphere given their longitudes and latitudes. Important in navigation, it is a special case of a more general formula in spherical trigonometry, the law of haversines, that relates the sides and angles of spherical triangles.",{"type":49,"tag":58,"props":39948,"children":39949},{},[39950],{"type":49,"tag":1601,"props":39951,"children":39953},{"alt":8926,"src":39952},"/static/great_circle.png",[],{"type":49,"tag":58,"props":39955,"children":39956},{},[39957],{"type":55,"value":39958},"Here's the code I used for calculating distance (using the Halversine formula):",{"type":49,"tag":1050,"props":39960,"children":39962},{"code":39961,"language":28337,"meta":8,"className":28338,"style":8},"from math import radians, cos, sin, asin, sqrt\n\ndef distance(origin, destination):\n    \"\"\"\n    Calculate the great circle distance between two points\n    on the earth (specified in decimal degrees)\n    \"\"\"\n\n    lon1, lat1 = origin\n    lon2, lat2 = destination\n    # convert decimal degrees to radians\n    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])\n    # haversine formula\n    dlon = lon2 - lon1\n    dlat = lat2 - lat1\n    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2\n    c = 2 * asin(sqrt(a))\n    r = 3956 # miles\n    return c * r\n",[39963],{"type":49,"tag":326,"props":39964,"children":39965},{"__ignoreMap":8},[39966,39987,39994,40028,40035,40043,40051,40058,40065,40082,40099,40107,40129,40137,40163,40189,40273,40300,40322],{"type":49,"tag":1060,"props":39967,"children":39968},{"class":1062,"line":1063},[39969,39973,39978,39982],{"type":49,"tag":1060,"props":39970,"children":39971},{"style":2194},[39972],{"type":55,"value":22184},{"type":49,"tag":1060,"props":39974,"children":39975},{"style":1073},[39976],{"type":55,"value":39977}," math ",{"type":49,"tag":1060,"props":39979,"children":39980},{"style":2194},[39981],{"type":55,"value":22194},{"type":49,"tag":1060,"props":39983,"children":39984},{"style":1073},[39985],{"type":55,"value":39986}," radians, cos, sin, asin, sqrt\n",{"type":49,"tag":1060,"props":39988,"children":39989},{"class":1062,"line":1079},[39990],{"type":49,"tag":1060,"props":39991,"children":39992},{"emptyLinePlaceholder":44},[39993],{"type":55,"value":1094},{"type":49,"tag":1060,"props":39995,"children":39996},{"class":1062,"line":1088},[39997,40001,40006,40010,40015,40019,40024],{"type":49,"tag":1060,"props":39998,"children":39999},{"style":2182},[40000],{"type":55,"value":22214},{"type":49,"tag":1060,"props":40002,"children":40003},{"style":1067},[40004],{"type":55,"value":40005}," distance",{"type":49,"tag":1060,"props":40007,"children":40008},{"style":1073},[40009],{"type":55,"value":2284},{"type":49,"tag":1060,"props":40011,"children":40012},{"style":22226},[40013],{"type":55,"value":40014},"origin",{"type":49,"tag":1060,"props":40016,"children":40017},{"style":1073},[40018],{"type":55,"value":873},{"type":49,"tag":1060,"props":40020,"children":40021},{"style":22226},[40022],{"type":55,"value":40023},"destination",{"type":49,"tag":1060,"props":40025,"children":40026},{"style":1073},[40027],{"type":55,"value":22242},{"type":49,"tag":1060,"props":40029,"children":40030},{"class":1062,"line":1097},[40031],{"type":49,"tag":1060,"props":40032,"children":40033},{"style":2215},[40034],{"type":55,"value":33233},{"type":49,"tag":1060,"props":40036,"children":40037},{"class":1062,"line":1111},[40038],{"type":49,"tag":1060,"props":40039,"children":40040},{"style":2215},[40041],{"type":55,"value":40042},"    Calculate the great circle distance between two points\n",{"type":49,"tag":1060,"props":40044,"children":40045},{"class":1062,"line":1120},[40046],{"type":49,"tag":1060,"props":40047,"children":40048},{"style":2215},[40049],{"type":55,"value":40050},"    on the earth (specified in decimal degrees)\n",{"type":49,"tag":1060,"props":40052,"children":40053},{"class":1062,"line":1128},[40054],{"type":49,"tag":1060,"props":40055,"children":40056},{"style":2215},[40057],{"type":55,"value":33233},{"type":49,"tag":1060,"props":40059,"children":40060},{"class":1062,"line":1141},[40061],{"type":49,"tag":1060,"props":40062,"children":40063},{"emptyLinePlaceholder":44},[40064],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40066,"children":40067},{"class":1062,"line":1150},[40068,40073,40077],{"type":49,"tag":1060,"props":40069,"children":40070},{"style":1073},[40071],{"type":55,"value":40072},"    lon1, lat1 ",{"type":49,"tag":1060,"props":40074,"children":40075},{"style":2194},[40076],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40078,"children":40079},{"style":1073},[40080],{"type":55,"value":40081}," origin\n",{"type":49,"tag":1060,"props":40083,"children":40084},{"class":1062,"line":1158},[40085,40090,40094],{"type":49,"tag":1060,"props":40086,"children":40087},{"style":1073},[40088],{"type":55,"value":40089},"    lon2, lat2 ",{"type":49,"tag":1060,"props":40091,"children":40092},{"style":2194},[40093],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40095,"children":40096},{"style":1073},[40097],{"type":55,"value":40098}," destination\n",{"type":49,"tag":1060,"props":40100,"children":40101},{"class":1062,"line":1171},[40102],{"type":49,"tag":1060,"props":40103,"children":40104},{"style":3039},[40105],{"type":55,"value":40106},"    # convert decimal degrees to radians\n",{"type":49,"tag":1060,"props":40108,"children":40109},{"class":1062,"line":1180},[40110,40115,40119,40124],{"type":49,"tag":1060,"props":40111,"children":40112},{"style":1073},[40113],{"type":55,"value":40114},"    lon1, lat1, lon2, lat2 ",{"type":49,"tag":1060,"props":40116,"children":40117},{"style":2194},[40118],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40120,"children":40121},{"style":9965},[40122],{"type":55,"value":40123}," map",{"type":49,"tag":1060,"props":40125,"children":40126},{"style":1073},[40127],{"type":55,"value":40128},"(radians, [lon1, lat1, lon2, lat2])\n",{"type":49,"tag":1060,"props":40130,"children":40131},{"class":1062,"line":1188},[40132],{"type":49,"tag":1060,"props":40133,"children":40134},{"style":3039},[40135],{"type":55,"value":40136},"    # haversine formula\n",{"type":49,"tag":1060,"props":40138,"children":40139},{"class":1062,"line":1201},[40140,40145,40149,40154,40158],{"type":49,"tag":1060,"props":40141,"children":40142},{"style":1073},[40143],{"type":55,"value":40144},"    dlon ",{"type":49,"tag":1060,"props":40146,"children":40147},{"style":2194},[40148],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40150,"children":40151},{"style":1073},[40152],{"type":55,"value":40153}," lon2 ",{"type":49,"tag":1060,"props":40155,"children":40156},{"style":2194},[40157],{"type":55,"value":10180},{"type":49,"tag":1060,"props":40159,"children":40160},{"style":1073},[40161],{"type":55,"value":40162}," lon1\n",{"type":49,"tag":1060,"props":40164,"children":40165},{"class":1062,"line":1210},[40166,40171,40175,40180,40184],{"type":49,"tag":1060,"props":40167,"children":40168},{"style":1073},[40169],{"type":55,"value":40170},"    dlat ",{"type":49,"tag":1060,"props":40172,"children":40173},{"style":2194},[40174],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40176,"children":40177},{"style":1073},[40178],{"type":55,"value":40179}," lat2 ",{"type":49,"tag":1060,"props":40181,"children":40182},{"style":2194},[40183],{"type":55,"value":10180},{"type":49,"tag":1060,"props":40185,"children":40186},{"style":1073},[40187],{"type":55,"value":40188}," lat1\n",{"type":49,"tag":1060,"props":40190,"children":40191},{"class":1062,"line":1218},[40192,40197,40201,40206,40210,40214,40218,40222,40226,40230,40235,40239,40244,40248,40253,40257,40261,40265,40269],{"type":49,"tag":1060,"props":40193,"children":40194},{"style":1073},[40195],{"type":55,"value":40196},"    a ",{"type":49,"tag":1060,"props":40198,"children":40199},{"style":2194},[40200],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40202,"children":40203},{"style":1073},[40204],{"type":55,"value":40205}," sin(dlat",{"type":49,"tag":1060,"props":40207,"children":40208},{"style":2194},[40209],{"type":55,"value":3744},{"type":49,"tag":1060,"props":40211,"children":40212},{"style":2287},[40213],{"type":55,"value":24195},{"type":49,"tag":1060,"props":40215,"children":40216},{"style":1073},[40217],{"type":55,"value":616},{"type":49,"tag":1060,"props":40219,"children":40220},{"style":2194},[40221],{"type":55,"value":23506},{"type":49,"tag":1060,"props":40223,"children":40224},{"style":2287},[40225],{"type":55,"value":24195},{"type":49,"tag":1060,"props":40227,"children":40228},{"style":2194},[40229],{"type":55,"value":33891},{"type":49,"tag":1060,"props":40231,"children":40232},{"style":1073},[40233],{"type":55,"value":40234}," cos(lat1) ",{"type":49,"tag":1060,"props":40236,"children":40237},{"style":2194},[40238],{"type":55,"value":22608},{"type":49,"tag":1060,"props":40240,"children":40241},{"style":1073},[40242],{"type":55,"value":40243}," cos(lat2) ",{"type":49,"tag":1060,"props":40245,"children":40246},{"style":2194},[40247],{"type":55,"value":22608},{"type":49,"tag":1060,"props":40249,"children":40250},{"style":1073},[40251],{"type":55,"value":40252}," sin(dlon",{"type":49,"tag":1060,"props":40254,"children":40255},{"style":2194},[40256],{"type":55,"value":3744},{"type":49,"tag":1060,"props":40258,"children":40259},{"style":2287},[40260],{"type":55,"value":24195},{"type":49,"tag":1060,"props":40262,"children":40263},{"style":1073},[40264],{"type":55,"value":616},{"type":49,"tag":1060,"props":40266,"children":40267},{"style":2194},[40268],{"type":55,"value":23506},{"type":49,"tag":1060,"props":40270,"children":40271},{"style":2287},[40272],{"type":55,"value":31358},{"type":49,"tag":1060,"props":40274,"children":40275},{"class":1062,"line":1232},[40276,40281,40285,40290,40295],{"type":49,"tag":1060,"props":40277,"children":40278},{"style":1073},[40279],{"type":55,"value":40280},"    c ",{"type":49,"tag":1060,"props":40282,"children":40283},{"style":2194},[40284],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40286,"children":40287},{"style":2287},[40288],{"type":55,"value":40289}," 2",{"type":49,"tag":1060,"props":40291,"children":40292},{"style":2194},[40293],{"type":55,"value":40294}," *",{"type":49,"tag":1060,"props":40296,"children":40297},{"style":1073},[40298],{"type":55,"value":40299}," asin(sqrt(a))\n",{"type":49,"tag":1060,"props":40301,"children":40302},{"class":1062,"line":1241},[40303,40308,40312,40317],{"type":49,"tag":1060,"props":40304,"children":40305},{"style":1073},[40306],{"type":55,"value":40307},"    r ",{"type":49,"tag":1060,"props":40309,"children":40310},{"style":2194},[40311],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40313,"children":40314},{"style":2287},[40315],{"type":55,"value":40316}," 3956",{"type":49,"tag":1060,"props":40318,"children":40319},{"style":3039},[40320],{"type":55,"value":40321}," # miles\n",{"type":49,"tag":1060,"props":40323,"children":40324},{"class":1062,"line":1249},[40325,40329,40334,40338],{"type":49,"tag":1060,"props":40326,"children":40327},{"style":2194},[40328],{"type":55,"value":25371},{"type":49,"tag":1060,"props":40330,"children":40331},{"style":1073},[40332],{"type":55,"value":40333}," c ",{"type":49,"tag":1060,"props":40335,"children":40336},{"style":2194},[40337],{"type":55,"value":22608},{"type":49,"tag":1060,"props":40339,"children":40340},{"style":1073},[40341],{"type":55,"value":40342}," r\n",{"type":49,"tag":58,"props":40344,"children":40345},{},[40346],{"type":55,"value":40347},"This formula assumes that the earth is a perfect sphere. Another approach would be to use the the Vincety Formula:",{"type":49,"tag":2910,"props":40349,"children":40350},{},[40351],{"type":49,"tag":58,"props":40352,"children":40353},{},[40354],{"type":55,"value":40355},"Vincenty's formulae are two related iterative methods used in geodesy to calculate the distance between two points on the surface of a spheroid, developed by Thaddeus Vincenty (1975a). They are based on the assumption that the figure of the Earth is an oblate spheroid, and hence are more accurate than methods that assume a spherical Earth, such as great-circle distance.",{"type":49,"tag":58,"props":40357,"children":40358},{},[40359,40361,40367],{"type":55,"value":40360},"This distance is packaged in ",{"type":49,"tag":326,"props":40362,"children":40364},{"className":40363},[],[40365],{"type":55,"value":40366},"geopy",{"type":55,"value":40368}," and can be calculated easily:",{"type":49,"tag":1050,"props":40370,"children":40372},{"code":40371,"language":28337,"meta":8,"className":28338,"style":8},"import geopy.distance\n\ncoords_1 = (52.2296756, 21.0122287)\ncoords_2 = (52.406374, 16.9251681)\n\nprint geopy.distance.vincenty(coords_1, coords_2).km\n",[40373],{"type":49,"tag":326,"props":40374,"children":40375},{"__ignoreMap":8},[40376,40388,40395,40429,40463,40470],{"type":49,"tag":1060,"props":40377,"children":40378},{"class":1062,"line":1063},[40379,40383],{"type":49,"tag":1060,"props":40380,"children":40381},{"style":2194},[40382],{"type":55,"value":22194},{"type":49,"tag":1060,"props":40384,"children":40385},{"style":1073},[40386],{"type":55,"value":40387}," geopy.distance\n",{"type":49,"tag":1060,"props":40389,"children":40390},{"class":1062,"line":1079},[40391],{"type":49,"tag":1060,"props":40392,"children":40393},{"emptyLinePlaceholder":44},[40394],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40396,"children":40397},{"class":1062,"line":1088},[40398,40403,40407,40411,40416,40420,40425],{"type":49,"tag":1060,"props":40399,"children":40400},{"style":1073},[40401],{"type":55,"value":40402},"coords_1 ",{"type":49,"tag":1060,"props":40404,"children":40405},{"style":2194},[40406],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40408,"children":40409},{"style":1073},[40410],{"type":55,"value":6234},{"type":49,"tag":1060,"props":40412,"children":40413},{"style":2287},[40414],{"type":55,"value":40415},"52.2296756",{"type":49,"tag":1060,"props":40417,"children":40418},{"style":1073},[40419],{"type":55,"value":873},{"type":49,"tag":1060,"props":40421,"children":40422},{"style":2287},[40423],{"type":55,"value":40424},"21.0122287",{"type":49,"tag":1060,"props":40426,"children":40427},{"style":1073},[40428],{"type":55,"value":5126},{"type":49,"tag":1060,"props":40430,"children":40431},{"class":1062,"line":1097},[40432,40437,40441,40445,40450,40454,40459],{"type":49,"tag":1060,"props":40433,"children":40434},{"style":1073},[40435],{"type":55,"value":40436},"coords_2 ",{"type":49,"tag":1060,"props":40438,"children":40439},{"style":2194},[40440],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40442,"children":40443},{"style":1073},[40444],{"type":55,"value":6234},{"type":49,"tag":1060,"props":40446,"children":40447},{"style":2287},[40448],{"type":55,"value":40449},"52.406374",{"type":49,"tag":1060,"props":40451,"children":40452},{"style":1073},[40453],{"type":55,"value":873},{"type":49,"tag":1060,"props":40455,"children":40456},{"style":2287},[40457],{"type":55,"value":40458},"16.9251681",{"type":49,"tag":1060,"props":40460,"children":40461},{"style":1073},[40462],{"type":55,"value":5126},{"type":49,"tag":1060,"props":40464,"children":40465},{"class":1062,"line":1111},[40466],{"type":49,"tag":1060,"props":40467,"children":40468},{"emptyLinePlaceholder":44},[40469],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40471,"children":40472},{"class":1062,"line":1120},[40473,40478],{"type":49,"tag":1060,"props":40474,"children":40475},{"style":9965},[40476],{"type":55,"value":40477},"print",{"type":49,"tag":1060,"props":40479,"children":40480},{"style":1073},[40481],{"type":55,"value":40482}," geopy.distance.vincenty(coords_1, coords_2).km\n",{"type":49,"tag":58,"props":40484,"children":40485},{},[40486,40488,40493],{"type":55,"value":40487},"Here's a look at the function I wrote for the ",{"type":49,"tag":326,"props":40489,"children":40491},{"className":40490},[],[40492],{"type":55,"value":36513},{"type":55,"value":40494}," view. I have commented out parts that aren't related to finding nearby books:",{"type":49,"tag":1050,"props":40496,"children":40498},{"code":40497,"language":28337,"meta":8,"className":28338,"style":8},"def book_detail(request, id, slug):\n\n    book = Book.objects.get(id=id, slug=slug)\n    b_coords = (book.lat, book.lon)\n    all_books = Book.objects.all()\n    coords = [((b.lat, b.lon),b) for b in all_books]\n\n    distance_dict = {}\n    for c in coords:\n        if c[0] != b_coords:\n            distance_dict[c[0]]=(distance(c[0],b_coords),c)\n\n    sorted_nearby = sorted(distance_dict.items(), key=lambda x: x[1][0])[:5]\n\n    # map_book = [{'loc':[float(book.lon), float(book.lat)],\n    #              'title':book.title,\n    #              'url':book.get_absolute_url()}]\n    context = {\n        'book':book,\n        # 'map_book':mark_safe(escapejs(json.dumps(map_book))),\n        'sorted_nearby':sorted_nearby,\n    }\n    return render(request, 'books/book_detail.html', context)\n",[40499],{"type":49,"tag":326,"props":40500,"children":40501},{"__ignoreMap":8},[40502,40543,40550,40596,40613,40629,40664,40671,40688,40708,40737,40772,40779,40849,40856,40864,40872,40880,40895,40908,40916,40929,40936],{"type":49,"tag":1060,"props":40503,"children":40504},{"class":1062,"line":1063},[40505,40509,40514,40518,40522,40526,40530,40534,40539],{"type":49,"tag":1060,"props":40506,"children":40507},{"style":2182},[40508],{"type":55,"value":22214},{"type":49,"tag":1060,"props":40510,"children":40511},{"style":1067},[40512],{"type":55,"value":40513}," book_detail",{"type":49,"tag":1060,"props":40515,"children":40516},{"style":1073},[40517],{"type":55,"value":2284},{"type":49,"tag":1060,"props":40519,"children":40520},{"style":22226},[40521],{"type":55,"value":33221},{"type":49,"tag":1060,"props":40523,"children":40524},{"style":1073},[40525],{"type":55,"value":873},{"type":49,"tag":1060,"props":40527,"children":40528},{"style":22226},[40529],{"type":55,"value":16428},{"type":49,"tag":1060,"props":40531,"children":40532},{"style":1073},[40533],{"type":55,"value":873},{"type":49,"tag":1060,"props":40535,"children":40536},{"style":22226},[40537],{"type":55,"value":40538},"slug",{"type":49,"tag":1060,"props":40540,"children":40541},{"style":1073},[40542],{"type":55,"value":22242},{"type":49,"tag":1060,"props":40544,"children":40545},{"class":1062,"line":1079},[40546],{"type":49,"tag":1060,"props":40547,"children":40548},{"emptyLinePlaceholder":44},[40549],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40551,"children":40552},{"class":1062,"line":1088},[40553,40558,40562,40567,40571,40575,40579,40583,40587,40591],{"type":49,"tag":1060,"props":40554,"children":40555},{"style":1073},[40556],{"type":55,"value":40557},"    book ",{"type":49,"tag":1060,"props":40559,"children":40560},{"style":2194},[40561],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40563,"children":40564},{"style":1073},[40565],{"type":55,"value":40566}," Book.objects.get(",{"type":49,"tag":1060,"props":40568,"children":40569},{"style":22635},[40570],{"type":55,"value":16428},{"type":49,"tag":1060,"props":40572,"children":40573},{"style":2194},[40574],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40576,"children":40577},{"style":9965},[40578],{"type":55,"value":16428},{"type":49,"tag":1060,"props":40580,"children":40581},{"style":1073},[40582],{"type":55,"value":873},{"type":49,"tag":1060,"props":40584,"children":40585},{"style":22635},[40586],{"type":55,"value":40538},{"type":49,"tag":1060,"props":40588,"children":40589},{"style":2194},[40590],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40592,"children":40593},{"style":1073},[40594],{"type":55,"value":40595},"slug)\n",{"type":49,"tag":1060,"props":40597,"children":40598},{"class":1062,"line":1097},[40599,40604,40608],{"type":49,"tag":1060,"props":40600,"children":40601},{"style":1073},[40602],{"type":55,"value":40603},"    b_coords ",{"type":49,"tag":1060,"props":40605,"children":40606},{"style":2194},[40607],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40609,"children":40610},{"style":1073},[40611],{"type":55,"value":40612}," (book.lat, book.lon)\n",{"type":49,"tag":1060,"props":40614,"children":40615},{"class":1062,"line":1111},[40616,40621,40625],{"type":49,"tag":1060,"props":40617,"children":40618},{"style":1073},[40619],{"type":55,"value":40620},"    all_books ",{"type":49,"tag":1060,"props":40622,"children":40623},{"style":2194},[40624],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40626,"children":40627},{"style":1073},[40628],{"type":55,"value":33265},{"type":49,"tag":1060,"props":40630,"children":40631},{"class":1062,"line":1120},[40632,40637,40641,40646,40650,40655,40659],{"type":49,"tag":1060,"props":40633,"children":40634},{"style":1073},[40635],{"type":55,"value":40636},"    coords ",{"type":49,"tag":1060,"props":40638,"children":40639},{"style":2194},[40640],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40642,"children":40643},{"style":1073},[40644],{"type":55,"value":40645}," [((b.lat, b.lon),b) ",{"type":49,"tag":1060,"props":40647,"children":40648},{"style":2194},[40649],{"type":55,"value":10063},{"type":49,"tag":1060,"props":40651,"children":40652},{"style":1073},[40653],{"type":55,"value":40654}," b ",{"type":49,"tag":1060,"props":40656,"children":40657},{"style":2194},[40658],{"type":55,"value":10073},{"type":49,"tag":1060,"props":40660,"children":40661},{"style":1073},[40662],{"type":55,"value":40663}," all_books]\n",{"type":49,"tag":1060,"props":40665,"children":40666},{"class":1062,"line":1128},[40667],{"type":49,"tag":1060,"props":40668,"children":40669},{"emptyLinePlaceholder":44},[40670],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40672,"children":40673},{"class":1062,"line":1141},[40674,40679,40683],{"type":49,"tag":1060,"props":40675,"children":40676},{"style":1073},[40677],{"type":55,"value":40678},"    distance_dict ",{"type":49,"tag":1060,"props":40680,"children":40681},{"style":2194},[40682],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40684,"children":40685},{"style":1073},[40686],{"type":55,"value":40687}," {}\n",{"type":49,"tag":1060,"props":40689,"children":40690},{"class":1062,"line":1150},[40691,40695,40699,40703],{"type":49,"tag":1060,"props":40692,"children":40693},{"style":2194},[40694],{"type":55,"value":34656},{"type":49,"tag":1060,"props":40696,"children":40697},{"style":1073},[40698],{"type":55,"value":40333},{"type":49,"tag":1060,"props":40700,"children":40701},{"style":2194},[40702],{"type":55,"value":10073},{"type":49,"tag":1060,"props":40704,"children":40705},{"style":1073},[40706],{"type":55,"value":40707}," coords:\n",{"type":49,"tag":1060,"props":40709,"children":40710},{"class":1062,"line":1158},[40711,40715,40720,40724,40728,40732],{"type":49,"tag":1060,"props":40712,"children":40713},{"style":2194},[40714],{"type":55,"value":29767},{"type":49,"tag":1060,"props":40716,"children":40717},{"style":1073},[40718],{"type":55,"value":40719}," c[",{"type":49,"tag":1060,"props":40721,"children":40722},{"style":2287},[40723],{"type":55,"value":8397},{"type":49,"tag":1060,"props":40725,"children":40726},{"style":1073},[40727],{"type":55,"value":22304},{"type":49,"tag":1060,"props":40729,"children":40730},{"style":2194},[40731],{"type":55,"value":35393},{"type":49,"tag":1060,"props":40733,"children":40734},{"style":1073},[40735],{"type":55,"value":40736}," b_coords:\n",{"type":49,"tag":1060,"props":40738,"children":40739},{"class":1062,"line":1171},[40740,40745,40749,40754,40758,40763,40767],{"type":49,"tag":1060,"props":40741,"children":40742},{"style":1073},[40743],{"type":55,"value":40744},"            distance_dict[c[",{"type":49,"tag":1060,"props":40746,"children":40747},{"style":2287},[40748],{"type":55,"value":8397},{"type":49,"tag":1060,"props":40750,"children":40751},{"style":1073},[40752],{"type":55,"value":40753},"]]",{"type":49,"tag":1060,"props":40755,"children":40756},{"style":2194},[40757],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40759,"children":40760},{"style":1073},[40761],{"type":55,"value":40762},"(distance(c[",{"type":49,"tag":1060,"props":40764,"children":40765},{"style":2287},[40766],{"type":55,"value":8397},{"type":49,"tag":1060,"props":40768,"children":40769},{"style":1073},[40770],{"type":55,"value":40771},"],b_coords),c)\n",{"type":49,"tag":1060,"props":40773,"children":40774},{"class":1062,"line":1180},[40775],{"type":49,"tag":1060,"props":40776,"children":40777},{"emptyLinePlaceholder":44},[40778],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40780,"children":40781},{"class":1062,"line":1188},[40782,40787,40791,40796,40801,40806,40810,40814,40818,40823,40827,40832,40836,40841,40845],{"type":49,"tag":1060,"props":40783,"children":40784},{"style":1073},[40785],{"type":55,"value":40786},"    sorted_nearby ",{"type":49,"tag":1060,"props":40788,"children":40789},{"style":2194},[40790],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40792,"children":40793},{"style":9965},[40794],{"type":55,"value":40795}," sorted",{"type":49,"tag":1060,"props":40797,"children":40798},{"style":1073},[40799],{"type":55,"value":40800},"(distance_dict.items(), ",{"type":49,"tag":1060,"props":40802,"children":40803},{"style":22635},[40804],{"type":55,"value":40805},"key",{"type":49,"tag":1060,"props":40807,"children":40808},{"style":2194},[40809],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40811,"children":40812},{"style":2182},[40813],{"type":55,"value":22048},{"type":49,"tag":1060,"props":40815,"children":40816},{"style":22226},[40817],{"type":55,"value":3588},{"type":49,"tag":1060,"props":40819,"children":40820},{"style":1073},[40821],{"type":55,"value":40822},": x[",{"type":49,"tag":1060,"props":40824,"children":40825},{"style":2287},[40826],{"type":55,"value":8405},{"type":49,"tag":1060,"props":40828,"children":40829},{"style":1073},[40830],{"type":55,"value":40831},"][",{"type":49,"tag":1060,"props":40833,"children":40834},{"style":2287},[40835],{"type":55,"value":8397},{"type":49,"tag":1060,"props":40837,"children":40838},{"style":1073},[40839],{"type":55,"value":40840},"])[:",{"type":49,"tag":1060,"props":40842,"children":40843},{"style":2287},[40844],{"type":55,"value":32358},{"type":49,"tag":1060,"props":40846,"children":40847},{"style":1073},[40848],{"type":55,"value":33153},{"type":49,"tag":1060,"props":40850,"children":40851},{"class":1062,"line":1201},[40852],{"type":49,"tag":1060,"props":40853,"children":40854},{"emptyLinePlaceholder":44},[40855],{"type":55,"value":1094},{"type":49,"tag":1060,"props":40857,"children":40858},{"class":1062,"line":1210},[40859],{"type":49,"tag":1060,"props":40860,"children":40861},{"style":3039},[40862],{"type":55,"value":40863},"    # map_book = [{'loc':[float(book.lon), float(book.lat)],\n",{"type":49,"tag":1060,"props":40865,"children":40866},{"class":1062,"line":1218},[40867],{"type":49,"tag":1060,"props":40868,"children":40869},{"style":3039},[40870],{"type":55,"value":40871},"    #              'title':book.title,\n",{"type":49,"tag":1060,"props":40873,"children":40874},{"class":1062,"line":1232},[40875],{"type":49,"tag":1060,"props":40876,"children":40877},{"style":3039},[40878],{"type":55,"value":40879},"    #              'url':book.get_absolute_url()}]\n",{"type":49,"tag":1060,"props":40881,"children":40882},{"class":1062,"line":1241},[40883,40887,40891],{"type":49,"tag":1060,"props":40884,"children":40885},{"style":1073},[40886],{"type":55,"value":33500},{"type":49,"tag":1060,"props":40888,"children":40889},{"style":2194},[40890],{"type":55,"value":3068},{"type":49,"tag":1060,"props":40892,"children":40893},{"style":1073},[40894],{"type":55,"value":4010},{"type":49,"tag":1060,"props":40896,"children":40897},{"class":1062,"line":1249},[40898,40903],{"type":49,"tag":1060,"props":40899,"children":40900},{"style":2215},[40901],{"type":55,"value":40902},"        'book'",{"type":49,"tag":1060,"props":40904,"children":40905},{"style":1073},[40906],{"type":55,"value":40907},":book,\n",{"type":49,"tag":1060,"props":40909,"children":40910},{"class":1062,"line":1262},[40911],{"type":49,"tag":1060,"props":40912,"children":40913},{"style":3039},[40914],{"type":55,"value":40915},"        # 'map_book':mark_safe(escapejs(json.dumps(map_book))),\n",{"type":49,"tag":1060,"props":40917,"children":40918},{"class":1062,"line":4581},[40919,40924],{"type":49,"tag":1060,"props":40920,"children":40921},{"style":2215},[40922],{"type":55,"value":40923},"        'sorted_nearby'",{"type":49,"tag":1060,"props":40925,"children":40926},{"style":1073},[40927],{"type":55,"value":40928},":sorted_nearby,\n",{"type":49,"tag":1060,"props":40930,"children":40931},{"class":1062,"line":4631},[40932],{"type":49,"tag":1060,"props":40933,"children":40934},{"style":1073},[40935],{"type":55,"value":3100},{"type":49,"tag":1060,"props":40937,"children":40938},{"class":1062,"line":4682},[40939,40943,40947,40952],{"type":49,"tag":1060,"props":40940,"children":40941},{"style":2194},[40942],{"type":55,"value":25371},{"type":49,"tag":1060,"props":40944,"children":40945},{"style":1073},[40946],{"type":55,"value":33598},{"type":49,"tag":1060,"props":40948,"children":40949},{"style":2215},[40950],{"type":55,"value":40951},"'books/book_detail.html'",{"type":49,"tag":1060,"props":40953,"children":40954},{"style":1073},[40955],{"type":55,"value":33608},{"type":49,"tag":58,"props":40957,"children":40958},{},[40959,40961,40967,40969,40975,40977,40983,40985,40991,40992,40998,41000,41006,41007,41013,41015,41021,41023,41029,41031,41037,41039,41045,41047,41053,41055,41061],{"type":55,"value":40960},"To find the 5 closest books I arrived at a solution that seems fairly convoluted and should be refactored, but works! I start with a queryset of all books, then use list comprehension to make a list of tuples containing ",{"type":49,"tag":326,"props":40962,"children":40964},{"className":40963},[],[40965],{"type":55,"value":40966},"((\u003C longitutde >, \u003C latitude >), \u003C Book Object >)",{"type":55,"value":40968},". Then I loop over this list and create a dictionary where the keys are ",{"type":49,"tag":326,"props":40970,"children":40972},{"className":40971},[],[40973],{"type":55,"value":40974},"(\u003C longitutde >, \u003C latitude >)",{"type":55,"value":40976}," and the values are tuples of the form: ",{"type":49,"tag":326,"props":40978,"children":40980},{"className":40979},[],[40981],{"type":55,"value":40982},"(\u003C distance in miles >, \u003C Book Object >)",{"type":55,"value":40984},". Finally, I use ",{"type":49,"tag":326,"props":40986,"children":40988},{"className":40987},[],[40989],{"type":55,"value":40990},"sorted",{"type":55,"value":25967},{"type":49,"tag":326,"props":40993,"children":40995},{"className":40994},[],[40996],{"type":55,"value":40997},"dictionary_dict.items()",{"type":55,"value":40999}," where the key is ",{"type":49,"tag":326,"props":41001,"children":41003},{"className":41002},[],[41004],{"type":55,"value":41005},"lambda x: x[1][0]",{"type":55,"value":1931},{"type":49,"tag":326,"props":41008,"children":41010},{"className":41009},[],[41011],{"type":55,"value":41012},"[1]",{"type":55,"value":41014}," accesses the ",{"type":49,"tag":326,"props":41016,"children":41018},{"className":41017},[],[41019],{"type":55,"value":41020},"value",{"type":55,"value":41022}," of the ",{"type":49,"tag":326,"props":41024,"children":41026},{"className":41025},[],[41027],{"type":55,"value":41028},"(\u003C key >, \u003C value>)",{"type":55,"value":41030}," tuple returned by ",{"type":49,"tag":326,"props":41032,"children":41034},{"className":41033},[],[41035],{"type":55,"value":41036},"items()",{"type":55,"value":41038},", and the ",{"type":49,"tag":326,"props":41040,"children":41042},{"className":41041},[],[41043],{"type":55,"value":41044},"[0]",{"type":55,"value":41046}," access the first item, which is the ",{"type":49,"tag":326,"props":41048,"children":41050},{"className":41049},[],[41051],{"type":55,"value":41052},"distance",{"type":55,"value":41054}," value we calculated. Finally, I take the first ",{"type":49,"tag":326,"props":41056,"children":41058},{"className":41057},[],[41059],{"type":55,"value":41060},"[:5]",{"type":55,"value":41062}," items of this sorted list.",{"type":49,"tag":58,"props":41064,"children":41065},{},[41066],{"type":55,"value":41067},"With this approach I think I avoided the possible issue of ambiguity if we have two books with the same coordinates. I'll need to add this scenario to my test suite later.",{"type":49,"tag":50,"props":41069,"children":41071},{"id":41070},"testing-travis-ci",[41072],{"type":55,"value":41073},"Testing & Travis CI",{"type":49,"tag":58,"props":41075,"children":41076},{},[41077],{"type":55,"value":41078},"Speaking of testing, this applcation includes a simple testing suite (that I am currently working on expanding). I have also managed to setup Travis CI for this project. When I push code from my local repo to GitHub, Travis CI automatically runs test, and the commit message contains additional information about whether or not all of the tests were successful.",{"type":49,"tag":58,"props":41080,"children":41081},{},[41082,41084,41090,41092,41097],{"type":55,"value":41083},"Setting up Travis CI is very simple. We need to grant Travis CI (.org) access to our GitHub account, enable Travis CI on the repository we are working with, and then add a ",{"type":49,"tag":326,"props":41085,"children":41087},{"className":41086},[],[41088],{"type":55,"value":41089},".travis.yml",{"type":55,"value":41091}," file to the top level of the project directory. Here's the ",{"type":49,"tag":326,"props":41093,"children":41095},{"className":41094},[],[41096],{"type":55,"value":41089},{"type":55,"value":41098}," file I have for this project:",{"type":49,"tag":1050,"props":41100,"children":41102},{"code":41101,"language":18237,"meta":8,"className":18238,"style":8},"language: python\n\npython:\n  - '3.5'\n\nservices:\n  - postgresql\n\nenv: -DJANGO=2.0 DB=postgresql\n\ninstall:\n  - pip install -r requirements.txt\n\nbefore_script:\n  - psql -c \"CREATE USER u_brian WITH PASSWORD 'password'; ALTER USER u_brian CREATEDB;\" -U postgres\n\nscript:\n  - python manage.py test books/\n",[41103],{"type":49,"tag":326,"props":41104,"children":41105},{"__ignoreMap":8},[41106,41122,41129,41140,41153,41160,41171,41183,41190,41207,41214,41226,41238,41245,41256,41268,41275,41286],{"type":49,"tag":1060,"props":41107,"children":41108},{"class":1062,"line":1063},[41109,41113,41117],{"type":49,"tag":1060,"props":41110,"children":41111},{"style":3839},[41112],{"type":55,"value":702},{"type":49,"tag":1060,"props":41114,"children":41115},{"style":1073},[41116],{"type":55,"value":78},{"type":49,"tag":1060,"props":41118,"children":41119},{"style":2215},[41120],{"type":55,"value":41121},"python\n",{"type":49,"tag":1060,"props":41123,"children":41124},{"class":1062,"line":1079},[41125],{"type":49,"tag":1060,"props":41126,"children":41127},{"emptyLinePlaceholder":44},[41128],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41130,"children":41131},{"class":1062,"line":1088},[41132,41136],{"type":49,"tag":1060,"props":41133,"children":41134},{"style":3839},[41135],{"type":55,"value":28337},{"type":49,"tag":1060,"props":41137,"children":41138},{"style":1073},[41139],{"type":55,"value":6862},{"type":49,"tag":1060,"props":41141,"children":41142},{"class":1062,"line":1097},[41143,41148],{"type":49,"tag":1060,"props":41144,"children":41145},{"style":1073},[41146],{"type":55,"value":41147},"  - ",{"type":49,"tag":1060,"props":41149,"children":41150},{"style":2215},[41151],{"type":55,"value":41152},"'3.5'\n",{"type":49,"tag":1060,"props":41154,"children":41155},{"class":1062,"line":1111},[41156],{"type":49,"tag":1060,"props":41157,"children":41158},{"emptyLinePlaceholder":44},[41159],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41161,"children":41162},{"class":1062,"line":1120},[41163,41167],{"type":49,"tag":1060,"props":41164,"children":41165},{"style":3839},[41166],{"type":55,"value":18755},{"type":49,"tag":1060,"props":41168,"children":41169},{"style":1073},[41170],{"type":55,"value":6862},{"type":49,"tag":1060,"props":41172,"children":41173},{"class":1062,"line":1128},[41174,41178],{"type":49,"tag":1060,"props":41175,"children":41176},{"style":1073},[41177],{"type":55,"value":41147},{"type":49,"tag":1060,"props":41179,"children":41180},{"style":2215},[41181],{"type":55,"value":41182},"postgresql\n",{"type":49,"tag":1060,"props":41184,"children":41185},{"class":1062,"line":1141},[41186],{"type":49,"tag":1060,"props":41187,"children":41188},{"emptyLinePlaceholder":44},[41189],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41191,"children":41192},{"class":1062,"line":1150},[41193,41198,41202],{"type":49,"tag":1060,"props":41194,"children":41195},{"style":3839},[41196],{"type":55,"value":41197},"env",{"type":49,"tag":1060,"props":41199,"children":41200},{"style":1073},[41201],{"type":55,"value":78},{"type":49,"tag":1060,"props":41203,"children":41204},{"style":2215},[41205],{"type":55,"value":41206},"-DJANGO=2.0 DB=postgresql\n",{"type":49,"tag":1060,"props":41208,"children":41209},{"class":1062,"line":1158},[41210],{"type":49,"tag":1060,"props":41211,"children":41212},{"emptyLinePlaceholder":44},[41213],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41215,"children":41216},{"class":1062,"line":1171},[41217,41222],{"type":49,"tag":1060,"props":41218,"children":41219},{"style":3839},[41220],{"type":55,"value":41221},"install",{"type":49,"tag":1060,"props":41223,"children":41224},{"style":1073},[41225],{"type":55,"value":6862},{"type":49,"tag":1060,"props":41227,"children":41228},{"class":1062,"line":1180},[41229,41233],{"type":49,"tag":1060,"props":41230,"children":41231},{"style":1073},[41232],{"type":55,"value":41147},{"type":49,"tag":1060,"props":41234,"children":41235},{"style":2215},[41236],{"type":55,"value":41237},"pip install -r requirements.txt\n",{"type":49,"tag":1060,"props":41239,"children":41240},{"class":1062,"line":1188},[41241],{"type":49,"tag":1060,"props":41242,"children":41243},{"emptyLinePlaceholder":44},[41244],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41246,"children":41247},{"class":1062,"line":1201},[41248,41252],{"type":49,"tag":1060,"props":41249,"children":41250},{"style":3839},[41251],{"type":55,"value":18716},{"type":49,"tag":1060,"props":41253,"children":41254},{"style":1073},[41255],{"type":55,"value":6862},{"type":49,"tag":1060,"props":41257,"children":41258},{"class":1062,"line":1210},[41259,41263],{"type":49,"tag":1060,"props":41260,"children":41261},{"style":1073},[41262],{"type":55,"value":41147},{"type":49,"tag":1060,"props":41264,"children":41265},{"style":2215},[41266],{"type":55,"value":41267},"psql -c \"CREATE USER u_brian WITH PASSWORD 'password'; ALTER USER u_brian CREATEDB;\" -U postgres\n",{"type":49,"tag":1060,"props":41269,"children":41270},{"class":1062,"line":1218},[41271],{"type":49,"tag":1060,"props":41272,"children":41273},{"emptyLinePlaceholder":44},[41274],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41276,"children":41277},{"class":1062,"line":1232},[41278,41282],{"type":49,"tag":1060,"props":41279,"children":41280},{"style":3839},[41281],{"type":55,"value":29691},{"type":49,"tag":1060,"props":41283,"children":41284},{"style":1073},[41285],{"type":55,"value":6862},{"type":49,"tag":1060,"props":41287,"children":41288},{"class":1062,"line":1241},[41289,41293],{"type":49,"tag":1060,"props":41290,"children":41291},{"style":1073},[41292],{"type":55,"value":41147},{"type":49,"tag":1060,"props":41294,"children":41295},{"style":2215},[41296],{"type":55,"value":41297},"python manage.py test books/\n",{"type":49,"tag":58,"props":41299,"children":41300},{},[41301],{"type":55,"value":41302},"We can generate a Travis CI badge that shows the status of the current Github deploy with the following code:",{"type":49,"tag":1050,"props":41304,"children":41306},{"code":41305,"language":33977,"meta":8,"className":33978,"style":8},"[![Build\nStatus](https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master)](https://travis-ci.org/briancaffey/django-leaflet-demo)\n",[41307],{"type":49,"tag":326,"props":41308,"children":41309},{"__ignoreMap":8},[41310,41318],{"type":49,"tag":1060,"props":41311,"children":41312},{"class":1062,"line":1063},[41313],{"type":49,"tag":1060,"props":41314,"children":41315},{"style":1073},[41316],{"type":55,"value":41317},"[![Build\n",{"type":49,"tag":1060,"props":41319,"children":41320},{"class":1062,"line":1079},[41321],{"type":49,"tag":1060,"props":41322,"children":41323},{"style":1073},[41324],{"type":55,"value":41325},"Status](https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master)](https://travis-ci.org/briancaffey/django-leaflet-demo)\n",{"type":49,"tag":58,"props":41327,"children":41328},{},[41329],{"type":49,"tag":80,"props":41330,"children":41333},{"href":41331,"rel":41332},"https://travis-ci.org/briancaffey/django-leaflet-demo",[84],[41334],{"type":49,"tag":1601,"props":41335,"children":41338},{"alt":41336,"src":41337},"Build Status","https://travis-ci.org/briancaffey/django-leaflet-demo.svg?branch=master",[],{"type":49,"tag":50,"props":41340,"children":41342},{"id":41341},"deploying-to-digitalocean",[41343],{"type":55,"value":41344},"Deploying to DigitalOcean",{"type":49,"tag":58,"props":41346,"children":41347},{},[41348],{"type":55,"value":41349},"Finally, I used DigitalOcean to deploy this app. I have used Heroku for most of my previous projects, but I decided to use DigitalOcean for this one to learn something new and get more experience with using Ubuntu and related tools for running a website: nginx and gunicorn.",{"type":49,"tag":58,"props":41351,"children":41352},{},[41353,41355,41361,41363,41368,41369,41374],{"type":55,"value":41354},"Again, for I turned to Vitor's blog for a very straightforward introduction to deploying on DigitalOcean with a simple Droplet. You can read more about the instructions for deployment ",{"type":49,"tag":80,"props":41356,"children":41359},{"href":41357,"rel":41358},"https://simpleisbetterthancomplex.com/tutorial/2016/10/14/how-to-deploy-to-digital-ocean.html",[84],[41360],{"type":55,"value":8879},{"type":55,"value":41362},", and I can say that I had no problems following the instructions step by step. Here are the ",{"type":49,"tag":326,"props":41364,"children":41366},{"className":41365},[],[41367],{"type":55,"value":30115},{"type":55,"value":715},{"type":49,"tag":326,"props":41370,"children":41372},{"className":41371},[],[41373],{"type":55,"value":17594},{"type":55,"value":41375}," scripts I have used to successfully deploy my project:",{"type":49,"tag":58,"props":41377,"children":41378},{},[41379],{"type":49,"tag":126,"props":41380,"children":41381},{},[41382],{"type":55,"value":41383},"/home/brian/bin/gunicorn_start",{"type":49,"tag":1050,"props":41385,"children":41387},{"code":41386,"language":2728,"meta":8,"className":2729,"style":8},"#!/bin/bash\n\nNAME=\"django-leaflet-demo\"\nDIR=/home/brian/django-leaflet-demo\nUSER=brian\nGROUP=brian\nWORKERS=3\nBIND=unix:/home/brian/run/gunicorn.sock\nDJANGO_SETTINGS_MODULE=djangoapp.settings\nDJANGO_WSGI_MODULE=djangoapp.wsgi\nLOG_LEVEL=error\ncd $DIR\nsource ../bin/activate\n\nexport DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE\nexport PYTHONPATH=$DIR:$PYTHONPATH\n\nexec ../bin/gunicorn ${DJANGO_WSGI_MODULE}:application \\\n  --name=$NAME \\\n  --workers=$WORKERS \\\n  --user=$USER \\\n  --group=$GROUP \\\n  --bind=$BIND \\\n  --log-level=$LOG_LEVEL \\\n  --log-file=-\n",[41388],{"type":49,"tag":326,"props":41389,"children":41390},{"__ignoreMap":8},[41391,41398,41405,41422,41439,41456,41472,41489,41506,41523,41540,41557,41570,41583,41590,41612,41633,41640,41667,41684,41701,41718,41735,41752,41769],{"type":49,"tag":1060,"props":41392,"children":41393},{"class":1062,"line":1063},[41394],{"type":49,"tag":1060,"props":41395,"children":41396},{"style":3039},[41397],{"type":55,"value":9852},{"type":49,"tag":1060,"props":41399,"children":41400},{"class":1062,"line":1079},[41401],{"type":49,"tag":1060,"props":41402,"children":41403},{"emptyLinePlaceholder":44},[41404],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41406,"children":41407},{"class":1062,"line":1088},[41408,41413,41417],{"type":49,"tag":1060,"props":41409,"children":41410},{"style":1073},[41411],{"type":55,"value":41412},"NAME",{"type":49,"tag":1060,"props":41414,"children":41415},{"style":2194},[41416],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41418,"children":41419},{"style":2215},[41420],{"type":55,"value":41421},"\"django-leaflet-demo\"\n",{"type":49,"tag":1060,"props":41423,"children":41424},{"class":1062,"line":1097},[41425,41430,41434],{"type":49,"tag":1060,"props":41426,"children":41427},{"style":1073},[41428],{"type":55,"value":41429},"DIR",{"type":49,"tag":1060,"props":41431,"children":41432},{"style":2194},[41433],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41435,"children":41436},{"style":2215},[41437],{"type":55,"value":41438},"/home/brian/django-leaflet-demo\n",{"type":49,"tag":1060,"props":41440,"children":41441},{"class":1062,"line":1111},[41442,41447,41451],{"type":49,"tag":1060,"props":41443,"children":41444},{"style":1073},[41445],{"type":55,"value":41446},"USER",{"type":49,"tag":1060,"props":41448,"children":41449},{"style":2194},[41450],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41452,"children":41453},{"style":2215},[41454],{"type":55,"value":41455},"brian\n",{"type":49,"tag":1060,"props":41457,"children":41458},{"class":1062,"line":1120},[41459,41464,41468],{"type":49,"tag":1060,"props":41460,"children":41461},{"style":1073},[41462],{"type":55,"value":41463},"GROUP",{"type":49,"tag":1060,"props":41465,"children":41466},{"style":2194},[41467],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41469,"children":41470},{"style":2215},[41471],{"type":55,"value":41455},{"type":49,"tag":1060,"props":41473,"children":41474},{"class":1062,"line":1128},[41475,41480,41484],{"type":49,"tag":1060,"props":41476,"children":41477},{"style":1073},[41478],{"type":55,"value":41479},"WORKERS",{"type":49,"tag":1060,"props":41481,"children":41482},{"style":2194},[41483],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41485,"children":41486},{"style":2215},[41487],{"type":55,"value":41488},"3\n",{"type":49,"tag":1060,"props":41490,"children":41491},{"class":1062,"line":1141},[41492,41497,41501],{"type":49,"tag":1060,"props":41493,"children":41494},{"style":1073},[41495],{"type":55,"value":41496},"BIND",{"type":49,"tag":1060,"props":41498,"children":41499},{"style":2194},[41500],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41502,"children":41503},{"style":2215},[41504],{"type":55,"value":41505},"unix:/home/brian/run/gunicorn.sock\n",{"type":49,"tag":1060,"props":41507,"children":41508},{"class":1062,"line":1150},[41509,41514,41518],{"type":49,"tag":1060,"props":41510,"children":41511},{"style":1073},[41512],{"type":55,"value":41513},"DJANGO_SETTINGS_MODULE",{"type":49,"tag":1060,"props":41515,"children":41516},{"style":2194},[41517],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41519,"children":41520},{"style":2215},[41521],{"type":55,"value":41522},"djangoapp.settings\n",{"type":49,"tag":1060,"props":41524,"children":41525},{"class":1062,"line":1158},[41526,41531,41535],{"type":49,"tag":1060,"props":41527,"children":41528},{"style":1073},[41529],{"type":55,"value":41530},"DJANGO_WSGI_MODULE",{"type":49,"tag":1060,"props":41532,"children":41533},{"style":2194},[41534],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41536,"children":41537},{"style":2215},[41538],{"type":55,"value":41539},"djangoapp.wsgi\n",{"type":49,"tag":1060,"props":41541,"children":41542},{"class":1062,"line":1171},[41543,41548,41552],{"type":49,"tag":1060,"props":41544,"children":41545},{"style":1073},[41546],{"type":55,"value":41547},"LOG_LEVEL",{"type":49,"tag":1060,"props":41549,"children":41550},{"style":2194},[41551],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41553,"children":41554},{"style":2215},[41555],{"type":55,"value":41556},"error\n",{"type":49,"tag":1060,"props":41558,"children":41559},{"class":1062,"line":1180},[41560,41565],{"type":49,"tag":1060,"props":41561,"children":41562},{"style":9965},[41563],{"type":55,"value":41564},"cd",{"type":49,"tag":1060,"props":41566,"children":41567},{"style":1073},[41568],{"type":55,"value":41569}," $DIR\n",{"type":49,"tag":1060,"props":41571,"children":41572},{"class":1062,"line":1188},[41573,41578],{"type":49,"tag":1060,"props":41574,"children":41575},{"style":9965},[41576],{"type":55,"value":41577},"source",{"type":49,"tag":1060,"props":41579,"children":41580},{"style":2215},[41581],{"type":55,"value":41582}," ../bin/activate\n",{"type":49,"tag":1060,"props":41584,"children":41585},{"class":1062,"line":1201},[41586],{"type":49,"tag":1060,"props":41587,"children":41588},{"emptyLinePlaceholder":44},[41589],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41591,"children":41592},{"class":1062,"line":1210},[41593,41598,41603,41607],{"type":49,"tag":1060,"props":41594,"children":41595},{"style":2194},[41596],{"type":55,"value":41597},"export",{"type":49,"tag":1060,"props":41599,"children":41600},{"style":1073},[41601],{"type":55,"value":41602}," DJANGO_SETTINGS_MODULE",{"type":49,"tag":1060,"props":41604,"children":41605},{"style":2194},[41606],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41608,"children":41609},{"style":1073},[41610],{"type":55,"value":41611},"$DJANGO_SETTINGS_MODULE\n",{"type":49,"tag":1060,"props":41613,"children":41614},{"class":1062,"line":1218},[41615,41619,41624,41628],{"type":49,"tag":1060,"props":41616,"children":41617},{"style":2194},[41618],{"type":55,"value":41597},{"type":49,"tag":1060,"props":41620,"children":41621},{"style":1073},[41622],{"type":55,"value":41623}," PYTHONPATH",{"type":49,"tag":1060,"props":41625,"children":41626},{"style":2194},[41627],{"type":55,"value":3068},{"type":49,"tag":1060,"props":41629,"children":41630},{"style":1073},[41631],{"type":55,"value":41632},"$DIR:$PYTHONPATH\n",{"type":49,"tag":1060,"props":41634,"children":41635},{"class":1062,"line":1232},[41636],{"type":49,"tag":1060,"props":41637,"children":41638},{"emptyLinePlaceholder":44},[41639],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41641,"children":41642},{"class":1062,"line":1241},[41643,41648,41653,41658,41663],{"type":49,"tag":1060,"props":41644,"children":41645},{"style":9965},[41646],{"type":55,"value":41647},"exec",{"type":49,"tag":1060,"props":41649,"children":41650},{"style":2215},[41651],{"type":55,"value":41652}," ../bin/gunicorn",{"type":49,"tag":1060,"props":41654,"children":41655},{"style":1073},[41656],{"type":55,"value":41657}," ${DJANGO_WSGI_MODULE}",{"type":49,"tag":1060,"props":41659,"children":41660},{"style":2215},[41661],{"type":55,"value":41662},":application",{"type":49,"tag":1060,"props":41664,"children":41665},{"style":2287},[41666],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41668,"children":41669},{"class":1062,"line":1249},[41670,41675,41680],{"type":49,"tag":1060,"props":41671,"children":41672},{"style":2287},[41673],{"type":55,"value":41674},"  --name=",{"type":49,"tag":1060,"props":41676,"children":41677},{"style":1073},[41678],{"type":55,"value":41679},"$NAME",{"type":49,"tag":1060,"props":41681,"children":41682},{"style":2287},[41683],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41685,"children":41686},{"class":1062,"line":1262},[41687,41692,41697],{"type":49,"tag":1060,"props":41688,"children":41689},{"style":2287},[41690],{"type":55,"value":41691},"  --workers=",{"type":49,"tag":1060,"props":41693,"children":41694},{"style":1073},[41695],{"type":55,"value":41696},"$WORKERS",{"type":49,"tag":1060,"props":41698,"children":41699},{"style":2287},[41700],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41702,"children":41703},{"class":1062,"line":4581},[41704,41709,41714],{"type":49,"tag":1060,"props":41705,"children":41706},{"style":2287},[41707],{"type":55,"value":41708},"  --user=",{"type":49,"tag":1060,"props":41710,"children":41711},{"style":1073},[41712],{"type":55,"value":41713},"$USER",{"type":49,"tag":1060,"props":41715,"children":41716},{"style":2287},[41717],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41719,"children":41720},{"class":1062,"line":4631},[41721,41726,41731],{"type":49,"tag":1060,"props":41722,"children":41723},{"style":2287},[41724],{"type":55,"value":41725},"  --group=",{"type":49,"tag":1060,"props":41727,"children":41728},{"style":1073},[41729],{"type":55,"value":41730},"$GROUP",{"type":49,"tag":1060,"props":41732,"children":41733},{"style":2287},[41734],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41736,"children":41737},{"class":1062,"line":4682},[41738,41743,41748],{"type":49,"tag":1060,"props":41739,"children":41740},{"style":2287},[41741],{"type":55,"value":41742},"  --bind=",{"type":49,"tag":1060,"props":41744,"children":41745},{"style":1073},[41746],{"type":55,"value":41747},"$BIND",{"type":49,"tag":1060,"props":41749,"children":41750},{"style":2287},[41751],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41753,"children":41754},{"class":1062,"line":4709},[41755,41760,41765],{"type":49,"tag":1060,"props":41756,"children":41757},{"style":2287},[41758],{"type":55,"value":41759},"  --log-level=",{"type":49,"tag":1060,"props":41761,"children":41762},{"style":1073},[41763],{"type":55,"value":41764},"$LOG_LEVEL",{"type":49,"tag":1060,"props":41766,"children":41767},{"style":2287},[41768],{"type":55,"value":10239},{"type":49,"tag":1060,"props":41770,"children":41771},{"class":1062,"line":5979},[41772],{"type":49,"tag":1060,"props":41773,"children":41774},{"style":2287},[41775],{"type":55,"value":41776},"  --log-file=-\n",{"type":49,"tag":58,"props":41778,"children":41779},{},[41780],{"type":49,"tag":126,"props":41781,"children":41782},{},[41783],{"type":55,"value":41784},"/etc/nginx/sites-available",{"type":49,"tag":1050,"props":41786,"children":41788},{"code":41787,"language":18237,"meta":8,"className":18238,"style":8},"upstream app_server {\nserver unix:/home/brian/run/gunicorn.sock fail_timeout=0;\n}\n\nserver {\nlisten 80;\nserver_name 159.89.235.193\nkeepalive_timeout 5;\nclient_max_body_size 4G;\naccess_log /home/brian/logs/nginx-access.log;\nerror_log /home/brian/logs/nginx-error.log;\n\nlocation /static/ {\nalias /home/brian/static/;\n}\n\nlocation / {\ntry_files $uri @proxy_to_app;\n}\n\nlocation @proxy_to_app {\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header Host $http_host;\nproxy_redirect off;\nproxy_pass http://app_server;\n}\n}\n",[41789],{"type":49,"tag":326,"props":41790,"children":41791},{"__ignoreMap":8},[41792,41800,41808,41815,41822,41830,41838,41846,41854,41862,41870,41878,41885,41893,41901,41908,41915,41923,41931,41938,41945,41953,41961,41969,41977,41985,41992],{"type":49,"tag":1060,"props":41793,"children":41794},{"class":1062,"line":1063},[41795],{"type":49,"tag":1060,"props":41796,"children":41797},{"style":2215},[41798],{"type":55,"value":41799},"upstream app_server {\n",{"type":49,"tag":1060,"props":41801,"children":41802},{"class":1062,"line":1079},[41803],{"type":49,"tag":1060,"props":41804,"children":41805},{"style":2215},[41806],{"type":55,"value":41807},"server unix:/home/brian/run/gunicorn.sock fail_timeout=0;\n",{"type":49,"tag":1060,"props":41809,"children":41810},{"class":1062,"line":1088},[41811],{"type":49,"tag":1060,"props":41812,"children":41813},{"style":1073},[41814],{"type":55,"value":3675},{"type":49,"tag":1060,"props":41816,"children":41817},{"class":1062,"line":1097},[41818],{"type":49,"tag":1060,"props":41819,"children":41820},{"emptyLinePlaceholder":44},[41821],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41823,"children":41824},{"class":1062,"line":1111},[41825],{"type":49,"tag":1060,"props":41826,"children":41827},{"style":2215},[41828],{"type":55,"value":41829},"server {\n",{"type":49,"tag":1060,"props":41831,"children":41832},{"class":1062,"line":1120},[41833],{"type":49,"tag":1060,"props":41834,"children":41835},{"style":2215},[41836],{"type":55,"value":41837},"listen 80;\n",{"type":49,"tag":1060,"props":41839,"children":41840},{"class":1062,"line":1128},[41841],{"type":49,"tag":1060,"props":41842,"children":41843},{"style":2215},[41844],{"type":55,"value":41845},"server_name 159.89.235.193\n",{"type":49,"tag":1060,"props":41847,"children":41848},{"class":1062,"line":1141},[41849],{"type":49,"tag":1060,"props":41850,"children":41851},{"style":2215},[41852],{"type":55,"value":41853},"keepalive_timeout 5;\n",{"type":49,"tag":1060,"props":41855,"children":41856},{"class":1062,"line":1150},[41857],{"type":49,"tag":1060,"props":41858,"children":41859},{"style":2215},[41860],{"type":55,"value":41861},"client_max_body_size 4G;\n",{"type":49,"tag":1060,"props":41863,"children":41864},{"class":1062,"line":1158},[41865],{"type":49,"tag":1060,"props":41866,"children":41867},{"style":2215},[41868],{"type":55,"value":41869},"access_log /home/brian/logs/nginx-access.log;\n",{"type":49,"tag":1060,"props":41871,"children":41872},{"class":1062,"line":1171},[41873],{"type":49,"tag":1060,"props":41874,"children":41875},{"style":2215},[41876],{"type":55,"value":41877},"error_log /home/brian/logs/nginx-error.log;\n",{"type":49,"tag":1060,"props":41879,"children":41880},{"class":1062,"line":1180},[41881],{"type":49,"tag":1060,"props":41882,"children":41883},{"emptyLinePlaceholder":44},[41884],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41886,"children":41887},{"class":1062,"line":1188},[41888],{"type":49,"tag":1060,"props":41889,"children":41890},{"style":2215},[41891],{"type":55,"value":41892},"location /static/ {\n",{"type":49,"tag":1060,"props":41894,"children":41895},{"class":1062,"line":1201},[41896],{"type":49,"tag":1060,"props":41897,"children":41898},{"style":2215},[41899],{"type":55,"value":41900},"alias /home/brian/static/;\n",{"type":49,"tag":1060,"props":41902,"children":41903},{"class":1062,"line":1210},[41904],{"type":49,"tag":1060,"props":41905,"children":41906},{"style":1073},[41907],{"type":55,"value":3675},{"type":49,"tag":1060,"props":41909,"children":41910},{"class":1062,"line":1218},[41911],{"type":49,"tag":1060,"props":41912,"children":41913},{"emptyLinePlaceholder":44},[41914],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41916,"children":41917},{"class":1062,"line":1232},[41918],{"type":49,"tag":1060,"props":41919,"children":41920},{"style":2215},[41921],{"type":55,"value":41922},"location / {\n",{"type":49,"tag":1060,"props":41924,"children":41925},{"class":1062,"line":1241},[41926],{"type":49,"tag":1060,"props":41927,"children":41928},{"style":2215},[41929],{"type":55,"value":41930},"try_files $uri @proxy_to_app;\n",{"type":49,"tag":1060,"props":41932,"children":41933},{"class":1062,"line":1249},[41934],{"type":49,"tag":1060,"props":41935,"children":41936},{"style":1073},[41937],{"type":55,"value":3675},{"type":49,"tag":1060,"props":41939,"children":41940},{"class":1062,"line":1262},[41941],{"type":49,"tag":1060,"props":41942,"children":41943},{"emptyLinePlaceholder":44},[41944],{"type":55,"value":1094},{"type":49,"tag":1060,"props":41946,"children":41947},{"class":1062,"line":4581},[41948],{"type":49,"tag":1060,"props":41949,"children":41950},{"style":2215},[41951],{"type":55,"value":41952},"location @proxy_to_app {\n",{"type":49,"tag":1060,"props":41954,"children":41955},{"class":1062,"line":4631},[41956],{"type":49,"tag":1060,"props":41957,"children":41958},{"style":2215},[41959],{"type":55,"value":41960},"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n",{"type":49,"tag":1060,"props":41962,"children":41963},{"class":1062,"line":4682},[41964],{"type":49,"tag":1060,"props":41965,"children":41966},{"style":2215},[41967],{"type":55,"value":41968},"proxy_set_header Host $http_host;\n",{"type":49,"tag":1060,"props":41970,"children":41971},{"class":1062,"line":4709},[41972],{"type":49,"tag":1060,"props":41973,"children":41974},{"style":2215},[41975],{"type":55,"value":41976},"proxy_redirect off;\n",{"type":49,"tag":1060,"props":41978,"children":41979},{"class":1062,"line":5979},[41980],{"type":49,"tag":1060,"props":41981,"children":41982},{"style":2215},[41983],{"type":55,"value":41984},"proxy_pass http://app_server;\n",{"type":49,"tag":1060,"props":41986,"children":41987},{"class":1062,"line":5988},[41988],{"type":49,"tag":1060,"props":41989,"children":41990},{"style":1073},[41991],{"type":55,"value":3675},{"type":49,"tag":1060,"props":41993,"children":41994},{"class":1062,"line":5997},[41995],{"type":49,"tag":1060,"props":41996,"children":41997},{"style":1073},[41998],{"type":55,"value":3675},{"type":49,"tag":58,"props":42000,"children":42001},{},[42002],{"type":55,"value":42003},"Finally, here is the Supervisor configuration file that runs the gunicorn server:",{"type":49,"tag":1050,"props":42005,"children":42007},{"code":42006},"[program:django-leaflet-demo]\ncommand=/home/brian/bin/gunicorn_start\nuser=brian\nautostart=true\nautorestart=true\nredirect_stderr=true\nstdout_logfile=/home/brian/logs/gunicorn-error.log\n",[42008],{"type":49,"tag":326,"props":42009,"children":42010},{"__ignoreMap":8},[42011],{"type":55,"value":42006},{"type":49,"tag":58,"props":42013,"children":42014},{},[42015],{"type":55,"value":42016},"I would definitely like to dive into DigitalOcean deployment in more depth in my next post.",{"type":49,"tag":58,"props":42018,"children":42019},{},[42020,42022,42027],{"type":55,"value":42021},"For now, you can view the live project on DigitalOcean here: ",{"type":49,"tag":80,"props":42023,"children":42025},{"href":32717,"rel":42024},[84],[42026],{"type":55,"value":32717},{"type":55,"value":42028},". In the future I would like to use this Droplet to do more demo apps like this one as I continue to learn the ins and outs of using Django and more frontend tools. Thanks for reading to the end and let me know if you have any comments or critiques on how I went about this project, I would be happy to hear from you!",{"type":49,"tag":7749,"props":42030,"children":42031},{},[42032],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":42034},[42035,42036,42037,42038,42039,42040,42041,42042,42043,42044],{"id":32713,"depth":1088,"text":32721},{"id":32939,"depth":1079,"text":32942},{"id":33161,"depth":1079,"text":33164},{"id":35099,"depth":1079,"text":35102},{"id":35881,"depth":1079,"text":35884},{"id":36637,"depth":1079,"text":36640},{"id":38251,"depth":1079,"text":38254},{"id":39930,"depth":1079,"text":39933},{"id":41070,"depth":1079,"text":41073},{"id":41341,"depth":1079,"text":41344},"content:2018:02:19:leaflet-maps-with-django.md","2018/02/19/leaflet-maps-with-django.md","2018/02/19/leaflet-maps-with-django",{"_path":42049,"_dir":42050,"_draft":7,"_partial":7,"_locale":8,"title":42051,"description":42052,"layout":16873,"date":42053,"comments":44,"image":42054,"tags":42055,"body":42057,"_type":7809,"_id":45206,"_source":7811,"_file":45207,"_stem":45208,"_extension":7814},"/2017/03/04/settinging-up-django-with-heroku","04","Setting up a Django app on Heroku","This is a simple guide to setting up a Django project on Heroku.","2017-03-04T00:00:00.000Z","/static/django-heroku.png",[14,42056],"heroku",{"type":46,"children":42058,"toc":45204},[42059,42063,42067,42072,42080,42085,42093,42106,42120,42235,42253,42260,42331,42387,42395,42400,42408,42413,42421,42432,42440,42445,42453,42464,42472,42484,42499,42511,42516,42524,42537,42544,42558,42595,42608,42613,42621,42640,42663,42675,42683,42688,42696,42701,42709,42714,42722,42734,42739,42747,42755,42760,42768,42773,42781,42800,42894,42899,42906,42911,42919,42937,42945,42950,42958,42969,42986,42993,43027,43072,43077,43084,43304,43309,43317,43328,43567,43583,43771,43783,43791,43804,43812,43830,43838,43843,43849,43854,43859,43867,43878,43891,44058,44070,44256,44287,44299,44307,44319,44333,44369,44436,44449,44457,44469,45171,45184,45196,45200],{"type":49,"tag":58,"props":42060,"children":42061},{},[42062],{"type":55,"value":42052},{"type":49,"tag":58,"props":42064,"children":42065},{},[42066],{"type":55,"value":32781},{"type":49,"tag":58,"props":42068,"children":42069},{},[42070],{"type":55,"value":42071},"The first step is to create a virutal environment in a new directory:",{"type":49,"tag":1050,"props":42073,"children":42075},{"code":42074},"$ mkdir proj && cd proj\n$ virtualenv -p python3 .\n$ source bin/activate\n(proj) $ mkdir src\n(proj) $ cd src\n(proj) $ pip install django==1.10.5\n(proj) $ django-admin.py startproject myproj .\n(proj) $ ls\nmyproj        manage.py\n",[42076],{"type":49,"tag":326,"props":42077,"children":42078},{"__ignoreMap":8},[42079],{"type":55,"value":42074},{"type":49,"tag":58,"props":42081,"children":42082},{},[42083],{"type":55,"value":42084},"This sets up a virtual environment and creates an empty Django project. The next step is to create a settings module.",{"type":49,"tag":1050,"props":42086,"children":42088},{"code":42087},"(proj) $ cd myproj\n(proj) $ mkdir settings && cd settings\n",[42089],{"type":49,"tag":326,"props":42090,"children":42091},{"__ignoreMap":8},[42092],{"type":55,"value":42087},{"type":49,"tag":58,"props":42094,"children":42095},{},[42096,42098,42104],{"type":55,"value":42097},"Next we want to add ",{"type":49,"tag":326,"props":42099,"children":42101},{"className":42100},[],[42102],{"type":55,"value":42103},"__init__.py",{"type":55,"value":42105}," to settings to make it a python module.",{"type":49,"tag":58,"props":42107,"children":42108},{},[42109],{"type":49,"tag":126,"props":42110,"children":42111},{},[42112,42114,42118],{"type":55,"value":42113},"src/myproj/settings/",{"type":49,"tag":72,"props":42115,"children":42116},{},[42117],{"type":55,"value":535},{"type":55,"value":42119},".py",{"type":49,"tag":1050,"props":42121,"children":42123},{"code":42122,"language":28337,"meta":8,"className":28338,"style":8},"from .base import *\n\nfrom .production import *\n\ntry:\n    from .local import *\nexcept:\n    pass\n",[42124],{"type":49,"tag":326,"props":42125,"children":42126},{"__ignoreMap":8},[42127,42148,42155,42175,42182,42194,42215,42227],{"type":49,"tag":1060,"props":42128,"children":42129},{"class":1062,"line":1063},[42130,42134,42139,42143],{"type":49,"tag":1060,"props":42131,"children":42132},{"style":2194},[42133],{"type":55,"value":22184},{"type":49,"tag":1060,"props":42135,"children":42136},{"style":1073},[42137],{"type":55,"value":42138}," .base ",{"type":49,"tag":1060,"props":42140,"children":42141},{"style":2194},[42142],{"type":55,"value":22194},{"type":49,"tag":1060,"props":42144,"children":42145},{"style":2194},[42146],{"type":55,"value":42147}," *\n",{"type":49,"tag":1060,"props":42149,"children":42150},{"class":1062,"line":1079},[42151],{"type":49,"tag":1060,"props":42152,"children":42153},{"emptyLinePlaceholder":44},[42154],{"type":55,"value":1094},{"type":49,"tag":1060,"props":42156,"children":42157},{"class":1062,"line":1088},[42158,42162,42167,42171],{"type":49,"tag":1060,"props":42159,"children":42160},{"style":2194},[42161],{"type":55,"value":22184},{"type":49,"tag":1060,"props":42163,"children":42164},{"style":1073},[42165],{"type":55,"value":42166}," .production ",{"type":49,"tag":1060,"props":42168,"children":42169},{"style":2194},[42170],{"type":55,"value":22194},{"type":49,"tag":1060,"props":42172,"children":42173},{"style":2194},[42174],{"type":55,"value":42147},{"type":49,"tag":1060,"props":42176,"children":42177},{"class":1062,"line":1097},[42178],{"type":49,"tag":1060,"props":42179,"children":42180},{"emptyLinePlaceholder":44},[42181],{"type":55,"value":1094},{"type":49,"tag":1060,"props":42183,"children":42184},{"class":1062,"line":1111},[42185,42190],{"type":49,"tag":1060,"props":42186,"children":42187},{"style":2194},[42188],{"type":55,"value":42189},"try",{"type":49,"tag":1060,"props":42191,"children":42192},{"style":1073},[42193],{"type":55,"value":6862},{"type":49,"tag":1060,"props":42195,"children":42196},{"class":1062,"line":1120},[42197,42202,42207,42211],{"type":49,"tag":1060,"props":42198,"children":42199},{"style":2194},[42200],{"type":55,"value":42201},"    from",{"type":49,"tag":1060,"props":42203,"children":42204},{"style":1073},[42205],{"type":55,"value":42206}," .local ",{"type":49,"tag":1060,"props":42208,"children":42209},{"style":2194},[42210],{"type":55,"value":22194},{"type":49,"tag":1060,"props":42212,"children":42213},{"style":2194},[42214],{"type":55,"value":42147},{"type":49,"tag":1060,"props":42216,"children":42217},{"class":1062,"line":1128},[42218,42223],{"type":49,"tag":1060,"props":42219,"children":42220},{"style":2194},[42221],{"type":55,"value":42222},"except",{"type":49,"tag":1060,"props":42224,"children":42225},{"style":1073},[42226],{"type":55,"value":6862},{"type":49,"tag":1060,"props":42228,"children":42229},{"class":1062,"line":1141},[42230],{"type":49,"tag":1060,"props":42231,"children":42232},{"style":2194},[42233],{"type":55,"value":42234},"    pass\n",{"type":49,"tag":58,"props":42236,"children":42237},{},[42238,42240,42245,42247,42252],{"type":55,"value":42239},"Next we want to change the ",{"type":49,"tag":326,"props":42241,"children":42243},{"className":42242},[],[42244],{"type":55,"value":19951},{"type":55,"value":42246}," (base directory) in ",{"type":49,"tag":326,"props":42248,"children":42250},{"className":42249},[],[42251],{"type":55,"value":19927},{"type":55,"value":6694},{"type":49,"tag":58,"props":42254,"children":42255},{},[42256],{"type":49,"tag":126,"props":42257,"children":42258},{},[42259],{"type":55,"value":19927},{"type":49,"tag":1050,"props":42261,"children":42263},{"code":42262,"language":28337,"meta":8,"className":28338,"style":8},"[...]\n# Build paths inside the project like this: os.path.join(BASE_DIR, ...)\nBASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n[...]\n",[42264],{"type":49,"tag":326,"props":42265,"children":42266},{"__ignoreMap":8},[42267,42282,42290,42316],{"type":49,"tag":1060,"props":42268,"children":42269},{"class":1062,"line":1063},[42270,42274,42278],{"type":49,"tag":1060,"props":42271,"children":42272},{"style":1073},[42273],{"type":55,"value":23394},{"type":49,"tag":1060,"props":42275,"children":42276},{"style":2287},[42277],{"type":55,"value":3078},{"type":49,"tag":1060,"props":42279,"children":42280},{"style":1073},[42281],{"type":55,"value":33153},{"type":49,"tag":1060,"props":42283,"children":42284},{"class":1062,"line":1079},[42285],{"type":49,"tag":1060,"props":42286,"children":42287},{"style":3039},[42288],{"type":55,"value":42289},"# Build paths inside the project like this: os.path.join(BASE_DIR, ...)\n",{"type":49,"tag":1060,"props":42291,"children":42292},{"class":1062,"line":1088},[42293,42297,42301,42306,42311],{"type":49,"tag":1060,"props":42294,"children":42295},{"style":2287},[42296],{"type":55,"value":19951},{"type":49,"tag":1060,"props":42298,"children":42299},{"style":2194},[42300],{"type":55,"value":2197},{"type":49,"tag":1060,"props":42302,"children":42303},{"style":1073},[42304],{"type":55,"value":42305}," os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(",{"type":49,"tag":1060,"props":42307,"children":42308},{"style":2188},[42309],{"type":55,"value":42310},"__file__",{"type":49,"tag":1060,"props":42312,"children":42313},{"style":1073},[42314],{"type":55,"value":42315},"))))\n",{"type":49,"tag":1060,"props":42317,"children":42318},{"class":1062,"line":1097},[42319,42323,42327],{"type":49,"tag":1060,"props":42320,"children":42321},{"style":1073},[42322],{"type":55,"value":23394},{"type":49,"tag":1060,"props":42324,"children":42325},{"style":2287},[42326],{"type":55,"value":3078},{"type":49,"tag":1060,"props":42328,"children":42329},{"style":1073},[42330],{"type":55,"value":33153},{"type":49,"tag":58,"props":42332,"children":42333},{},[42334,42336,42341,42343,42349,42351,42357,42359,42364,42366,42372,42373,42379,42381,42386],{"type":55,"value":42335},"Next we need to move ",{"type":49,"tag":326,"props":42337,"children":42339},{"className":42338},[],[42340],{"type":55,"value":19927},{"type":55,"value":42342}," into the ",{"type":49,"tag":326,"props":42344,"children":42346},{"className":42345},[],[42347],{"type":55,"value":42348},"settings",{"type":55,"value":42350}," folder and rename it ",{"type":49,"tag":326,"props":42352,"children":42354},{"className":42353},[],[42355],{"type":55,"value":42356},"base.py",{"type":55,"value":42358}," and then copy ",{"type":49,"tag":326,"props":42360,"children":42362},{"className":42361},[],[42363],{"type":55,"value":42356},{"type":55,"value":42365}," twice as ",{"type":49,"tag":326,"props":42367,"children":42369},{"className":42368},[],[42370],{"type":55,"value":42371},"local.py",{"type":55,"value":715},{"type":49,"tag":326,"props":42374,"children":42376},{"className":42375},[],[42377],{"type":55,"value":42378},"production.py",{"type":55,"value":42380}," these three files will live in ",{"type":49,"tag":326,"props":42382,"children":42384},{"className":42383},[],[42385],{"type":55,"value":42348},{"type":55,"value":745},{"type":49,"tag":1050,"props":42388,"children":42390},{"code":42389},"(proj) $ mv settings.py settings\n(proj) $ cd settings\n(proj) $ mv settings.py base.py\n(proj) $ cp base.py local.py\n(proj) $ cp base.py production.py\n",[42391],{"type":49,"tag":326,"props":42392,"children":42393},{"__ignoreMap":8},[42394],{"type":55,"value":42389},{"type":49,"tag":58,"props":42396,"children":42397},{},[42398],{"type":55,"value":42399},"Next we need to install PostgreSQL:",{"type":49,"tag":1050,"props":42401,"children":42403},{"code":42402},"(proj) $ pip install psycopg2\n(proj) $ pip install gunicorn dj-database-url\n(proj) $ pip install django-crispy-forms\n(proj) $ pip install pillow\n",[42404],{"type":49,"tag":326,"props":42405,"children":42406},{"__ignoreMap":8},[42407],{"type":55,"value":42402},{"type":49,"tag":58,"props":42409,"children":42410},{},[42411],{"type":55,"value":42412},"At this point we can check to see if everything installed correctly:",{"type":49,"tag":1050,"props":42414,"children":42416},{"code":42415},"(proj) $ pip freeze\nappdirs==1.4.3\ndj-database-url==0.4.2\nDjango==1.10.5\ndjango-crispy-forms==1.6.1\ngunicorn==19.7.1\nolefile==0.44\npackaging==16.8\nPillow==4.0.0\npsycopg2==2.7.1\npyparsing==2.2.0\nsix==1.10.0\n",[42417],{"type":49,"tag":326,"props":42418,"children":42419},{"__ignoreMap":8},[42420],{"type":55,"value":42415},{"type":49,"tag":58,"props":42422,"children":42423},{},[42424,42426,42431],{"type":55,"value":42425},"And then we can add these to a file in our base directory called ",{"type":49,"tag":326,"props":42427,"children":42429},{"className":42428},[],[42430],{"type":55,"value":14324},{"type":55,"value":6694},{"type":49,"tag":1050,"props":42433,"children":42435},{"code":42434},"(proj) $ pip freeze > requirements.txt\n",[42436],{"type":49,"tag":326,"props":42437,"children":42438},{"__ignoreMap":8},[42439],{"type":55,"value":42434},{"type":49,"tag":58,"props":42441,"children":42442},{},[42443],{"type":55,"value":42444},"Next we can run migrations and create a superuser:",{"type":49,"tag":1050,"props":42446,"children":42448},{"code":42447},"(proj) $ python manage.py migrate\n(proj) $ python manage.py createsuperuser\n",[42449],{"type":49,"tag":326,"props":42450,"children":42451},{"__ignoreMap":8},[42452],{"type":55,"value":42447},{"type":49,"tag":58,"props":42454,"children":42455},{},[42456,42458,42463],{"type":55,"value":42457},"Next we need to initialize our git repository and create ",{"type":49,"tag":326,"props":42459,"children":42461},{"className":42460},[],[42462],{"type":55,"value":18695},{"type":55,"value":6694},{"type":49,"tag":1050,"props":42465,"children":42467},{"code":42466},"(proj) $ git init\n",[42468],{"type":49,"tag":326,"props":42469,"children":42470},{"__ignoreMap":8},[42471],{"type":55,"value":42466},{"type":49,"tag":58,"props":42473,"children":42474},{},[42475,42477,42482],{"type":55,"value":42476},"We can put ",{"type":49,"tag":326,"props":42478,"children":42480},{"className":42479},[],[42481],{"type":55,"value":18695},{"type":55,"value":42483}," in our base directory and add the following:",{"type":49,"tag":1050,"props":42485,"children":42488},{"code":42486,"language":55,"meta":8,"className":42487,"style":8},"myproj/settings/local.py\n","language-text shiki shiki-themes github-light github-dark monokai",[42489],{"type":49,"tag":326,"props":42490,"children":42491},{"__ignoreMap":8},[42492],{"type":49,"tag":1060,"props":42493,"children":42494},{"class":1062,"line":1063},[42495],{"type":49,"tag":1060,"props":42496,"children":42497},{},[42498],{"type":55,"value":42486},{"type":49,"tag":58,"props":42500,"children":42501},{},[42502,42504,42510],{"type":55,"value":42503},"We also want to ignore several other python-related files in our directory. An easy way to do this is to add python gitignore. This can be found ",{"type":49,"tag":80,"props":42505,"children":42508},{"href":42506,"rel":42507},"https://raw.githubusercontent.com/github/gitignore/master/Python.gitignore",[84],[42509],{"type":55,"value":8879},{"type":55,"value":745},{"type":49,"tag":58,"props":42512,"children":42513},{},[42514],{"type":55,"value":42515},"Next we can make our first commit:",{"type":49,"tag":1050,"props":42517,"children":42519},{"code":42518},"(proj) $ git add --all\n(proj) $ git commit -m \"initial commit\"\n",[42520],{"type":49,"tag":326,"props":42521,"children":42522},{"__ignoreMap":8},[42523],{"type":55,"value":42518},{"type":49,"tag":58,"props":42525,"children":42526},{},[42527,42529,42535],{"type":55,"value":42528},"The next step involves setting up Heroku. First we need to create a ",{"type":49,"tag":326,"props":42530,"children":42532},{"className":42531},[],[42533],{"type":55,"value":42534},"Procfile",{"type":55,"value":42536}," in our base directory:",{"type":49,"tag":58,"props":42538,"children":42539},{},[42540],{"type":49,"tag":126,"props":42541,"children":42542},{},[42543],{"type":55,"value":42534},{"type":49,"tag":1050,"props":42545,"children":42547},{"code":42546,"language":55,"meta":8,"className":42487,"style":8},"web: gunicorn myproj.wsgi --log-file -\n",[42548],{"type":49,"tag":326,"props":42549,"children":42550},{"__ignoreMap":8},[42551],{"type":49,"tag":1060,"props":42552,"children":42553},{"class":1062,"line":1063},[42554],{"type":49,"tag":1060,"props":42555,"children":42556},{},[42557],{"type":55,"value":42546},{"type":49,"tag":58,"props":42559,"children":42560},{},[42561,42563,42569,42570,42576,42577,42582,42583,42588,42589,42594],{"type":55,"value":42562},"Next we can try to run Heroku locally, but first we need to add ",{"type":49,"tag":326,"props":42564,"children":42566},{"className":42565},[],[42567],{"type":55,"value":42568},"0.0.0.0",{"type":55,"value":12789},{"type":49,"tag":326,"props":42571,"children":42573},{"className":42572},[],[42574],{"type":55,"value":42575},"ALLOWED_HOSTS",{"type":55,"value":16370},{"type":49,"tag":326,"props":42578,"children":42580},{"className":42579},[],[42581],{"type":55,"value":42378},{"type":55,"value":873},{"type":49,"tag":326,"props":42584,"children":42586},{"className":42585},[],[42587],{"type":55,"value":42356},{"type":55,"value":715},{"type":49,"tag":326,"props":42590,"children":42592},{"className":42591},[],[42593],{"type":55,"value":42371},{"type":55,"value":745},{"type":49,"tag":58,"props":42596,"children":42597},{},[42598,42600,42606],{"type":55,"value":42599},"We should now see \"It worked!\" at ",{"type":49,"tag":326,"props":42601,"children":42603},{"className":42602},[],[42604],{"type":55,"value":42605},"0.0.0.0:5000",{"type":55,"value":42607},", which tells us that everything is working properly.",{"type":49,"tag":58,"props":42609,"children":42610},{},[42611],{"type":55,"value":42612},"Next we need to create the project on Heroku:",{"type":49,"tag":1050,"props":42614,"children":42616},{"code":42615},"(proj) $ heroku login\n(proj) $ heroku create my-unique-project-name-123\n",[42617],{"type":49,"tag":326,"props":42618,"children":42619},{"__ignoreMap":8},[42620],{"type":55,"value":42615},{"type":49,"tag":58,"props":42622,"children":42623},{},[42624,42626,42632,42634],{"type":55,"value":42625},"Now we can see our project at ",{"type":49,"tag":326,"props":42627,"children":42629},{"className":42628},[],[42630],{"type":55,"value":42631},"my-unique-project-name-123.herokuapp.com",{"type":55,"value":42633},", and it should say ",{"type":49,"tag":326,"props":42635,"children":42637},{"className":42636},[],[42638],{"type":55,"value":42639},"Heroku | Welcome to your new app!",{"type":49,"tag":58,"props":42641,"children":42642},{},[42643,42645,42650,42651,42656,42657,42662],{"type":55,"value":42644},"Next we will want to add ",{"type":49,"tag":326,"props":42646,"children":42648},{"className":42647},[],[42649],{"type":55,"value":42631},{"type":55,"value":12789},{"type":49,"tag":326,"props":42652,"children":42654},{"className":42653},[],[42655],{"type":55,"value":42575},{"type":55,"value":16370},{"type":49,"tag":326,"props":42658,"children":42660},{"className":42659},[],[42661],{"type":55,"value":19927},{"type":55,"value":745},{"type":49,"tag":58,"props":42664,"children":42665},{},[42666,42668,42674],{"type":55,"value":42667},"The very last step is to add the specific version of Python to a file called ",{"type":49,"tag":326,"props":42669,"children":42671},{"className":42670},[],[42672],{"type":55,"value":42673},"runtime.txt",{"type":55,"value":42536},{"type":49,"tag":1050,"props":42676,"children":42678},{"code":42677},"(proj) $ python -V\nPython 3.4.3\n(proj) $ echo \"python-3.4.3\" > runtime.txt\n",[42679],{"type":49,"tag":326,"props":42680,"children":42681},{"__ignoreMap":8},[42682],{"type":55,"value":42677},{"type":49,"tag":58,"props":42684,"children":42685},{},[42686],{"type":55,"value":42687},"Before we push to Heroku we need to change a setting on Heroku related to static files:",{"type":49,"tag":1050,"props":42689,"children":42691},{"code":42690},"(proj) $ heroku config:set DISABLE_COLLECTSTATIC=1\n",[42692],{"type":49,"tag":326,"props":42693,"children":42694},{"__ignoreMap":8},[42695],{"type":55,"value":42690},{"type":49,"tag":58,"props":42697,"children":42698},{},[42699],{"type":55,"value":42700},"Now we can finally push the git repository to Heroku:",{"type":49,"tag":1050,"props":42702,"children":42704},{"code":42703},"(proj) $ git push heroku master\n",[42705],{"type":49,"tag":326,"props":42706,"children":42707},{"__ignoreMap":8},[42708],{"type":55,"value":42703},{"type":49,"tag":58,"props":42710,"children":42711},{},[42712],{"type":55,"value":42713},"Now if we go to our site on heroku we should see:",{"type":49,"tag":1050,"props":42715,"children":42717},{"code":42716},"Not Found\n\nThe requested URL / was not found on this server.\n",[42718],{"type":49,"tag":326,"props":42719,"children":42720},{"__ignoreMap":8},[42721],{"type":55,"value":42716},{"type":49,"tag":58,"props":42723,"children":42724},{},[42725,42727,42733],{"type":55,"value":42726},"There is a helpful guide on deploying Python and Django apps on Heroku's website ",{"type":49,"tag":80,"props":42728,"children":42731},{"href":42729,"rel":42730},"https://devcenter.heroku.com/articles/deploying-python",[84],[42732],{"type":55,"value":8879},{"type":55,"value":745},{"type":49,"tag":58,"props":42735,"children":42736},{},[42737],{"type":55,"value":42738},"Here's an important excerpt regarding databases:",{"type":49,"tag":2910,"props":42740,"children":42741},{},[42742],{"type":49,"tag":58,"props":42743,"children":42744},{},[42745],{"type":55,"value":42746},"For Django applications, a Heroku Postgres hobby-dev database is automatically provisioned. This populates the DATABASE_URL environment variable.\nNo add-ons are automatically provisioned if a pure Python application is detected. If you need a SQL database for your app, add one explicitly:",{"type":49,"tag":1050,"props":42748,"children":42750},{"code":42749},"$ heroku addons:create heroku-postgresql:hobby-dev\n",[42751],{"type":49,"tag":326,"props":42752,"children":42753},{"__ignoreMap":8},[42754],{"type":55,"value":42749},{"type":49,"tag":58,"props":42756,"children":42757},{},[42758],{"type":55,"value":42759},"So we need to run this command:",{"type":49,"tag":1050,"props":42761,"children":42763},{"code":42762},"\n(proj) $ heroku addons:create heroku-postgresql:hobby-dev\n\n",[42764],{"type":49,"tag":326,"props":42765,"children":42766},{"__ignoreMap":8},[42767],{"type":55,"value":42762},{"type":49,"tag":58,"props":42769,"children":42770},{},[42771],{"type":55,"value":42772},"Next we need to access the terminal on our Heroku server:",{"type":49,"tag":1050,"props":42774,"children":42776},{"code":42775},"(proj) $ heroku run bash\n",[42777],{"type":49,"tag":326,"props":42778,"children":42779},{"__ignoreMap":8},[42780],{"type":55,"value":42775},{"type":49,"tag":58,"props":42782,"children":42783},{},[42784,42786,42791,42793,42798],{"type":55,"value":42785},"Next we need to add database-related information to ",{"type":49,"tag":326,"props":42787,"children":42789},{"className":42788},[],[42790],{"type":55,"value":42378},{"type":55,"value":42792}," under the ",{"type":49,"tag":326,"props":42794,"children":42796},{"className":42795},[],[42797],{"type":55,"value":20124},{"type":55,"value":42799}," section:",{"type":49,"tag":1050,"props":42801,"children":42803},{"code":42802,"language":28337,"meta":8,"className":28338,"style":8},"[...]\nimport dj_database_url\n\ndb_from_env = dj_database_url.config()\nDATABASES['default'].update(db_from_env)\n[...]\n",[42804],{"type":49,"tag":326,"props":42805,"children":42806},{"__ignoreMap":8},[42807,42822,42834,42841,42858,42879],{"type":49,"tag":1060,"props":42808,"children":42809},{"class":1062,"line":1063},[42810,42814,42818],{"type":49,"tag":1060,"props":42811,"children":42812},{"style":1073},[42813],{"type":55,"value":23394},{"type":49,"tag":1060,"props":42815,"children":42816},{"style":2287},[42817],{"type":55,"value":3078},{"type":49,"tag":1060,"props":42819,"children":42820},{"style":1073},[42821],{"type":55,"value":33153},{"type":49,"tag":1060,"props":42823,"children":42824},{"class":1062,"line":1079},[42825,42829],{"type":49,"tag":1060,"props":42826,"children":42827},{"style":2194},[42828],{"type":55,"value":22194},{"type":49,"tag":1060,"props":42830,"children":42831},{"style":1073},[42832],{"type":55,"value":42833}," dj_database_url\n",{"type":49,"tag":1060,"props":42835,"children":42836},{"class":1062,"line":1088},[42837],{"type":49,"tag":1060,"props":42838,"children":42839},{"emptyLinePlaceholder":44},[42840],{"type":55,"value":1094},{"type":49,"tag":1060,"props":42842,"children":42843},{"class":1062,"line":1097},[42844,42849,42853],{"type":49,"tag":1060,"props":42845,"children":42846},{"style":1073},[42847],{"type":55,"value":42848},"db_from_env ",{"type":49,"tag":1060,"props":42850,"children":42851},{"style":2194},[42852],{"type":55,"value":3068},{"type":49,"tag":1060,"props":42854,"children":42855},{"style":1073},[42856],{"type":55,"value":42857}," dj_database_url.config()\n",{"type":49,"tag":1060,"props":42859,"children":42860},{"class":1062,"line":1111},[42861,42865,42869,42874],{"type":49,"tag":1060,"props":42862,"children":42863},{"style":2287},[42864],{"type":55,"value":20124},{"type":49,"tag":1060,"props":42866,"children":42867},{"style":1073},[42868],{"type":55,"value":23394},{"type":49,"tag":1060,"props":42870,"children":42871},{"style":2215},[42872],{"type":55,"value":42873},"'default'",{"type":49,"tag":1060,"props":42875,"children":42876},{"style":1073},[42877],{"type":55,"value":42878},"].update(db_from_env)\n",{"type":49,"tag":1060,"props":42880,"children":42881},{"class":1062,"line":1120},[42882,42886,42890],{"type":49,"tag":1060,"props":42883,"children":42884},{"style":1073},[42885],{"type":55,"value":23394},{"type":49,"tag":1060,"props":42887,"children":42888},{"style":2287},[42889],{"type":55,"value":3078},{"type":49,"tag":1060,"props":42891,"children":42892},{"style":1073},[42893],{"type":55,"value":33153},{"type":49,"tag":58,"props":42895,"children":42896},{},[42897],{"type":55,"value":42898},"Now we can push to Heroku:",{"type":49,"tag":1050,"props":42900,"children":42901},{"code":42703},[42902],{"type":49,"tag":326,"props":42903,"children":42904},{"__ignoreMap":8},[42905],{"type":55,"value":42703},{"type":49,"tag":58,"props":42907,"children":42908},{},[42909],{"type":55,"value":42910},"Next we can run our migrations:",{"type":49,"tag":1050,"props":42912,"children":42914},{"code":42913},"(proj) $ heroku run python manage.py makemigrations\n",[42915],{"type":49,"tag":326,"props":42916,"children":42917},{"__ignoreMap":8},[42918],{"type":55,"value":42913},{"type":49,"tag":58,"props":42920,"children":42921},{},[42922,42924,42929,42930,42935],{"type":55,"value":42923},"Next we can run ",{"type":49,"tag":326,"props":42925,"children":42927},{"className":42926},[],[42928],{"type":55,"value":3323},{"type":55,"value":715},{"type":49,"tag":326,"props":42931,"children":42933},{"className":42932},[],[42934],{"type":55,"value":21930},{"type":55,"value":42936}," on our Heroku server:",{"type":49,"tag":1050,"props":42938,"children":42940},{"code":42939},"(proj) $ heroku run python manage.py migrate && heroku run python manage.py createsuperuser\n",[42941],{"type":49,"tag":326,"props":42942,"children":42943},{"__ignoreMap":8},[42944],{"type":55,"value":42939},{"type":49,"tag":58,"props":42946,"children":42947},{},[42948],{"type":55,"value":42949},"Now we should be able to login to the admin page with the account we just created, but CSS is still not working at this point. Here's how we configure static files to get CSS to work:",{"type":49,"tag":1050,"props":42951,"children":42953},{"code":42952},"(proj) $ pip install whitenoise\n",[42954],{"type":49,"tag":326,"props":42955,"children":42956},{"__ignoreMap":8},[42957],{"type":55,"value":42952},{"type":49,"tag":58,"props":42959,"children":42960},{},[42961,42967],{"type":49,"tag":326,"props":42962,"children":42964},{"className":42963},[],[42965],{"type":55,"value":42966},"whitenoise",{"type":55,"value":42968}," is needed so Heroku can run our static files.",{"type":49,"tag":58,"props":42970,"children":42971},{},[42972,42974,42979,42980,42985],{"type":55,"value":42973},"Next we want to make sure to include ",{"type":49,"tag":326,"props":42975,"children":42977},{"className":42976},[],[42978],{"type":55,"value":42966},{"type":55,"value":16370},{"type":49,"tag":326,"props":42981,"children":42983},{"className":42982},[],[42984],{"type":55,"value":14324},{"type":55,"value":6694},{"type":49,"tag":1050,"props":42987,"children":42988},{"code":42434},[42989],{"type":49,"tag":326,"props":42990,"children":42991},{"__ignoreMap":8},[42992],{"type":55,"value":42434},{"type":49,"tag":58,"props":42994,"children":42995},{},[42996,42998,43004,43006,43011,43013,43018,43020,43026],{"type":55,"value":42997},"Next we need to add the following item to the list of ",{"type":49,"tag":326,"props":42999,"children":43001},{"className":43000},[],[43002],{"type":55,"value":43003},"MIDDLEWARE",{"type":55,"value":43005}," components. This needs to be added to BOTH ",{"type":49,"tag":326,"props":43007,"children":43009},{"className":43008},[],[43010],{"type":55,"value":42378},{"type":55,"value":43012}," AND ",{"type":49,"tag":326,"props":43014,"children":43016},{"className":43015},[],[43017],{"type":55,"value":42356},{"type":55,"value":43019}," in order for the local files to show on both our heroku site and the locally served site with ",{"type":49,"tag":326,"props":43021,"children":43023},{"className":43022},[],[43024],{"type":55,"value":43025},"heroku local web",{"type":55,"value":6694},{"type":49,"tag":1050,"props":43028,"children":43030},{"code":43029,"language":55,"meta":8,"className":42487,"style":8},"MIDDLEWARE = [\n[...]\n'whitenoise.middleware.WhiteNoiseMiddleware',\n[...]\n]\n",[43031],{"type":49,"tag":326,"props":43032,"children":43033},{"__ignoreMap":8},[43034,43042,43050,43058,43065],{"type":49,"tag":1060,"props":43035,"children":43036},{"class":1062,"line":1063},[43037],{"type":49,"tag":1060,"props":43038,"children":43039},{},[43040],{"type":55,"value":43041},"MIDDLEWARE = [\n",{"type":49,"tag":1060,"props":43043,"children":43044},{"class":1062,"line":1079},[43045],{"type":49,"tag":1060,"props":43046,"children":43047},{},[43048],{"type":55,"value":43049},"[...]\n",{"type":49,"tag":1060,"props":43051,"children":43052},{"class":1062,"line":1088},[43053],{"type":49,"tag":1060,"props":43054,"children":43055},{},[43056],{"type":55,"value":43057},"'whitenoise.middleware.WhiteNoiseMiddleware',\n",{"type":49,"tag":1060,"props":43059,"children":43060},{"class":1062,"line":1097},[43061],{"type":49,"tag":1060,"props":43062,"children":43063},{},[43064],{"type":55,"value":43049},{"type":49,"tag":1060,"props":43066,"children":43067},{"class":1062,"line":1111},[43068],{"type":49,"tag":1060,"props":43069,"children":43070},{},[43071],{"type":55,"value":33153},{"type":49,"tag":58,"props":43073,"children":43074},{},[43075],{"type":55,"value":43076},"Next we have a few more items to add to our settings files:",{"type":49,"tag":58,"props":43078,"children":43079},{},[43080],{"type":49,"tag":126,"props":43081,"children":43082},{},[43083],{"type":55,"value":42378},{"type":49,"tag":1050,"props":43085,"children":43087},{"code":43086,"language":28337,"meta":8,"className":28338,"style":8},"\nSTATICFILES_DIRS = (\n    os.path.join(BASE_DIR, \"static\"),\n)\n\nSTATIC_ROOT = os.path.join(BASE_DIR, \"live-static\", \"static-root\")\n\nSTATICFILES_STORAGE = 'whitenoise.django.GzipManifestStaticFilesStorage'\n\n#STATIC_ROOT = \"/home/cfedeploy/webapps/cfehome_static_root/\"\n\nMEDIA_URL = \"/media/\"\n\nMEDIA_ROOT = os.path.join(BASE_DIR, \"live-static\", \"media-root\")\n\n",[43088],{"type":49,"tag":326,"props":43089,"children":43090},{"__ignoreMap":8},[43091,43098,43115,43139,43146,43153,43194,43201,43217,43224,43232,43239,43256,43263],{"type":49,"tag":1060,"props":43092,"children":43093},{"class":1062,"line":1063},[43094],{"type":49,"tag":1060,"props":43095,"children":43096},{"emptyLinePlaceholder":44},[43097],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43099,"children":43100},{"class":1062,"line":1079},[43101,43106,43110],{"type":49,"tag":1060,"props":43102,"children":43103},{"style":2287},[43104],{"type":55,"value":43105},"STATICFILES_DIRS",{"type":49,"tag":1060,"props":43107,"children":43108},{"style":2194},[43109],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43111,"children":43112},{"style":1073},[43113],{"type":55,"value":43114}," (\n",{"type":49,"tag":1060,"props":43116,"children":43117},{"class":1062,"line":1088},[43118,43123,43127,43131,43135],{"type":49,"tag":1060,"props":43119,"children":43120},{"style":1073},[43121],{"type":55,"value":43122},"    os.path.join(",{"type":49,"tag":1060,"props":43124,"children":43125},{"style":2287},[43126],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43128,"children":43129},{"style":1073},[43130],{"type":55,"value":873},{"type":49,"tag":1060,"props":43132,"children":43133},{"style":2215},[43134],{"type":55,"value":19969},{"type":49,"tag":1060,"props":43136,"children":43137},{"style":1073},[43138],{"type":55,"value":20221},{"type":49,"tag":1060,"props":43140,"children":43141},{"class":1062,"line":1097},[43142],{"type":49,"tag":1060,"props":43143,"children":43144},{"style":1073},[43145],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43147,"children":43148},{"class":1062,"line":1111},[43149],{"type":49,"tag":1060,"props":43150,"children":43151},{"emptyLinePlaceholder":44},[43152],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43154,"children":43155},{"class":1062,"line":1120},[43156,43160,43164,43168,43172,43176,43181,43185,43190],{"type":49,"tag":1060,"props":43157,"children":43158},{"style":2287},[43159],{"type":55,"value":19919},{"type":49,"tag":1060,"props":43161,"children":43162},{"style":2194},[43163],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43165,"children":43166},{"style":1073},[43167],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43169,"children":43170},{"style":2287},[43171],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43173,"children":43174},{"style":1073},[43175],{"type":55,"value":873},{"type":49,"tag":1060,"props":43177,"children":43178},{"style":2215},[43179],{"type":55,"value":43180},"\"live-static\"",{"type":49,"tag":1060,"props":43182,"children":43183},{"style":1073},[43184],{"type":55,"value":873},{"type":49,"tag":1060,"props":43186,"children":43187},{"style":2215},[43188],{"type":55,"value":43189},"\"static-root\"",{"type":49,"tag":1060,"props":43191,"children":43192},{"style":1073},[43193],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43195,"children":43196},{"class":1062,"line":1128},[43197],{"type":49,"tag":1060,"props":43198,"children":43199},{"emptyLinePlaceholder":44},[43200],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43202,"children":43203},{"class":1062,"line":1141},[43204,43208,43212],{"type":49,"tag":1060,"props":43205,"children":43206},{"style":2287},[43207],{"type":55,"value":24619},{"type":49,"tag":1060,"props":43209,"children":43210},{"style":2194},[43211],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43213,"children":43214},{"style":2215},[43215],{"type":55,"value":43216}," 'whitenoise.django.GzipManifestStaticFilesStorage'\n",{"type":49,"tag":1060,"props":43218,"children":43219},{"class":1062,"line":1150},[43220],{"type":49,"tag":1060,"props":43221,"children":43222},{"emptyLinePlaceholder":44},[43223],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43225,"children":43226},{"class":1062,"line":1158},[43227],{"type":49,"tag":1060,"props":43228,"children":43229},{"style":3039},[43230],{"type":55,"value":43231},"#STATIC_ROOT = \"/home/cfedeploy/webapps/cfehome_static_root/\"\n",{"type":49,"tag":1060,"props":43233,"children":43234},{"class":1062,"line":1171},[43235],{"type":49,"tag":1060,"props":43236,"children":43237},{"emptyLinePlaceholder":44},[43238],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43240,"children":43241},{"class":1062,"line":1180},[43242,43247,43251],{"type":49,"tag":1060,"props":43243,"children":43244},{"style":2287},[43245],{"type":55,"value":43246},"MEDIA_URL",{"type":49,"tag":1060,"props":43248,"children":43249},{"style":2194},[43250],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43252,"children":43253},{"style":2215},[43254],{"type":55,"value":43255}," \"/media/\"\n",{"type":49,"tag":1060,"props":43257,"children":43258},{"class":1062,"line":1188},[43259],{"type":49,"tag":1060,"props":43260,"children":43261},{"emptyLinePlaceholder":44},[43262],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43264,"children":43265},{"class":1062,"line":1201},[43266,43271,43275,43279,43283,43287,43291,43295,43300],{"type":49,"tag":1060,"props":43267,"children":43268},{"style":2287},[43269],{"type":55,"value":43270},"MEDIA_ROOT",{"type":49,"tag":1060,"props":43272,"children":43273},{"style":2194},[43274],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43276,"children":43277},{"style":1073},[43278],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43280,"children":43281},{"style":2287},[43282],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43284,"children":43285},{"style":1073},[43286],{"type":55,"value":873},{"type":49,"tag":1060,"props":43288,"children":43289},{"style":2215},[43290],{"type":55,"value":43180},{"type":49,"tag":1060,"props":43292,"children":43293},{"style":1073},[43294],{"type":55,"value":873},{"type":49,"tag":1060,"props":43296,"children":43297},{"style":2215},[43298],{"type":55,"value":43299},"\"media-root\"",{"type":49,"tag":1060,"props":43301,"children":43302},{"style":1073},[43303],{"type":55,"value":5126},{"type":49,"tag":58,"props":43305,"children":43306},{},[43307],{"type":55,"value":43308},"And we also need to add some files to our base directory that will hold our static files:",{"type":49,"tag":1050,"props":43310,"children":43312},{"code":43311},"(proj) $ mkdir static\n(proj) $ echo \"body {color:#000;}\" > static/main.css\n(proj) $ mkdir live-static\n(proj) $ mkdir live-static/static-root\n(proj) $ mkdir live-static/media-root\n(proj) $\n(proj) $\n\n",[43313],{"type":49,"tag":326,"props":43314,"children":43315},{"__ignoreMap":8},[43316],{"type":55,"value":43311},{"type":49,"tag":58,"props":43318,"children":43319},{},[43320,43322,43327],{"type":55,"value":43321},"And we also need to add the following to the end of ",{"type":49,"tag":326,"props":43323,"children":43325},{"className":43324},[],[43326],{"type":55,"value":42378},{"type":55,"value":6694},{"type":49,"tag":1050,"props":43329,"children":43331},{"code":43330,"language":28337,"meta":8,"className":28338,"style":8},"[...]\nSTATIC_URL = '/static/'\n\nSTATICFILES_DIRS = (\n    os.path.join(BASE_DIR, \"static\"),\n)\n\nSTATIC_ROOT = os.path.join(BASE_DIR, \"live-static\", \"static-root\")\n\nSTATICFILES_STORAGE = 'whitenoise.django.GzipManifestStaticFilesStorage'\n\n#STATIC_ROOT = \"/home/cfedeploy/webapps/cfehome_static_root/\"\n\nMEDIA_URL = \"/media/\"\n\nMEDIA_ROOT = os.path.join(BASE_DIR, \"live-static\", \"media-root\")\n",[43332],{"type":49,"tag":326,"props":43333,"children":43334},{"__ignoreMap":8},[43335,43350,43365,43372,43387,43410,43417,43424,43463,43470,43485,43492,43499,43506,43521,43528],{"type":49,"tag":1060,"props":43336,"children":43337},{"class":1062,"line":1063},[43338,43342,43346],{"type":49,"tag":1060,"props":43339,"children":43340},{"style":1073},[43341],{"type":55,"value":23394},{"type":49,"tag":1060,"props":43343,"children":43344},{"style":2287},[43345],{"type":55,"value":3078},{"type":49,"tag":1060,"props":43347,"children":43348},{"style":1073},[43349],{"type":55,"value":33153},{"type":49,"tag":1060,"props":43351,"children":43352},{"class":1062,"line":1079},[43353,43357,43361],{"type":49,"tag":1060,"props":43354,"children":43355},{"style":2287},[43356],{"type":55,"value":24569},{"type":49,"tag":1060,"props":43358,"children":43359},{"style":2194},[43360],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43362,"children":43363},{"style":2215},[43364],{"type":55,"value":24578},{"type":49,"tag":1060,"props":43366,"children":43367},{"class":1062,"line":1088},[43368],{"type":49,"tag":1060,"props":43369,"children":43370},{"emptyLinePlaceholder":44},[43371],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43373,"children":43374},{"class":1062,"line":1097},[43375,43379,43383],{"type":49,"tag":1060,"props":43376,"children":43377},{"style":2287},[43378],{"type":55,"value":43105},{"type":49,"tag":1060,"props":43380,"children":43381},{"style":2194},[43382],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43384,"children":43385},{"style":1073},[43386],{"type":55,"value":43114},{"type":49,"tag":1060,"props":43388,"children":43389},{"class":1062,"line":1111},[43390,43394,43398,43402,43406],{"type":49,"tag":1060,"props":43391,"children":43392},{"style":1073},[43393],{"type":55,"value":43122},{"type":49,"tag":1060,"props":43395,"children":43396},{"style":2287},[43397],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43399,"children":43400},{"style":1073},[43401],{"type":55,"value":873},{"type":49,"tag":1060,"props":43403,"children":43404},{"style":2215},[43405],{"type":55,"value":19969},{"type":49,"tag":1060,"props":43407,"children":43408},{"style":1073},[43409],{"type":55,"value":20221},{"type":49,"tag":1060,"props":43411,"children":43412},{"class":1062,"line":1120},[43413],{"type":49,"tag":1060,"props":43414,"children":43415},{"style":1073},[43416],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43418,"children":43419},{"class":1062,"line":1128},[43420],{"type":49,"tag":1060,"props":43421,"children":43422},{"emptyLinePlaceholder":44},[43423],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43425,"children":43426},{"class":1062,"line":1141},[43427,43431,43435,43439,43443,43447,43451,43455,43459],{"type":49,"tag":1060,"props":43428,"children":43429},{"style":2287},[43430],{"type":55,"value":19919},{"type":49,"tag":1060,"props":43432,"children":43433},{"style":2194},[43434],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43436,"children":43437},{"style":1073},[43438],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43440,"children":43441},{"style":2287},[43442],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43444,"children":43445},{"style":1073},[43446],{"type":55,"value":873},{"type":49,"tag":1060,"props":43448,"children":43449},{"style":2215},[43450],{"type":55,"value":43180},{"type":49,"tag":1060,"props":43452,"children":43453},{"style":1073},[43454],{"type":55,"value":873},{"type":49,"tag":1060,"props":43456,"children":43457},{"style":2215},[43458],{"type":55,"value":43189},{"type":49,"tag":1060,"props":43460,"children":43461},{"style":1073},[43462],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43464,"children":43465},{"class":1062,"line":1150},[43466],{"type":49,"tag":1060,"props":43467,"children":43468},{"emptyLinePlaceholder":44},[43469],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43471,"children":43472},{"class":1062,"line":1158},[43473,43477,43481],{"type":49,"tag":1060,"props":43474,"children":43475},{"style":2287},[43476],{"type":55,"value":24619},{"type":49,"tag":1060,"props":43478,"children":43479},{"style":2194},[43480],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43482,"children":43483},{"style":2215},[43484],{"type":55,"value":43216},{"type":49,"tag":1060,"props":43486,"children":43487},{"class":1062,"line":1171},[43488],{"type":49,"tag":1060,"props":43489,"children":43490},{"emptyLinePlaceholder":44},[43491],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43493,"children":43494},{"class":1062,"line":1180},[43495],{"type":49,"tag":1060,"props":43496,"children":43497},{"style":3039},[43498],{"type":55,"value":43231},{"type":49,"tag":1060,"props":43500,"children":43501},{"class":1062,"line":1188},[43502],{"type":49,"tag":1060,"props":43503,"children":43504},{"emptyLinePlaceholder":44},[43505],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43507,"children":43508},{"class":1062,"line":1201},[43509,43513,43517],{"type":49,"tag":1060,"props":43510,"children":43511},{"style":2287},[43512],{"type":55,"value":43246},{"type":49,"tag":1060,"props":43514,"children":43515},{"style":2194},[43516],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43518,"children":43519},{"style":2215},[43520],{"type":55,"value":43255},{"type":49,"tag":1060,"props":43522,"children":43523},{"class":1062,"line":1210},[43524],{"type":49,"tag":1060,"props":43525,"children":43526},{"emptyLinePlaceholder":44},[43527],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43529,"children":43530},{"class":1062,"line":1218},[43531,43535,43539,43543,43547,43551,43555,43559,43563],{"type":49,"tag":1060,"props":43532,"children":43533},{"style":2287},[43534],{"type":55,"value":43270},{"type":49,"tag":1060,"props":43536,"children":43537},{"style":2194},[43538],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43540,"children":43541},{"style":1073},[43542],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43544,"children":43545},{"style":2287},[43546],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43548,"children":43549},{"style":1073},[43550],{"type":55,"value":873},{"type":49,"tag":1060,"props":43552,"children":43553},{"style":2215},[43554],{"type":55,"value":43180},{"type":49,"tag":1060,"props":43556,"children":43557},{"style":1073},[43558],{"type":55,"value":873},{"type":49,"tag":1060,"props":43560,"children":43561},{"style":2215},[43562],{"type":55,"value":43299},{"type":49,"tag":1060,"props":43564,"children":43565},{"style":1073},[43566],{"type":55,"value":5126},{"type":49,"tag":58,"props":43568,"children":43569},{},[43570,43575,43576,43581],{"type":49,"tag":326,"props":43571,"children":43573},{"className":43572},[],[43574],{"type":55,"value":42356},{"type":55,"value":715},{"type":49,"tag":326,"props":43577,"children":43579},{"className":43578},[],[43580],{"type":55,"value":42371},{"type":55,"value":43582}," should have the following:",{"type":49,"tag":1050,"props":43584,"children":43586},{"code":43585,"language":28337,"meta":8,"className":28338,"style":8},"STATIC_URL = '/static/'\n\nSTATICFILES_DIRS = (\n    os.path.join(BASE_DIR, \"static\"),\n)\n\nSTATIC_ROOT = os.path.join(BASE_DIR, \"live-static\", \"static-root\")\n\nMEDIA_URL = \"/media/\"\n\nMEDIA_ROOT = os.path.join(BASE_DIR, \"live-static\", \"media-root\")\n",[43587],{"type":49,"tag":326,"props":43588,"children":43589},{"__ignoreMap":8},[43590,43605,43612,43627,43650,43657,43664,43703,43710,43725,43732],{"type":49,"tag":1060,"props":43591,"children":43592},{"class":1062,"line":1063},[43593,43597,43601],{"type":49,"tag":1060,"props":43594,"children":43595},{"style":2287},[43596],{"type":55,"value":24569},{"type":49,"tag":1060,"props":43598,"children":43599},{"style":2194},[43600],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43602,"children":43603},{"style":2215},[43604],{"type":55,"value":24578},{"type":49,"tag":1060,"props":43606,"children":43607},{"class":1062,"line":1079},[43608],{"type":49,"tag":1060,"props":43609,"children":43610},{"emptyLinePlaceholder":44},[43611],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43613,"children":43614},{"class":1062,"line":1088},[43615,43619,43623],{"type":49,"tag":1060,"props":43616,"children":43617},{"style":2287},[43618],{"type":55,"value":43105},{"type":49,"tag":1060,"props":43620,"children":43621},{"style":2194},[43622],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43624,"children":43625},{"style":1073},[43626],{"type":55,"value":43114},{"type":49,"tag":1060,"props":43628,"children":43629},{"class":1062,"line":1097},[43630,43634,43638,43642,43646],{"type":49,"tag":1060,"props":43631,"children":43632},{"style":1073},[43633],{"type":55,"value":43122},{"type":49,"tag":1060,"props":43635,"children":43636},{"style":2287},[43637],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43639,"children":43640},{"style":1073},[43641],{"type":55,"value":873},{"type":49,"tag":1060,"props":43643,"children":43644},{"style":2215},[43645],{"type":55,"value":19969},{"type":49,"tag":1060,"props":43647,"children":43648},{"style":1073},[43649],{"type":55,"value":20221},{"type":49,"tag":1060,"props":43651,"children":43652},{"class":1062,"line":1111},[43653],{"type":49,"tag":1060,"props":43654,"children":43655},{"style":1073},[43656],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43658,"children":43659},{"class":1062,"line":1120},[43660],{"type":49,"tag":1060,"props":43661,"children":43662},{"emptyLinePlaceholder":44},[43663],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43665,"children":43666},{"class":1062,"line":1128},[43667,43671,43675,43679,43683,43687,43691,43695,43699],{"type":49,"tag":1060,"props":43668,"children":43669},{"style":2287},[43670],{"type":55,"value":19919},{"type":49,"tag":1060,"props":43672,"children":43673},{"style":2194},[43674],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43676,"children":43677},{"style":1073},[43678],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43680,"children":43681},{"style":2287},[43682],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43684,"children":43685},{"style":1073},[43686],{"type":55,"value":873},{"type":49,"tag":1060,"props":43688,"children":43689},{"style":2215},[43690],{"type":55,"value":43180},{"type":49,"tag":1060,"props":43692,"children":43693},{"style":1073},[43694],{"type":55,"value":873},{"type":49,"tag":1060,"props":43696,"children":43697},{"style":2215},[43698],{"type":55,"value":43189},{"type":49,"tag":1060,"props":43700,"children":43701},{"style":1073},[43702],{"type":55,"value":5126},{"type":49,"tag":1060,"props":43704,"children":43705},{"class":1062,"line":1141},[43706],{"type":49,"tag":1060,"props":43707,"children":43708},{"emptyLinePlaceholder":44},[43709],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43711,"children":43712},{"class":1062,"line":1150},[43713,43717,43721],{"type":49,"tag":1060,"props":43714,"children":43715},{"style":2287},[43716],{"type":55,"value":43246},{"type":49,"tag":1060,"props":43718,"children":43719},{"style":2194},[43720],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43722,"children":43723},{"style":2215},[43724],{"type":55,"value":43255},{"type":49,"tag":1060,"props":43726,"children":43727},{"class":1062,"line":1158},[43728],{"type":49,"tag":1060,"props":43729,"children":43730},{"emptyLinePlaceholder":44},[43731],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43733,"children":43734},{"class":1062,"line":1171},[43735,43739,43743,43747,43751,43755,43759,43763,43767],{"type":49,"tag":1060,"props":43736,"children":43737},{"style":2287},[43738],{"type":55,"value":43270},{"type":49,"tag":1060,"props":43740,"children":43741},{"style":2194},[43742],{"type":55,"value":2197},{"type":49,"tag":1060,"props":43744,"children":43745},{"style":1073},[43746],{"type":55,"value":24594},{"type":49,"tag":1060,"props":43748,"children":43749},{"style":2287},[43750],{"type":55,"value":19951},{"type":49,"tag":1060,"props":43752,"children":43753},{"style":1073},[43754],{"type":55,"value":873},{"type":49,"tag":1060,"props":43756,"children":43757},{"style":2215},[43758],{"type":55,"value":43180},{"type":49,"tag":1060,"props":43760,"children":43761},{"style":1073},[43762],{"type":55,"value":873},{"type":49,"tag":1060,"props":43764,"children":43765},{"style":2215},[43766],{"type":55,"value":43299},{"type":49,"tag":1060,"props":43768,"children":43769},{"style":1073},[43770],{"type":55,"value":5126},{"type":49,"tag":58,"props":43772,"children":43773},{},[43774,43776,43781],{"type":55,"value":43775},"Next we want to run ",{"type":49,"tag":326,"props":43777,"children":43779},{"className":43778},[],[43780],{"type":55,"value":3316},{"type":55,"value":43782}," locally:",{"type":49,"tag":1050,"props":43784,"children":43786},{"code":43785},"(proj) $ python manage.py collectstatic\n",[43787],{"type":49,"tag":326,"props":43788,"children":43789},{"__ignoreMap":8},[43790],{"type":55,"value":43785},{"type":49,"tag":58,"props":43792,"children":43793},{},[43794,43796,43802],{"type":55,"value":43795},"We also want to add a blank file to ",{"type":49,"tag":326,"props":43797,"children":43799},{"className":43798},[],[43800],{"type":55,"value":43801},"live-static/media-root",{"type":55,"value":43803}," so that it becomes tracked in git:",{"type":49,"tag":1050,"props":43805,"children":43807},{"code":43806},"(proj) $ echo \"some text\" > live-static/media-root/blank.txt\n",[43808],{"type":49,"tag":326,"props":43809,"children":43810},{"__ignoreMap":8},[43811],{"type":55,"value":43806},{"type":49,"tag":58,"props":43813,"children":43814},{},[43815,43817,43823,43824,43829],{"type":55,"value":43816},"Next we can commit these changes and push to Heroku, and check to see if the static files are working in the admin panel. We also want to set ",{"type":49,"tag":326,"props":43818,"children":43820},{"className":43819},[],[43821],{"type":55,"value":43822},"DISABLE_COLLECTSTATIC",{"type":55,"value":12789},{"type":49,"tag":326,"props":43825,"children":43827},{"className":43826},[],[43828],{"type":55,"value":8397},{"type":55,"value":6694},{"type":49,"tag":1050,"props":43831,"children":43833},{"code":43832},"(proj) $ git add --all\n(proj) $ git commit -m \"added static files\"\n(proj) $ git push heroku master\n(proj) $ heroku config:set DISABLE_COLLECTSTATIC=0\n",[43834],{"type":49,"tag":326,"props":43835,"children":43836},{"__ignoreMap":8},[43837],{"type":55,"value":43832},{"type":49,"tag":58,"props":43839,"children":43840},{},[43841],{"type":55,"value":43842},"Now we should be able to see the admin panel with working CSS on both the live and local heroku sites.",{"type":49,"tag":1757,"props":43844,"children":43846},{"id":43845},"adding-an-app-and-configuring-bootstrap",[43847],{"type":55,"value":43848},"Adding an app and configuring Bootstrap",{"type":49,"tag":58,"props":43850,"children":43851},{},[43852],{"type":55,"value":43853},"Now that everything seems to be working we can start building our app.",{"type":49,"tag":58,"props":43855,"children":43856},{},[43857],{"type":55,"value":43858},"Let's start by creating a new app:",{"type":49,"tag":1050,"props":43860,"children":43862},{"code":43861},"(proj) $ python manage.py startapp pages\n",[43863],{"type":49,"tag":326,"props":43864,"children":43865},{"__ignoreMap":8},[43866],{"type":55,"value":43861},{"type":49,"tag":58,"props":43868,"children":43869},{},[43870,43876],{"type":49,"tag":326,"props":43871,"children":43873},{"className":43872},[],[43874],{"type":55,"value":43875},"pages",{"type":55,"value":43877}," will be the name of an app that we create here.",{"type":49,"tag":58,"props":43879,"children":43880},{},[43881,43883,43889],{"type":55,"value":43882},"In ",{"type":49,"tag":326,"props":43884,"children":43886},{"className":43885},[],[43887],{"type":55,"value":43888},"pages/views.py",{"type":55,"value":43890}," we can add a class-based view that will serve as the homepage:",{"type":49,"tag":1050,"props":43892,"children":43894},{"code":43893,"language":28337,"meta":8,"className":28338,"style":8},"from django.shortcuts import render\nfrom django.views.generic import View\n# Create your views here.\n\nclass HomeView(View):\n    def get(self, request, *args, **kwargs):\n        return render(request, 'pages/home.html', {})\n\n",[43895],{"type":49,"tag":326,"props":43896,"children":43897},{"__ignoreMap":8},[43898,43919,43940,43948,43955,43980,44037],{"type":49,"tag":1060,"props":43899,"children":43900},{"class":1062,"line":1063},[43901,43905,43910,43914],{"type":49,"tag":1060,"props":43902,"children":43903},{"style":2194},[43904],{"type":55,"value":22184},{"type":49,"tag":1060,"props":43906,"children":43907},{"style":1073},[43908],{"type":55,"value":43909}," django.shortcuts ",{"type":49,"tag":1060,"props":43911,"children":43912},{"style":2194},[43913],{"type":55,"value":22194},{"type":49,"tag":1060,"props":43915,"children":43916},{"style":1073},[43917],{"type":55,"value":43918}," render\n",{"type":49,"tag":1060,"props":43920,"children":43921},{"class":1062,"line":1079},[43922,43926,43931,43935],{"type":49,"tag":1060,"props":43923,"children":43924},{"style":2194},[43925],{"type":55,"value":22184},{"type":49,"tag":1060,"props":43927,"children":43928},{"style":1073},[43929],{"type":55,"value":43930}," django.views.generic ",{"type":49,"tag":1060,"props":43932,"children":43933},{"style":2194},[43934],{"type":55,"value":22194},{"type":49,"tag":1060,"props":43936,"children":43937},{"style":1073},[43938],{"type":55,"value":43939}," View\n",{"type":49,"tag":1060,"props":43941,"children":43942},{"class":1062,"line":1088},[43943],{"type":49,"tag":1060,"props":43944,"children":43945},{"style":3039},[43946],{"type":55,"value":43947},"# Create your views here.\n",{"type":49,"tag":1060,"props":43949,"children":43950},{"class":1062,"line":1097},[43951],{"type":49,"tag":1060,"props":43952,"children":43953},{"emptyLinePlaceholder":44},[43954],{"type":55,"value":1094},{"type":49,"tag":1060,"props":43956,"children":43957},{"class":1062,"line":1111},[43958,43962,43967,43971,43976],{"type":49,"tag":1060,"props":43959,"children":43960},{"style":2182},[43961],{"type":55,"value":31987},{"type":49,"tag":1060,"props":43963,"children":43964},{"style":3992},[43965],{"type":55,"value":43966}," HomeView",{"type":49,"tag":1060,"props":43968,"children":43969},{"style":1073},[43970],{"type":55,"value":2284},{"type":49,"tag":1060,"props":43972,"children":43973},{"style":31999},[43974],{"type":55,"value":43975},"View",{"type":49,"tag":1060,"props":43977,"children":43978},{"style":1073},[43979],{"type":55,"value":22242},{"type":49,"tag":1060,"props":43981,"children":43982},{"class":1062,"line":1120},[43983,43987,43992,43996,44000,44004,44008,44012,44016,44021,44025,44029,44033],{"type":49,"tag":1060,"props":43984,"children":43985},{"style":2182},[43986],{"type":55,"value":32021},{"type":49,"tag":1060,"props":43988,"children":43989},{"style":1067},[43990],{"type":55,"value":43991}," get",{"type":49,"tag":1060,"props":43993,"children":43994},{"style":1073},[43995],{"type":55,"value":2284},{"type":49,"tag":1060,"props":43997,"children":43998},{"style":22226},[43999],{"type":55,"value":22963},{"type":49,"tag":1060,"props":44001,"children":44002},{"style":1073},[44003],{"type":55,"value":873},{"type":49,"tag":1060,"props":44005,"children":44006},{"style":22226},[44007],{"type":55,"value":33221},{"type":49,"tag":1060,"props":44009,"children":44010},{"style":1073},[44011],{"type":55,"value":873},{"type":49,"tag":1060,"props":44013,"children":44014},{"style":2194},[44015],{"type":55,"value":22608},{"type":49,"tag":1060,"props":44017,"children":44018},{"style":22226},[44019],{"type":55,"value":44020},"args",{"type":49,"tag":1060,"props":44022,"children":44023},{"style":1073},[44024],{"type":55,"value":873},{"type":49,"tag":1060,"props":44026,"children":44027},{"style":2194},[44028],{"type":55,"value":23506},{"type":49,"tag":1060,"props":44030,"children":44031},{"style":22226},[44032],{"type":55,"value":32073},{"type":49,"tag":1060,"props":44034,"children":44035},{"style":1073},[44036],{"type":55,"value":22242},{"type":49,"tag":1060,"props":44038,"children":44039},{"class":1062,"line":1128},[44040,44044,44048,44053],{"type":49,"tag":1060,"props":44041,"children":44042},{"style":2194},[44043],{"type":55,"value":22346},{"type":49,"tag":1060,"props":44045,"children":44046},{"style":1073},[44047],{"type":55,"value":33598},{"type":49,"tag":1060,"props":44049,"children":44050},{"style":2215},[44051],{"type":55,"value":44052},"'pages/home.html'",{"type":49,"tag":1060,"props":44054,"children":44055},{"style":1073},[44056],{"type":55,"value":44057},", {})\n",{"type":49,"tag":58,"props":44059,"children":44060},{},[44061,44063,44068],{"type":55,"value":44062},"We then update ",{"type":49,"tag":326,"props":44064,"children":44066},{"className":44065},[],[44067],{"type":55,"value":25845},{"type":55,"value":44069}," to include our new view:",{"type":49,"tag":1050,"props":44071,"children":44073},{"code":44072,"language":28337,"meta":8,"className":28338,"style":8},"from django.conf.urls import url\nfrom django.contrib import admin\nfrom services.views import HomeView\n\nurlpatterns = [\n    url(r'^admin/', admin.site.urls),\n    url(r'^$', HomeView.as_view(), name='home'),\n]\n\n",[44074],{"type":49,"tag":326,"props":44075,"children":44076},{"__ignoreMap":8},[44077,44098,44119,44140,44147,44164,44203,44249],{"type":49,"tag":1060,"props":44078,"children":44079},{"class":1062,"line":1063},[44080,44084,44089,44093],{"type":49,"tag":1060,"props":44081,"children":44082},{"style":2194},[44083],{"type":55,"value":22184},{"type":49,"tag":1060,"props":44085,"children":44086},{"style":1073},[44087],{"type":55,"value":44088}," django.conf.urls ",{"type":49,"tag":1060,"props":44090,"children":44091},{"style":2194},[44092],{"type":55,"value":22194},{"type":49,"tag":1060,"props":44094,"children":44095},{"style":1073},[44096],{"type":55,"value":44097}," url\n",{"type":49,"tag":1060,"props":44099,"children":44100},{"class":1062,"line":1079},[44101,44105,44110,44114],{"type":49,"tag":1060,"props":44102,"children":44103},{"style":2194},[44104],{"type":55,"value":22184},{"type":49,"tag":1060,"props":44106,"children":44107},{"style":1073},[44108],{"type":55,"value":44109}," django.contrib ",{"type":49,"tag":1060,"props":44111,"children":44112},{"style":2194},[44113],{"type":55,"value":22194},{"type":49,"tag":1060,"props":44115,"children":44116},{"style":1073},[44117],{"type":55,"value":44118}," admin\n",{"type":49,"tag":1060,"props":44120,"children":44121},{"class":1062,"line":1088},[44122,44126,44131,44135],{"type":49,"tag":1060,"props":44123,"children":44124},{"style":2194},[44125],{"type":55,"value":22184},{"type":49,"tag":1060,"props":44127,"children":44128},{"style":1073},[44129],{"type":55,"value":44130}," services.views ",{"type":49,"tag":1060,"props":44132,"children":44133},{"style":2194},[44134],{"type":55,"value":22194},{"type":49,"tag":1060,"props":44136,"children":44137},{"style":1073},[44138],{"type":55,"value":44139}," HomeView\n",{"type":49,"tag":1060,"props":44141,"children":44142},{"class":1062,"line":1097},[44143],{"type":49,"tag":1060,"props":44144,"children":44145},{"emptyLinePlaceholder":44},[44146],{"type":55,"value":1094},{"type":49,"tag":1060,"props":44148,"children":44149},{"class":1062,"line":1111},[44150,44155,44159],{"type":49,"tag":1060,"props":44151,"children":44152},{"style":1073},[44153],{"type":55,"value":44154},"urlpatterns ",{"type":49,"tag":1060,"props":44156,"children":44157},{"style":2194},[44158],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44160,"children":44161},{"style":1073},[44162],{"type":55,"value":44163}," [\n",{"type":49,"tag":1060,"props":44165,"children":44166},{"class":1062,"line":1120},[44167,44172,44177,44182,44188,44194,44198],{"type":49,"tag":1060,"props":44168,"children":44169},{"style":1073},[44170],{"type":55,"value":44171},"    url(",{"type":49,"tag":1060,"props":44173,"children":44174},{"style":2182},[44175],{"type":55,"value":44176},"r",{"type":49,"tag":1060,"props":44178,"children":44179},{"style":2215},[44180],{"type":55,"value":44181},"'",{"type":49,"tag":1060,"props":44183,"children":44185},{"style":44184},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#E6DB74",[44186],{"type":55,"value":44187},"^",{"type":49,"tag":1060,"props":44189,"children":44191},{"style":44190},"--shiki-default:#032F62;--shiki-dark:#DBEDFF;--shiki-sepia:#E6DB74",[44192],{"type":55,"value":44193},"admin/",{"type":49,"tag":1060,"props":44195,"children":44196},{"style":2215},[44197],{"type":55,"value":44181},{"type":49,"tag":1060,"props":44199,"children":44200},{"style":1073},[44201],{"type":55,"value":44202},", admin.site.urls),\n",{"type":49,"tag":1060,"props":44204,"children":44205},{"class":1062,"line":1128},[44206,44210,44214,44218,44223,44227,44232,44236,44240,44245],{"type":49,"tag":1060,"props":44207,"children":44208},{"style":1073},[44209],{"type":55,"value":44171},{"type":49,"tag":1060,"props":44211,"children":44212},{"style":2182},[44213],{"type":55,"value":44176},{"type":49,"tag":1060,"props":44215,"children":44216},{"style":2215},[44217],{"type":55,"value":44181},{"type":49,"tag":1060,"props":44219,"children":44220},{"style":44184},[44221],{"type":55,"value":44222},"^$",{"type":49,"tag":1060,"props":44224,"children":44225},{"style":2215},[44226],{"type":55,"value":44181},{"type":49,"tag":1060,"props":44228,"children":44229},{"style":1073},[44230],{"type":55,"value":44231},", HomeView.as_view(), ",{"type":49,"tag":1060,"props":44233,"children":44234},{"style":22635},[44235],{"type":55,"value":3735},{"type":49,"tag":1060,"props":44237,"children":44238},{"style":2194},[44239],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44241,"children":44242},{"style":2215},[44243],{"type":55,"value":44244},"'home'",{"type":49,"tag":1060,"props":44246,"children":44247},{"style":1073},[44248],{"type":55,"value":20221},{"type":49,"tag":1060,"props":44250,"children":44251},{"class":1062,"line":1141},[44252],{"type":49,"tag":1060,"props":44253,"children":44254},{"style":1073},[44255],{"type":55,"value":33153},{"type":49,"tag":58,"props":44257,"children":44258},{},[44259,44261,44266,44267,44273,44275,44280,44281,44286],{"type":55,"value":44260},"Next we have to add ",{"type":49,"tag":326,"props":44262,"children":44264},{"className":44263},[],[44265],{"type":55,"value":43875},{"type":55,"value":12789},{"type":49,"tag":326,"props":44268,"children":44270},{"className":44269},[],[44271],{"type":55,"value":44272},"INSTALLED_APPS",{"type":55,"value":44274}," in both ",{"type":49,"tag":326,"props":44276,"children":44278},{"className":44277},[],[44279],{"type":55,"value":42378},{"type":55,"value":715},{"type":49,"tag":326,"props":44282,"children":44284},{"className":44283},[],[44285],{"type":55,"value":42371},{"type":55,"value":745},{"type":49,"tag":58,"props":44288,"children":44289},{},[44290,44292,44297],{"type":55,"value":44291},"Next we need to make some folders within our new ",{"type":49,"tag":326,"props":44293,"children":44295},{"className":44294},[],[44296],{"type":55,"value":43875},{"type":55,"value":44298}," app:",{"type":49,"tag":1050,"props":44300,"children":44302},{"code":44301},"(proj) $ mkdir page/templates && cd pages/templates\n(proj) $ mkdir pages\n(proj) $ touch home.html\n",[44303],{"type":49,"tag":326,"props":44304,"children":44305},{"__ignoreMap":8},[44306],{"type":55,"value":44301},{"type":49,"tag":58,"props":44308,"children":44309},{},[44310,44312,44318],{"type":55,"value":44311},"Then we need to add the following to ",{"type":49,"tag":326,"props":44313,"children":44315},{"className":44314},[],[44316],{"type":55,"value":44317},"home.html",{"type":55,"value":6694},{"type":49,"tag":1050,"props":44320,"children":44322},{"code":44321,"language":33977,"meta":8,"className":33978,"style":8},"{% extends \"base.html\" %} {% block content %} {% endblock content%}\n",[44323],{"type":49,"tag":326,"props":44324,"children":44325},{"__ignoreMap":8},[44326],{"type":49,"tag":1060,"props":44327,"children":44328},{"class":1062,"line":1063},[44329],{"type":49,"tag":1060,"props":44330,"children":44331},{"style":1073},[44332],{"type":55,"value":44321},{"type":49,"tag":58,"props":44334,"children":44335},{},[44336,44338,44343,44344,44350,44351,44356,44357,44362,44363,44368],{"type":55,"value":44337},"Next we need to update ",{"type":49,"tag":326,"props":44339,"children":44341},{"className":44340},[],[44342],{"type":55,"value":41429},{"type":55,"value":16370},{"type":49,"tag":326,"props":44345,"children":44347},{"className":44346},[],[44348],{"type":55,"value":44349},"TEMPLATES",{"type":55,"value":16370},{"type":49,"tag":326,"props":44352,"children":44354},{"className":44353},[],[44355],{"type":55,"value":42356},{"type":55,"value":873},{"type":49,"tag":326,"props":44358,"children":44360},{"className":44359},[],[44361],{"type":55,"value":42371},{"type":55,"value":715},{"type":49,"tag":326,"props":44364,"children":44366},{"className":44365},[],[44367],{"type":55,"value":42378},{"type":55,"value":6694},{"type":49,"tag":1050,"props":44370,"children":44372},{"code":44371,"language":28337,"meta":8,"className":28338,"style":8},"[...]\n'DIRS': [os.path.join(BASE_DIR, 'templates')],\n[...]\n",[44373],{"type":49,"tag":326,"props":44374,"children":44375},{"__ignoreMap":8},[44376,44391,44421],{"type":49,"tag":1060,"props":44377,"children":44378},{"class":1062,"line":1063},[44379,44383,44387],{"type":49,"tag":1060,"props":44380,"children":44381},{"style":1073},[44382],{"type":55,"value":23394},{"type":49,"tag":1060,"props":44384,"children":44385},{"style":2287},[44386],{"type":55,"value":3078},{"type":49,"tag":1060,"props":44388,"children":44389},{"style":1073},[44390],{"type":55,"value":33153},{"type":49,"tag":1060,"props":44392,"children":44393},{"class":1062,"line":1079},[44394,44399,44404,44408,44412,44417],{"type":49,"tag":1060,"props":44395,"children":44396},{"style":2215},[44397],{"type":55,"value":44398},"'DIRS'",{"type":49,"tag":1060,"props":44400,"children":44401},{"style":1073},[44402],{"type":55,"value":44403},": [os.path.join(",{"type":49,"tag":1060,"props":44405,"children":44406},{"style":2287},[44407],{"type":55,"value":19951},{"type":49,"tag":1060,"props":44409,"children":44410},{"style":1073},[44411],{"type":55,"value":873},{"type":49,"tag":1060,"props":44413,"children":44414},{"style":2215},[44415],{"type":55,"value":44416},"'templates'",{"type":49,"tag":1060,"props":44418,"children":44419},{"style":1073},[44420],{"type":55,"value":29860},{"type":49,"tag":1060,"props":44422,"children":44423},{"class":1062,"line":1088},[44424,44428,44432],{"type":49,"tag":1060,"props":44425,"children":44426},{"style":1073},[44427],{"type":55,"value":23394},{"type":49,"tag":1060,"props":44429,"children":44430},{"style":2287},[44431],{"type":55,"value":3078},{"type":49,"tag":1060,"props":44433,"children":44434},{"style":1073},[44435],{"type":55,"value":33153},{"type":49,"tag":58,"props":44437,"children":44438},{},[44439,44441,44447],{"type":55,"value":44440},"Next we need to add a ",{"type":49,"tag":326,"props":44442,"children":44444},{"className":44443},[],[44445],{"type":55,"value":44446},"templates",{"type":55,"value":44448}," folder to the root of our project:",{"type":49,"tag":1050,"props":44450,"children":44452},{"code":44451},"(proj) $ mkdir templates\n(proj) $ touch tempates/base.html\n",[44453],{"type":49,"tag":326,"props":44454,"children":44455},{"__ignoreMap":8},[44456],{"type":55,"value":44451},{"type":49,"tag":58,"props":44458,"children":44459},{},[44460,44462,44468],{"type":55,"value":44461},"Next we can add a basic Bootstrap template to ",{"type":49,"tag":326,"props":44463,"children":44465},{"className":44464},[],[44466],{"type":55,"value":44467},"base.html",{"type":55,"value":6694},{"type":49,"tag":1050,"props":44470,"children":44472},{"code":44471,"language":33977,"meta":8,"className":33978,"style":8},"\u003C!DOCTYPE html>\n\u003Chtml lang=\"en\">\n  \u003Chead>\n    \u003Cmeta charset=\"utf-8\" />\n    \u003Cmeta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    \u003Cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    \u003C!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->\n    \u003Ctitle>Bootstrap 101 Template\u003C/title>\n\n    \u003C!-- Latest compiled and minified CSS -->\n    \u003Clink\n      rel=\"stylesheet\"\n      href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\"\n      integrity=\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\"\n      crossorigin=\"anonymous\"\n    />\n\n    \u003C!-- Optional theme -->\n    \u003Clink\n      rel=\"stylesheet\"\n      href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css\"\n      integrity=\"sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp\"\n      crossorigin=\"anonymous\"\n    />\n\n    \u003C!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->\n    \u003C!-- WARNING: Respond.js doesn't work if you view the page via file:// -->\n    \u003C!--[if lt IE 9]>\n      \u003Cscript src=\"https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js\">\u003C/script>\n      \u003Cscript src=\"https://oss.maxcdn.com/respond/1.4.2/respond.min.js\">\u003C/script>\n    \u003C![endif]-->\n  \u003C/head>\n  \u003Cbody>\n    \u003Ch1>Hello, world!\u003C/h1>\n\n    \u003C!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->\n    \u003Cscript src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js\">\u003C/script>\n    \u003C!-- Include all compiled plugins (below), or include individual files as needed -->\n    \u003C!-- Latest compiled and minified JavaScript -->\n    \u003Cscript\n      src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js\"\n      integrity=\"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa\"\n      crossorigin=\"anonymous\"\n    >\u003C/script>\n  \u003C/body>\n\u003C/html>\n",[44473],{"type":49,"tag":326,"props":44474,"children":44475},{"__ignoreMap":8},[44476,44498,44527,44543,44573,44616,44657,44665,44689,44696,44704,44716,44733,44750,44767,44784,44792,44799,44807,44818,44833,44849,44865,44880,44887,44894,44902,44910,44918,44926,44934,44942,44957,44973,44997,45004,45012,45049,45057,45065,45077,45094,45110,45125,45141,45156],{"type":49,"tag":1060,"props":44477,"children":44478},{"class":1062,"line":1063},[44479,44484,44489,44494],{"type":49,"tag":1060,"props":44480,"children":44481},{"style":1073},[44482],{"type":55,"value":44483},"\u003C!",{"type":49,"tag":1060,"props":44485,"children":44486},{"style":3839},[44487],{"type":55,"value":44488},"DOCTYPE",{"type":49,"tag":1060,"props":44490,"children":44491},{"style":1067},[44492],{"type":55,"value":44493}," html",{"type":49,"tag":1060,"props":44495,"children":44496},{"style":1073},[44497],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44499,"children":44500},{"class":1062,"line":1079},[44501,44505,44509,44514,44518,44523],{"type":49,"tag":1060,"props":44502,"children":44503},{"style":1073},[44504],{"type":55,"value":5197},{"type":49,"tag":1060,"props":44506,"children":44507},{"style":3839},[44508],{"type":55,"value":33977},{"type":49,"tag":1060,"props":44510,"children":44511},{"style":1067},[44512],{"type":55,"value":44513}," lang",{"type":49,"tag":1060,"props":44515,"children":44516},{"style":1073},[44517],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44519,"children":44520},{"style":2215},[44521],{"type":55,"value":44522},"\"en\"",{"type":49,"tag":1060,"props":44524,"children":44525},{"style":1073},[44526],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44528,"children":44529},{"class":1062,"line":1088},[44530,44534,44539],{"type":49,"tag":1060,"props":44531,"children":44532},{"style":1073},[44533],{"type":55,"value":35573},{"type":49,"tag":1060,"props":44535,"children":44536},{"style":3839},[44537],{"type":55,"value":44538},"head",{"type":49,"tag":1060,"props":44540,"children":44541},{"style":1073},[44542],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44544,"children":44545},{"class":1062,"line":1097},[44546,44550,44555,44560,44564,44569],{"type":49,"tag":1060,"props":44547,"children":44548},{"style":1073},[44549],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44551,"children":44552},{"style":3839},[44553],{"type":55,"value":44554},"meta",{"type":49,"tag":1060,"props":44556,"children":44557},{"style":1067},[44558],{"type":55,"value":44559}," charset",{"type":49,"tag":1060,"props":44561,"children":44562},{"style":1073},[44563],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44565,"children":44566},{"style":2215},[44567],{"type":55,"value":44568},"\"utf-8\"",{"type":49,"tag":1060,"props":44570,"children":44571},{"style":1073},[44572],{"type":55,"value":35624},{"type":49,"tag":1060,"props":44574,"children":44575},{"class":1062,"line":1111},[44576,44580,44584,44589,44593,44598,44603,44607,44612],{"type":49,"tag":1060,"props":44577,"children":44578},{"style":1073},[44579],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44581,"children":44582},{"style":3839},[44583],{"type":55,"value":44554},{"type":49,"tag":1060,"props":44585,"children":44586},{"style":1067},[44587],{"type":55,"value":44588}," http-equiv",{"type":49,"tag":1060,"props":44590,"children":44591},{"style":1073},[44592],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44594,"children":44595},{"style":2215},[44596],{"type":55,"value":44597},"\"X-UA-Compatible\"",{"type":49,"tag":1060,"props":44599,"children":44600},{"style":1067},[44601],{"type":55,"value":44602}," content",{"type":49,"tag":1060,"props":44604,"children":44605},{"style":1073},[44606],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44608,"children":44609},{"style":2215},[44610],{"type":55,"value":44611},"\"IE=edge\"",{"type":49,"tag":1060,"props":44613,"children":44614},{"style":1073},[44615],{"type":55,"value":35624},{"type":49,"tag":1060,"props":44617,"children":44618},{"class":1062,"line":1120},[44619,44623,44627,44631,44635,44640,44644,44648,44653],{"type":49,"tag":1060,"props":44620,"children":44621},{"style":1073},[44622],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44624,"children":44625},{"style":3839},[44626],{"type":55,"value":44554},{"type":49,"tag":1060,"props":44628,"children":44629},{"style":1067},[44630],{"type":55,"value":35610},{"type":49,"tag":1060,"props":44632,"children":44633},{"style":1073},[44634],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44636,"children":44637},{"style":2215},[44638],{"type":55,"value":44639},"\"viewport\"",{"type":49,"tag":1060,"props":44641,"children":44642},{"style":1067},[44643],{"type":55,"value":44602},{"type":49,"tag":1060,"props":44645,"children":44646},{"style":1073},[44647],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44649,"children":44650},{"style":2215},[44651],{"type":55,"value":44652},"\"width=device-width, initial-scale=1\"",{"type":49,"tag":1060,"props":44654,"children":44655},{"style":1073},[44656],{"type":55,"value":35624},{"type":49,"tag":1060,"props":44658,"children":44659},{"class":1062,"line":1128},[44660],{"type":49,"tag":1060,"props":44661,"children":44662},{"style":3039},[44663],{"type":55,"value":44664},"    \u003C!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->\n",{"type":49,"tag":1060,"props":44666,"children":44667},{"class":1062,"line":1141},[44668,44672,44676,44681,44685],{"type":49,"tag":1060,"props":44669,"children":44670},{"style":1073},[44671],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44673,"children":44674},{"style":3839},[44675],{"type":55,"value":39603},{"type":49,"tag":1060,"props":44677,"children":44678},{"style":1073},[44679],{"type":55,"value":44680},">Bootstrap 101 Template\u003C/",{"type":49,"tag":1060,"props":44682,"children":44683},{"style":3839},[44684],{"type":55,"value":39603},{"type":49,"tag":1060,"props":44686,"children":44687},{"style":1073},[44688],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44690,"children":44691},{"class":1062,"line":1150},[44692],{"type":49,"tag":1060,"props":44693,"children":44694},{"emptyLinePlaceholder":44},[44695],{"type":55,"value":1094},{"type":49,"tag":1060,"props":44697,"children":44698},{"class":1062,"line":1158},[44699],{"type":49,"tag":1060,"props":44700,"children":44701},{"style":3039},[44702],{"type":55,"value":44703},"    \u003C!-- Latest compiled and minified CSS -->\n",{"type":49,"tag":1060,"props":44705,"children":44706},{"class":1062,"line":1171},[44707,44711],{"type":49,"tag":1060,"props":44708,"children":44709},{"style":1073},[44710],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44712,"children":44713},{"style":3839},[44714],{"type":55,"value":44715},"link\n",{"type":49,"tag":1060,"props":44717,"children":44718},{"class":1062,"line":1180},[44719,44724,44728],{"type":49,"tag":1060,"props":44720,"children":44721},{"style":1067},[44722],{"type":55,"value":44723},"      rel",{"type":49,"tag":1060,"props":44725,"children":44726},{"style":1073},[44727],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44729,"children":44730},{"style":2215},[44731],{"type":55,"value":44732},"\"stylesheet\"\n",{"type":49,"tag":1060,"props":44734,"children":44735},{"class":1062,"line":1188},[44736,44741,44745],{"type":49,"tag":1060,"props":44737,"children":44738},{"style":1067},[44739],{"type":55,"value":44740},"      href",{"type":49,"tag":1060,"props":44742,"children":44743},{"style":1073},[44744],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44746,"children":44747},{"style":2215},[44748],{"type":55,"value":44749},"\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\"\n",{"type":49,"tag":1060,"props":44751,"children":44752},{"class":1062,"line":1201},[44753,44758,44762],{"type":49,"tag":1060,"props":44754,"children":44755},{"style":1067},[44756],{"type":55,"value":44757},"      integrity",{"type":49,"tag":1060,"props":44759,"children":44760},{"style":1073},[44761],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44763,"children":44764},{"style":2215},[44765],{"type":55,"value":44766},"\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\"\n",{"type":49,"tag":1060,"props":44768,"children":44769},{"class":1062,"line":1210},[44770,44775,44779],{"type":49,"tag":1060,"props":44771,"children":44772},{"style":1067},[44773],{"type":55,"value":44774},"      crossorigin",{"type":49,"tag":1060,"props":44776,"children":44777},{"style":1073},[44778],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44780,"children":44781},{"style":2215},[44782],{"type":55,"value":44783},"\"anonymous\"\n",{"type":49,"tag":1060,"props":44785,"children":44786},{"class":1062,"line":1218},[44787],{"type":49,"tag":1060,"props":44788,"children":44789},{"style":1073},[44790],{"type":55,"value":44791},"    />\n",{"type":49,"tag":1060,"props":44793,"children":44794},{"class":1062,"line":1232},[44795],{"type":49,"tag":1060,"props":44796,"children":44797},{"emptyLinePlaceholder":44},[44798],{"type":55,"value":1094},{"type":49,"tag":1060,"props":44800,"children":44801},{"class":1062,"line":1241},[44802],{"type":49,"tag":1060,"props":44803,"children":44804},{"style":3039},[44805],{"type":55,"value":44806},"    \u003C!-- Optional theme -->\n",{"type":49,"tag":1060,"props":44808,"children":44809},{"class":1062,"line":1249},[44810,44814],{"type":49,"tag":1060,"props":44811,"children":44812},{"style":1073},[44813],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44815,"children":44816},{"style":3839},[44817],{"type":55,"value":44715},{"type":49,"tag":1060,"props":44819,"children":44820},{"class":1062,"line":1262},[44821,44825,44829],{"type":49,"tag":1060,"props":44822,"children":44823},{"style":1067},[44824],{"type":55,"value":44723},{"type":49,"tag":1060,"props":44826,"children":44827},{"style":1073},[44828],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44830,"children":44831},{"style":2215},[44832],{"type":55,"value":44732},{"type":49,"tag":1060,"props":44834,"children":44835},{"class":1062,"line":4581},[44836,44840,44844],{"type":49,"tag":1060,"props":44837,"children":44838},{"style":1067},[44839],{"type":55,"value":44740},{"type":49,"tag":1060,"props":44841,"children":44842},{"style":1073},[44843],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44845,"children":44846},{"style":2215},[44847],{"type":55,"value":44848},"\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css\"\n",{"type":49,"tag":1060,"props":44850,"children":44851},{"class":1062,"line":4631},[44852,44856,44860],{"type":49,"tag":1060,"props":44853,"children":44854},{"style":1067},[44855],{"type":55,"value":44757},{"type":49,"tag":1060,"props":44857,"children":44858},{"style":1073},[44859],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44861,"children":44862},{"style":2215},[44863],{"type":55,"value":44864},"\"sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp\"\n",{"type":49,"tag":1060,"props":44866,"children":44867},{"class":1062,"line":4682},[44868,44872,44876],{"type":49,"tag":1060,"props":44869,"children":44870},{"style":1067},[44871],{"type":55,"value":44774},{"type":49,"tag":1060,"props":44873,"children":44874},{"style":1073},[44875],{"type":55,"value":3068},{"type":49,"tag":1060,"props":44877,"children":44878},{"style":2215},[44879],{"type":55,"value":44783},{"type":49,"tag":1060,"props":44881,"children":44882},{"class":1062,"line":4709},[44883],{"type":49,"tag":1060,"props":44884,"children":44885},{"style":1073},[44886],{"type":55,"value":44791},{"type":49,"tag":1060,"props":44888,"children":44889},{"class":1062,"line":5979},[44890],{"type":49,"tag":1060,"props":44891,"children":44892},{"emptyLinePlaceholder":44},[44893],{"type":55,"value":1094},{"type":49,"tag":1060,"props":44895,"children":44896},{"class":1062,"line":5988},[44897],{"type":49,"tag":1060,"props":44898,"children":44899},{"style":3039},[44900],{"type":55,"value":44901},"    \u003C!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->\n",{"type":49,"tag":1060,"props":44903,"children":44904},{"class":1062,"line":5997},[44905],{"type":49,"tag":1060,"props":44906,"children":44907},{"style":3039},[44908],{"type":55,"value":44909},"    \u003C!-- WARNING: Respond.js doesn't work if you view the page via file:// -->\n",{"type":49,"tag":1060,"props":44911,"children":44912},{"class":1062,"line":6006},[44913],{"type":49,"tag":1060,"props":44914,"children":44915},{"style":3039},[44916],{"type":55,"value":44917},"    \u003C!--[if lt IE 9]>\n",{"type":49,"tag":1060,"props":44919,"children":44920},{"class":1062,"line":10142},[44921],{"type":49,"tag":1060,"props":44922,"children":44923},{"style":3039},[44924],{"type":55,"value":44925},"      \u003Cscript src=\"https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js\">\u003C/script>\n",{"type":49,"tag":1060,"props":44927,"children":44928},{"class":1062,"line":10151},[44929],{"type":49,"tag":1060,"props":44930,"children":44931},{"style":3039},[44932],{"type":55,"value":44933},"      \u003Cscript src=\"https://oss.maxcdn.com/respond/1.4.2/respond.min.js\">\u003C/script>\n",{"type":49,"tag":1060,"props":44935,"children":44936},{"class":1062,"line":10160},[44937],{"type":49,"tag":1060,"props":44938,"children":44939},{"style":3039},[44940],{"type":55,"value":44941},"    \u003C![endif]-->\n",{"type":49,"tag":1060,"props":44943,"children":44944},{"class":1062,"line":10188},[44945,44949,44953],{"type":49,"tag":1060,"props":44946,"children":44947},{"style":1073},[44948],{"type":55,"value":35717},{"type":49,"tag":1060,"props":44950,"children":44951},{"style":3839},[44952],{"type":55,"value":44538},{"type":49,"tag":1060,"props":44954,"children":44955},{"style":1073},[44956],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44958,"children":44959},{"class":1062,"line":10196},[44960,44964,44969],{"type":49,"tag":1060,"props":44961,"children":44962},{"style":1073},[44963],{"type":55,"value":35573},{"type":49,"tag":1060,"props":44965,"children":44966},{"style":3839},[44967],{"type":55,"value":44968},"body",{"type":49,"tag":1060,"props":44970,"children":44971},{"style":1073},[44972],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44974,"children":44975},{"class":1062,"line":10205},[44976,44980,44984,44989,44993],{"type":49,"tag":1060,"props":44977,"children":44978},{"style":1073},[44979],{"type":55,"value":35662},{"type":49,"tag":1060,"props":44981,"children":44982},{"style":3839},[44983],{"type":55,"value":1757},{"type":49,"tag":1060,"props":44985,"children":44986},{"style":1073},[44987],{"type":55,"value":44988},">Hello, world!\u003C/",{"type":49,"tag":1060,"props":44990,"children":44991},{"style":3839},[44992],{"type":55,"value":1757},{"type":49,"tag":1060,"props":44994,"children":44995},{"style":1073},[44996],{"type":55,"value":33998},{"type":49,"tag":1060,"props":44998,"children":44999},{"class":1062,"line":10242},[45000],{"type":49,"tag":1060,"props":45001,"children":45002},{"emptyLinePlaceholder":44},[45003],{"type":55,"value":1094},{"type":49,"tag":1060,"props":45005,"children":45006},{"class":1062,"line":10261},[45007],{"type":49,"tag":1060,"props":45008,"children":45009},{"style":3039},[45010],{"type":55,"value":45011},"    \u003C!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->\n",{"type":49,"tag":1060,"props":45013,"children":45014},{"class":1062,"line":10270},[45015,45019,45023,45028,45032,45037,45041,45045],{"type":49,"tag":1060,"props":45016,"children":45017},{"style":1073},[45018],{"type":55,"value":35662},{"type":49,"tag":1060,"props":45020,"children":45021},{"style":3839},[45022],{"type":55,"value":29691},{"type":49,"tag":1060,"props":45024,"children":45025},{"style":1067},[45026],{"type":55,"value":45027}," src",{"type":49,"tag":1060,"props":45029,"children":45030},{"style":1073},[45031],{"type":55,"value":3068},{"type":49,"tag":1060,"props":45033,"children":45034},{"style":2215},[45035],{"type":55,"value":45036},"\"https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js\"",{"type":49,"tag":1060,"props":45038,"children":45039},{"style":1073},[45040],{"type":55,"value":39211},{"type":49,"tag":1060,"props":45042,"children":45043},{"style":3839},[45044],{"type":55,"value":29691},{"type":49,"tag":1060,"props":45046,"children":45047},{"style":1073},[45048],{"type":55,"value":33998},{"type":49,"tag":1060,"props":45050,"children":45051},{"class":1062,"line":10278},[45052],{"type":49,"tag":1060,"props":45053,"children":45054},{"style":3039},[45055],{"type":55,"value":45056},"    \u003C!-- Include all compiled plugins (below), or include individual files as needed -->\n",{"type":49,"tag":1060,"props":45058,"children":45059},{"class":1062,"line":10287},[45060],{"type":49,"tag":1060,"props":45061,"children":45062},{"style":3039},[45063],{"type":55,"value":45064},"    \u003C!-- Latest compiled and minified JavaScript -->\n",{"type":49,"tag":1060,"props":45066,"children":45067},{"class":1062,"line":10319},[45068,45072],{"type":49,"tag":1060,"props":45069,"children":45070},{"style":1073},[45071],{"type":55,"value":35662},{"type":49,"tag":1060,"props":45073,"children":45074},{"style":3839},[45075],{"type":55,"value":45076},"script\n",{"type":49,"tag":1060,"props":45078,"children":45079},{"class":1062,"line":10332},[45080,45085,45089],{"type":49,"tag":1060,"props":45081,"children":45082},{"style":1067},[45083],{"type":55,"value":45084},"      src",{"type":49,"tag":1060,"props":45086,"children":45087},{"style":1073},[45088],{"type":55,"value":3068},{"type":49,"tag":1060,"props":45090,"children":45091},{"style":2215},[45092],{"type":55,"value":45093},"\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js\"\n",{"type":49,"tag":1060,"props":45095,"children":45096},{"class":1062,"line":10356},[45097,45101,45105],{"type":49,"tag":1060,"props":45098,"children":45099},{"style":1067},[45100],{"type":55,"value":44757},{"type":49,"tag":1060,"props":45102,"children":45103},{"style":1073},[45104],{"type":55,"value":3068},{"type":49,"tag":1060,"props":45106,"children":45107},{"style":2215},[45108],{"type":55,"value":45109},"\"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa\"\n",{"type":49,"tag":1060,"props":45111,"children":45112},{"class":1062,"line":10364},[45113,45117,45121],{"type":49,"tag":1060,"props":45114,"children":45115},{"style":1067},[45116],{"type":55,"value":44774},{"type":49,"tag":1060,"props":45118,"children":45119},{"style":1073},[45120],{"type":55,"value":3068},{"type":49,"tag":1060,"props":45122,"children":45123},{"style":2215},[45124],{"type":55,"value":44783},{"type":49,"tag":1060,"props":45126,"children":45127},{"class":1062,"line":10373},[45128,45133,45137],{"type":49,"tag":1060,"props":45129,"children":45130},{"style":1073},[45131],{"type":55,"value":45132},"    >\u003C/",{"type":49,"tag":1060,"props":45134,"children":45135},{"style":3839},[45136],{"type":55,"value":29691},{"type":49,"tag":1060,"props":45138,"children":45139},{"style":1073},[45140],{"type":55,"value":33998},{"type":49,"tag":1060,"props":45142,"children":45143},{"class":1062,"line":10395},[45144,45148,45152],{"type":49,"tag":1060,"props":45145,"children":45146},{"style":1073},[45147],{"type":55,"value":35717},{"type":49,"tag":1060,"props":45149,"children":45150},{"style":3839},[45151],{"type":55,"value":44968},{"type":49,"tag":1060,"props":45153,"children":45154},{"style":1073},[45155],{"type":55,"value":33998},{"type":49,"tag":1060,"props":45157,"children":45158},{"class":1062,"line":10403},[45159,45163,45167],{"type":49,"tag":1060,"props":45160,"children":45161},{"style":1073},[45162],{"type":55,"value":35084},{"type":49,"tag":1060,"props":45164,"children":45165},{"style":3839},[45166],{"type":55,"value":33977},{"type":49,"tag":1060,"props":45168,"children":45169},{"style":1073},[45170],{"type":55,"value":33998},{"type":49,"tag":58,"props":45172,"children":45173},{},[45174,45176,45183],{"type":55,"value":45175},"This html was taken from ",{"type":49,"tag":80,"props":45177,"children":45180},{"href":45178,"rel":45179},"http://getbootstrap.com/getting-started/",[84],[45181],{"type":55,"value":45182},"Bootstrap's 'Get Started' page",{"type":55,"value":745},{"type":49,"tag":58,"props":45185,"children":45186},{},[45187,45189,45194],{"type":55,"value":45188},"Now we can run ",{"type":49,"tag":326,"props":45190,"children":45192},{"className":45191},[],[45193],{"type":55,"value":43025},{"type":55,"value":45195}," and confirm that we see \"Hello, world!\" from the Bootstrap template.",{"type":49,"tag":58,"props":45197,"children":45198},{},[45199],{"type":55,"value":32931},{"type":49,"tag":7749,"props":45201,"children":45202},{},[45203],{"type":55,"value":7753},{"title":8,"searchDepth":1079,"depth":1079,"links":45205},[],"content:2017:03:04:settinging-up-django-with-heroku.md","2017/03/04/settinging-up-django-with-heroku.md","2017/03/04/settinging-up-django-with-heroku",1723329678185]