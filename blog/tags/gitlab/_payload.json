[{"data":1,"prerenderedAt":10596},["ShallowReactive",2],{"/blog/tags/gitlab/":3},[4,258,4805,10493],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"date":11,"image":12,"tags":13,"body":21,"_type":252,"_id":253,"_source":254,"_file":255,"_stem":256,"_extension":257},"/2020/11/29/weekend-project-update-open-sec-data","29",false,"","Weekend project update: Open SEC Data","This project uses Django, DRF and Celery to read public SEC filings from sec.gov, build it into an API which is consumed through a Vue.js application.","2020-11-29T00:00:00.000Z","/static/sec-update.jpg",[14,15,16,17,18,19,20],"django","vue","data","api","gitlab","docker","celery",{"type":22,"children":23,"toc":249},"root",[24,32,72,86,91,177,182],{"type":25,"tag":26,"props":27,"children":28},"element","p",{},[29],{"type":30,"value":31},"text","Here's an early look at a project I have been working on to practice some Django and Vue.js concepts: Open SEC Data.",{"type":25,"tag":33,"props":34,"children":35},"ul",{},[36,50,61],{"type":25,"tag":37,"props":38,"children":39},"li",{},[40,48],{"type":25,"tag":41,"props":42,"children":46},"a",{"href":43,"rel":44},"https://opensecdata.ga",[45],"nofollow",[47],{"type":30,"value":43},{"type":30,"value":49}," (project staging website, deployed to docker swarm cluster running on DigitalOcean)",{"type":25,"tag":37,"props":51,"children":52},{},[53,59],{"type":25,"tag":41,"props":54,"children":57},{"href":55,"rel":56},"https://gitlab.com/briancaffey/sec-filings-app",[45],[58],{"type":30,"value":55},{"type":30,"value":60}," (main repository, requires GitLab account)",{"type":25,"tag":37,"props":62,"children":63},{},[64,70],{"type":25,"tag":41,"props":65,"children":68},{"href":66,"rel":67},"https://github.com/briancaffey/sec-filings-app",[45],[69],{"type":30,"value":66},{"type":30,"value":71}," (mirror, no account required to view)",{"type":25,"tag":26,"props":73,"children":74},{},[75,77,84],{"type":30,"value":76},"This project uses Django, DRF and Celery to read public SEC filings from ",{"type":25,"tag":41,"props":78,"children":81},{"href":79,"rel":80},"https://www.sec.gov/Archives/edgar/full-index/",[45],[82],{"type":30,"value":83},"sec.gov",{"type":30,"value":85},", build it into an API which is consumed through a Vue.js application. I'm currently focused on 13F filings which are required for large US investment funds managing over $100 million USD. There is data dating back to 1993 and it is published quarterly.",{"type":25,"tag":26,"props":87,"children":88},{},[89],{"type":30,"value":90},"Here are some of the things I'm focusing on in this project in no particular order:",{"type":25,"tag":33,"props":92,"children":93},{},[94,99,104,109,114,119,124,146,167,172],{"type":25,"tag":37,"props":95,"children":96},{},[97],{"type":30,"value":98},"Getting better at Django REST Framework. This project has been helping me apply some of the parts of DRF that I have found difficult. I'm currently using ViewSets which feels function-based views inside of class-based views. They are flexible, but I would like to add more abstraction with filtering",{"type":25,"tag":37,"props":100,"children":101},{},[102],{"type":30,"value":103},"Django admin. While this project primarily uses Django as a REST API with Django REST Framework, I have tried to take advantage of the Django admin to build out helpful views that can be used to spot check the data I'm creating. Most of my API is read-only, this makes things pretty simple.",{"type":25,"tag":37,"props":105,"children":106},{},[107],{"type":30,"value":108},"Moderately complex paginated data tables with Vue. I work with lots of paginated table data, and I think there is a better way to do abstract some of the repeated logic that I use (getting and setting current page, rows per page). I'm using Vuex, and I have heard of module factories, but I'm thinking that there will be a better way to do this when Vue 3 officially comes to Quasar Framework (Quasar is a Vue.js framework).",{"type":25,"tag":37,"props":110,"children":111},{},[112],{"type":30,"value":113},"Session authentication with DRF. There are a lot of guides showing how to use JWT and Token Authentication for DRF with Javascript frontends. The DRF recommends using Session Authentication for such use cases as a web-base Javascript client, so I hope I can promote some best practices around how to use Django's built-in session authentication for use with the Django REST Framework using an HttpOnly session cookie. I also understand that all security decisions have trade-offs, and I'm trying to understand what trade-offs come with handling authentication in this way.",{"type":25,"tag":37,"props":115,"children":116},{},[117],{"type":30,"value":118},"Social authentication. I have previously setup social authentication with Google, Facebook and GitHub using Python Social Auth. I think it is a great package, and it adds a lot of flexibility with it's concept of pipelines, but I haven't done much with these yet, so I'm hoping to dig in further and better understand how I can make better use of social authentication in my app. This app uses Linkedin 0Auth2 with a custom user model. Logging in with Linkedin account gives you the ability to request an API Token (Django REST Framework's Token) to access the public API.",{"type":25,"tag":37,"props":120,"children":121},{},[122],{"type":30,"value":123},"Automatic API documentation with OpenAPI. Swagger/OpenAPI seems like nice way to document and API, so I'm hoping to build best practices around how to document a DRF API automatically with OpenAPI and Swagger UI.",{"type":25,"tag":37,"props":125,"children":126},{},[127,129,136,138,144],{"type":30,"value":128},"CI/CD with GitLab and docker swarm. I will admit that I am huge GitLab fan. I love how flexible their CI/CD pipelines are. Being a docker fan as well, I chose to use docker swarm for this project to keep things simple and straightforward. I think one under-appreciate feature of docker is being able to set ",{"type":25,"tag":130,"props":131,"children":133},"code",{"className":132},[],[134],{"type":30,"value":135},"DOCKER_HOST",{"type":30,"value":137}," to an SSH connection, such as ",{"type":25,"tag":130,"props":139,"children":141},{"className":140},[],[142],{"type":30,"value":143},"ssh://root@123.456.789.10",{"type":30,"value":145},". This let's you control the remote docker host without needing to SSH to it first, and it is also how I'm able to deploy and run management commands \"manually\" through the GitLab UI.",{"type":25,"tag":37,"props":147,"children":148},{},[149,151,157,159,165],{"type":30,"value":150},"Productive development environment. To start the project, you only need to run docker-compose up (after copying ",{"type":25,"tag":130,"props":152,"children":154},{"className":153},[],[155],{"type":30,"value":156},".env.template",{"type":30,"value":158}," to ",{"type":25,"tag":130,"props":160,"children":162},{"className":161},[],[163],{"type":30,"value":164},".env",{"type":30,"value":166}," in the root directory for storing sensitive data outside of git such as LinkedIn OAuth2 keys). The development environment is very similar to how this project runs in production with some additional utilities for monitoring and debugging such as pgadmin4, flower (for celery), redis commander (a GUI for viewing redis databases), Django debug toolbar (a must have for any Django project, I believe), runserver_plus with Werkzeug, and others. Also, the backend and frontend hot reload automatically with the help of webpack for Vue and watchdog for Django and Celery.",{"type":25,"tag":37,"props":168,"children":169},{},[170],{"type":30,"value":171},"Automatic TLS certificate generation with Traefik. For a simple project in docker swarm, I'm really happy with how simple it is to request TLS certificates from Let's Encrypt automatically with Traefik. There are no scripts, cron jobs or one-time setup jobs, it just seems to work out of the box if configured correctly.",{"type":25,"tag":37,"props":173,"children":174},{},[175],{"type":30,"value":176},"Testing with pytest. I have only been trying to test most of my API views so far. I really like using factory with pytest, so I use that in most of my tests.",{"type":25,"tag":26,"props":178,"children":179},{},[180],{"type":30,"value":181},"That's all I have for now. I have a long list of questions, things I want to improve, add and experiment with, here are just a few that come to mind:",{"type":25,"tag":33,"props":183,"children":184},{},[185,190,195,209,214,219,224,229],{"type":25,"tag":37,"props":186,"children":187},{},[188],{"type":30,"value":189},"Frontend testing. I don't have any component testing or e2d tests, so this would be good to add eventually. Since I'm using a component library and my app uses these components directly, I'm not exactly sure how much testing I should be doing.",{"type":25,"tag":37,"props":191,"children":192},{},[193],{"type":30,"value":194},"Data verification/validation. There are a lot of site that do provide similar data, WhaleWisdom is the biggest one that I know of. Once I get more data built on the site it would be good to spot check some of the values. There are some nuances to the filing data that I haven't addressed, such as Amendment filings and additions.",{"type":25,"tag":37,"props":196,"children":197},{},[198,200,207],{"type":30,"value":199},"Calculating period changes. One of the features that I'm not sure how best to implement is the ability to sort holdings for a filer in a given period on the percent increase from the last period. One way would be to add these as additional fields to the Holding model and then calculate these values as I process the data in celery. If I process the data from recent periods to later periods, I will have to update these values once the previous period has been processed, so it would be an additional check to do. I'll probably post this question here in more detail later. Here's ",{"type":25,"tag":41,"props":201,"children":204},{"href":202,"rel":203},"https://whalewisdom.com/filer/ubs-ag#tabholdings_tab_link",[45],[205],{"type":30,"value":206},"an example of what this means from WhaleWisdom",{"type":30,"value":208},".",{"type":25,"tag":37,"props":210,"children":211},{},[212],{"type":30,"value":213},"Accessing LinkedIn profile data to populate fields on my CustomUser model.",{"type":25,"tag":37,"props":215,"children":216},{},[217],{"type":30,"value":218},"Scaling? I have a lot more experience with deploying projects to AWS which is built around the ability to scale. I don't know a project on DigitalOcean would be scaled automatically. A single node docker swarm cluster while take some time to process all of the data. I would probably be better of scaling vertically with much bigger droplets and higher celery concurrency.",{"type":25,"tag":37,"props":220,"children":221},{},[222],{"type":30,"value":223},"Docker swarm secrets. I'm currently using environment variables to pass secrets stored in GitLab CI when I build images and deploy to docker swarm. I would like to learn how to properly use swarm secrets and work them into my CI/CD pipeline.",{"type":25,"tag":37,"props":225,"children":226},{},[227],{"type":30,"value":228},"As I mentioned above, I'm also interested in updating this project to Vue3 and to apply some of its new features to this project.",{"type":25,"tag":37,"props":230,"children":231},{},[232,234,240,242,248],{"type":30,"value":233},"Use pipenv, poetry or some other way of pinning secondary python dependencies. Does anyone have a recommendation on how best to do this with docker. I have always thought that docker ",{"type":25,"tag":235,"props":236,"children":237},"em",{},[238],{"type":30,"value":239},"is",{"type":30,"value":241}," the virtual environment, but I realize that some versions of indirect dependencies may change when pip installing without using a lockfile similar to ",{"type":25,"tag":130,"props":243,"children":245},{"className":244},[],[246],{"type":30,"value":247},"package-lock.json",{"type":30,"value":208},{"title":8,"searchDepth":250,"depth":250,"links":251},2,[],"markdown","content:2020:11:29:weekend-project-update-open-sec-data.md","content","2020/11/29/weekend-project-update-open-sec-data.md","2020/11/29/weekend-project-update-open-sec-data","md",{"_path":259,"_dir":260,"_draft":7,"_partial":7,"_locale":8,"title":261,"description":262,"layout":263,"date":264,"comments":265,"image":266,"tags":267,"body":273,"_type":252,"_id":4802,"_source":254,"_file":4803,"_stem":4804,"_extension":257},"/2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx","09","Deploying Django applications with docker swarm on DigitalOcean using GitLab CI, Traefik, NGINX and REX-Ray","A guide to deploying Django applications with docker using popular open-source tools","post","2020-08-09T00:00:00.000Z",true,"/static/shark.jpg",[14,19,268,15,18,269,270,271,272],"digital-ocean","rex-ray","traefik","nginx","swarm",{"type":22,"children":274,"toc":4776},[275,307,312,321,333,338,345,350,416,448,454,498,504,541,546,551,556,562,575,653,659,681,687,692,701,712,718,730,735,743,764,769,777,791,799,804,813,841,890,909,920,1112,1138,1177,1255,1263,1288,1383,1391,1412,1499,1512,1518,1554,1562,1590,1632,1638,1643,1651,1659,1696,1701,1709,1721,1740,1748,1768,1776,1796,1805,1832,2065,2142,2187,2228,2236,2257,2262,2269,2287,2299,2306,2326,2336,2369,2374,2581,2600,2607,2620,2657,2703,2716,2765,2781,2868,3092,3121,3126,3131,3144,3162,3173,3365,3384,3419,3427,3500,3508,3529,3555,3563,3642,3654,3798,3803,3817,3837,3845,3850,3858,3897,3931,3936,3945,3959,3964,3982,3987,3995,4000,4028,4047,4077,4082,4409,4417,4441,4528,4540,4548,4560,4567,4579,4587,4605,4613,4618,4626,4631,4636,4644,4663,4669,4674,4691,4699,4704,4710,4715,4721,4726,4732,4737,4743,4748,4754,4759,4765,4770],{"type":25,"tag":26,"props":276,"children":277},{},[278,280,287,289,296,298,305],{"type":30,"value":279},"I recently wrote two articles about deploying Django applications to AWS serverless environments: one on ",{"type":25,"tag":41,"props":281,"children":284},{"href":282,"rel":283},"https://briancaffey.github.io/2020/06/02/django-postgres-vue-gitlab-ecs.html",[45],[285],{"type":30,"value":286},"AWS Fargate",{"type":30,"value":288}," (CloudFront, ALB and ECS Fargate containers) and one on ",{"type":25,"tag":41,"props":290,"children":293},{"href":291,"rel":292},"https://briancaffey.github.io/2020/08/01/django-and-lambda-with-cdk-and-api-gateway.html",[45],[294],{"type":30,"value":295},"AWS Lambda",{"type":30,"value":297}," (Lambda + API Gateway, without using Zappa or Serverless Framework). Both projects focused on automating as much of the setup and operation as possible using DevOps patterns: Infrastructure as Code, GitOps, CI/CD and docker containers. I used AWS resources exclusively (with the exception of GitLab) with the help of ",{"type":25,"tag":41,"props":299,"children":302},{"href":300,"rel":301},"https://aws.amazon.com/cdk/",[45],[303],{"type":30,"value":304},"AWS Cloud Development Kit (CDK)",{"type":30,"value":306},", an awesome tool that I have really come to like. In general I really like AWS, and the more I use it I start to think about what I would do without it. Also, a lot of the feedback I got on these projects recommended to \"just use a VPS\" instead of bothering with AWS because it is complicated, expensive, overkill, etc. This got me thinking about how far I could get in deploying a Django application on a server with little or no external services that AWS has spoiled me with. After a little bit of discomfort and confusion, I was able to check off most of what I was hoping to and came away with a few questions as well. If you are interested to know how I got things setup and and hear some of my thoughts on running Django applications in production, continue reading!",{"type":25,"tag":26,"props":308,"children":309},{},[310],{"type":30,"value":311},"In this article, I'm going to go over my approach to deploying and running Django applications using DigitalOcean Droplets (Linux-based virtual machine that runs on top of virtualized hardware) and block storage volumes (network-based block devices that provide additional data storage for Droplets).",{"type":25,"tag":313,"props":314,"children":315},"blockquote",{},[316],{"type":25,"tag":26,"props":317,"children":318},{},[319],{"type":30,"value":320},"I'll also touch on trade-offs between DigitalOcean and AWS and emphasize aspects of the project that confuse/d me with these block quotes.",{"type":25,"tag":26,"props":322,"children":323},{},[324,326,332],{"type":30,"value":325},"Here's a link to my project that I'll be referencing: ",{"type":25,"tag":41,"props":327,"children":330},{"href":328,"rel":329},"https://gitlab.com/briancaffey/digital-ocean-docker-swarm-django-traefik",[45],[331],{"type":30,"value":328},{"type":30,"value":208},{"type":25,"tag":26,"props":334,"children":335},{},[336],{"type":30,"value":337},"The project setup is a combination of some of the best practices I have picked up along the way as well as some very helpful guides, repositories and blog posts that I'll do my best to reference throughout this article.",{"type":25,"tag":339,"props":340,"children":342},"h2",{"id":341},"overview",[343],{"type":30,"value":344},"Overview",{"type":25,"tag":26,"props":346,"children":347},{},[348],{"type":30,"value":349},"Here are some of the key parts of the project that I'll go over:",{"type":25,"tag":33,"props":351,"children":352},{},[353,358,363,368,373,378,391,396,401,406,411],{"type":25,"tag":37,"props":354,"children":355},{},[356],{"type":30,"value":357},"DigitalOcean and GitLab setup",{"type":25,"tag":37,"props":359,"children":360},{},[361],{"type":30,"value":362},"Creating an A Record that points to our Droplet IP",{"type":25,"tag":37,"props":364,"children":365},{},[366],{"type":30,"value":367},"Using a prebuilt VM image that ships with docker and docker-compose",{"type":25,"tag":37,"props":369,"children":370},{},[371],{"type":30,"value":372},"Setting up the REX-Ray storage driver to automatically provision Digital Ocean block storage volumes",{"type":25,"tag":37,"props":374,"children":375},{},[376],{"type":30,"value":377},"Setting up a docker swarm cluster",{"type":25,"tag":37,"props":379,"children":380},{},[381,383,389],{"type":30,"value":382},"Setting up a ",{"type":25,"tag":130,"props":384,"children":386},{"className":385},[],[387],{"type":30,"value":388},".gitlab-ci.yml",{"type":30,"value":390}," file to build images and push them to a private GitLab CI project registry",{"type":25,"tag":37,"props":392,"children":393},{},[394],{"type":30,"value":395},"Writing a docker-compose file to configure the services (containers) that will support the application",{"type":25,"tag":37,"props":397,"children":398},{},[399],{"type":30,"value":400},"Deploying a stack to the docker swarm cluster on DigitalOcean from our GitLab CI environment over SSH",{"type":25,"tag":37,"props":402,"children":403},{},[404],{"type":30,"value":405},"Django project settings and management commands for our Postgres database and static files",{"type":25,"tag":37,"props":407,"children":408},{},[409],{"type":30,"value":410},"Monitoring, logging and debugging",{"type":25,"tag":37,"props":412,"children":413},{},[414],{"type":30,"value":415},"Destroying the environment + cleanup",{"type":25,"tag":26,"props":417,"children":418},{},[419,421,428,430,437,439,446],{"type":30,"value":420},"Before I dig into all of this, I recommend that you check out ",{"type":25,"tag":41,"props":422,"children":425},{"href":423,"rel":424},"https://mattsegal.dev/django-prod-architectures.html",[45],[426],{"type":30,"value":427},"this article about Django production architectures by Matt Segal",{"type":30,"value":429},". This is a great primer for a lot of what I'll be talking about and it includes some great visualizations. ",{"type":25,"tag":41,"props":431,"children":434},{"href":432,"rel":433},"https://mattsegal.dev",[45],[435],{"type":30,"value":436},"mattsegal.dev",{"type":30,"value":438}," has lots of good content related to Django, I also recommend checking out ",{"type":25,"tag":41,"props":440,"children":443},{"href":441,"rel":442},"https://mattsegal.dev/nginx-django-reverse-proxy-config.html",[45],[444],{"type":30,"value":445},"this article about how NGINX is used with Django",{"type":30,"value":447},". Thanks for the great resources, Matt!",{"type":25,"tag":339,"props":449,"children":451},{"id":450},"digitalocean-setup",[452],{"type":30,"value":453},"DigitalOcean setup",{"type":25,"tag":33,"props":455,"children":456},{},[457,462,473,484],{"type":25,"tag":37,"props":458,"children":459},{},[460],{"type":30,"value":461},"Sign up for a new DigitalOcean account if you don't already have one",{"type":25,"tag":37,"props":463,"children":464},{},[465,467],{"type":30,"value":466},"Create a DigitalOcean project ",{"type":25,"tag":41,"props":468,"children":471},{"href":469,"rel":470},"https://cloud.digitalocean.com/projects/new",[45],[472],{"type":30,"value":469},{"type":25,"tag":37,"props":474,"children":475},{},[476,478],{"type":30,"value":477},"Create a personal access token (we will use this to configure a docker addon that will provision block storage volumes automatically) ",{"type":25,"tag":41,"props":479,"children":482},{"href":480,"rel":481},"https://cloud.digitalocean.com/account/api/tokens",[45],[483],{"type":30,"value":480},{"type":25,"tag":37,"props":485,"children":486},{},[487,489,496],{"type":30,"value":488},"Create and add an SSH key to your account. This is a pretty simple step, but DigitalOcean still has really thorough documentation on how to do this (see ",{"type":25,"tag":41,"props":490,"children":493},{"href":491,"rel":492},"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/",[45],[494],{"type":30,"value":495},"this article",{"type":30,"value":497}," for more information)",{"type":25,"tag":339,"props":499,"children":501},{"id":500},"prebuilt-docker-vm-image",[502],{"type":30,"value":503},"Prebuilt Docker VM image",{"type":25,"tag":26,"props":505,"children":506},{},[507,509,516,518,524,526,531,533,539],{"type":30,"value":508},"From the ",{"type":25,"tag":41,"props":510,"children":513},{"href":511,"rel":512},"https://cloud.digitalocean.com/droplets/new",[45],[514],{"type":30,"value":515},"Create Droplets",{"type":30,"value":517}," page, select ",{"type":25,"tag":130,"props":519,"children":521},{"className":520},[],[522],{"type":30,"value":523},"Marketplace",{"type":30,"value":525}," and search for ",{"type":25,"tag":130,"props":527,"children":529},{"className":528},[],[530],{"type":30,"value":19},{"type":30,"value":532},". Select the ",{"type":25,"tag":130,"props":534,"children":536},{"className":535},[],[537],{"type":30,"value":538},"Docker 5:19.03.1~3 18.04",{"type":30,"value":540}," image. Note that this VM is Ubuntun 18.04 with Docker Community Edition and docker-compose pre-installed.",{"type":25,"tag":26,"props":542,"children":543},{},[544],{"type":30,"value":545},"Select the basic plan, and then scroll to the left to choose the $5.00/month option. Select a datacenter region. Most of these regions should be OK, but you should verify that the region you have selected supports volumes (they may all support volumes, but there are some DO features that are not supported accross all regiongs, similar to AWS). Do not select a VPC or any of the additional options.",{"type":25,"tag":26,"props":547,"children":548},{},[549],{"type":30,"value":550},"For Authentication, select the SSH key that you created earlier.",{"type":25,"tag":26,"props":552,"children":553},{},[554],{"type":30,"value":555},"Take note of the Droplet's IP address; we will use this in the next step.",{"type":25,"tag":339,"props":557,"children":559},{"id":558},"gitlab-setup",[560],{"type":30,"value":561},"GitLab setup",{"type":25,"tag":26,"props":563,"children":564},{},[565,567,573],{"type":30,"value":566},"Create a new GitLab project and clone it locally. You can also clone or fork my project and use that as a starting point. Go to ",{"type":25,"tag":130,"props":568,"children":570},{"className":569},[],[571],{"type":30,"value":572},"Settings > CI/CD > Variables",{"type":30,"value":574}," in your GitLab project and add the following environment variables:",{"type":25,"tag":33,"props":576,"children":577},{},[578,603,614,625,636],{"type":25,"tag":37,"props":579,"children":580},{},[581,587,589,595,597],{"type":25,"tag":130,"props":582,"children":584},{"className":583},[],[585],{"type":30,"value":586},"SSH_PRIVATE_KEY",{"type":30,"value":588},": the value should start with ",{"type":25,"tag":130,"props":590,"children":592},{"className":591},[],[593],{"type":30,"value":594},"-----BEGIN RSA PRIVATE KEY-----",{"type":30,"value":596}," and end with ",{"type":25,"tag":130,"props":598,"children":600},{"className":599},[],[601],{"type":30,"value":602},"-----END RSA PRIVATE KEY-----",{"type":25,"tag":37,"props":604,"children":605},{},[606,612],{"type":25,"tag":130,"props":607,"children":609},{"className":608},[],[610],{"type":30,"value":611},"DROPLET_IP",{"type":30,"value":613},": the IP address of the droplet you just created",{"type":25,"tag":37,"props":615,"children":616},{},[617,623],{"type":25,"tag":130,"props":618,"children":620},{"className":619},[],[621],{"type":30,"value":622},"POSTGRES_PASSWORD",{"type":30,"value":624},": a secure password that we will use for our Postgres database (we will share this with our Django application later on)",{"type":25,"tag":37,"props":626,"children":627},{},[628,634],{"type":25,"tag":130,"props":629,"children":631},{"className":630},[],[632],{"type":30,"value":633},"SECRET_KEY",{"type":30,"value":635},": a random secret key to use for our Django application.",{"type":25,"tag":37,"props":637,"children":638},{},[639,645,647],{"type":25,"tag":130,"props":640,"children":642},{"className":641},[],[643],{"type":30,"value":644},"DEBUG",{"type":30,"value":646},": the number ",{"type":25,"tag":130,"props":648,"children":650},{"className":649},[],[651],{"type":30,"value":652},"0",{"type":25,"tag":339,"props":654,"children":656},{"id":655},"a-record",[657],{"type":30,"value":658},"A Record",{"type":25,"tag":26,"props":660,"children":661},{},[662,664,670,672,679],{"type":30,"value":663},"By the end of this project you will be able to deploy your Django application to a live domain name provided that you have one. All you need to do is create an A Record that points to the Droplet IP. There are no DNS configuration changes to make inside of DigitalOcean. I'm using a domain that I purchased through Route53. You can get a free ",{"type":25,"tag":130,"props":665,"children":667},{"className":666},[],[668],{"type":30,"value":669},".tk",{"type":30,"value":671}," domain from ",{"type":25,"tag":41,"props":673,"children":676},{"href":674,"rel":675},"https://www.freenom.com/en/freeandpaiddomains.html",[45],[677],{"type":30,"value":678},"freenom",{"type":30,"value":680},". I have used this before and it is a great option for testing things out.",{"type":25,"tag":339,"props":682,"children":684},{"id":683},"ssh-into-your-digitalocean-droplet",[685],{"type":30,"value":686},"SSH into your DigitalOcean Droplet",{"type":25,"tag":26,"props":688,"children":689},{},[690],{"type":30,"value":691},"You can do this with the following command:",{"type":25,"tag":693,"props":694,"children":696},"pre",{"code":695},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91\n",[697],{"type":25,"tag":130,"props":698,"children":699},{"__ignoreMap":8},[700],{"type":30,"value":695},{"type":25,"tag":26,"props":702,"children":703},{},[704,710],{"type":25,"tag":130,"props":705,"children":707},{"className":706},[],[708],{"type":30,"value":709},"a1_rsa",{"type":30,"value":711}," is the private key I added to GitHub. You can logout for now, but keep this command handy, because we will be coming back to our Droplet via SSH shortly.",{"type":25,"tag":339,"props":713,"children":715},{"id":714},"add-the-rex-ray-docker-plugin",[716],{"type":30,"value":717},"Add the REX-Ray docker plugin",{"type":25,"tag":26,"props":719,"children":720},{},[721,723,729],{"type":30,"value":722},"This step is very simple, you can follow along with this short guide: ",{"type":25,"tag":41,"props":724,"children":727},{"href":725,"rel":726},"https://www.digitalocean.com/community/questions/how-to-attach-digitalocean-block-storage-to-docker-container",[45],[728],{"type":30,"value":725},{"type":30,"value":208},{"type":25,"tag":26,"props":731,"children":732},{},[733],{"type":30,"value":734},"There is basically one command to run:",{"type":25,"tag":693,"props":736,"children":738},{"code":737},"docker plugin install rexray/dobs DOBS_TOKEN=YOUR_DIGITALOCEAN_TOKEN DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775\n",[739],{"type":25,"tag":130,"props":740,"children":741},{"__ignoreMap":8},[742],{"type":30,"value":737},{"type":25,"tag":26,"props":744,"children":745},{},[746,748,754,756,762],{"type":30,"value":747},"You will need to make sure that you replace ",{"type":25,"tag":130,"props":749,"children":751},{"className":750},[],[752],{"type":30,"value":753},"YOUR_DIGITALOCEAN_TOKEN",{"type":30,"value":755}," with the personal access token you added earlier. Also, ",{"type":25,"tag":130,"props":757,"children":759},{"className":758},[],[760],{"type":30,"value":761},"DOBS_REGION",{"type":30,"value":763}," should be the region you selected for your Droplet earlier.",{"type":25,"tag":26,"props":765,"children":766},{},[767],{"type":30,"value":768},"Check that the plugin was installed correctly with:",{"type":25,"tag":693,"props":770,"children":772},{"code":771},"docker plugin ls\n",[773],{"type":25,"tag":130,"props":774,"children":775},{"__ignoreMap":8},[776],{"type":30,"value":771},{"type":25,"tag":26,"props":778,"children":779},{},[780,782,789],{"type":30,"value":781},"Here's a quick intro to REX-Ray from ",{"type":25,"tag":41,"props":783,"children":786},{"href":784,"rel":785},"https://rexray.readthedocs.io/en/stable/",[45],[787],{"type":30,"value":788},"rexray.readthedocs.io",{"type":30,"value":790},":",{"type":25,"tag":313,"props":792,"children":793},{},[794],{"type":25,"tag":26,"props":795,"children":796},{},[797],{"type":30,"value":798},"REX-Ray is an open source, storage management solution designed to support container runtimes such as Docker and Mesos. REX-Ray enables stateful applications, such as databases, to persist and maintain its data after the life cycle of the container has ended. Built-in high availability enables orchestrators such as Docker Swarm, Kubernetes, and Mesos Frameworks like Marathon to automatically orchestrate storage tasks between hosts in a cluster.",{"type":25,"tag":26,"props":800,"children":801},{},[802],{"type":30,"value":803},"In the context of this project, REX-Ray will automate the creation of DigitalOcean Block Storage Volumes. We will talk about volumes and how they are used later on in this article.",{"type":25,"tag":339,"props":805,"children":807},{"id":806},"gitlab-ciyml",[808],{"type":25,"tag":130,"props":809,"children":811},{"className":810},[],[812],{"type":30,"value":388},{"type":25,"tag":26,"props":814,"children":815},{},[816,821,823,830,832,839],{"type":25,"tag":130,"props":817,"children":819},{"className":818},[],[820],{"type":30,"value":388},{"type":30,"value":822}," is a file that configures pipelines when code is pushed to GitLab, similar to how GitHub Actions work with GitHub. This single file is a huge topic, if you are unfamiliar with GitLab CI, you might want to have a look over ",{"type":25,"tag":41,"props":824,"children":827},{"href":825,"rel":826},"https://docs.gitlab.com/ee/ci/yaml/",[45],[828],{"type":30,"value":829},"this page from the GitLab documentation",{"type":30,"value":831}," which goes over all of the configuration options with many examples. Also, ",{"type":25,"tag":41,"props":833,"children":836},{"href":834,"rel":835},"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",[45],[837],{"type":30,"value":838},"this documentation page",{"type":30,"value":840}," covers the predefined environment variables that are made available to GitLab CI pipelines. I'm using these in a few different places as we will see shortly.",{"type":25,"tag":26,"props":842,"children":843},{},[844,846,851,853,859,861,867,869,875,877,882,883,888],{"type":30,"value":845},"CI/CD pipelines that I define with ",{"type":25,"tag":130,"props":847,"children":849},{"className":848},[],[850],{"type":30,"value":388},{"type":30,"value":852}," typically contain three stages: ",{"type":25,"tag":130,"props":854,"children":856},{"className":855},[],[857],{"type":30,"value":858},"test",{"type":30,"value":860},", ",{"type":25,"tag":130,"props":862,"children":864},{"className":863},[],[865],{"type":30,"value":866},"build",{"type":30,"value":868}," and ",{"type":25,"tag":130,"props":870,"children":872},{"className":871},[],[873],{"type":30,"value":874},"deploy",{"type":30,"value":876},". We will focus on the ",{"type":25,"tag":130,"props":878,"children":880},{"className":879},[],[881],{"type":30,"value":866},{"type":30,"value":868},{"type":25,"tag":130,"props":884,"children":886},{"className":885},[],[887],{"type":30,"value":874},{"type":30,"value":889}," stages for now (reference the article on my Fargate project linked above for reference on setting up unit tests with pytest).",{"type":25,"tag":26,"props":891,"children":892},{},[893,899,901,907],{"type":25,"tag":130,"props":894,"children":896},{"className":895},[],[897],{"type":30,"value":898},"build-backend",{"type":30,"value":900}," is the name of a GitLab CI job that builds and tags a docker image from the source code in the ",{"type":25,"tag":130,"props":902,"children":904},{"className":903},[],[905],{"type":30,"value":906},"backend",{"type":30,"value":908}," directory of this project and pushes the tagged container image to a private image registry on gitlab.com that we will use later.",{"type":25,"tag":26,"props":910,"children":911},{},[912,914,919],{"type":30,"value":913},"Here's the YAML code for ",{"type":25,"tag":130,"props":915,"children":917},{"className":916},[],[918],{"type":30,"value":898},{"type":30,"value":790},{"type":25,"tag":693,"props":921,"children":925},{"code":922,"language":923,"meta":8,"className":924,"style":8},"build-backend:\n  stage: build\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  before_script:\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - |\n      docker build \\\n        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n        -f backend/docker/Dockerfile.prod \\\n        ./backend/\n    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n","yml","language-yml shiki shiki-themes github-light github-dark monokai",[926],{"type":25,"tag":130,"props":927,"children":928},{"__ignoreMap":8},[929,946,965,983,996,1010,1023,1036,1049,1063,1072,1081,1090,1099],{"type":25,"tag":930,"props":931,"children":934},"span",{"class":932,"line":933},"line",1,[935,940],{"type":25,"tag":930,"props":936,"children":938},{"style":937},"--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[939],{"type":30,"value":898},{"type":25,"tag":930,"props":941,"children":943},{"style":942},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[944],{"type":30,"value":945},":\n",{"type":25,"tag":930,"props":947,"children":948},{"class":932,"line":250},[949,954,959],{"type":25,"tag":930,"props":950,"children":951},{"style":937},[952],{"type":30,"value":953},"  stage",{"type":25,"tag":930,"props":955,"children":956},{"style":942},[957],{"type":30,"value":958},": ",{"type":25,"tag":930,"props":960,"children":962},{"style":961},"--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[963],{"type":30,"value":964},"build\n",{"type":25,"tag":930,"props":966,"children":968},{"class":932,"line":967},3,[969,974,978],{"type":25,"tag":930,"props":970,"children":971},{"style":937},[972],{"type":30,"value":973},"  image",{"type":25,"tag":930,"props":975,"children":976},{"style":942},[977],{"type":30,"value":958},{"type":25,"tag":930,"props":979,"children":980},{"style":961},[981],{"type":30,"value":982},"docker:19.03.1\n",{"type":25,"tag":930,"props":984,"children":986},{"class":932,"line":985},4,[987,992],{"type":25,"tag":930,"props":988,"children":989},{"style":937},[990],{"type":30,"value":991},"  services",{"type":25,"tag":930,"props":993,"children":994},{"style":942},[995],{"type":30,"value":945},{"type":25,"tag":930,"props":997,"children":999},{"class":932,"line":998},5,[1000,1005],{"type":25,"tag":930,"props":1001,"children":1002},{"style":942},[1003],{"type":30,"value":1004},"    - ",{"type":25,"tag":930,"props":1006,"children":1007},{"style":961},[1008],{"type":30,"value":1009},"docker:19.03.5-dind\n",{"type":25,"tag":930,"props":1011,"children":1013},{"class":932,"line":1012},6,[1014,1019],{"type":25,"tag":930,"props":1015,"children":1016},{"style":937},[1017],{"type":30,"value":1018},"  before_script",{"type":25,"tag":930,"props":1020,"children":1021},{"style":942},[1022],{"type":30,"value":945},{"type":25,"tag":930,"props":1024,"children":1026},{"class":932,"line":1025},7,[1027,1031],{"type":25,"tag":930,"props":1028,"children":1029},{"style":942},[1030],{"type":30,"value":1004},{"type":25,"tag":930,"props":1032,"children":1033},{"style":961},[1034],{"type":30,"value":1035},"docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n",{"type":25,"tag":930,"props":1037,"children":1039},{"class":932,"line":1038},8,[1040,1045],{"type":25,"tag":930,"props":1041,"children":1042},{"style":937},[1043],{"type":30,"value":1044},"  script",{"type":25,"tag":930,"props":1046,"children":1047},{"style":942},[1048],{"type":30,"value":945},{"type":25,"tag":930,"props":1050,"children":1052},{"class":932,"line":1051},9,[1053,1057],{"type":25,"tag":930,"props":1054,"children":1055},{"style":942},[1056],{"type":30,"value":1004},{"type":25,"tag":930,"props":1058,"children":1060},{"style":1059},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[1061],{"type":30,"value":1062},"|\n",{"type":25,"tag":930,"props":1064,"children":1066},{"class":932,"line":1065},10,[1067],{"type":25,"tag":930,"props":1068,"children":1069},{"style":961},[1070],{"type":30,"value":1071},"      docker build \\\n",{"type":25,"tag":930,"props":1073,"children":1075},{"class":932,"line":1074},11,[1076],{"type":25,"tag":930,"props":1077,"children":1078},{"style":961},[1079],{"type":30,"value":1080},"        -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \\\n",{"type":25,"tag":930,"props":1082,"children":1084},{"class":932,"line":1083},12,[1085],{"type":25,"tag":930,"props":1086,"children":1087},{"style":961},[1088],{"type":30,"value":1089},"        -f backend/docker/Dockerfile.prod \\\n",{"type":25,"tag":930,"props":1091,"children":1093},{"class":932,"line":1092},13,[1094],{"type":25,"tag":930,"props":1095,"children":1096},{"style":961},[1097],{"type":30,"value":1098},"        ./backend/\n",{"type":25,"tag":930,"props":1100,"children":1102},{"class":932,"line":1101},14,[1103,1107],{"type":25,"tag":930,"props":1104,"children":1105},{"style":942},[1106],{"type":30,"value":1004},{"type":25,"tag":930,"props":1108,"children":1109},{"style":961},[1110],{"type":30,"value":1111},"docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA\n",{"type":25,"tag":26,"props":1113,"children":1114},{},[1115,1121,1123,1129,1131,1136],{"type":25,"tag":130,"props":1116,"children":1118},{"className":1117},[],[1119],{"type":30,"value":1120},"build-nginx",{"type":30,"value":1122}," is almost identical, but the ",{"type":25,"tag":130,"props":1124,"children":1126},{"className":1125},[],[1127],{"type":30,"value":1128},"docker build",{"type":30,"value":1130}," arguments are slightly different. There are three arguments for the ",{"type":25,"tag":130,"props":1132,"children":1134},{"className":1133},[],[1135],{"type":30,"value":1128},{"type":30,"value":1137}," command that I'm using here:",{"type":25,"tag":1139,"props":1140,"children":1141},"ol",{},[1142,1153,1164],{"type":25,"tag":37,"props":1143,"children":1144},{},[1145,1151],{"type":25,"tag":130,"props":1146,"children":1148},{"className":1147},[],[1149],{"type":30,"value":1150},"-t",{"type":30,"value":1152},": the tag to tag the built image with",{"type":25,"tag":37,"props":1154,"children":1155},{},[1156,1162],{"type":25,"tag":130,"props":1157,"children":1159},{"className":1158},[],[1160],{"type":30,"value":1161},"-f",{"type":30,"value":1163},": the Dockerfile to be used for building the image",{"type":25,"tag":37,"props":1165,"children":1166},{},[1167,1169,1175],{"type":30,"value":1168},"the ",{"type":25,"tag":130,"props":1170,"children":1172},{"className":1171},[],[1173],{"type":30,"value":1174},"context",{"type":30,"value":1176}," that is sent to the docker daemon when we build the image",{"type":25,"tag":26,"props":1178,"children":1179},{},[1180,1185,1187,1193,1194,1200,1202,1208,1210,1216,1218,1223,1225,1231,1233,1239,1241,1246,1248,1253],{"type":25,"tag":130,"props":1181,"children":1183},{"className":1182},[],[1184],{"type":30,"value":1150},{"type":30,"value":1186}," makes use of two predefined GitLab CI variables: ",{"type":25,"tag":130,"props":1188,"children":1190},{"className":1189},[],[1191],{"type":30,"value":1192},"CI_REGISTRY_IMAGE",{"type":30,"value":868},{"type":25,"tag":130,"props":1195,"children":1197},{"className":1196},[],[1198],{"type":30,"value":1199},"CI_COMMIT_SHORT_SHA",{"type":30,"value":1201},". ",{"type":25,"tag":130,"props":1203,"children":1205},{"className":1204},[],[1206],{"type":30,"value":1207},"$CI_REGISTRY_IMAGE",{"type":30,"value":1209}," is the URL for the private image registry on gitlab.com that we push our images to that is specific to our project: ",{"type":25,"tag":130,"props":1211,"children":1213},{"className":1212},[],[1214],{"type":30,"value":1215},"registry.gitlab.com/\u003Cgitlab_username>/\u003Cproject_name>",{"type":30,"value":1217},", and ",{"type":25,"tag":130,"props":1219,"children":1221},{"className":1220},[],[1222],{"type":30,"value":1199},{"type":30,"value":1224}," is an character alphanumeric value that contains the truncated name of the commit hash, this is known as the ",{"type":25,"tag":130,"props":1226,"children":1228},{"className":1227},[],[1229],{"type":30,"value":1230},"tag",{"type":30,"value":1232},", even though we pass in more than just this value. We combine these two values with ",{"type":25,"tag":130,"props":1234,"children":1236},{"className":1235},[],[1237],{"type":30,"value":1238},"/",{"type":30,"value":1240}," and the name of the image we are building, such as ",{"type":25,"tag":130,"props":1242,"children":1244},{"className":1243},[],[1245],{"type":30,"value":906},{"type":30,"value":1247},", so the full value being passed to ",{"type":25,"tag":130,"props":1249,"children":1251},{"className":1250},[],[1252],{"type":30,"value":1150},{"type":30,"value":1254}," is:",{"type":25,"tag":693,"props":1256,"children":1258},{"code":1257},"registry.gitlab.com/gitlab-username/my-project/backend:abcd1234\n",[1259],{"type":25,"tag":130,"props":1260,"children":1261},{"__ignoreMap":8},[1262],{"type":30,"value":1257},{"type":25,"tag":26,"props":1264,"children":1265},{},[1266,1271,1273,1279,1281,1286],{"type":25,"tag":130,"props":1267,"children":1269},{"className":1268},[],[1270],{"type":30,"value":1161},{"type":30,"value":1272}," is the path to the ",{"type":25,"tag":130,"props":1274,"children":1276},{"className":1275},[],[1277],{"type":30,"value":1278},"Dockerfile",{"type":30,"value":1280}," we are using relative to the directory where we are running the ",{"type":25,"tag":130,"props":1282,"children":1284},{"className":1283},[],[1285],{"type":30,"value":1128},{"type":30,"value":1287}," command, which is the root directory of the project.",{"type":25,"tag":26,"props":1289,"children":1290},{},[1291,1293,1298,1300,1306,1307,1313,1315,1320,1321,1326,1328,1333,1335,1340,1342,1347,1349,1354,1355,1360,1362,1367,1369,1374,1376,1381],{"type":30,"value":1292},"The final argument defines the context that we are using to build the image, and this is an important part for understanding how Docker works. This argument defines the directory that is zipped up and sent to the docker daemon via the docker API. When we build an image with ",{"type":25,"tag":130,"props":1294,"children":1296},{"className":1295},[],[1297],{"type":30,"value":1128},{"type":30,"value":1299},", we are essentially using the docker CLI to make a POST request to our docker daemon (server) where the POST data contains all of the files that we will have access to in the steps of the Dockerfile (such as ",{"type":25,"tag":130,"props":1301,"children":1303},{"className":1302},[],[1304],{"type":30,"value":1305},"ADD",{"type":30,"value":868},{"type":25,"tag":130,"props":1308,"children":1310},{"className":1309},[],[1311],{"type":30,"value":1312},"COPY",{"type":30,"value":1314}," -- we will get to these soon). There's a key difference between the ",{"type":25,"tag":130,"props":1316,"children":1318},{"className":1317},[],[1319],{"type":30,"value":906},{"type":30,"value":868},{"type":25,"tag":130,"props":1322,"children":1324},{"className":1323},[],[1325],{"type":30,"value":271},{"type":30,"value":1327}," ",{"type":25,"tag":130,"props":1329,"children":1331},{"className":1330},[],[1332],{"type":30,"value":1128},{"type":30,"value":1334}," commands: the context for ",{"type":25,"tag":130,"props":1336,"children":1338},{"className":1337},[],[1339],{"type":30,"value":906},{"type":30,"value":1341}," is ",{"type":25,"tag":130,"props":1343,"children":1345},{"className":1344},[],[1346],{"type":30,"value":906},{"type":30,"value":1348},", but the context for ",{"type":25,"tag":130,"props":1350,"children":1352},{"className":1351},[],[1353],{"type":30,"value":271},{"type":30,"value":1341},{"type":25,"tag":130,"props":1356,"children":1358},{"className":1357},[],[1359],{"type":30,"value":208},{"type":30,"value":1361}," (the root of the project). This is because we may want access to another top level directory in our project that contains, for example, a Vue.js or React application, that we will build into our NGINX container. In order to be able to access both files in the ",{"type":25,"tag":130,"props":1363,"children":1365},{"className":1364},[],[1366],{"type":30,"value":271},{"type":30,"value":1368}," and the folder containing our frontend app, we need to send a context that contains both of these directories. Sending too many files to to the docker daemon when you run docker build will usually cause the ",{"type":25,"tag":130,"props":1370,"children":1372},{"className":1371},[],[1373],{"type":30,"value":1128},{"type":30,"value":1375}," command to hang. The first line of output from a ",{"type":25,"tag":130,"props":1377,"children":1379},{"className":1378},[],[1380],{"type":30,"value":1128},{"type":30,"value":1382}," command should be something like this:",{"type":25,"tag":693,"props":1384,"children":1386},{"code":1385},"Sending build context to Docker daemon  24.58kB\n",[1387],{"type":25,"tag":130,"props":1388,"children":1389},{"__ignoreMap":8},[1390],{"type":30,"value":1385},{"type":25,"tag":26,"props":1392,"children":1393},{},[1394,1396,1402,1404,1410],{"type":30,"value":1395},"If this number is too high, you should use a ",{"type":25,"tag":130,"props":1397,"children":1399},{"className":1398},[],[1400],{"type":30,"value":1401},".dockerignore",{"type":30,"value":1403}," file that ignores any files or directories you don't want to send to the docker daemon (similar to how ",{"type":25,"tag":130,"props":1405,"children":1407},{"className":1406},[],[1408],{"type":30,"value":1409},".gitignore",{"type":30,"value":1411}," works with git).",{"type":25,"tag":26,"props":1413,"children":1414},{},[1415,1417,1423,1425,1431,1433,1439,1440,1446,1448,1454,1456,1462,1464,1470,1472,1477,1478,1483,1485,1490,1492,1497],{"type":30,"value":1416},"To be able to pull and push (read and write) images to our private project container image registry, we need login with our docker client using the ",{"type":25,"tag":130,"props":1418,"children":1420},{"className":1419},[],[1421],{"type":30,"value":1422},"docker login",{"type":30,"value":1424}," command in the ",{"type":25,"tag":130,"props":1426,"children":1428},{"className":1427},[],[1429],{"type":30,"value":1430},"before_script",{"type":30,"value":1432}," as well two other predefined GitLab CI variables: ",{"type":25,"tag":130,"props":1434,"children":1436},{"className":1435},[],[1437],{"type":30,"value":1438},"CI_JOB_TOKEN",{"type":30,"value":868},{"type":25,"tag":130,"props":1441,"children":1443},{"className":1442},[],[1444],{"type":30,"value":1445},"CI_REGISTRY",{"type":30,"value":1447},". This all happens using a special service called ",{"type":25,"tag":130,"props":1449,"children":1451},{"className":1450},[],[1452],{"type":30,"value":1453},"docker-in-docker",{"type":30,"value":1455}," which I won't go into too much detail here, but it is a common practice when working with containers in a CI/CD environment that itself which is also based on containers, such as GitLab CI (each job runs in a container -- the key ",{"type":25,"tag":130,"props":1457,"children":1459},{"className":1458},[],[1460],{"type":30,"value":1461},"image",{"type":30,"value":1463}," -- and can define additional containers -- the ",{"type":25,"tag":130,"props":1465,"children":1467},{"className":1466},[],[1468],{"type":30,"value":1469},"services",{"type":30,"value":1471}," key -- to help with the CI job). Once the two images for ",{"type":25,"tag":130,"props":1473,"children":1475},{"className":1474},[],[1476],{"type":30,"value":906},{"type":30,"value":868},{"type":25,"tag":130,"props":1479,"children":1481},{"className":1480},[],[1482],{"type":30,"value":271},{"type":30,"value":1484}," have been built and pushed, our GitLab CI pipeline moves on to the next stage: ",{"type":25,"tag":130,"props":1486,"children":1488},{"className":1487},[],[1489],{"type":30,"value":874},{"type":30,"value":1491},". In the ",{"type":25,"tag":130,"props":1493,"children":1495},{"className":1494},[],[1496],{"type":30,"value":874},{"type":30,"value":1498}," stage, we will start these and other containers on our DigitalOcean droplet, so we are getting close, but there is a lot more to explain. Before we deploy our containers, we need to do some one-time setup:",{"type":25,"tag":1139,"props":1500,"children":1501},{},[1502,1507],{"type":25,"tag":37,"props":1503,"children":1504},{},[1505],{"type":30,"value":1506},"initialize a single-node docker swarm cluster on our Droplet and",{"type":25,"tag":37,"props":1508,"children":1509},{},[1510],{"type":30,"value":1511},"create a docker network that our cluster's services (containers) will use",{"type":25,"tag":339,"props":1513,"children":1515},{"id":1514},"setup-a-docker-swarm-cluster",[1516],{"type":30,"value":1517},"Setup a docker swarm cluster",{"type":25,"tag":26,"props":1519,"children":1520},{},[1521,1523,1529,1531,1536,1538,1544,1546,1552],{"type":30,"value":1522},"To setup a docker swarm cluster, SSH into the Droplet with the command we introduced above (",{"type":25,"tag":130,"props":1524,"children":1526},{"className":1525},[],[1527],{"type":30,"value":1528},"ssh -i ~/.ssh/a1_rsa root@123.45.578.91",{"type":30,"value":1530}," where ",{"type":25,"tag":130,"props":1532,"children":1534},{"className":1533},[],[1535],{"type":30,"value":709},{"type":30,"value":1537}," is the name of the private key file -- you can ignore the ",{"type":25,"tag":130,"props":1539,"children":1541},{"className":1540},[],[1542],{"type":30,"value":1543},"-i ~/.ssh/a1_rsa",{"type":30,"value":1545}," part if you are using an SSH key called ",{"type":25,"tag":130,"props":1547,"children":1549},{"className":1548},[],[1550],{"type":30,"value":1551},"id_rsa",{"type":30,"value":1553},"), and run the following command:",{"type":25,"tag":693,"props":1555,"children":1557},{"code":1556},"docker swarm init --advertise-addr DROPLET_IP\n",[1558],{"type":25,"tag":130,"props":1559,"children":1560},{"__ignoreMap":8},[1561],{"type":30,"value":1556},{"type":25,"tag":26,"props":1563,"children":1564},{},[1565,1567,1572,1574,1580,1582,1588],{"type":30,"value":1566},"Replace ",{"type":25,"tag":130,"props":1568,"children":1570},{"className":1569},[],[1571],{"type":30,"value":611},{"type":30,"value":1573}," with your Droplet's IP address (e.g. ",{"type":25,"tag":130,"props":1575,"children":1577},{"className":1576},[],[1578],{"type":30,"value":1579},"123.45.578.91",{"type":30,"value":1581},"). Check out ",{"type":25,"tag":41,"props":1583,"children":1586},{"href":1584,"rel":1585},"https://www.digitalocean.com/community/tutorials/how-to-create-a-cluster-of-docker-containers-with-docker-swarm-and-digitalocean-on-ubuntu-16-04",[45],[1587],{"type":30,"value":495},{"type":30,"value":1589}," for some additional information about using docker swarm on GitLab. It is a little bit outdated, but the main ideas should still hold up. Docker swarm is designed to orchestrate containers running on a group (or swarm) of multiple machines. However, it is perfectly fine to run a single-node cluster as we are doing here.",{"type":25,"tag":26,"props":1591,"children":1592},{},[1593,1595,1601,1603,1609,1611,1616,1618,1623,1625,1630],{"type":30,"value":1594},"Docker swarm uses docker-compose files, but using docker swarm is very different from running ",{"type":25,"tag":130,"props":1596,"children":1598},{"className":1597},[],[1599],{"type":30,"value":1600},"docker-compose up",{"type":30,"value":1602},", a command which you might see people running both locally and in production and which also uses docker-compose files. As a best practice, you should not be using ",{"type":25,"tag":130,"props":1604,"children":1606},{"className":1605},[],[1607],{"type":30,"value":1608},"docker-compose",{"type":30,"value":1610}," (the command) in production. Many people do this, and several official tutorials will often end with \"now just run ",{"type":25,"tag":130,"props":1612,"children":1614},{"className":1613},[],[1615],{"type":30,"value":1600},{"type":30,"value":1617}," and you are done\". The first time I ran containers in the cloud I pulled my git repo into a VM, installed docker and docker-compose and ran ",{"type":25,"tag":130,"props":1619,"children":1621},{"className":1620},[],[1622],{"type":30,"value":1600},{"type":30,"value":1624},". It is pretty easy and it works very similarly in both local and production environments, but this guide will be using ",{"type":25,"tag":130,"props":1626,"children":1628},{"className":1627},[],[1629],{"type":30,"value":1608},{"type":30,"value":1631}," in production. There is more I could say here, but the main point is that docker swarm is a simplified version of something like Kubernetes, but it comes built-in to docker and is very simple to use.",{"type":25,"tag":339,"props":1633,"children":1635},{"id":1634},"defining-an-overlay-network",[1636],{"type":30,"value":1637},"Defining an overlay network",{"type":25,"tag":26,"props":1639,"children":1640},{},[1641],{"type":30,"value":1642},"SSH into your droplet and run the following command:",{"type":25,"tag":693,"props":1644,"children":1646},{"code":1645},"docker network create --driver=overlay traefik-public\n",[1647],{"type":25,"tag":130,"props":1648,"children":1649},{"__ignoreMap":8},[1650],{"type":30,"value":1645},{"type":25,"tag":313,"props":1652,"children":1653},{},[1654],{"type":25,"tag":26,"props":1655,"children":1656},{},[1657],{"type":30,"value":1658},"Usually we define networks in our docker-compose file, but this network needs to be defined first and then referenced in our docker-compose file. Here's a thread on SO that goes into a little bit more on why this is necessary, but I still don't have a very clear idea of why this is the case. With another configuration or perhaps docker-compose version, this may not be needed. I'll update this part of the article if I figure anything out.",{"type":25,"tag":26,"props":1660,"children":1661},{},[1662,1664,1670,1672,1677,1679,1685,1687,1694],{"type":30,"value":1663},"Let's go over one more docker concept that will helpful in the next few steps. When you run ",{"type":25,"tag":130,"props":1665,"children":1667},{"className":1666},[],[1668],{"type":30,"value":1669},"docker ps",{"type":30,"value":1671}," on your local machine, the docker CLI first looks to see if the ",{"type":25,"tag":130,"props":1673,"children":1675},{"className":1674},[],[1676],{"type":30,"value":135},{"type":30,"value":1678}," environment variable is set. If it is not, then docker defaults to ",{"type":25,"tag":130,"props":1680,"children":1682},{"className":1681},[],[1683],{"type":30,"value":1684},"unix:///var/run/docker.sock",{"type":30,"value":1686},", a UNIX socket. Check out ",{"type":25,"tag":41,"props":1688,"children":1691},{"href":1689,"rel":1690},"https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock",[45],[1692],{"type":30,"value":1693},"this SO post",{"type":30,"value":1695}," titled \"Can anyone explain docker.sock?\"",{"type":25,"tag":26,"props":1697,"children":1698},{},[1699],{"type":30,"value":1700},"We change the docker host that our local docker CLI is talking to by setting this environment variable, and one nice way to set this environment variables uses an SSH connection:",{"type":25,"tag":693,"props":1702,"children":1704},{"code":1703},"DOCKER_HOST=ssh://root@$DOCKER_IP\n",[1705],{"type":25,"tag":130,"props":1706,"children":1707},{"__ignoreMap":8},[1708],{"type":30,"value":1703},{"type":25,"tag":26,"props":1710,"children":1711},{},[1712,1714,1720],{"type":30,"value":1713},"See this article for a more in-depth discussion: ",{"type":25,"tag":41,"props":1715,"children":1718},{"href":1716,"rel":1717},"https://www.digitalocean.com/community/tutorials/how-to-use-a-remote-docker-server-to-speed-up-your-workflow",[45],[1719],{"type":30,"value":1716},{"type":30,"value":208},{"type":25,"tag":26,"props":1722,"children":1723},{},[1724,1726,1731,1733,1738],{"type":30,"value":1725},"You can try this out locally. Run a container locally, check it with ",{"type":25,"tag":130,"props":1727,"children":1729},{"className":1728},[],[1730],{"type":30,"value":1669},{"type":30,"value":1732},", then export the ",{"type":25,"tag":130,"props":1734,"children":1736},{"className":1735},[],[1737],{"type":30,"value":135},{"type":30,"value":1739}," environment variable with the following command:",{"type":25,"tag":693,"props":1741,"children":1743},{"code":1742},"export DOCKER_HOST=ssh://root@123.45.678.91\n",[1744],{"type":25,"tag":130,"props":1745,"children":1746},{"__ignoreMap":8},[1747],{"type":30,"value":1742},{"type":25,"tag":26,"props":1749,"children":1750},{},[1751,1753,1759,1761,1766],{"type":30,"value":1752},"Replacing ",{"type":25,"tag":130,"props":1754,"children":1756},{"className":1755},[],[1757],{"type":30,"value":1758},"123.45.678.91",{"type":30,"value":1760}," with your Droplet IP. Run ",{"type":25,"tag":130,"props":1762,"children":1764},{"className":1763},[],[1765],{"type":30,"value":1669},{"type":30,"value":1767}," again and you should see nothing (or any other containers that you started on your Droplet). Finally, run:",{"type":25,"tag":693,"props":1769,"children":1771},{"code":1770},"unset DOCKER_HOST\n",[1772],{"type":25,"tag":130,"props":1773,"children":1774},{"__ignoreMap":8},[1775],{"type":30,"value":1770},{"type":25,"tag":26,"props":1777,"children":1778},{},[1779,1781,1786,1788,1794],{"type":30,"value":1780},"Running ",{"type":25,"tag":130,"props":1782,"children":1784},{"className":1783},[],[1785],{"type":30,"value":1669},{"type":30,"value":1787}," again you should see the containers on your machine. We will be using this idea in the next step when we look at the ",{"type":25,"tag":130,"props":1789,"children":1791},{"className":1790},[],[1792],{"type":30,"value":1793},"docker stack deploy",{"type":30,"value":1795}," command.",{"type":25,"tag":339,"props":1797,"children":1799},{"id":1798},"docker-stack-deploy",[1800],{"type":25,"tag":130,"props":1801,"children":1803},{"className":1802},[],[1804],{"type":30,"value":1793},{"type":25,"tag":26,"props":1806,"children":1807},{},[1808,1810,1815,1817,1822,1824,1830],{"type":30,"value":1809},"Now that we have done our one-time-setup steps, let's look at the ",{"type":25,"tag":130,"props":1811,"children":1813},{"className":1812},[],[1814],{"type":30,"value":874},{"type":30,"value":1816}," stage of ",{"type":25,"tag":130,"props":1818,"children":1820},{"className":1819},[],[1821],{"type":30,"value":388},{"type":30,"value":1823},", the GitLab CI job that will get our containers running on our Droplet. First, let's break down the ",{"type":25,"tag":130,"props":1825,"children":1827},{"className":1826},[],[1828],{"type":30,"value":1829},"deploy-digital-ocean",{"type":30,"value":1831}," command:",{"type":25,"tag":693,"props":1833,"children":1835},{"code":1834,"language":923,"meta":8,"className":924,"style":8},"deploy-digital-ocean:\n  stage: deploy\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  variables:\n    DOCKER_HOST: 'ssh://root@$DROPLET_IP'\n  before_script:\n    - apk update && apk add openssh-client bash\n    - mkdir -p ~/.ssh\n    - echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n    - chmod 600 ~/.ssh/id_rsa\n    - eval \"$(ssh-agent -s)\"\n    - ssh-add ~/.ssh/id_rsa\n    - ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY\n  script:\n    - docker stack deploy -c stack.yml my-stack --with-registry-auth\n",[1836],{"type":25,"tag":130,"props":1837,"children":1838},{"__ignoreMap":8},[1839,1850,1866,1881,1892,1903,1915,1932,1943,1955,1967,1979,1991,2003,2015,2028,2040,2052],{"type":25,"tag":930,"props":1840,"children":1841},{"class":932,"line":933},[1842,1846],{"type":25,"tag":930,"props":1843,"children":1844},{"style":937},[1845],{"type":30,"value":1829},{"type":25,"tag":930,"props":1847,"children":1848},{"style":942},[1849],{"type":30,"value":945},{"type":25,"tag":930,"props":1851,"children":1852},{"class":932,"line":250},[1853,1857,1861],{"type":25,"tag":930,"props":1854,"children":1855},{"style":937},[1856],{"type":30,"value":953},{"type":25,"tag":930,"props":1858,"children":1859},{"style":942},[1860],{"type":30,"value":958},{"type":25,"tag":930,"props":1862,"children":1863},{"style":961},[1864],{"type":30,"value":1865},"deploy\n",{"type":25,"tag":930,"props":1867,"children":1868},{"class":932,"line":967},[1869,1873,1877],{"type":25,"tag":930,"props":1870,"children":1871},{"style":937},[1872],{"type":30,"value":973},{"type":25,"tag":930,"props":1874,"children":1875},{"style":942},[1876],{"type":30,"value":958},{"type":25,"tag":930,"props":1878,"children":1879},{"style":961},[1880],{"type":30,"value":982},{"type":25,"tag":930,"props":1882,"children":1883},{"class":932,"line":985},[1884,1888],{"type":25,"tag":930,"props":1885,"children":1886},{"style":937},[1887],{"type":30,"value":991},{"type":25,"tag":930,"props":1889,"children":1890},{"style":942},[1891],{"type":30,"value":945},{"type":25,"tag":930,"props":1893,"children":1894},{"class":932,"line":998},[1895,1899],{"type":25,"tag":930,"props":1896,"children":1897},{"style":942},[1898],{"type":30,"value":1004},{"type":25,"tag":930,"props":1900,"children":1901},{"style":961},[1902],{"type":30,"value":1009},{"type":25,"tag":930,"props":1904,"children":1905},{"class":932,"line":1012},[1906,1911],{"type":25,"tag":930,"props":1907,"children":1908},{"style":937},[1909],{"type":30,"value":1910},"  variables",{"type":25,"tag":930,"props":1912,"children":1913},{"style":942},[1914],{"type":30,"value":945},{"type":25,"tag":930,"props":1916,"children":1917},{"class":932,"line":1025},[1918,1923,1927],{"type":25,"tag":930,"props":1919,"children":1920},{"style":937},[1921],{"type":30,"value":1922},"    DOCKER_HOST",{"type":25,"tag":930,"props":1924,"children":1925},{"style":942},[1926],{"type":30,"value":958},{"type":25,"tag":930,"props":1928,"children":1929},{"style":961},[1930],{"type":30,"value":1931},"'ssh://root@$DROPLET_IP'\n",{"type":25,"tag":930,"props":1933,"children":1934},{"class":932,"line":1038},[1935,1939],{"type":25,"tag":930,"props":1936,"children":1937},{"style":937},[1938],{"type":30,"value":1018},{"type":25,"tag":930,"props":1940,"children":1941},{"style":942},[1942],{"type":30,"value":945},{"type":25,"tag":930,"props":1944,"children":1945},{"class":932,"line":1051},[1946,1950],{"type":25,"tag":930,"props":1947,"children":1948},{"style":942},[1949],{"type":30,"value":1004},{"type":25,"tag":930,"props":1951,"children":1952},{"style":961},[1953],{"type":30,"value":1954},"apk update && apk add openssh-client bash\n",{"type":25,"tag":930,"props":1956,"children":1957},{"class":932,"line":1065},[1958,1962],{"type":25,"tag":930,"props":1959,"children":1960},{"style":942},[1961],{"type":30,"value":1004},{"type":25,"tag":930,"props":1963,"children":1964},{"style":961},[1965],{"type":30,"value":1966},"mkdir -p ~/.ssh\n",{"type":25,"tag":930,"props":1968,"children":1969},{"class":932,"line":1074},[1970,1974],{"type":25,"tag":930,"props":1971,"children":1972},{"style":942},[1973],{"type":30,"value":1004},{"type":25,"tag":930,"props":1975,"children":1976},{"style":961},[1977],{"type":30,"value":1978},"echo \"$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa\n",{"type":25,"tag":930,"props":1980,"children":1981},{"class":932,"line":1083},[1982,1986],{"type":25,"tag":930,"props":1983,"children":1984},{"style":942},[1985],{"type":30,"value":1004},{"type":25,"tag":930,"props":1987,"children":1988},{"style":961},[1989],{"type":30,"value":1990},"chmod 600 ~/.ssh/id_rsa\n",{"type":25,"tag":930,"props":1992,"children":1993},{"class":932,"line":1092},[1994,1998],{"type":25,"tag":930,"props":1995,"children":1996},{"style":942},[1997],{"type":30,"value":1004},{"type":25,"tag":930,"props":1999,"children":2000},{"style":961},[2001],{"type":30,"value":2002},"eval \"$(ssh-agent -s)\"\n",{"type":25,"tag":930,"props":2004,"children":2005},{"class":932,"line":1101},[2006,2010],{"type":25,"tag":930,"props":2007,"children":2008},{"style":942},[2009],{"type":30,"value":1004},{"type":25,"tag":930,"props":2011,"children":2012},{"style":961},[2013],{"type":30,"value":2014},"ssh-add ~/.ssh/id_rsa\n",{"type":25,"tag":930,"props":2016,"children":2018},{"class":932,"line":2017},15,[2019,2023],{"type":25,"tag":930,"props":2020,"children":2021},{"style":942},[2022],{"type":30,"value":1004},{"type":25,"tag":930,"props":2024,"children":2025},{"style":961},[2026],{"type":30,"value":2027},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts\n",{"type":25,"tag":930,"props":2029,"children":2031},{"class":932,"line":2030},16,[2032,2036],{"type":25,"tag":930,"props":2033,"children":2034},{"style":942},[2035],{"type":30,"value":1004},{"type":25,"tag":930,"props":2037,"children":2038},{"style":961},[2039],{"type":30,"value":1035},{"type":25,"tag":930,"props":2041,"children":2043},{"class":932,"line":2042},17,[2044,2048],{"type":25,"tag":930,"props":2045,"children":2046},{"style":937},[2047],{"type":30,"value":1044},{"type":25,"tag":930,"props":2049,"children":2050},{"style":942},[2051],{"type":30,"value":945},{"type":25,"tag":930,"props":2053,"children":2055},{"class":932,"line":2054},18,[2056,2060],{"type":25,"tag":930,"props":2057,"children":2058},{"style":942},[2059],{"type":30,"value":1004},{"type":25,"tag":930,"props":2061,"children":2062},{"style":961},[2063],{"type":30,"value":2064},"docker stack deploy -c stack.yml my-stack --with-registry-auth\n",{"type":25,"tag":26,"props":2066,"children":2067},{},[2068,2070,2075,2076,2081,2083,2088,2090,2095,2096,2102,2104,2109,2111,2117,2119,2125,2127,2133,2135,2141],{"type":30,"value":2069},"This job uses the same ",{"type":25,"tag":130,"props":2071,"children":2073},{"className":2072},[],[2074],{"type":30,"value":1461},{"type":30,"value":868},{"type":25,"tag":130,"props":2077,"children":2079},{"className":2078},[],[2080],{"type":30,"value":1469},{"type":30,"value":2082}," that our ",{"type":25,"tag":130,"props":2084,"children":2086},{"className":2085},[],[2087],{"type":30,"value":866},{"type":30,"value":2089}," stage jobs used. Notice that we set ",{"type":25,"tag":130,"props":2091,"children":2093},{"className":2092},[],[2094],{"type":30,"value":135},{"type":30,"value":158},{"type":25,"tag":130,"props":2097,"children":2099},{"className":2098},[],[2100],{"type":30,"value":2101},"\"ssh://root@$DROPLET_IP\"",{"type":30,"value":2103},", this means that any docker CLI commands in this job will be communicating with the docker daemon on our Droplet. The ",{"type":25,"tag":130,"props":2105,"children":2107},{"className":2106},[],[2108],{"type":30,"value":1430},{"type":30,"value":2110}," has a lot going on, but all we are doing is preparing to use the SSH private key that we previously added to our GitLab project's CI/CD environment variables. The base image for this job, ",{"type":25,"tag":130,"props":2112,"children":2114},{"className":2113},[],[2115],{"type":30,"value":2116},"docker:19.03.1",{"type":30,"value":2118}," is based on Alpine Linus. This version of Linux is super light weight and doesn't come with ",{"type":25,"tag":130,"props":2120,"children":2122},{"className":2121},[],[2123],{"type":30,"value":2124},"openssh-client",{"type":30,"value":2126}," or ",{"type":25,"tag":130,"props":2128,"children":2130},{"className":2129},[],[2131],{"type":30,"value":2132},"bash",{"type":30,"value":2134},", so our first step is to install these with the Alpine package manager, ",{"type":25,"tag":130,"props":2136,"children":2138},{"className":2137},[],[2139],{"type":30,"value":2140},"apk",{"type":30,"value":790},{"type":25,"tag":693,"props":2143,"children":2146},{"code":1954,"language":2144,"meta":8,"className":2145,"style":8},"sh","language-sh shiki shiki-themes github-light github-dark monokai",[2147],{"type":25,"tag":130,"props":2148,"children":2149},{"__ignoreMap":8},[2150],{"type":25,"tag":930,"props":2151,"children":2152},{"class":932,"line":933},[2153,2158,2163,2168,2172,2177,2182],{"type":25,"tag":930,"props":2154,"children":2156},{"style":2155},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[2157],{"type":30,"value":2140},{"type":25,"tag":930,"props":2159,"children":2160},{"style":961},[2161],{"type":30,"value":2162}," update",{"type":25,"tag":930,"props":2164,"children":2165},{"style":942},[2166],{"type":30,"value":2167}," && ",{"type":25,"tag":930,"props":2169,"children":2170},{"style":2155},[2171],{"type":30,"value":2140},{"type":25,"tag":930,"props":2173,"children":2174},{"style":961},[2175],{"type":30,"value":2176}," add",{"type":25,"tag":930,"props":2178,"children":2179},{"style":961},[2180],{"type":30,"value":2181}," openssh-client",{"type":25,"tag":930,"props":2183,"children":2184},{"style":961},[2185],{"type":30,"value":2186}," bash\n",{"type":25,"tag":26,"props":2188,"children":2189},{},[2190,2192,2197,2199,2204,2206,2212,2214,2220,2221,2227],{"type":30,"value":2191},"Next, we add the ",{"type":25,"tag":130,"props":2193,"children":2195},{"className":2194},[],[2196],{"type":30,"value":586},{"type":30,"value":2198}," environment variable into the body of the ",{"type":25,"tag":130,"props":2200,"children":2202},{"className":2201},[],[2203],{"type":30,"value":1551},{"type":30,"value":2205}," private key file, change the permission of this file and then add the key to our SSH agent. Here's an excerpt from ",{"type":25,"tag":130,"props":2207,"children":2209},{"className":2208},[],[2210],{"type":30,"value":2211},"man ssh-agent",{"type":30,"value":2213}," that provides a little bit more context into why we need to run ",{"type":25,"tag":130,"props":2215,"children":2217},{"className":2216},[],[2218],{"type":30,"value":2219},"eval \"$(ssh-agent -s)\"",{"type":30,"value":868},{"type":25,"tag":130,"props":2222,"children":2224},{"className":2223},[],[2225],{"type":30,"value":2226},"ssh-add ~/.ssh/id_rsa",{"type":30,"value":790},{"type":25,"tag":693,"props":2229,"children":2231},{"code":2230},"DESCRIPTION\n     ssh-agent is a program to hold private keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)ssh-agent is usually started in the beginning of an X-session or a login session, and all other windows or programs are started as clients to the ssh-agent program.  Through use of environment variables the agent can be located and automatically used for authentication when logging in to other machines using ssh(1).\n\n     The agent initially does not have any private keys.  Keys are added using ssh(1) (see AddKeysToAgent in ssh_config(5) for details) or ssh-add(1).  Multiple identities may be stored in ssh-agent concurrently and ssh(1) will automatically use them if present.  ssh-add(1) is also used to remove keys from ssh-agent and to query the keys that are held in one.\n",[2232],{"type":25,"tag":130,"props":2233,"children":2234},{"__ignoreMap":8},[2235],{"type":30,"value":2230},{"type":25,"tag":26,"props":2237,"children":2238},{},[2239,2241,2247,2249,2255],{"type":30,"value":2240},"Next, ",{"type":25,"tag":130,"props":2242,"children":2244},{"className":2243},[],[2245],{"type":30,"value":2246},"ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts",{"type":30,"value":2248}," tells our SSH agent about our Droplet so that it doesn't prompt us with a ",{"type":25,"tag":130,"props":2250,"children":2252},{"className":2251},[],[2253],{"type":30,"value":2254},"Do you want to add this server to known hosts? (yes/no)",{"type":30,"value":2256},", or whatever the equivalent of that is for the docker CLI when it attempts to connect to a remote docker daemon over SSH.",{"type":25,"tag":26,"props":2258,"children":2259},{},[2260],{"type":30,"value":2261},"Finally, we login to our our GitLab private registry using the same command from before when we built and pushed images to our private registry on gitlab.com:",{"type":25,"tag":693,"props":2263,"children":2264},{"code":1035},[2265],{"type":25,"tag":130,"props":2266,"children":2267},{"__ignoreMap":8},[2268],{"type":30,"value":1035},{"type":25,"tag":26,"props":2270,"children":2271},{},[2272,2274,2279,2280,2285],{"type":30,"value":2273},"This essentially gives our DigitalOcean Droplet access to the ",{"type":25,"tag":130,"props":2275,"children":2277},{"className":2276},[],[2278],{"type":30,"value":906},{"type":30,"value":868},{"type":25,"tag":130,"props":2281,"children":2283},{"className":2282},[],[2284],{"type":30,"value":271},{"type":30,"value":2286}," images in our private GitLab CI image registry, even tho we are running this command in a contain, in a container that is probably running in Kubernetes on GCP. Next, we are actually going to use these images.",{"type":25,"tag":26,"props":2288,"children":2289},{},[2290,2292,2297],{"type":30,"value":2291},"The last command in the ",{"type":25,"tag":130,"props":2293,"children":2295},{"className":2294},[],[2296],{"type":30,"value":1829},{"type":30,"value":2298}," job is:",{"type":25,"tag":693,"props":2300,"children":2301},{"code":2064},[2302],{"type":25,"tag":130,"props":2303,"children":2304},{"__ignoreMap":8},[2305],{"type":30,"value":2064},{"type":25,"tag":26,"props":2307,"children":2308},{},[2309,2311,2317,2318,2324],{"type":30,"value":2310},"Check out this link from the docker docs on docker stacks ",{"type":25,"tag":41,"props":2312,"children":2315},{"href":2313,"rel":2314},"https://docs.docker.com/engine/swarm/stack-deploy/",[45],[2316],{"type":30,"value":2313},{"type":30,"value":1201},{"type":25,"tag":130,"props":2319,"children":2321},{"className":2320},[],[2322],{"type":30,"value":2323},"--with-registry-auth",{"type":30,"value":2325}," is important, our command will complete if this is not included, but our application won't start.",{"type":25,"tag":339,"props":2327,"children":2329},{"id":2328},"stackyml",[2330],{"type":25,"tag":130,"props":2331,"children":2333},{"className":2332},[],[2334],{"type":30,"value":2335},"stack.yml",{"type":25,"tag":26,"props":2337,"children":2338},{},[2339,2341,2346,2348,2353,2355,2360,2362,2367],{"type":30,"value":2340},"Now we are ready to tackle the last big file in our repo: ",{"type":25,"tag":130,"props":2342,"children":2344},{"className":2343},[],[2345],{"type":30,"value":2335},{"type":30,"value":2347},". This is a the docker-compose file that we use to deploy our project. The only reason we needed to run ",{"type":25,"tag":130,"props":2349,"children":2351},{"className":2350},[],[2352],{"type":30,"value":1422},{"type":30,"value":2354}," above is because ",{"type":25,"tag":130,"props":2356,"children":2358},{"className":2357},[],[2359],{"type":30,"value":2335},{"type":30,"value":2361}," references the two images we built and pushed to our GitLab private repo. There's a lot going on in this file, let's start with the ",{"type":25,"tag":130,"props":2363,"children":2365},{"className":2364},[],[2366],{"type":30,"value":906},{"type":30,"value":2368}," service:",{"type":25,"tag":2370,"props":2371,"children":2372},"h3",{"id":906},[2373],{"type":30,"value":906},{"type":25,"tag":693,"props":2375,"children":2377},{"code":2376,"language":923,"meta":8,"className":924,"style":8},"version: '3.4'\nservices:\n  backend:\n  image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n  networks:\n    - main\n  environment:\n    - POSTGRES_PASSWORD\n    - SECRET_KEY\n    - DEBUG\n  volumes:\n    - backendassets:/code/assets\n  depends_on:\n    - postgres\n    - redis\n    - web\n",[2378],{"type":25,"tag":130,"props":2379,"children":2380},{"__ignoreMap":8},[2381,2398,2409,2421,2437,2449,2461,2473,2485,2497,2509,2521,2533,2545,2557,2569],{"type":25,"tag":930,"props":2382,"children":2383},{"class":932,"line":933},[2384,2389,2393],{"type":25,"tag":930,"props":2385,"children":2386},{"style":937},[2387],{"type":30,"value":2388},"version",{"type":25,"tag":930,"props":2390,"children":2391},{"style":942},[2392],{"type":30,"value":958},{"type":25,"tag":930,"props":2394,"children":2395},{"style":961},[2396],{"type":30,"value":2397},"'3.4'\n",{"type":25,"tag":930,"props":2399,"children":2400},{"class":932,"line":250},[2401,2405],{"type":25,"tag":930,"props":2402,"children":2403},{"style":937},[2404],{"type":30,"value":1469},{"type":25,"tag":930,"props":2406,"children":2407},{"style":942},[2408],{"type":30,"value":945},{"type":25,"tag":930,"props":2410,"children":2411},{"class":932,"line":967},[2412,2417],{"type":25,"tag":930,"props":2413,"children":2414},{"style":937},[2415],{"type":30,"value":2416},"  backend",{"type":25,"tag":930,"props":2418,"children":2419},{"style":942},[2420],{"type":30,"value":945},{"type":25,"tag":930,"props":2422,"children":2423},{"class":932,"line":985},[2424,2428,2432],{"type":25,"tag":930,"props":2425,"children":2426},{"style":937},[2427],{"type":30,"value":973},{"type":25,"tag":930,"props":2429,"children":2430},{"style":942},[2431],{"type":30,"value":958},{"type":25,"tag":930,"props":2433,"children":2434},{"style":961},[2435],{"type":30,"value":2436},"${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\n",{"type":25,"tag":930,"props":2438,"children":2439},{"class":932,"line":998},[2440,2445],{"type":25,"tag":930,"props":2441,"children":2442},{"style":937},[2443],{"type":30,"value":2444},"  networks",{"type":25,"tag":930,"props":2446,"children":2447},{"style":942},[2448],{"type":30,"value":945},{"type":25,"tag":930,"props":2450,"children":2451},{"class":932,"line":1012},[2452,2456],{"type":25,"tag":930,"props":2453,"children":2454},{"style":942},[2455],{"type":30,"value":1004},{"type":25,"tag":930,"props":2457,"children":2458},{"style":961},[2459],{"type":30,"value":2460},"main\n",{"type":25,"tag":930,"props":2462,"children":2463},{"class":932,"line":1025},[2464,2469],{"type":25,"tag":930,"props":2465,"children":2466},{"style":937},[2467],{"type":30,"value":2468},"  environment",{"type":25,"tag":930,"props":2470,"children":2471},{"style":942},[2472],{"type":30,"value":945},{"type":25,"tag":930,"props":2474,"children":2475},{"class":932,"line":1038},[2476,2480],{"type":25,"tag":930,"props":2477,"children":2478},{"style":942},[2479],{"type":30,"value":1004},{"type":25,"tag":930,"props":2481,"children":2482},{"style":961},[2483],{"type":30,"value":2484},"POSTGRES_PASSWORD\n",{"type":25,"tag":930,"props":2486,"children":2487},{"class":932,"line":1051},[2488,2492],{"type":25,"tag":930,"props":2489,"children":2490},{"style":942},[2491],{"type":30,"value":1004},{"type":25,"tag":930,"props":2493,"children":2494},{"style":961},[2495],{"type":30,"value":2496},"SECRET_KEY\n",{"type":25,"tag":930,"props":2498,"children":2499},{"class":932,"line":1065},[2500,2504],{"type":25,"tag":930,"props":2501,"children":2502},{"style":942},[2503],{"type":30,"value":1004},{"type":25,"tag":930,"props":2505,"children":2506},{"style":961},[2507],{"type":30,"value":2508},"DEBUG\n",{"type":25,"tag":930,"props":2510,"children":2511},{"class":932,"line":1074},[2512,2517],{"type":25,"tag":930,"props":2513,"children":2514},{"style":937},[2515],{"type":30,"value":2516},"  volumes",{"type":25,"tag":930,"props":2518,"children":2519},{"style":942},[2520],{"type":30,"value":945},{"type":25,"tag":930,"props":2522,"children":2523},{"class":932,"line":1083},[2524,2528],{"type":25,"tag":930,"props":2525,"children":2526},{"style":942},[2527],{"type":30,"value":1004},{"type":25,"tag":930,"props":2529,"children":2530},{"style":961},[2531],{"type":30,"value":2532},"backendassets:/code/assets\n",{"type":25,"tag":930,"props":2534,"children":2535},{"class":932,"line":1092},[2536,2541],{"type":25,"tag":930,"props":2537,"children":2538},{"style":937},[2539],{"type":30,"value":2540},"  depends_on",{"type":25,"tag":930,"props":2542,"children":2543},{"style":942},[2544],{"type":30,"value":945},{"type":25,"tag":930,"props":2546,"children":2547},{"class":932,"line":1101},[2548,2552],{"type":25,"tag":930,"props":2549,"children":2550},{"style":942},[2551],{"type":30,"value":1004},{"type":25,"tag":930,"props":2553,"children":2554},{"style":961},[2555],{"type":30,"value":2556},"postgres\n",{"type":25,"tag":930,"props":2558,"children":2559},{"class":932,"line":2017},[2560,2564],{"type":25,"tag":930,"props":2561,"children":2562},{"style":942},[2563],{"type":30,"value":1004},{"type":25,"tag":930,"props":2565,"children":2566},{"style":961},[2567],{"type":30,"value":2568},"redis\n",{"type":25,"tag":930,"props":2570,"children":2571},{"class":932,"line":2030},[2572,2576],{"type":25,"tag":930,"props":2573,"children":2574},{"style":942},[2575],{"type":30,"value":1004},{"type":25,"tag":930,"props":2577,"children":2578},{"style":961},[2579],{"type":30,"value":2580},"web\n",{"type":25,"tag":26,"props":2582,"children":2583},{},[2584,2586,2591,2593,2598],{"type":30,"value":2585},"The ",{"type":25,"tag":130,"props":2587,"children":2589},{"className":2588},[],[2590],{"type":30,"value":1461},{"type":30,"value":2592}," is essentially what we defined in ",{"type":25,"tag":130,"props":2594,"children":2596},{"className":2595},[],[2597],{"type":30,"value":388},{"type":30,"value":2599},", but the syntax is slightly different:",{"type":25,"tag":693,"props":2601,"children":2602},{"code":2436},[2603],{"type":25,"tag":130,"props":2604,"children":2605},{"__ignoreMap":8},[2606],{"type":30,"value":2436},{"type":25,"tag":26,"props":2608,"children":2609},{},[2610,2612,2618],{"type":30,"value":2611},"We pass environment variables that we defined in GitLab CI via the ",{"type":25,"tag":130,"props":2613,"children":2615},{"className":2614},[],[2616],{"type":30,"value":2617},"environment",{"type":30,"value":2619}," key.",{"type":25,"tag":26,"props":2621,"children":2622},{},[2623,2625,2631,2633,2639,2641,2647,2649,2655],{"type":30,"value":2624},"The volume ",{"type":25,"tag":130,"props":2626,"children":2628},{"className":2627},[],[2629],{"type":30,"value":2630},"backendassets",{"type":30,"value":2632}," is used for storing static assets (CSS, JS, etc.) as well as media assets (images, videos, any other file type). We mount this directory at ",{"type":25,"tag":130,"props":2634,"children":2636},{"className":2635},[],[2637],{"type":30,"value":2638},"/code/assets",{"type":30,"value":2640}," and then define our ",{"type":25,"tag":130,"props":2642,"children":2644},{"className":2643},[],[2645],{"type":30,"value":2646},"STATIC_ROOT",{"type":30,"value":2648}," in Django's ",{"type":25,"tag":130,"props":2650,"children":2652},{"className":2651},[],[2653],{"type":30,"value":2654},"settings.py",{"type":30,"value":2656}," to be:",{"type":25,"tag":693,"props":2658,"children":2662},{"code":2659,"language":2660,"meta":8,"className":2661,"style":8},"os.path.join(BASE_DIR, \"assets\", \"static\")\n","py","language-py shiki shiki-themes github-light github-dark monokai",[2663],{"type":25,"tag":130,"props":2664,"children":2665},{"__ignoreMap":8},[2666],{"type":25,"tag":930,"props":2667,"children":2668},{"class":932,"line":933},[2669,2674,2680,2684,2689,2693,2698],{"type":25,"tag":930,"props":2670,"children":2671},{"style":942},[2672],{"type":30,"value":2673},"os.path.join(",{"type":25,"tag":930,"props":2675,"children":2677},{"style":2676},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2678],{"type":30,"value":2679},"BASE_DIR",{"type":25,"tag":930,"props":2681,"children":2682},{"style":942},[2683],{"type":30,"value":860},{"type":25,"tag":930,"props":2685,"children":2686},{"style":961},[2687],{"type":30,"value":2688},"\"assets\"",{"type":25,"tag":930,"props":2690,"children":2691},{"style":942},[2692],{"type":30,"value":860},{"type":25,"tag":930,"props":2694,"children":2695},{"style":961},[2696],{"type":30,"value":2697},"\"static\"",{"type":25,"tag":930,"props":2699,"children":2700},{"style":942},[2701],{"type":30,"value":2702},")\n",{"type":25,"tag":26,"props":2704,"children":2705},{},[2706,2708,2714],{"type":30,"value":2707},"Later, when we run ",{"type":25,"tag":130,"props":2709,"children":2711},{"className":2710},[],[2712],{"type":30,"value":2713},"collectstatic",{"type":30,"value":2715},", files are copied to this location in our container, and since this is the location of the volume, the files are actually copied to the volume and will be persisted if we destroy the backend container and restart it. When the container restarts, the volume is mounted again and the static files will still be available to our application.",{"type":25,"tag":26,"props":2717,"children":2718},{},[2719,2725,2726,2732,2734,2740,2742,2748,2750,2755,2757,2763],{"type":25,"tag":130,"props":2720,"children":2722},{"className":2721},[],[2723],{"type":30,"value":2724},"network",{"type":30,"value":868},{"type":25,"tag":130,"props":2727,"children":2729},{"className":2728},[],[2730],{"type":30,"value":2731},"depends_on",{"type":30,"value":2733}," related to to the other services that this application will communicate with. ",{"type":25,"tag":130,"props":2735,"children":2737},{"className":2736},[],[2738],{"type":30,"value":2739},"main",{"type":30,"value":2741}," is a network defined in the ",{"type":25,"tag":130,"props":2743,"children":2745},{"className":2744},[],[2746],{"type":30,"value":2747},"networks",{"type":30,"value":2749}," part of ",{"type":25,"tag":130,"props":2751,"children":2753},{"className":2752},[],[2754],{"type":30,"value":2335},{"type":30,"value":2756},", notice that we reference the ",{"type":25,"tag":130,"props":2758,"children":2760},{"className":2759},[],[2761],{"type":30,"value":2762},"traefik-public",{"type":30,"value":2764}," network here that we created earlier, as well.",{"type":25,"tag":313,"props":2766,"children":2767},{},[2768],{"type":25,"tag":26,"props":2769,"children":2770},{},[2771,2773,2779],{"type":30,"value":2772},"Depends on helps with service startup order, but it is a better practice to use ",{"type":25,"tag":130,"props":2774,"children":2776},{"className":2775},[],[2777],{"type":30,"value":2778},"./wait-for-it.sh",{"type":30,"value":2780},". However, I have never had any issues related to startup order. I'll try adding this later to make things more robust.",{"type":25,"tag":26,"props":2782,"children":2783},{},[2784,2790,2791,2797,2799,2804,2806,2811,2812,2817,2819,2824,2825,2830,2831,2836,2838,2843,2845,2851,2853,2859,2861,2866],{"type":25,"tag":130,"props":2785,"children":2787},{"className":2786},[],[2788],{"type":30,"value":2789},"postgres",{"type":30,"value":868},{"type":25,"tag":130,"props":2792,"children":2794},{"className":2793},[],[2795],{"type":30,"value":2796},"redis",{"type":30,"value":2798}," will start before ",{"type":25,"tag":130,"props":2800,"children":2802},{"className":2801},[],[2803],{"type":30,"value":906},{"type":30,"value":2805},". Our Django application will communicate to these services by their hostnames: ",{"type":25,"tag":130,"props":2807,"children":2809},{"className":2808},[],[2810],{"type":30,"value":2789},{"type":30,"value":868},{"type":25,"tag":130,"props":2813,"children":2815},{"className":2814},[],[2816],{"type":30,"value":2796},{"type":30,"value":2818},". The fact that ",{"type":25,"tag":130,"props":2820,"children":2822},{"className":2821},[],[2823],{"type":30,"value":906},{"type":30,"value":860},{"type":25,"tag":130,"props":2826,"children":2828},{"className":2827},[],[2829],{"type":30,"value":2789},{"type":30,"value":868},{"type":25,"tag":130,"props":2832,"children":2834},{"className":2833},[],[2835],{"type":30,"value":2796},{"type":30,"value":2837}," are all on the same network (",{"type":25,"tag":130,"props":2839,"children":2841},{"className":2840},[],[2842],{"type":30,"value":2739},{"type":30,"value":2844},") means that they can resolve each other by these names. For example, the connection string to redis will look like: ",{"type":25,"tag":130,"props":2846,"children":2848},{"className":2847},[],[2849],{"type":30,"value":2850},"redis://redis:6379",{"type":30,"value":2852},". Let's look at the ",{"type":25,"tag":130,"props":2854,"children":2856},{"className":2855},[],[2857],{"type":30,"value":2858},"DATABASES",{"type":30,"value":2860}," configuration in ",{"type":25,"tag":130,"props":2862,"children":2864},{"className":2863},[],[2865],{"type":30,"value":2654},{"type":30,"value":2867}," to see how we connect to Postgres:",{"type":25,"tag":693,"props":2869,"children":2871},{"code":2870,"language":2660,"meta":8,"className":2661,"style":8},"DATABASES = {\n    \"default\": {\n        \"ENGINE\": \"django.db.backends.postgresql_psycopg2\",\n        \"NAME\": os.environ.get(\"POSTGRES_NAME\", \"postgres\"),\n        \"USER\": os.environ.get(\"POSTGRES_USERNAME\", \"postgres\"),\n        \"PASSWORD\": os.environ.get(\"POSTGRES_PASSWORD\", \"postgres\"),\n        \"HOST\": os.environ.get(\"POSTGRES_SERVICE_HOST\", \"postgres\"),\n        \"PORT\": os.environ.get(\"POSTGRES_SERVICE_PORT\", 5432),\n    }\n}\n",[2872],{"type":25,"tag":130,"props":2873,"children":2874},{"__ignoreMap":8},[2875,2892,2905,2927,2959,2988,3017,3046,3076,3084],{"type":25,"tag":930,"props":2876,"children":2877},{"class":932,"line":933},[2878,2882,2887],{"type":25,"tag":930,"props":2879,"children":2880},{"style":2676},[2881],{"type":30,"value":2858},{"type":25,"tag":930,"props":2883,"children":2884},{"style":1059},[2885],{"type":30,"value":2886}," =",{"type":25,"tag":930,"props":2888,"children":2889},{"style":942},[2890],{"type":30,"value":2891}," {\n",{"type":25,"tag":930,"props":2893,"children":2894},{"class":932,"line":250},[2895,2900],{"type":25,"tag":930,"props":2896,"children":2897},{"style":961},[2898],{"type":30,"value":2899},"    \"default\"",{"type":25,"tag":930,"props":2901,"children":2902},{"style":942},[2903],{"type":30,"value":2904},": {\n",{"type":25,"tag":930,"props":2906,"children":2907},{"class":932,"line":967},[2908,2913,2917,2922],{"type":25,"tag":930,"props":2909,"children":2910},{"style":961},[2911],{"type":30,"value":2912},"        \"ENGINE\"",{"type":25,"tag":930,"props":2914,"children":2915},{"style":942},[2916],{"type":30,"value":958},{"type":25,"tag":930,"props":2918,"children":2919},{"style":961},[2920],{"type":30,"value":2921},"\"django.db.backends.postgresql_psycopg2\"",{"type":25,"tag":930,"props":2923,"children":2924},{"style":942},[2925],{"type":30,"value":2926},",\n",{"type":25,"tag":930,"props":2928,"children":2929},{"class":932,"line":985},[2930,2935,2940,2945,2949,2954],{"type":25,"tag":930,"props":2931,"children":2932},{"style":961},[2933],{"type":30,"value":2934},"        \"NAME\"",{"type":25,"tag":930,"props":2936,"children":2937},{"style":942},[2938],{"type":30,"value":2939},": os.environ.get(",{"type":25,"tag":930,"props":2941,"children":2942},{"style":961},[2943],{"type":30,"value":2944},"\"POSTGRES_NAME\"",{"type":25,"tag":930,"props":2946,"children":2947},{"style":942},[2948],{"type":30,"value":860},{"type":25,"tag":930,"props":2950,"children":2951},{"style":961},[2952],{"type":30,"value":2953},"\"postgres\"",{"type":25,"tag":930,"props":2955,"children":2956},{"style":942},[2957],{"type":30,"value":2958},"),\n",{"type":25,"tag":930,"props":2960,"children":2961},{"class":932,"line":998},[2962,2967,2971,2976,2980,2984],{"type":25,"tag":930,"props":2963,"children":2964},{"style":961},[2965],{"type":30,"value":2966},"        \"USER\"",{"type":25,"tag":930,"props":2968,"children":2969},{"style":942},[2970],{"type":30,"value":2939},{"type":25,"tag":930,"props":2972,"children":2973},{"style":961},[2974],{"type":30,"value":2975},"\"POSTGRES_USERNAME\"",{"type":25,"tag":930,"props":2977,"children":2978},{"style":942},[2979],{"type":30,"value":860},{"type":25,"tag":930,"props":2981,"children":2982},{"style":961},[2983],{"type":30,"value":2953},{"type":25,"tag":930,"props":2985,"children":2986},{"style":942},[2987],{"type":30,"value":2958},{"type":25,"tag":930,"props":2989,"children":2990},{"class":932,"line":1012},[2991,2996,3000,3005,3009,3013],{"type":25,"tag":930,"props":2992,"children":2993},{"style":961},[2994],{"type":30,"value":2995},"        \"PASSWORD\"",{"type":25,"tag":930,"props":2997,"children":2998},{"style":942},[2999],{"type":30,"value":2939},{"type":25,"tag":930,"props":3001,"children":3002},{"style":961},[3003],{"type":30,"value":3004},"\"POSTGRES_PASSWORD\"",{"type":25,"tag":930,"props":3006,"children":3007},{"style":942},[3008],{"type":30,"value":860},{"type":25,"tag":930,"props":3010,"children":3011},{"style":961},[3012],{"type":30,"value":2953},{"type":25,"tag":930,"props":3014,"children":3015},{"style":942},[3016],{"type":30,"value":2958},{"type":25,"tag":930,"props":3018,"children":3019},{"class":932,"line":1025},[3020,3025,3029,3034,3038,3042],{"type":25,"tag":930,"props":3021,"children":3022},{"style":961},[3023],{"type":30,"value":3024},"        \"HOST\"",{"type":25,"tag":930,"props":3026,"children":3027},{"style":942},[3028],{"type":30,"value":2939},{"type":25,"tag":930,"props":3030,"children":3031},{"style":961},[3032],{"type":30,"value":3033},"\"POSTGRES_SERVICE_HOST\"",{"type":25,"tag":930,"props":3035,"children":3036},{"style":942},[3037],{"type":30,"value":860},{"type":25,"tag":930,"props":3039,"children":3040},{"style":961},[3041],{"type":30,"value":2953},{"type":25,"tag":930,"props":3043,"children":3044},{"style":942},[3045],{"type":30,"value":2958},{"type":25,"tag":930,"props":3047,"children":3048},{"class":932,"line":1038},[3049,3054,3058,3063,3067,3072],{"type":25,"tag":930,"props":3050,"children":3051},{"style":961},[3052],{"type":30,"value":3053},"        \"PORT\"",{"type":25,"tag":930,"props":3055,"children":3056},{"style":942},[3057],{"type":30,"value":2939},{"type":25,"tag":930,"props":3059,"children":3060},{"style":961},[3061],{"type":30,"value":3062},"\"POSTGRES_SERVICE_PORT\"",{"type":25,"tag":930,"props":3064,"children":3065},{"style":942},[3066],{"type":30,"value":860},{"type":25,"tag":930,"props":3068,"children":3069},{"style":2676},[3070],{"type":30,"value":3071},"5432",{"type":25,"tag":930,"props":3073,"children":3074},{"style":942},[3075],{"type":30,"value":2958},{"type":25,"tag":930,"props":3077,"children":3078},{"class":932,"line":1051},[3079],{"type":25,"tag":930,"props":3080,"children":3081},{"style":942},[3082],{"type":30,"value":3083},"    }\n",{"type":25,"tag":930,"props":3085,"children":3086},{"class":932,"line":1065},[3087],{"type":25,"tag":930,"props":3088,"children":3089},{"style":942},[3090],{"type":30,"value":3091},"}\n",{"type":25,"tag":26,"props":3093,"children":3094},{},[3095,3097,3103,3105,3111,3113,3119],{"type":30,"value":3096},"I have defined the ",{"type":25,"tag":130,"props":3098,"children":3100},{"className":3099},[],[3101],{"type":30,"value":3102},"HOST",{"type":30,"value":3104}," to be based on the environment variable ",{"type":25,"tag":130,"props":3106,"children":3108},{"className":3107},[],[3109],{"type":30,"value":3110},"POSTGRES_HOST",{"type":30,"value":3112},", but I have not defined this environment variable, so why didn't I just say ",{"type":25,"tag":130,"props":3114,"children":3116},{"className":3115},[],[3117],{"type":30,"value":3118},"\"HOST\": \"postgres\"",{"type":30,"value":3120},"? I could have, but if I want to change the database in the future, the only change will be adding an environment variable; I won't have to worry about hardcoded values.",{"type":25,"tag":26,"props":3122,"children":3123},{},[3124],{"type":30,"value":3125},"I'm choosing to run Postgres in a container and not use a managed database (which DigitalOcean does offer) in order to save on costs and also to get more practice managing my own database. I use RDS with AWS and it handles a lot of things that I don't have to worry about, such as backups, and it allows me to quickly restore from a snapshot. I'm interested in learning more about how I can do these tasks with a database that I run myself.",{"type":25,"tag":2370,"props":3127,"children":3128},{"id":271},[3129],{"type":30,"value":3130},"NGINX",{"type":25,"tag":26,"props":3132,"children":3133},{},[3134,3136,3142],{"type":30,"value":3135},"The next service we should go over is ",{"type":25,"tag":130,"props":3137,"children":3139},{"className":3138},[],[3140],{"type":30,"value":3141},"web",{"type":30,"value":3143},", the service that runs the NGINX container that we pushed to our private GitLab image registry. This service has a couple of functions that I'll walk through:",{"type":25,"tag":1139,"props":3145,"children":3146},{},[3147,3152,3157],{"type":25,"tag":37,"props":3148,"children":3149},{},[3150],{"type":30,"value":3151},"Reverse proxy",{"type":25,"tag":37,"props":3153,"children":3154},{},[3155],{"type":30,"value":3156},"Serve static files for Django",{"type":25,"tag":37,"props":3158,"children":3159},{},[3160],{"type":30,"value":3161},"Serve a frontend Javascript application",{"type":25,"tag":26,"props":3163,"children":3164},{},[3165,3167,3172],{"type":30,"value":3166},"Here's the definition of this service in ",{"type":25,"tag":130,"props":3168,"children":3170},{"className":3169},[],[3171],{"type":30,"value":2335},{"type":30,"value":790},{"type":25,"tag":693,"props":3174,"children":3176},{"code":3175,"language":923,"meta":8,"className":924,"style":8},"services:\n  web:\n    image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n    networks:\n      - traefik-public\n      - main\n    volumes:\n      - backendassets:/usr/src/app/assets\n    deploy:\n      labels:\n        - 'traefik.enable=true'\n        - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n        - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n        - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n        - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",[3177],{"type":25,"tag":130,"props":3178,"children":3179},{"__ignoreMap":8},[3180,3191,3203,3220,3232,3245,3256,3268,3280,3292,3304,3317,3329,3341,3353],{"type":25,"tag":930,"props":3181,"children":3182},{"class":932,"line":933},[3183,3187],{"type":25,"tag":930,"props":3184,"children":3185},{"style":937},[3186],{"type":30,"value":1469},{"type":25,"tag":930,"props":3188,"children":3189},{"style":942},[3190],{"type":30,"value":945},{"type":25,"tag":930,"props":3192,"children":3193},{"class":932,"line":250},[3194,3199],{"type":25,"tag":930,"props":3195,"children":3196},{"style":937},[3197],{"type":30,"value":3198},"  web",{"type":25,"tag":930,"props":3200,"children":3201},{"style":942},[3202],{"type":30,"value":945},{"type":25,"tag":930,"props":3204,"children":3205},{"class":932,"line":967},[3206,3211,3215],{"type":25,"tag":930,"props":3207,"children":3208},{"style":937},[3209],{"type":30,"value":3210},"    image",{"type":25,"tag":930,"props":3212,"children":3213},{"style":942},[3214],{"type":30,"value":958},{"type":25,"tag":930,"props":3216,"children":3217},{"style":961},[3218],{"type":30,"value":3219},"${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHORT_SHA}\n",{"type":25,"tag":930,"props":3221,"children":3222},{"class":932,"line":985},[3223,3228],{"type":25,"tag":930,"props":3224,"children":3225},{"style":937},[3226],{"type":30,"value":3227},"    networks",{"type":25,"tag":930,"props":3229,"children":3230},{"style":942},[3231],{"type":30,"value":945},{"type":25,"tag":930,"props":3233,"children":3234},{"class":932,"line":998},[3235,3240],{"type":25,"tag":930,"props":3236,"children":3237},{"style":942},[3238],{"type":30,"value":3239},"      - ",{"type":25,"tag":930,"props":3241,"children":3242},{"style":961},[3243],{"type":30,"value":3244},"traefik-public\n",{"type":25,"tag":930,"props":3246,"children":3247},{"class":932,"line":1012},[3248,3252],{"type":25,"tag":930,"props":3249,"children":3250},{"style":942},[3251],{"type":30,"value":3239},{"type":25,"tag":930,"props":3253,"children":3254},{"style":961},[3255],{"type":30,"value":2460},{"type":25,"tag":930,"props":3257,"children":3258},{"class":932,"line":1025},[3259,3264],{"type":25,"tag":930,"props":3260,"children":3261},{"style":937},[3262],{"type":30,"value":3263},"    volumes",{"type":25,"tag":930,"props":3265,"children":3266},{"style":942},[3267],{"type":30,"value":945},{"type":25,"tag":930,"props":3269,"children":3270},{"class":932,"line":1038},[3271,3275],{"type":25,"tag":930,"props":3272,"children":3273},{"style":942},[3274],{"type":30,"value":3239},{"type":25,"tag":930,"props":3276,"children":3277},{"style":961},[3278],{"type":30,"value":3279},"backendassets:/usr/src/app/assets\n",{"type":25,"tag":930,"props":3281,"children":3282},{"class":932,"line":1051},[3283,3288],{"type":25,"tag":930,"props":3284,"children":3285},{"style":937},[3286],{"type":30,"value":3287},"    deploy",{"type":25,"tag":930,"props":3289,"children":3290},{"style":942},[3291],{"type":30,"value":945},{"type":25,"tag":930,"props":3293,"children":3294},{"class":932,"line":1065},[3295,3300],{"type":25,"tag":930,"props":3296,"children":3297},{"style":937},[3298],{"type":30,"value":3299},"      labels",{"type":25,"tag":930,"props":3301,"children":3302},{"style":942},[3303],{"type":30,"value":945},{"type":25,"tag":930,"props":3305,"children":3306},{"class":932,"line":1074},[3307,3312],{"type":25,"tag":930,"props":3308,"children":3309},{"style":942},[3310],{"type":30,"value":3311},"        - ",{"type":25,"tag":930,"props":3313,"children":3314},{"style":961},[3315],{"type":30,"value":3316},"'traefik.enable=true'\n",{"type":25,"tag":930,"props":3318,"children":3319},{"class":932,"line":1083},[3320,3324],{"type":25,"tag":930,"props":3321,"children":3322},{"style":942},[3323],{"type":30,"value":3311},{"type":25,"tag":930,"props":3325,"children":3326},{"style":961},[3327],{"type":30,"value":3328},"'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n",{"type":25,"tag":930,"props":3330,"children":3331},{"class":932,"line":1092},[3332,3336],{"type":25,"tag":930,"props":3333,"children":3334},{"style":942},[3335],{"type":30,"value":3311},{"type":25,"tag":930,"props":3337,"children":3338},{"style":961},[3339],{"type":30,"value":3340},"'traefik.http.routers.nginx-web.entrypoints=websecure'\n",{"type":25,"tag":930,"props":3342,"children":3343},{"class":932,"line":1101},[3344,3348],{"type":25,"tag":930,"props":3345,"children":3346},{"style":942},[3347],{"type":30,"value":3311},{"type":25,"tag":930,"props":3349,"children":3350},{"style":961},[3351],{"type":30,"value":3352},"'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n",{"type":25,"tag":930,"props":3354,"children":3355},{"class":932,"line":2017},[3356,3360],{"type":25,"tag":930,"props":3357,"children":3358},{"style":942},[3359],{"type":30,"value":3311},{"type":25,"tag":930,"props":3361,"children":3362},{"style":961},[3363],{"type":30,"value":3364},"'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n",{"type":25,"tag":26,"props":3366,"children":3367},{},[3368,3370,3375,3377,3382],{"type":30,"value":3369},"For now, ignore the contents under the ",{"type":25,"tag":130,"props":3371,"children":3373},{"className":3372},[],[3374],{"type":30,"value":874},{"type":30,"value":3376}," key; we will cover this next when we go over the ",{"type":25,"tag":130,"props":3378,"children":3380},{"className":3379},[],[3381],{"type":30,"value":270},{"type":30,"value":3383}," service.",{"type":25,"tag":26,"props":3385,"children":3386},{},[3387,3389,3395,3396,3402,3404,3409,3411,3417],{"type":30,"value":3388},"NGINX acts as a reverse proxy when it sends request starting with ",{"type":25,"tag":130,"props":3390,"children":3392},{"className":3391},[],[3393],{"type":30,"value":3394},"/api",{"type":30,"value":2126},{"type":25,"tag":130,"props":3397,"children":3399},{"className":3398},[],[3400],{"type":30,"value":3401},"/admin",{"type":30,"value":3403}," to the ",{"type":25,"tag":130,"props":3405,"children":3407},{"className":3406},[],[3408],{"type":30,"value":906},{"type":30,"value":3410}," container. Two blocks in ",{"type":25,"tag":130,"props":3412,"children":3414},{"className":3413},[],[3415],{"type":30,"value":3416},"prod.conf",{"type":30,"value":3418}," enable this behavior:",{"type":25,"tag":693,"props":3420,"children":3422},{"code":3421},"  upstream backend {\n    server backend:8000;\n  }\n",[3423],{"type":25,"tag":130,"props":3424,"children":3425},{"__ignoreMap":8},[3426],{"type":30,"value":3421},{"type":25,"tag":26,"props":3428,"children":3429},{},[3430,3432,3437,3439,3445,3446,3451,3453,3458,3460,3465,3467,3472,3474,3479,3480,3485,3487,3492,3494,3499],{"type":30,"value":3431},"This hostname ",{"type":25,"tag":130,"props":3433,"children":3435},{"className":3434},[],[3436],{"type":30,"value":906},{"type":30,"value":3438}," is defined as ",{"type":25,"tag":130,"props":3440,"children":3442},{"className":3441},[],[3443],{"type":30,"value":3444},"backend:8000",{"type":30,"value":1201},{"type":25,"tag":130,"props":3447,"children":3449},{"className":3448},[],[3450],{"type":30,"value":3444},{"type":30,"value":3452}," can be resolved by the ",{"type":25,"tag":130,"props":3454,"children":3456},{"className":3455},[],[3457],{"type":30,"value":3141},{"type":30,"value":3459}," service because it is on the same ",{"type":25,"tag":130,"props":3461,"children":3463},{"className":3462},[],[3464],{"type":30,"value":2739},{"type":30,"value":3466}," network that ",{"type":25,"tag":130,"props":3468,"children":3470},{"className":3469},[],[3471],{"type":30,"value":906},{"type":30,"value":3473}," is on. If either of the ",{"type":25,"tag":130,"props":3475,"children":3477},{"className":3476},[],[3478],{"type":30,"value":3141},{"type":30,"value":2126},{"type":25,"tag":130,"props":3481,"children":3483},{"className":3482},[],[3484],{"type":30,"value":906},{"type":30,"value":3486}," wasn't on the ",{"type":25,"tag":130,"props":3488,"children":3490},{"className":3489},[],[3491],{"type":30,"value":2739},{"type":30,"value":3493}," network, NGINX would not be able to make sense of ",{"type":25,"tag":130,"props":3495,"children":3497},{"className":3496},[],[3498],{"type":30,"value":3444},{"type":30,"value":208},{"type":25,"tag":693,"props":3501,"children":3503},{"code":3502},"    # backend urls\n    location ~ ^/(admin|api) {\n      proxy_redirect off;\n      proxy_pass http://backend;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n    }\n",[3504],{"type":25,"tag":130,"props":3505,"children":3506},{"__ignoreMap":8},[3507],{"type":30,"value":3502},{"type":25,"tag":26,"props":3509,"children":3510},{},[3511,3513,3519,3521,3527],{"type":30,"value":3512},"This block does that actual request forwarding. ",{"type":25,"tag":130,"props":3514,"children":3516},{"className":3515},[],[3517],{"type":30,"value":3518},"http://backend",{"type":30,"value":3520}," references the ",{"type":25,"tag":130,"props":3522,"children":3524},{"className":3523},[],[3525],{"type":30,"value":3526},"upstream backend {}",{"type":30,"value":3528}," block defined above.",{"type":25,"tag":26,"props":3530,"children":3531},{},[3532,3533,3538,3540,3546,3548,3553],{"type":30,"value":2624},{"type":25,"tag":130,"props":3534,"children":3536},{"className":3535},[],[3537],{"type":30,"value":2630},{"type":30,"value":3539}," is referenced here and mounts to ",{"type":25,"tag":130,"props":3541,"children":3543},{"className":3542},[],[3544],{"type":30,"value":3545},"/usr/src/app/assets",{"type":30,"value":3547},". This path is then referenced in ",{"type":25,"tag":130,"props":3549,"children":3551},{"className":3550},[],[3552],{"type":30,"value":3416},{"type":30,"value":3554},", the NGINX configuration file that is used in our custom NGINX-based image:",{"type":25,"tag":693,"props":3556,"children":3558},{"code":3557},"    # static files\n    location /static {\n      autoindex on;\n      alias /usr/src/app/assets/static;\n    }\n",[3559],{"type":25,"tag":130,"props":3560,"children":3561},{"__ignoreMap":8},[3562],{"type":30,"value":3557},{"type":25,"tag":26,"props":3564,"children":3565},{},[3566,3568,3573,3575,3581,3583,3589,3591,3597,3599,3604,3606,3612,3614,3619,3621,3626,3628,3633,3635,3640],{"type":30,"value":3567},"In this block of ",{"type":25,"tag":130,"props":3569,"children":3571},{"className":3570},[],[3572],{"type":30,"value":3416},{"type":30,"value":3574},", we tell NGINX to serve files from ",{"type":25,"tag":130,"props":3576,"children":3578},{"className":3577},[],[3579],{"type":30,"value":3580},"/usr/src/app/assets/static",{"type":30,"value":3582}," for requests that start with ",{"type":25,"tag":130,"props":3584,"children":3586},{"className":3585},[],[3587],{"type":30,"value":3588},"/static",{"type":30,"value":3590},". A request made to ",{"type":25,"tag":130,"props":3592,"children":3594},{"className":3593},[],[3595],{"type":30,"value":3596},"https://mysite.com/static/base.css",{"type":30,"value":3598}," would return a file located at ",{"type":25,"tag":130,"props":3600,"children":3602},{"className":3601},[],[3603],{"type":30,"value":3580},{"type":30,"value":3605}," if that file existed. Remember, when we run the ",{"type":25,"tag":130,"props":3607,"children":3609},{"className":3608},[],[3610],{"type":30,"value":3611},"collecstatic",{"type":30,"value":3613}," management command in our Django container, it will collect our static files to ",{"type":25,"tag":130,"props":3615,"children":3617},{"className":3616},[],[3618],{"type":30,"value":2630},{"type":30,"value":3620},". Since ",{"type":25,"tag":130,"props":3622,"children":3624},{"className":3623},[],[3625],{"type":30,"value":2630},{"type":30,"value":3627}," is mounted to the ",{"type":25,"tag":130,"props":3629,"children":3631},{"className":3630},[],[3632],{"type":30,"value":3141},{"type":30,"value":3634}," service at ",{"type":25,"tag":130,"props":3636,"children":3638},{"className":3637},[],[3639],{"type":30,"value":3545},{"type":30,"value":3641},", NGINX will have access to these files by way of the volume mount and they will persist across restarts of the web service and its NGINX container.",{"type":25,"tag":26,"props":3643,"children":3644},{},[3645,3647,3652],{"type":30,"value":3646},"Finally, NGINX can serve a Javascript SPA or similar if we choose to use one in our project. To understand how this is done, we need to understand multistage Dockerfiles. Here's the Dockerfile used for the ",{"type":25,"tag":130,"props":3648,"children":3650},{"className":3649},[],[3651],{"type":30,"value":271},{"type":30,"value":3653}," container:",{"type":25,"tag":693,"props":3655,"children":3658},{"code":3656,"language":1278,"meta":8,"className":3657,"style":8},"# # build stage\n# FROM node:10-alpine as build-stage\n# WORKDIR /app/\n# COPY frontend/package.json /app/\n# RUN npm cache verify\n# RUN npm install\n# COPY frontend /app/\n# RUN npm run build\n\n# production stage\n# FROM nginx:1.19.1-alpine as production-stage\nFROM nginx:1.19.1-alpine\nCOPY nginx/prod/prod.conf /etc/nginx/nginx.conf\nCOPY nginx/prod/index.html /dist/\n# COPY --from=build-stage /app/dist /dist/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n","language-Dockerfile shiki shiki-themes github-light github-dark monokai",[3659],{"type":25,"tag":130,"props":3660,"children":3661},{"__ignoreMap":8},[3662,3670,3678,3686,3694,3702,3710,3718,3726,3734,3742,3750,3758,3766,3774,3782,3790],{"type":25,"tag":930,"props":3663,"children":3664},{"class":932,"line":933},[3665],{"type":25,"tag":930,"props":3666,"children":3667},{},[3668],{"type":30,"value":3669},"# # build stage\n",{"type":25,"tag":930,"props":3671,"children":3672},{"class":932,"line":250},[3673],{"type":25,"tag":930,"props":3674,"children":3675},{},[3676],{"type":30,"value":3677},"# FROM node:10-alpine as build-stage\n",{"type":25,"tag":930,"props":3679,"children":3680},{"class":932,"line":967},[3681],{"type":25,"tag":930,"props":3682,"children":3683},{},[3684],{"type":30,"value":3685},"# WORKDIR /app/\n",{"type":25,"tag":930,"props":3687,"children":3688},{"class":932,"line":985},[3689],{"type":25,"tag":930,"props":3690,"children":3691},{},[3692],{"type":30,"value":3693},"# COPY frontend/package.json /app/\n",{"type":25,"tag":930,"props":3695,"children":3696},{"class":932,"line":998},[3697],{"type":25,"tag":930,"props":3698,"children":3699},{},[3700],{"type":30,"value":3701},"# RUN npm cache verify\n",{"type":25,"tag":930,"props":3703,"children":3704},{"class":932,"line":1012},[3705],{"type":25,"tag":930,"props":3706,"children":3707},{},[3708],{"type":30,"value":3709},"# RUN npm install\n",{"type":25,"tag":930,"props":3711,"children":3712},{"class":932,"line":1025},[3713],{"type":25,"tag":930,"props":3714,"children":3715},{},[3716],{"type":30,"value":3717},"# COPY frontend /app/\n",{"type":25,"tag":930,"props":3719,"children":3720},{"class":932,"line":1038},[3721],{"type":25,"tag":930,"props":3722,"children":3723},{},[3724],{"type":30,"value":3725},"# RUN npm run build\n",{"type":25,"tag":930,"props":3727,"children":3728},{"class":932,"line":1051},[3729],{"type":25,"tag":930,"props":3730,"children":3731},{"emptyLinePlaceholder":265},[3732],{"type":30,"value":3733},"\n",{"type":25,"tag":930,"props":3735,"children":3736},{"class":932,"line":1065},[3737],{"type":25,"tag":930,"props":3738,"children":3739},{},[3740],{"type":30,"value":3741},"# production stage\n",{"type":25,"tag":930,"props":3743,"children":3744},{"class":932,"line":1074},[3745],{"type":25,"tag":930,"props":3746,"children":3747},{},[3748],{"type":30,"value":3749},"# FROM nginx:1.19.1-alpine as production-stage\n",{"type":25,"tag":930,"props":3751,"children":3752},{"class":932,"line":1083},[3753],{"type":25,"tag":930,"props":3754,"children":3755},{},[3756],{"type":30,"value":3757},"FROM nginx:1.19.1-alpine\n",{"type":25,"tag":930,"props":3759,"children":3760},{"class":932,"line":1092},[3761],{"type":25,"tag":930,"props":3762,"children":3763},{},[3764],{"type":30,"value":3765},"COPY nginx/prod/prod.conf /etc/nginx/nginx.conf\n",{"type":25,"tag":930,"props":3767,"children":3768},{"class":932,"line":1101},[3769],{"type":25,"tag":930,"props":3770,"children":3771},{},[3772],{"type":30,"value":3773},"COPY nginx/prod/index.html /dist/\n",{"type":25,"tag":930,"props":3775,"children":3776},{"class":932,"line":2017},[3777],{"type":25,"tag":930,"props":3778,"children":3779},{},[3780],{"type":30,"value":3781},"# COPY --from=build-stage /app/dist /dist/\n",{"type":25,"tag":930,"props":3783,"children":3784},{"class":932,"line":2030},[3785],{"type":25,"tag":930,"props":3786,"children":3787},{},[3788],{"type":30,"value":3789},"EXPOSE 80\n",{"type":25,"tag":930,"props":3791,"children":3792},{"class":932,"line":2042},[3793],{"type":25,"tag":930,"props":3794,"children":3795},{},[3796],{"type":30,"value":3797},"CMD [\"nginx\", \"-g\", \"daemon off;\"]\n",{"type":25,"tag":26,"props":3799,"children":3800},{},[3801],{"type":30,"value":3802},"Currently I don't have a SPA setup, but this is how we could setup one using Vue.js. The important part is this line:",{"type":25,"tag":693,"props":3804,"children":3806},{"code":3805,"language":1278,"meta":8,"className":3657,"style":8},"COPY --from=build-stage /app/dist /dist/\n",[3807],{"type":25,"tag":130,"props":3808,"children":3809},{"__ignoreMap":8},[3810],{"type":25,"tag":930,"props":3811,"children":3812},{"class":932,"line":933},[3813],{"type":25,"tag":930,"props":3814,"children":3815},{},[3816],{"type":30,"value":3805},{"type":25,"tag":26,"props":3818,"children":3819},{},[3820,3822,3828,3830,3835],{"type":30,"value":3821},"This would copy the build files for our Javascript application into the ",{"type":25,"tag":130,"props":3823,"children":3825},{"className":3824},[],[3826],{"type":30,"value":3827},"/dist/",{"type":30,"value":3829}," folder of our NGINX container. Another few declarations and blocks in ",{"type":25,"tag":130,"props":3831,"children":3833},{"className":3832},[],[3834],{"type":30,"value":3416},{"type":30,"value":3836}," allow all other requests to be served by the contents of this folder:",{"type":25,"tag":693,"props":3838,"children":3840},{"code":3839},"    root /dist/;\n    index index.html;\n",[3841],{"type":25,"tag":130,"props":3842,"children":3843},{"__ignoreMap":8},[3844],{"type":30,"value":3839},{"type":25,"tag":26,"props":3846,"children":3847},{},[3848],{"type":30,"value":3849},"This sets the root and the index document for our NGINX webserver.",{"type":25,"tag":693,"props":3851,"children":3853},{"code":3852},"    # frontend\n    location / {\n      try_files $uri $uri/ @rewrites;\n    }\n\n    location @rewrites {\n      rewrite ^(.+)$ /index.html last;\n    }\n",[3854],{"type":25,"tag":130,"props":3855,"children":3856},{"__ignoreMap":8},[3857],{"type":30,"value":3852},{"type":25,"tag":26,"props":3859,"children":3860},{},[3861,3863,3869,3871,3876,3878,3883,3884,3889,3890,3895],{"type":30,"value":3862},"These two blocks route all other requests to the frontend Javascript app's ",{"type":25,"tag":130,"props":3864,"children":3866},{"className":3865},[],[3867],{"type":30,"value":3868},"index.html",{"type":30,"value":3870}," file location in ",{"type":25,"tag":130,"props":3872,"children":3874},{"className":3873},[],[3875],{"type":30,"value":3827},{"type":30,"value":3877}," (any request that doesn't start with ",{"type":25,"tag":130,"props":3879,"children":3881},{"className":3880},[],[3882],{"type":30,"value":3588},{"type":30,"value":860},{"type":25,"tag":130,"props":3885,"children":3887},{"className":3886},[],[3888],{"type":30,"value":3394},{"type":30,"value":2126},{"type":25,"tag":130,"props":3891,"children":3893},{"className":3892},[],[3894],{"type":30,"value":3401},{"type":30,"value":3896},"). We may wish to change this behavior if you want Django to serve most of your requests and possibly serve a single page application on another path.",{"type":25,"tag":26,"props":3898,"children":3899},{},[3900,3902,3907,3909,3915,3917,3923,3925,3930],{"type":30,"value":3901},"Lastly, the ",{"type":25,"tag":130,"props":3903,"children":3905},{"className":3904},[],[3906],{"type":30,"value":3141},{"type":30,"value":3908}," service's ",{"type":25,"tag":130,"props":3910,"children":3912},{"className":3911},[],[3913],{"type":30,"value":3914},"deployment",{"type":30,"value":3916}," key has some ",{"type":25,"tag":130,"props":3918,"children":3920},{"className":3919},[],[3921],{"type":30,"value":3922},"labels",{"type":30,"value":3924}," defined for Traefik. Let's come back to these after having a look at the ",{"type":25,"tag":130,"props":3926,"children":3928},{"className":3927},[],[3929],{"type":30,"value":270},{"type":30,"value":3383},{"type":25,"tag":2370,"props":3932,"children":3933},{"id":270},[3934],{"type":30,"value":3935},"Traefik",{"type":25,"tag":26,"props":3937,"children":3938},{},[3939],{"type":25,"tag":3940,"props":3941,"children":3944},"img",{"alt":3942,"src":3943},"png","https://docs.traefik.io/assets/img/traefik-architecture.png",[],{"type":25,"tag":313,"props":3946,"children":3947},{},[3948],{"type":25,"tag":26,"props":3949,"children":3950},{},[3951,3953],{"type":30,"value":3952},"Traefik is an open-source Edge Router that makes publishing your services a fun and easy experience. It receives requests on behalf of your system and finds out which components are responsible for handling them. -- ",{"type":25,"tag":41,"props":3954,"children":3957},{"href":3955,"rel":3956},"https://docs.traefik.io/",[45],[3958],{"type":30,"value":3955},{"type":25,"tag":26,"props":3960,"children":3961},{},[3962],{"type":30,"value":3963},"Traefik has three main functions in my application:",{"type":25,"tag":1139,"props":3965,"children":3966},{},[3967,3972,3977],{"type":25,"tag":37,"props":3968,"children":3969},{},[3970],{"type":30,"value":3971},"Request TLS certificates from Let's Encrypt that allow us to encrypt our web traffic with HTTPS",{"type":25,"tag":37,"props":3973,"children":3974},{},[3975],{"type":30,"value":3976},"Do TLS termination",{"type":25,"tag":37,"props":3978,"children":3979},{},[3980],{"type":30,"value":3981},"Route all requests to NGINX",{"type":25,"tag":26,"props":3983,"children":3984},{},[3985],{"type":30,"value":3986},"The one thing that Traefik cannot do is serve static files; it is not a webserver, unlike NGINX which is a webserver. NGINX is also capable of requesting TLS certs from Let's Encrypt, so we don't technically need Traefik, but it is indeed \"fun and easy\", especially when it comes to requesting certificates.",{"type":25,"tag":313,"props":3988,"children":3989},{},[3990],{"type":25,"tag":26,"props":3991,"children":3992},{},[3993],{"type":30,"value":3994},"I have tried setting up Certbot with NGINX a long time ago but I never go it to work, and I didn't like the idea about how to run a chron job to refresh old certs.",{"type":25,"tag":26,"props":3996,"children":3997},{},[3998],{"type":30,"value":3999},"There are two main ways to set up Traefik:",{"type":25,"tag":1139,"props":4001,"children":4002},{},[4003,4023],{"type":25,"tag":37,"props":4004,"children":4005},{},[4006,4008,4014,4016,4021],{"type":30,"value":4007},"write a ",{"type":25,"tag":130,"props":4009,"children":4011},{"className":4010},[],[4012],{"type":30,"value":4013},"traefik.toml",{"type":30,"value":4015}," file and build this into your own custom image (similar to what we do with NGINX and ",{"type":25,"tag":130,"props":4017,"children":4019},{"className":4018},[],[4020],{"type":30,"value":3416},{"type":30,"value":4022},")",{"type":25,"tag":37,"props":4024,"children":4025},{},[4026],{"type":30,"value":4027},"use a base image and specify all configure options through command line arguments.",{"type":25,"tag":26,"props":4029,"children":4030},{},[4031,4033,4038,4040,4045],{"type":30,"value":4032},"I started out with the first approach, and I did get it to work, but I have decided that the second way is better. It requires one less image to build in our deployment process and it is easy to parametrize the command line arguments in ",{"type":25,"tag":130,"props":4034,"children":4036},{"className":4035},[],[4037],{"type":30,"value":2335},{"type":30,"value":4039}," (for now all the values I'm using in the ",{"type":25,"tag":130,"props":4041,"children":4043},{"className":4042},[],[4044],{"type":30,"value":270},{"type":30,"value":4046}," service are hard-coded, this is one more item for my ToDo list on this project).",{"type":25,"tag":26,"props":4048,"children":4049},{},[4050,4052,4057,4059,4066,4068,4075],{"type":30,"value":4051},"I had a hard time finding good examples of how to use Traefik version 2 with Docker Swarm in the Traefik docs. Their official example for using docker uses ",{"type":25,"tag":130,"props":4053,"children":4055},{"className":4054},[],[4056],{"type":30,"value":1600},{"type":30,"value":4058},". There is a Swarm example, but it is for an older version of Traefik (1.7). This article titled ",{"type":25,"tag":41,"props":4060,"children":4063},{"href":4061,"rel":4062},"https://blog.creekorful.com/2019/10/how-to-install-traefik-2-docker-swarm/",[45],[4064],{"type":30,"value":4065},"How to install Traefik 2.x on a Docker Swarm",{"type":30,"value":4067}," helped me a lot in figuring out how to get everything working. Thank you for the great article, ",{"type":25,"tag":41,"props":4069,"children":4072},{"href":4070,"rel":4071},"https://github.com/creekorful",[45],[4073],{"type":30,"value":4074},"Alos",{"type":30,"value":4076},"!",{"type":25,"tag":26,"props":4078,"children":4079},{},[4080],{"type":30,"value":4081},"Here's the code that sets up the traefik service:",{"type":25,"tag":693,"props":4083,"children":4085},{"code":4084,"language":923,"meta":8,"className":924,"style":8},"services:\n  traefik:\n    image: traefik:v2.0.2\n    ports:\n      - '80:80'\n      - '443:443'\n    command:\n      - '--providers.docker.endpoint=unix:///var/run/docker.sock'\n      - '--providers.docker.swarmMode=true'\n      - '--providers.docker.exposedbydefault=false'\n      - '--providers.docker.network=traefik-public'\n      - '--entrypoints.web.address=:80'\n      - '--entrypoints.websecure.address=:443'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n      - '--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n      - '--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n      - '--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n    volumes:\n      - letsencrypt:/letsencrypt\n      - /var/run/docker.sock:/var/run/docker.sock\n    networks:\n      - traefik-public\n    deploy:\n      placement:\n        constraints:\n          - node.role == manager\n",[4086],{"type":25,"tag":130,"props":4087,"children":4088},{"__ignoreMap":8},[4089,4100,4112,4128,4140,4152,4164,4176,4188,4200,4212,4224,4236,4248,4260,4272,4284,4296,4307,4320,4333,4345,4357,4369,4382,4395],{"type":25,"tag":930,"props":4090,"children":4091},{"class":932,"line":933},[4092,4096],{"type":25,"tag":930,"props":4093,"children":4094},{"style":937},[4095],{"type":30,"value":1469},{"type":25,"tag":930,"props":4097,"children":4098},{"style":942},[4099],{"type":30,"value":945},{"type":25,"tag":930,"props":4101,"children":4102},{"class":932,"line":250},[4103,4108],{"type":25,"tag":930,"props":4104,"children":4105},{"style":937},[4106],{"type":30,"value":4107},"  traefik",{"type":25,"tag":930,"props":4109,"children":4110},{"style":942},[4111],{"type":30,"value":945},{"type":25,"tag":930,"props":4113,"children":4114},{"class":932,"line":967},[4115,4119,4123],{"type":25,"tag":930,"props":4116,"children":4117},{"style":937},[4118],{"type":30,"value":3210},{"type":25,"tag":930,"props":4120,"children":4121},{"style":942},[4122],{"type":30,"value":958},{"type":25,"tag":930,"props":4124,"children":4125},{"style":961},[4126],{"type":30,"value":4127},"traefik:v2.0.2\n",{"type":25,"tag":930,"props":4129,"children":4130},{"class":932,"line":985},[4131,4136],{"type":25,"tag":930,"props":4132,"children":4133},{"style":937},[4134],{"type":30,"value":4135},"    ports",{"type":25,"tag":930,"props":4137,"children":4138},{"style":942},[4139],{"type":30,"value":945},{"type":25,"tag":930,"props":4141,"children":4142},{"class":932,"line":998},[4143,4147],{"type":25,"tag":930,"props":4144,"children":4145},{"style":942},[4146],{"type":30,"value":3239},{"type":25,"tag":930,"props":4148,"children":4149},{"style":961},[4150],{"type":30,"value":4151},"'80:80'\n",{"type":25,"tag":930,"props":4153,"children":4154},{"class":932,"line":1012},[4155,4159],{"type":25,"tag":930,"props":4156,"children":4157},{"style":942},[4158],{"type":30,"value":3239},{"type":25,"tag":930,"props":4160,"children":4161},{"style":961},[4162],{"type":30,"value":4163},"'443:443'\n",{"type":25,"tag":930,"props":4165,"children":4166},{"class":932,"line":1025},[4167,4172],{"type":25,"tag":930,"props":4168,"children":4169},{"style":937},[4170],{"type":30,"value":4171},"    command",{"type":25,"tag":930,"props":4173,"children":4174},{"style":942},[4175],{"type":30,"value":945},{"type":25,"tag":930,"props":4177,"children":4178},{"class":932,"line":1038},[4179,4183],{"type":25,"tag":930,"props":4180,"children":4181},{"style":942},[4182],{"type":30,"value":3239},{"type":25,"tag":930,"props":4184,"children":4185},{"style":961},[4186],{"type":30,"value":4187},"'--providers.docker.endpoint=unix:///var/run/docker.sock'\n",{"type":25,"tag":930,"props":4189,"children":4190},{"class":932,"line":1051},[4191,4195],{"type":25,"tag":930,"props":4192,"children":4193},{"style":942},[4194],{"type":30,"value":3239},{"type":25,"tag":930,"props":4196,"children":4197},{"style":961},[4198],{"type":30,"value":4199},"'--providers.docker.swarmMode=true'\n",{"type":25,"tag":930,"props":4201,"children":4202},{"class":932,"line":1065},[4203,4207],{"type":25,"tag":930,"props":4204,"children":4205},{"style":942},[4206],{"type":30,"value":3239},{"type":25,"tag":930,"props":4208,"children":4209},{"style":961},[4210],{"type":30,"value":4211},"'--providers.docker.exposedbydefault=false'\n",{"type":25,"tag":930,"props":4213,"children":4214},{"class":932,"line":1074},[4215,4219],{"type":25,"tag":930,"props":4216,"children":4217},{"style":942},[4218],{"type":30,"value":3239},{"type":25,"tag":930,"props":4220,"children":4221},{"style":961},[4222],{"type":30,"value":4223},"'--providers.docker.network=traefik-public'\n",{"type":25,"tag":930,"props":4225,"children":4226},{"class":932,"line":1083},[4227,4231],{"type":25,"tag":930,"props":4228,"children":4229},{"style":942},[4230],{"type":30,"value":3239},{"type":25,"tag":930,"props":4232,"children":4233},{"style":961},[4234],{"type":30,"value":4235},"'--entrypoints.web.address=:80'\n",{"type":25,"tag":930,"props":4237,"children":4238},{"class":932,"line":1092},[4239,4243],{"type":25,"tag":930,"props":4240,"children":4241},{"style":942},[4242],{"type":30,"value":3239},{"type":25,"tag":930,"props":4244,"children":4245},{"style":961},[4246],{"type":30,"value":4247},"'--entrypoints.websecure.address=:443'\n",{"type":25,"tag":930,"props":4249,"children":4250},{"class":932,"line":1101},[4251,4255],{"type":25,"tag":930,"props":4252,"children":4253},{"style":942},[4254],{"type":30,"value":3239},{"type":25,"tag":930,"props":4256,"children":4257},{"style":961},[4258],{"type":30,"value":4259},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true'\n",{"type":25,"tag":930,"props":4261,"children":4262},{"class":932,"line":2017},[4263,4267],{"type":25,"tag":930,"props":4264,"children":4265},{"style":942},[4266],{"type":30,"value":3239},{"type":25,"tag":930,"props":4268,"children":4269},{"style":961},[4270],{"type":30,"value":4271},"'--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web'\n",{"type":25,"tag":930,"props":4273,"children":4274},{"class":932,"line":2030},[4275,4279],{"type":25,"tag":930,"props":4276,"children":4277},{"style":942},[4278],{"type":30,"value":3239},{"type":25,"tag":930,"props":4280,"children":4281},{"style":961},[4282],{"type":30,"value":4283},"'--certificatesresolvers.letsencryptresolver.acme.email=brian@email.com'\n",{"type":25,"tag":930,"props":4285,"children":4286},{"class":932,"line":2042},[4287,4291],{"type":25,"tag":930,"props":4288,"children":4289},{"style":942},[4290],{"type":30,"value":3239},{"type":25,"tag":930,"props":4292,"children":4293},{"style":961},[4294],{"type":30,"value":4295},"'--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json'\n",{"type":25,"tag":930,"props":4297,"children":4298},{"class":932,"line":2054},[4299,4303],{"type":25,"tag":930,"props":4300,"children":4301},{"style":937},[4302],{"type":30,"value":3263},{"type":25,"tag":930,"props":4304,"children":4305},{"style":942},[4306],{"type":30,"value":945},{"type":25,"tag":930,"props":4308,"children":4310},{"class":932,"line":4309},19,[4311,4315],{"type":25,"tag":930,"props":4312,"children":4313},{"style":942},[4314],{"type":30,"value":3239},{"type":25,"tag":930,"props":4316,"children":4317},{"style":961},[4318],{"type":30,"value":4319},"letsencrypt:/letsencrypt\n",{"type":25,"tag":930,"props":4321,"children":4323},{"class":932,"line":4322},20,[4324,4328],{"type":25,"tag":930,"props":4325,"children":4326},{"style":942},[4327],{"type":30,"value":3239},{"type":25,"tag":930,"props":4329,"children":4330},{"style":961},[4331],{"type":30,"value":4332},"/var/run/docker.sock:/var/run/docker.sock\n",{"type":25,"tag":930,"props":4334,"children":4336},{"class":932,"line":4335},21,[4337,4341],{"type":25,"tag":930,"props":4338,"children":4339},{"style":937},[4340],{"type":30,"value":3227},{"type":25,"tag":930,"props":4342,"children":4343},{"style":942},[4344],{"type":30,"value":945},{"type":25,"tag":930,"props":4346,"children":4348},{"class":932,"line":4347},22,[4349,4353],{"type":25,"tag":930,"props":4350,"children":4351},{"style":942},[4352],{"type":30,"value":3239},{"type":25,"tag":930,"props":4354,"children":4355},{"style":961},[4356],{"type":30,"value":3244},{"type":25,"tag":930,"props":4358,"children":4360},{"class":932,"line":4359},23,[4361,4365],{"type":25,"tag":930,"props":4362,"children":4363},{"style":937},[4364],{"type":30,"value":3287},{"type":25,"tag":930,"props":4366,"children":4367},{"style":942},[4368],{"type":30,"value":945},{"type":25,"tag":930,"props":4370,"children":4372},{"class":932,"line":4371},24,[4373,4378],{"type":25,"tag":930,"props":4374,"children":4375},{"style":937},[4376],{"type":30,"value":4377},"      placement",{"type":25,"tag":930,"props":4379,"children":4380},{"style":942},[4381],{"type":30,"value":945},{"type":25,"tag":930,"props":4383,"children":4385},{"class":932,"line":4384},25,[4386,4391],{"type":25,"tag":930,"props":4387,"children":4388},{"style":937},[4389],{"type":30,"value":4390},"        constraints",{"type":25,"tag":930,"props":4392,"children":4393},{"style":942},[4394],{"type":30,"value":945},{"type":25,"tag":930,"props":4396,"children":4398},{"class":932,"line":4397},26,[4399,4404],{"type":25,"tag":930,"props":4400,"children":4401},{"style":942},[4402],{"type":30,"value":4403},"          - ",{"type":25,"tag":930,"props":4405,"children":4406},{"style":961},[4407],{"type":30,"value":4408},"node.role == manager\n",{"type":25,"tag":313,"props":4410,"children":4411},{},[4412],{"type":25,"tag":26,"props":4413,"children":4414},{},[4415],{"type":30,"value":4416},"The one thing I don't like about this setup is that it uses a 1GB volume to store one small JSON file. I think that 1GB is the smallest block storage volume I can request using REX-Ray. This only adds $0.10/month to our project costs which is not that bad.",{"type":25,"tag":26,"props":4418,"children":4419},{},[4420,4425,4426,4432,4434,4439],{"type":25,"tag":130,"props":4421,"children":4423},{"className":4422},[],[4424],{"type":30,"value":3141},{"type":30,"value":868},{"type":25,"tag":130,"props":4427,"children":4429},{"className":4428},[],[4430],{"type":30,"value":4431},"websecure",{"type":30,"value":4433}," refer to values declared on the ",{"type":25,"tag":130,"props":4435,"children":4437},{"className":4436},[],[4438],{"type":30,"value":3141},{"type":30,"value":4440}," service. Let's take a look at those values:",{"type":25,"tag":693,"props":4442,"children":4446},{"code":4443,"language":4444,"meta":8,"className":4445,"style":8},"deploy:\n  labels:\n    - 'traefik.enable=true'\n    - 'traefik.http.routers.nginx-web.rule=Host(`mysite.com`)'\n    - 'traefik.http.routers.nginx-web.entrypoints=websecure'\n    - 'traefik.http.routers.nginx-web.tls.certresolver=letsencryptresolver'\n    - 'traefik.http.services.nginx-web.loadbalancer.server.port=80'\n","yaml","language-yaml shiki shiki-themes github-light github-dark monokai",[4447],{"type":25,"tag":130,"props":4448,"children":4449},{"__ignoreMap":8},[4450,4461,4473,4484,4495,4506,4517],{"type":25,"tag":930,"props":4451,"children":4452},{"class":932,"line":933},[4453,4457],{"type":25,"tag":930,"props":4454,"children":4455},{"style":937},[4456],{"type":30,"value":874},{"type":25,"tag":930,"props":4458,"children":4459},{"style":942},[4460],{"type":30,"value":945},{"type":25,"tag":930,"props":4462,"children":4463},{"class":932,"line":250},[4464,4469],{"type":25,"tag":930,"props":4465,"children":4466},{"style":937},[4467],{"type":30,"value":4468},"  labels",{"type":25,"tag":930,"props":4470,"children":4471},{"style":942},[4472],{"type":30,"value":945},{"type":25,"tag":930,"props":4474,"children":4475},{"class":932,"line":967},[4476,4480],{"type":25,"tag":930,"props":4477,"children":4478},{"style":942},[4479],{"type":30,"value":1004},{"type":25,"tag":930,"props":4481,"children":4482},{"style":961},[4483],{"type":30,"value":3316},{"type":25,"tag":930,"props":4485,"children":4486},{"class":932,"line":985},[4487,4491],{"type":25,"tag":930,"props":4488,"children":4489},{"style":942},[4490],{"type":30,"value":1004},{"type":25,"tag":930,"props":4492,"children":4493},{"style":961},[4494],{"type":30,"value":3328},{"type":25,"tag":930,"props":4496,"children":4497},{"class":932,"line":998},[4498,4502],{"type":25,"tag":930,"props":4499,"children":4500},{"style":942},[4501],{"type":30,"value":1004},{"type":25,"tag":930,"props":4503,"children":4504},{"style":961},[4505],{"type":30,"value":3340},{"type":25,"tag":930,"props":4507,"children":4508},{"class":932,"line":1012},[4509,4513],{"type":25,"tag":930,"props":4510,"children":4511},{"style":942},[4512],{"type":30,"value":1004},{"type":25,"tag":930,"props":4514,"children":4515},{"style":961},[4516],{"type":30,"value":3352},{"type":25,"tag":930,"props":4518,"children":4519},{"class":932,"line":1025},[4520,4524],{"type":25,"tag":930,"props":4521,"children":4522},{"style":942},[4523],{"type":30,"value":1004},{"type":25,"tag":930,"props":4525,"children":4526},{"style":961},[4527],{"type":30,"value":3364},{"type":25,"tag":26,"props":4529,"children":4530},{},[4531,4533,4538],{"type":30,"value":4532},"I still need to setup HTTP -> HTTPS redirecting, so for now only ",{"type":25,"tag":130,"props":4534,"children":4536},{"className":4535},[],[4537],{"type":30,"value":4431},{"type":30,"value":4539}," is defined, but Alos explains this clearly in his article.",{"type":25,"tag":313,"props":4541,"children":4542},{},[4543],{"type":25,"tag":26,"props":4544,"children":4545},{},[4546],{"type":30,"value":4547},"For me this is the most complicated part of the setup. I'm still not familiar with exactly how Traefik and Let's Encrypt work. Hopefully I can run through this process a few more times with some variations to better understand the rough edges. Otherwise for this simple way to get TLS certificates. AWS makes this very easy with Amazon Certificate Manager (ACM) which makes the requesting of certificates very simple, especially within CDK.",{"type":25,"tag":26,"props":4549,"children":4550},{},[4551,4553,4558],{"type":30,"value":4552},"That wraps up our overview of ",{"type":25,"tag":130,"props":4554,"children":4556},{"className":4555},[],[4557],{"type":30,"value":2335},{"type":30,"value":4559},", we left off with the following command:",{"type":25,"tag":693,"props":4561,"children":4562},{"code":2064},[4563],{"type":25,"tag":130,"props":4564,"children":4565},{"__ignoreMap":8},[4566],{"type":30,"value":2064},{"type":25,"tag":26,"props":4568,"children":4569},{},[4570,4572,4577],{"type":30,"value":4571},"We can check out the status of our docker stack deployment by running a few different docker CLI commands. You can either SSH into your Droplet or configure the ",{"type":25,"tag":130,"props":4573,"children":4575},{"className":4574},[],[4576],{"type":30,"value":135},{"type":30,"value":4578}," environment variable that I showed you earlier and run these commands from your local terminal:",{"type":25,"tag":693,"props":4580,"children":4582},{"code":4581},"docker stack ps my-stack --no-trunc\n",[4583],{"type":25,"tag":130,"props":4584,"children":4585},{"__ignoreMap":8},[4586],{"type":30,"value":4581},{"type":25,"tag":26,"props":4588,"children":4589},{},[4590,4596,4598,4604],{"type":25,"tag":130,"props":4591,"children":4593},{"className":4592},[],[4594],{"type":30,"value":4595},"--no-trunc",{"type":30,"value":4597}," is important because important error messages tend to be cut off. This option will show the full version of each column returned by ",{"type":25,"tag":130,"props":4599,"children":4601},{"className":4600},[],[4602],{"type":30,"value":4603},"docker stack ps",{"type":30,"value":208},{"type":25,"tag":693,"props":4606,"children":4608},{"code":4607},"docker service ls\n",[4609],{"type":25,"tag":130,"props":4610,"children":4611},{"__ignoreMap":8},[4612],{"type":30,"value":4607},{"type":25,"tag":26,"props":4614,"children":4615},{},[4616],{"type":30,"value":4617},"This command shows some the active services on our Droplet.",{"type":25,"tag":693,"props":4619,"children":4621},{"code":4620},"docker ps\n",[4622],{"type":25,"tag":130,"props":4623,"children":4624},{"__ignoreMap":8},[4625],{"type":30,"value":4620},{"type":25,"tag":26,"props":4627,"children":4628},{},[4629],{"type":30,"value":4630},"This command is useful for shelling into a container to run commands and poke around for debugging.",{"type":25,"tag":26,"props":4632,"children":4633},{},[4634],{"type":30,"value":4635},"You can get the Container ID of a running container and access it with the following command:",{"type":25,"tag":693,"props":4637,"children":4639},{"code":4638},"docker exec -it 0da8370ab283 bash\n",[4640],{"type":25,"tag":130,"props":4641,"children":4642},{"__ignoreMap":8},[4643],{"type":30,"value":4638},{"type":25,"tag":26,"props":4645,"children":4646},{},[4647,4649,4654,4656,4662],{"type":30,"value":4648},"This assumes that ",{"type":25,"tag":130,"props":4650,"children":4652},{"className":4651},[],[4653],{"type":30,"value":2132},{"type":30,"value":4655}," is installed on the container with ID ",{"type":25,"tag":130,"props":4657,"children":4659},{"className":4658},[],[4660],{"type":30,"value":4661},"0da8370ab283",{"type":30,"value":208},{"type":25,"tag":339,"props":4664,"children":4666},{"id":4665},"management-commands",[4667],{"type":30,"value":4668},"Management commands",{"type":25,"tag":26,"props":4670,"children":4671},{},[4672],{"type":30,"value":4673},"Once the site is deployed we stil need to run a few commands to set up our Djnago application:",{"type":25,"tag":1139,"props":4675,"children":4676},{},[4677,4681,4686],{"type":25,"tag":37,"props":4678,"children":4679},{},[4680],{"type":30,"value":2713},{"type":25,"tag":37,"props":4682,"children":4683},{},[4684],{"type":30,"value":4685},"migrate",{"type":25,"tag":37,"props":4687,"children":4688},{},[4689],{"type":30,"value":4690},"createsuperuser",{"type":25,"tag":313,"props":4692,"children":4693},{},[4694],{"type":25,"tag":26,"props":4695,"children":4696},{},[4697],{"type":30,"value":4698},"One other ToDo is to figure out how to run these commands through manual GitLab CI jobs.",{"type":25,"tag":26,"props":4700,"children":4701},{},[4702],{"type":30,"value":4703},"That's most of what I wanted to cover on a first pass. This should be a good starting point for working with a Django application in Docker Swarm on DigitalOcean.",{"type":25,"tag":339,"props":4705,"children":4707},{"id":4706},"next-steps",[4708],{"type":30,"value":4709},"Next steps",{"type":25,"tag":26,"props":4711,"children":4712},{},[4713],{"type":30,"value":4714},"Here are some ideas about the next steps I could take on this project.",{"type":25,"tag":2370,"props":4716,"children":4718},{"id":4717},"local-environment",[4719],{"type":30,"value":4720},"Local environment",{"type":25,"tag":26,"props":4722,"children":4723},{},[4724],{"type":30,"value":4725},"I'll probably need to create another docker-compose file to bring up everything locally. It might be a good way to experiment with different Traefik settings.",{"type":25,"tag":2370,"props":4727,"children":4729},{"id":4728},"infrastructure-as-code-setup",[4730],{"type":30,"value":4731},"Infrastructure as Code setup",{"type":25,"tag":26,"props":4733,"children":4734},{},[4735],{"type":30,"value":4736},"There might be a good opportunity to learn more about Terreform or Ansible here. There are a number of manual, one time setup steps. Some of these can't be automated, but some of them would probably fit very neatly into one of these tools. Pulumi would also be a good option to explore as it is more analagous to CDK.",{"type":25,"tag":2370,"props":4738,"children":4740},{"id":4739},"scaling-out-docker-swarm-services-across-multiple-machines",[4741],{"type":30,"value":4742},"Scaling out docker swarm services across multiple machines",{"type":25,"tag":26,"props":4744,"children":4745},{},[4746],{"type":30,"value":4747},"I have only scratched the surface of what docker swarm can do. There are lots of other settings that would be helpful to setup for learning purposes, especially around resource limits for services. For simplicity I haven't touch on any of these options yet. I'm curious to know how many containers I can fit onto one small Droplet, and if resource limits could help with compute and memory-intensive workloads.",{"type":25,"tag":2370,"props":4749,"children":4751},{"id":4750},"kubernetes-on-digitalocean",[4752],{"type":30,"value":4753},"Kubernetes on DigitalOcean",{"type":25,"tag":26,"props":4755,"children":4756},{},[4757],{"type":30,"value":4758},"DigitalOcean now offers simplified Kubernetes solutions. It would be interesting to try this out once I get better with docker swarm. I have used Kubernetes a with minikube and to a limited extent with GCP.",{"type":25,"tag":2370,"props":4760,"children":4762},{"id":4761},"deploying-locally-without-using-gitlab-ci",[4763],{"type":30,"value":4764},"Deploying locally, without using GitLab CI",{"type":25,"tag":26,"props":4766,"children":4767},{},[4768],{"type":30,"value":4769},"CDK makes deploying locally very easy, especially with the Lambda project I put together. This project as it stands might be a little bit more difficult to deploy locally. It assumes that the images we want to deploy are private. It might be possible, but for now I am fine with deploying through GitLab CI since the pipeline only takes a few minutes to complete for the build and deploy stages.",{"type":25,"tag":4771,"props":4772,"children":4773},"style",{},[4774],{"type":30,"value":4775},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":8,"searchDepth":250,"depth":250,"links":4777},[4778,4779,4780,4781,4782,4783,4784,4785,4786,4787,4788,4789,4794,4795],{"id":341,"depth":250,"text":344},{"id":450,"depth":250,"text":453},{"id":500,"depth":250,"text":503},{"id":558,"depth":250,"text":561},{"id":655,"depth":250,"text":658},{"id":683,"depth":250,"text":686},{"id":714,"depth":250,"text":717},{"id":806,"depth":250,"text":388},{"id":1514,"depth":250,"text":1517},{"id":1634,"depth":250,"text":1637},{"id":1798,"depth":250,"text":1793},{"id":2328,"depth":250,"text":2335,"children":4790},[4791,4792,4793],{"id":906,"depth":967,"text":906},{"id":271,"depth":967,"text":3130},{"id":270,"depth":967,"text":3935},{"id":4665,"depth":250,"text":4668},{"id":4706,"depth":250,"text":4709,"children":4796},[4797,4798,4799,4800,4801],{"id":4717,"depth":967,"text":4720},{"id":4728,"depth":967,"text":4731},{"id":4739,"depth":967,"text":4742},{"id":4750,"depth":967,"text":4753},{"id":4761,"depth":967,"text":4764},"content:2020:08:09:digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx.md","2020/08/09/digital-ocean-docker-swarm-django-traefik-nginx",{"_path":4806,"_dir":4807,"_draft":7,"_partial":7,"_locale":8,"title":4808,"description":8,"layout":263,"date":4809,"comments":265,"image":4810,"tags":4811,"body":4814,"_type":252,"_id":10490,"_source":254,"_file":10491,"_stem":10492,"_extension":257},"/2020/06/02/django-postgres-vue-gitlab-ecs","02","Using AWS CDK, GitLab, Fargate and CloudFront for Django + Vue.js applications","2020-06-02T00:00:00.000Z","/static/architecture_verbose_equals_true.png",[4812,14,18,15,4813],"fargate","cdk",{"type":22,"children":4815,"toc":10451},[4816,4838,4845,4858,4901,4906,4912,4917,4990,4996,5002,5008,5022,5027,5032,5037,5042,5047,5052,5057,5062,5067,5072,5077,5082,5087,5092,5097,5102,5107,5112,5117,5122,5127,5132,5137,5142,5147,5152,5157,5162,5167,5172,5177,5183,5221,5227,5268,5273,5296,5303,5370,5376,5450,5456,5494,5500,5515,5520,5526,5601,5607,5676,5688,5694,5699,5705,5725,5731,5736,5759,5765,5784,5789,5836,5842,5855,5883,5915,5921,5926,5938,5943,5949,5967,5988,6139,6150,6896,6910,6982,6994,7079,7087,7113,7124,7158,7180,7199,7432,7460,7567,7575,7585,7595,7601,7612,7752,7788,7831,7851,7857,7877,7962,8002,8021,8032,8044,8053,8073,8082,8094,8103,8144,8153,8186,8195,8200,8209,8214,8223,8236,8249,8284,8304,8314,8326,8335,8340,8349,8391,8400,8405,8426,8436,8448,8457,8462,8471,8484,8551,8560,8571,8580,8585,8612,8621,8626,8635,8658,8680,8685,8691,8704,8737,8742,8748,8753,8759,8764,8784,8789,8808,8814,8819,8825,8830,8853,8887,8892,8904,8917,8922,8960,8965,8970,8982,8987,9008,9013,9098,9103,9435,9463,9468,9859,9864,10372,10378,10412,10417,10447],{"type":25,"tag":313,"props":4817,"children":4818},{},[4819],{"type":25,"tag":26,"props":4820,"children":4821},{},[4822,4824,4830,4832],{"type":30,"value":4823},"This article was originally posted on ",{"type":25,"tag":41,"props":4825,"children":4828},{"href":4826,"rel":4827},"https://dev.to/briancaffey/building-a-django-vue-js-application-with-aws-cdk-and-gitlab-ci-also-how-to-scale-celery-workers-to-zero-1o6i",[45],[4829],{"type":30,"value":4826},{"type":30,"value":4831},". It is also available on the documentation site for the project: ",{"type":25,"tag":41,"props":4833,"children":4836},{"href":4834,"rel":4835},"https://verbose-equals-true.gitlab.io/django-postgres-vue-gitlab-ecs/start/overview/",[45],[4837],{"type":30,"value":4834},{"type":25,"tag":4839,"props":4840,"children":4842},"h1",{"id":4841},"project-overview",[4843],{"type":30,"value":4844},"Project Overview",{"type":25,"tag":26,"props":4846,"children":4847},{},[4848,4850,4856],{"type":30,"value":4849},"This is an overview of a Proof-of-Concept web application I'm working on called ",{"type":25,"tag":130,"props":4851,"children":4853},{"className":4852},[],[4854],{"type":30,"value":4855},"django-postgres-vue-gitlab-ecs",{"type":30,"value":4857},". This project aims to demonstrate the development and deployment of a web application using some of my favorite tools, languages and frameworks including:",{"type":25,"tag":33,"props":4859,"children":4860},{},[4861,4866,4871,4876,4881,4886,4891],{"type":25,"tag":37,"props":4862,"children":4863},{},[4864],{"type":30,"value":4865},"Python",{"type":25,"tag":37,"props":4867,"children":4868},{},[4869],{"type":30,"value":4870},"Django",{"type":25,"tag":37,"props":4872,"children":4873},{},[4874],{"type":30,"value":4875},"JavaScript",{"type":25,"tag":37,"props":4877,"children":4878},{},[4879],{"type":30,"value":4880},"Vue.js/Quasar Framework",{"type":25,"tag":37,"props":4882,"children":4883},{},[4884],{"type":30,"value":4885},"GitLab",{"type":25,"tag":37,"props":4887,"children":4888},{},[4889],{"type":30,"value":4890},"AWS",{"type":25,"tag":37,"props":4892,"children":4893},{},[4894,4896],{"type":30,"value":4895},"and last but not least, ",{"type":25,"tag":4897,"props":4898,"children":4899},"strong",{},[4900],{"type":30,"value":304},{"type":25,"tag":26,"props":4902,"children":4903},{},[4904],{"type":30,"value":4905},"This README will start by describing some features of the application I'm building and how the different technologies are used together. I also share my experience in adopting CDK for managing cloud infrastructure on AWS. Finally, I discuss my solution to a specific question I have been trying to answer: what's the best way to scale Celery workers to zero to reduce Total Cost of Ownership?",{"type":25,"tag":339,"props":4907,"children":4909},{"id":4908},"development-philosophies-and-best-practices",[4910],{"type":30,"value":4911},"Development Philosophies and Best Practices",{"type":25,"tag":26,"props":4913,"children":4914},{},[4915],{"type":30,"value":4916},"Here are some of the best practices that this project aims to use:",{"type":25,"tag":33,"props":4918,"children":4919},{},[4920,4925,4930,4935,4940,4945,4950,4963,4968,4973,4978],{"type":25,"tag":37,"props":4921,"children":4922},{},[4923],{"type":30,"value":4924},"Open-source, MIT-Licensed",{"type":25,"tag":37,"props":4926,"children":4927},{},[4928],{"type":30,"value":4929},"12 Factor App",{"type":25,"tag":37,"props":4931,"children":4932},{},[4933],{"type":30,"value":4934},"Infrastructure as Code",{"type":25,"tag":37,"props":4936,"children":4937},{},[4938],{"type":30,"value":4939},"Containerization with Docker",{"type":25,"tag":37,"props":4941,"children":4942},{},[4943],{"type":30,"value":4944},"Testing",{"type":25,"tag":37,"props":4946,"children":4947},{},[4948],{"type":30,"value":4949},"GitOps",{"type":25,"tag":37,"props":4951,"children":4952},{},[4953,4955],{"type":30,"value":4954},"Serverless* ",{"type":25,"tag":4897,"props":4956,"children":4957},{},[4958],{"type":25,"tag":930,"props":4959,"children":4960},{},[4961],{"type":30,"value":4962},"1",{"type":25,"tag":37,"props":4964,"children":4965},{},[4966],{"type":30,"value":4967},"Project documentation",{"type":25,"tag":37,"props":4969,"children":4970},{},[4971],{"type":30,"value":4972},"Cost containment and tracking",{"type":25,"tag":37,"props":4974,"children":4975},{},[4976],{"type":30,"value":4977},"KISS & DRY",{"type":25,"tag":37,"props":4979,"children":4980},{},[4981,4983,4988],{"type":30,"value":4982},"Initial AWS console interaction is strictly limited to what can ",{"type":25,"tag":235,"props":4984,"children":4985},{},[4986],{"type":30,"value":4987},"only",{"type":30,"value":4989}," be done through the AWS console, otherwise AWS CDK and AWS CLI (preferably in CI/CD pipelines) are the primary means of interacting with AWS resources and the AWS Console is treated as a \"read-only\" convenience.",{"type":25,"tag":339,"props":4991,"children":4993},{"id":4992},"topics",[4994],{"type":30,"value":4995},"Topics",{"type":25,"tag":26,"props":4997,"children":4998},{},[4999],{"type":25,"tag":3940,"props":5000,"children":5001},{"alt":3942,"src":4810},[],{"type":25,"tag":2370,"props":5003,"children":5005},{"id":5004},"legend",[5006],{"type":30,"value":5007},"Legend",{"type":25,"tag":313,"props":5009,"children":5010},{},[5011],{"type":25,"tag":26,"props":5012,"children":5013},{},[5014,5016],{"type":30,"value":5015},"This diagram was created with draw.io. Here's the link to the a read-only version of the diagram on draw.io: ",{"type":25,"tag":41,"props":5017,"children":5020},{"href":5018,"rel":5019},"https://drive.google.com/file/d/1gU61zjoW80fCusUcswU1zhEE5VFB1Z5U/view?usp=sharing",[45],[5021],{"type":30,"value":5018},{"type":25,"tag":26,"props":5023,"children":5024},{},[5025],{"type":30,"value":5026},"1 - GitLab is used to host the source code, test the source code and deploy the application to AWS.",{"type":25,"tag":26,"props":5028,"children":5029},{},[5030],{"type":30,"value":5031},"2 - Unit testing (see .gitlab-ci.yml)",{"type":25,"tag":26,"props":5033,"children":5034},{},[5035],{"type":30,"value":5036},"2a - Pytest",{"type":25,"tag":26,"props":5038,"children":5039},{},[5040],{"type":30,"value":5041},"2b - Jest",{"type":25,"tag":26,"props":5043,"children":5044},{},[5045],{"type":30,"value":5046},"2c - Cypress",{"type":25,"tag":26,"props":5048,"children":5049},{},[5050],{"type":30,"value":5051},"3 - Deployment phase (see /gitlab-ci/aws/cdk.yml)",{"type":25,"tag":26,"props":5053,"children":5054},{},[5055],{"type":30,"value":5056},"3a - Quasar PWA assets are built if there are changes in the quasar directory",{"type":25,"tag":26,"props":5058,"children":5059},{},[5060],{"type":30,"value":5061},"3b - AWS Cloud Development Kit (CDK) defines all infrastructure in AWS (4a - 12)",{"type":25,"tag":26,"props":5063,"children":5064},{},[5065],{"type":30,"value":5066},"3c - AWS CLI is used to run Fargate tasks through manual GitLab CI jobs",{"type":25,"tag":26,"props":5068,"children":5069},{},[5070],{"type":30,"value":5071},"4 - CDK Assets (ECR and S3 buckets that CDK uses internally to manage build assets and artifacts)",{"type":25,"tag":26,"props":5073,"children":5074},{},[5075],{"type":30,"value":5076},"4a - Elastic Container Repository is used to manage the Django docker image used in various parts of the application",{"type":25,"tag":26,"props":5078,"children":5079},{},[5080],{"type":30,"value":5081},"4b - S3 bucket used to store files associated with CDK and CloudFormation",{"type":25,"tag":26,"props":5083,"children":5084},{},[5085],{"type":30,"value":5086},"5 - Route53 is used to route traffic to the CloudFront distribution",{"type":25,"tag":26,"props":5088,"children":5089},{},[5090],{"type":30,"value":5091},"6 - CloudFront distribution that serves as the \"front desk\" of the application. It routes requests to to the correct CloudFront Origin",{"type":25,"tag":26,"props":5093,"children":5094},{},[5095],{"type":30,"value":5096},"7 - CloudFront Origin Configurations",{"type":25,"tag":26,"props":5098,"children":5099},{},[5100],{"type":30,"value":5101},"7a - S3 bucket for Quasar PWA assets",{"type":25,"tag":26,"props":5103,"children":5104},{},[5105],{"type":30,"value":5106},"7b - Application Load Balancer for Django application (/api/, /admin/, /flower/, /ws/, /graphql/)",{"type":25,"tag":26,"props":5108,"children":5109},{},[5110],{"type":30,"value":5111},"7c - S3 bucket for Django assets (static files, public media and private media)",{"type":25,"tag":26,"props":5113,"children":5114},{},[5115],{"type":30,"value":5116},"8 - Web server and websocket servers",{"type":25,"tag":26,"props":5118,"children":5119},{},[5120],{"type":30,"value":5121},"8a - Fargate service running uvicorn process (REST, GraphQL, Django Channels)",{"type":25,"tag":26,"props":5123,"children":5124},{},[5125],{"type":30,"value":5126},"8b - Autoscaling Group for Fargate Service that serves Django API",{"type":25,"tag":26,"props":5128,"children":5129},{},[5130],{"type":30,"value":5131},"9 - Celery and celery worker autoscaling",{"type":25,"tag":26,"props":5133,"children":5134},{},[5135],{"type":30,"value":5136},"9a - Fargate service that is autoscaled between 0 and N Fargate tasks for a given celery queue",{"type":25,"tag":26,"props":5138,"children":5139},{},[5140],{"type":30,"value":5141},"9b - Scheduled Event that triggers a Lambda to make a request to Django backend which collects celery queue metrics and published\nmetrics to CloudWatch using boto3",{"type":25,"tag":26,"props":5143,"children":5144},{},[5145],{"type":30,"value":5146},"9c - Lambda event the makes a request to /api/celery-metrics/",{"type":25,"tag":26,"props":5148,"children":5149},{},[5150],{"type":30,"value":5151},"9d - CloudWatch alarm that is used to scale the Fargate service for a celery queue",{"type":25,"tag":26,"props":5153,"children":5154},{},[5155],{"type":30,"value":5156},"9e - Autoscaling group for celery Fargate service",{"type":25,"tag":26,"props":5158,"children":5159},{},[5160],{"type":30,"value":5161},"10 - Fargate tasks that run Django management commands such as migrate and collectstatic. These are triggered from manual GitLab CI\njobs using the AWS CLI (3c)",{"type":25,"tag":26,"props":5163,"children":5164},{},[5165],{"type":30,"value":5166},"11 - ElastiCache for Redis, used for Caching, Celery Broker, Channels Layer, etc.",{"type":25,"tag":26,"props":5168,"children":5169},{},[5170],{"type":30,"value":5171},"12 - Aurora Postgres Serverless",{"type":25,"tag":26,"props":5173,"children":5174},{},[5175],{"type":30,"value":5176},"Here's a list of some of the major topics covered:",{"type":25,"tag":2370,"props":5178,"children":5180},{"id":5179},"local-development",[5181],{"type":30,"value":5182},"Local development",{"type":25,"tag":33,"props":5184,"children":5185},{},[5186,5196,5201,5206,5211,5216],{"type":25,"tag":37,"props":5187,"children":5188},{},[5189,5191],{"type":30,"value":5190},"Setting up a local development environment using docker with one easy command: ",{"type":25,"tag":130,"props":5192,"children":5194},{"className":5193},[],[5195],{"type":30,"value":1600},{"type":25,"tag":37,"props":5197,"children":5198},{},[5199],{"type":30,"value":5200},"Hot-reloading for all parts of the application in local development",{"type":25,"tag":37,"props":5202,"children":5203},{},[5204],{"type":30,"value":5205},"Structuring a Django application (apps, settings modules, environment variables)",{"type":25,"tag":37,"props":5207,"children":5208},{},[5209],{"type":30,"value":5210},"Automatic code formatting with black and prettier",{"type":25,"tag":37,"props":5212,"children":5213},{},[5214],{"type":30,"value":5215},"Monitoring services (flower, pgadmin4, redis-commander)",{"type":25,"tag":37,"props":5217,"children":5218},{},[5219],{"type":30,"value":5220},"VSCode settings and extensions",{"type":25,"tag":2370,"props":5222,"children":5224},{"id":5223},"gitlab-ci",[5225],{"type":30,"value":5226},"GitLab CI",{"type":25,"tag":33,"props":5228,"children":5229},{},[5230,5235,5240,5245,5250,5263],{"type":25,"tag":37,"props":5231,"children":5232},{},[5233],{"type":30,"value":5234},"GitLab CI for running unit and integration tests",{"type":25,"tag":37,"props":5236,"children":5237},{},[5238],{"type":30,"value":5239},"GitLab CI configuration for deployment to multiple environments (dev, prod) using AWS CDK",{"type":25,"tag":37,"props":5241,"children":5242},{},[5243],{"type":30,"value":5244},"GitLab CI scheduled jobs for updating all project dependencies through automated merge requests with Renovate",{"type":25,"tag":37,"props":5246,"children":5247},{},[5248],{"type":30,"value":5249},"GitLab CI manual jobs for running admin and management commands (database migrations, collectstatic, etc.)",{"type":25,"tag":37,"props":5251,"children":5252},{},[5253,5255,5261],{"type":30,"value":5254},"How to deploy to multiple environments (master -> staging, tags -> prod pattern as well as optional ephemeral environments per commit) using the new GitLab CI ",{"type":25,"tag":130,"props":5256,"children":5258},{"className":5257},[],[5259],{"type":30,"value":5260},"rules",{"type":30,"value":5262}," syntax",{"type":25,"tag":37,"props":5264,"children":5265},{},[5266],{"type":30,"value":5267},"Recording Cypress test videos with GitLab CI artifacts for manual review",{"type":25,"tag":2370,"props":5269,"children":5271},{"id":5270},"aws",[5272],{"type":30,"value":4890},{"type":25,"tag":33,"props":5274,"children":5275},{},[5276,5281,5286,5291],{"type":25,"tag":37,"props":5277,"children":5278},{},[5279],{"type":30,"value":5280},"Initial account setup",{"type":25,"tag":37,"props":5282,"children":5283},{},[5284],{"type":30,"value":5285},"Generating keys used in GitLab CI for deployment",{"type":25,"tag":37,"props":5287,"children":5288},{},[5289],{"type":30,"value":5290},"Opting in to new ARN format for ECS services and tasks (used for resource tagging) and container insights",{"type":25,"tag":37,"props":5292,"children":5293},{},[5294],{"type":30,"value":5295},"AWS Cloud Development Kit (CDK) for Infrastructure as Code to manage all AWS resources with CloudFormation Stacks - Nested stacks for grouping related resources under parent tasks (one parent task represent on environment for the application, such as production)",{"type":25,"tag":5297,"props":5298,"children":5300},"h4",{"id":5299},"aws-resources",[5301],{"type":30,"value":5302},"AWS Resources",{"type":25,"tag":33,"props":5304,"children":5305},{},[5306,5311,5325,5330,5335,5340,5345,5350,5355,5360,5365],{"type":25,"tag":37,"props":5307,"children":5308},{},[5309],{"type":30,"value":5310},"Automated provisioning of Amazon Certificate Manager certificates for TLS (HTTPS)",{"type":25,"tag":37,"props":5312,"children":5313},{},[5314,5316,5324],{"type":30,"value":5315},"Multi-AZ VPC with security groups and NACLs (no NAT Gateways/NAT instances used* ",{"type":25,"tag":4897,"props":5317,"children":5318},{},[5319],{"type":25,"tag":930,"props":5320,"children":5321},{},[5322],{"type":30,"value":5323},"2",{"type":30,"value":4022},{"type":25,"tag":37,"props":5326,"children":5327},{},[5328],{"type":30,"value":5329},"S3 buckets for static site hosting and Django static and media assets",{"type":25,"tag":37,"props":5331,"children":5332},{},[5333],{"type":30,"value":5334},"CloudFront for serving Vue.js SPA (PWA) static assets, Django static/media files and proxy to Application Load Balancer which forwards to ECS",{"type":25,"tag":37,"props":5336,"children":5337},{},[5338],{"type":30,"value":5339},"Fargate for multiple Django processes: gunicorn for backend API, daphne for Django Channels, celery for asynchronous tasks and celery beat for scheduled tasks",{"type":25,"tag":37,"props":5341,"children":5342},{},[5343],{"type":30,"value":5344},"Autoscaling (between 0 and N Fargate tasks) for infrequent, compute/memory intensive and long-running celery tasks with custom CloudWatch metrics",{"type":25,"tag":37,"props":5346,"children":5347},{},[5348],{"type":30,"value":5349},"Hosted Redis with ElastiCache for celery broker, application caching, django-constance, etc.",{"type":25,"tag":37,"props":5351,"children":5352},{},[5353],{"type":30,"value":5354},"Aurora Postgres and Aurora Postgres Serverless for cost savings in staging environments",{"type":25,"tag":37,"props":5356,"children":5357},{},[5358],{"type":30,"value":5359},"CDK Assets for automating S3 asset deployment and automated container building during deployment with AWS CDK",{"type":25,"tag":37,"props":5361,"children":5362},{},[5363],{"type":30,"value":5364},"Thorough resource tagging by both application and environment (dev, prod, etc.) for comprehensive cost tracking",{"type":25,"tag":37,"props":5366,"children":5367},{},[5368],{"type":30,"value":5369},"Optional bastion host for SSH access to bring up a Django shell in a container running on a container instance (this requires an EC2 instance)",{"type":25,"tag":2370,"props":5371,"children":5373},{"id":5372},"django-application",[5374],{"type":30,"value":5375},"Django Application",{"type":25,"tag":33,"props":5377,"children":5378},{},[5379,5384,5389,5394,5407,5412,5417,5430,5435,5440,5445],{"type":25,"tag":37,"props":5380,"children":5381},{},[5382],{"type":30,"value":5383},"Django REST Framework",{"type":25,"tag":37,"props":5385,"children":5386},{},[5387],{"type":30,"value":5388},"JWT-based authentication with django-rest-framework-simplejwt",{"type":25,"tag":37,"props":5390,"children":5391},{},[5392],{"type":30,"value":5393},"Custom user model with email as username",{"type":25,"tag":37,"props":5395,"children":5396},{},[5397,5399,5405],{"type":30,"value":5398},"Social authentication with ",{"type":25,"tag":130,"props":5400,"children":5402},{"className":5401},[],[5403],{"type":30,"value":5404},"python-social-auth",{"type":30,"value":5406}," (Google, Facebook, GitHub)",{"type":25,"tag":37,"props":5408,"children":5409},{},[5410],{"type":30,"value":5411},"Pytest for unit testing",{"type":25,"tag":37,"props":5413,"children":5414},{},[5415],{"type":30,"value":5416},"Settings broken into separate modules (development, ci, production)",{"type":25,"tag":37,"props":5418,"children":5419},{},[5420,5422,5428],{"type":30,"value":5421},"Django apps organized in ",{"type":25,"tag":130,"props":5423,"children":5425},{"className":5424},[],[5426],{"type":30,"value":5427},"apps",{"type":30,"value":5429}," directory",{"type":25,"tag":37,"props":5431,"children":5432},{},[5433],{"type":30,"value":5434},"S3 for static assets, public media and private media files in production, local file system for assets in local development",{"type":25,"tag":37,"props":5436,"children":5437},{},[5438],{"type":30,"value":5439},"Multiple Celery queues for asynchronous tasks",{"type":25,"tag":37,"props":5441,"children":5442},{},[5443],{"type":30,"value":5444},"Django Channels for websocket support with daphne",{"type":25,"tag":37,"props":5446,"children":5447},{},[5448],{"type":30,"value":5449},"Graphene for GraphQL",{"type":25,"tag":2370,"props":5451,"children":5453},{"id":5452},"vuejs-application",[5454],{"type":30,"value":5455},"Vue.js application",{"type":25,"tag":33,"props":5457,"children":5458},{},[5459,5464,5469,5474,5479,5484,5489],{"type":25,"tag":37,"props":5460,"children":5461},{},[5462],{"type":30,"value":5463},"Quasar Framework for creating a Vue.js app with multiple build targets (SPA, PWA, Electron, SSR and Cordova)",{"type":25,"tag":37,"props":5465,"children":5466},{},[5467],{"type":30,"value":5468},"Internationalization",{"type":25,"tag":37,"props":5470,"children":5471},{},[5472],{"type":30,"value":5473},"Dark/Light mode",{"type":25,"tag":37,"props":5475,"children":5476},{},[5477],{"type":30,"value":5478},"Vuex for state management",{"type":25,"tag":37,"props":5480,"children":5481},{},[5482],{"type":30,"value":5483},"vue-router",{"type":25,"tag":37,"props":5485,"children":5486},{},[5487],{"type":30,"value":5488},"axios",{"type":25,"tag":37,"props":5490,"children":5491},{},[5492],{"type":30,"value":5493},"Vue Apollo",{"type":25,"tag":2370,"props":5495,"children":5497},{"id":5496},"aws-django-vuejs",[5498],{"type":30,"value":5499},"AWS  Django  Vue.js",{"type":25,"tag":26,"props":5501,"children":5502},{},[5503,5505,5513],{"type":30,"value":5504},"CloudFront is used as a CDN and proxy in order to serve the frontend Vue.js PWA* ",{"type":25,"tag":4897,"props":5506,"children":5507},{},[5508],{"type":25,"tag":930,"props":5509,"children":5510},{},[5511],{"type":30,"value":5512},"3",{"type":30,"value":5514},", static and media assets, Django API and other monitoring services all on the same URL with environments namespaced by subdomain (or a combination of domain and subdomains by production and non-production environments, respectively). The PWA uses Workbox to route certain URL paths to network only (not served by the local cache).",{"type":25,"tag":26,"props":5516,"children":5517},{},[5518],{"type":30,"value":5519},"Here are some examples:",{"type":25,"tag":5297,"props":5521,"children":5523},{"id":5522},"staging-environment-urls",[5524],{"type":30,"value":5525},"Staging environment URLs",{"type":25,"tag":33,"props":5527,"children":5528},{},[5529,5540,5551,5562,5573,5584],{"type":25,"tag":37,"props":5530,"children":5531},{},[5532,5538],{"type":25,"tag":130,"props":5533,"children":5535},{"className":5534},[],[5536],{"type":30,"value":5537},"https://dev.mysite.com/api/*",{"type":30,"value":5539}," - Django REST Framework",{"type":25,"tag":37,"props":5541,"children":5542},{},[5543,5549],{"type":25,"tag":130,"props":5544,"children":5546},{"className":5545},[],[5547],{"type":30,"value":5548},"https://dev.mysite.com/admin/*",{"type":30,"value":5550}," - Django Admin",{"type":25,"tag":37,"props":5552,"children":5553},{},[5554,5560],{"type":25,"tag":130,"props":5555,"children":5557},{"className":5556},[],[5558],{"type":30,"value":5559},"https://dev.mysite.com/graphql/",{"type":30,"value":5561}," - Graphene/GraphQL",{"type":25,"tag":37,"props":5563,"children":5564},{},[5565,5571],{"type":25,"tag":130,"props":5566,"children":5568},{"className":5567},[],[5569],{"type":30,"value":5570},"https://dev.mysite.com/flower/*",{"type":30,"value":5572}," - Flower (Celery monitoring utility)",{"type":25,"tag":37,"props":5574,"children":5575},{},[5576,5582],{"type":25,"tag":130,"props":5577,"children":5579},{"className":5578},[],[5580],{"type":30,"value":5581},"https://dev.mysite.com/media/private/private-file.csv",{"type":30,"value":5583}," - private media files",{"type":25,"tag":37,"props":5585,"children":5586},{},[5587,5593,5595,5600],{"type":25,"tag":130,"props":5588,"children":5590},{"className":5589},[],[5591],{"type":30,"value":5592},"https://dev.mysite.com/*",{"type":30,"value":5594}," - Vue.js PWA (all other routes load ",{"type":25,"tag":130,"props":5596,"children":5598},{"className":5597},[],[5599],{"type":30,"value":3868},{"type":30,"value":4022},{"type":25,"tag":5297,"props":5602,"children":5604},{"id":5603},"production-environment-urls",[5605],{"type":30,"value":5606},"Production environment URLs",{"type":25,"tag":33,"props":5608,"children":5609},{},[5610,5620,5630,5640,5650,5660],{"type":25,"tag":37,"props":5611,"children":5612},{},[5613,5619],{"type":25,"tag":130,"props":5614,"children":5616},{"className":5615},[],[5617],{"type":30,"value":5618},"https://mysite.com/api/*",{"type":30,"value":5539},{"type":25,"tag":37,"props":5621,"children":5622},{},[5623,5629],{"type":25,"tag":130,"props":5624,"children":5626},{"className":5625},[],[5627],{"type":30,"value":5628},"https://mysite.com/admin/*",{"type":30,"value":5550},{"type":25,"tag":37,"props":5631,"children":5632},{},[5633,5639],{"type":25,"tag":130,"props":5634,"children":5636},{"className":5635},[],[5637],{"type":30,"value":5638},"https://mysite.com/graphql/",{"type":30,"value":5561},{"type":25,"tag":37,"props":5641,"children":5642},{},[5643,5649],{"type":25,"tag":130,"props":5644,"children":5646},{"className":5645},[],[5647],{"type":30,"value":5648},"https://mysite.com/flower/*",{"type":30,"value":5572},{"type":25,"tag":37,"props":5651,"children":5652},{},[5653,5659],{"type":25,"tag":130,"props":5654,"children":5656},{"className":5655},[],[5657],{"type":30,"value":5658},"https://mysite.com/media/private/private-file.csv",{"type":30,"value":5583},{"type":25,"tag":37,"props":5661,"children":5662},{},[5663,5669,5670,5675],{"type":25,"tag":130,"props":5664,"children":5666},{"className":5665},[],[5667],{"type":30,"value":5668},"https://mysite.com",{"type":30,"value":5594},{"type":25,"tag":130,"props":5671,"children":5673},{"className":5672},[],[5674],{"type":30,"value":3868},{"type":30,"value":4022},{"type":25,"tag":26,"props":5677,"children":5678},{},[5679,5681,5687],{"type":30,"value":5680},"Alternatively, the production domain name could be configured to use a dedicated subdomain such as ",{"type":25,"tag":130,"props":5682,"children":5684},{"className":5683},[],[5685],{"type":30,"value":5686},"https://app.mysite.com",{"type":30,"value":208},{"type":25,"tag":2370,"props":5689,"children":5691},{"id":5690},"sample-application-logic",[5692],{"type":30,"value":5693},"Sample application logic",{"type":25,"tag":26,"props":5695,"children":5696},{},[5697],{"type":30,"value":5698},"While this is mostly a Proof-of-Concept project that focuses on architecture, I have included some light-weight examples of what you can do with this application. These examples are all WIP.",{"type":25,"tag":5297,"props":5700,"children":5702},{"id":5701},"social-authentication",[5703],{"type":30,"value":5704},"Social Authentication",{"type":25,"tag":33,"props":5706,"children":5707},{},[5708,5720],{"type":25,"tag":37,"props":5709,"children":5710},{},[5711,5713,5718],{"type":30,"value":5712},"Uses ",{"type":25,"tag":130,"props":5714,"children":5716},{"className":5715},[],[5717],{"type":30,"value":5404},{"type":30,"value":5719}," to allow users to Sign Up/Login with Google, Facebook and GitHub accounts",{"type":25,"tag":37,"props":5721,"children":5722},{},[5723],{"type":30,"value":5724},"Makes use of the custom user model",{"type":25,"tag":5297,"props":5726,"children":5728},{"id":5727},"credit-card-statement-app",[5729],{"type":30,"value":5730},"Credit Card Statement App",{"type":25,"tag":26,"props":5732,"children":5733},{},[5734],{"type":30,"value":5735},"This is a simple application for users to upload credit card statements in CSV format.",{"type":25,"tag":33,"props":5737,"children":5738},{},[5739,5744,5749,5754],{"type":25,"tag":37,"props":5740,"children":5741},{},[5742],{"type":30,"value":5743},"Credit card transactions in CSV files are created using bulk inserts via the Django ORM in a celery task",{"type":25,"tag":37,"props":5745,"children":5746},{},[5747],{"type":30,"value":5748},"CSV files are saved in private S3 storage",{"type":25,"tag":37,"props":5750,"children":5751},{},[5752],{"type":30,"value":5753},"Basic visualization of spend over time",{"type":25,"tag":37,"props":5755,"children":5756},{},[5757],{"type":30,"value":5758},"Download consolidated CSV file",{"type":25,"tag":5297,"props":5760,"children":5762},{"id":5761},"hacker-news-clone",[5763],{"type":30,"value":5764},"Hacker News Clone",{"type":25,"tag":33,"props":5766,"children":5767},{},[5768,5779],{"type":25,"tag":37,"props":5769,"children":5770},{},[5771,5773],{"type":30,"value":5772},"An implementation of the application from this tutorial: ",{"type":25,"tag":41,"props":5774,"children":5777},{"href":5775,"rel":5776},"https://www.howtographql.com/graphql-python/0-introduction/",[45],[5778],{"type":30,"value":5775},{"type":25,"tag":37,"props":5780,"children":5781},{},[5782],{"type":30,"value":5783},"Uses Vue Apollo GraphQL client",{"type":25,"tag":2370,"props":5785,"children":5787},{"id":5786},"testing",[5788],{"type":30,"value":4944},{"type":25,"tag":33,"props":5790,"children":5791},{},[5792,5797,5802,5807,5812,5823],{"type":25,"tag":37,"props":5793,"children":5794},{},[5795],{"type":30,"value":5796},"Unit testing with pytest and Jest",{"type":25,"tag":37,"props":5798,"children":5799},{},[5800],{"type":30,"value":5801},"Test coverage reports",{"type":25,"tag":37,"props":5803,"children":5804},{},[5805],{"type":30,"value":5806},"Integration testing with Cypress",{"type":25,"tag":37,"props":5808,"children":5809},{},[5810],{"type":30,"value":5811},"Capture integration test run recordings as GitLab CI job artifacts",{"type":25,"tag":37,"props":5813,"children":5814},{},[5815,5817],{"type":30,"value":5816},"Testing GitLab CI jobs locally with ",{"type":25,"tag":130,"props":5818,"children":5820},{"className":5819},[],[5821],{"type":30,"value":5822},"gitlab-runner",{"type":25,"tag":37,"props":5824,"children":5825},{},[5826,5828],{"type":30,"value":5827},"Tests for CDK?* ",{"type":25,"tag":4897,"props":5829,"children":5830},{},[5831],{"type":25,"tag":930,"props":5832,"children":5833},{},[5834],{"type":30,"value":5835},"4",{"type":25,"tag":2370,"props":5837,"children":5839},{"id":5838},"caveats-questions-confusion-and-footnotes",[5840],{"type":30,"value":5841},"Caveats, Questions, Confusion and Footnotes",{"type":25,"tag":1139,"props":5843,"children":5844},{},[5845,5850],{"type":25,"tag":37,"props":5846,"children":5847},{},[5848],{"type":30,"value":5849},"In the context of this project, it is serverless in the sense that AWS Fargate is serverless: there are no EC2 instances to manage. It is not serverless in the way that Zappa can deploy a Django application as an AWS Lambda function with one invocation per request. There are \"always on\" processes that listen for incoming requests. I'm interested in trying Zappa, but I'm confused about how CDK, zappa-cli, SAM and Serverless Framework would all play together. Aurora Postgres Serverless is another nice \"serverless\" aspect of this project and contributes significantly to cost savings.",{"type":25,"tag":37,"props":5851,"children":5852},{},[5853],{"type":30,"value":5854},"This project currently uses no NAT Gateways. The Fargate services and tasks running Django processes (gunicorn, celery, daphne as well as migration, collectstatic and other management commands) are launched in public subnets and the databases (RDS and ElastiCache) are placed in private subnets. This is primarily done to avoid the cost of running a NAT Gateway.",{"type":25,"tag":33,"props":5856,"children":5857},{},[5858,5870],{"type":25,"tag":37,"props":5859,"children":5860},{},[5861,5863,5869],{"type":30,"value":5862},"I think it would fairly easy to switch to using a NAT Gatway to add an additional layer of security that is recommended in this article: ",{"type":25,"tag":41,"props":5864,"children":5867},{"href":5865,"rel":5866},"https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/",[45],[5868],{"type":30,"value":5865},{"type":30,"value":208},{"type":25,"tag":37,"props":5871,"children":5872},{},[5873,5875,5881],{"type":30,"value":5874},"I asked a question about this on the Stack Exchange Information Security forum: ",{"type":25,"tag":41,"props":5876,"children":5879},{"href":5877,"rel":5878},"https://security.stackexchange.com/questions/232055/security-implications-of-using-public-subnets-in-aws-vpc-for-hosting-web-and-job",[45],[5880],{"type":30,"value":5877},{"type":30,"value":5882},"\nI'm curious to know if this is a reasonable tradeoff to make, as well as how secure the proposed solution is (using security groups and network ACLs).",{"type":25,"tag":1139,"props":5884,"children":5885},{"start":967},[5886,5898],{"type":25,"tag":37,"props":5887,"children":5888},{},[5889,5891,5896],{"type":30,"value":5890},"I'm not focusing on SEO in this project. I'm using ",{"type":25,"tag":130,"props":5892,"children":5894},{"className":5893},[],[5895],{"type":30,"value":3868},{"type":30,"value":5897}," as the error document for the S3 website that CloudFront uses as the default behavior. This means that nested routes for the PWA have 404 response codes. I have heard about using lambda@edge to rewrite the the response code, I'm also curious about using this project in SSR mode (and also \"serverless-side rendering\"), but for now that is outside of the scope of what I want to do with this project.",{"type":25,"tag":37,"props":5899,"children":5900},{},[5901,5906,5908,5914],{"type":25,"tag":4897,"props":5902,"children":5903},{},[5904],{"type":30,"value":5905},"CDK is an awesome tool!",{"type":30,"value":5907}," Here is a great introduction by Nathan Peck, Senior Developer Advocate at Amazon Web Services: ",{"type":25,"tag":41,"props":5909,"children":5912},{"href":5910,"rel":5911},"https://www.youtube.com/watch?v=184S7ki6fJA",[45],[5913],{"type":30,"value":5910},{"type":30,"value":208},{"type":25,"tag":339,"props":5916,"children":5918},{"id":5917},"my-experience-with-aws-cdk",[5919],{"type":30,"value":5920},"My experience with AWS CDK",{"type":25,"tag":26,"props":5922,"children":5923},{},[5924],{"type":30,"value":5925},"Having worked with CloudFormation for almost a year, I was not looking forward to learning a another Infrastructure as Code (IaC) tool. I struggled with CloudFormation and the whole concept of using an extended version of YAML to define infrastructure for multiple environments. I have limited experience with Terraform, but learning another DSL seemed like a lateral move that didn't seem worth it. I'm glad I did spend time learning and using CloudFormation, because CDK is an abstraction layer over CloudFormation. Here are some of my thoughts on adopting CDK.",{"type":25,"tag":2370,"props":5927,"children":5929},{"id":5928},"start-here-httpscdkworkshopcom",[5930,5932],{"type":30,"value":5931},"Start here: ",{"type":25,"tag":41,"props":5933,"children":5936},{"href":5934,"rel":5935},"https://cdkworkshop.com",[45],[5937],{"type":30,"value":5934},{"type":25,"tag":26,"props":5939,"children":5940},{},[5941],{"type":30,"value":5942},"This is a great resource that was my first exposure to CDK. It focuses on using Lambda, DynamoDB and API Gateway, three technologies that I haven't used in production environments. In my mind this stack is the antithesis of the stack paradigm I am most experienced with: EC2, RDS and ELB. Regardless, I went ahead with it and was pretty much instantly hooked on CDK.",{"type":25,"tag":2370,"props":5944,"children":5946},{"id":5945},"the-stack-is-defined-by-a-small-number-of-inputs-used-for-namespacing",[5947],{"type":30,"value":5948},"The stack is defined by a small number of inputs used for namespacing",{"type":25,"tag":26,"props":5950,"children":5951},{},[5952,5958,5960,5965],{"type":25,"tag":130,"props":5953,"children":5955},{"className":5954},[],[5956],{"type":30,"value":5957},"awscdk/app.py",{"type":30,"value":5959}," is the entrypoint for ",{"type":25,"tag":130,"props":5961,"children":5963},{"className":5962},[],[5964],{"type":30,"value":4813},{"type":30,"value":5966}," commands. Here's what it contains:",{"type":25,"tag":26,"props":5968,"children":5969},{},[5970,5972,5978,5980,5986],{"type":30,"value":5971},"Here are the main parameters for ",{"type":25,"tag":130,"props":5973,"children":5975},{"className":5974},[],[5976],{"type":30,"value":5977},"ApplicationStack",{"type":30,"value":5979},", which represents all of the resources for a specific environment environment. Each value is composed of environment variables set in GitLab CI when ",{"type":25,"tag":130,"props":5981,"children":5983},{"className":5982},[],[5984],{"type":30,"value":5985},"cdk deploy",{"type":30,"value":5987}," is called:",{"type":25,"tag":33,"props":5989,"children":5990},{},[5991,6031,6042,6066,6099,6130],{"type":25,"tag":37,"props":5992,"children":5993},{},[5994,6000,6002,6008,6009,6015,6016,6022,6023,6029],{"type":25,"tag":130,"props":5995,"children":5997},{"className":5996},[],[5998],{"type":30,"value":5999},"environment_name",{"type":30,"value":6001}," - Possible examples could be ",{"type":25,"tag":130,"props":6003,"children":6005},{"className":6004},[],[6006],{"type":30,"value":6007},"dev",{"type":30,"value":860},{"type":25,"tag":130,"props":6010,"children":6012},{"className":6011},[],[6013],{"type":30,"value":6014},"qa",{"type":30,"value":860},{"type":25,"tag":130,"props":6017,"children":6019},{"className":6018},[],[6020],{"type":30,"value":6021},"some-feature-branch",{"type":30,"value":860},{"type":25,"tag":130,"props":6024,"children":6026},{"className":6025},[],[6027],{"type":30,"value":6028},"prod",{"type":30,"value":6030},", etc.",{"type":25,"tag":37,"props":6032,"children":6033},{},[6034,6040],{"type":25,"tag":130,"props":6035,"children":6037},{"className":6036},[],[6038],{"type":30,"value":6039},"base_domain_name",{"type":30,"value":6041}," - The domain name of the Hosted Zone that needs to be setup manually in Route53",{"type":25,"tag":37,"props":6043,"children":6044},{},[6045,6051,6053,6059,6061],{"type":25,"tag":130,"props":6046,"children":6048},{"className":6047},[],[6049],{"type":30,"value":6050},"full_domain_name",{"type":30,"value":6052}," - ",{"type":25,"tag":130,"props":6054,"children":6056},{"className":6055},[],[6057],{"type":30,"value":6058},"f\"{environment_name}.{base_domain_name}\"",{"type":30,"value":6060}," or optionally just ",{"type":25,"tag":130,"props":6062,"children":6064},{"className":6063},[],[6065],{"type":30,"value":6039},{"type":25,"tag":37,"props":6067,"children":6068},{},[6069,6075,6077,6082,6084,6089,6091,6097],{"type":25,"tag":130,"props":6070,"children":6072},{"className":6071},[],[6073],{"type":30,"value":6074},"base_app_name",{"type":30,"value":6076}," - Based on the ",{"type":25,"tag":130,"props":6078,"children":6080},{"className":6079},[],[6081],{"type":30,"value":6039},{"type":30,"value":6083},", but ",{"type":25,"tag":130,"props":6085,"children":6087},{"className":6086},[],[6088],{"type":30,"value":208},{"type":30,"value":6090}," is replaced with ",{"type":25,"tag":130,"props":6092,"children":6094},{"className":6093},[],[6095],{"type":30,"value":6096},"-",{"type":30,"value":6098}," in order to be used for naming certain AWS resources, used for resources tagging so we can easily look at the costs of all environments for our application with one tag.",{"type":25,"tag":37,"props":6100,"children":6101},{},[6102,6108,6110,6115,6116,6121,6123,6128],{"type":25,"tag":130,"props":6103,"children":6105},{"className":6104},[],[6106],{"type":30,"value":6107},"full_app_name",{"type":30,"value":6109}," - Base on ",{"type":25,"tag":130,"props":6111,"children":6113},{"className":6112},[],[6114],{"type":30,"value":6050},{"type":30,"value":860},{"type":25,"tag":130,"props":6117,"children":6119},{"className":6118},[],[6120],{"type":30,"value":208},{"type":30,"value":6122}," replaced with ",{"type":25,"tag":130,"props":6124,"children":6126},{"className":6125},[],[6127],{"type":30,"value":6096},{"type":30,"value":6129}," as well.",{"type":25,"tag":37,"props":6131,"children":6132},{},[6133],{"type":25,"tag":130,"props":6134,"children":6136},{"className":6135},[],[6137],{"type":30,"value":6138},"aws_region",{"type":25,"tag":26,"props":6140,"children":6141},{},[6142,6144,6149],{"type":30,"value":6143},"Expand to the following to view ",{"type":25,"tag":130,"props":6145,"children":6147},{"className":6146},[],[6148],{"type":30,"value":5957},{"type":30,"value":790},{"type":25,"tag":6151,"props":6152,"children":6153},"details",{},[6154],{"type":25,"tag":693,"props":6155,"children":6159},{"code":6156,"language":6157,"meta":8,"className":6158,"style":8},"#!/usr/bin/env python3\nimport os\n\nfrom aws_cdk import core\n\nfrom awscdk.cdk_app_root import ApplicationStack\n\n# naming conventions, also used for ACM certs, DNS Records, resource naming\n# Dynamically generated resource names created in CDK are used in GitLab CI\n# such as cluster name, task definitions, etc.\nenvironment_name = f\"{os.environ.get('ENVIRONMENT', 'dev')}\"\nbase_domain_name = os.environ.get(\"DOMAIN_NAME\", \"mysite.com\")\n# if the the production environent subdomain should nott be included in the URL\n# redefine `full_domain_name` to `base_domain_name` for that environment\nfull_domain_name = f\"{environment_name}.{base_domain_name}\"  # dev.mysite.com\n# if environment_name == \"prod\":\n#     full_domain_name = base_domain_name\nbase_app_name = os.environ.get(\"APP_NAME\", \"mysite-com\")\nfull_app_name = f\"{environment_name}-{base_app_name}\"  # dev-mysite-com\naws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n\n\napp = core.App()\nstack = ApplicationStack(\n    app,\n    f\"{full_app_name}-stack\",\n    environment_name=environment_name,\n    base_domain_name=base_domain_name,\n    full_domain_name=full_domain_name,\n    base_app_name=base_app_name,\n    full_app_name=full_app_name,\n    env={\"region\": aws_region},\n)\n\n# in order to be able to tag ECS resources, you need to go to\n# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n# and enable at least Service and Task. Optionally enable\n# CloudWatch Container Insights\nstack.node.apply_aspect(core.Tag(\"StackName\", full_app_name))\nstack.node.apply_aspect(core.Tag(\"StackName\", base_app_name))\n\napp.synth()\n","python","language-python shiki shiki-themes github-light github-dark monokai",[6160],{"type":25,"tag":130,"props":6161,"children":6162},{"__ignoreMap":8},[6163,6172,6185,6192,6214,6221,6242,6249,6257,6265,6273,6335,6370,6378,6386,6443,6451,6459,6493,6550,6584,6591,6598,6615,6632,6640,6673,6692,6710,6728,6746,6764,6791,6799,6807,6816,6825,6834,6843,6862,6879,6887],{"type":25,"tag":930,"props":6164,"children":6165},{"class":932,"line":933},[6166],{"type":25,"tag":930,"props":6167,"children":6169},{"style":6168},"--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F",[6170],{"type":30,"value":6171},"#!/usr/bin/env python3\n",{"type":25,"tag":930,"props":6173,"children":6174},{"class":932,"line":250},[6175,6180],{"type":25,"tag":930,"props":6176,"children":6177},{"style":1059},[6178],{"type":30,"value":6179},"import",{"type":25,"tag":930,"props":6181,"children":6182},{"style":942},[6183],{"type":30,"value":6184}," os\n",{"type":25,"tag":930,"props":6186,"children":6187},{"class":932,"line":967},[6188],{"type":25,"tag":930,"props":6189,"children":6190},{"emptyLinePlaceholder":265},[6191],{"type":30,"value":3733},{"type":25,"tag":930,"props":6193,"children":6194},{"class":932,"line":985},[6195,6200,6205,6209],{"type":25,"tag":930,"props":6196,"children":6197},{"style":1059},[6198],{"type":30,"value":6199},"from",{"type":25,"tag":930,"props":6201,"children":6202},{"style":942},[6203],{"type":30,"value":6204}," aws_cdk ",{"type":25,"tag":930,"props":6206,"children":6207},{"style":1059},[6208],{"type":30,"value":6179},{"type":25,"tag":930,"props":6210,"children":6211},{"style":942},[6212],{"type":30,"value":6213}," core\n",{"type":25,"tag":930,"props":6215,"children":6216},{"class":932,"line":998},[6217],{"type":25,"tag":930,"props":6218,"children":6219},{"emptyLinePlaceholder":265},[6220],{"type":30,"value":3733},{"type":25,"tag":930,"props":6222,"children":6223},{"class":932,"line":1012},[6224,6228,6233,6237],{"type":25,"tag":930,"props":6225,"children":6226},{"style":1059},[6227],{"type":30,"value":6199},{"type":25,"tag":930,"props":6229,"children":6230},{"style":942},[6231],{"type":30,"value":6232}," awscdk.cdk_app_root ",{"type":25,"tag":930,"props":6234,"children":6235},{"style":1059},[6236],{"type":30,"value":6179},{"type":25,"tag":930,"props":6238,"children":6239},{"style":942},[6240],{"type":30,"value":6241}," ApplicationStack\n",{"type":25,"tag":930,"props":6243,"children":6244},{"class":932,"line":1025},[6245],{"type":25,"tag":930,"props":6246,"children":6247},{"emptyLinePlaceholder":265},[6248],{"type":30,"value":3733},{"type":25,"tag":930,"props":6250,"children":6251},{"class":932,"line":1038},[6252],{"type":25,"tag":930,"props":6253,"children":6254},{"style":6168},[6255],{"type":30,"value":6256},"# naming conventions, also used for ACM certs, DNS Records, resource naming\n",{"type":25,"tag":930,"props":6258,"children":6259},{"class":932,"line":1051},[6260],{"type":25,"tag":930,"props":6261,"children":6262},{"style":6168},[6263],{"type":30,"value":6264},"# Dynamically generated resource names created in CDK are used in GitLab CI\n",{"type":25,"tag":930,"props":6266,"children":6267},{"class":932,"line":1065},[6268],{"type":25,"tag":930,"props":6269,"children":6270},{"style":6168},[6271],{"type":30,"value":6272},"# such as cluster name, task definitions, etc.\n",{"type":25,"tag":930,"props":6274,"children":6275},{"class":932,"line":1074},[6276,6281,6286,6292,6297,6302,6307,6312,6316,6321,6325,6330],{"type":25,"tag":930,"props":6277,"children":6278},{"style":942},[6279],{"type":30,"value":6280},"environment_name ",{"type":25,"tag":930,"props":6282,"children":6283},{"style":1059},[6284],{"type":30,"value":6285},"=",{"type":25,"tag":930,"props":6287,"children":6289},{"style":6288},"--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[6290],{"type":30,"value":6291}," f",{"type":25,"tag":930,"props":6293,"children":6294},{"style":961},[6295],{"type":30,"value":6296},"\"",{"type":25,"tag":930,"props":6298,"children":6299},{"style":2676},[6300],{"type":30,"value":6301},"{",{"type":25,"tag":930,"props":6303,"children":6304},{"style":942},[6305],{"type":30,"value":6306},"os.environ.get(",{"type":25,"tag":930,"props":6308,"children":6309},{"style":961},[6310],{"type":30,"value":6311},"'ENVIRONMENT'",{"type":25,"tag":930,"props":6313,"children":6314},{"style":942},[6315],{"type":30,"value":860},{"type":25,"tag":930,"props":6317,"children":6318},{"style":961},[6319],{"type":30,"value":6320},"'dev'",{"type":25,"tag":930,"props":6322,"children":6323},{"style":942},[6324],{"type":30,"value":4022},{"type":25,"tag":930,"props":6326,"children":6327},{"style":2676},[6328],{"type":30,"value":6329},"}",{"type":25,"tag":930,"props":6331,"children":6332},{"style":961},[6333],{"type":30,"value":6334},"\"\n",{"type":25,"tag":930,"props":6336,"children":6337},{"class":932,"line":1083},[6338,6343,6347,6352,6357,6361,6366],{"type":25,"tag":930,"props":6339,"children":6340},{"style":942},[6341],{"type":30,"value":6342},"base_domain_name ",{"type":25,"tag":930,"props":6344,"children":6345},{"style":1059},[6346],{"type":30,"value":6285},{"type":25,"tag":930,"props":6348,"children":6349},{"style":942},[6350],{"type":30,"value":6351}," os.environ.get(",{"type":25,"tag":930,"props":6353,"children":6354},{"style":961},[6355],{"type":30,"value":6356},"\"DOMAIN_NAME\"",{"type":25,"tag":930,"props":6358,"children":6359},{"style":942},[6360],{"type":30,"value":860},{"type":25,"tag":930,"props":6362,"children":6363},{"style":961},[6364],{"type":30,"value":6365},"\"mysite.com\"",{"type":25,"tag":930,"props":6367,"children":6368},{"style":942},[6369],{"type":30,"value":2702},{"type":25,"tag":930,"props":6371,"children":6372},{"class":932,"line":1092},[6373],{"type":25,"tag":930,"props":6374,"children":6375},{"style":6168},[6376],{"type":30,"value":6377},"# if the the production environent subdomain should nott be included in the URL\n",{"type":25,"tag":930,"props":6379,"children":6380},{"class":932,"line":1101},[6381],{"type":25,"tag":930,"props":6382,"children":6383},{"style":6168},[6384],{"type":30,"value":6385},"# redefine `full_domain_name` to `base_domain_name` for that environment\n",{"type":25,"tag":930,"props":6387,"children":6388},{"class":932,"line":2017},[6389,6394,6398,6402,6406,6410,6414,6418,6422,6426,6430,6434,6438],{"type":25,"tag":930,"props":6390,"children":6391},{"style":942},[6392],{"type":30,"value":6393},"full_domain_name ",{"type":25,"tag":930,"props":6395,"children":6396},{"style":1059},[6397],{"type":30,"value":6285},{"type":25,"tag":930,"props":6399,"children":6400},{"style":6288},[6401],{"type":30,"value":6291},{"type":25,"tag":930,"props":6403,"children":6404},{"style":961},[6405],{"type":30,"value":6296},{"type":25,"tag":930,"props":6407,"children":6408},{"style":2676},[6409],{"type":30,"value":6301},{"type":25,"tag":930,"props":6411,"children":6412},{"style":942},[6413],{"type":30,"value":5999},{"type":25,"tag":930,"props":6415,"children":6416},{"style":2676},[6417],{"type":30,"value":6329},{"type":25,"tag":930,"props":6419,"children":6420},{"style":961},[6421],{"type":30,"value":208},{"type":25,"tag":930,"props":6423,"children":6424},{"style":2676},[6425],{"type":30,"value":6301},{"type":25,"tag":930,"props":6427,"children":6428},{"style":942},[6429],{"type":30,"value":6039},{"type":25,"tag":930,"props":6431,"children":6432},{"style":2676},[6433],{"type":30,"value":6329},{"type":25,"tag":930,"props":6435,"children":6436},{"style":961},[6437],{"type":30,"value":6296},{"type":25,"tag":930,"props":6439,"children":6440},{"style":6168},[6441],{"type":30,"value":6442},"  # dev.mysite.com\n",{"type":25,"tag":930,"props":6444,"children":6445},{"class":932,"line":2030},[6446],{"type":25,"tag":930,"props":6447,"children":6448},{"style":6168},[6449],{"type":30,"value":6450},"# if environment_name == \"prod\":\n",{"type":25,"tag":930,"props":6452,"children":6453},{"class":932,"line":2042},[6454],{"type":25,"tag":930,"props":6455,"children":6456},{"style":6168},[6457],{"type":30,"value":6458},"#     full_domain_name = base_domain_name\n",{"type":25,"tag":930,"props":6460,"children":6461},{"class":932,"line":2054},[6462,6467,6471,6475,6480,6484,6489],{"type":25,"tag":930,"props":6463,"children":6464},{"style":942},[6465],{"type":30,"value":6466},"base_app_name ",{"type":25,"tag":930,"props":6468,"children":6469},{"style":1059},[6470],{"type":30,"value":6285},{"type":25,"tag":930,"props":6472,"children":6473},{"style":942},[6474],{"type":30,"value":6351},{"type":25,"tag":930,"props":6476,"children":6477},{"style":961},[6478],{"type":30,"value":6479},"\"APP_NAME\"",{"type":25,"tag":930,"props":6481,"children":6482},{"style":942},[6483],{"type":30,"value":860},{"type":25,"tag":930,"props":6485,"children":6486},{"style":961},[6487],{"type":30,"value":6488},"\"mysite-com\"",{"type":25,"tag":930,"props":6490,"children":6491},{"style":942},[6492],{"type":30,"value":2702},{"type":25,"tag":930,"props":6494,"children":6495},{"class":932,"line":4309},[6496,6501,6505,6509,6513,6517,6521,6525,6529,6533,6537,6541,6545],{"type":25,"tag":930,"props":6497,"children":6498},{"style":942},[6499],{"type":30,"value":6500},"full_app_name ",{"type":25,"tag":930,"props":6502,"children":6503},{"style":1059},[6504],{"type":30,"value":6285},{"type":25,"tag":930,"props":6506,"children":6507},{"style":6288},[6508],{"type":30,"value":6291},{"type":25,"tag":930,"props":6510,"children":6511},{"style":961},[6512],{"type":30,"value":6296},{"type":25,"tag":930,"props":6514,"children":6515},{"style":2676},[6516],{"type":30,"value":6301},{"type":25,"tag":930,"props":6518,"children":6519},{"style":942},[6520],{"type":30,"value":5999},{"type":25,"tag":930,"props":6522,"children":6523},{"style":2676},[6524],{"type":30,"value":6329},{"type":25,"tag":930,"props":6526,"children":6527},{"style":961},[6528],{"type":30,"value":6096},{"type":25,"tag":930,"props":6530,"children":6531},{"style":2676},[6532],{"type":30,"value":6301},{"type":25,"tag":930,"props":6534,"children":6535},{"style":942},[6536],{"type":30,"value":6074},{"type":25,"tag":930,"props":6538,"children":6539},{"style":2676},[6540],{"type":30,"value":6329},{"type":25,"tag":930,"props":6542,"children":6543},{"style":961},[6544],{"type":30,"value":6296},{"type":25,"tag":930,"props":6546,"children":6547},{"style":6168},[6548],{"type":30,"value":6549},"  # dev-mysite-com\n",{"type":25,"tag":930,"props":6551,"children":6552},{"class":932,"line":4322},[6553,6558,6562,6566,6571,6575,6580],{"type":25,"tag":930,"props":6554,"children":6555},{"style":942},[6556],{"type":30,"value":6557},"aws_region ",{"type":25,"tag":930,"props":6559,"children":6560},{"style":1059},[6561],{"type":30,"value":6285},{"type":25,"tag":930,"props":6563,"children":6564},{"style":942},[6565],{"type":30,"value":6351},{"type":25,"tag":930,"props":6567,"children":6568},{"style":961},[6569],{"type":30,"value":6570},"\"AWS_DEFAULT_REGION\"",{"type":25,"tag":930,"props":6572,"children":6573},{"style":942},[6574],{"type":30,"value":860},{"type":25,"tag":930,"props":6576,"children":6577},{"style":961},[6578],{"type":30,"value":6579},"\"us-east-1\"",{"type":25,"tag":930,"props":6581,"children":6582},{"style":942},[6583],{"type":30,"value":2702},{"type":25,"tag":930,"props":6585,"children":6586},{"class":932,"line":4335},[6587],{"type":25,"tag":930,"props":6588,"children":6589},{"emptyLinePlaceholder":265},[6590],{"type":30,"value":3733},{"type":25,"tag":930,"props":6592,"children":6593},{"class":932,"line":4347},[6594],{"type":25,"tag":930,"props":6595,"children":6596},{"emptyLinePlaceholder":265},[6597],{"type":30,"value":3733},{"type":25,"tag":930,"props":6599,"children":6600},{"class":932,"line":4359},[6601,6606,6610],{"type":25,"tag":930,"props":6602,"children":6603},{"style":942},[6604],{"type":30,"value":6605},"app ",{"type":25,"tag":930,"props":6607,"children":6608},{"style":1059},[6609],{"type":30,"value":6285},{"type":25,"tag":930,"props":6611,"children":6612},{"style":942},[6613],{"type":30,"value":6614}," core.App()\n",{"type":25,"tag":930,"props":6616,"children":6617},{"class":932,"line":4371},[6618,6623,6627],{"type":25,"tag":930,"props":6619,"children":6620},{"style":942},[6621],{"type":30,"value":6622},"stack ",{"type":25,"tag":930,"props":6624,"children":6625},{"style":1059},[6626],{"type":30,"value":6285},{"type":25,"tag":930,"props":6628,"children":6629},{"style":942},[6630],{"type":30,"value":6631}," ApplicationStack(\n",{"type":25,"tag":930,"props":6633,"children":6634},{"class":932,"line":4384},[6635],{"type":25,"tag":930,"props":6636,"children":6637},{"style":942},[6638],{"type":30,"value":6639},"    app,\n",{"type":25,"tag":930,"props":6641,"children":6642},{"class":932,"line":4397},[6643,6648,6652,6656,6660,6664,6669],{"type":25,"tag":930,"props":6644,"children":6645},{"style":6288},[6646],{"type":30,"value":6647},"    f",{"type":25,"tag":930,"props":6649,"children":6650},{"style":961},[6651],{"type":30,"value":6296},{"type":25,"tag":930,"props":6653,"children":6654},{"style":2676},[6655],{"type":30,"value":6301},{"type":25,"tag":930,"props":6657,"children":6658},{"style":942},[6659],{"type":30,"value":6107},{"type":25,"tag":930,"props":6661,"children":6662},{"style":2676},[6663],{"type":30,"value":6329},{"type":25,"tag":930,"props":6665,"children":6666},{"style":961},[6667],{"type":30,"value":6668},"-stack\"",{"type":25,"tag":930,"props":6670,"children":6671},{"style":942},[6672],{"type":30,"value":2926},{"type":25,"tag":930,"props":6674,"children":6676},{"class":932,"line":6675},27,[6677,6683,6687],{"type":25,"tag":930,"props":6678,"children":6680},{"style":6679},"--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[6681],{"type":30,"value":6682},"    environment_name",{"type":25,"tag":930,"props":6684,"children":6685},{"style":1059},[6686],{"type":30,"value":6285},{"type":25,"tag":930,"props":6688,"children":6689},{"style":942},[6690],{"type":30,"value":6691},"environment_name,\n",{"type":25,"tag":930,"props":6693,"children":6695},{"class":932,"line":6694},28,[6696,6701,6705],{"type":25,"tag":930,"props":6697,"children":6698},{"style":6679},[6699],{"type":30,"value":6700},"    base_domain_name",{"type":25,"tag":930,"props":6702,"children":6703},{"style":1059},[6704],{"type":30,"value":6285},{"type":25,"tag":930,"props":6706,"children":6707},{"style":942},[6708],{"type":30,"value":6709},"base_domain_name,\n",{"type":25,"tag":930,"props":6711,"children":6713},{"class":932,"line":6712},29,[6714,6719,6723],{"type":25,"tag":930,"props":6715,"children":6716},{"style":6679},[6717],{"type":30,"value":6718},"    full_domain_name",{"type":25,"tag":930,"props":6720,"children":6721},{"style":1059},[6722],{"type":30,"value":6285},{"type":25,"tag":930,"props":6724,"children":6725},{"style":942},[6726],{"type":30,"value":6727},"full_domain_name,\n",{"type":25,"tag":930,"props":6729,"children":6731},{"class":932,"line":6730},30,[6732,6737,6741],{"type":25,"tag":930,"props":6733,"children":6734},{"style":6679},[6735],{"type":30,"value":6736},"    base_app_name",{"type":25,"tag":930,"props":6738,"children":6739},{"style":1059},[6740],{"type":30,"value":6285},{"type":25,"tag":930,"props":6742,"children":6743},{"style":942},[6744],{"type":30,"value":6745},"base_app_name,\n",{"type":25,"tag":930,"props":6747,"children":6749},{"class":932,"line":6748},31,[6750,6755,6759],{"type":25,"tag":930,"props":6751,"children":6752},{"style":6679},[6753],{"type":30,"value":6754},"    full_app_name",{"type":25,"tag":930,"props":6756,"children":6757},{"style":1059},[6758],{"type":30,"value":6285},{"type":25,"tag":930,"props":6760,"children":6761},{"style":942},[6762],{"type":30,"value":6763},"full_app_name,\n",{"type":25,"tag":930,"props":6765,"children":6767},{"class":932,"line":6766},32,[6768,6773,6777,6781,6786],{"type":25,"tag":930,"props":6769,"children":6770},{"style":6679},[6771],{"type":30,"value":6772},"    env",{"type":25,"tag":930,"props":6774,"children":6775},{"style":1059},[6776],{"type":30,"value":6285},{"type":25,"tag":930,"props":6778,"children":6779},{"style":942},[6780],{"type":30,"value":6301},{"type":25,"tag":930,"props":6782,"children":6783},{"style":961},[6784],{"type":30,"value":6785},"\"region\"",{"type":25,"tag":930,"props":6787,"children":6788},{"style":942},[6789],{"type":30,"value":6790},": aws_region},\n",{"type":25,"tag":930,"props":6792,"children":6794},{"class":932,"line":6793},33,[6795],{"type":25,"tag":930,"props":6796,"children":6797},{"style":942},[6798],{"type":30,"value":2702},{"type":25,"tag":930,"props":6800,"children":6802},{"class":932,"line":6801},34,[6803],{"type":25,"tag":930,"props":6804,"children":6805},{"emptyLinePlaceholder":265},[6806],{"type":30,"value":3733},{"type":25,"tag":930,"props":6808,"children":6810},{"class":932,"line":6809},35,[6811],{"type":25,"tag":930,"props":6812,"children":6813},{"style":6168},[6814],{"type":30,"value":6815},"# in order to be able to tag ECS resources, you need to go to\n",{"type":25,"tag":930,"props":6817,"children":6819},{"class":932,"line":6818},36,[6820],{"type":25,"tag":930,"props":6821,"children":6822},{"style":6168},[6823],{"type":30,"value":6824},"# the ECS Console > Account Settings > Amazon ECS ARN and resource ID settings\n",{"type":25,"tag":930,"props":6826,"children":6828},{"class":932,"line":6827},37,[6829],{"type":25,"tag":930,"props":6830,"children":6831},{"style":6168},[6832],{"type":30,"value":6833},"# and enable at least Service and Task. Optionally enable\n",{"type":25,"tag":930,"props":6835,"children":6837},{"class":932,"line":6836},38,[6838],{"type":25,"tag":930,"props":6839,"children":6840},{"style":6168},[6841],{"type":30,"value":6842},"# CloudWatch Container Insights\n",{"type":25,"tag":930,"props":6844,"children":6846},{"class":932,"line":6845},39,[6847,6852,6857],{"type":25,"tag":930,"props":6848,"children":6849},{"style":942},[6850],{"type":30,"value":6851},"stack.node.apply_aspect(core.Tag(",{"type":25,"tag":930,"props":6853,"children":6854},{"style":961},[6855],{"type":30,"value":6856},"\"StackName\"",{"type":25,"tag":930,"props":6858,"children":6859},{"style":942},[6860],{"type":30,"value":6861},", full_app_name))\n",{"type":25,"tag":930,"props":6863,"children":6865},{"class":932,"line":6864},40,[6866,6870,6874],{"type":25,"tag":930,"props":6867,"children":6868},{"style":942},[6869],{"type":30,"value":6851},{"type":25,"tag":930,"props":6871,"children":6872},{"style":961},[6873],{"type":30,"value":6856},{"type":25,"tag":930,"props":6875,"children":6876},{"style":942},[6877],{"type":30,"value":6878},", base_app_name))\n",{"type":25,"tag":930,"props":6880,"children":6882},{"class":932,"line":6881},41,[6883],{"type":25,"tag":930,"props":6884,"children":6885},{"emptyLinePlaceholder":265},[6886],{"type":30,"value":3733},{"type":25,"tag":930,"props":6888,"children":6890},{"class":932,"line":6889},42,[6891],{"type":25,"tag":930,"props":6892,"children":6893},{"style":942},[6894],{"type":30,"value":6895},"app.synth()\n",{"type":25,"tag":2370,"props":6897,"children":6899},{"id":6898},"using-cdk-synth-in-development",[6900,6902,6908],{"type":30,"value":6901},"Using ",{"type":25,"tag":130,"props":6903,"children":6905},{"className":6904},[],[6906],{"type":30,"value":6907},"cdk synth",{"type":30,"value":6909}," in development",{"type":25,"tag":26,"props":6911,"children":6912},{},[6913,6915,6921,6923,6929,6931,6937,6938,6944,6945,6951,6953,6959,6961,6967,6969,6974,6976,6981],{"type":30,"value":6914},"When I first started using CDK, I defined a root stack containing multiple CDK constructs that each included groups of related CDK resources. For example, I had an ",{"type":25,"tag":130,"props":6916,"children":6918},{"className":6917},[],[6919],{"type":30,"value":6920},"RDSConstruct",{"type":30,"value":6922}," that contained a ",{"type":25,"tag":130,"props":6924,"children":6926},{"className":6925},[],[6927],{"type":30,"value":6928},"Secret",{"type":30,"value":6930},", a ",{"type":25,"tag":130,"props":6932,"children":6934},{"className":6933},[],[6935],{"type":30,"value":6936},"StringParameter",{"type":30,"value":6930},{"type":25,"tag":130,"props":6939,"children":6941},{"className":6940},[],[6942],{"type":30,"value":6943},"CfnSecurityGroup",{"type":30,"value":6930},{"type":25,"tag":130,"props":6946,"children":6948},{"className":6947},[],[6949],{"type":30,"value":6950},"CfnDBSubnetGroup",{"type":30,"value":6952}," and a ",{"type":25,"tag":130,"props":6954,"children":6956},{"className":6955},[],[6957],{"type":30,"value":6958},"CfnDBCluster",{"type":30,"value":6960},". Whenever I added a new section of CDK code, I would run ",{"type":25,"tag":130,"props":6962,"children":6964},{"className":6963},[],[6965],{"type":30,"value":6966},"cdk synth > stack.yml",{"type":30,"value":6968}," to generate a \"snapshot\" of my infrastructure in one file. ",{"type":25,"tag":130,"props":6970,"children":6972},{"className":6971},[],[6973],{"type":30,"value":2335},{"type":30,"value":6975}," was committed in my repo, and I could easily see how changes in CDK code changed the resulting CloudFormation YAML by repeating this ",{"type":25,"tag":130,"props":6977,"children":6979},{"className":6978},[],[6980],{"type":30,"value":6907},{"type":30,"value":1795},{"type":25,"tag":2370,"props":6983,"children":6985},{"id":6984},"nestedstacks",[6986,6992],{"type":25,"tag":130,"props":6987,"children":6989},{"className":6988},[],[6990],{"type":30,"value":6991},"NestedStack",{"type":30,"value":6993},"s",{"type":25,"tag":26,"props":6995,"children":6996},{},[6997,7002,7004,7009,7011,7017,7019,7025,7027,7032,7033,7039,7041,7047,7049,7055,7057,7062,7064,7070,7072,7077],{"type":25,"tag":130,"props":6998,"children":7000},{"className":6999},[],[7001],{"type":30,"value":2335},{"type":30,"value":7003}," grew larger and larger as I added more resources in my main \"master stack\" or \"skeleton stack\", and I realized that I was going to reach the hard limit of 200 resources per CloudFormation stack. Refactoring to use ",{"type":25,"tag":130,"props":7005,"children":7007},{"className":7006},[],[7008],{"type":30,"value":6991},{"type":30,"value":7010},"s was pretty straightforward, all I had to do was replace ",{"type":25,"tag":130,"props":7012,"children":7014},{"className":7013},[],[7015],{"type":30,"value":7016},"core.Construct",{"type":30,"value":7018}," with ",{"type":25,"tag":130,"props":7020,"children":7022},{"className":7021},[],[7023],{"type":30,"value":7024},"cloudformation.NestedStack",{"type":30,"value":7026},". With nested stacks, running ",{"type":25,"tag":130,"props":7028,"children":7030},{"className":7029},[],[7031],{"type":30,"value":6966},{"type":30,"value":3520},{"type":25,"tag":130,"props":7034,"children":7036},{"className":7035},[],[7037],{"type":30,"value":7038},"AWS::CloudFormation::Stack",{"type":30,"value":7040},"s that are created, with ",{"type":25,"tag":130,"props":7042,"children":7044},{"className":7043},[],[7045],{"type":30,"value":7046},"TemplateURL",{"type":30,"value":7048}," and parameters from other stacks. It is more useful to look into contents of ",{"type":25,"tag":130,"props":7050,"children":7052},{"className":7051},[],[7053],{"type":30,"value":7054},"cdk.out",{"type":30,"value":7056}," when working with ",{"type":25,"tag":130,"props":7058,"children":7060},{"className":7059},[],[7061],{"type":30,"value":6991},{"type":30,"value":7063},"s. The following command (executed from the root of the project) update the contents of the ",{"type":25,"tag":130,"props":7065,"children":7067},{"className":7066},[],[7068],{"type":30,"value":7069},"awscdk/cdk.out",{"type":30,"value":7071}," directory with templates for each of the ",{"type":25,"tag":130,"props":7073,"children":7075},{"className":7074},[],[7076],{"type":30,"value":6991},{"type":30,"value":7078},"s:",{"type":25,"tag":693,"props":7080,"children":7082},{"code":7081},"cdk synth --app awscdk/app.py --output awscdk/cdk.out\n",[7083],{"type":25,"tag":130,"props":7084,"children":7085},{"__ignoreMap":8},[7086],{"type":30,"value":7081},{"type":25,"tag":26,"props":7088,"children":7089},{},[7090,7092,7097,7098,7103,7105,7111],{"type":30,"value":7091},"The result is JSON, not YAML, and ",{"type":25,"tag":130,"props":7093,"children":7095},{"className":7094},[],[7096],{"type":30,"value":7054},{"type":30,"value":1341},{"type":25,"tag":130,"props":7099,"children":7101},{"className":7100},[],[7102],{"type":30,"value":1409},{"type":30,"value":7104},"d, but it can still be helpful in verifying that your CDK code is generating the correct CloudFormation templates. (",{"type":25,"tag":130,"props":7106,"children":7108},{"className":7107},[],[7109],{"type":30,"value":7110},"cdk diff",{"type":30,"value":7112}," may be the best option for seeing how CDK code changes will change your infrastructure).",{"type":25,"tag":2370,"props":7114,"children":7116},{"id":7115},"cdk-deploy-and-cdk-in-gitlab-ci-pipelines",[7117,7122],{"type":25,"tag":130,"props":7118,"children":7120},{"className":7119},[],[7121],{"type":30,"value":5985},{"type":30,"value":7123}," and CDK in GitLab CI pipelines",{"type":25,"tag":26,"props":7125,"children":7126},{},[7127,7129,7134,7135,7141,7143,7149,7151,7157],{"type":30,"value":7128},"I like how ",{"type":25,"tag":130,"props":7130,"children":7132},{"className":7131},[],[7133],{"type":30,"value":5985},{"type":30,"value":1327},{"type":25,"tag":130,"props":7136,"children":7138},{"className":7137},[],[7139],{"type":30,"value":7140},"tail",{"type":30,"value":7142},"s the output of CloudFormation events until the stack update finishes or fails. I previously had been using the AWS CLI to call ",{"type":25,"tag":130,"props":7144,"children":7146},{"className":7145},[],[7147],{"type":30,"value":7148},"aws cloudformation update-stack",{"type":30,"value":7150},". This command kicks off a stack update and the GitLab pipeline will succeed regardless of the success of failure of the ",{"type":25,"tag":130,"props":7152,"children":7154},{"className":7153},[],[7155],{"type":30,"value":7156},"update-stack",{"type":30,"value":1795},{"type":25,"tag":313,"props":7159,"children":7160},{},[7161],{"type":25,"tag":26,"props":7162,"children":7163},{},[7164,7166,7171,7173,7178],{"type":30,"value":7165},"With CDK, the CI pipeline that calls ",{"type":25,"tag":130,"props":7167,"children":7169},{"className":7168},[],[7170],{"type":30,"value":5985},{"type":30,"value":7172}," fails if ",{"type":25,"tag":130,"props":7174,"children":7176},{"className":7175},[],[7177],{"type":30,"value":5985},{"type":30,"value":7179}," results in a stack rollback.",{"type":25,"tag":26,"props":7181,"children":7182},{},[7183,7185,7190,7192,7197],{"type":30,"value":7184},"I couldn't find any examples of how to run ",{"type":25,"tag":130,"props":7186,"children":7188},{"className":7187},[],[7189],{"type":30,"value":5985},{"type":30,"value":7191}," in a GitLab CI pipeline (using the Python version of CDK, or any version of CDK). It would be nice if there was an official image maintained for the different languages that are ready to run CDK deploy. Here's how I got ",{"type":25,"tag":130,"props":7193,"children":7195},{"className":7194},[],[7196],{"type":30,"value":5985},{"type":30,"value":7198}," working correctly in my CI/CD pipline:",{"type":25,"tag":693,"props":7200,"children":7202},{"code":7201,"language":4444,"meta":8,"className":4445,"style":8},"cdk deploy:\n  image: docker:19.03.1\n  services:\n    - docker:19.03.5-dind\n  stage: deploy\n  only:\n    - master\n  variables:\n    ENVIRONMENT: dev\n    DOCKER_TLS_CERTDIR: ''\n  before_script:\n    - apk add nodejs-current npm\n    - npm i -g aws-cdk\n    - apk add --no-cache python3\n    - pip3 install -e awscdk\n  script:\n    - cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app awscdk/app.py --require-approval never\n",[7203],{"type":25,"tag":130,"props":7204,"children":7205},{"__ignoreMap":8},[7206,7217,7232,7243,7254,7269,7281,7293,7304,7321,7338,7349,7361,7373,7385,7397,7408,7420],{"type":25,"tag":930,"props":7207,"children":7208},{"class":932,"line":933},[7209,7213],{"type":25,"tag":930,"props":7210,"children":7211},{"style":937},[7212],{"type":30,"value":5985},{"type":25,"tag":930,"props":7214,"children":7215},{"style":942},[7216],{"type":30,"value":945},{"type":25,"tag":930,"props":7218,"children":7219},{"class":932,"line":250},[7220,7224,7228],{"type":25,"tag":930,"props":7221,"children":7222},{"style":937},[7223],{"type":30,"value":973},{"type":25,"tag":930,"props":7225,"children":7226},{"style":942},[7227],{"type":30,"value":958},{"type":25,"tag":930,"props":7229,"children":7230},{"style":961},[7231],{"type":30,"value":982},{"type":25,"tag":930,"props":7233,"children":7234},{"class":932,"line":967},[7235,7239],{"type":25,"tag":930,"props":7236,"children":7237},{"style":937},[7238],{"type":30,"value":991},{"type":25,"tag":930,"props":7240,"children":7241},{"style":942},[7242],{"type":30,"value":945},{"type":25,"tag":930,"props":7244,"children":7245},{"class":932,"line":985},[7246,7250],{"type":25,"tag":930,"props":7247,"children":7248},{"style":942},[7249],{"type":30,"value":1004},{"type":25,"tag":930,"props":7251,"children":7252},{"style":961},[7253],{"type":30,"value":1009},{"type":25,"tag":930,"props":7255,"children":7256},{"class":932,"line":998},[7257,7261,7265],{"type":25,"tag":930,"props":7258,"children":7259},{"style":937},[7260],{"type":30,"value":953},{"type":25,"tag":930,"props":7262,"children":7263},{"style":942},[7264],{"type":30,"value":958},{"type":25,"tag":930,"props":7266,"children":7267},{"style":961},[7268],{"type":30,"value":1865},{"type":25,"tag":930,"props":7270,"children":7271},{"class":932,"line":1012},[7272,7277],{"type":25,"tag":930,"props":7273,"children":7274},{"style":937},[7275],{"type":30,"value":7276},"  only",{"type":25,"tag":930,"props":7278,"children":7279},{"style":942},[7280],{"type":30,"value":945},{"type":25,"tag":930,"props":7282,"children":7283},{"class":932,"line":1025},[7284,7288],{"type":25,"tag":930,"props":7285,"children":7286},{"style":942},[7287],{"type":30,"value":1004},{"type":25,"tag":930,"props":7289,"children":7290},{"style":961},[7291],{"type":30,"value":7292},"master\n",{"type":25,"tag":930,"props":7294,"children":7295},{"class":932,"line":1038},[7296,7300],{"type":25,"tag":930,"props":7297,"children":7298},{"style":937},[7299],{"type":30,"value":1910},{"type":25,"tag":930,"props":7301,"children":7302},{"style":942},[7303],{"type":30,"value":945},{"type":25,"tag":930,"props":7305,"children":7306},{"class":932,"line":1051},[7307,7312,7316],{"type":25,"tag":930,"props":7308,"children":7309},{"style":937},[7310],{"type":30,"value":7311},"    ENVIRONMENT",{"type":25,"tag":930,"props":7313,"children":7314},{"style":942},[7315],{"type":30,"value":958},{"type":25,"tag":930,"props":7317,"children":7318},{"style":961},[7319],{"type":30,"value":7320},"dev\n",{"type":25,"tag":930,"props":7322,"children":7323},{"class":932,"line":1065},[7324,7329,7333],{"type":25,"tag":930,"props":7325,"children":7326},{"style":937},[7327],{"type":30,"value":7328},"    DOCKER_TLS_CERTDIR",{"type":25,"tag":930,"props":7330,"children":7331},{"style":942},[7332],{"type":30,"value":958},{"type":25,"tag":930,"props":7334,"children":7335},{"style":961},[7336],{"type":30,"value":7337},"''\n",{"type":25,"tag":930,"props":7339,"children":7340},{"class":932,"line":1074},[7341,7345],{"type":25,"tag":930,"props":7342,"children":7343},{"style":937},[7344],{"type":30,"value":1018},{"type":25,"tag":930,"props":7346,"children":7347},{"style":942},[7348],{"type":30,"value":945},{"type":25,"tag":930,"props":7350,"children":7351},{"class":932,"line":1083},[7352,7356],{"type":25,"tag":930,"props":7353,"children":7354},{"style":942},[7355],{"type":30,"value":1004},{"type":25,"tag":930,"props":7357,"children":7358},{"style":961},[7359],{"type":30,"value":7360},"apk add nodejs-current npm\n",{"type":25,"tag":930,"props":7362,"children":7363},{"class":932,"line":1092},[7364,7368],{"type":25,"tag":930,"props":7365,"children":7366},{"style":942},[7367],{"type":30,"value":1004},{"type":25,"tag":930,"props":7369,"children":7370},{"style":961},[7371],{"type":30,"value":7372},"npm i -g aws-cdk\n",{"type":25,"tag":930,"props":7374,"children":7375},{"class":932,"line":1101},[7376,7380],{"type":25,"tag":930,"props":7377,"children":7378},{"style":942},[7379],{"type":30,"value":1004},{"type":25,"tag":930,"props":7381,"children":7382},{"style":961},[7383],{"type":30,"value":7384},"apk add --no-cache python3\n",{"type":25,"tag":930,"props":7386,"children":7387},{"class":932,"line":2017},[7388,7392],{"type":25,"tag":930,"props":7389,"children":7390},{"style":942},[7391],{"type":30,"value":1004},{"type":25,"tag":930,"props":7393,"children":7394},{"style":961},[7395],{"type":30,"value":7396},"pip3 install -e awscdk\n",{"type":25,"tag":930,"props":7398,"children":7399},{"class":932,"line":2030},[7400,7404],{"type":25,"tag":930,"props":7401,"children":7402},{"style":937},[7403],{"type":30,"value":1044},{"type":25,"tag":930,"props":7405,"children":7406},{"style":942},[7407],{"type":30,"value":945},{"type":25,"tag":930,"props":7409,"children":7410},{"class":932,"line":2042},[7411,7415],{"type":25,"tag":930,"props":7412,"children":7413},{"style":942},[7414],{"type":30,"value":1004},{"type":25,"tag":930,"props":7416,"children":7417},{"style":961},[7418],{"type":30,"value":7419},"cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n",{"type":25,"tag":930,"props":7421,"children":7422},{"class":932,"line":2054},[7423,7427],{"type":25,"tag":930,"props":7424,"children":7425},{"style":942},[7426],{"type":30,"value":1004},{"type":25,"tag":930,"props":7428,"children":7429},{"style":961},[7430],{"type":30,"value":7431},"cdk deploy --app awscdk/app.py --require-approval never\n",{"type":25,"tag":26,"props":7433,"children":7434},{},[7435,7437,7443,7445,7450,7452,7458],{"type":30,"value":7436},"I have all of my CDK code in a top level directory called ",{"type":25,"tag":130,"props":7438,"children":7440},{"className":7439},[],[7441],{"type":30,"value":7442},"awscdk",{"type":30,"value":7444},", my Django code is in the top level ",{"type":25,"tag":130,"props":7446,"children":7448},{"className":7447},[],[7449],{"type":30,"value":906},{"type":30,"value":7451}," directory and my frontend code is in the top level ",{"type":25,"tag":130,"props":7453,"children":7455},{"className":7454},[],[7456],{"type":30,"value":7457},"quasar",{"type":30,"value":7459}," directory. This directory structure is important, I'll come back to it shortly. Here are some things to note about this GitLab CI job definition:",{"type":25,"tag":33,"props":7461,"children":7462},{},[7463,7514,7540],{"type":25,"tag":37,"props":7464,"children":7465},{},[7466,7468,7473,7475,7481,7483,7489,7491,7497,7499,7505,7507,7512],{"type":30,"value":7467},"It uses the base ",{"type":25,"tag":130,"props":7469,"children":7471},{"className":7470},[],[7472],{"type":30,"value":19},{"type":30,"value":7474}," image with ",{"type":25,"tag":130,"props":7476,"children":7478},{"className":7477},[],[7479],{"type":30,"value":7480},"docker:dind",{"type":30,"value":7482}," as a dependent service. This is necessary only if you hare using CDK constructs that build docker images and make use of ",{"type":25,"tag":130,"props":7484,"children":7486},{"className":7485},[],[7487],{"type":30,"value":7488},"cdk bootstrap",{"type":30,"value":7490},", such as the ",{"type":25,"tag":130,"props":7492,"children":7494},{"className":7493},[],[7495],{"type":30,"value":7496},"aws_ecs.AssetImage",{"type":30,"value":7498}," that I use to define ",{"type":25,"tag":130,"props":7500,"children":7502},{"className":7501},[],[7503],{"type":30,"value":7504},"self.image",{"type":30,"value":7506}," in the ",{"type":25,"tag":130,"props":7508,"children":7510},{"className":7509},[],[7511],{"type":30,"value":5977},{"type":30,"value":7513}," class that defines that main stack of my application.",{"type":25,"tag":37,"props":7515,"children":7516},{},[7517,7519,7524,7526,7531,7533,7538],{"type":30,"value":7518},"It requires node, npm python and pip, so these all need to be installed via ",{"type":25,"tag":130,"props":7520,"children":7522},{"className":7521},[],[7523],{"type":30,"value":2140},{"type":30,"value":7525},", the package manager for Alpine Linux. These are done in the ",{"type":25,"tag":130,"props":7527,"children":7529},{"className":7528},[],[7530],{"type":30,"value":1430},{"type":30,"value":7532},", the setup for the main \"script\" where ",{"type":25,"tag":130,"props":7534,"children":7536},{"className":7535},[],[7537],{"type":30,"value":5985},{"type":30,"value":7539}," is called.",{"type":25,"tag":37,"props":7541,"children":7542},{},[7543,7545,7551,7553,7558,7560,7565],{"type":30,"value":7544},"The main ",{"type":25,"tag":130,"props":7546,"children":7548},{"className":7547},[],[7549],{"type":30,"value":7550},"script",{"type":30,"value":7552}," section calls ",{"type":25,"tag":130,"props":7554,"children":7556},{"className":7555},[],[7557],{"type":30,"value":7488},{"type":30,"value":7559},". You only need to call ",{"type":25,"tag":130,"props":7561,"children":7563},{"className":7562},[],[7564],{"type":30,"value":7488},{"type":30,"value":7566}," once to initialize resources that CDK will use, so placing it here in my CI script is more of a reminder that we are using CDK assets (S3 buckets and ECR images); calling it again once it has been called initially on your AWS account does nothing, and you will see a message that communicates this:",{"type":25,"tag":693,"props":7568,"children":7570},{"code":7569}," $ cdk bootstrap --app awscdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    Bootstrapping environment aws://XXXXXXXXXXXX/us-east-1...\n    Environment aws://XXXXXXXXXXXX/us-east-1 bootstrapped (no changes).\n",[7571],{"type":25,"tag":130,"props":7572,"children":7573},{"__ignoreMap":8},[7574],{"type":30,"value":7569},{"type":25,"tag":2370,"props":7576,"children":7578},{"id":7577},"cdk-bootstap",[7579],{"type":25,"tag":130,"props":7580,"children":7582},{"className":7581},[],[7583],{"type":30,"value":7584},"cdk bootstap",{"type":25,"tag":26,"props":7586,"children":7587},{},[7588,7593],{"type":25,"tag":130,"props":7589,"children":7591},{"className":7590},[],[7592],{"type":30,"value":7488},{"type":30,"value":7594}," is one of my favorite features of CDK. As I mentioned earlier, it is used with S3 and ECR.",{"type":25,"tag":5297,"props":7596,"children":7598},{"id":7597},"s3-assets",[7599],{"type":30,"value":7600},"S3 Assets",{"type":25,"tag":26,"props":7602,"children":7603},{},[7604,7606,7611],{"type":30,"value":7605},"With S3, it allows you to populate the contents of an S3 bucket. Here's an example from ",{"type":25,"tag":130,"props":7607,"children":7609},{"className":7608},[],[7610],{"type":30,"value":5977},{"type":30,"value":790},{"type":25,"tag":693,"props":7613,"children":7615},{"code":7614,"language":6157,"meta":8,"className":6158,"style":8},"        if os.path.isdir(\"./quasar/dist/pwa\"):\n            s3_deployment.BucketDeployment(\n                self,\n                \"BucketDeployment\",\n                destination_bucket=self.static_site_bucket,\n                sources=[s3_deployment.Source.asset(\"./quasar/dist/pwa\")],\n                distribution=self.cloudfront.distribution,\n            )\n",[7616],{"type":25,"tag":130,"props":7617,"children":7618},{"__ignoreMap":8},[7619,7642,7650,7663,7675,7697,7723,7744],{"type":25,"tag":930,"props":7620,"children":7621},{"class":932,"line":933},[7622,7627,7632,7637],{"type":25,"tag":930,"props":7623,"children":7624},{"style":1059},[7625],{"type":30,"value":7626},"        if",{"type":25,"tag":930,"props":7628,"children":7629},{"style":942},[7630],{"type":30,"value":7631}," os.path.isdir(",{"type":25,"tag":930,"props":7633,"children":7634},{"style":961},[7635],{"type":30,"value":7636},"\"./quasar/dist/pwa\"",{"type":25,"tag":930,"props":7638,"children":7639},{"style":942},[7640],{"type":30,"value":7641},"):\n",{"type":25,"tag":930,"props":7643,"children":7644},{"class":932,"line":250},[7645],{"type":25,"tag":930,"props":7646,"children":7647},{"style":942},[7648],{"type":30,"value":7649},"            s3_deployment.BucketDeployment(\n",{"type":25,"tag":930,"props":7651,"children":7652},{"class":932,"line":967},[7653,7659],{"type":25,"tag":930,"props":7654,"children":7656},{"style":7655},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[7657],{"type":30,"value":7658},"                self",{"type":25,"tag":930,"props":7660,"children":7661},{"style":942},[7662],{"type":30,"value":2926},{"type":25,"tag":930,"props":7664,"children":7665},{"class":932,"line":985},[7666,7671],{"type":25,"tag":930,"props":7667,"children":7668},{"style":961},[7669],{"type":30,"value":7670},"                \"BucketDeployment\"",{"type":25,"tag":930,"props":7672,"children":7673},{"style":942},[7674],{"type":30,"value":2926},{"type":25,"tag":930,"props":7676,"children":7677},{"class":932,"line":998},[7678,7683,7687,7692],{"type":25,"tag":930,"props":7679,"children":7680},{"style":6679},[7681],{"type":30,"value":7682},"                destination_bucket",{"type":25,"tag":930,"props":7684,"children":7685},{"style":1059},[7686],{"type":30,"value":6285},{"type":25,"tag":930,"props":7688,"children":7689},{"style":7655},[7690],{"type":30,"value":7691},"self",{"type":25,"tag":930,"props":7693,"children":7694},{"style":942},[7695],{"type":30,"value":7696},".static_site_bucket,\n",{"type":25,"tag":930,"props":7698,"children":7699},{"class":932,"line":1012},[7700,7705,7709,7714,7718],{"type":25,"tag":930,"props":7701,"children":7702},{"style":6679},[7703],{"type":30,"value":7704},"                sources",{"type":25,"tag":930,"props":7706,"children":7707},{"style":1059},[7708],{"type":30,"value":6285},{"type":25,"tag":930,"props":7710,"children":7711},{"style":942},[7712],{"type":30,"value":7713},"[s3_deployment.Source.asset(",{"type":25,"tag":930,"props":7715,"children":7716},{"style":961},[7717],{"type":30,"value":7636},{"type":25,"tag":930,"props":7719,"children":7720},{"style":942},[7721],{"type":30,"value":7722},")],\n",{"type":25,"tag":930,"props":7724,"children":7725},{"class":932,"line":1025},[7726,7731,7735,7739],{"type":25,"tag":930,"props":7727,"children":7728},{"style":6679},[7729],{"type":30,"value":7730},"                distribution",{"type":25,"tag":930,"props":7732,"children":7733},{"style":1059},[7734],{"type":30,"value":6285},{"type":25,"tag":930,"props":7736,"children":7737},{"style":7655},[7738],{"type":30,"value":7691},{"type":25,"tag":930,"props":7740,"children":7741},{"style":942},[7742],{"type":30,"value":7743},".cloudfront.distribution,\n",{"type":25,"tag":930,"props":7745,"children":7746},{"class":932,"line":1038},[7747],{"type":25,"tag":930,"props":7748,"children":7749},{"style":942},[7750],{"type":30,"value":7751},"            )\n",{"type":25,"tag":26,"props":7753,"children":7754},{},[7755,7757,7763,7765,7771,7773,7779,7781,7786],{"type":30,"value":7756},"If the directory ",{"type":25,"tag":130,"props":7758,"children":7760},{"className":7759},[],[7761],{"type":30,"value":7762},"./quasar/dist/pwa",{"type":30,"value":7764}," exists, CDK will upload the contents of that directory to the ",{"type":25,"tag":130,"props":7766,"children":7768},{"className":7767},[],[7769],{"type":30,"value":7770},"static_site_bucket",{"type":30,"value":7772}," and then invalidate the cache for ",{"type":25,"tag":130,"props":7774,"children":7776},{"className":7775},[],[7777],{"type":30,"value":7778},"self.cloudfront.distribution",{"type":30,"value":7780},", all in one shot. ",{"type":25,"tag":130,"props":7782,"children":7784},{"className":7783},[],[7785],{"type":30,"value":7762},{"type":30,"value":7787}," is the directory where assets from my frontend PWA are placed when compiled. GitLab CI passes these files between the jobs using artifacts:",{"type":25,"tag":693,"props":7789,"children":7791},{"code":7790,"language":4444,"meta":8,"className":4445,"style":8},"artifacts:\n  paths:\n    - quasar/dist/pwa\n",[7792],{"type":25,"tag":130,"props":7793,"children":7794},{"__ignoreMap":8},[7795,7807,7819],{"type":25,"tag":930,"props":7796,"children":7797},{"class":932,"line":933},[7798,7803],{"type":25,"tag":930,"props":7799,"children":7800},{"style":937},[7801],{"type":30,"value":7802},"artifacts",{"type":25,"tag":930,"props":7804,"children":7805},{"style":942},[7806],{"type":30,"value":945},{"type":25,"tag":930,"props":7808,"children":7809},{"class":932,"line":250},[7810,7815],{"type":25,"tag":930,"props":7811,"children":7812},{"style":937},[7813],{"type":30,"value":7814},"  paths",{"type":25,"tag":930,"props":7816,"children":7817},{"style":942},[7818],{"type":30,"value":945},{"type":25,"tag":930,"props":7820,"children":7821},{"class":932,"line":967},[7822,7826],{"type":25,"tag":930,"props":7823,"children":7824},{"style":942},[7825],{"type":30,"value":1004},{"type":25,"tag":930,"props":7827,"children":7828},{"style":961},[7829],{"type":30,"value":7830},"quasar/dist/pwa\n",{"type":25,"tag":26,"props":7832,"children":7833},{},[7834,7836,7841,7843,7849],{"type":30,"value":7835},"The job to build PWA assets can be set to only run when there are changes in the ",{"type":25,"tag":130,"props":7837,"children":7839},{"className":7838},[],[7840],{"type":30,"value":7457},{"type":30,"value":7842}," directory, so the ",{"type":25,"tag":130,"props":7844,"children":7846},{"className":7845},[],[7847],{"type":30,"value":7848},".quasar/dist/pwa",{"type":30,"value":7850}," directory will only exist if the job is executed. This helps speed up our CI/CD pipeline.",{"type":25,"tag":5297,"props":7852,"children":7854},{"id":7853},"ecr-assets",[7855],{"type":30,"value":7856},"ECR Assets",{"type":25,"tag":26,"props":7858,"children":7859},{},[7860,7862,7868,7870,7875],{"type":30,"value":7861},"I use ",{"type":25,"tag":130,"props":7863,"children":7865},{"className":7864},[],[7866],{"type":30,"value":7867},"cdk boostrap",{"type":30,"value":7869}," and CDK assets in a similar way for building and pushing my application container. In ",{"type":25,"tag":130,"props":7871,"children":7873},{"className":7872},[],[7874],{"type":30,"value":5977},{"type":30,"value":7876},", I define the following:",{"type":25,"tag":693,"props":7878,"children":7880},{"code":7879,"language":6157,"meta":8,"className":6158,"style":8},"        self.image = ecs.AssetImage(\n            \"./backend\", file=\"scripts/prod/Dockerfile\", target=\"production\",\n        )\n",[7881],{"type":25,"tag":130,"props":7882,"children":7883},{"__ignoreMap":8},[7884,7906,7954],{"type":25,"tag":930,"props":7885,"children":7886},{"class":932,"line":933},[7887,7892,7897,7901],{"type":25,"tag":930,"props":7888,"children":7889},{"style":7655},[7890],{"type":30,"value":7891},"        self",{"type":25,"tag":930,"props":7893,"children":7894},{"style":942},[7895],{"type":30,"value":7896},".image ",{"type":25,"tag":930,"props":7898,"children":7899},{"style":1059},[7900],{"type":30,"value":6285},{"type":25,"tag":930,"props":7902,"children":7903},{"style":942},[7904],{"type":30,"value":7905}," ecs.AssetImage(\n",{"type":25,"tag":930,"props":7907,"children":7908},{"class":932,"line":250},[7909,7914,7918,7923,7927,7932,7936,7941,7945,7950],{"type":25,"tag":930,"props":7910,"children":7911},{"style":961},[7912],{"type":30,"value":7913},"            \"./backend\"",{"type":25,"tag":930,"props":7915,"children":7916},{"style":942},[7917],{"type":30,"value":860},{"type":25,"tag":930,"props":7919,"children":7920},{"style":6679},[7921],{"type":30,"value":7922},"file",{"type":25,"tag":930,"props":7924,"children":7925},{"style":1059},[7926],{"type":30,"value":6285},{"type":25,"tag":930,"props":7928,"children":7929},{"style":961},[7930],{"type":30,"value":7931},"\"scripts/prod/Dockerfile\"",{"type":25,"tag":930,"props":7933,"children":7934},{"style":942},[7935],{"type":30,"value":860},{"type":25,"tag":930,"props":7937,"children":7938},{"style":6679},[7939],{"type":30,"value":7940},"target",{"type":25,"tag":930,"props":7942,"children":7943},{"style":1059},[7944],{"type":30,"value":6285},{"type":25,"tag":930,"props":7946,"children":7947},{"style":961},[7948],{"type":30,"value":7949},"\"production\"",{"type":25,"tag":930,"props":7951,"children":7952},{"style":942},[7953],{"type":30,"value":2926},{"type":25,"tag":930,"props":7955,"children":7956},{"class":932,"line":967},[7957],{"type":25,"tag":930,"props":7958,"children":7959},{"style":942},[7960],{"type":30,"value":7961},"        )\n",{"type":25,"tag":26,"props":7963,"children":7964},{},[7965,7967,7972,7974,7980,7981,7987,7988,7993,7995,8000],{"type":30,"value":7966},"This image is then referenced by multiple ",{"type":25,"tag":130,"props":7968,"children":7970},{"className":7969},[],[7971],{"type":30,"value":6991},{"type":30,"value":7973},"s that define Fargate services and tasks (",{"type":25,"tag":130,"props":7975,"children":7977},{"className":7976},[],[7978],{"type":30,"value":7979},"gunicorn",{"type":30,"value":860},{"type":25,"tag":130,"props":7982,"children":7984},{"className":7983},[],[7985],{"type":30,"value":7986},"daphne",{"type":30,"value":860},{"type":25,"tag":130,"props":7989,"children":7991},{"className":7990},[],[7992],{"type":30,"value":20},{"type":30,"value":7994}," workers, etc.) This keeps our CDK code DRY.. Don't Repeat Yourself! Similarly, we aren't rebuilding, pushing and pulling the backend container when there are no changes to the code in ",{"type":25,"tag":130,"props":7996,"children":7998},{"className":7997},[],[7999],{"type":30,"value":906},{"type":30,"value":8001}," directory.",{"type":25,"tag":26,"props":8003,"children":8004},{},[8005,8007,8013,8015,8020],{"type":30,"value":8006},"I'm not setting up an ECR image repository for my application, but I believe there is a way to do this. One question that I have about using ",{"type":25,"tag":130,"props":8008,"children":8010},{"className":8009},[],[8011],{"type":30,"value":8012},"ecs.AssetImage",{"type":30,"value":8014}," is about image lifecycle management. I know that you can implement rules about how many images you want to keep in an ECR image repository, but ",{"type":25,"tag":4897,"props":8016,"children":8017},{},[8018],{"type":30,"value":8019},"I'm not sure how this works with CDK Image Assets",{"type":30,"value":208},{"type":25,"tag":2370,"props":8022,"children":8024},{"id":8023},"quick-tour-of-applicationstack",[8025,8027],{"type":30,"value":8026},"Quick tour of ",{"type":25,"tag":130,"props":8028,"children":8030},{"className":8029},[],[8031],{"type":30,"value":5977},{"type":25,"tag":26,"props":8033,"children":8034},{},[8035,8037,8042],{"type":30,"value":8036},"Here's a very quick look at the structure of my CDK code, focusing on the ",{"type":25,"tag":130,"props":8038,"children":8040},{"className":8039},[],[8041],{"type":30,"value":5977},{"type":30,"value":8043},", the \"master stack\" or \"skeleton stack\" that contains.",{"type":25,"tag":5297,"props":8045,"children":8047},{"id":8046},"hosted_zone",[8048],{"type":25,"tag":130,"props":8049,"children":8051},{"className":8050},[],[8052],{"type":30,"value":8046},{"type":25,"tag":26,"props":8054,"children":8055},{},[8056,8058,8064,8065,8071],{"type":30,"value":8057},"We get the hosted zone using the ",{"type":25,"tag":130,"props":8059,"children":8061},{"className":8060},[],[8062],{"type":30,"value":8063},"DOMAIN_NAME",{"type":30,"value":868},{"type":25,"tag":130,"props":8066,"children":8068},{"className":8067},[],[8069],{"type":30,"value":8070},"HOSTED_ZONE_ID",{"type":30,"value":8072},". This is not a nested stack.",{"type":25,"tag":5297,"props":8074,"children":8076},{"id":8075},"site_certificate",[8077],{"type":25,"tag":130,"props":8078,"children":8080},{"className":8079},[],[8081],{"type":30,"value":8075},{"type":25,"tag":26,"props":8083,"children":8084},{},[8085,8087,8092],{"type":30,"value":8086},"The ACM Certificate that will be used for the given environment. This references the ",{"type":25,"tag":130,"props":8088,"children":8090},{"className":8089},[],[8091],{"type":30,"value":6050},{"type":30,"value":8093}," (environment + application).",{"type":25,"tag":5297,"props":8095,"children":8097},{"id":8096},"vpc_stack",[8098],{"type":25,"tag":130,"props":8099,"children":8101},{"className":8100},[],[8102],{"type":30,"value":8096},{"type":25,"tag":26,"props":8104,"children":8105},{},[8106,8108,8113,8115,8121,8123,8129,8130,8136,8138,8143],{"type":30,"value":8107},"A ",{"type":25,"tag":130,"props":8109,"children":8111},{"className":8110},[],[8112],{"type":30,"value":6991},{"type":30,"value":8114}," for defining VPC resources. This construct generates lots of CloudFormation resources. I currently have ",{"type":25,"tag":130,"props":8116,"children":8118},{"className":8117},[],[8119],{"type":30,"value":8120},"nat_gateways",{"type":30,"value":8122}," set to zero, and I'm ",{"type":25,"tag":130,"props":8124,"children":8126},{"className":8125},[],[8127],{"type":30,"value":8128},"PUBLIC",{"type":30,"value":868},{"type":25,"tag":130,"props":8131,"children":8133},{"className":8132},[],[8134],{"type":30,"value":8135},"PRIVATE",{"type":30,"value":8137}," subnets spread over 2 AZs. As I mentioned earlier, this is primarily for cost considerations and it is a best practice to use the tiered security model and run our Fargate tasks in private subnets instead of public subnets. I think I need to add NACL resources in this ",{"type":25,"tag":130,"props":8139,"children":8141},{"className":8140},[],[8142],{"type":30,"value":6991},{"type":30,"value":208},{"type":25,"tag":5297,"props":8145,"children":8147},{"id":8146},"alb_stack",[8148],{"type":25,"tag":130,"props":8149,"children":8151},{"className":8150},[],[8152],{"type":30,"value":8146},{"type":25,"tag":26,"props":8154,"children":8155},{},[8156,8158,8164,8165,8171,8173,8178,8180,8185],{"type":30,"value":8157},"This defines the load balancer, configures that will send traffic to our Fargate services (such as our Django API). I was a little bit unclear about needing a ",{"type":25,"tag":130,"props":8159,"children":8161},{"className":8160},[],[8162],{"type":30,"value":8163},"listener",{"type":30,"value":868},{"type":25,"tag":130,"props":8166,"children":8168},{"className":8167},[],[8169],{"type":30,"value":8170},"https_listener",{"type":30,"value":8172},". I might be able to get away with removing the ",{"type":25,"tag":130,"props":8174,"children":8176},{"className":8175},[],[8177],{"type":30,"value":8163},{"type":30,"value":8179}," and only using ",{"type":25,"tag":130,"props":8181,"children":8183},{"className":8182},[],[8184],{"type":30,"value":8170},{"type":30,"value":208},{"type":25,"tag":5297,"props":8187,"children":8189},{"id":8188},"static_site_stack",[8190],{"type":25,"tag":130,"props":8191,"children":8193},{"className":8192},[],[8194],{"type":30,"value":8188},{"type":25,"tag":26,"props":8196,"children":8197},{},[8198],{"type":30,"value":8199},"This stack defines the S3 bucket and policies that will be used for hosting our static site (Quasar PWA).",{"type":25,"tag":5297,"props":8201,"children":8203},{"id":8202},"backend_assets",[8204],{"type":25,"tag":130,"props":8205,"children":8207},{"className":8206},[],[8208],{"type":30,"value":8202},{"type":25,"tag":26,"props":8210,"children":8211},{},[8212],{"type":30,"value":8213},"This stack defines the bucket and policies for managing the bucket that holds static and media assets for Django.",{"type":25,"tag":5297,"props":8215,"children":8217},{"id":8216},"cloudfront",[8218],{"type":25,"tag":130,"props":8219,"children":8221},{"className":8220},[],[8222],{"type":30,"value":8216},{"type":25,"tag":26,"props":8224,"children":8225},{},[8226,8228,8234],{"type":30,"value":8227},"This defines the CloudFront distribution that ties together several different parts of the application. It is the \"front desk\" of the application, and acts as a CDN and proxy. There is a separate CloudFront distribution for each environment (dev, staging, production). This stack also defines the Route53 ",{"type":25,"tag":130,"props":8229,"children":8231},{"className":8230},[],[8232],{"type":30,"value":8233},"ARecord",{"type":30,"value":8235}," that will be used to send traffic to a specific subdomain to the correct CloudFront distribution.",{"type":25,"tag":26,"props":8237,"children":8238},{},[8239,8241,8247],{"type":30,"value":8240},"There are three ",{"type":25,"tag":130,"props":8242,"children":8244},{"className":8243},[],[8245],{"type":30,"value":8246},"origin_configs",{"type":30,"value":8248}," for each distribution:",{"type":25,"tag":1139,"props":8250,"children":8251},{},[8252,8263,8273],{"type":25,"tag":37,"props":8253,"children":8254},{},[8255,8261],{"type":25,"tag":130,"props":8256,"children":8258},{"className":8257},[],[8259],{"type":30,"value":8260},"CustomOriginConfig",{"type":30,"value":8262}," for the ALB",{"type":25,"tag":37,"props":8264,"children":8265},{},[8266,8271],{"type":25,"tag":130,"props":8267,"children":8269},{"className":8268},[],[8270],{"type":30,"value":8260},{"type":30,"value":8272}," for the S3 bucket website",{"type":25,"tag":37,"props":8274,"children":8275},{},[8276,8282],{"type":25,"tag":130,"props":8277,"children":8279},{"className":8278},[],[8280],{"type":30,"value":8281},"S3OriginConfig",{"type":30,"value":8283}," for the Django static assets",{"type":25,"tag":26,"props":8285,"children":8286},{},[8287,8289,8294,8296,8302],{"type":30,"value":8288},"Note that these ",{"type":25,"tag":130,"props":8290,"children":8292},{"className":8291},[],[8293],{"type":30,"value":8246},{"type":30,"value":8295}," each have different ",{"type":25,"tag":130,"props":8297,"children":8299},{"className":8298},[],[8300],{"type":30,"value":8301},"behaviors",{"type":30,"value":8303},", and that list comprehension is used to keep this code DRY.",{"type":25,"tag":5297,"props":8305,"children":8307},{"id":8306},"bucketdeployment",[8308],{"type":25,"tag":130,"props":8309,"children":8311},{"className":8310},[],[8312],{"type":30,"value":8313},"BucketDeployment",{"type":25,"tag":26,"props":8315,"children":8316},{},[8317,8319,8324],{"type":30,"value":8318},"This will deploy our static site assets to the S3 bucket defined in ",{"type":25,"tag":130,"props":8320,"children":8322},{"className":8321},[],[8323],{"type":30,"value":8188},{"type":30,"value":8325}," if the static site assets are present at the time of deployment. If they are not present, this means that there were no changes made to the frontend site.",{"type":25,"tag":5297,"props":8327,"children":8329},{"id":8328},"ecs",[8330],{"type":25,"tag":130,"props":8331,"children":8333},{"className":8332},[],[8334],{"type":30,"value":8328},{"type":25,"tag":26,"props":8336,"children":8337},{},[8338],{"type":30,"value":8339},"Defines the ECS Cluster.",{"type":25,"tag":5297,"props":8341,"children":8343},{"id":8342},"rds",[8344],{"type":25,"tag":130,"props":8345,"children":8347},{"className":8346},[],[8348],{"type":30,"value":8342},{"type":25,"tag":26,"props":8350,"children":8351},{},[8352,8354,8360,8362,8367,8369,8375,8377,8383,8384,8390],{"type":30,"value":8353},"There is no L2 construct for ",{"type":25,"tag":130,"props":8355,"children":8357},{"className":8356},[],[8358],{"type":30,"value":8359},"DBCluster",{"type":30,"value":8361},", so I used ",{"type":25,"tag":130,"props":8363,"children":8365},{"className":8364},[],[8366],{"type":30,"value":6958},{"type":30,"value":8368}," in order to use the Aurora Postgres ",{"type":25,"tag":130,"props":8370,"children":8372},{"className":8371},[],[8373],{"type":30,"value":8374},"engine",{"type":30,"value":8376}," and the ",{"type":25,"tag":130,"props":8378,"children":8380},{"className":8379},[],[8381],{"type":30,"value":8382},"serverless",{"type":30,"value":1327},{"type":25,"tag":130,"props":8385,"children":8387},{"className":8386},[],[8388],{"type":30,"value":8389},"engine_mode",{"type":30,"value":208},{"type":25,"tag":5297,"props":8392,"children":8394},{"id":8393},"elasticache",[8395],{"type":25,"tag":130,"props":8396,"children":8398},{"className":8397},[],[8399],{"type":30,"value":8393},{"type":25,"tag":26,"props":8401,"children":8402},{},[8403],{"type":30,"value":8404},"I also had to use L1 constructs for ElastiCache, but this one is pretty straightforward.",{"type":25,"tag":26,"props":8406,"children":8407},{},[8408,8410,8416,8418,8424],{"type":30,"value":8409},"For both RDS and ElastiCache I used the ",{"type":25,"tag":130,"props":8411,"children":8413},{"className":8412},[],[8414],{"type":30,"value":8415},"vpc_default_security_group",{"type":30,"value":8417}," as the ",{"type":25,"tag":130,"props":8419,"children":8421},{"className":8420},[],[8422],{"type":30,"value":8423},"source_security_group",{"type":30,"value":8425},". It might be a better idea to define another security group altogether, but this approach works.",{"type":25,"tag":5297,"props":8427,"children":8429},{"id":8428},"assetimage",[8430],{"type":25,"tag":130,"props":8431,"children":8433},{"className":8432},[],[8434],{"type":30,"value":8435},"AssetImage",{"type":25,"tag":26,"props":8437,"children":8438},{},[8439,8441,8446],{"type":30,"value":8440},"The docker image that references Django application code in the ",{"type":25,"tag":130,"props":8442,"children":8444},{"className":8443},[],[8445],{"type":30,"value":906},{"type":30,"value":8447}," directory. This image is referenced in Fargate services and tasks.",{"type":25,"tag":5297,"props":8449,"children":8451},{"id":8450},"variables",[8452],{"type":25,"tag":130,"props":8453,"children":8455},{"className":8454},[],[8456],{"type":30,"value":8450},{"type":25,"tag":26,"props":8458,"children":8459},{},[8460],{"type":30,"value":8461},"This section defines and organizes all of the environment variables and secrets for my application.",{"type":25,"tag":5297,"props":8463,"children":8465},{"id":8464},"backend_service",[8466],{"type":25,"tag":130,"props":8467,"children":8469},{"className":8468},[],[8470],{"type":30,"value":8464},{"type":25,"tag":26,"props":8472,"children":8473},{},[8474,8476,8482],{"type":30,"value":8475},"It might be a better idea to replace this with ",{"type":25,"tag":130,"props":8477,"children":8479},{"className":8478},[],[8480],{"type":30,"value":8481},"NetworkLoadBalancedFargateService",{"type":30,"value":8483},", but instead I implemented this with lower-level constructs just to be clear about what I'm doing. To add a load balanced service, here is what I did:",{"type":25,"tag":1139,"props":8485,"children":8486},{},[8487,8492,8505,8518,8523,8528,8546],{"type":25,"tag":37,"props":8488,"children":8489},{},[8490],{"type":30,"value":8491},"Define the Fargate task",{"type":25,"tag":37,"props":8493,"children":8494},{},[8495,8497,8503],{"type":30,"value":8496},"Add the container to this task with other information (secrets, logging, ",{"type":25,"tag":130,"props":8498,"children":8500},{"className":8499},[],[8501],{"type":30,"value":8502},"command",{"type":30,"value":8504},", etc.)",{"type":25,"tag":37,"props":8506,"children":8507},{},[8508,8510,8516],{"type":30,"value":8509},"Give the task role permissions it needs such as access to Secrets, S3 permissions. (It might be a good idea to refactor this into a function that can be called on ",{"type":25,"tag":130,"props":8511,"children":8513},{"className":8512},[],[8514],{"type":30,"value":8515},"task_role",{"type":30,"value":8517},", but for now I am explicitly granting all permissions)",{"type":25,"tag":37,"props":8519,"children":8520},{},[8521],{"type":30,"value":8522},"Create and add a port mapping",{"type":25,"tag":37,"props":8524,"children":8525},{},[8526],{"type":30,"value":8527},"Define an ECS Fargate Service that reference the previously defined Fargate task, configure security group",{"type":25,"tag":37,"props":8529,"children":8530},{},[8531,8533,8538,8540,8545],{"type":30,"value":8532},"Add the service as a target to the ",{"type":25,"tag":130,"props":8534,"children":8536},{"className":8535},[],[8537],{"type":30,"value":8170},{"type":30,"value":8539}," defined previously in ",{"type":25,"tag":130,"props":8541,"children":8543},{"className":8542},[],[8544],{"type":30,"value":8146},{"type":30,"value":208},{"type":25,"tag":37,"props":8547,"children":8548},{},[8549],{"type":30,"value":8550},"Optionally configure autoscaling for the Fargate service",{"type":25,"tag":5297,"props":8552,"children":8554},{"id":8553},"flower_service",[8555],{"type":25,"tag":130,"props":8556,"children":8558},{"className":8557},[],[8559],{"type":30,"value":8553},{"type":25,"tag":26,"props":8561,"children":8562},{},[8563,8565],{"type":30,"value":8564},"Flower is a monitoring utility for Celery. I had trouble getting this to work correctly, but I managed to make it work by adding a simple nginx container that passes traffic to the flower container running in the same task. ",{"type":25,"tag":41,"props":8566,"children":8569},{"href":8567,"rel":8568},"https://flower.readthedocs.io/en/latest/reverse-proxy.html",[45],[8570],{"type":30,"value":8567},{"type":25,"tag":5297,"props":8572,"children":8574},{"id":8573},"celery_default_service",[8575],{"type":25,"tag":130,"props":8576,"children":8578},{"className":8577},[],[8579],{"type":30,"value":8573},{"type":25,"tag":26,"props":8581,"children":8582},{},[8583],{"type":30,"value":8584},"This stack defines the default celery queue. This is discussed later in more detail, but the basic idea is to:",{"type":25,"tag":1139,"props":8586,"children":8587},{},[8588,8592,8597,8602,8607],{"type":25,"tag":37,"props":8589,"children":8590},{},[8591],{"type":30,"value":8491},{"type":25,"tag":37,"props":8593,"children":8594},{},[8595],{"type":30,"value":8596},"Add the container",{"type":25,"tag":37,"props":8598,"children":8599},{},[8600],{"type":30,"value":8601},"Define the Fargate service",{"type":25,"tag":37,"props":8603,"children":8604},{},[8605],{"type":30,"value":8606},"Grant permissions",{"type":25,"tag":37,"props":8608,"children":8609},{},[8610],{"type":30,"value":8611},"Configure autoscaling",{"type":25,"tag":5297,"props":8613,"children":8615},{"id":8614},"celery_autoscaling",[8616],{"type":25,"tag":130,"props":8617,"children":8619},{"className":8618},[],[8620],{"type":30,"value":8614},{"type":25,"tag":26,"props":8622,"children":8623},{},[8624],{"type":30,"value":8625},"This stack defines the Lambda function and schedule on which this Lambda is called. This stack is discussed in more detail later on.",{"type":25,"tag":5297,"props":8627,"children":8629},{"id":8628},"backend_tasks",[8630],{"type":25,"tag":130,"props":8631,"children":8633},{"className":8632},[],[8634],{"type":30,"value":8628},{"type":25,"tag":26,"props":8636,"children":8637},{},[8638,8640,8645,8646,8651,8652,8657],{"type":30,"value":8639},"These are administrative tasks that are executed by running manual GitLab CI jobs such as ",{"type":25,"tag":130,"props":8641,"children":8643},{"className":8642},[],[8644],{"type":30,"value":4685},{"type":30,"value":860},{"type":25,"tag":130,"props":8647,"children":8649},{"className":8648},[],[8650],{"type":30,"value":2713},{"type":30,"value":868},{"type":25,"tag":130,"props":8653,"children":8655},{"className":8654},[],[8656],{"type":30,"value":4690},{"type":30,"value":208},{"type":25,"tag":339,"props":8659,"children":8661},{"id":8660},"why-x-why-not-y",[8662,8664,8670,8672,8678],{"type":30,"value":8663},"Why ",{"type":25,"tag":130,"props":8665,"children":8667},{"className":8666},[],[8668],{"type":30,"value":8669},"X",{"type":30,"value":8671},"? Why not ",{"type":25,"tag":130,"props":8673,"children":8675},{"className":8674},[],[8676],{"type":30,"value":8677},"Y",{"type":30,"value":8679},"?",{"type":25,"tag":26,"props":8681,"children":8682},{},[8683],{"type":30,"value":8684},"This section will compare some of the technology choices I have made in this project to other popular alternatives.",{"type":25,"tag":2370,"props":8686,"children":8688},{"id":8687},"why-ecs-why-not-kubernetes",[8689],{"type":30,"value":8690},"Why ECS? Why not Kubernetes?",{"type":25,"tag":26,"props":8692,"children":8693},{},[8694,8696,8702],{"type":30,"value":8695},"I like Kubernetes. I have never used it to support production workloads, but I have explored it in a limited capacity. I have set up this project in Kubernetes locally using ",{"type":25,"tag":130,"props":8697,"children":8699},{"className":8698},[],[8700],{"type":30,"value":8701},"minikube",{"type":30,"value":8703},", there is an article on this in the documentation. There are also lots of options for how you do Kubernetes, here are a few off of the top of my head:",{"type":25,"tag":33,"props":8705,"children":8706},{},[8707,8712,8717,8722,8727,8732],{"type":25,"tag":37,"props":8708,"children":8709},{},[8710],{"type":30,"value":8711},"KOPS",{"type":25,"tag":37,"props":8713,"children":8714},{},[8715],{"type":30,"value":8716},"EKS",{"type":25,"tag":37,"props":8718,"children":8719},{},[8720],{"type":30,"value":8721},"k3s",{"type":25,"tag":37,"props":8723,"children":8724},{},[8725],{"type":30,"value":8726},"cdk8s",{"type":25,"tag":37,"props":8728,"children":8729},{},[8730],{"type":30,"value":8731},"Kubernetes on Fargate",{"type":25,"tag":37,"props":8733,"children":8734},{},[8735],{"type":30,"value":8736},"\"Kuberetes the Hard Way\"",{"type":25,"tag":26,"props":8738,"children":8739},{},[8740],{"type":30,"value":8741},"With any of these options you are probably going to want to use Helm to do deployments, which adds another layer of abstraction that also has several different ways to be managed. On the other hand, ECS is \"just ECS\"; there are not a lot of other considerations to make when running workloads in ECS. You have to choose between the two available launch types: EC2 and Fargate. Comparisons of ECS and Kubernetes often mention that ECS integrates nicely with other AWS Services, something I have generally found to be true in setting up this project. Granting permissions to S3 buckets or CloudWatch, or using security groups to give ECS tasks access to certain resources in your VPC are some examples of what this \"tight integration\" has meant for me so far.",{"type":25,"tag":2370,"props":8743,"children":8745},{"id":8744},"why-django-why-not-flask",[8746],{"type":30,"value":8747},"Why Django? Why not Flask?",{"type":25,"tag":26,"props":8749,"children":8750},{},[8751],{"type":30,"value":8752},"I like Django for lots of reasons. I get why people say it can be \"overkill\", and there are definitely lots of parts of Django that don't use. I use Django primarily for the ORM, migrations system and the Django Admin. I also use the Django REST Framework, which gives me another big productivity boost when building APIs. I dislike Django Forms and Django templates, but that wasn't always the case. Before that, I disliked JavaScript frameworks and single page applications. That changes when I started working with Vue.js and Quasar.",{"type":25,"tag":2370,"props":8754,"children":8756},{"id":8755},"why-quasar-framework-why-not-nuxtjs-or-vanilla-vuejs-why-not-react",[8757],{"type":30,"value":8758},"Why Quasar Framework? Why not Nuxt.js or vanilla Vue.js? Why not React?",{"type":25,"tag":26,"props":8760,"children":8761},{},[8762],{"type":30,"value":8763},"Quasar Framework is a few different things, and just like Vue.js itself, Quasar can be incrementally adopted. Primarily, Quasar is a CLI for creating Vue.js projects. It offers some opinions on how to organize files and folders. It handles SPA, PWA, SSR, Electron, Cordova and other build targets. It implements the MaterialUI spec and it has an awesome and active community (but Django, GitLab and AWS do, too!)",{"type":25,"tag":26,"props":8765,"children":8766},{},[8767,8769,8775,8777,8782],{"type":30,"value":8768},"Quasar does things a little bit differently than vanilla Vue.js. There is no ",{"type":25,"tag":130,"props":8770,"children":8772},{"className":8771},[],[8773],{"type":30,"value":8774},"main.js",{"type":30,"value":8776}," file in a typical Quasar application. Instead, bootfiles are used to initialize things that would typically go into ",{"type":25,"tag":130,"props":8778,"children":8780},{"className":8779},[],[8781],{"type":30,"value":8774},{"type":30,"value":8783},". I believe this helps Quasar manage multiple build targets easily.",{"type":25,"tag":26,"props":8785,"children":8786},{},[8787],{"type":30,"value":8788},"I really haven't worked a lot with Nuxt.js, but I would probably be drawn to it if Quasar was not an option. I like how it helps structure your application. In the same way that Django is \"batteries included\", Quasar is also very much \"batteries included\".",{"type":25,"tag":26,"props":8790,"children":8791},{},[8792,8794,8799,8800,8806],{"type":30,"value":8793},"I think React is neat, but I have similar feelings between React and Vue that I have between Django and Flask. One requires you make more decisions and therefore has a heavy mental load. The biggest example of this is the tight integration of an official router and state management system for Vue (",{"type":25,"tag":130,"props":8795,"children":8797},{"className":8796},[],[8798],{"type":30,"value":5483},{"type":30,"value":868},{"type":25,"tag":130,"props":8801,"children":8803},{"className":8802},[],[8804],{"type":30,"value":8805},"vuex",{"type":30,"value":8807},").",{"type":25,"tag":2370,"props":8809,"children":8811},{"id":8810},"why-celery-why-not-heuy-or-django-rq",[8812],{"type":30,"value":8813},"Why Celery? Why not Heuy or django-rq?",{"type":25,"tag":26,"props":8815,"children":8816},{},[8817],{"type":30,"value":8818},"I think celery is probably the most heavy-weight option for managing asynchronous tasks in Django. It is very flexible and \"pluggable\" which makes it slightly more challenging to get setup. I would be interested in trying another option, but celery is a mature option that has a large community of users.",{"type":25,"tag":339,"props":8820,"children":8822},{"id":8821},"scaling-celery-workers-to-zero",[8823],{"type":30,"value":8824},"Scaling Celery workers to zero",{"type":25,"tag":26,"props":8826,"children":8827},{},[8828],{"type":30,"value":8829},"Django is used in a few different ways in this application:",{"type":25,"tag":33,"props":8831,"children":8832},{},[8833,8838,8843,8848],{"type":25,"tag":37,"props":8834,"children":8835},{},[8836],{"type":30,"value":8837},"a backend API supported by Django REST Framework, Postgres and static files stored in AWS S3, served over CloudFront",{"type":25,"tag":37,"props":8839,"children":8840},{},[8841],{"type":30,"value":8842},"a websocket server supported by Django Channels",{"type":25,"tag":37,"props":8844,"children":8845},{},[8846],{"type":30,"value":8847},"an administrative backend that is automatically generated by Django (Django Admin)",{"type":25,"tag":37,"props":8849,"children":8850},{},[8851],{"type":30,"value":8852},"asynchronous task workers supported by Celery",{"type":25,"tag":26,"props":8854,"children":8855},{},[8856,8858,8863,8865,8871,8872,8878,8879,8885],{"type":30,"value":8857},"The API server, websocket server and Django admin can technically be served by the same ",{"type":25,"tag":130,"props":8859,"children":8861},{"className":8860},[],[8862],{"type":30,"value":7986},{"type":30,"value":8864}," process. In terms of our application and AWS architecture, this means that requests for URLs starting with ",{"type":25,"tag":130,"props":8866,"children":8868},{"className":8867},[],[8869],{"type":30,"value":8870},"/api/",{"type":30,"value":860},{"type":25,"tag":130,"props":8873,"children":8875},{"className":8874},[],[8876],{"type":30,"value":8877},"/ws/",{"type":30,"value":868},{"type":25,"tag":130,"props":8880,"children":8882},{"className":8881},[],[8883],{"type":30,"value":8884},"/admin/",{"type":30,"value":8886}," can all be sent to the same Fargate service target group.",{"type":25,"tag":26,"props":8888,"children":8889},{},[8890],{"type":30,"value":8891},"Alternatively, we could split these up into two or three different process that can then be scaled individually.",{"type":25,"tag":26,"props":8893,"children":8894},{},[8895,8897,8903],{"type":30,"value":8896},"Celery processes should be run as separate processes. If you have multiple queues, you may have workers that are dedicated to processing tasks from certain queues which run as individual Fargate tasks, each with certain CPU and memory allocations and other celery settings, such as ",{"type":25,"tag":130,"props":8898,"children":8900},{"className":8899},[],[8901],{"type":30,"value":8902},"max_concurrency",{"type":30,"value":208},{"type":25,"tag":26,"props":8905,"children":8906},{},[8907,8909,8915],{"type":30,"value":8908},"To manage the total cost of ownership, I wanted to know how to scale Celery workers between 0 and ",{"type":25,"tag":130,"props":8910,"children":8912},{"className":8911},[],[8913],{"type":30,"value":8914},"N",{"type":30,"value":8916},". A celery worker is typically an \"always on\" process that watches for new messages that arrive in the queue and then processes message specified (the messages delivered to the queue contain information on which function to call, and what arguments that function should be called with.",{"type":25,"tag":26,"props":8918,"children":8919},{},[8920],{"type":30,"value":8921},"Let's image that we have a celery task to process with the following properties:",{"type":25,"tag":33,"props":8923,"children":8924},{},[8925,8930,8935,8940,8945,8950,8955],{"type":25,"tag":37,"props":8926,"children":8927},{},[8928],{"type":30,"value":8929},"It takes a long time to process (between 15 minutes and 1 or 2 hours)",{"type":25,"tag":37,"props":8931,"children":8932},{},[8933],{"type":30,"value":8934},"It has lots of dependencies (such as pandas, scikit-learn, etc.)",{"type":25,"tag":37,"props":8936,"children":8937},{},[8938],{"type":30,"value":8939},"It requires a high amount of CPU and memory",{"type":25,"tag":37,"props":8941,"children":8942},{},[8943],{"type":30,"value":8944},"It cannot easily be broken down into smaller sub-tasks",{"type":25,"tag":37,"props":8946,"children":8947},{},[8948],{"type":30,"value":8949},"The time and frequency at which this task will be called is not predictable",{"type":25,"tag":37,"props":8951,"children":8952},{},[8953],{"type":30,"value":8954},"A 2 - 3 minute delay between calling the task and starting work on the task is acceptable",{"type":25,"tag":37,"props":8956,"children":8957},{},[8958],{"type":30,"value":8959},"This task might not be very easy to process with AWS Lambda without lots of additional logic, if not impossible.",{"type":25,"tag":26,"props":8961,"children":8962},{},[8963],{"type":30,"value":8964},"To manage our project's TCO, we want scale down the number of Fargate tasks that process the queue this task is sent to. If there are no messages queued for this worker and no messages currently being processed by any of the workers for the queue, the number of Fargate tasks (celery workers) should be scaled down.",{"type":25,"tag":26,"props":8966,"children":8967},{},[8968],{"type":30,"value":8969},"I haven't done much with autoscaling on AWS before, but I found that CDK provides some very nice abstractions that make scaling with Fargate task very straightforward.",{"type":25,"tag":26,"props":8971,"children":8972},{},[8973,8975,8980],{"type":30,"value":8974},"ECS allows you to scale based on some built in metrics, such as CPU Utilization. Scaling between 0 and ",{"type":25,"tag":130,"props":8976,"children":8978},{"className":8977},[],[8979],{"type":30,"value":8914},{"type":30,"value":8981}," workers based on CPU utilization metrics wouldn't work because there would be no CPU utilization after the Fargate tasks are scaled to zero; messages in the queue would remain unprocessed and no new workers would be brought online.",{"type":25,"tag":26,"props":8983,"children":8984},{},[8985],{"type":30,"value":8986},"Using the number of tasks in the queue would be a better option. I tried a few different options to get this to work.",{"type":25,"tag":26,"props":8988,"children":8989},{},[8990,8992,8998,9000,9006],{"type":30,"value":8991},"First, I tried using one of the high-level constructs (L3 construct) from ",{"type":25,"tag":130,"props":8993,"children":8995},{"className":8994},[],[8996],{"type":30,"value":8997},"ecs_patterns",{"type":30,"value":8999}," called ",{"type":25,"tag":130,"props":9001,"children":9003},{"className":9002},[],[9004],{"type":30,"value":9005},"QueueProcessingFargateService",{"type":30,"value":9007},", but this would require that I replace Redis with SQS as the broker to be used with Celery. Some people prefer to use SQS, but I like having the ability to inspect and control, which requires a broker like Redis and is not possible with SQS.",{"type":25,"tag":26,"props":9009,"children":9010},{},[9011],{"type":30,"value":9012},"My current solution involves:",{"type":25,"tag":1139,"props":9014,"children":9015},{},[9016,9036,9049,9066,9086],{"type":25,"tag":37,"props":9017,"children":9018},{},[9019,9021,9027,9029,9035],{"type":30,"value":9020},"Creating a CloudWatch metric (the namespace is ",{"type":25,"tag":130,"props":9022,"children":9024},{"className":9023},[],[9025],{"type":30,"value":9026},"FULL_APP_NAME",{"type":30,"value":9028}," and the metric name is the name of the queue, ",{"type":25,"tag":130,"props":9030,"children":9032},{"className":9031},[],[9033],{"type":30,"value":9034},"default",{"type":30,"value":4022},{"type":25,"tag":37,"props":9037,"children":9038},{},[9039,9041,9047],{"type":30,"value":9040},"Calling ",{"type":25,"tag":130,"props":9042,"children":9044},{"className":9043},[],[9045],{"type":30,"value":9046},"auto_scale_task_count",{"type":30,"value":9048}," on the Fargate service to create a an \"autoscaling Fargate task\"",{"type":25,"tag":37,"props":9050,"children":9051},{},[9052,9053,9059,9061],{"type":30,"value":9040},{"type":25,"tag":130,"props":9054,"children":9056},{"className":9055},[],[9057],{"type":30,"value":9058},"scale_on_metric",{"type":30,"value":9060}," on the \"autoscaling Fargate task\" with the CloudWatch metric created in ",{"type":25,"tag":130,"props":9062,"children":9064},{"className":9063},[],[9065],{"type":30,"value":4962},{"type":25,"tag":37,"props":9067,"children":9068},{},[9069,9070,9076,9078,9084],{"type":30,"value":382},{"type":25,"tag":130,"props":9071,"children":9073},{"className":9072},[],[9074],{"type":30,"value":9075},"celery-metrics",{"type":30,"value":9077}," API endpoint on my Django API server that, when ",{"type":25,"tag":130,"props":9079,"children":9081},{"className":9080},[],[9082],{"type":30,"value":9083},"POST",{"type":30,"value":9085},"ed to, collects celery metrics per queue and publishes these metrics to CloudWatch.",{"type":25,"tag":37,"props":9087,"children":9088},{},[9089,9091,9096],{"type":30,"value":9090},"Scheduling a Lambda function to post to the ",{"type":25,"tag":130,"props":9092,"children":9094},{"className":9093},[],[9095],{"type":30,"value":9075},{"type":30,"value":9097}," endpoint every 5 minutes.",{"type":25,"tag":26,"props":9099,"children":9100},{},[9101],{"type":30,"value":9102},"Here's the code that takes care of steps 1, 2 and 3:",{"type":25,"tag":693,"props":9104,"children":9106},{"code":9105,"language":6157,"meta":8,"className":6158,"style":8},"        self.default_celery_queue_cw_metric = cw.Metric(\n            namespace=scope.full_app_name, metric_name=\"default\"\n        )\n\n        self.celery_default_queue_asg = self.celery_default_worker_service.auto_scale_task_count(\n            min_capacity=0, max_capacity=2\n        )\n\n        self.celery_default_queue_asg.scale_on_metric(\n            \"CeleryDefaultQueueAutoscaling\",\n            metric=self.default_celery_queue_cw_metric,\n            scaling_steps=[\n                aas.ScalingInterval(change=-1, lower=0),\n                aas.ScalingInterval(change=1, lower=1),\n            ],\n            adjustment_type=aas.AdjustmentType.CHANGE_IN_CAPACITY,\n        )\n",[9107],{"type":25,"tag":130,"props":9108,"children":9109},{"__ignoreMap":8},[9110,9131,9162,9169,9176,9202,9236,9243,9250,9262,9274,9295,9312,9355,9394,9402,9428],{"type":25,"tag":930,"props":9111,"children":9112},{"class":932,"line":933},[9113,9117,9122,9126],{"type":25,"tag":930,"props":9114,"children":9115},{"style":7655},[9116],{"type":30,"value":7891},{"type":25,"tag":930,"props":9118,"children":9119},{"style":942},[9120],{"type":30,"value":9121},".default_celery_queue_cw_metric ",{"type":25,"tag":930,"props":9123,"children":9124},{"style":1059},[9125],{"type":30,"value":6285},{"type":25,"tag":930,"props":9127,"children":9128},{"style":942},[9129],{"type":30,"value":9130}," cw.Metric(\n",{"type":25,"tag":930,"props":9132,"children":9133},{"class":932,"line":250},[9134,9139,9143,9148,9153,9157],{"type":25,"tag":930,"props":9135,"children":9136},{"style":6679},[9137],{"type":30,"value":9138},"            namespace",{"type":25,"tag":930,"props":9140,"children":9141},{"style":1059},[9142],{"type":30,"value":6285},{"type":25,"tag":930,"props":9144,"children":9145},{"style":942},[9146],{"type":30,"value":9147},"scope.full_app_name, ",{"type":25,"tag":930,"props":9149,"children":9150},{"style":6679},[9151],{"type":30,"value":9152},"metric_name",{"type":25,"tag":930,"props":9154,"children":9155},{"style":1059},[9156],{"type":30,"value":6285},{"type":25,"tag":930,"props":9158,"children":9159},{"style":961},[9160],{"type":30,"value":9161},"\"default\"\n",{"type":25,"tag":930,"props":9163,"children":9164},{"class":932,"line":967},[9165],{"type":25,"tag":930,"props":9166,"children":9167},{"style":942},[9168],{"type":30,"value":7961},{"type":25,"tag":930,"props":9170,"children":9171},{"class":932,"line":985},[9172],{"type":25,"tag":930,"props":9173,"children":9174},{"emptyLinePlaceholder":265},[9175],{"type":30,"value":3733},{"type":25,"tag":930,"props":9177,"children":9178},{"class":932,"line":998},[9179,9183,9188,9192,9197],{"type":25,"tag":930,"props":9180,"children":9181},{"style":7655},[9182],{"type":30,"value":7891},{"type":25,"tag":930,"props":9184,"children":9185},{"style":942},[9186],{"type":30,"value":9187},".celery_default_queue_asg ",{"type":25,"tag":930,"props":9189,"children":9190},{"style":1059},[9191],{"type":30,"value":6285},{"type":25,"tag":930,"props":9193,"children":9194},{"style":7655},[9195],{"type":30,"value":9196}," self",{"type":25,"tag":930,"props":9198,"children":9199},{"style":942},[9200],{"type":30,"value":9201},".celery_default_worker_service.auto_scale_task_count(\n",{"type":25,"tag":930,"props":9203,"children":9204},{"class":932,"line":1012},[9205,9210,9214,9218,9222,9227,9231],{"type":25,"tag":930,"props":9206,"children":9207},{"style":6679},[9208],{"type":30,"value":9209},"            min_capacity",{"type":25,"tag":930,"props":9211,"children":9212},{"style":1059},[9213],{"type":30,"value":6285},{"type":25,"tag":930,"props":9215,"children":9216},{"style":2676},[9217],{"type":30,"value":652},{"type":25,"tag":930,"props":9219,"children":9220},{"style":942},[9221],{"type":30,"value":860},{"type":25,"tag":930,"props":9223,"children":9224},{"style":6679},[9225],{"type":30,"value":9226},"max_capacity",{"type":25,"tag":930,"props":9228,"children":9229},{"style":1059},[9230],{"type":30,"value":6285},{"type":25,"tag":930,"props":9232,"children":9233},{"style":2676},[9234],{"type":30,"value":9235},"2\n",{"type":25,"tag":930,"props":9237,"children":9238},{"class":932,"line":1025},[9239],{"type":25,"tag":930,"props":9240,"children":9241},{"style":942},[9242],{"type":30,"value":7961},{"type":25,"tag":930,"props":9244,"children":9245},{"class":932,"line":1038},[9246],{"type":25,"tag":930,"props":9247,"children":9248},{"emptyLinePlaceholder":265},[9249],{"type":30,"value":3733},{"type":25,"tag":930,"props":9251,"children":9252},{"class":932,"line":1051},[9253,9257],{"type":25,"tag":930,"props":9254,"children":9255},{"style":7655},[9256],{"type":30,"value":7891},{"type":25,"tag":930,"props":9258,"children":9259},{"style":942},[9260],{"type":30,"value":9261},".celery_default_queue_asg.scale_on_metric(\n",{"type":25,"tag":930,"props":9263,"children":9264},{"class":932,"line":1065},[9265,9270],{"type":25,"tag":930,"props":9266,"children":9267},{"style":961},[9268],{"type":30,"value":9269},"            \"CeleryDefaultQueueAutoscaling\"",{"type":25,"tag":930,"props":9271,"children":9272},{"style":942},[9273],{"type":30,"value":2926},{"type":25,"tag":930,"props":9275,"children":9276},{"class":932,"line":1074},[9277,9282,9286,9290],{"type":25,"tag":930,"props":9278,"children":9279},{"style":6679},[9280],{"type":30,"value":9281},"            metric",{"type":25,"tag":930,"props":9283,"children":9284},{"style":1059},[9285],{"type":30,"value":6285},{"type":25,"tag":930,"props":9287,"children":9288},{"style":7655},[9289],{"type":30,"value":7691},{"type":25,"tag":930,"props":9291,"children":9292},{"style":942},[9293],{"type":30,"value":9294},".default_celery_queue_cw_metric,\n",{"type":25,"tag":930,"props":9296,"children":9297},{"class":932,"line":1083},[9298,9303,9307],{"type":25,"tag":930,"props":9299,"children":9300},{"style":6679},[9301],{"type":30,"value":9302},"            scaling_steps",{"type":25,"tag":930,"props":9304,"children":9305},{"style":1059},[9306],{"type":30,"value":6285},{"type":25,"tag":930,"props":9308,"children":9309},{"style":942},[9310],{"type":30,"value":9311},"[\n",{"type":25,"tag":930,"props":9313,"children":9314},{"class":932,"line":1092},[9315,9320,9325,9330,9334,9338,9343,9347,9351],{"type":25,"tag":930,"props":9316,"children":9317},{"style":942},[9318],{"type":30,"value":9319},"                aas.ScalingInterval(",{"type":25,"tag":930,"props":9321,"children":9322},{"style":6679},[9323],{"type":30,"value":9324},"change",{"type":25,"tag":930,"props":9326,"children":9327},{"style":1059},[9328],{"type":30,"value":9329},"=-",{"type":25,"tag":930,"props":9331,"children":9332},{"style":2676},[9333],{"type":30,"value":4962},{"type":25,"tag":930,"props":9335,"children":9336},{"style":942},[9337],{"type":30,"value":860},{"type":25,"tag":930,"props":9339,"children":9340},{"style":6679},[9341],{"type":30,"value":9342},"lower",{"type":25,"tag":930,"props":9344,"children":9345},{"style":1059},[9346],{"type":30,"value":6285},{"type":25,"tag":930,"props":9348,"children":9349},{"style":2676},[9350],{"type":30,"value":652},{"type":25,"tag":930,"props":9352,"children":9353},{"style":942},[9354],{"type":30,"value":2958},{"type":25,"tag":930,"props":9356,"children":9357},{"class":932,"line":1101},[9358,9362,9366,9370,9374,9378,9382,9386,9390],{"type":25,"tag":930,"props":9359,"children":9360},{"style":942},[9361],{"type":30,"value":9319},{"type":25,"tag":930,"props":9363,"children":9364},{"style":6679},[9365],{"type":30,"value":9324},{"type":25,"tag":930,"props":9367,"children":9368},{"style":1059},[9369],{"type":30,"value":6285},{"type":25,"tag":930,"props":9371,"children":9372},{"style":2676},[9373],{"type":30,"value":4962},{"type":25,"tag":930,"props":9375,"children":9376},{"style":942},[9377],{"type":30,"value":860},{"type":25,"tag":930,"props":9379,"children":9380},{"style":6679},[9381],{"type":30,"value":9342},{"type":25,"tag":930,"props":9383,"children":9384},{"style":1059},[9385],{"type":30,"value":6285},{"type":25,"tag":930,"props":9387,"children":9388},{"style":2676},[9389],{"type":30,"value":4962},{"type":25,"tag":930,"props":9391,"children":9392},{"style":942},[9393],{"type":30,"value":2958},{"type":25,"tag":930,"props":9395,"children":9396},{"class":932,"line":2017},[9397],{"type":25,"tag":930,"props":9398,"children":9399},{"style":942},[9400],{"type":30,"value":9401},"            ],\n",{"type":25,"tag":930,"props":9403,"children":9404},{"class":932,"line":2030},[9405,9410,9414,9419,9424],{"type":25,"tag":930,"props":9406,"children":9407},{"style":6679},[9408],{"type":30,"value":9409},"            adjustment_type",{"type":25,"tag":930,"props":9411,"children":9412},{"style":1059},[9413],{"type":30,"value":6285},{"type":25,"tag":930,"props":9415,"children":9416},{"style":942},[9417],{"type":30,"value":9418},"aas.AdjustmentType.",{"type":25,"tag":930,"props":9420,"children":9421},{"style":2676},[9422],{"type":30,"value":9423},"CHANGE_IN_CAPACITY",{"type":25,"tag":930,"props":9425,"children":9426},{"style":942},[9427],{"type":30,"value":2926},{"type":25,"tag":930,"props":9429,"children":9430},{"class":932,"line":2042},[9431],{"type":25,"tag":930,"props":9432,"children":9433},{"style":942},[9434],{"type":30,"value":7961},{"type":25,"tag":26,"props":9436,"children":9437},{},[9438,9440,9446,9448,9454,9456,9462],{"type":30,"value":9439},"Step 4 inspects active and reserved tasks, filters the tasks by the ",{"type":25,"tag":130,"props":9441,"children":9443},{"className":9442},[],[9444],{"type":30,"value":9445},"routing_key",{"type":30,"value":9447}," (which is the same as the queue name) and the combines this with any queued tasks by calling ",{"type":25,"tag":130,"props":9449,"children":9451},{"className":9450},[],[9452],{"type":30,"value":9453},"llen(queue_name)",{"type":30,"value":9455},". Finally, the queue names and combined active, reserved and queued task totals are sent to CloudWatch via boto3. The code for this is in ",{"type":25,"tag":130,"props":9457,"children":9459},{"className":9458},[],[9460],{"type":30,"value":9461},"backend/apps/core/utils/celery_utils.py",{"type":30,"value":208},{"type":25,"tag":26,"props":9464,"children":9465},{},[9466],{"type":30,"value":9467},"Here's the code for the Lambda function in step 5:",{"type":25,"tag":693,"props":9469,"children":9471},{"code":9470,"language":6157,"meta":8,"className":6158,"style":8},"import json\nimport os\nimport urllib.request\n\nFULL_DOMAIN_NAME = os.environ.get(\"FULL_DOMAIN_NAME\")\nCELERY_METRICS_PATH = \"api/celery-metrics/\"\n\nCELERY_METRICS_URL = f\"https://{FULL_DOMAIN_NAME}/{CELERY_METRICS_PATH}\"\nCELERY_METRICS_TOKEN = os.environ.get(\"CELERY_METRICS_TOKEN\")\n\n\ndef lambda_handler(event, context):\n    data = {\"celery_metrics_token\": CELERY_METRICS_TOKEN}\n    params = json.dumps(data).encode('utf8')\n    req = urllib.request.Request(\n        CELERY_METRICS_URL,\n        data=params,\n        headers={'content-type': 'application/json'},\n    )\n    response = urllib.request.urlopen(req)\n    return response.read()\n",[9472],{"type":25,"tag":130,"props":9473,"children":9474},{"__ignoreMap":8},[9475,9487,9498,9510,9517,9542,9559,9566,9605,9630,9637,9644,9680,9714,9740,9757,9769,9786,9821,9829,9846],{"type":25,"tag":930,"props":9476,"children":9477},{"class":932,"line":933},[9478,9482],{"type":25,"tag":930,"props":9479,"children":9480},{"style":1059},[9481],{"type":30,"value":6179},{"type":25,"tag":930,"props":9483,"children":9484},{"style":942},[9485],{"type":30,"value":9486}," json\n",{"type":25,"tag":930,"props":9488,"children":9489},{"class":932,"line":250},[9490,9494],{"type":25,"tag":930,"props":9491,"children":9492},{"style":1059},[9493],{"type":30,"value":6179},{"type":25,"tag":930,"props":9495,"children":9496},{"style":942},[9497],{"type":30,"value":6184},{"type":25,"tag":930,"props":9499,"children":9500},{"class":932,"line":967},[9501,9505],{"type":25,"tag":930,"props":9502,"children":9503},{"style":1059},[9504],{"type":30,"value":6179},{"type":25,"tag":930,"props":9506,"children":9507},{"style":942},[9508],{"type":30,"value":9509}," urllib.request\n",{"type":25,"tag":930,"props":9511,"children":9512},{"class":932,"line":985},[9513],{"type":25,"tag":930,"props":9514,"children":9515},{"emptyLinePlaceholder":265},[9516],{"type":30,"value":3733},{"type":25,"tag":930,"props":9518,"children":9519},{"class":932,"line":998},[9520,9525,9529,9533,9538],{"type":25,"tag":930,"props":9521,"children":9522},{"style":2676},[9523],{"type":30,"value":9524},"FULL_DOMAIN_NAME",{"type":25,"tag":930,"props":9526,"children":9527},{"style":1059},[9528],{"type":30,"value":2886},{"type":25,"tag":930,"props":9530,"children":9531},{"style":942},[9532],{"type":30,"value":6351},{"type":25,"tag":930,"props":9534,"children":9535},{"style":961},[9536],{"type":30,"value":9537},"\"FULL_DOMAIN_NAME\"",{"type":25,"tag":930,"props":9539,"children":9540},{"style":942},[9541],{"type":30,"value":2702},{"type":25,"tag":930,"props":9543,"children":9544},{"class":932,"line":1012},[9545,9550,9554],{"type":25,"tag":930,"props":9546,"children":9547},{"style":2676},[9548],{"type":30,"value":9549},"CELERY_METRICS_PATH",{"type":25,"tag":930,"props":9551,"children":9552},{"style":1059},[9553],{"type":30,"value":2886},{"type":25,"tag":930,"props":9555,"children":9556},{"style":961},[9557],{"type":30,"value":9558}," \"api/celery-metrics/\"\n",{"type":25,"tag":930,"props":9560,"children":9561},{"class":932,"line":1025},[9562],{"type":25,"tag":930,"props":9563,"children":9564},{"emptyLinePlaceholder":265},[9565],{"type":30,"value":3733},{"type":25,"tag":930,"props":9567,"children":9568},{"class":932,"line":1038},[9569,9574,9578,9582,9587,9592,9596,9601],{"type":25,"tag":930,"props":9570,"children":9571},{"style":2676},[9572],{"type":30,"value":9573},"CELERY_METRICS_URL",{"type":25,"tag":930,"props":9575,"children":9576},{"style":1059},[9577],{"type":30,"value":2886},{"type":25,"tag":930,"props":9579,"children":9580},{"style":6288},[9581],{"type":30,"value":6291},{"type":25,"tag":930,"props":9583,"children":9584},{"style":961},[9585],{"type":30,"value":9586},"\"https://",{"type":25,"tag":930,"props":9588,"children":9589},{"style":2676},[9590],{"type":30,"value":9591},"{FULL_DOMAIN_NAME}",{"type":25,"tag":930,"props":9593,"children":9594},{"style":961},[9595],{"type":30,"value":1238},{"type":25,"tag":930,"props":9597,"children":9598},{"style":2676},[9599],{"type":30,"value":9600},"{CELERY_METRICS_PATH}",{"type":25,"tag":930,"props":9602,"children":9603},{"style":961},[9604],{"type":30,"value":6334},{"type":25,"tag":930,"props":9606,"children":9607},{"class":932,"line":1051},[9608,9613,9617,9621,9626],{"type":25,"tag":930,"props":9609,"children":9610},{"style":2676},[9611],{"type":30,"value":9612},"CELERY_METRICS_TOKEN",{"type":25,"tag":930,"props":9614,"children":9615},{"style":1059},[9616],{"type":30,"value":2886},{"type":25,"tag":930,"props":9618,"children":9619},{"style":942},[9620],{"type":30,"value":6351},{"type":25,"tag":930,"props":9622,"children":9623},{"style":961},[9624],{"type":30,"value":9625},"\"CELERY_METRICS_TOKEN\"",{"type":25,"tag":930,"props":9627,"children":9628},{"style":942},[9629],{"type":30,"value":2702},{"type":25,"tag":930,"props":9631,"children":9632},{"class":932,"line":1065},[9633],{"type":25,"tag":930,"props":9634,"children":9635},{"emptyLinePlaceholder":265},[9636],{"type":30,"value":3733},{"type":25,"tag":930,"props":9638,"children":9639},{"class":932,"line":1074},[9640],{"type":25,"tag":930,"props":9641,"children":9642},{"emptyLinePlaceholder":265},[9643],{"type":30,"value":3733},{"type":25,"tag":930,"props":9645,"children":9646},{"class":932,"line":1083},[9647,9652,9657,9662,9668,9672,9676],{"type":25,"tag":930,"props":9648,"children":9649},{"style":6288},[9650],{"type":30,"value":9651},"def",{"type":25,"tag":930,"props":9653,"children":9654},{"style":2155},[9655],{"type":30,"value":9656}," lambda_handler",{"type":25,"tag":930,"props":9658,"children":9659},{"style":942},[9660],{"type":30,"value":9661},"(",{"type":25,"tag":930,"props":9663,"children":9665},{"style":9664},"--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#FD971F;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[9666],{"type":30,"value":9667},"event",{"type":25,"tag":930,"props":9669,"children":9670},{"style":942},[9671],{"type":30,"value":860},{"type":25,"tag":930,"props":9673,"children":9674},{"style":9664},[9675],{"type":30,"value":1174},{"type":25,"tag":930,"props":9677,"children":9678},{"style":942},[9679],{"type":30,"value":7641},{"type":25,"tag":930,"props":9681,"children":9682},{"class":932,"line":1092},[9683,9688,9692,9697,9702,9706,9710],{"type":25,"tag":930,"props":9684,"children":9685},{"style":942},[9686],{"type":30,"value":9687},"    data ",{"type":25,"tag":930,"props":9689,"children":9690},{"style":1059},[9691],{"type":30,"value":6285},{"type":25,"tag":930,"props":9693,"children":9694},{"style":942},[9695],{"type":30,"value":9696}," {",{"type":25,"tag":930,"props":9698,"children":9699},{"style":961},[9700],{"type":30,"value":9701},"\"celery_metrics_token\"",{"type":25,"tag":930,"props":9703,"children":9704},{"style":942},[9705],{"type":30,"value":958},{"type":25,"tag":930,"props":9707,"children":9708},{"style":2676},[9709],{"type":30,"value":9612},{"type":25,"tag":930,"props":9711,"children":9712},{"style":942},[9713],{"type":30,"value":3091},{"type":25,"tag":930,"props":9715,"children":9716},{"class":932,"line":1101},[9717,9722,9726,9731,9736],{"type":25,"tag":930,"props":9718,"children":9719},{"style":942},[9720],{"type":30,"value":9721},"    params ",{"type":25,"tag":930,"props":9723,"children":9724},{"style":1059},[9725],{"type":30,"value":6285},{"type":25,"tag":930,"props":9727,"children":9728},{"style":942},[9729],{"type":30,"value":9730}," json.dumps(data).encode(",{"type":25,"tag":930,"props":9732,"children":9733},{"style":961},[9734],{"type":30,"value":9735},"'utf8'",{"type":25,"tag":930,"props":9737,"children":9738},{"style":942},[9739],{"type":30,"value":2702},{"type":25,"tag":930,"props":9741,"children":9742},{"class":932,"line":2017},[9743,9748,9752],{"type":25,"tag":930,"props":9744,"children":9745},{"style":942},[9746],{"type":30,"value":9747},"    req ",{"type":25,"tag":930,"props":9749,"children":9750},{"style":1059},[9751],{"type":30,"value":6285},{"type":25,"tag":930,"props":9753,"children":9754},{"style":942},[9755],{"type":30,"value":9756}," urllib.request.Request(\n",{"type":25,"tag":930,"props":9758,"children":9759},{"class":932,"line":2030},[9760,9765],{"type":25,"tag":930,"props":9761,"children":9762},{"style":2676},[9763],{"type":30,"value":9764},"        CELERY_METRICS_URL",{"type":25,"tag":930,"props":9766,"children":9767},{"style":942},[9768],{"type":30,"value":2926},{"type":25,"tag":930,"props":9770,"children":9771},{"class":932,"line":2042},[9772,9777,9781],{"type":25,"tag":930,"props":9773,"children":9774},{"style":6679},[9775],{"type":30,"value":9776},"        data",{"type":25,"tag":930,"props":9778,"children":9779},{"style":1059},[9780],{"type":30,"value":6285},{"type":25,"tag":930,"props":9782,"children":9783},{"style":942},[9784],{"type":30,"value":9785},"params,\n",{"type":25,"tag":930,"props":9787,"children":9788},{"class":932,"line":2054},[9789,9794,9798,9802,9807,9811,9816],{"type":25,"tag":930,"props":9790,"children":9791},{"style":6679},[9792],{"type":30,"value":9793},"        headers",{"type":25,"tag":930,"props":9795,"children":9796},{"style":1059},[9797],{"type":30,"value":6285},{"type":25,"tag":930,"props":9799,"children":9800},{"style":942},[9801],{"type":30,"value":6301},{"type":25,"tag":930,"props":9803,"children":9804},{"style":961},[9805],{"type":30,"value":9806},"'content-type'",{"type":25,"tag":930,"props":9808,"children":9809},{"style":942},[9810],{"type":30,"value":958},{"type":25,"tag":930,"props":9812,"children":9813},{"style":961},[9814],{"type":30,"value":9815},"'application/json'",{"type":25,"tag":930,"props":9817,"children":9818},{"style":942},[9819],{"type":30,"value":9820},"},\n",{"type":25,"tag":930,"props":9822,"children":9823},{"class":932,"line":4309},[9824],{"type":25,"tag":930,"props":9825,"children":9826},{"style":942},[9827],{"type":30,"value":9828},"    )\n",{"type":25,"tag":930,"props":9830,"children":9831},{"class":932,"line":4322},[9832,9837,9841],{"type":25,"tag":930,"props":9833,"children":9834},{"style":942},[9835],{"type":30,"value":9836},"    response ",{"type":25,"tag":930,"props":9838,"children":9839},{"style":1059},[9840],{"type":30,"value":6285},{"type":25,"tag":930,"props":9842,"children":9843},{"style":942},[9844],{"type":30,"value":9845}," urllib.request.urlopen(req)\n",{"type":25,"tag":930,"props":9847,"children":9848},{"class":932,"line":4335},[9849,9854],{"type":25,"tag":930,"props":9850,"children":9851},{"style":1059},[9852],{"type":30,"value":9853},"    return",{"type":25,"tag":930,"props":9855,"children":9856},{"style":942},[9857],{"type":30,"value":9858}," response.read()\n",{"type":25,"tag":26,"props":9860,"children":9861},{},[9862],{"type":30,"value":9863},"Finally, here is the code for defining the lambda function and scheduled invocation of the lambda function:",{"type":25,"tag":693,"props":9865,"children":9867},{"code":9866,"language":6157,"meta":8,"className":6158,"style":8},"class CeleryAutoscalingStack(cloudformation.NestedStack):\n    def __init__(self, scope: core.Construct, id: str, **kwargs) -> None:\n        super().__init__(\n            scope, id, **kwargs,\n        )\n\n        self.lambda_function = aws_lambda.Function(\n            self,\n            \"CeleryMetricsLambdaFunction\",\n            code=aws_lambda.Code.asset(\"awslambda\"),\n            handler=\"publish_celery_metrics.lambda_handler\",\n            runtime=aws_lambda.Runtime.PYTHON_3_7,\n            environment=scope.variables.regular_variables,\n        )\n\n        self.celery_default_cw_metric_schedule = events.Rule(\n            self,\n            \"CeleryDefaultCWMetricSchedule\",\n            schedule=events.Schedule.rate(core.Duration.minutes(5)),\n            targets=[\n                events_targets.LambdaFunction(handler=self.lambda_function)\n            ],\n        )\n\n        # TODO: refactor this to loop through CloudWatch metrics multiple celery queues\n        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n            scope.backend_service.backend_task.task_role\n        )\n",[9868],{"type":25,"tag":130,"props":9869,"children":9870},{"__ignoreMap":8},[9871,9907,9986,10009,10034,10041,10048,10069,10081,10093,10119,10140,10166,10183,10190,10197,10218,10229,10241,10268,10284,10310,10317,10324,10331,10349,10357,10365],{"type":25,"tag":930,"props":9872,"children":9873},{"class":932,"line":933},[9874,9879,9885,9889,9895,9899,9903],{"type":25,"tag":930,"props":9875,"children":9876},{"style":6288},[9877],{"type":30,"value":9878},"class",{"type":25,"tag":930,"props":9880,"children":9882},{"style":9881},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[9883],{"type":30,"value":9884}," CeleryAutoscalingStack",{"type":25,"tag":930,"props":9886,"children":9887},{"style":942},[9888],{"type":30,"value":9661},{"type":25,"tag":930,"props":9890,"children":9892},{"style":9891},"--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[9893],{"type":30,"value":9894},"cloudformation",{"type":25,"tag":930,"props":9896,"children":9897},{"style":942},[9898],{"type":30,"value":208},{"type":25,"tag":930,"props":9900,"children":9901},{"style":9891},[9902],{"type":30,"value":6991},{"type":25,"tag":930,"props":9904,"children":9905},{"style":942},[9906],{"type":30,"value":7641},{"type":25,"tag":930,"props":9908,"children":9909},{"class":932,"line":250},[9910,9915,9921,9925,9929,9933,9938,9943,9948,9952,9958,9962,9967,9972,9977,9982],{"type":25,"tag":930,"props":9911,"children":9912},{"style":6288},[9913],{"type":30,"value":9914},"    def",{"type":25,"tag":930,"props":9916,"children":9918},{"style":9917},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[9919],{"type":30,"value":9920}," __init__",{"type":25,"tag":930,"props":9922,"children":9923},{"style":942},[9924],{"type":30,"value":9661},{"type":25,"tag":930,"props":9926,"children":9927},{"style":9664},[9928],{"type":30,"value":7691},{"type":25,"tag":930,"props":9930,"children":9931},{"style":942},[9932],{"type":30,"value":860},{"type":25,"tag":930,"props":9934,"children":9935},{"style":9664},[9936],{"type":30,"value":9937},"scope",{"type":25,"tag":930,"props":9939,"children":9940},{"style":942},[9941],{"type":30,"value":9942},": core.Construct, ",{"type":25,"tag":930,"props":9944,"children":9945},{"style":9664},[9946],{"type":30,"value":9947},"id",{"type":25,"tag":930,"props":9949,"children":9950},{"style":942},[9951],{"type":30,"value":958},{"type":25,"tag":930,"props":9953,"children":9955},{"style":9954},"--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[9956],{"type":30,"value":9957},"str",{"type":25,"tag":930,"props":9959,"children":9960},{"style":942},[9961],{"type":30,"value":860},{"type":25,"tag":930,"props":9963,"children":9964},{"style":1059},[9965],{"type":30,"value":9966},"**",{"type":25,"tag":930,"props":9968,"children":9969},{"style":9664},[9970],{"type":30,"value":9971},"kwargs",{"type":25,"tag":930,"props":9973,"children":9974},{"style":942},[9975],{"type":30,"value":9976},") -> ",{"type":25,"tag":930,"props":9978,"children":9979},{"style":2676},[9980],{"type":30,"value":9981},"None",{"type":25,"tag":930,"props":9983,"children":9984},{"style":942},[9985],{"type":30,"value":945},{"type":25,"tag":930,"props":9987,"children":9988},{"class":932,"line":967},[9989,9994,9999,10004],{"type":25,"tag":930,"props":9990,"children":9991},{"style":9954},[9992],{"type":30,"value":9993},"        super",{"type":25,"tag":930,"props":9995,"children":9996},{"style":942},[9997],{"type":30,"value":9998},"().",{"type":25,"tag":930,"props":10000,"children":10001},{"style":9917},[10002],{"type":30,"value":10003},"__init__",{"type":25,"tag":930,"props":10005,"children":10006},{"style":942},[10007],{"type":30,"value":10008},"(\n",{"type":25,"tag":930,"props":10010,"children":10011},{"class":932,"line":985},[10012,10017,10021,10025,10029],{"type":25,"tag":930,"props":10013,"children":10014},{"style":942},[10015],{"type":30,"value":10016},"            scope, ",{"type":25,"tag":930,"props":10018,"children":10019},{"style":9917},[10020],{"type":30,"value":9947},{"type":25,"tag":930,"props":10022,"children":10023},{"style":942},[10024],{"type":30,"value":860},{"type":25,"tag":930,"props":10026,"children":10027},{"style":1059},[10028],{"type":30,"value":9966},{"type":25,"tag":930,"props":10030,"children":10031},{"style":942},[10032],{"type":30,"value":10033},"kwargs,\n",{"type":25,"tag":930,"props":10035,"children":10036},{"class":932,"line":998},[10037],{"type":25,"tag":930,"props":10038,"children":10039},{"style":942},[10040],{"type":30,"value":7961},{"type":25,"tag":930,"props":10042,"children":10043},{"class":932,"line":1012},[10044],{"type":25,"tag":930,"props":10045,"children":10046},{"emptyLinePlaceholder":265},[10047],{"type":30,"value":3733},{"type":25,"tag":930,"props":10049,"children":10050},{"class":932,"line":1025},[10051,10055,10060,10064],{"type":25,"tag":930,"props":10052,"children":10053},{"style":7655},[10054],{"type":30,"value":7891},{"type":25,"tag":930,"props":10056,"children":10057},{"style":942},[10058],{"type":30,"value":10059},".lambda_function ",{"type":25,"tag":930,"props":10061,"children":10062},{"style":1059},[10063],{"type":30,"value":6285},{"type":25,"tag":930,"props":10065,"children":10066},{"style":942},[10067],{"type":30,"value":10068}," aws_lambda.Function(\n",{"type":25,"tag":930,"props":10070,"children":10071},{"class":932,"line":1038},[10072,10077],{"type":25,"tag":930,"props":10073,"children":10074},{"style":7655},[10075],{"type":30,"value":10076},"            self",{"type":25,"tag":930,"props":10078,"children":10079},{"style":942},[10080],{"type":30,"value":2926},{"type":25,"tag":930,"props":10082,"children":10083},{"class":932,"line":1051},[10084,10089],{"type":25,"tag":930,"props":10085,"children":10086},{"style":961},[10087],{"type":30,"value":10088},"            \"CeleryMetricsLambdaFunction\"",{"type":25,"tag":930,"props":10090,"children":10091},{"style":942},[10092],{"type":30,"value":2926},{"type":25,"tag":930,"props":10094,"children":10095},{"class":932,"line":1065},[10096,10101,10105,10110,10115],{"type":25,"tag":930,"props":10097,"children":10098},{"style":6679},[10099],{"type":30,"value":10100},"            code",{"type":25,"tag":930,"props":10102,"children":10103},{"style":1059},[10104],{"type":30,"value":6285},{"type":25,"tag":930,"props":10106,"children":10107},{"style":942},[10108],{"type":30,"value":10109},"aws_lambda.Code.asset(",{"type":25,"tag":930,"props":10111,"children":10112},{"style":961},[10113],{"type":30,"value":10114},"\"awslambda\"",{"type":25,"tag":930,"props":10116,"children":10117},{"style":942},[10118],{"type":30,"value":2958},{"type":25,"tag":930,"props":10120,"children":10121},{"class":932,"line":1074},[10122,10127,10131,10136],{"type":25,"tag":930,"props":10123,"children":10124},{"style":6679},[10125],{"type":30,"value":10126},"            handler",{"type":25,"tag":930,"props":10128,"children":10129},{"style":1059},[10130],{"type":30,"value":6285},{"type":25,"tag":930,"props":10132,"children":10133},{"style":961},[10134],{"type":30,"value":10135},"\"publish_celery_metrics.lambda_handler\"",{"type":25,"tag":930,"props":10137,"children":10138},{"style":942},[10139],{"type":30,"value":2926},{"type":25,"tag":930,"props":10141,"children":10142},{"class":932,"line":1083},[10143,10148,10152,10157,10162],{"type":25,"tag":930,"props":10144,"children":10145},{"style":6679},[10146],{"type":30,"value":10147},"            runtime",{"type":25,"tag":930,"props":10149,"children":10150},{"style":1059},[10151],{"type":30,"value":6285},{"type":25,"tag":930,"props":10153,"children":10154},{"style":942},[10155],{"type":30,"value":10156},"aws_lambda.Runtime.",{"type":25,"tag":930,"props":10158,"children":10159},{"style":2676},[10160],{"type":30,"value":10161},"PYTHON_3_7",{"type":25,"tag":930,"props":10163,"children":10164},{"style":942},[10165],{"type":30,"value":2926},{"type":25,"tag":930,"props":10167,"children":10168},{"class":932,"line":1092},[10169,10174,10178],{"type":25,"tag":930,"props":10170,"children":10171},{"style":6679},[10172],{"type":30,"value":10173},"            environment",{"type":25,"tag":930,"props":10175,"children":10176},{"style":1059},[10177],{"type":30,"value":6285},{"type":25,"tag":930,"props":10179,"children":10180},{"style":942},[10181],{"type":30,"value":10182},"scope.variables.regular_variables,\n",{"type":25,"tag":930,"props":10184,"children":10185},{"class":932,"line":1101},[10186],{"type":25,"tag":930,"props":10187,"children":10188},{"style":942},[10189],{"type":30,"value":7961},{"type":25,"tag":930,"props":10191,"children":10192},{"class":932,"line":2017},[10193],{"type":25,"tag":930,"props":10194,"children":10195},{"emptyLinePlaceholder":265},[10196],{"type":30,"value":3733},{"type":25,"tag":930,"props":10198,"children":10199},{"class":932,"line":2030},[10200,10204,10209,10213],{"type":25,"tag":930,"props":10201,"children":10202},{"style":7655},[10203],{"type":30,"value":7891},{"type":25,"tag":930,"props":10205,"children":10206},{"style":942},[10207],{"type":30,"value":10208},".celery_default_cw_metric_schedule ",{"type":25,"tag":930,"props":10210,"children":10211},{"style":1059},[10212],{"type":30,"value":6285},{"type":25,"tag":930,"props":10214,"children":10215},{"style":942},[10216],{"type":30,"value":10217}," events.Rule(\n",{"type":25,"tag":930,"props":10219,"children":10220},{"class":932,"line":2042},[10221,10225],{"type":25,"tag":930,"props":10222,"children":10223},{"style":7655},[10224],{"type":30,"value":10076},{"type":25,"tag":930,"props":10226,"children":10227},{"style":942},[10228],{"type":30,"value":2926},{"type":25,"tag":930,"props":10230,"children":10231},{"class":932,"line":2054},[10232,10237],{"type":25,"tag":930,"props":10233,"children":10234},{"style":961},[10235],{"type":30,"value":10236},"            \"CeleryDefaultCWMetricSchedule\"",{"type":25,"tag":930,"props":10238,"children":10239},{"style":942},[10240],{"type":30,"value":2926},{"type":25,"tag":930,"props":10242,"children":10243},{"class":932,"line":4309},[10244,10249,10253,10258,10263],{"type":25,"tag":930,"props":10245,"children":10246},{"style":6679},[10247],{"type":30,"value":10248},"            schedule",{"type":25,"tag":930,"props":10250,"children":10251},{"style":1059},[10252],{"type":30,"value":6285},{"type":25,"tag":930,"props":10254,"children":10255},{"style":942},[10256],{"type":30,"value":10257},"events.Schedule.rate(core.Duration.minutes(",{"type":25,"tag":930,"props":10259,"children":10260},{"style":2676},[10261],{"type":30,"value":10262},"5",{"type":25,"tag":930,"props":10264,"children":10265},{"style":942},[10266],{"type":30,"value":10267},")),\n",{"type":25,"tag":930,"props":10269,"children":10270},{"class":932,"line":4322},[10271,10276,10280],{"type":25,"tag":930,"props":10272,"children":10273},{"style":6679},[10274],{"type":30,"value":10275},"            targets",{"type":25,"tag":930,"props":10277,"children":10278},{"style":1059},[10279],{"type":30,"value":6285},{"type":25,"tag":930,"props":10281,"children":10282},{"style":942},[10283],{"type":30,"value":9311},{"type":25,"tag":930,"props":10285,"children":10286},{"class":932,"line":4335},[10287,10292,10297,10301,10305],{"type":25,"tag":930,"props":10288,"children":10289},{"style":942},[10290],{"type":30,"value":10291},"                events_targets.LambdaFunction(",{"type":25,"tag":930,"props":10293,"children":10294},{"style":6679},[10295],{"type":30,"value":10296},"handler",{"type":25,"tag":930,"props":10298,"children":10299},{"style":1059},[10300],{"type":30,"value":6285},{"type":25,"tag":930,"props":10302,"children":10303},{"style":7655},[10304],{"type":30,"value":7691},{"type":25,"tag":930,"props":10306,"children":10307},{"style":942},[10308],{"type":30,"value":10309},".lambda_function)\n",{"type":25,"tag":930,"props":10311,"children":10312},{"class":932,"line":4347},[10313],{"type":25,"tag":930,"props":10314,"children":10315},{"style":942},[10316],{"type":30,"value":9401},{"type":25,"tag":930,"props":10318,"children":10319},{"class":932,"line":4359},[10320],{"type":25,"tag":930,"props":10321,"children":10322},{"style":942},[10323],{"type":30,"value":7961},{"type":25,"tag":930,"props":10325,"children":10326},{"class":932,"line":4371},[10327],{"type":25,"tag":930,"props":10328,"children":10329},{"emptyLinePlaceholder":265},[10330],{"type":30,"value":3733},{"type":25,"tag":930,"props":10332,"children":10333},{"class":932,"line":4384},[10334,10339,10344],{"type":25,"tag":930,"props":10335,"children":10336},{"style":6168},[10337],{"type":30,"value":10338},"        # ",{"type":25,"tag":930,"props":10340,"children":10341},{"style":1059},[10342],{"type":30,"value":10343},"TODO",{"type":25,"tag":930,"props":10345,"children":10346},{"style":6168},[10347],{"type":30,"value":10348},": refactor this to loop through CloudWatch metrics multiple celery queues\n",{"type":25,"tag":930,"props":10350,"children":10351},{"class":932,"line":4397},[10352],{"type":25,"tag":930,"props":10353,"children":10354},{"style":942},[10355],{"type":30,"value":10356},"        scope.celery_default_service.default_celery_queue_cw_metric.grant_put_metric_data(\n",{"type":25,"tag":930,"props":10358,"children":10359},{"class":932,"line":6675},[10360],{"type":25,"tag":930,"props":10361,"children":10362},{"style":942},[10363],{"type":30,"value":10364},"            scope.backend_service.backend_task.task_role\n",{"type":25,"tag":930,"props":10366,"children":10367},{"class":932,"line":6694},[10368],{"type":25,"tag":930,"props":10369,"children":10370},{"style":942},[10371],{"type":30,"value":7961},{"type":25,"tag":339,"props":10373,"children":10375},{"id":10374},"miscellaneous-grievances",[10376],{"type":30,"value":10377},"Miscellaneous Grievances",{"type":25,"tag":33,"props":10379,"children":10380},{},[10381,10386,10399],{"type":25,"tag":37,"props":10382,"children":10383},{},[10384],{"type":30,"value":10385},"Fargate tasks cannot access Secrets that use JSON template",{"type":25,"tag":37,"props":10387,"children":10388},{},[10389,10391,10397],{"type":30,"value":10390},"You cannot select ",{"type":25,"tag":130,"props":10392,"children":10394},{"className":10393},[],[10395],{"type":30,"value":10396},"FARGATE_SPOT",{"type":30,"value":10398}," on a CDK-created ECS cluster. This option seems to only be available from the ECS Wizard in the AWS Console",{"type":25,"tag":37,"props":10400,"children":10401},{},[10402,10404,10410],{"type":30,"value":10403},"It's not super clear how to package dependencies in Lambda with CDK. Here's an interesting approach that I would like to try: ",{"type":25,"tag":41,"props":10405,"children":10408},{"href":10406,"rel":10407},"https://github.com/aws-samples/aws-cdk-examples/issues/130#issuecomment-554097487",[45],[10409],{"type":30,"value":10406},{"type":30,"value":10411},". The Lambda functions I'm using don't require anything outside of the standard library, but if they did it would require some additional work to make sure dependencies can be added as Lambda Layers.",{"type":25,"tag":339,"props":10413,"children":10415},{"id":10414},"todo",[10416],{"type":30,"value":10343},{"type":25,"tag":33,"props":10418,"children":10419},{},[10420,10425,10430,10435],{"type":25,"tag":37,"props":10421,"children":10422},{},[10423],{"type":30,"value":10424},"Create an IAM role template that can be used to create an IAM role that has access to setup infrastructure through CDK. Currently I'm using an admin account which is not a best practice.",{"type":25,"tag":37,"props":10426,"children":10427},{},[10428],{"type":30,"value":10429},"Move this Wiki Article to the project documentation site and main README",{"type":25,"tag":37,"props":10431,"children":10432},{},[10433],{"type":30,"value":10434},"Expand on each topic, replace existing documentation",{"type":25,"tag":37,"props":10436,"children":10437},{},[10438,10440,10445],{"type":30,"value":10439},"Add a summary of each ",{"type":25,"tag":130,"props":10441,"children":10443},{"className":10442},[],[10444],{"type":30,"value":6991},{"type":30,"value":10446}," from CDK code",{"type":25,"tag":4771,"props":10448,"children":10449},{},[10450],{"type":30,"value":4775},{"title":8,"searchDepth":250,"depth":250,"links":10452},[10453,10454,10466,10480,10487,10488,10489],{"id":4908,"depth":250,"text":4911},{"id":4992,"depth":250,"text":4995,"children":10455},[10456,10457,10458,10459,10460,10461,10462,10463,10464,10465],{"id":5004,"depth":967,"text":5007},{"id":5179,"depth":967,"text":5182},{"id":5223,"depth":967,"text":5226},{"id":5270,"depth":967,"text":4890},{"id":5372,"depth":967,"text":5375},{"id":5452,"depth":967,"text":5455},{"id":5496,"depth":967,"text":5499},{"id":5690,"depth":967,"text":5693},{"id":5786,"depth":967,"text":4944},{"id":5838,"depth":967,"text":5841},{"id":5917,"depth":250,"text":5920,"children":10467},[10468,10470,10471,10473,10475,10477,10478],{"id":5928,"depth":967,"text":10469},"Start here: https://cdkworkshop.com",{"id":5945,"depth":967,"text":5948},{"id":6898,"depth":967,"text":10472},"Using cdk synth in development",{"id":6984,"depth":967,"text":10474},"NestedStacks",{"id":7115,"depth":967,"text":10476},"cdk deploy and CDK in GitLab CI pipelines",{"id":7577,"depth":967,"text":7584},{"id":8023,"depth":967,"text":10479},"Quick tour of ApplicationStack",{"id":8660,"depth":250,"text":10481,"children":10482},"Why X? Why not Y?",[10483,10484,10485,10486],{"id":8687,"depth":967,"text":8690},{"id":8744,"depth":967,"text":8747},{"id":8755,"depth":967,"text":8758},{"id":8810,"depth":967,"text":8813},{"id":8821,"depth":250,"text":8824},{"id":10374,"depth":250,"text":10377},{"id":10414,"depth":250,"text":10343},"content:2020:06:02:django-postgres-vue-gitlab-ecs.md","2020/06/02/django-postgres-vue-gitlab-ecs.md","2020/06/02/django-postgres-vue-gitlab-ecs",{"_path":10494,"_dir":260,"_draft":7,"_partial":7,"_locale":8,"title":10495,"description":10496,"layout":263,"date":10497,"comments":265,"image":10498,"tags":10499,"body":10500,"_type":252,"_id":10593,"_source":254,"_file":10594,"_stem":10595,"_extension":257},"/2019/01/09/django-docker-vue-nginx-drf-traefik-celery","Setup, Development and Deployment of a web app using Django, VueJS, VuePress, Docker, nginx, traefik and GitLab","This project is currently deployed on https://verbose-equals-true.tk. The source code is available at https://gitlab.com/briancaffey/verbose-equals-true.","2019-01-09T00:00:00.000Z","/static/technologies.png",[14,15,19,18],{"type":22,"children":10501,"toc":10591},[10502,10522,10527,10567,10572,10579],{"type":25,"tag":26,"props":10503,"children":10504},{},[10505,10507,10513,10515,10521],{"type":30,"value":10506},"This project is currently deployed on ",{"type":25,"tag":41,"props":10508,"children":10511},{"href":10509,"rel":10510},"https://verbose-equals-true.tk",[45],[10512],{"type":30,"value":10509},{"type":30,"value":10514},". The source code is available at ",{"type":25,"tag":41,"props":10516,"children":10519},{"href":10517,"rel":10518},"https://gitlab.com/briancaffey/verbose-equals-true",[45],[10520],{"type":30,"value":10517},{"type":30,"value":208},{"type":25,"tag":26,"props":10523,"children":10524},{},[10525],{"type":30,"value":10526},"The goal of this project is to explain how to setup a project starting with a fresh installation of 16.04. Setup includes local development environment, GitLab CI/CD, VSCode settings and configuration of the different containers that make up the application:",{"type":25,"tag":33,"props":10528,"children":10529},{},[10530,10534,10539,10543,10547,10552,10557,10562],{"type":25,"tag":37,"props":10531,"children":10532},{},[10533],{"type":30,"value":4870},{"type":25,"tag":37,"props":10535,"children":10536},{},[10537],{"type":30,"value":10538},"Node (for local development with VueJS)",{"type":25,"tag":37,"props":10540,"children":10541},{},[10542],{"type":30,"value":271},{"type":25,"tag":37,"props":10544,"children":10545},{},[10546],{"type":30,"value":3935},{"type":25,"tag":37,"props":10548,"children":10549},{},[10550],{"type":30,"value":10551},"Postgres",{"type":25,"tag":37,"props":10553,"children":10554},{},[10555],{"type":30,"value":10556},"Celery",{"type":25,"tag":37,"props":10558,"children":10559},{},[10560],{"type":30,"value":10561},"flower",{"type":25,"tag":37,"props":10563,"children":10564},{},[10565],{"type":30,"value":10566},"portainer",{"type":25,"tag":26,"props":10568,"children":10569},{},[10570],{"type":30,"value":10571},"Here's an overview of the architecture used in the application:",{"type":25,"tag":26,"props":10573,"children":10574},{},[10575],{"type":25,"tag":3940,"props":10576,"children":10578},{"alt":3942,"src":10577},"/static/architecture.png",[],{"type":25,"tag":26,"props":10580,"children":10581},{},[10582,10584,10590],{"type":30,"value":10583},"Extensive documentation for this project can be found at ",{"type":25,"tag":41,"props":10585,"children":10588},{"href":10586,"rel":10587},"https://verbose-equals-true.tk/docs",[45],[10589],{"type":30,"value":10586},{"type":30,"value":208},{"title":8,"searchDepth":250,"depth":250,"links":10592},[],"content:2019:01:09:django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery.md","2019/01/09/django-docker-vue-nginx-drf-traefik-celery",1723473708912]