<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="twitter:creator" content="@briancaffey"><meta data-n-head="ssr" property="twitter:site" content="@briancaffey"><meta data-n-head="ssr" property="og:title" content="My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi"><meta data-n-head="ssr" property="og:description" content="I wrote three reusable infrastructure as code libraries to develop high-level abstractions for deploying containerized web apps on AWS ECS. This article will provide an overview of my experience working with CDK, Terraform and Pulumi and will cover how I use these libraries in automated infrastructure deployment pipelines using GitHub Actions"><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/iac_rosetta_stone_og_image.png"><meta data-n-head="ssr" property="twitter:image" content="https://briancaffey.github.io/static/iac_rosetta_stone_og_image.png"><meta data-n-head="ssr" property="twitter:card" content="summary_large_image"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/4fb1928.js" as="script"><link rel="preload" href="/_nuxt/8bfa011.js" as="script"><link rel="preload" href="/_nuxt/b575c49.js" as="script"><link rel="preload" href="/_nuxt/691d3dd.js" as="script"><link rel="preload" href="/_nuxt/c259e4a.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 507279a1:0 32d0cba6:0 a0fa61ae:0 68e9f29f:0 00a52ce3:0 23961490:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.bg-green-100{--bg-opacity:1;background-color:#f0fff4;background-color:rgba(240,255,244,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.rounded-t-lg{border-top-left-radius:.5rem;border-top-right-radius:.5rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.flex-shrink{flex-shrink:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-4xl{font-size:2.25rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mb-1{margin-bottom:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mt-8{margin-top:2rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-16{padding-left:4rem;padding-right:4rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pb-2{padding-bottom:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-16{grid-gap:4rem;gap:4rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:py-16{padding-top:4rem;padding-bottom:4rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:Montserrat,Arial,Sans Serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto;margin-top:1.5rem;margin-bottom:1.5rem}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 0 0 0 #0e2233;box-shadow:0 0 0 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 0 30px 2px #0e2233;box-shadow:0 0 30px 2px var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-size:smaller}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary);color:#158876;color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{content:" ";margin-top:-85px;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:Montserrat,Arial,Sans Serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-913fe8d6]{padding:0}.selected[data-v-913fe8d6]{text-shadow:.25px 0 0 #000}.picker[data-v-913fe8d6]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-913fe8d6]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-4365f19e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-40f34933]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-40f34933]:hover{transform:scale(1.3)}.modal[data-v-40f34933]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-40f34933],.picker[data-v-40f34933]{position:absolute;left:0}.picker[data-v-40f34933]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.tag[data-v-d8ade784]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-d8ade784]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1708275835/fr/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi/state.js" as="script"><link rel="preload" href="/_nuxt/static/1708275835/fr/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1708275835/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-913fe8d6><div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-913fe8d6><div class="justify-left flex-grow flex-cols-4" data-v-913fe8d6><a href="/fr" class="text-xl nuxt-link-active" data-v-913fe8d6><span class="hidden sm:inline text-2xl" data-v-913fe8d6>Brian Caffey</span><span class="inline sm:hidden" data-v-913fe8d6>JBC</span></a></div> <div class="flex-grow relative" data-v-913fe8d6><nav z-index="10000" data-v-4365f19e data-v-913fe8d6><div data-v-4365f19e><ul class="items-right float-right hidden md:flex" data-v-4365f19e><li class="px-4 text-lg" data-v-4365f19e><a href="/fr/blog/1" data-v-4365f19e>
          Blog
        </a></li> <li class="px-4 text-lg" data-v-4365f19e><a href="/fr/contact" data-v-4365f19e>
          Contact
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-4365f19e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-4365f19e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-4365f19e><title data-v-4365f19e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-4365f19e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-913fe8d6><div class="centered" data-v-288717a6 data-v-913fe8d6><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üñ•Ô∏è, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåû, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåö, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="‚òï, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-40f34933 data-v-288717a6><!----> <ul data-v-40f34933><li class="md:px-1 px-1 cursor-pointer" data-v-40f34933><span aria-label="üá´üá∑, fr, flag-fr" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-40f34933><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-40f34933><a href="/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" data-v-40f34933><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-40f34933></a><a href="/fr/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-40f34933><span aria-label="üá´üá∑, fr, flag-fr" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Fran√ßais <br data-v-40f34933></a><a href="/zh/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" data-v-40f34933><span aria-label="üá®üá≥, cn, flag-cn" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> ÁÆÄ‰Ωì‰∏≠Êñá <br data-v-40f34933></a><a href="/ru/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" data-v-40f34933><span aria-label="üá∑üá∫, ru, flag-ru" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> –†—É—Å—Å–∫–∏–π <br data-v-40f34933></a><a href="/jp/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" data-v-40f34933><span aria-label="üáØüáµ, jp, flag-jp" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> Êó•Êú¨Ë™û <br data-v-40f34933></a><a href="/in/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi" data-v-40f34933><span aria-label="üáÆüá≥, flag-in" class="emoji-mart-emoji" data-v-40f34933><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> ‡§π‡§ø‡§Ç‡§¶‡•Ä <br data-v-40f34933></a></div></div></div></li></ul></div></div></div></div> <article data-v-142b09b6><img src="/static/iac_rosetta_stone_og_image.png" class="pt-2 w-full object-cover cover-image" style="height:32rem" data-v-142b09b6> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-142b09b6><h1 class="prose text-4xl leading-9 py-4 font-bold" data-v-142b09b6>
      My Infrastructure as Code Rosetta Stone - Deploying the same web application on AWS ECS Fargate with CDK, Terraform and Pulumi
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-142b09b6><a href="/fr/blog/tags/django" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    django üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/cdk" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    cdk üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/terraform" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    terraform üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/pulumi" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    pulumi üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/cloudformation" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    cloudformation üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/github-actions" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    github-actions üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/aws" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    aws üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/ecs" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    ecs üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/fargate" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    fargate üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/containers" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    containers üè∑Ô∏è
    <!----></div></a><a href="/fr/blog/tags/docker" data-v-d8ade784 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-d8ade784>
    docker üè∑Ô∏è
    <!----></div></a></div> <div class="flex py-2" data-v-23cbc744 data-v-142b09b6><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://news.ycombinator.com/item?id=34291336" data-v-86c576ca><img src="/icons/hn.png" alt="https://news.ycombinator.com/item?id=34291336" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/" data-v-86c576ca><img src="/icons/reddit.png" alt="https://www.reddit.com/r/aws/comments/105vo53/my_infrastructure_as_code_rosetta_stone_deploying/" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4" data-v-86c576ca><img src="/icons/dev.png" alt="https://dev.to/briancaffey/my-infrastructure-as-code-rosetta-stone-deploying-the-same-web-application-on-aws-ecs-fargate-with-cdk-terraform-and-pulumi-oe4" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a" data-v-86c576ca><img src="/icons/medium.png" alt="https://medium.com/@briancaffey/my-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi-44fcb8233e6a" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions" data-v-86c576ca><img src="/icons/hashnode.png" alt="https://briancaffey.hashnode.dev/setting-up-ad-hoc-development-environments-for-django-applications-with-aws-ecs-terraform-and-github-actions" width="25" class="rounded" data-v-86c576ca></a></div><div class="pr-4 rounded" data-v-86c576ca data-v-23cbc744><a href="https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta" data-v-86c576ca><img src="/icons/substack.png" alt="https://briancaffey.substack.com/p/my-infrastructure-as-code-rosetta" width="25" class="rounded" data-v-86c576ca></a></div></div> <p class="blog-date text-gray-500 mb-4" data-v-142b09b6>
      derni√®re mise √† jour le
      7 janvier 2023
    </p> <!----> <div class="markdown nuxt-content" data-v-142b09b6 data-v-142b09b6><h2 id="tldr" data-v-142b09b6 data-v-142b09b6><a href="#tldr" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>tl;dr</h2>
<p data-v-142b09b6 data-v-142b09b6>I wrote three infrastructure as code libraries for deploying containerized 3-tier web apps on AWS ECS Fargate using CDK, Terraform and Pulumi. This article will provide an overview of my experience working with these three IaC tools and will show how I use my libraries in automated infrastructure deployment pipelines with GitHub Actions.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>CDK Construct Library</strong>: <a href="https://github.com/briancaffey/cdk-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>github.com/briancaffey/cdk-django</a></p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Terraform Modules</strong>: <a href="https://github.com/briancaffey/terraform-aws-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>github.com/briancaffey/terraform-aws-django</a></p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Pulumi Component Library</strong>: <a href="https://github.com/briancaffey/pulumi-aws-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>github.com/briancaffey/pulumi-aws-django</a></p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>Mono repo with a sample Django micro blogging app (Œºblog) and frontend app (Vue SPA written with Quasar), GitHub Action workflows for infrastructure and (separate) application deployment pipelines, IaC code that <em data-v-142b09b6 data-v-142b09b6>consumes</em> each of the libraries listed above, <a href="https://briancaffey.github.io/django-step-by-step/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>VuePress documentation site</a> and miscellaneous items (k6 load testing scripts, Cypress tests, docker-compose, etc.): <a href="https://github.com/briancaffey/django-step-by-step" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>github.com/briancaffey/django-step-by-step</a></p>
</li>
</ul>
<h2 id="eli5" data-v-142b09b6 data-v-142b09b6><a href="#eli5" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>eli5</h2>
<p data-v-142b09b6 data-v-142b09b6>Pretend we are at the beach building sandcastles. We can build sandcastles using our hands, but this takes a lot of time, and we might bump into each other and accidentally knock over part of our sandcastle. I made some tools for building sandcastles. We have one tool for building a sand castle base that includes the wall around the outside, the moat, the door, and different sections inside the walls. And I made another tool for deploying smaller sand \castle houses inside the walls of the sandcastle base. We fill the tool with sand and water and then turn it over inside of our base and we can build an entire city of sandcastles. Also, the tool lets us carefully remove parts of our sandcastle without knocking over any of the other parts. We can share the tool with all of our friends and they can make cool sandcastles too, and the tool is free for them to use.</p>
<p data-v-142b09b6 data-v-142b09b6>Instead of sandcastles, I'm working with computer systems that can power internet applications, like YouTube for example. I'm building tools that can allow me or anyone else to build really awesome internet applications using computers.</p>
<p data-v-142b09b6 data-v-142b09b6>The tools are not physical tools like the ones for building sandcastles, but instead, these tools are made with code. The code for websites like YouTube allows you to upload videos <em data-v-142b09b6 data-v-142b09b6>to YouTube</em>, but the code I'm writing allows you to upload any type of website (even site YouTube) <em data-v-142b09b6 data-v-142b09b6>to the internet</em>. When we run this code, it creates applications on the internet. Also, sand is very expensive and Jeff Bezos owns the beach.</p>
<h2 id="why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi" data-v-142b09b6 data-v-142b09b6><a href="#why-i-made-an-infrastructure-as-code-rosetta-stone-with-cdk-terraform-and-pulumi" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Why I made an Infrastructure as Code Rosetta Stone with CDK, Terraform and Pulumi</h2>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>To push me to learn more about AWS, IaC, CI/CD, automation, and Platform Engineering</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Learn the differences between major IaC tools and how to use them to do exactly the same thing (build a web app) on the same Cloud (AWS) in the same way (serverless container technology using ECS Fargate).</li>
<li data-v-142b09b6 data-v-142b09b6>Get more experience publishing software packages (npm) and finding the right level of abstraction for IaC libraries that is both dynamic and straightforward</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>To fail as many times as possible</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Every time I fail when I think I have things right, I learn something new</li>
<li data-v-142b09b6 data-v-142b09b6>Failed IaC pipelines can sometimes be scary, and every failure I have on these projects can teach me about potential failure modes for live projects running in production</li>
<li data-v-142b09b6 data-v-142b09b6>You can oftentimes be "stuck" where you have a set of resources that you can't update or delete. Learning to get unstuck from these scenarios is important</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>To take an application-first approach to DevOps</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Application developers are increasingly being tasked with operational duties</li>
<li data-v-142b09b6 data-v-142b09b6>While learning about IaC, I had a hard time finding in-depth materials covering application development, CI/CD pipelines, automation, and Infrastructure as Code and how these three knowledge domains work together. There are important considerations to make when  between a Hello World docker image</li>
<li data-v-142b09b6 data-v-142b09b6>You could probably use another framework with these IaC libraries like Flask or Rails, but for now I'm building these projects with Django first-in-mind</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>To develop a project I can reference when helping myself and others</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>companies and projects that do IaC and CI/CD for the most part have things in private repos for obvious reasons, there isn't any good reason to share this type of code unless you are sharing it with an auditor</li>
<li data-v-142b09b6 data-v-142b09b6>Hopefully, the sample application, IaC, and CI/CD pipelines <em data-v-142b09b6 data-v-142b09b6>aren't overly complex</em>. There are more complex examples of open-source companies out there, but their repos have steep learning curves and a lot going on</li>
<li data-v-142b09b6 data-v-142b09b6>People often ask about how to split up IaC deployments and application deployments. I want to be able to use this project to <strong data-v-142b09b6 data-v-142b09b6>show</strong> people how it can be done</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>To encourage others (specifically Developer Advocates / Developer Relations / Solutions Architects in the CDK, Terraform, and Pulumi communities) to share complete and non-trivial examples of IaC software <strong data-v-142b09b6 data-v-142b09b6>in use</strong> with an actual application.</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>There are many ways one could create an "IaC Rosetta Stone" (<code data-v-142b09b6 data-v-142b09b6>public cloud providers x CI/CD providers x IaC tools</code> is a big number)</li>
<li data-v-142b09b6 data-v-142b09b6>This takes a lot of effort and time</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>I have nothing to sell you</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>So many articles about Cloud/DevOps are trying to sell you a tool. Outside of what I consider to be mainstream vendors like GitHub and AWS, there are no products that I'm promoting here</li>
<li data-v-142b09b6 data-v-142b09b6>I'm also not trying to sell anyone on using my IaC packages</li>
<li data-v-142b09b6 data-v-142b09b6>Hopefully, my IaC packages can serve as a helpful reference or starting point</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Walk before running</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>I want to build up confidence with vanilla use cases before getting too fancy</li>
<li data-v-142b09b6 data-v-142b09b6>With a solid foundation in these tools, I want to learn about some of the more advanced patterns teams are adopting (Pulumi Automation API, Terragrunt for Terraform, self-mutating CDK Pipelines)</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>12 Factor App, DevOps, and Platform Engineering</strong></p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6><a href="https://12factor.net/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>12 Factor App</a> is great and has guided how I approach both Django application development and IaC library development</li>
<li data-v-142b09b6 data-v-142b09b6>The <a href="https://platformengineering.org/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>platformengineering.org</a> community has some good guiding principles</li>
</ul>
<h2 id="cdkterraformpulumi-terminology" data-v-142b09b6 data-v-142b09b6><a href="#cdkterraformpulumi-terminology" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>CDK/Terraform/Pulumi terminology</h2>
<h3 id="constructs-modules-and-components" data-v-142b09b6 data-v-142b09b6><a href="#constructs-modules-and-components" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>constructs, modules and components</h3>
<p data-v-142b09b6 data-v-142b09b6>A CDK construct, Terraform module and Pulumi component generally mean the same thing: an abstract grouping of one or more cloud resources.</p>
<p data-v-142b09b6 data-v-142b09b6>In this article I will refer to <strong data-v-142b09b6 data-v-142b09b6>constructs/modules/components</strong> as <strong data-v-142b09b6 data-v-142b09b6>c/m/c</strong> for short, and the term <strong data-v-142b09b6 data-v-142b09b6>stack</strong> can generally be used to refer to either a CloudFormation stack, a Pulumi Stack or a Terraform group of resources that are part of a module that has had <code data-v-142b09b6 data-v-142b09b6>apply</code> ran against it.</p>
<h3 id="what-is-a-stack" data-v-142b09b6 data-v-142b09b6><a href="#what-is-a-stack" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>what is a stack?</h3>
<p data-v-142b09b6 data-v-142b09b6>AWS has a resource type called CloudFormation Stacks, and Pulumi also has a concept of stacks. Terraform documentation doesn't refer to stacks, and instead in Terraform docs use the words "Terraform configuration" to refer to some group of resources that were built using a module.</p>
<p data-v-142b09b6 data-v-142b09b6>CDK Constructs and Pulumi Components are somewhat similar, however CDK Constructs map to CloudFormation and the Pulumi components I'm using from the <code data-v-142b09b6 data-v-142b09b6>@pulumi/aws</code> package generally map directly to Terraform resources from the AWS Provider (the Pulumi AWS Provider uses much of the same code that the Terraform AWS Provider uses).</p>
<h3 id="verbs" data-v-142b09b6 data-v-142b09b6><a href="#verbs" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>verbs</h3>
<p data-v-142b09b6 data-v-142b09b6>In CDK you <code data-v-142b09b6 data-v-142b09b6>synth</code> CDK code to generate CloudFormation templates. You can also run <code data-v-142b09b6 data-v-142b09b6>diff</code> to see what changes would be applied during a stack update.</p>
<p data-v-142b09b6 data-v-142b09b6>In Terraform you <code data-v-142b09b6 data-v-142b09b6>init</code> to download all providers and modules. This is sort of like running <code data-v-142b09b6 data-v-142b09b6>npm install</code> in CDK and Pulumi. You then run <code data-v-142b09b6 data-v-142b09b6>terraform plan</code> to see the changes that would result. <code data-v-142b09b6 data-v-142b09b6>terraform apply</code> does CRUD operations on your cloud resources.</p>
<p data-v-142b09b6 data-v-142b09b6>In Pulumi you run <code data-v-142b09b6 data-v-142b09b6>pulumi preview</code> to see what changes would be made to a stack. You can use the <code data-v-142b09b6 data-v-142b09b6>--diff</code> flag to see the specifics of what would change.</p>
<p data-v-142b09b6 data-v-142b09b6>To summarize:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>In CDK you synth CloudFormation and use these templates to deploy stacks made up of constructs. An "app" can contain multiple stacks, and you can deploy one or more stacks in an app at a time</li>
<li data-v-142b09b6 data-v-142b09b6>In Terraform you plan a configuration made up of modules, and then run <code data-v-142b09b6 data-v-142b09b6>terraform apply</code> to build the configuration/stack (<a href="https://discuss.hashicorp.com/t/what-is-a-terraform-stack/31985" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>discuss.hashicorp.com/t/what-is-a-terraform-stack/31985</a>)</li>
<li data-v-142b09b6 data-v-142b09b6>Pulumi: You preview a Pulumi stack made up of components, and then run <code data-v-142b09b6 data-v-142b09b6>pulumi up</code> to build the resources</li>
<li data-v-142b09b6 data-v-142b09b6>To tear down a stack in all three tools, you run <code data-v-142b09b6 data-v-142b09b6>destroy</code></li>
</ul>
<h2 id="infrastructure-as-code-library-repos" data-v-142b09b6 data-v-142b09b6><a href="#infrastructure-as-code-library-repos" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Infrastructure as Code library repos</h2>
<p data-v-142b09b6 data-v-142b09b6>Let's look at the three repos that I wrote for deploying the same type of 3-tier web application to AWS using ECS Fargate.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>CDK: <a href="https://github.com/briancaffey/cdk-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>cdk-django</code></a></li>
<li data-v-142b09b6 data-v-142b09b6>Terraform: <a href="https://github.com/briancaffey/terraform-aws-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code></a></li>
<li data-v-142b09b6 data-v-142b09b6>Pulumi: <a href="https://github.com/briancaffey/pulumi-aws-django" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code></a></li>
</ul>
<h3 id="language" data-v-142b09b6 data-v-142b09b6><a href="#language" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Language</h3>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>cdk-django</code> and <code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code> are both written in TypeScript. <code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code> is written in HCL, a domain specific language created by HashiCorp. The <code data-v-142b09b6 data-v-142b09b6>cdk-django</code> is published to both npm and PyPI, so you can use it in JavaScript, TypeScript and Python projects, other languages are supported as well, but you need to write your library in TypeScript so it can be transpiled to other languages using <a href="https://github.com/aws/jsii" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>jsii</a>.</p>
<p data-v-142b09b6 data-v-142b09b6>My Pulumi library is written in TypeScript and is published to NPM. For now it can only be used in JavaScript and TypeScript projects. There is a way in Pulumi to write in any language and then publish to any other major language, but I haven't  done this yet. See <a href="https://github.com/pulumi/pulumi-component-provider-ts-boilerplate" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>this GitHub repo</a> for more information on this.</p>
<p data-v-142b09b6 data-v-142b09b6>The HCL is pretty simple when you get used to it. I find that I don't like adding lots of logic in Terraform code because it takes away from the readability of a module. There is a tool called <a href="https://developer.hashicorp.com/terraform/cdktf" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>CDKTF</a> which allows you to write HCL Terraform in TypeScript, but I haven't used it yet.</p>
<h3 id="release-management-versioning-and-publishing" data-v-142b09b6 data-v-142b09b6><a href="#release-management-versioning-and-publishing" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Release management, versioning and publishing</h3>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code> and <code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code> both use <code data-v-142b09b6 data-v-142b09b6>release-please</code> for automatically generating a changelog file and bumping versions. <code data-v-142b09b6 data-v-142b09b6>release-please</code> is an open source tool from Google that they use to version their Terraform GCP modules. Whenever I push new commits to <code data-v-142b09b6 data-v-142b09b6>main</code>, a new PR is created that adds changes to the CHANGELOG.md file, bumps the version of the library in <code data-v-142b09b6 data-v-142b09b6>package.json</code> and adds a new git tag (e.g. <code data-v-142b09b6 data-v-142b09b6>v1.2.3</code>) based on commit messages.</p>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>cdk-django</code> uses <a href="https://github.com/projen/projen" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>projen</code></a> for maintaining the changelog and bumping versions and publishing to npm. It is popular among developers in the CDK community and is a really awesome tool since it basically uses one file (<code data-v-142b09b6 data-v-142b09b6>.projenrc.ts</code>) to configure your entire repo, including files like <code data-v-142b09b6 data-v-142b09b6>tsconfig.json</code>, <code data-v-142b09b6 data-v-142b09b6>package.json</code>, and even GitHub Action workflows. It has a lot of configuration options, but I'm using it in a pretty simple way. It generates a new release and items to the changelog when I manually trigger a GitHub Action.</p>
<p data-v-142b09b6 data-v-142b09b6>These tools are both based on <a href="https://www.conventionalcommits.org/en/v1.0.0/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>conventional commits</a> to automatically update the Changelog file.</p>
<p data-v-142b09b6 data-v-142b09b6>I'm still manually publishing my <code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code> package from the CLI. I need to add a GitHub Action to do this for me. This and other backlog items are listed at the end of the article!</p>
<h3 id="makefile-examples-and-local-development" data-v-142b09b6 data-v-142b09b6><a href="#makefile-examples-and-local-development" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Makefile, examples and local development</h3>
<p data-v-142b09b6 data-v-142b09b6>Each repo has a Makefile that includes commands that I frequently use when developing new features or fixing bugs. Each repo has commands for the following:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>synthesizing CDK to CloudFormation / running <code data-v-142b09b6 data-v-142b09b6>terraform plan</code> / previewing pulumi up for both the base and app stacks</li>
<li data-v-142b09b6 data-v-142b09b6>creating/updating an ad hoc base stack called <code data-v-142b09b6 data-v-142b09b6>dev</code></li>
<li data-v-142b09b6 data-v-142b09b6>destroying resources in the ad-hoc base stack called <code data-v-142b09b6 data-v-142b09b6>dev</code></li>
<li data-v-142b09b6 data-v-142b09b6>creating an ad hoc app stack called <code data-v-142b09b6 data-v-142b09b6>alpha</code> that uses resources from <code data-v-142b09b6 data-v-142b09b6>dev</code></li>
<li data-v-142b09b6 data-v-142b09b6>destroying an ad hoc app stack called <code data-v-142b09b6 data-v-142b09b6>alpha</code> that uses resources from <code data-v-142b09b6 data-v-142b09b6>dev</code></li>
<li data-v-142b09b6 data-v-142b09b6>creating/updating a prod base stack called <code data-v-142b09b6 data-v-142b09b6>stage</code></li>
<li data-v-142b09b6 data-v-142b09b6>destroying resources in the prod base stack called <code data-v-142b09b6 data-v-142b09b6>stage</code></li>
<li data-v-142b09b6 data-v-142b09b6>creating a prod app stack using called <code data-v-142b09b6 data-v-142b09b6>stage</code> that uses resources from the <code data-v-142b09b6 data-v-142b09b6>stage</code> base stack</li>
<li data-v-142b09b6 data-v-142b09b6>destroying resources in the prod app stack called <code data-v-142b09b6 data-v-142b09b6>stage</code></li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Here's an example of what these commands look like in <code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code> for prod infrastructure base and app stacks:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>prod-base-preview:  build
    pulumi -C examples/prod/base --stack stage --non-interactive preview

prod-base-up:   build
    pulumi -C examples/prod/base --stack stage --non-interactive up --yes

prod-base-destroy:  build
    pulumi -C examples/prod/base --stack stage --non-interactive destroy --yes

prod-app-preview:   build
    pulumi -C examples/prod/app --stack stage --non-interactive preview

prod-app-preview-diff:  build
    pulumi -C examples/prod/app --stack stage --non-interactive preview --diff

prod-app-up:    build
    pulumi -C examples/prod/app --stack stage --non-interactive up --yes

prod-app-destroy:   build
    pulumi -C examples/prod/app --stack stage --non-interactive destroy --yes
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>I currently don't have tests for all of these libraries, but for now the most effective way of testing that things are working correctly is to use the <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s to create environments and smoke check the environments to make sure everything works correctly.</p>
<p data-v-142b09b6 data-v-142b09b6>Adding unit tests is another item for the backlog.</p>
<h3 id="ad-hoc-vs-prod" data-v-142b09b6 data-v-142b09b6><a href="#ad-hoc-vs-prod" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>ad-hoc vs prod</h3>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6><a href="https://briancaffey.github.io/2022/03/27/ad-hoc-developer-environments-for-django-with-aws-ecs-terraform-and-github-actions" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>the last article I wrote was about ad hoc environments</a>. Also known as "on-demand" environments or "preview" environments.</li>
<li data-v-142b09b6 data-v-142b09b6>the motivation for using ad-hoc environments is speed and cost (you can stand up an environment in less time and you share the costs of the base environment, including VPC, ALB, RDS)</li>
<li data-v-142b09b6 data-v-142b09b6>you can completely ignore "ad-hoc" environments and use the "prod" infrastructure for any number of environments (such as dev, QA, RC, stage and prod)</li>
<li data-v-142b09b6 data-v-142b09b6>prod can be used for a production environment and any number of pre-production environments</li>
<li data-v-142b09b6 data-v-142b09b6>multiple environments built with "prod" infrastructure can be configured with a "knobs and dials" (e.g., how big are app and DB instances, how many tasks to run in a service, etc.)</li>
<li data-v-142b09b6 data-v-142b09b6>the "prod" infrastructure should be the same for the "production" environment and the "staging" environment</li>
</ul>
<h3 id="directory-structure" data-v-142b09b6 data-v-142b09b6><a href="#directory-structure" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Directory structure</h3>
<p data-v-142b09b6 data-v-142b09b6>The directory structures for each repo are all similar with some minor differences.</p>
<p data-v-142b09b6 data-v-142b09b6>There are two types of environments: <code data-v-142b09b6 data-v-142b09b6>ad-hoc</code> and <code data-v-142b09b6 data-v-142b09b6>prod</code>. Within ad-hoc and production, there are two directories <code data-v-142b09b6 data-v-142b09b6>base</code> and <code data-v-142b09b6 data-v-142b09b6>app</code>.</p>
<p data-v-142b09b6 data-v-142b09b6>Each repo has a directory called <code data-v-142b09b6 data-v-142b09b6>internal</code> which contain building blocks used by the <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s that are exposed. The contents of the <code data-v-142b09b6 data-v-142b09b6>internal</code> directories are not intended to be used by anyone who is using the libraries.</p>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>CDK construct library repo structure</strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/cdk-django$ tree -L 4 -d src/
src/
‚îú‚îÄ‚îÄ constructs
‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base
‚îÇ   ‚îú‚îÄ‚îÄ internal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alb
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bastion
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customResources
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ highestPriorityRule
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iam
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management-command
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduler
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ web
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ worker
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rds
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vpc
‚îÇ   ‚îî‚îÄ‚îÄ prod
‚îÇ       ‚îú‚îÄ‚îÄ app
‚îÇ       ‚îî‚îÄ‚îÄ base
‚îî‚îÄ‚îÄ examples
    ‚îî‚îÄ‚îÄ ad-hoc
        ‚îú‚îÄ‚îÄ app
        ‚îÇ   ‚îî‚îÄ‚îÄ config
        ‚îî‚îÄ‚îÄ base
            ‚îî‚îÄ‚îÄ config
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Terraform module library repo structure</strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/terraform-aws-django$ tree -L 4 -d modules
modules
‚îú‚îÄ‚îÄ ad-hoc
‚îÇ   ‚îú‚îÄ‚îÄ app
‚îÇ   ‚îî‚îÄ‚îÄ base
‚îú‚îÄ‚îÄ internal
‚îÇ   ‚îú‚îÄ‚îÄ alb
‚îÇ   ‚îú‚îÄ‚îÄ autoscaling
‚îÇ   ‚îú‚îÄ‚îÄ bastion
‚îÇ   ‚îú‚îÄ‚îÄ ecs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_beat
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ celery_worker
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cluster
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management_command
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ web
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prod
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_beat
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ celery_worker
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cluster
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ management_command
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ web
‚îÇ   ‚îú‚îÄ‚îÄ elasticache
‚îÇ   ‚îú‚îÄ‚îÄ iam
‚îÇ   ‚îú‚îÄ‚îÄ rds
‚îÇ   ‚îú‚îÄ‚îÄ route53
‚îÇ   ‚îú‚îÄ‚îÄ s3
‚îÇ   ‚îú‚îÄ‚îÄ sd
‚îÇ   ‚îî‚îÄ‚îÄ sg
‚îî‚îÄ‚îÄ prod
    ‚îú‚îÄ‚îÄ app
    ‚îî‚îÄ‚îÄ base
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Pulumi component library repo structure</strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/pulumi-aws-django$ tree -L 3 src/
src/
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ ad-hoc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base
‚îÇ   ‚îî‚îÄ‚îÄ internal
‚îÇ       ‚îú‚îÄ‚îÄ README.md
‚îÇ       ‚îú‚îÄ‚îÄ alb
‚îÇ       ‚îú‚îÄ‚îÄ bastion
‚îÇ       ‚îú‚îÄ‚îÄ cw
‚îÇ       ‚îú‚îÄ‚îÄ ecs
‚îÇ       ‚îú‚îÄ‚îÄ iam
‚îÇ       ‚îú‚îÄ‚îÄ rds
‚îÇ       ‚îî‚îÄ‚îÄ sg
‚îî‚îÄ‚îÄ util
    ‚îú‚îÄ‚îÄ index.ts
    ‚îî‚îÄ‚îÄ taggable.ts
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6>Pulumi examples directory</strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/pulumi-aws-django$ tree -L 3 examples/
examples/
‚îî‚îÄ‚îÄ ad-hoc
    ‚îú‚îÄ‚îÄ app
    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.alpha.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ Pulumi.yaml
    ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ node_modules
    ‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json
    ‚îÇ   ‚îú‚îÄ‚îÄ package.json
    ‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json
    ‚îî‚îÄ‚îÄ base
        ‚îú‚îÄ‚îÄ Pulumi.yaml
        ‚îú‚îÄ‚îÄ bin
        ‚îú‚îÄ‚îÄ index.ts
        ‚îú‚îÄ‚îÄ package-lock.json
        ‚îú‚îÄ‚îÄ package.json
        ‚îî‚îÄ‚îÄ tsconfig.json
</code></pre></div>
<h3 id="cloc" data-v-142b09b6 data-v-142b09b6><a href="#cloc" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>CLOC</h3>
<p data-v-142b09b6 data-v-142b09b6>Let's use CLOC (count lines of code) to compare the lines of code used in the <code data-v-142b09b6 data-v-142b09b6>c/m/c</code> of CDK/CloudFormation/Terraform/Pulumi.</p>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>cdk-django</code></strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/cdk-django$ cloc src/constructs/
      14 text files.
      14 unique files.
       0 files ignored.

github.com/AlDanial/cloc v 1.94  T=0.04 s (356.1 files/s, 30040.9 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
TypeScript                      13            155             59            908
Python                           1             18              8             33
-------------------------------------------------------------------------------
SUM:                            14            173             67            941
-------------------------------------------------------------------------------
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code></strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/terraform-aws-django$ cloc modules/
      68 text files.
      58 unique files.
      11 files ignored.

github.com/AlDanial/cloc v 1.94  T=0.15 s (385.9 files/s, 20585.1 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
HCL                             55            472            205           2390
Markdown                         3              7              0             20
-------------------------------------------------------------------------------
SUM:                            58            479            205           2410
-------------------------------------------------------------------------------
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6><strong data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code></strong></p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>~/git/github/pulumi-aws-django$ cloc src/components/
      15 text files.
      15 unique files.
       0 files ignored.

github.com/AlDanial/cloc v 1.94  T=0.11 s (134.5 files/s, 12924.2 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
TypeScript                      13            110            176           1119
Markdown                         2              6              0             30
-------------------------------------------------------------------------------
SUM:                            15            116            176           1149
-------------------------------------------------------------------------------
</code></pre></div>
<h2 id="communities" data-v-142b09b6 data-v-142b09b6><a href="#communities" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Communities</h2>
<p data-v-142b09b6 data-v-142b09b6>The CDK, Terraform and Pulumi communities are all great and a lot of people helped when I got stuck on issues writing these libraries. Thank you!</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6><a href="https://cdk.dev/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>cdk.dev</a></li>
<li data-v-142b09b6 data-v-142b09b6><a href="https://discuss.hashicorp.com/c/terraform-core/27" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>Terraform Section of HashiCorp Discuss Forum</a></li>
<li data-v-142b09b6 data-v-142b09b6><a href="https://slack.pulumi.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>Pulumi Slack</a></li>
</ul>
<h2 id="Œºblog" data-v-142b09b6 data-v-142b09b6><a href="#%CE%BCblog" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Œºblog</h2>
<p data-v-142b09b6 data-v-142b09b6>Œºblog is a micro blogging application that I have written using Django and Vue.js. Here's a screenshot of the homepage:</p>
<p data-v-142b09b6 data-v-142b09b6><img alt="ublog" src="/static/ublog_screenshot.png" data-v-142b09b6 data-v-142b09b6></p>
<p data-v-142b09b6 data-v-142b09b6>It is a pretty simple app. Users can write posts with text and an optional images. Logged in users can write posts and like posts.</p>
<h3 id="mono-repo-structure" data-v-142b09b6 data-v-142b09b6><a href="#mono-repo-structure" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Mono-repo structure</h3>
<p data-v-142b09b6 data-v-142b09b6>It lives in a GitHub mono repo called <code data-v-142b09b6 data-v-142b09b6>django-step-by-step</code>. This mono repo contains a few different things:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>backend Django application</li>
<li data-v-142b09b6 data-v-142b09b6>frontend Vue.js application</li>
<li data-v-142b09b6 data-v-142b09b6>IaC code that uses c/m/c from <code data-v-142b09b6 data-v-142b09b6>cdk-django</code>, <code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code> and <code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code></li>
<li data-v-142b09b6 data-v-142b09b6>GitHub Actions workflows for both Infrastructure deployments and application deployments</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Œºblog is the reference application that I deploy to infrastructure created with CDK, Terraform and Pulumi. Œºblog is meant to represent a generic 12 Factor application that uses:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>gunicorn for a backend API</li>
<li data-v-142b09b6 data-v-142b09b6>Vue.js for a client that consumes the backend API</li>
<li data-v-142b09b6 data-v-142b09b6>celery for async task processing</li>
<li data-v-142b09b6 data-v-142b09b6>celery beat for scheduling tasks</li>
<li data-v-142b09b6 data-v-142b09b6>Postgres for relational data</li>
<li data-v-142b09b6 data-v-142b09b6>Redis for caching and message brokering</li>
<li data-v-142b09b6 data-v-142b09b6>S3 for object storage</li>
<li data-v-142b09b6 data-v-142b09b6>Django admin for a simple admin interface</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>There is a lot more I could add on Œºblog. For now I'll just mention that it:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>has a great local development environment (supports both docker-compose and virtual environments)</li>
<li data-v-142b09b6 data-v-142b09b6>demonstrates how to use Django in different ways. It implements the same application using Function Based View and Class Based Views, and implements both a REST API (both with FBV and CBV) and GraphQL.</li>
<li data-v-142b09b6 data-v-142b09b6>GitHub Actions for running unit tests</li>
<li data-v-142b09b6 data-v-142b09b6>k6 for load testing</li>
<li data-v-142b09b6 data-v-142b09b6>contains a documentation site deployed to GitHub pages (made with VuePress) can be found here: <a href="https://briancaffey.github.io/django-step-by-step/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>https://briancaffey.github.io/django-step-by-step/</a></li>
</ul>
<h1 id="infrastructure-deep-dive" data-v-142b09b6 data-v-142b09b6><a href="#infrastructure-deep-dive" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Infrastructure Deep Dive</h1>
<p data-v-142b09b6 data-v-142b09b6>Let's go through each of the <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s used in the three libraries. I'll cover some of the organizational decisions, dependencies and differences between how things are done between CDK, Terraform and Pulumi.</p>
<p data-v-142b09b6 data-v-142b09b6>I'll first talk about the two stacks used in ad hoc environments: <code data-v-142b09b6 data-v-142b09b6>base</code> and <code data-v-142b09b6 data-v-142b09b6>app</code>. Then I'll talk about the prod environments which are also composed of <code data-v-142b09b6 data-v-142b09b6>base</code> and <code data-v-142b09b6 data-v-142b09b6>app</code> stacks.</p>
<p data-v-142b09b6 data-v-142b09b6>Keep in mind that there aren't that many differences between the ad hoc environment base and app stacks and the prod environment app and base stacks. A future optimization could be to use a single base and app stack, but I think there is a trade-off between readability and DRYness of infrastructure code, <strong data-v-142b09b6 data-v-142b09b6>especially with Terraform</strong>. In general I try to use very little conditionals and logic with Terraform code. It is much easier to have dynamic configuration in CDK and Pulumi, and probably also for other tools like CDKTF (that I have not yet tried).</p>
<h2 id="splitting-up-the-stacks" data-v-142b09b6 data-v-142b09b6><a href="#splitting-up-the-stacks" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Splitting up the stacks</h2>
<p data-v-142b09b6 data-v-142b09b6>While it is possible to put all resources in a single stack with both Terraform, CDK and Pulumi, it is not recommended to do so.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Terraform enables this with outputs and <code data-v-142b09b6 data-v-142b09b6>terraform_remote_state</code></li>
<li data-v-142b09b6 data-v-142b09b6>Pulumi encourages the use of <a href="https://www.pulumi.com/docs/guides/organizing-projects-stacks/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>micro stacks</a></li>
<li data-v-142b09b6 data-v-142b09b6>CDK has an article on how to <a href="https://docs.aws.amazon.com/cdk/v2/guide/stack_how_to_create_multiple_stacks.html" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>create an app with multiple stacks</a></li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>My design decision was to keep things limited to 2 stacks. Later on it would be interesting to try splitting out another stack.</p>
<p data-v-142b09b6 data-v-142b09b6>Also, on-demand environments really lends itself to stacks that are split up.</p>
<p data-v-142b09b6 data-v-142b09b6>In the section <a href="https://docs.aws.amazon.com/cdk/v2/guide/resources.html" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>"Passing unique identifiers"</a>, the CDK recommends that we keep the two stacks in the same app. In Terraform and Pulumi, each stack environment is in its own app.</p>
<p data-v-142b09b6 data-v-142b09b6>There is a balance to be found between single stacks vs micro stacks. Both the base and app <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s could be split out further. For example, the <code data-v-142b09b6 data-v-142b09b6>base</code> <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s could be split into <code data-v-142b09b6 data-v-142b09b6>networking</code> and <code data-v-142b09b6 data-v-142b09b6>rds</code>. The <code data-v-142b09b6 data-v-142b09b6>app</code> stack could be split into different ECS services so that their infrastructure can be deployed independently, like <code data-v-142b09b6 data-v-142b09b6>cluster</code>, <code data-v-142b09b6 data-v-142b09b6>backend</code> and <code data-v-142b09b6 data-v-142b09b6>frontend</code>. The more resources that a stack has, the longer it takes to deploy and the more risky it gets, but adding lots of stacks can add to mental overhead, and pipeline complexity. Each tool has ways of dealing with these complexities (CDK Pipelines, Terragrunt, Pulumi Automation API), but I won't be getting into any of these options in this article. I would like to try these out and share in a future article.</p>
<p data-v-142b09b6 data-v-142b09b6>My rules of thumbs are:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>single stacks are bad because you don't want to put all your eggs in one basket, however your IaC tool should give you confidence about what is going to change when you try to make a change</li>
<li data-v-142b09b6 data-v-142b09b6>Lots of small stacks can cause overhead and make things more complex than they need to be</li>
</ul>
<h2 id="ad-hoc-base-overview" data-v-142b09b6 data-v-142b09b6><a href="#ad-hoc-base-overview" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Ad hoc base overview</h2>
<p data-v-142b09b6 data-v-142b09b6>Here's an overview of the resources used in an ad hoc base environment.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>(Inputs)</li>
<li data-v-142b09b6 data-v-142b09b6>(Optional environment configs)</li>
<li data-v-142b09b6 data-v-142b09b6>VPC and Service Discovery</li>
<li data-v-142b09b6 data-v-142b09b6>S3</li>
<li data-v-142b09b6 data-v-142b09b6>Security Groups</li>
<li data-v-142b09b6 data-v-142b09b6>Load Balancer</li>
<li data-v-142b09b6 data-v-142b09b6>RDS</li>
<li data-v-142b09b6 data-v-142b09b6>Bastion Host</li>
</ul>
<h3 id="visualization" data-v-142b09b6 data-v-142b09b6><a href="#visualization" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Visualization</h3>
<p data-v-142b09b6 data-v-142b09b6>Here's a dependency graph showing all of the resources in ad hoc base stack. This can be found on the <code data-v-142b09b6 data-v-142b09b6>Resources</code> tab of the ad hoc base stack in the Pulumi console.</p>
<p data-v-142b09b6 data-v-142b09b6><img alt="Graph view of ad hoc base infrastructure" src="/static/pulumi_ad_hoc_base_dep_graph.png" data-v-142b09b6 data-v-142b09b6></p>
<h3 id="inputs" data-v-142b09b6 data-v-142b09b6><a href="#inputs" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Inputs</h3>
<p data-v-142b09b6 data-v-142b09b6>There are only two required inputs for the ad hoc base stack</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>ACM certificate ARN</li>
<li data-v-142b09b6 data-v-142b09b6>Domain Name</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>I store these values in environment variables for the pipelines in CDK, Terraform and Pulumi. When running pipelines from my local environment, they are exported in my shell before running deploy/apply/up or synth/plan/preview.</p>
<h3 id="vpc" data-v-142b09b6 data-v-142b09b6><a href="#vpc" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>VPC</h3>
<p data-v-142b09b6 data-v-142b09b6>The VPC is the first resource that is created as part of the <code data-v-142b09b6 data-v-142b09b6>base</code> stack. There official, high-level constructs in each IaC tool for building VPCs and all related networking resources.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>awsx</code> has a VPC module</li>
<li data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>terraform-aws-vpc</code> module</li>
<li data-v-142b09b6 data-v-142b09b6>L2 VPC Construct in CDK</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>The setting in the Terraform VPC module <code data-v-142b09b6 data-v-142b09b6>one_nat_gateway_per_az = false</code> doesn't seem to exist on the <code data-v-142b09b6 data-v-142b09b6>awsx.ec2.Vpc</code> module. This will add to cost savings since it will use 1 NAT Gateway instead of 2 or 3.</p>
<h3 id="security-groups" data-v-142b09b6 data-v-142b09b6><a href="#security-groups" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Security Groups</h3>
<p data-v-142b09b6 data-v-142b09b6>Pulumi and Terraform can be used in a similar way to define security groups. CDK has a much more concise option for defining ingress and egress rules for security groups.</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> albSecurityGroup <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>SecurityGroup</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>scope<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'AlbSecurityGroup'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
      vpc<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>vpc<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

    albSecurityGroup<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>addIngressRule</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>Peer<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>anyIpv4</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> Port<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>tcp</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token number" data-v-142b09b6 data-v-142b09b6>443</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'HTTPS'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
    albSecurityGroup<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>addIngressRule</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>Peer<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>anyIpv4</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> Port<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>tcp</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token number" data-v-142b09b6 data-v-142b09b6>80</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'HTTP'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<h3 id="load-balancer-resources" data-v-142b09b6 data-v-142b09b6><a href="#load-balancer-resources" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Load Balancer Resources</h3>
<p data-v-142b09b6 data-v-142b09b6>There's not much to comment on here. In each library I have resource group that defines the following:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Application Load Balancer</li>
<li data-v-142b09b6 data-v-142b09b6>A default target group</li>
<li data-v-142b09b6 data-v-142b09b6>An HTTP listener that redirects to HTTPS</li>
<li data-v-142b09b6 data-v-142b09b6>An HTTPS listener with a default "fixed-response" action</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Properties from these resources are used in the "app" stack to build listener rules for ECS services that are configured with load balancers, such as the backend and frontend web services.</p>
<p data-v-142b09b6 data-v-142b09b6>Ad hoc app environments all share a common load balancer from the base stack that they use.</p>
<h3 id="rds-resources" data-v-142b09b6 data-v-142b09b6><a href="#rds-resources" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>RDS Resources</h3>
<p data-v-142b09b6 data-v-142b09b6>All three libraries have the RDS security group and Subnet Group in the same <code data-v-142b09b6 data-v-142b09b6>c/m/c</code> as the RDS instance. The SG and DB Subnet group could alternatively be grouped closer to the other network resources.</p>
<p data-v-142b09b6 data-v-142b09b6>Currently the RDS resources are part of the "base" stack for each library. A future optimization may be to break the RDS instance out of the "base" stack and put it in its own stack. The "RDS" stack would be dependent on the "base" stack, and then "app" stack would then be dependent on both the "base" stack and the "RDS" stack. More stacks isn't necessarily a bad thing, but for my initial implementation of these libraries I have decided to keep the "micro stacks" approach limited to only 2 stacks for an environment.</p>
<p data-v-142b09b6 data-v-142b09b6>The way that database secrets are handled is another difference between CDK and Terraform and Pulumi. I am currently "hardcoding" the RDS password for Terraform and Pulumi, and in CDK I am using a Secrets Manager Secret for the database credential.</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> secret <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>Secret</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>scope<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'dbSecret'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
      secretName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>dbSecretName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
      description<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'secret for rds'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
      generateSecretString<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
        secretStringTemplate<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token constant" data-v-142b09b6 data-v-142b09b6>JSON</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>stringify</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> username<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'postgres'</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
        generateStringKey<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'password'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
        excludePunctuation<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token boolean" data-v-142b09b6 data-v-142b09b6>true</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
        includeSpace<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token boolean" data-v-142b09b6 data-v-142b09b6>false</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
      <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>In the <code data-v-142b09b6 data-v-142b09b6>DatabaseInstance</code> props we can then use this secret like so:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    credentials: Credentials.fromSecret(secret),
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>In the application deployed with CDK, I use a Django settings module package that uses a package called <code data-v-142b09b6 data-v-142b09b6>aws_secretsmanager_caching</code> to get and cache the secrets manager secret for the database, whereas in the apps deployed with Terraform and Pulumi I read in the password from an environment variable.</p>
<p data-v-142b09b6 data-v-142b09b6>The Terraform and Pulumi database instance arguments simply accept a <code data-v-142b09b6 data-v-142b09b6>password</code> field. This will be another item for the backlog for Terraform and Pulumi. The <a href="https://www.pulumi.com/registry/packages/random/api-docs/randompassword/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>randompassword</code></a> and <a href="https://www.pulumi.com/registry/packages/aws/api-docs/secretsmanager/secretversion/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>secretversion</code></a> components can be used to do this.</p>
<h3 id="bastion-host" data-v-142b09b6 data-v-142b09b6><a href="#bastion-host" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Bastion Host</h3>
<p data-v-142b09b6 data-v-142b09b6>There are two main use cases for the bastion host in ad-hoc environments.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>When creating a new ad hoc app environment, the bastion host is used to create a new database called <code data-v-142b09b6 data-v-142b09b6>{ad-hoc-env-name}-db</code> that the new ad hoc environment will use. (There might be another way of doing this, but using a bastion host is working well for now).</p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>If you using a database management tool on you local machine like DBeaver, the bastion host can help you connect to the RDS instance in a private subnet. The bastion host instance is configured to run a service that forwards traffic on port 5432 to the RDS instance. If you port forward from your local machine to the bastion host on port 5432, you can connect RDS by simple connecting to <code data-v-142b09b6 data-v-142b09b6>localhost:5432</code> on your local machine.</p>
</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>You don't need to manage SSH keys since you connect to the instance in a private subnet using SSM:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-bash" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>aws ssm start-session --target <span class="token variable" data-v-142b09b6 data-v-142b09b6>$INSTANCE_ID</span>
</code></pre></div>
<h3 id="outputs" data-v-142b09b6 data-v-142b09b6><a href="#outputs" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Outputs</h3>
<p data-v-142b09b6 data-v-142b09b6>Here are the outputs for the ad hoc base stack used in Terraform and Pulumi:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>vpc_id</li>
<li data-v-142b09b6 data-v-142b09b6>assets_bucket_name</li>
<li data-v-142b09b6 data-v-142b09b6>private_subnet_ids</li>
<li data-v-142b09b6 data-v-142b09b6>app_sg_id</li>
<li data-v-142b09b6 data-v-142b09b6>alb_sg_id</li>
<li data-v-142b09b6 data-v-142b09b6>listener_arn</li>
<li data-v-142b09b6 data-v-142b09b6>alb_dns_name</li>
<li data-v-142b09b6 data-v-142b09b6>task_role_arn</li>
<li data-v-142b09b6 data-v-142b09b6>execution_role_arn</li>
<li data-v-142b09b6 data-v-142b09b6>rds_address</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>In CDK, the stack references in the app stack don't reference the unique identifiers from the base stack (such as the VPC id or bastion host instance id), but instead they reference the properties of the stack which have types like <code data-v-142b09b6 data-v-142b09b6>Vpc</code> and <code data-v-142b09b6 data-v-142b09b6>RdsInstance</code>. More on this later in the following section <strong data-v-142b09b6 data-v-142b09b6>Passing data between stacks</strong>.</p>
<h2 id="ad-hoc-app-overview" data-v-142b09b6 data-v-142b09b6><a href="#ad-hoc-app-overview" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Ad hoc app overview</h2>
<p data-v-142b09b6 data-v-142b09b6>The ad hoc app is an group of resources that powers an on-demand environment that is meant to be short lived for testing, QA, validation, demos, etc.</p>
<p data-v-142b09b6 data-v-142b09b6>This visualization shows all of the resources in the ad hoc app stack. It also comes from the Pulumi console.</p>
<p data-v-142b09b6 data-v-142b09b6><img alt="Graph view of ad hoc app infrastructure" src="/static/pulumi_ad_hoc_app_dep_graph.png" data-v-142b09b6 data-v-142b09b6></p>
<h3 id="ecs-cluster" data-v-142b09b6 data-v-142b09b6><a href="#ecs-cluster" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>ECS Cluster</h3>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>This is a small component that defines both ECS Cluster and the default capacity providers</li>
<li data-v-142b09b6 data-v-142b09b6>It defaults to not using <code data-v-142b09b6 data-v-142b09b6>FARGATE_SPOT</code>; ad hoc environments do use <code data-v-142b09b6 data-v-142b09b6>FARGATE_SPOT</code> for cost savings</li>
</ul>
<blockquote data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>NOTE: defaultCapacityProviderStrategy on cluster not currently supported. (<a href="https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ecs.CapacityProviderStrategy.html" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>link</a>)</p>
</blockquote>
<h3 id="shared-environment-variables" data-v-142b09b6 data-v-142b09b6><a href="#shared-environment-variables" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Shared environment variables</h3>
<p data-v-142b09b6 data-v-142b09b6>The backend containers should all have the same environment variables, so I define them once in the app stack and pass these into the service resource <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>I struggled to get this right in pulumi. A lot of Pulumi examples used <code data-v-142b09b6 data-v-142b09b6>JSON.stringify</code> for containerDefinitions in task definitions. I was able to get help from the Pulumi Slack channel; someone recommended that I use <code data-v-142b09b6 data-v-142b09b6>pulumi.jsonStringify</code> which was added in a relatively recent version of <code data-v-142b09b6 data-v-142b09b6>pulumi/pulumi</code>.</li>
<li data-v-142b09b6 data-v-142b09b6>CDK allows you to declare environment variables for a containerDefinition like <code data-v-142b09b6 data-v-142b09b6>{ FOO: "bar" }</code></li>
<li data-v-142b09b6 data-v-142b09b6>Pulumi and Terraform require that values are passed like <code data-v-142b09b6 data-v-142b09b6>{ name: "FOO", value: "bar"}</code></li>
<li data-v-142b09b6 data-v-142b09b6>You could transform <code data-v-142b09b6 data-v-142b09b6>{ FOO: "bar" }</code> into the name/value format, but I didn't bother to do this</li>
<li data-v-142b09b6 data-v-142b09b6>extra env vars in Terraform to allow for dynamically passing extra environment variables, and I used the <code data-v-142b09b6 data-v-142b09b6>concat</code> function to add these to the list of default environment variables.</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Here's what the code looks like for joining extra environment variables to the default environment variables:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token comment" data-v-142b09b6 data-v-142b09b6>// CDK</span>
    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>if</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>extraEnvVars<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
      environmentVariables <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> <span class="token operator" data-v-142b09b6 data-v-142b09b6>...</span>extraEnvVars<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token operator" data-v-142b09b6 data-v-142b09b6>...</span>environmentVariables <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>
</code></pre></div>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    # terraform
    env_vars = concat(local.env_vars, var.extra_env_vars)
</code></pre></div>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    // Pulumi
    if (extraEnvVars) {
      envVars = envVars.apply(x => x.concat(extraEnvVars!))
    }
</code></pre></div>
<h3 id="route53-record" data-v-142b09b6 data-v-142b09b6><a href="#route53-record" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Route53 Record</h3>
<p data-v-142b09b6 data-v-142b09b6>This is pretty straightforward in each library. Each ad hoc environment gets a Route 53 record, and listener rules for the web services (Django and Vue.js SPA) match on a combination of the host header and path patterns.</p>
<p data-v-142b09b6 data-v-142b09b6>This part is pretty opinionated in that it assumes you want to host the frontend and backend services on the same URL. For example, requests matching <code data-v-142b09b6 data-v-142b09b6>example.com/api/*</code> are routed to the backend API and all other requests matching <code data-v-142b09b6 data-v-142b09b6>example.com/*</code> are routed to the frontend service.</p>
<h3 id="redis" data-v-142b09b6 data-v-142b09b6><a href="#redis" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Redis</h3>
<p data-v-142b09b6 data-v-142b09b6>I go into more depth about why I run a Redis instance in an ECS service in my other article. This is only for the ad hoc environments. Production environments are configured with ElastiCache running Redis.</p>
<p data-v-142b09b6 data-v-142b09b6>I decided to not make this service use any persistent storage. It may be a good idea to not use FARGATE_SPOT for this service, since restarts to the redis service could cause issues in ad hoc environments. For example, you may get a lot of celery errors in ad hoc environments if redis is not reachable.</p>
<h3 id="web-service" data-v-142b09b6 data-v-142b09b6><a href="#web-service" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Web Service</h3>
<p data-v-142b09b6 data-v-142b09b6>The web service is what defines the main Django application as well as the frontend website (JavaScript SPA or SSR site). I designed the Web Service resources group to be able to support both traditional Django apps (powered by templates), or for Django apps that service only a limited number of endpoints. This <code data-v-142b09b6 data-v-142b09b6>c/m/c</code> has an input parameter called <code data-v-142b09b6 data-v-142b09b6>pathPatterns</code> which determines which paths it serves. For example, the API container may serve traffic for <code data-v-142b09b6 data-v-142b09b6>/api/*</code> and <code data-v-142b09b6 data-v-142b09b6>/admin/*</code> only, or it may want to serve all traffic (<code data-v-142b09b6 data-v-142b09b6>/*</code>).</p>
<p data-v-142b09b6 data-v-142b09b6>The way I use these components in ad hoc and prod environments is heavily opinionated in that:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>it assumes that the frontend SPA/SSR site should have a lower priority rule than the backend service and should route request paths matching <code data-v-142b09b6 data-v-142b09b6>/*</code>, while the backend service routes requests for a specific list of path patterns (<code data-v-142b09b6 data-v-142b09b6>/api/*</code>, <code data-v-142b09b6 data-v-142b09b6>/admin/*</code>, <code data-v-142b09b6 data-v-142b09b6>/graphql/*</code>, etc.).</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>You may want Django to handle most of your routes and 404 pages, in which case you would want the SPA to only handle requests matching certain paths. This would require some more consideration and careful refactoring.</p>
<h3 id="celery" data-v-142b09b6 data-v-142b09b6><a href="#celery" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Celery</h3>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>The reason for having a celery service is to be able to have potentially multiple workers that scale independently</li>
<li data-v-142b09b6 data-v-142b09b6>I use the same Pulumi component for both works and schedulers</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>The terminology for this resource group could be better. Celery is one of many options for running async task workers, so it should probably be called something like <code data-v-142b09b6 data-v-142b09b6>AsyncWorker</code> across the board rather than using the term <code data-v-142b09b6 data-v-142b09b6>celery</code>.</p>
<h3 id="management-command" data-v-142b09b6 data-v-142b09b6><a href="#management-command" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Management Command</h3>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Defines a task that can be used to run commands like <code data-v-142b09b6 data-v-142b09b6>collectstatic</code> and <code data-v-142b09b6 data-v-142b09b6>migrate</code></li>
<li data-v-142b09b6 data-v-142b09b6>These tasks are ran both after the initial <code data-v-142b09b6 data-v-142b09b6>app</code> stack deployment and before rolling application upgrades</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>In my Django app I have a single management command that calls <code data-v-142b09b6 data-v-142b09b6>migrate</code> and <code data-v-142b09b6 data-v-142b09b6>collectstatic</code> and runs them in the same process one after another. This management command could also be used for clearing caches during updates, loading fixtures, etc.</p>
<p data-v-142b09b6 data-v-142b09b6>One other thing to note about this <code data-v-142b09b6 data-v-142b09b6>c/m/c</code> is that it outputs a complete script that can be used in GitHub Actions (or on your CLI when testing locally) that does the following:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>saves the <code data-v-142b09b6 data-v-142b09b6>START</code> timestamp</li>
<li data-v-142b09b6 data-v-142b09b6>runs the task with the required settings</li>
<li data-v-142b09b6 data-v-142b09b6>waits for the task to complete</li>
<li data-v-142b09b6 data-v-142b09b6>saves the <code data-v-142b09b6 data-v-142b09b6>END</code> timestamp</li>
<li data-v-142b09b6 data-v-142b09b6>collects the logs for the task between <code data-v-142b09b6 data-v-142b09b6>START</code> and <code data-v-142b09b6 data-v-142b09b6>END</code> and prints them to <code data-v-142b09b6 data-v-142b09b6>stdout</code></li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Here's an example of what the script looks like in Pulumi:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> executionScript <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>interpolate<span class="token template-string" data-v-142b09b6 data-v-142b09b6><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span><span class="token string" data-v-142b09b6 data-v-142b09b6>#!/bin/bash
START_TIME=$(date +%s000)
TASK_ID=$(aws ecs run-task --cluster </span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>ecsClusterId<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6> --task-definition </span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>taskDefinition<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>arn<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6> --launch-type FARGATE --network-configuration "awsvpcConfiguration={subnets=[</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>privateSubnetIds</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>apply</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>x <span class="token operator" data-v-142b09b6 data-v-142b09b6>=></span> x<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>join</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>","</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>],securityGroups=[</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>appSgId<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>],assignPublicIp=ENABLED}" | jq -r '.tasks[0].taskArn')
aws ecs wait tasks-stopped --tasks $TASK_ID --cluster </span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>ecsClusterId<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>
END_TIME=$(date +%s000)
aws logs get-log-events --log-group-name </span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>cwLoggingResources<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>cwLogGroupName<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6> --log-stream-name </span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>name<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>/</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>props<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>name<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>/\${TASK_ID##*/} --start-time $START_TIME --end-time $END_TIME | jq -r '.events[].message'
</span><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>this</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>executionScript <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> executionScript<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>In GitHub Actions we get this command as a stack output, save it to a file, make it executable and then run it. This is what it looks like with CDK as a CloudFormation stack output:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-yaml" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>      <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>-</span> <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>name</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>"Run backend update command"</span>
        <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>id</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> run_backend_update
        <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>run</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>|</span><span class="token scalar string" data-v-142b09b6 data-v-142b09b6>
          # get the script from the stack output with an output key that contains the string `backendUpdate`
          BACKEND_UPDATE_SCRIPT=$(aws cloudformation describe-stacks \
            --stack-name $AD_HOC_APP_NAME \
            | jq -r '.Stacks[0].Outputs[]|select(.OutputKey | contains("backendUpdate")) | .OutputValue' \
          )</span>

          echo "$BACKEND_UPDATE_SCRIPT" <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>></span> backend_update_command.sh
          cat backend_update_command.sh
          sudo chmod +x backend_update_command.sh
          ./backend_update_command.sh
</code></pre></div>
<h3 id="passing-data-between-stacks" data-v-142b09b6 data-v-142b09b6><a href="#passing-data-between-stacks" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Passing data between stacks</h3>
<p data-v-142b09b6 data-v-142b09b6>Pulumi uses stack references, Terraform uses remote state and CDK uses Stack Outputs or Stack References.</p>
<p data-v-142b09b6 data-v-142b09b6>Here's what this looks like in Terraform</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>data "terraform_remote_state" "this" {
  backend = "local"

  config = {
    path = "../base/terraform.tfstate"
  }
}

module "main" {
  source = "../../../modules/ad-hoc/app"

  vpc_id                         = data.terraform_remote_state.this.outputs.vpc_id
  assets_bucket_name             = data.terraform_remote_state.this.outputs.assets_bucket_name
  private_subnet_ids             = data.terraform_remote_state.this.outputs.private_subnet_ids
  app_sg_id                      = data.terraform_remote_state.this.outputs.app_sg_id
  alb_sg_id                      = data.terraform_remote_state.this.outputs.alb_sg_id
  listener_arn                   = data.terraform_remote_state.this.outputs.listener_arn
  alb_dns_name                   = data.terraform_remote_state.this.outputs.alb_dns_name
  service_discovery_namespace_id = data.terraform_remote_state.this.outputs.service_discovery_namespace_id
  rds_address                    = data.terraform_remote_state.this.outputs.rds_address
  domain_name                    = data.terraform_remote_state.this.outputs.domain_name
  base_stack_name                = data.terraform_remote_state.this.outputs.base_stack_name
  region                         = var.region
}
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>In CDK:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> baseStack <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>Stack</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>app<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'ExampleAdHocBaseStack'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> env<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> stackName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBaseEnvName <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
baseStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>node<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>setContext</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>'config'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> adHocBaseEnvConfig<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> appStack <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>Stack</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>app<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'ExampleAdHocAppStack'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> env<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> stackName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocAppEnvName <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
appStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>node<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>setContext</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>'config'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> adHocAppEnvConfig<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> adHocBase <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>AdHocBase</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>baseStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'AdHocBase'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> certificateArn<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> domainName <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> addHocApp <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>AdHocApp</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>appStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'AdHocApp'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
  baseStackName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBaseEnvName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  vpc<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>vpc<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  alb<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>alb<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  appSecurityGroup<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>appSecurityGroup<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  serviceDiscoveryNamespace<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>serviceDiscoveryNamespace<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  rdsInstance<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>databaseInstance<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  assetsBucket<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>assetsBucket<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  domainName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>domainName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  listener<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBase<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>listener<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>and in Pulumi:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> stackReference <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>pulumi</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>StackReference</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token template-string" data-v-142b09b6 data-v-142b09b6><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>org<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>/ad-hoc-base/</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>environment<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span>

<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> vpcId <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"vpcId"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> assetsBucketName <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"assetsBucketName"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> privateSubnets <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"privateSubnetIds"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>[</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>]</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> appSgId <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"appSgId"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> albSgId <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"albSgId"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> listenerArn <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"listenerArn"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> albDnsName <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"albDnsName"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> serviceDiscoveryNamespaceId <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"serviceDiscoveryNamespaceId"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> rdsAddress <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"rdsAddress"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> domainName <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"domainName"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> baseStackName <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> stackReference<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>getOutput</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"baseStackName"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>as</span> pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>Output<span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span><span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

<span class="token comment" data-v-142b09b6 data-v-142b09b6>// ad hoc app env</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> adHocAppComponent <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>AdHocAppComponent</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"AdHocAppComponent"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
  vpcId<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  assetsBucketName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  privateSubnets<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  appSgId<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  albSgId<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  listenerArn<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  albDnsName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  serviceDiscoveryNamespaceId<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  rdsAddress<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  domainName<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span>
  baseStackName
<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<h2 id="cli-scaffolding" data-v-142b09b6 data-v-142b09b6><a href="#cli-scaffolding" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>CLI scaffolding</h2>
<p data-v-142b09b6 data-v-142b09b6>CDK and Pulumi have some good options for how to scaffold a project.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Pulumi has <code data-v-142b09b6 data-v-142b09b6>pulumi new aws-typescript</code> among lots of other options (run <code data-v-142b09b6 data-v-142b09b6>pulumi new -l</code> to see over 200 project types). I used this to create the library itself, the examples and the pulumi projects that I use in <code data-v-142b09b6 data-v-142b09b6>django-step-by-step</code> that consume the library.</li>
<li data-v-142b09b6 data-v-142b09b6>CDK has <code data-v-142b09b6 data-v-142b09b6>projen</code> CLI commands which can help set up either library code or project code</li>
<li data-v-142b09b6 data-v-142b09b6>The major benefits of these tools is setting up <code data-v-142b09b6 data-v-142b09b6>tsconfig.json</code> and <code data-v-142b09b6 data-v-142b09b6>package.json</code> correctly</li>
<li data-v-142b09b6 data-v-142b09b6>Terraform is so simple that it doesn't really need tooling for scaffolding</li>
</ul>
<h2 id="best-practices" data-v-142b09b6 data-v-142b09b6><a href="#best-practices" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Best practices</h2>
<p data-v-142b09b6 data-v-142b09b6>For <code data-v-142b09b6 data-v-142b09b6>terraform-aws-django</code>, I tried to follow the recommendations from <a href="https://www.terraform-best-practices.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>terraform-best-practices.com</a> which helped me a lot with things like consistent naming patterns and directory structures. For example:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>use the name <code data-v-142b09b6 data-v-142b09b6>this</code> for resources in a module where that resource is the only resource of its type</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>CDK and Pulumi lend themselves to more nesting and abstractions because they can be written in more familiar programming languages with better abstractions, functions, loops, classes, etc., so there are some differences in directory structure of my libraries when comparing Terraform to both CDK and Pulumi.</p>
<p data-v-142b09b6 data-v-142b09b6>For Pulumi and CDK, I mostly tried to follow along with recommendations from their documentation and example projects. While working with Pulumi I struggled a bit with the concepts of <code data-v-142b09b6 data-v-142b09b6>Inputs</code>, <code data-v-142b09b6 data-v-142b09b6>Outputs</code>, <code data-v-142b09b6 data-v-142b09b6>pulumi.interpolate</code>, <code data-v-142b09b6 data-v-142b09b6>apply()</code>, <code data-v-142b09b6 data-v-142b09b6>all()</code> and the differences between <code data-v-142b09b6 data-v-142b09b6>getX</code> and <code data-v-142b09b6 data-v-142b09b6>getXOutput</code>. There is a little bit of a learning curve here, but the documentation and examples go a long way in showing how to do things the right way.</p>
<h2 id="environment-configuration" data-v-142b09b6 data-v-142b09b6><a href="#environment-configuration" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Environment configuration</h2>
<p data-v-142b09b6 data-v-142b09b6>Environment configuration allows for either a base or app stack to be configured with non-default values. For example:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>you may decide to start a new base environment but you want to provision a powerful database instance class and size. You would change this using environment configuration</li>
<li data-v-142b09b6 data-v-142b09b6>You might want to create an ad hoc app environment but you need it to include some special environment variables, you could set these in environment config.</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>In the examples above, our IaC can optionally take environment configuration values that overwrite default values, or extend default values.</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Pulumi defines environment-specific config in files called <code data-v-142b09b6 data-v-142b09b6>Pulumi.{env}.yaml</code> (<a href="https://www.pulumi.com/docs/intro/concepts/config/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>Pulumi article on configuration</a>)</li>
<li data-v-142b09b6 data-v-142b09b6>Terraform uses <code data-v-142b09b6 data-v-142b09b6>{env}.tfvars</code> for this type of configuration</li>
<li data-v-142b09b6 data-v-142b09b6>CDK has several options for this type of configuration (<code data-v-142b09b6 data-v-142b09b6>cdk.context.json</code>, extending stack props, etc.)</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>For CDK I have been using <code data-v-142b09b6 data-v-142b09b6>setContext</code> and the <code data-v-142b09b6 data-v-142b09b6>tryGetContext</code> method:</p>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>setContext</code> needs to be set on the node before any child nodes are added:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> baseStack <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>Stack</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>app<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'ExampleAdHocBaseStack'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> env<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> stackName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocBaseEnvName <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
baseStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>node<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>setContext</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>'config'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> adHocBaseEnvConfig<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>

<span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> appStack <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>Stack</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>app<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'ExampleAdHocAppStack'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span> env<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> stackName<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> adHocAppEnvName <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
appStack<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>node<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>setContext</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>'config'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> adHocAppEnvConfig<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>And the config objects are read from JSON files like this:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token keyword" data-v-142b09b6 data-v-142b09b6>var</span> adHocBaseEnvConfig <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token constant" data-v-142b09b6 data-v-142b09b6>JSON</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>parse</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>fs<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>readFileSync</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token template-string" data-v-142b09b6 data-v-142b09b6><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span><span class="token string" data-v-142b09b6 data-v-142b09b6>src/examples/ad-hoc/base/config/</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>adHocBaseEnvName<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>.json</span><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'utf8'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
<span class="token keyword" data-v-142b09b6 data-v-142b09b6>var</span> adHocAppEnvConfig <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token constant" data-v-142b09b6 data-v-142b09b6>JSON</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>parse</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span>fs<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>readFileSync</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token template-string" data-v-142b09b6 data-v-142b09b6><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span><span class="token string" data-v-142b09b6 data-v-142b09b6>src/examples/ad-hoc/app/config/</span><span class="token interpolation" data-v-142b09b6 data-v-142b09b6><span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>${</span>adHocAppEnvName<span class="token interpolation-punctuation punctuation" data-v-142b09b6 data-v-142b09b6>}</span></span><span class="token string" data-v-142b09b6 data-v-142b09b6>.json</span><span class="token template-punctuation string" data-v-142b09b6 data-v-142b09b6>`</span></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>,</span> <span class="token string" data-v-142b09b6 data-v-142b09b6>'utf8'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>The context can be used in constructs like this:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>const</span> extraEnvVars <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>this</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>node<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>tryGetContext</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>'config'</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span>extraEnvVars<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>Pulumi has similar functions for getting context values, here's an example of how I get extra environment variables for app environments using Pulumi's config:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-ts" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>interface</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>EnvVar</span> <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>
      name<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
      value<span class="token operator" data-v-142b09b6 data-v-142b09b6>:</span> <span class="token builtin" data-v-142b09b6 data-v-142b09b6>string</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>

    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>let</span> config <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> <span class="token keyword" data-v-142b09b6 data-v-142b09b6>new</span> <span class="token class-name" data-v-142b09b6 data-v-142b09b6>pulumi</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token function" data-v-142b09b6 data-v-142b09b6>Config</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
    <span class="token keyword" data-v-142b09b6 data-v-142b09b6>let</span> extraEnvVars <span class="token operator" data-v-142b09b6 data-v-142b09b6>=</span> config<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>.</span><span class="token generic-function" data-v-142b09b6 data-v-142b09b6><span class="token function" data-v-142b09b6 data-v-142b09b6>getObject</span><span class="token generic class-name" data-v-142b09b6 data-v-142b09b6><span class="token operator" data-v-142b09b6 data-v-142b09b6>&lt;</span>EnvVar<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>[</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>]</span><span class="token operator" data-v-142b09b6 data-v-142b09b6>></span></span></span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>(</span><span class="token string" data-v-142b09b6 data-v-142b09b6>"extraEnvVars"</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>)</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>;</span>
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>In my <code data-v-142b09b6 data-v-142b09b6>Pulumi.alpha.yaml</code> file I have the <code data-v-142b09b6 data-v-142b09b6>extraEnvVars</code> set like this:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-yaml" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token key atrule" data-v-142b09b6 data-v-142b09b6>config</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span>
  <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>aws:region</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> us<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>-</span>east<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>-</span><span class="token number" data-v-142b09b6 data-v-142b09b6>1</span>
  <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>extraEnvVars</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span>
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>-</span> <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>name</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> FOO
      <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>value</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> BAR
    <span class="token punctuation" data-v-142b09b6 data-v-142b09b6>-</span> <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>name</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> BIZ
      <span class="token key atrule" data-v-142b09b6 data-v-142b09b6>value</span><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>:</span> BUZ
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>I haven't done too much with configuration, but it seems like the right place to build out all of the dials and switches for optional settings in stack resources that you want people to be able to change in their ad hoc environments, or that you want to set per "production" environment (QA, stage, prod, etc.)</p>
<h2 id="local-development" data-v-142b09b6 data-v-142b09b6><a href="#local-development" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Local development</h2>
<p data-v-142b09b6 data-v-142b09b6>Using the Makefile targets in each library repo, my process for developing <code data-v-142b09b6 data-v-142b09b6>c/m/c</code>s involves making code changes followed by Makefile targets that preview/plan/diff against my AWS account, then running deploy/apply/up and waiting for things to finish deploying. Once I can validate that things are looking correct in my account, I run the destroy command and make sure that all of the resources are removed successfully. RDS instances can take up to 10 minutes to create, which means that the base stack takes some time to test. The app environment is able to be spun up quickly, but it can sometimes get stuck and take some time to delete services.</p>
<p data-v-142b09b6 data-v-142b09b6>Here are some sample times for deploying ad hoc stacks with CDK.</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6># CDK ad hoc base deployment time

 ‚úÖ  ExampleAdHocBaseStack (dev)

‚ú®  Deployment time: 629.64s

# CDK ad hoc app deployment time

 ‚úÖ  ExampleAdHocAppStack (alpha)

‚ú®  Deployment time: 126.62s
</code></pre></div>
<p data-v-142b09b6 data-v-142b09b6>Here is an example of what the <code data-v-142b09b6 data-v-142b09b6>pulumi preview</code> commands shows for the ad-hoc base stack:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-text" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6># Pulumi preview
~/git/github/pulumi-aws-django$ pulumi -C examples/ad-hoc/base --stack dev preview
Previewing update (dev)

View Live: https://app.pulumi.com/briancaffey/ad-hoc-base/dev/previews/718625b2-48f5-4ef4-8ed4-9b2694fda64a

     Type                                                    Name                        Plan
 +   pulumi:pulumi:Stack                                     ad-hoc-base-dev             create
 +   ‚îî‚îÄ pulumi-contrib:components:AdHocBaseEnv               myAdHocEnv                  create
 +      ‚îú‚îÄ pulumi-contrib:components:AlbResources            AlbResources                create
 +      ‚îÇ  ‚îú‚îÄ aws:alb:TargetGroup                            DefaultTg                   create
 +      ‚îÇ  ‚îú‚îÄ aws:alb:LoadBalancer                           LoadBalancer                create
 +      ‚îÇ  ‚îú‚îÄ aws:alb:Listener                               HttpListener                create
 +      ‚îÇ  ‚îî‚îÄ aws:alb:Listener                               HttpsListener               create
 +      ‚îú‚îÄ pulumi-contrib:components:BastionHostResources    BastionHostResources        create
 +      ‚îÇ  ‚îú‚îÄ aws:iam:Role                                   BastionHostRole             create
 +      ‚îÇ  ‚îú‚îÄ aws:iam:RolePolicy                             BastionHostPolicy           create
 +      ‚îÇ  ‚îú‚îÄ aws:iam:InstanceProfile                        BastionHostInstanceProfile  create
 +      ‚îÇ  ‚îî‚îÄ aws:ec2:Instance                               BastionHostInstance         create
 +      ‚îú‚îÄ pulumi-contrib:components:RdsResources            RdsResources                create
 +      ‚îÇ  ‚îú‚îÄ aws:rds:SubnetGroup                            DbSubnetGroup               create
 +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          RdsSecurityGroup            create
 +      ‚îÇ  ‚îî‚îÄ aws:rds:Instance                               DbInstance                  create
 +      ‚îú‚îÄ pulumi-contrib:components:SecurityGroupResources  SecurityGroupResources      create
 +      ‚îÇ  ‚îú‚îÄ aws:ec2:SecurityGroup                          AlbSecurityGroup            create
 +      ‚îÇ  ‚îî‚îÄ aws:ec2:SecurityGroup                          AppSecurityGroup            create
 +      ‚îú‚îÄ aws:s3:Bucket                                     assetsBucket                create
 +      ‚îú‚îÄ awsx:ec2:Vpc                                      dev                         create
 +      ‚îÇ  ‚îî‚îÄ aws:ec2:Vpc                                    dev                         create
 +      ‚îÇ     ‚îú‚îÄ aws:ec2:InternetGateway                     dev                         create
 +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-1               create
 +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-1               create
 +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-1               create
 +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-1               create
 +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-private-2               create
 +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:RouteTable                       dev-private-2               create
 +      ‚îÇ     ‚îÇ     ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-private-2               create
 +      ‚îÇ     ‚îÇ     ‚îî‚îÄ aws:ec2:Route                         dev-private-2               create
 +      ‚îÇ     ‚îú‚îÄ aws:ec2:Subnet                              dev-public-1                create
 +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-1                create
 +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-1                create
 +      ‚îÇ     ‚îÇ  ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-1                create
 +      ‚îÇ     ‚îÇ  ‚îú‚îÄ aws:ec2:Eip                              dev-1                       create
 +      ‚îÇ     ‚îÇ  ‚îî‚îÄ aws:ec2:NatGateway                       dev-1                       create
 +      ‚îÇ     ‚îî‚îÄ aws:ec2:Subnet                              dev-public-2                create
 +      ‚îÇ        ‚îú‚îÄ aws:ec2:RouteTable                       dev-public-2                create
 +      ‚îÇ        ‚îÇ  ‚îú‚îÄ aws:ec2:RouteTableAssociation         dev-public-2                create
 +      ‚îÇ        ‚îÇ  ‚îî‚îÄ aws:ec2:Route                         dev-public-2                create
 +      ‚îÇ        ‚îú‚îÄ aws:ec2:Eip                              dev-2                       create
 +      ‚îÇ        ‚îî‚îÄ aws:ec2:NatGateway                       dev-2                       create
 +      ‚îî‚îÄ aws:servicediscovery:PrivateDnsNamespace          PrivateDnsNamespace         create


Outputs:
    albDnsName                 : output&lt;string>
    albSgId                    : output&lt;string>
    appSgId                    : output&lt;string>
    assetsBucketName           : output&lt;string>
    baseStackName              : "dev"
    bastionHostInstanceId      : output&lt;string>
    domainName                 : "example.com"
    listenerArn                : output&lt;string>
    privateSubnetIds           : output&lt;string>
    rdsAddress                 : output&lt;string>
    serviceDiscoveryNamespaceId: output&lt;string>
    vpcId                      : output&lt;string>

Resources:
    + 44 to create
</code></pre></div>
<h2 id="running-infrastructure-pipelines-in-github-actions" data-v-142b09b6 data-v-142b09b6><a href="#running-infrastructure-pipelines-in-github-actions" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Running infrastructure pipelines in GitHub Actions</h2>
<p data-v-142b09b6 data-v-142b09b6><em data-v-142b09b6 data-v-142b09b6>I don't currently have GitHub Actions working for all tools in all environments, this part is still a WIP but is working at a basic level. Another item for the backlog!</em></p>
<p data-v-142b09b6 data-v-142b09b6>In the <code data-v-142b09b6 data-v-142b09b6>.github/workflows</code> directory of the <code data-v-142b09b6 data-v-142b09b6>django-step-by-step</code> repo, I will have the following <code data-v-142b09b6 data-v-142b09b6>2 * 2 * 2 * 3 = 24</code> pipelines for running infrastructure as code pipelines:</p>
<div class="nuxt-content-highlight" data-v-142b09b6 data-v-142b09b6><pre class="line-numbers language-bash" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6><span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>ad_hoc,prod<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>_<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>base,app<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>_<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>create_update,destroy<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>_<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>{</span>cdk,terraform,pulumi<span class="token punctuation" data-v-142b09b6 data-v-142b09b6>}</span>.yml
</code></pre></div>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>For CDK I'm using CDK CLI commands</li>
<li data-v-142b09b6 data-v-142b09b6>For Terraform I'm also using terraform CLI commands</li>
<li data-v-142b09b6 data-v-142b09b6>For Pulumi I'm using the official Pulumi GitHub Action</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>Pulumi has <a href="https://www.pulumi.com/docs/guides/continuous-delivery/github-actions/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>a great article</a> about how to use their official GitHub Action. This action calls the Pulumi CLI under the hood with all of the correct flags.</p>
<p data-v-142b09b6 data-v-142b09b6>The general pattern that all of these pipelines use is:</p>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Do a synth/plan/preview, and upload the synth/plan/preview file to an artifact</li>
<li data-v-142b09b6 data-v-142b09b6>Pause and wait on manual review of the planned changes</li>
<li data-v-142b09b6 data-v-142b09b6>download the artifact and run deploy/apply/up against it, or optionally cancel the operation if the changes you see in the GitHub Actions pipeline logs are not what you expected.</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>I do this by having two jobs in each GitHub Action: one for synth/plan/preview and one for deploy/apply/up.</p>
<p data-v-142b09b6 data-v-142b09b6>The job for deploy/apply/up includes an <code data-v-142b09b6 data-v-142b09b6>environment</code> that is configured in GitHub to be a protected environment that requires approvals. Even if you are the only approver (which I am on this project), it is the easiest and safest way preview infrastructure changes before they happen. If you see something in the plan and it isn't what you wanted to change, you cancel the job.</p>
<h2 id="application-deployments" data-v-142b09b6 data-v-142b09b6><a href="#application-deployments" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Application deployments</h2>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>There are two GitHub Actions pipelines for deploying the frontend and the backend. Both of these pipelines run bash scripts that call AWS CLI commands to perform rolling updates on all of the services used in the application (frontend, API, workers, scheduler)</p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>The backend deployment script runs database migrations, the <code data-v-142b09b6 data-v-142b09b6>collectstatic</code> command and any other commands needed to run before the rolling update starts (clearing the cache, loading fixtures, etc.)</p>
</li>
<li data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6>What is important to note here is that application deployments are not dependent on the IaC tool we use. Since we are tagging things consistently across CDK, Terraform and Pulumi, we can look up resources by tag rather than getting "outputs" of the app stacks.</p>
</li>
</ul>
<h2 id="interacting-with-aws-via-iac" data-v-142b09b6 data-v-142b09b6><a href="#interacting-with-aws-via-iac" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Interacting with AWS via IaC</h2>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>CDK interacts directly with CloudFormation (and custom resources which allow for running arbitrary SDK calls and lambda functions) and provides <a href="https://docs.aws.amazon.com/cdk/v2/guide/constructs.html" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>L1, L2 and L3 constructs</a> which offer different levels of abstraction over CloudFormation.</li>
<li data-v-142b09b6 data-v-142b09b6>Terraform has the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>AWS Provider</a> and the <a href="https://registry.terraform.io/namespaces/terraform-aws-modules" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>terraform-aws-modules</code></a>.</li>
<li data-v-142b09b6 data-v-142b09b6>Pulumi has AWS Classic (<code data-v-142b09b6 data-v-142b09b6>@pulumi/aws</code>) <strong data-v-142b09b6 data-v-142b09b6>provider</strong> and <code data-v-142b09b6 data-v-142b09b6>AWSx</code> (<a href="https://www.pulumi.com/registry/packages/awsx/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>Crosswalk for Pulumi</a>) <strong data-v-142b09b6 data-v-142b09b6>library</strong> and <code data-v-142b09b6 data-v-142b09b6>aws_native</code> <strong data-v-142b09b6 data-v-142b09b6>provider</strong>.</li>
</ul>
<blockquote data-v-142b09b6 data-v-142b09b6>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>aws_native</code> "manages and provisions resources using the AWS Cloud Control API, which typically supports new AWS features on the day of launch."</p>
</blockquote>
<p data-v-142b09b6 data-v-142b09b6><code data-v-142b09b6 data-v-142b09b6>aws_native</code> looks like a really interesting option, but it is currently in public preview so I have not decided to use it. I am using the AWSx library only for my VPC and associated resources, everything else uses the AWS Classic provider.</p>
<p data-v-142b09b6 data-v-142b09b6>For CDK I use mostly L2 constructs and some L1 constructs.</p>
<p data-v-142b09b6 data-v-142b09b6>Fot Terraform I use the VPC from the <code data-v-142b09b6 data-v-142b09b6>terraform-aws-modules</code>, and everything else uses the AWS Terraform Provider.</p>
<h2 id="what-i-did-not-put-in-iac" data-v-142b09b6 data-v-142b09b6><a href="#what-i-did-not-put-in-iac" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>What I did not put in IaC</h2>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>ECR (Elastic Container Registry)</li>
<li data-v-142b09b6 data-v-142b09b6>ACM (Amazon Certificate Manager)</li>
<li data-v-142b09b6 data-v-142b09b6>(Roles used for deployments)</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>I created the Elastic Container Registry <code data-v-142b09b6 data-v-142b09b6>backend</code> and <code data-v-142b09b6 data-v-142b09b6>frontend</code> repos manually in the AWS Console. I also manually requested an ACM certificate for <code data-v-142b09b6 data-v-142b09b6>*.mydomain.com</code> for the domain that I use for testing that I purchased through Route53 domains.</p>
<p data-v-142b09b6 data-v-142b09b6>I currently am using another less-than best practice of using Administrative Credentials stored in GitHub secrets. The better approach here is to make roles for different pipelines and use OIDC to authenticate instead of storing credentials. This is another good item for the backlog.</p>
<h2 id="tagging" data-v-142b09b6 data-v-142b09b6><a href="#tagging" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Tagging</h2>
<ul data-v-142b09b6 data-v-142b09b6>
<li data-v-142b09b6 data-v-142b09b6>Terraform and CDK both make it easy to automatically tag all resources in a stack</li>
<li data-v-142b09b6 data-v-142b09b6>It is possible to do this in Pulumi, but you need to write a little bit of code.</li>
<li data-v-142b09b6 data-v-142b09b6><a href="https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>https://www.pulumi.com/blog/automatically-enforcing-aws-resource-tagging-policies/</a></li>
<li data-v-142b09b6 data-v-142b09b6><a href="https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>https://github.com/joeduffy/aws-tags-example/tree/master/autotag-ts</a></li>
<li data-v-142b09b6 data-v-142b09b6>Tagging is important since I look up resources by tag in GitHub Actions pipelines (for example, the Bastion Host is looked up by tag)</li>
<li data-v-142b09b6 data-v-142b09b6>Automatically tagging resources works through <a href="https://www.pulumi.com/docs/intro/vs/terraform/" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>stack transformations</a> are unique to Pulumi</li>
</ul>
<h2 id="smoke-checking-application-environments" data-v-142b09b6 data-v-142b09b6><a href="#smoke-checking-application-environments" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Smoke checking application environments</h2>
<p data-v-142b09b6 data-v-142b09b6>Here's the list of things I check when standing up an application environment:</p>
<ul class="contains-task-list" data-v-142b09b6 data-v-142b09b6>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Run the init/tsc, synth/plan/preview and deploy/apply/up commands successfully</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Access the bastion host (<code data-v-142b09b6 data-v-142b09b6>make aws-ssm-start-session</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Run ECSExec to access a shell in a backend container (<code data-v-142b09b6 data-v-142b09b6>make aws-ecs-exec</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Test database connectivity (<code data-v-142b09b6 data-v-142b09b6>python manage.py showmigrations</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Run the migrations (<code data-v-142b09b6 data-v-142b09b6>python manage.py migrate</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Run collectstatic (<code data-v-142b09b6 data-v-142b09b6>python manage.py collectstatic</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Visit the site (<code data-v-142b09b6 data-v-142b09b6>alpha.example.com</code>)</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Publish a blog post</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Publish a blog post with an image</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Check celery worker logs for successfully complete scheduled tasks</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Trigger an autoscaling event by running k6 load tests against an environment</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Optionally deploy another backend or frontend image tag using the GitHub Actions pipelines for backend and frontend updates</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Destroy the app stack</li>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Destroy the base stack</li>
</ul>
<h2 id="backlog-and-next-steps" data-v-142b09b6 data-v-142b09b6><a href="#backlog-and-next-steps" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Backlog and next steps</h2>
<p data-v-142b09b6 data-v-142b09b6>Here are some of the next things I'll be working on in these project, roughly in order of importance:</p>
<ul class="contains-task-list" data-v-142b09b6 data-v-142b09b6>
<li class="task-list-item" data-v-142b09b6 data-v-142b09b6><input checked disabled type="checkbox" data-v-142b09b6 data-v-142b09b6> Introduce manual approvals in GitHub Actions for all deployments and allow for the previewing or "planning" before proceeding with an live operations in infrastructure pipelines</li>
<li data-v-142b09b6 data-v-142b09b6>Switch to using OIDC for AWS authentication from GitHub Actions and remove AWS secrets from GitHub</li>
<li data-v-142b09b6 data-v-142b09b6>Show how to do account isolation (different accounts for prod vs pre-prod environments)</li>
<li data-v-142b09b6 data-v-142b09b6>GitHub Actions deployment pipeline for publishing <code data-v-142b09b6 data-v-142b09b6>pulumi-aws-django</code> package</li>
<li data-v-142b09b6 data-v-142b09b6>Complete all GitHub Action deployment pipelines for base and app stacks (both ad hoc and prod)</li>
<li data-v-142b09b6 data-v-142b09b6>For Pulumi and Terraform, use a Secrets Manager secret for the database instead of hardcoding it. Use the <code data-v-142b09b6 data-v-142b09b6>random</code> functions to do this</li>
<li data-v-142b09b6 data-v-142b09b6>Refactor GitHub Actions and make them reusable across different projects</li>
<li data-v-142b09b6 data-v-142b09b6>Writing tests for Pulumi and CDK. Figure out how to write tests for Terraform modules</li>
<li data-v-142b09b6 data-v-142b09b6>Use graviton instances and have the option to select between different architectures</li>
<li data-v-142b09b6 data-v-142b09b6>Standardize all resources names across CDK, Terraform and Pulumi</li>
<li data-v-142b09b6 data-v-142b09b6>The Pulumi components that define the resources associated with each ECS service are not very dry</li>
<li data-v-142b09b6 data-v-142b09b6>Interfaces could be constructed with inheritance (base set of properties that is extended for different types of services)</li>
<li data-v-142b09b6 data-v-142b09b6>Fix the CDK issue with priority rule on ALB listeners. I need to used a custom resource for this which is currently a WIP. Terraform and Pulumi look up the next highest listener rule priority under the hood, so you are not required to provide it, but CDK requires it, which means that you can't do ad hoc environments in CDK without a custom resource that looks up what the next available priority number is.</li>
<li data-v-142b09b6 data-v-142b09b6>Make all three of the libraries less opinionated. For example, the celery worker and scheduler should be optional and the frontend component should also be optional</li>
<li data-v-142b09b6 data-v-142b09b6>experiment with using a frontend with SSR. This is supported by Quasar, the framework I'm currently using to build my frontend SPA site</li>
</ul>
<p data-v-142b09b6 data-v-142b09b6>If you want to get involved or help with any of the above, please let me know!</p>
<h2 id="conclusion" data-v-142b09b6 data-v-142b09b6><a href="#conclusion" aria-hidden="true" tabindex="-1" data-v-142b09b6 data-v-142b09b6><span class="icon icon-link" data-v-142b09b6 data-v-142b09b6></span></a>Conclusion</h2>
<p data-v-142b09b6 data-v-142b09b6>I first started out with IaC following this project <a href="https://github.com/aws-samples/ecs-refarch-cloudformation" rel="nofollow noopener noreferrer" target="_blank" data-v-142b09b6 data-v-142b09b6>aws-samples/ecs-refarch-cloudformation</a> (which is pretty old at this point) and wrote a lot of CloudFormation by hand. The pain of doing that lead me to explore the CDK with Python. I learned TypeScript by rewriting the Python CDK code I wrote in TypeScript. I later worked with a team that was more experienced in Terraform and learned how to use that. I feel like Pulumi takes the best of the two tools and has a really great developer experience. There is a little bit of a learning curve with Pulumi, and you give up some of the simplicity of Terraform.</p></div> <div class="text-center pb-4 pt-8" data-v-142b09b6><button class="mc-btn rounded py-1 px-2" data-v-142b09b6>
        Show Disqus Comments üí¨
      </button></div> <!----> <h1 data-v-142b09b6></h1></div></article> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-7718c60c><hr class="mt-4" data-v-7718c60c> <div class="align-center py-4" data-v-7718c60c><div class="pb-4" data-v-7718c60c>
      Abonnez-vous √† mon newsletter
    </div> <div class="flex align-center justify-center" data-v-5690d13b data-v-7718c60c><div id="mc_embed_signup" class="w-full md:w-1/2 flex-shrink justify-center" data-v-5690d13b><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-5690d13b><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4" data-v-5690d13b><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Adresse e-mail" class="rounded mc text-center" data-v-5690d13b> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-5690d13b><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-5690d13b></div> <div class="text-right" style="width:100%" data-v-5690d13b><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="S'inscrire" class="mc-btn rounded px-2 py-1 w-full" data-v-5690d13b></div></div></form></div></div></div> <hr data-v-7718c60c> <div class="py-4" data-v-7718c60c>
    Merci d'avoir visiter mon site !
  </div> <div class="pb-4" data-v-7718c60c>
    ¬© 2024 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1708275835/fr/2023/01/07/i-deployed-the-same-containerized-serverless-django-app-with-aws-cdk-terraform-and-pulumi/state.js"></script><script src="/_nuxt/4fb1928.js" defer></script><script src="/_nuxt/c259e4a.js" defer></script><script src="/_nuxt/8bfa011.js" defer></script><script src="/_nuxt/b575c49.js" defer></script><script src="/_nuxt/691d3dd.js" defer></script>
  </body>
</html>
