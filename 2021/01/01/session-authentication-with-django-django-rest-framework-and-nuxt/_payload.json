[{"data":1,"prerenderedAt":663},["ShallowReactive",2],{"session-authentication-with-django-django-rest-framework-and-nuxt":3},{"id":4,"title":5,"body":6,"comments":645,"date":646,"description":647,"draft":645,"extension":648,"external":649,"image":650,"meta":651,"navigation":652,"path":653,"seo":654,"stem":655,"tags":656,"__hash__":662},"blog/2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt.md","Session Authentication with Django, Django REST Framework and Nuxt",{"type":7,"value":8,"toc":617},"minimark",[9,13,16,24,27,30,33,36,41,44,47,51,54,59,62,78,81,85,88,118,122,125,128,132,135,138,141,145,152,155,164,167,185,188,202,216,307,313,346,378,405,411,444,454,466,472,554,558,562,565,569,576,579,583,586,589,593,596,600,603,607,610,614],[10,11,12],"p",{},"This will be a continuation of the discussion about how data flows in Django + Nuxt applications, looking specifically at session authentication.",[10,14,15],{},"Here's a GitLab repo that where you can find the source code and other diagrams related to this project:",[10,17,18],{},[19,20,21],"a",{"href":21,"rel":22},"https://gitlab.com/briancaffey/django-nuxt-starter",[23],"nofollow",[10,25,26],{},"This diagram focuses on the interactions between:",[10,28,29],{},"I. The browser",[10,31,32],{},"II. The Nuxt server (Node process)",[10,34,35],{},"III. The Django backend API server (gunicorn process)",[37,38,40],"h2",{"id":39},"context","Context",[10,42,43],{},"For illustration purposes, I'm using a simple CRUD application that has two models: Users and (blog) Posts. Users can log in with email and password credentials and create, read, update and delete blog posts (CRUD). Currently I'm only doing the R (read) of CRUD: listing and viewing blog posts. Creating, updating and delete will be added later. For now, users must be logged in to see posts.",[10,45,46],{},"I'm still learning a lot about Nuxt and how it can be used with Django and Django REST Framework. This project is an effort at documenting my learning process, learning in public and learning from mistakes, so any feedback or guidance on what I have written here would be highly appreciated!",[37,48,50],{"id":49},"why-nuxt","Why Nuxt?",[10,52,53],{},"Using Nuxt (with Server Side Rendering, or SSR) is one of many ways to use Vue.js with Django. Vue is a progressive framework, which means that it can be gradually adopted into a project--you don't have to go all-in on the framework or rewrite the application from scratch to fit with how Vue works.",[55,56,58],"h3",{"id":57},"different-ways-to-use-vue-with-django","Different ways to use Vue with Django",[10,60,61],{},"In terms of Django, here are some ways that you can use Vue:",[63,64,65,69,72,75],"ul",{},[66,67,68],"li",{},"Vue as a jQuery replacement for adding basic interactivity in views served by Django templates",[66,70,71],{},"Build a static Vue application and serve it as a set of static assets in a Django project alongside routes that are served by other normal Django templates views.",[66,73,74],{},"Build a Vue SPA which consumes a Django API (usually built with Django REST Framework or similar), and serve it over a content delivery network (CDN).",[66,76,77],{},"Use Vue to build an Electron desktop app that uses Django as an API",[10,79,80],{},"In these scenarios, Vue is served as either static assets (such as in the case of serving a SPA over a CDN), or Vue code is included in an HTML response from a server (where the view library, not your application, is served over a CDN), similar to how jQuery is used.",[55,82,84],{"id":83},"different-ways-to-use-nuxt","Different ways to use Nuxt",[10,86,87],{},"Nuxt is a Framework that can be used in a few different ways, I'll briefly discus three ways in which Nuxt can be used. Common to all three of these ways of using Nuxt is the directory structure. No matter how you use Nuxt, it provides a great way to organize Vue code.",[89,90,91,100,103],"ol",{},[66,92,93,94,99],{},"Static mode: this mode allows you to write Vue code which is built into a static HTML, and then that HTML is deployed to a CDN or webserver like NGINX. The developer (or CI/CD process) runs a command to generate HTML files for each page in the application, and these pages are served as-is when accessed by a user. I recently migrated my personal blog from Jekyll to Nuxt with full-static mode. Check it out at (",[19,95,98],{"href":96,"rel":97},"https://briancaffey.github.io",[23],"briancaffey.github.io",").",[66,101,102],{},"SPA mode: This is similar to what you might use if you started a Vue project with Vue CLI. The project is also generated as in Static Mode, but what is generated is primarily Javascript code that is executed on the browser.",[66,104,105,106,110,111,113,114,117],{},"SSR mode: Server Side Rendering is the mode that I'll be focusing on here. Unlike the other ways of using Vue that have already been discussed, this mode involves a Node.js server that will handle our requests. For example, a web request for ",[107,108,109],"code",{},"/posts"," is sent to our Nuxt Server (a Node.js server process) and Node.js is responsible for returning HTML that contains all of the blog Posts that we want to show (or a paginated selection of all blog posts, which is how my example blog app is built). So the Nuxt app has to make a request to our Django API server before returning fully rendered HTML page for the ",[107,112,109],{}," page. The user then gets the page from Nuxt, reads all of the blog posts and then decides to check out the blog posts on the second page of posts. When the user clicks on page 2, we request the second page of data from our Django API directly, not from Nuxt. The user then sees a short loading animation followed by the second page of blog posts that are loaded in using AJAX (usually with ",[107,115,116],{},"fetch"," or axios).",[55,119,121],{"id":120},"nuxt-benefits","Nuxt Benefits",[10,123,124],{},"The main reason for using Nuxt is to render the first page loads on the server, returning a complete HTML response that can be beneficial for SEO, social sharing, and other scenarios where you need control over how a website's pages are delivered (specifically, the initial request made to the server).",[10,126,127],{},"This type of control is not possible for applications that serve Vue over CDN since they can only request backend API data once the JS client has been requested from a CDN.",[55,129,131],{"id":130},"nuxt-downsides-and-tradeoffs","Nuxt Downsides and Tradeoffs",[10,133,134],{},"Using Nuxt for SSR introduces quite a bit of complexity in both the application deployment and our Vue code. The backend API won't have to change at all when moving to Nuxt from a static Vue SPA.",[10,136,137],{},"Django alone is capable of returning fully generated, SEO-optimized HTML for each request, but applications built with Vue and Django templates may be difficult to work on as the project grows larger and larger. The Django/DRF + Nuxt approach may be more appropriate for projects with dedicated backend and frontend teams.",[10,139,140],{},"One other potential downside is added latency because of the \"double request\". If the Nuxt server and the Django server are on the same machine, then this latency will probably be a non-issue.",[37,142,144],{"id":143},"diagram","Diagram",[10,146,147],{},[148,149],"img",{"alt":150,"src":151},"Nuxt Django Auth","/static/django_nuxt_auth.png",[10,153,154],{},"This diagram looks at session authentication with a focus on the browser, the Nuxt server and the Django server. It looks at two simple user stories, ordered from top to bottom in the diagram.",[10,156,157,158,160,161,163],{},"I. An existing application user visits the site in a new browser, navigates to the Login page, logs in with credentials and then visits a protected page: ",[107,159,109],{},".\nII. The user closes the browser and then comes back directly to the ",[107,162,109],{}," page.",[10,165,166],{},"These two user stories sound simple, but they touch on a lot of the features of Nuxt that make it powerful, and complicated at first (for Vue users). These include:",[63,168,169,174,179,182],{},[66,170,171],{},[107,172,173],{},"asyncData",[66,175,176],{},[107,177,178],{},"nuxtServerInit",[66,180,181],{},"Vuex on the client and server",[66,183,184],{},"Custom plugin for axios",[10,186,187],{},"Some important parts of Nuxt that this diagram does not (yet) touch on are:",[63,189,190,193,199],{},[66,191,192],{},"Nuxt auth module (I don't know if this is relevant for my use case)",[66,194,195,196,198],{},"Nuxt fetch property (different from the ",[107,197,116],{}," web API)",[66,200,201],{},"Nuxt middleware (I'm also not sure if this would be helpful for anything I am doing in this example project)",[55,203,205,206,208,209,212,213,215],{"id":204},"user-story-i-a-user-tries-to-open-posts-is-redirected-to-login-logs-in-then-navigate-to-posts-and-sees-blog-posts","User story I.: A user tries to open ",[107,207,109],{},", is redirected to ",[107,210,211],{},"/login",", logs in, then navigate to ",[107,214,109],{}," and sees blog posts",[89,217,218,225,241,258,268,271,274,294,297],{},[66,219,220,221,224],{},"User navigates to ",[107,222,223],{},"http://domain.com/",". This request is handled by the Nuxt server.",[66,226,227,228,230,231,236,237,240],{},"The ",[107,229,178],{}," action is called (",[19,232,235],{"href":233,"rel":234},"https://nuxtjs.org/docs/2.x/directory-structure/store#the-nuxtserverinit-action",[23],"read more on nuxtServerInit","). This is a special Vuex action that, if defined in ",[107,238,239],{},"store/index.js",", will be called once per request to the Nuxt Server (when a page is initially visited or refreshed in the browser).",[66,242,243,245,246,249,250,253,254,257],{},[107,244,178],{}," dispatches a Vuex action in the ",[107,247,248],{},"user"," module called ",[107,251,252],{},"fetchData",". This action makes an GET request to ",[107,255,256],{},"/api/account/"," in the Django application.",[66,259,260,261,263,264,267],{},"An API call to ",[107,262,256],{}," is made to the Django backend directly from the Nuxt container over the docker network (",[107,265,266],{},"backend:8000",")",[66,269,270],{},"If the request is made by an anonymous user (no user is logged in), a 403 response is returned to the Nuxt server and no account data is set in the Vuex store (on the server).",[66,272,273],{},"Since the user is currently not logged in, the request returns a 403 response.",[66,275,276,279,280,282,283,286,287,289,290,293],{},[107,277,278],{},"authMiddleware"," (on the Nuxt server) redirects the user to ",[107,281,211],{}," based on the value of ",[107,284,285],{},"authenticated"," in the Vuex store. The Original request for ",[107,288,109],{}," returns a fully-rendered ",[107,291,292],{},"/login/"," page instead.",[66,295,296],{},"User is now on the Login page",[66,298,227,299,302,303,306],{},[107,300,301],{},"created"," hook for the Login page makes a GET request to ",[107,304,305],{},"/api/login-set-cookie/",".",[10,308,309,310,306],{},"10, 11. This endpoint calls a simple view that is decorated with ",[107,311,312],{},"@ensure_csrf_token",[89,314,316,323,341],{"start":315},12,[66,317,318,319,322],{},"When the response returns to the browser, the ",[107,320,321],{},"csrftoken"," is set in the browser.",[66,324,325,326,329,330,332,333,336,337,340],{},"The $apiCall function is defined in ",[107,327,328],{},"plugins/axios.js",", and it adds the ",[107,331,321],{}," cookie to the ",[107,334,335],{},"X-CSRFToken"," header of API requests. This is important for POST request where the CSRF token is required. When the user fills out their email and password in the login form, the $apiCall function is called with ",[107,338,339],{},"/api/login/"," and the email/password as credentials.",[66,342,343,344,306],{},"The email and password are sent as data in the POST request to ",[107,345,339],{},[10,347,348,349,351,352,355,356,359,360,363,364,367,368,370,371,373,374,377],{},"15, 16. The ",[107,350,339],{}," URL calls the ",[107,353,354],{},"login_view"," which makes use of two functions from ",[107,357,358],{},"django.contrib.auth",": ",[107,361,362],{},"authenticate"," and ",[107,365,366],{},"login",". ",[107,369,362],{}," gets a user from the provided email/password, and the ",[107,372,366],{}," function sets an HttpOnly ",[107,375,376],{},"sessionid"," session cookie on the response.",[89,379,381,390,400],{"start":380},17,[66,382,383,384,386,387,389],{},"The HttpOnly ",[107,385,376],{}," cookie is automatically set on the browser when the ",[107,388,339],{}," request returns successfully.",[66,391,392,393,395,396,399],{},"When this ",[107,394,339],{}," request returns successfully, a value in the ",[107,397,398],{},"auth"," Vuex module is set to keep track of the current user's logged in state.",[66,401,402,403,306],{},"Next, a GET request is made to ",[107,404,256],{},[10,406,407,408,410],{},"20, 21. Since the ",[107,409,376],{}," cookie is set and sent along with the request automatically, this request will succeed.",[89,412,414,423,429,438],{"start":413},22,[66,415,416,417,419,420,422],{},"When the ",[107,418,256],{}," request returns, the user's account information is saved to the ",[107,421,248],{}," Vuex module. At this point, the client may redirect automatically to the home page, or user account page, dashboard, etc.",[66,424,425,426,428],{},"Now logged in, the user navigates (again via Vue router) to ",[107,427,109],{},", a page that shows a paginated view of all blog posts.",[66,430,431,432,434,435,306],{},"This page has an ",[107,433,173],{}," method which is called when the page component is created and it dispatches a Vuex action ",[107,436,437],{},"posts/fetchData",[66,439,440,441,306],{},"This Vuex action makes a GET request to ",[107,442,443],{},"/api/posts/",[10,445,446,447,449,450,453],{},"26, 27. ",[107,448,443],{}," uses a ",[107,451,452],{},"ModelViewSet"," and returns a paginated list of blog posts",[89,455,457],{"start":456},28,[66,458,416,459,461,462,465],{},[107,460,443],{}," request returns successfully, the blog post data is saved to the ",[107,463,464],{},"blog"," Vuex module.",[55,467,469,470],{"id":468},"user-story-ii-logged-in-user-opens-new-browser-window-and-revisits-posts","User story II.: Logged in user opens new browser window and revisits ",[107,471,109],{},[89,473,475,480,485,493,507,515,522,529,541,551],{"start":474},29,[66,476,477,478,306],{},"The user closes their browser and then opens a new browser window and navigates to ",[107,479,109],{},[66,481,482,484],{},[107,483,178],{}," is called as usual,",[66,486,227,487,490,491,306],{},[107,488,489],{},"user/fetchData"," action is called. This action makes a GET request to ",[107,492,256],{},[66,494,227,495,497,498,500,501,503,504,506],{},[107,496,256],{}," request returns successfully. The ",[107,499,376],{}," cookie is passed along from the browser to the API request that is made from the Nuxt server to the backend API (",[107,502,256],{},").  User account data is then set on the Vuex ",[107,505,248],{}," module.",[66,508,227,509,511,512,514],{},[107,510,173],{}," method for the ",[107,513,109],{}," pages is called.",[66,516,517,519,520],{},[107,518,173],{}," dispatches a Vuex action ",[107,521,437],{},[66,523,524,526,527,306],{},[107,525,437],{}," makes an API request to ",[107,528,443],{},[66,530,227,531,533,534,536,537,540],{},[107,532,443],{}," request is handled by a ",[107,535,452],{}," for the ",[107,538,539],{},"Post"," model that gets blog posts and then sets them to the Vuex store (on the server) when the request returns a response (to the Nuxt server).",[66,542,543,544,363,546,536,548,550],{},"Once the async data fetching is compete (",[107,545,178],{},[107,547,173],{},[107,549,109],{}," page), the page HTML is rendered using the Vuex store data stored on the server. The Vuex data is sent back with the rendered HTML (I think this is how it works).",[66,552,553],{},"Finally, the user sees the list of blog posts. The page is loaded \"at once\"; there is no waiting for data to load after loading the page initially.",[37,555,557],{"id":556},"discussion","Discussion",[55,559,561],{"id":560},"complexity","Complexity",[10,563,564],{},"Is this authentication process overly complicated? When I make these diagrams, I try to make simple concept as detailed as possible, but there are a lot of distinct actions being taken in many different parts of the application and getting them all into one diagram was tricky.",[55,566,568],{"id":567},"httponly-session-cookies","HttpOnly Session Cookies",[10,570,571,572,575],{},"Session authentication is the officially recommended way to do authentication with Django REST Framework for clients that run in the browser. However, there seem to be lots of people using JWT with DRF and Javascript clients that run in the browser. The main argument against doing this is that the JWT must be stored in a Javascript-accessible store (localStorage or Cookies) so it can be passed with each request. Many people are also interested in trying to store JWT for authentication in HttpOnly cookies to harden client-side security. I'm very curious to know if anyone is actually doing this, and what the implementation looks like. While ",[107,573,574],{},"djangorestframework_simplejwt"," doesn't support HttpOnly, there seems to be lots of interest in doing this. I think it might be possible with a special middleware, so let me know if anyone is interested in proof-of-concept/diagram for that.",[10,577,578],{},"Some use cases for JWT and other token authentication methods with DRF might include native mobile apps or Desktop apps. For most cases, I think session authentication with Django's built in session cookies for DRF authentication is the best option. JWTs also have no clear solution for logging out, which may be important for some security considerations. The concept of stateless authentication is interesting, but for most use cases I would argue that it is not worth doing. Let me know if anyone has thoughts on this, I'm curious to see what everyone thinks.",[55,580,582],{"id":581},"next-steps","Next Steps",[10,584,585],{},"My next steps for this project/repo are to deploy this to a production environment as soon as I have time to do so. My local setup has been working well, and I think it should work well for a simple DigitalOcean docker swarm deployment like I have done with other Django + Vue projects.",[10,587,588],{},"I also want to add the create, update and delete functionality for posts, improve error handling with API calls, add form validation, and maybe write some tests with Jest.",[37,590,592],{"id":591},"questions","Questions",[10,594,595],{},"Here are some questions and areas that I still need to investigate.",[55,597,599],{"id":598},"nuxt-composition-api","Nuxt Composition API",[10,601,602],{},"I have seen that there is a Composition API module for Nuxt. I have only just now started looking at Composition API examples and documentation for \"vanilla\" Vue, but I have heard that the Nuxt Composition API module has some additional features specifically for use with Nuxt, so I'm curious to learn what these are.",[55,604,606],{"id":605},"nuxt-v3-and-vue-3","Nuxt v3 and Vue 3",[10,608,609],{},"Nuxt looks like it has plans to support Vue 3, so I am interested to learn more about Vue 3 as it is adopted by Vue frameworks such as Nuxt and Quasar.",[55,611,613],{"id":612},"nuxts-fetch-method-server-middleware-nuxt-auth-module","Nuxt's fetch method, server middleware, Nuxt auth module",[10,615,616],{},"I think I am using server middleware correctly, it can be improved by redirecting to the initial requested route after successful login. I'm not sure if I should use the Nuxt auth module in this application, I have read that it doesn't support HttpOnly cookie use cases, but I could be wrong.",{"title":618,"searchDepth":619,"depth":619,"links":620},"",2,[621,622,629,635,640],{"id":39,"depth":619,"text":40},{"id":49,"depth":619,"text":50,"children":623},[624,626,627,628],{"id":57,"depth":625,"text":58},3,{"id":83,"depth":625,"text":84},{"id":120,"depth":625,"text":121},{"id":130,"depth":625,"text":131},{"id":143,"depth":619,"text":144,"children":630},[631,633],{"id":204,"depth":625,"text":632},"User story I.: A user tries to open /posts, is redirected to /login, logs in, then navigate to /posts and sees blog posts",{"id":468,"depth":625,"text":634},"User story II.: Logged in user opens new browser window and revisits /posts",{"id":556,"depth":619,"text":557,"children":636},[637,638,639],{"id":560,"depth":625,"text":561},{"id":567,"depth":625,"text":568},{"id":581,"depth":625,"text":582},{"id":591,"depth":619,"text":592,"children":641},[642,643,644],{"id":598,"depth":625,"text":599},{"id":605,"depth":625,"text":606},{"id":612,"depth":625,"text":613},false,"2021-01-01","This article shows how to use session authentication with Django + Nuxt.js applications","md",null,"/static/django_nuxt_auth_og.png",{},true,"/2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt",{"title":5,"description":647},"2021/01/01/session-authentication-with-django-django-rest-framework-and-nuxt",[657,658,659,660,661],"django","vue","nuxt","drf","authentication","QNhKMyUFZxiHwo7hdnfz0PzsZ9ICARDle0xhC4U0Duc",1753130142329]