<!DOCTYPE html><html  lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Using Stripe for recurring monthly SaaS subscriptions in a Django + Vue application</title><style>html{font-family:Montserrat,Arial,Sans Serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{border:1px solid #3b8070;border-radius:4px;color:#3b8070;display:inline-block;padding:10px 30px;text-decoration:none}.button--green:hover{background-color:#3b8070;color:#fff}.button--grey{border:1px solid #35495e;border-radius:4px;color:#35495e;display:inline-block;margin-left:15px;padding:10px 30px;text-decoration:none}.button--grey:hover{background-color:#35495e;color:#fff}</style><style>span.emoji-mart-emoji[data-v-05905815]{padding:0}.selected[data-v-05905815]{text-shadow:.25px 0 0 #000}.picker[data-v-05905815]{margin-left:auto;margin-right:auto;position:absolute;top:10px;transform:translate(50%,50%)}.top[data-v-05905815]{background-color:var(--color-primary);height:3px;width:100%}</style><style>.selected[data-v-1edc4b99]{text-shadow:.9px 0 0}</style><style>span.emoji-mart-emoji[data-v-de9cb334]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-de9cb334]:hover{transform:scale(1.3)}.centered[data-v-de9cb334]{left:50vw;margin-left:auto;margin-right:auto;position:absolute;right:50vw}</style><style>span.emoji-mart-emoji[data-v-f26190e6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-f26190e6]:hover{transform:scale(1.3)}.picker[data-v-f26190e6]{left:0;margin-left:auto;margin-right:auto;position:absolute;right:0;z-index:10000000000}.localepicker[data-v-f26190e6]{background-color:var(--bg)}.localeText[data-v-f26190e6]{color:var(--color-primary)}</style><style>.tag[data-v-09161b57]{background-color:var(--color-tag);transition:transform .2s}.tag[data-v-09161b57]:hover{transform:scale(1.05)}</style><link rel="stylesheet" href="/_nuxt/entry.C_qR6n1r.css" crossorigin><link rel="stylesheet" href="/_nuxt/app.MFRQdpI0.css" crossorigin><link rel="preload" as="fetch" crossorigin="anonymous" href="/2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application/_payload.json?f7a02a46-9c0e-478e-936c-d4b79733d6b2"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/jzUacxre.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CDMEWRFj.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CzmcxFEq.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B-mOQKwH.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DPol-5Mm.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DuQfXRjE.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DjIsa8m4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/rBAQty2o.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/C4Sm19mx.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CGR4pH2t.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CgFg6jAm.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/D7hIbxa9.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/C5aKNO_V.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BnNjkjIJ.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/lzNerLNA.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CiUqihjK.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BuB7IBBV.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CfTcFQKu.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DidSn7PP.js"><link rel="preload" as="fetch" fetchpriority="low" crossorigin="anonymous" href="/_nuxt/builds/meta/f7a02a46-9c0e-478e-936c-d4b79733d6b2.json"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BAz4hE9E.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DPdwgYFM.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/B9ziLBQK.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DAwWNWwV.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/_7iENaYg.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BVmCdIjn.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/D86XVKAs.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/rgQGHqoJ.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DDRJokCh.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BaoTS1Ec.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/B9rTWv16.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/CJwV7gYv.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/C9IforG0.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/Du9tXjnC.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/Bq3ZV0Cc.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BPxGl8VU.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DbwMaSgs.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/zTRos7l-.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BZZoewB1.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/BSjOxtvE.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/CRVSn5jR.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/UiuPncGx.js"><meta name="description" content="Brian Caffey's personal website"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="robots" content="all"><meta property="twitter:creator" content="@briancaffey"><meta property="twitter:site" content="@briancaffey"><meta property="og:title" content="Using Stripe for recurring monthly SaaS subscriptions in a Django + Vue application"><meta property="og:description" content="This article shares my experience learning and implementing the Stripe API for recurring monthly SaaS subscription payments in an application using Django and Vue.js"><meta property="og:image" content="https://briancaffey.github.io/static/django_vue_stripe.png"><meta property="twitter:image" content="https://briancaffey.github.io/static/django_vue_stripe.png"><meta property="twitter:card" content="summary_large_image"><script type="module" src="/_nuxt/jzUacxre.js" crossorigin></script><script>"use strict";(()=>{const t=window,e=document.documentElement,c=["dark","light"],n=getStorageValue("localStorage","nuxt-color-mode")||"system";let i=n==="system"?u():n;const r=e.getAttribute("data-color-mode-forced");r&&(i=r),l(i),t["__NUXT_COLOR_MODE__"]={preference:n,value:i,getColorScheme:u,addColorScheme:l,removeColorScheme:d};function l(o){const s=""+o+"-mode",a="";e.classList?e.classList.add(s):e.className+=" "+s,a&&e.setAttribute("data-"+a,o)}function d(o){const s=""+o+"-mode",a="";e.classList?e.classList.remove(s):e.className=e.className.replace(new RegExp(s,"g"),""),a&&e.removeAttribute("data-"+a)}function f(o){return t.matchMedia("(prefers-color-scheme"+o+")")}function u(){if(t.matchMedia&&f("").media!=="not all"){for(const o of c)if(f(":"+o).matches)return o}return"light"}})();function getStorageValue(t,e){switch(t){case"localStorage":return window.localStorage.getItem(e);case"sessionStorage":return window.sessionStorage.getItem(e);case"cookie":return getCookie(e);default:return null}}function getCookie(t){const c=("; "+window.document.cookie).split("; "+t+"=");if(c.length===2)return c.pop()?.split(";").shift()}</script></head><body><div id="__nuxt"><div><div><div data-v-05905815><div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-05905815><div class="justify-left flex-grow flex-cols-4" data-v-05905815><a href="/" class="text-xl" data-v-05905815><span class="hidden sm:inline text-2xl" data-v-05905815>Brian Caffey</span><span class="inline sm:hidden" data-v-05905815>JBC</span></a></div><div class="flex-grow relative" data-v-05905815><nav z-index="10000" data-v-05905815 data-v-1edc4b99><div data-v-1edc4b99><ul class="items-right float-right hidden md:flex" data-v-1edc4b99><li class="px-4 text-lg" data-v-1edc4b99><a href="/blog/1" class="" data-v-1edc4b99>Blog</a></li><li class="px-4 text-lg" data-v-1edc4b99><a href="/contact" class="" data-v-1edc4b99>Contact</a></li></ul><div class="flex justify-end md:hidden z-1000" data-v-1edc4b99><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-1edc4b99><svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-1edc4b99><title data-v-1edc4b99>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-1edc4b99></path></svg></button></div><!----></div></nav></div></div><div class="picker" data-v-05905815><div class="centered" data-v-05905815 data-v-de9cb334><div class="grid items-center justify-center" data-v-de9cb334><ul class="flex px-4" data-v-de9cb334><!--[--><li class="md:px-1 px-1 cursor-pointer" data-v-de9cb334><span aria-label="üñ•Ô∏è, desktop_computer" class="emoji-mart-emoji" data-v-de9cb334><span class="emoji-set-apple emoji-type-image" style="background-position:51.67% 95%;width:32px;height:32px;"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-de9cb334><span aria-label="üåû, sun_with_face" class="emoji-mart-emoji" data-v-de9cb334><span class="emoji-set-apple emoji-type-image" style="background-position:8.33% 48.33%;width:32px;height:32px;"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-de9cb334><span aria-label="üåö, new_moon_with_face" class="emoji-mart-emoji" data-v-de9cb334><span class="emoji-set-apple emoji-type-image" style="background-position:8.33% 41.67%;width:32px;height:32px;"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-de9cb334><span aria-label="‚òï, coffee" class="emoji-mart-emoji" data-v-de9cb334><span class="emoji-set-apple emoji-type-image" style="background-position:95% 30%;width:32px;height:32px;"></span></span></li><!--]--><li class="md:px-1 px-1 cursor-pointer" data-v-de9cb334><div data-v-de9cb334 data-v-f26190e6><ul data-v-f26190e6><li class="md:px-1 px-1 cursor-pointer" data-v-f26190e6><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-f26190e6><span class="emoji-set-apple emoji-type-image" style="background-position:6.67% 45%;width:32px;height:32px;"></span></span></li></ul><div class="rounded-md z-10 picker" data-v-f26190e6><!----></div></div></li></ul></div></div></div></div><!--[--><article><img onerror="this.setAttribute(&#39;data-error&#39;, 1)" alt="This article shares my experience learning and implementing the Stripe API for recurring monthly SaaS subscription payments in an application using Django and Vue.js" data-nuxt-img srcset="/_ipx/f_webp/static/django_vue_stripe.png 1x, /_ipx/f_webp/static/django_vue_stripe.png 2x" class="pt-2 w-full object-cover" style="height:32rem;" src="/_ipx/f_webp/static/django_vue_stripe.png"><div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2"><h1 class="prose text-4xl leading-9 py-4 font-bold">Using Stripe for recurring monthly SaaS subscriptions in a Django + Vue application</h1><div class="flex flex-wrap -ml-1 py-2"><!--[--><a href="/blog/tags/django/" class="" data-v-09161b57><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-09161b57>django üè∑Ô∏è <!----></div></a><a href="/blog/tags/vue/" class="" data-v-09161b57><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-09161b57>vue üè∑Ô∏è <!----></div></a><a href="/blog/tags/drf/" class="" data-v-09161b57><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-09161b57>drf üè∑Ô∏è <!----></div></a><a href="/blog/tags/stripe/" class="" data-v-09161b57><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mb-1 uppercase cursor-pointer tag" data-v-09161b57>stripe üè∑Ô∏è <!----></div></a><!--]--></div><!----><p class="blog-date text-gray-500 mb-4">Last updated January 2, 2021</p><!----><div class="markdown"><h1 id="using-stripe-for-recurring-monthly-payments-to-a-paid-saas-subscription-in-a-django-vuejs-application"><!--[-->Using Stripe for recurring monthly payments to a paid SaaS subscription in a Django + Vue.js application<!--]--></h1><p><!--[-->This diagram shows the flow of data for the lifecycle of a paid customer subscription in a Django application with a Vue.js client. There are four stages:<!--]--></p><p><!--[-->I. Account setup, configuration, model and object creation
II. Logic and data flow for starting a customer&#39;s premium monthly subscription
III. Automatic subscription renewal
IV. Cancelling a premium subscription<!--]--></p><h2 id="context"><a href="#context"><!--[-->Context<!--]--></a></h2><p><!--[-->This is my first attempt at using Stripe, or any other online payment service API. Most of what I have diagramed here comes from this article from the Stripe documentation: <a href="https://stripe.com/docs/billing/subscriptions/fixed-price" rel="nofollow"><!--[-->https://stripe.com/docs/billing/subscriptions/fixed-price<!--]--></a>. Knowing almost nothing about what is needed to create a SaaS subscription, I found this article very helpful. It was a lot to read at once, but each call to to the Stripe API is very clear and straightforward.<!--]--></p><p><!--[-->I made some modifications and additions to this walk-through for my use case, which is an API service called Open SEC Data, an open source project that I&#39;m working on (<a href="https://gitlab.com/briancaffey/sec-filings-app" rel="nofollow"><!--[-->https://gitlab.com/briancaffey/sec-filings-app<!--]--></a>).<!--]--></p><h2 id="diagram"><a href="#diagram"><!--[-->Diagram<!--]--></a></h2><p><!--[-->Here&#39;s a read-only link to the diagram: <a href="https://drive.google.com/file/d/1oH2b0W-c-dI5oXzc_jvCGvXx9sJagr4a/view?usp=sharing" rel="nofollow"><!--[-->https://drive.google.com/file/d/1oH2b0W-c-dI5oXzc_jvCGvXx9sJagr4a/view?usp=sharing<!--]--></a>. This diagram is made with <a href="https://www.diagrams.net/" rel="nofollow"><!--[-->https://www.diagrams.net/<!--]--></a>.<!--]--></p><p><!--[--><img onerror="this.setAttribute(&#39;data-error&#39;, 1)" alt="png" data-nuxt-img srcset="/_ipx/_/static/django_vue_stripe_diagram.png 1x, /_ipx/_/static/django_vue_stripe_diagram.png 2x" src="/_ipx/_/static/django_vue_stripe_diagram.png"><!--]--></p><h2 id="legend"><a href="#legend"><!--[-->Legend<!--]--></a></h2><p><!--[-->Here&#39;s a detailed description of each part of the diagram, starting with the first section.<!--]--></p><h3 id="i-account-setup-configuration-model-and-object-creation"><a href="#i-account-setup-configuration-model-and-object-creation"><!--[-->I. Account setup, configuration, model and object creation<!--]--></a></h3><ol><!--[--><li><!--[-->Setup a Stripe account. For local development, make sure you turn on <code><!--[-->View test data<!--]--></code>. On your local machine, install the stripe CLI and authenticate with your Stripe account<!--]--></li><li><!--[-->Create a Product in Stripe (mine is called <code><!--[-->Open SEC Data Premium Subscription<!--]--></code>)<!--]--></li><li><!--[-->Create a Price in Stripe that references the Product.<br>Instead of creating these objects in the Stripe Dashboard, you can also create them with the Stripe CLI or the Python SDK. I created a Django management command called <code><!--[-->create_stripe_data<!--]--></code> that will create a Product and related Price in Stripe. We will need the id of the Price, it looks like this: <code><!--[-->price_1Hx0goL67dRDwyuDh9yEWsBo<!--]--></code>.<!--]--></li><li><!--[-->Add the Price ID as an environment variable <code><!--[-->SUBSCRIPTION_PRICE_ID<!--]--></code> to the backend. This will be used later when we make API calls to Stripe from inside of Django views.<!--]--></li><li><!--[-->For production environments, you will need to a register a Stripe webhook. This is an endpoint in Django that Stripe will POST to in order to inform the Django application of events that have happened in Stripe.<br>For local development we need to run <code><!--[-->stripe listen --forward-to localhost/api/stripe-webhooks/<!--]--></code> in order to forward webhook events to the local Django application. This works really well for local development.<!--]--></li><li><!--[-->In both local and production environments we need to add an environment variables to the Django application that will be used to validate the webhook event.<!--]--></li><li><!--[-->You will need to create a <code><!--[-->Subscription<!--]--></code> model or similar in your Django models. This model should be related to your user model in some way. At a minimum it should have the <code><!--[-->subscription_id<!--]--></code> (the ID of the Stripe Subscription) and <code><!--[-->current_period_end<!--]--></code> (also from the Stripe Subscription object). We will use this model in the next sections.<!--]--></li><li><!--[--><code><!--[-->/api/stripe-webhooks/<!--]--></code> is the endpoint in the Django application that Stripe will send POST requests to in order to inform the Django application of events that happen in Stripe. The URL can be called anything you want, as long as you register it with that URL. In local development, you need to specify this URL in the <code><!--[-->stipe listen<!--]--></code> command (for example, <code><!--[-->stripe listen forward-to localhost/api/stripe-webhooks/<!--]--></code>).<!--]--></li><li><!--[--><code><!--[-->STRIPE_SECRET_KEY<!--]--></code> is the name of the secret API key that should only be accessible by the backend. In local development, this key looks like <code><!--[-->sk_test_Abc123<!--]--></code>. In production, this key will look like <code><!--[-->sk_Abc123<!--]--></code>.<!--]--></li><li><!--[--><code><!--[-->stripe<!--]--></code> is the name of the PyPI package that we need to add to <code><!--[-->requirements.txt<!--]--></code> (<code><!--[-->requirements/base.txt<!--]--></code>).<!--]--></li><li><!--[--><code><!--[-->STRIPE_PUBLISHABLE_KEY<!--]--></code> is the value of the Stripe API key that can be made public and is used in the Vue application to instantiate Stripe.<!--]--></li><li><!--[-->The Stripe library is included in <code><!--[-->index.html<!--]--></code> via CDN so that it is accessible anywhere in the Vue application. Stripe object is instantiated in the Vue application with:<blockquote><!--[--><p><!--[--><code><!--[-->let stripe = Stripe(process.env.STRIPE_PUBLISHABLE_KEY)<!--]--></code><!--]--></p><!--]--></blockquote><!--]--></li><!--]--></ol><h3 id="ii-logic-and-data-flow-for-starting-a-customers-premium-monthly-subscription"><a href="#ii-logic-and-data-flow-for-starting-a-customers-premium-monthly-subscription"><!--[-->II. Logic and data flow for starting a customer&#39;s premium monthly subscription<!--]--></a></h3><p><!--[-->With everything setup and configured properly in Stripe, the backend Django application and the frontend Vue application, customers can now start paying for monthly subscriptions. In my application, a user can sign up for an account first without having a premium subscription. In other scenarios, having an active account may require a premium subscription.<!--]--></p><ol start="13"><!--[--><li><!--[-->When a logged-in user visits their <code><!--[-->/account<!--]--></code> page, they will see the status of their account: Basic (free) or Premium (paid subscription). Users on a Basic plan will see the option to upgrade to Premium. They will be redirected to a <code><!--[-->/premium<!--]--></code> page where they will be presented with a credit card form. This credit card form is generated by <a href="https://stripe.com/payments/elements" rel="nofollow"><!--[-->Stripe Elements<!--]--></a>. The user fills out their credit card, expiration date, card security code and billing ZIP code and then clicks <code><!--[-->Purchase<!--]--></code>.<!--]--></li><li><!--[-->Clicking on <code><!--[-->Purchase<!--]--></code> calls a method <code><!--[-->purchase<!--]--></code> that calls <code><!--[-->stripe.CreatePaymentMethod<!--]--></code>. The <code><!--[-->paymentMethodId<!--]--></code> token returned from <code><!--[-->stripe.CreatePaymentMethod<!--]--></code> is then passed to the method called <code><!--[-->createSubscription<!--]--></code>.<!--]--></li><li><!--[-->Stripe creates this object and returns a response that contains a <code><!--[-->paymentMethodId<!--]--></code> token.<!--]--></li><li><!--[--><code><!--[-->createSubscription<!--]--></code> sends a POST request to <code><!--[-->/api/stripe/create-subscription/<!--]--></code> in the Django application with the <code><!--[-->paymentMethodId<!--]--></code> that we generated in the previous step.<!--]--></li><li><!--[--><code><!--[-->/api/stripe/create-subscription/<!--]--></code> calls a view called <code><!--[-->create_subscription<!--]--></code> which makes a number of API calls to Stripe and then finally saves some data in the application&#39;s Postgres database.<!--]--></li><li><!--[-->The first API call creates the Customer object in Stripe if it does not exist. <code><!--[-->email=request.user.email<!--]--></code> is used in the API call to associate the Stripe customer with the user&#39;s email.<!--]--></li><li><!--[-->Next the payment method is attached to Stripe Customer model.<!--]--></li><li><!--[-->Next the Stripe payment method is set as the default payment method for Stripe customer for future billing.<!--]--></li><li><!--[-->The Stripe subscription model is created with the customer ID that was created in the earlier and the price ID corresponding to the premium subscription (added in the setup stage).<!--]--></li><li><!--[-->Once these Stripe API calls have finished, a new Subscription is saved in the Postgres database. <code><!--[-->stripe_subscription_id<!--]--></code>, <code><!--[-->stripe_customer_id<!--]--></code> and <code><!--[-->valid_through<!--]--></code> (DateTimeField that keeps track of the date through which the user&#39;s subscription has been paid for) are saved to the <code><!--[-->Subscription<!--]--></code> model and then the subscription model is saved to the user model&#39;s <code><!--[-->subscription<!--]--></code> field.<!--]--></li><li><!--[-->When the <code><!--[-->createSubscription<!--]--></code> method&#39;s POST requests returns successfully, the user&#39;s account is fetched again from <code><!--[-->/api/account/<!--]--></code><!--]--></li><li><!--[-->The browser makes a request to <code><!--[-->/api/account/<!--]--></code>.<!--]--></li><li><!--[--><code><!--[-->/api/account/<!--]--></code> returns information on the user and their subscription.<!--]--></li><li><!--[-->Data from <code><!--[-->/api/account/<!--]--></code> is updated in Vuex <code><!--[-->user<!--]--></code> store.<!--]--></li><li><!--[-->The user is now able to make requests to resources for premium features.<!--]--></li><li><!--[-->In this application, one such example is the ability to request an API key for making for making API calls.<!--]--></li><li><!--[-->A user makes a request to an API endpoint for a premium feature.<!--]--></li><li><!--[-->When determining permissions for resources that should only be accessible to customers with valid subscriptions, we need to compare <code><!--[-->request.user.subscription.valid_through<!--]--></code> to <code><!--[-->timezone.now()<!--]--></code> and make sure that <code><!--[-->valid_through<!--]--></code> is greater than <code><!--[-->timezone.now()<!--]--></code>.<!--]--></li><li><!--[-->Requests for protected resources are successfully returned to the browser.<!--]--></li><!--]--></ol><h3 id="iii-automatic-subscription-renewal"><a href="#iii-automatic-subscription-renewal"><!--[-->III. Automatic subscription renewal<!--]--></a></h3><p><!--[-->The customer&#39;s credit card is charged once each month that they are subscribed to the service. This action happens in Stripe. This section assumes that the customer&#39;s primary payment method is still valid (it has not been canceled expired or not able to be charged for some other reason).<!--]--></p><ol start="32"><!--[--><li><!--[-->The customer&#39;s card is charged in Stripe and an event is sent to the Django backend via a webhook that we registered in the setup stage.<!--]--></li><li><!--[-->The webhook view checks <code><!--[-->event.type<!--]--></code> and if the event is of type <code><!--[-->invoice.paid<!--]--></code> we extend the user&#39;s subscription by one month.<!--]--></li><li><!--[-->To extend the user&#39;s subscription, we modify the <code><!--[-->DateTimeField<!--]--></code> field on the <code><!--[-->Subscription<!--]--></code> that tracks the <code><!--[-->current_period_end<!--]--></code> which is included in the webhook data object. The model field in my code is called <code><!--[-->valid_through<!--]--></code>.<!--]--></li><!--]--></ol><h3 id="iv-cancelling-a-premium-subscription"><a href="#iv-cancelling-a-premium-subscription"><!--[-->IV. Cancelling a premium subscription<!--]--></a></h3><ol start="35"><!--[--><li><!--[-->When a user decides to cancel their payed subscription service, they click on the <code><!--[-->Cancel My Subscription<!--]--></code> button.<!--]--></li><li><!--[-->This makes a POST request to <code><!--[-->/api/stripe/cancel-subscription<!--]--></code> which calls the <code><!--[-->cancel_subscription<!--]--></code> view. This view calls <code><!--[-->stripe.Subscription.delete(subscriptionId)<!--]--></code>, where the <code><!--[-->subscriptionId<!--]--></code> is retrieved from <code><!--[-->request.user.subscription<!--]--></code> (the <code><!--[-->Subscription<!--]--></code> model created in the setup section).<!--]--></li><li><!--[-->The subscription is deleted in Stripe through the <code><!--[-->stripe.Subscription.delete<!--]--></code> API call.<!--]--></li><li><!--[-->The user&#39;s subscription is deleted from the user model with <code><!--[-->request.user.subscription.delete()<!--]--></code>.<!--]--></li><li><!--[-->The frontend responds to the deleted subscription by fetching <code><!--[-->/api/account/<!--]--></code> again, refresh, or redirecting and the user no longer has access to their premium subscription.<!--]--></li><!--]--></ol></div><div class="text-center pb-4 pt-8"><button class="mc-btn rounded py-1 px-2"> Show Disqus Comments üí¨ </button></div><!----><h1></h1></div></article><!--]--><div class="mx-auto max-w-6xl p-4 lg:px-16 text-center"><hr class="mt-4"><div class="align-center py-4"><div class="pb-4">Join my mailing list to get updated whenever I publish a new article.</div><div class="flex align-center justify-center"><div id="mc_embed_signup" class="w-full md:w-1/2 flex-shrink justify-center"><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&amp;id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4"><input id="mce-EMAIL" type="email" value="" name="EMAIL" placeholder="Enter your email address" class="rounded mc text-center" autocomplete="on"><div style="position:absolute;left:-5000px;" aria-hidden="true"><input type="text" name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" value=""></div><div class="text-right" style="width:100%;"><input id="mc-embedded-subscribe" type="submit" value="Subscribe" name="subscribe" class="mc-btn rounded px-2 py-1 w-full"></div></div></form></div></div></div><hr><div class="py-4">Thanks for checking out my site!</div><div class="pb-4"> ¬© 2025 Brian Caffey </div></div></div></div></div><div id="teleports"></div><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__" data-src="/2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application/_payload.json?f7a02a46-9c0e-478e-936c-d4b79733d6b2">[{"state":1,"once":18,"_errors":19,"serverRendered":5,"path":21,"pinia":22,"prerenderedAt":23},["Reactive",2],{"$scolor-mode":3,"$si18n:cached-locale-configs":7,"$si18n:resolved-locale":8,"$ssite-config":9},{"preference":4,"value":4,"unknown":5,"forced":6},"system",true,false,{},"",{"_priority":10,"currentLocale":14,"defaultLocale":14,"env":15,"name":16,"url":17},{"name":11,"env":12,"url":11,"defaultLocale":13,"currentLocale":13},-3,-15,-2,"en-US","production","briancaffey.github.io","https://briancaffey.github.io",["Set"],["ShallowReactive",20],{"using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application":-1},"/2021/01/02/using-the-stripe-api-for-recurring-monthly-saas-subscription-payments-in-django-and-vue-application",{},1757463808139]</script><script>window.__NUXT__={};window.__NUXT__.config={public:{url:"https://briancaffey.github.io",content:{wsUrl:""},mdc:{components:{prose:true,map:{}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}},gtag:{enabled:true,initMode:"auto",id:"G-S8TVBBMW66",initCommands:[],config:{},tags:[],loadingStrategy:"defer",url:"https://www.googletagmanager.com/gtag/js"},i18n:{baseUrl:"",defaultLocale:"en",rootRedirect:"",redirectStatusCode:302,skipSettingLocaleOnNavigate:false,locales:[{code:"en",emoji:"flag-us",iso:"en-US",name:"English",flag:"üá∫üá∏",language:"en-US",_hreflang:"en-US",_sitemap:"en-US"},{code:"fr",emoji:"flag-fr",iso:"fr-FR",name:"Fran√ßais",flag:"üá´üá∑",language:"fr-FR",_hreflang:"fr-FR",_sitemap:"fr-FR"},{code:"zh",emoji:"flag-cn",iso:"zh-ZH",name:"ÁÆÄ‰Ωì‰∏≠Êñá",flag:"üá®üá≥",language:"zh-ZH",_hreflang:"zh-ZH",_sitemap:"zh-ZH"},{code:"ru",emoji:"flag-ru",iso:"ru-RU",name:"–†—É—Å—Å–∫–∏–π",flag:"üá∑üá∫",language:"ru-RU",_hreflang:"ru-RU",_sitemap:"ru-RU"},{code:"ja",emoji:"flag-jp",iso:"ja-JP",name:"Êó•Êú¨Ë™û",flag:"üáØüáµ",language:"ja-JP",_hreflang:"ja-JP",_sitemap:"ja-JP"},{code:"in",emoji:"flag-in",iso:"hi-IN",name:"‡§π‡§ø‡§Ç‡§¶‡•Ä",flag:"üáÆüá≥",language:"hi-IN",_hreflang:"hi-IN",_sitemap:"hi-IN"}],detectBrowserLanguage:{alwaysRedirect:false,cookieCrossOrigin:false,cookieDomain:"",cookieKey:"i18n_redirected",cookieSecure:false,fallbackLocale:"",redirectOn:"root",useCookie:true},experimental:{localeDetector:"",typedPages:true,typedOptionsAndMessages:false,alternateLinkCanonicalQueries:true,devCache:false,cacheLifetime:"",stripMessagesPayload:false,preload:false,strictSeo:false,nitroContextDetection:true},domainLocales:{en:{domain:""},fr:{domain:""},zh:{domain:""},ru:{domain:""},ja:{domain:""},in:{domain:""}}}},app:{baseURL:"/",buildId:"f7a02a46-9c0e-478e-936c-d4b79733d6b2",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>