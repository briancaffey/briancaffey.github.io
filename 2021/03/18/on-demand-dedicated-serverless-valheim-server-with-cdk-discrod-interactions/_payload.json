[{"data":1,"prerenderedAt":3167},["ShallowReactive",2],{"on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions":3},{"id":4,"title":5,"body":6,"comments":3150,"date":3151,"description":3152,"draft":3150,"extension":3153,"external":3154,"image":3155,"meta":3156,"navigation":329,"path":3157,"seo":3158,"stem":3159,"tags":3160,"__hash__":3166},"blog/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions.md","On-demand, serverless Valheim server setup with AWS CDK, Discord Interactions and GitLab CI",{"type":7,"value":8,"toc":3128},"minimark",[9,22,25,28,31,40,53,61,67,80,84,99,117,155,158,165,168,172,179,198,208,211,225,231,236,247,252,259,268,274,288,292,298,585,591,597,600,606,609,615,625,628,634,649,653,664,998,1008,1012,1019,1025,1032,1038,1042,1049,1099,1112,1283,1289,1295,1302,1308,1312,1319,1453,1467,1470,1476,1483,1525,1536,1540,1546,1670,1673,1679,1682,1685,1689,1710,1716,1722,1728,1747,1752,2293,2311,2315,2327,2641,2648,2651,2660,2664,2667,2783,2806,2809,2813,2816,2822,2834,2840,2849,2966,2969,2977,2986,2990,2993,2997,3091,3095,3098,3121,3124],[10,11,12],"blockquote",{},[13,14,15,16],"p",{},"Here's a link to the GitLab repo I'll be referencing in this article: ",[17,18,19],"a",{"href":19,"rel":20},"https://gitlab.com/briancaffey/valheim-cdk-discord-interactions",[21],"nofollow",[13,23,24],{},"This is an in-depth technical article about running an on-demand, dedicated server for Valheim using Amazon Web Services controlled with Discord Slash Commands, a new part their Interactions API that is currently in beta. Valheim is an open-world online multiplayer survival game loosely based on Norse mythology that has blown up recently.",[13,26,27],{},"My main goal with this project was to find an inexpensive way of running a server given how my friends and I play the game, which is typically a few times a week in the evenings. Some combination of 4 of us will start playing, and we drop in and out between walking dogs, cooking, etc. When playing, we all jump on a dedicated voice channel on our group's Discord.",[13,29,30],{},"Before setting up a dedicated server, our game's world state was stored on files that lived on one of our computers, and that computer needed to be running the game server in order for anyone to connect. Sending files around would be possible, but would quickly become tedious. There are lots of services that offer dedicated servers for Valheim, as well as many technical guides and channels on the official Valheim Discord server to support the use of dedicated servers. I wanted to see if I could set up a server myself on AWS using CDK, or Cloud Development Kit. CDK is an Infrastructure as Code (IaC) tool that allows you to define, deploy and update AWS infrastructure with popular programming languages such as Python, Typescript, Java, etc.",[32,33,35,39],"h2",{"id":34},"cdk-valheim-construct-on-github",[36,37,38],"code",{},"cdk-valheim"," construct on GitHub",[13,41,42,43,47,48,52],{},"The best part of CDK is that it enables the creation high-level, reusable constructs that can be published to software registries like npm and PyPI. Developers can import and use these constructs in their own CDK code. A quick google search for \"cdk valheim\" turned up a few results. ",[17,44,38],{"href":45,"rel":46},"https://github.com/gotodeploy/cdk-valheim",[21]," seems like the best option for what I was looking for. This project uses ECS, a container orchestration tool from AWS that I have experience using with web applications and EFS for persistent file storage. Although it is written in Typescript, I can still use the construct in my preferred programming language (Python) without any extra effort or configuration. This is thanks to the jsii. From ",[17,49,50],{"href":50,"rel":51},"https://github.com/aws/jsii",[21],":",[10,54,55],{},[13,56,57,60],{},[36,58,59],{},"jsii"," allows code in any language to naturally interact with JavaScript classes. It is the technology that enables the AWS Cloud Development Kit to deliver polyglot libraries from a single codebase!",[13,62,63,64,66],{},"Here's an overview of the ",[36,65,38],{}," construct:",[68,69,70,74,77],"ul",{},[71,72,73],"li",{},"Scheduled scaling of an ECS service using AWS Fargate (a serverless compute engine for containers)",[71,75,76],{},"Elastic File System (EFS) file system mounted into the Fargate Task container of our ECS service",[71,78,79],{},"Optional automated backups of the EFS file system using AWS Backup",[32,81,83],{"id":82},"discord-interactions-and-slash-commands","Discord Interactions and Slash Commands",[13,85,86,87,90,91,94,95,98],{},"Scheduled ECS scaling is nice, but we don't always know when we will be able to play together, so it is not the best way to minimize infrastructure costs. My plan was to set the ECS service to an initial task count of zero and then let any of us set the number of tasks to either zero or one through a Discord Slash Command. A Slash Command allows you to interact with a discord bot by typing ",[36,88,89],{},"/"," and then tabbing through to the option we want, such as ",[36,92,93],{},"/valheim server start"," or ",[36,96,97],{},"/valheim server status",".",[13,100,101,102,105,106,94,109,112,113,116],{},"Invoking a Slash Command from Discord sends a ",[36,103,104],{},"POST"," request from Discord to a webhook URL that we have to provide. To handle the webhook, one simple and inexpensive approach is to use API Gateway and a Lambda function that serves a Flask app. The Flask app can then use boto3 (which is included in the Lambda execution environment) to call ",[36,107,108],{},"update_service",[36,110,111],{},"describe_services"," to scaled the ECS task's ",[36,114,115],{},"desiredCount"," based on the slash command options and sub options.",[13,118,119,120,122,123,126,127,130,131,134,135,138,139,94,142,145,146,148,149,94,152,98],{},"The function that handles the webhook ",[36,121,104],{}," request when the sub-command is ",[36,124,125],{},"status"," queries AWS for the number of ECS tasks in our service that are ",[36,128,129],{},"desired",", ",[36,132,133],{},"running"," and ",[36,136,137],{},"pending"," and then sends back a message that will be displayed to the user who sent the command. When the sub-command is ",[36,140,141],{},"start",[36,143,144],{},"stop",", the ",[36,147,115],{}," is either set to ",[36,150,151],{},"1",[36,153,154],{},"0",[13,156,157],{},"Here's an overview of the server setup and how Discord Slash Commands can be used to control the server:",[13,159,160],{},[161,162],"img",{"alt":163,"src":164},"png","/static/valheim/diagram.png",[13,166,167],{},"I'll cover each of the steps labelled in this diagram at the end of the article. The rest of the article will provide detailed instructions for how to set everything up. I won't be going over AWS account setup or Discord server setup.",[32,169,171],{"id":170},"how-to-set-up-the-discord-developer-application-and-interaction","How to set up the Discord developer application and Interaction",[13,173,174,175,178],{},"First, you need to be the admin of a Discord server. Once you create the server, go to ",[36,176,177],{},"Server Settings > Widget"," and take note of the Server ID. This is also known as the Guild ID.",[13,180,181,182,186,187,190,191,194,195,52],{},"Then go to ",[17,183,184],{"href":184,"rel":185},"https://discord.com/developers/applications",[21]," and create an application. Under ",[36,188,189],{},"General Information",", make note of the public key (the application ID). Put these values in a file that will be ",[36,192,193],{},".gitignored"," called ",[36,196,197],{},".env",[199,200,205],"pre",{"className":201,"code":203,"language":204},[202],"language-text","export GUILD_ID=123456789\nexport APPLICATION_ID=abc123\n","text",[36,206,203],{"__ignoreMap":207},"",[13,209,210],{},"We will use this file later when registering the Interaction.",[13,212,213,214,217,218,134,221,224],{},"Next go to the ",[36,215,216],{},"OAuth2"," tab and select the ",[36,219,220],{},"bot",[36,222,223],{},"applications.commands"," permissions. This will generated an OAuth2 authorization link. Copy the link and open it in a browser. We will see an error:",[199,226,229],{"className":227,"code":228,"language":204},[202],"OAuth2 application does not have a bot\n",[36,230,228],{"__ignoreMap":207},[232,233,235],"h3",{"id":234},"configure-a-bot-for-our-discord-application","Configure a bot for our Discord application",[13,237,238,239,242,243,246],{},"Next, got to the ",[36,240,241],{},"Bot"," tab and click the ",[36,244,245],{},"Add Bot"," button.",[10,248,249],{},[13,250,251],{},"Adding a bot user gives your app visible life in Discord. However, this action is irrevocable! Choose wisely.",[13,253,254,255,258],{},"Turn off the ",[36,256,257],{},"Public Bot"," option and save changes.",[13,260,261,262,265,266,52],{},"Get the bot token by clicking on ",[36,263,264],{},"Click to Reveal Token",", and add this to ",[36,267,197],{},[199,269,272],{"className":270,"code":271,"language":204},[202],"export BOT_TOKEN=abc.xyz.123\n",[36,273,271],{"__ignoreMap":207},[13,275,276,277,217,279,134,281,283,284,287],{},"Now go back to the ",[36,278,216],{},[36,280,220],{},[36,282,223],{}," permissions again, copy the link and open it. Select the server that you want to add this application to. You should see a captcha, and then a message that says ",[36,285,286],{},"Authorized",". You should also see a message from your discord server that the bot has joined the server.",[232,289,291],{"id":290},"create-the-interaction","Create the Interaction",[13,293,294,295,297],{},"Now we will set up the Interaction. Currently the only way to set up the interaction is through an HTTP ",[36,296,104],{}," request. This Python script sets up our Interaction:",[199,299,303],{"className":300,"code":301,"language":302,"meta":207,"style":207},"language-py shiki shiki-themes github-light github-dark","\"\"\"\nhttps://discord.com/developers/docs/interactions/slash-commands#registering-a-command\n\"\"\"\n\nimport os\n\nimport requests\n\nAPPLICATION_ID = os.environ.get(\"APPLICATION_ID\")\nGUILD_ID = os.environ.get(\"GUILD_ID\")\nBOT_TOKEN = os.environ.get(\"BOT_TOKEN\")\n\nurl = f\"https://discord.com/api/v8/applications/{APPLICATION_ID}/guilds/{GUILD_ID}/commands\"\n\njson = {\n    \"name\": \"vh\",\n    \"description\": \"Start, stop or get the status of the Valheim server\",\n    \"options\": [\n        {\n            \"name\": \"valheim_server_controls\",\n            \"description\": \"What do you want to do?\",\n            \"type\": 3,\n            \"required\": True,\n            \"choices\": [\n                {\n                    \"name\": \"status\",\n                    \"value\": \"status\"\n                },\n                {\n                    \"name\": \"start\",\n                    \"value\": \"start\"\n                },\n                {\n                    \"name\": \"stop\",\n                    \"value\": \"stop\"\n                }\n            ]\n        },\n    ]\n}\n\nheaders = {\n    \"Authorization\": f\"Bot {BOT_TOKEN}\"\n}\n\nif __name__ == \"__main__\":\n    r = requests.post(url, headers=headers, json=json)\n    print(r.content)\n","py",[36,304,305,313,319,324,331,337,342,348,353,359,365,371,376,382,387,393,399,405,411,417,423,429,435,441,447,453,459,465,471,476,482,488,493,498,504,510,516,522,528,534,540,545,551,557,562,567,573,579],{"__ignoreMap":207},[306,307,310],"span",{"class":308,"line":309},"line",1,[306,311,312],{},"\"\"\"\n",[306,314,316],{"class":308,"line":315},2,[306,317,318],{},"https://discord.com/developers/docs/interactions/slash-commands#registering-a-command\n",[306,320,322],{"class":308,"line":321},3,[306,323,312],{},[306,325,327],{"class":308,"line":326},4,[306,328,330],{"emptyLinePlaceholder":329},true,"\n",[306,332,334],{"class":308,"line":333},5,[306,335,336],{},"import os\n",[306,338,340],{"class":308,"line":339},6,[306,341,330],{"emptyLinePlaceholder":329},[306,343,345],{"class":308,"line":344},7,[306,346,347],{},"import requests\n",[306,349,351],{"class":308,"line":350},8,[306,352,330],{"emptyLinePlaceholder":329},[306,354,356],{"class":308,"line":355},9,[306,357,358],{},"APPLICATION_ID = os.environ.get(\"APPLICATION_ID\")\n",[306,360,362],{"class":308,"line":361},10,[306,363,364],{},"GUILD_ID = os.environ.get(\"GUILD_ID\")\n",[306,366,368],{"class":308,"line":367},11,[306,369,370],{},"BOT_TOKEN = os.environ.get(\"BOT_TOKEN\")\n",[306,372,374],{"class":308,"line":373},12,[306,375,330],{"emptyLinePlaceholder":329},[306,377,379],{"class":308,"line":378},13,[306,380,381],{},"url = f\"https://discord.com/api/v8/applications/{APPLICATION_ID}/guilds/{GUILD_ID}/commands\"\n",[306,383,385],{"class":308,"line":384},14,[306,386,330],{"emptyLinePlaceholder":329},[306,388,390],{"class":308,"line":389},15,[306,391,392],{},"json = {\n",[306,394,396],{"class":308,"line":395},16,[306,397,398],{},"    \"name\": \"vh\",\n",[306,400,402],{"class":308,"line":401},17,[306,403,404],{},"    \"description\": \"Start, stop or get the status of the Valheim server\",\n",[306,406,408],{"class":308,"line":407},18,[306,409,410],{},"    \"options\": [\n",[306,412,414],{"class":308,"line":413},19,[306,415,416],{},"        {\n",[306,418,420],{"class":308,"line":419},20,[306,421,422],{},"            \"name\": \"valheim_server_controls\",\n",[306,424,426],{"class":308,"line":425},21,[306,427,428],{},"            \"description\": \"What do you want to do?\",\n",[306,430,432],{"class":308,"line":431},22,[306,433,434],{},"            \"type\": 3,\n",[306,436,438],{"class":308,"line":437},23,[306,439,440],{},"            \"required\": True,\n",[306,442,444],{"class":308,"line":443},24,[306,445,446],{},"            \"choices\": [\n",[306,448,450],{"class":308,"line":449},25,[306,451,452],{},"                {\n",[306,454,456],{"class":308,"line":455},26,[306,457,458],{},"                    \"name\": \"status\",\n",[306,460,462],{"class":308,"line":461},27,[306,463,464],{},"                    \"value\": \"status\"\n",[306,466,468],{"class":308,"line":467},28,[306,469,470],{},"                },\n",[306,472,474],{"class":308,"line":473},29,[306,475,452],{},[306,477,479],{"class":308,"line":478},30,[306,480,481],{},"                    \"name\": \"start\",\n",[306,483,485],{"class":308,"line":484},31,[306,486,487],{},"                    \"value\": \"start\"\n",[306,489,491],{"class":308,"line":490},32,[306,492,470],{},[306,494,496],{"class":308,"line":495},33,[306,497,452],{},[306,499,501],{"class":308,"line":500},34,[306,502,503],{},"                    \"name\": \"stop\",\n",[306,505,507],{"class":308,"line":506},35,[306,508,509],{},"                    \"value\": \"stop\"\n",[306,511,513],{"class":308,"line":512},36,[306,514,515],{},"                }\n",[306,517,519],{"class":308,"line":518},37,[306,520,521],{},"            ]\n",[306,523,525],{"class":308,"line":524},38,[306,526,527],{},"        },\n",[306,529,531],{"class":308,"line":530},39,[306,532,533],{},"    ]\n",[306,535,537],{"class":308,"line":536},40,[306,538,539],{},"}\n",[306,541,543],{"class":308,"line":542},41,[306,544,330],{"emptyLinePlaceholder":329},[306,546,548],{"class":308,"line":547},42,[306,549,550],{},"headers = {\n",[306,552,554],{"class":308,"line":553},43,[306,555,556],{},"    \"Authorization\": f\"Bot {BOT_TOKEN}\"\n",[306,558,560],{"class":308,"line":559},44,[306,561,539],{},[306,563,565],{"class":308,"line":564},45,[306,566,330],{"emptyLinePlaceholder":329},[306,568,570],{"class":308,"line":569},46,[306,571,572],{},"if __name__ == \"__main__\":\n",[306,574,576],{"class":308,"line":575},47,[306,577,578],{},"    r = requests.post(url, headers=headers, json=json)\n",[306,580,582],{"class":308,"line":581},48,[306,583,584],{},"    print(r.content)\n",[13,586,587,588,590],{},"Before running this command, source the ",[36,589,197],{}," file:",[199,592,595],{"className":593,"code":594,"language":204},[202],"source .env\n",[36,596,594],{"__ignoreMap":207},[13,598,599],{},"Then run the script:",[199,601,604],{"className":602,"code":603,"language":204},[202],"python3 register_bot.py\n",[36,605,603],{"__ignoreMap":207},[13,607,608],{},"You should see this response:",[199,610,613],{"className":611,"code":612,"language":204},[202],"b'{\"id\": \"XXXXXXXXXXXXXX\", \"application_id\": \"XXXXXXXXXXXXXX\", \"name\": \"vh\", \"description\": \"Start, stop or get the status of the Valheim server\", \"version\": \"XXXXXXXXXXXXXX\", \"default_permission\": true, \"guild_id\": \"XXXXXXXXXXXXXX\", \"options\": [{\"type\": 3, \"name\": \"valheim_server_controls\", \"description\": \"What do you want to do?\", \"required\": true, \"choices\": [{\"name\": \"status\", \"value\": \"status\"}, {\"name\": \"start\", \"value\": \"start\"}, {\"name\": \"stop\", \"value\": \"stop\"}]}]}'\n",[36,614,612],{"__ignoreMap":207},[13,616,617,618,620,621,624],{},"Now, when you type ",[36,619,89],{}," in any channel on the Discord server that you authenticated the bot, you should see the ",[36,622,623],{},"vh"," command at the top of the list of autocomplete options.",[13,626,627],{},"If we run any of these commands, we should see a response saying:",[199,629,632],{"className":630,"code":631,"language":204},[202],"This interaction failed\n",[36,633,631],{"__ignoreMap":207},[13,635,636,637,640,641,643,644,648],{},"This is because we have not configured an ",[36,638,639],{},"Interactions Endpoint URL"," under the ",[36,642,189],{}," section of our Discord Application's admin page (",[17,645,646],{"href":646,"rel":647},"https://discord.com/developers/applications/",[21],").",[32,650,652],{"id":651},"setting-up-the-interactions-endpoint-url-for-our-slash-command","Setting up the Interactions Endpoint URL for our Slash Command",[13,654,655,656,658,659,52],{},"In order for our Slash Command to do anything, we need to set up URL that Discord will ",[36,657,104],{}," the Interaction event data to, including information such as who sent the Interaction, what channel it was sent on, what options were used, etc. You can see an example of the event payload ",[17,660,663],{"href":661,"rel":662},"https://discord.com/developers/docs/interactions/slash-commands#receiving-an-interaction",[21],"here on the Discord developer documentation",[199,665,669],{"className":666,"code":667,"language":668,"meta":207,"style":207},"language-json shiki shiki-themes github-light github-dark","{\n    \"type\": 2,\n    \"token\": \"A_UNIQUE_TOKEN\",\n    \"member\": {\n        \"user\": {\n            \"id\": 53908232506183680,\n            \"username\": \"Mason\",\n            \"avatar\": \"a_d5efa99b3eeaa7dd43acca82f5692432\",\n            \"discriminator\": \"1337\",\n            \"public_flags\": 131141\n        },\n        \"roles\": [\"539082325061836999\"],\n        \"premium_since\": null,\n        \"permissions\": \"2147483647\",\n        \"pending\": false,\n        \"nick\": null,\n        \"mute\": false,\n        \"joined_at\": \"2017-03-13T19:19:14.040000+00:00\",\n        \"is_pending\": false,\n        \"deaf\": false\n    },\n    \"id\": \"786008729715212338\",\n    \"guild_id\": \"290926798626357999\",\n    \"data\": {\n        \"options\": [{\n            \"name\": \"cardname\",\n            \"value\": \"The Gitrog Monster\"\n        }],\n        \"name\": \"cardsearch\",\n        \"id\": \"771825006014889984\"\n    },\n    \"channel_id\": \"645027906669510667\"\n}\n","json",[36,670,671,677,692,705,713,720,732,744,756,768,778,782,796,808,820,832,843,854,866,877,887,892,904,916,923,931,943,953,958,970,980,984,994],{"__ignoreMap":207},[306,672,673],{"class":308,"line":309},[306,674,676],{"class":675},"sVt8B","{\n",[306,678,679,683,686,689],{"class":308,"line":315},[306,680,682],{"class":681},"sj4cs","    \"type\"",[306,684,685],{"class":675},": ",[306,687,688],{"class":681},"2",[306,690,691],{"class":675},",\n",[306,693,694,697,699,703],{"class":308,"line":321},[306,695,696],{"class":681},"    \"token\"",[306,698,685],{"class":675},[306,700,702],{"class":701},"sZZnC","\"A_UNIQUE_TOKEN\"",[306,704,691],{"class":675},[306,706,707,710],{"class":308,"line":326},[306,708,709],{"class":681},"    \"member\"",[306,711,712],{"class":675},": {\n",[306,714,715,718],{"class":308,"line":333},[306,716,717],{"class":681},"        \"user\"",[306,719,712],{"class":675},[306,721,722,725,727,730],{"class":308,"line":339},[306,723,724],{"class":681},"            \"id\"",[306,726,685],{"class":675},[306,728,729],{"class":681},"53908232506183680",[306,731,691],{"class":675},[306,733,734,737,739,742],{"class":308,"line":344},[306,735,736],{"class":681},"            \"username\"",[306,738,685],{"class":675},[306,740,741],{"class":701},"\"Mason\"",[306,743,691],{"class":675},[306,745,746,749,751,754],{"class":308,"line":350},[306,747,748],{"class":681},"            \"avatar\"",[306,750,685],{"class":675},[306,752,753],{"class":701},"\"a_d5efa99b3eeaa7dd43acca82f5692432\"",[306,755,691],{"class":675},[306,757,758,761,763,766],{"class":308,"line":355},[306,759,760],{"class":681},"            \"discriminator\"",[306,762,685],{"class":675},[306,764,765],{"class":701},"\"1337\"",[306,767,691],{"class":675},[306,769,770,773,775],{"class":308,"line":361},[306,771,772],{"class":681},"            \"public_flags\"",[306,774,685],{"class":675},[306,776,777],{"class":681},"131141\n",[306,779,780],{"class":308,"line":367},[306,781,527],{"class":675},[306,783,784,787,790,793],{"class":308,"line":373},[306,785,786],{"class":681},"        \"roles\"",[306,788,789],{"class":675},": [",[306,791,792],{"class":701},"\"539082325061836999\"",[306,794,795],{"class":675},"],\n",[306,797,798,801,803,806],{"class":308,"line":378},[306,799,800],{"class":681},"        \"premium_since\"",[306,802,685],{"class":675},[306,804,805],{"class":681},"null",[306,807,691],{"class":675},[306,809,810,813,815,818],{"class":308,"line":384},[306,811,812],{"class":681},"        \"permissions\"",[306,814,685],{"class":675},[306,816,817],{"class":701},"\"2147483647\"",[306,819,691],{"class":675},[306,821,822,825,827,830],{"class":308,"line":389},[306,823,824],{"class":681},"        \"pending\"",[306,826,685],{"class":675},[306,828,829],{"class":681},"false",[306,831,691],{"class":675},[306,833,834,837,839,841],{"class":308,"line":395},[306,835,836],{"class":681},"        \"nick\"",[306,838,685],{"class":675},[306,840,805],{"class":681},[306,842,691],{"class":675},[306,844,845,848,850,852],{"class":308,"line":401},[306,846,847],{"class":681},"        \"mute\"",[306,849,685],{"class":675},[306,851,829],{"class":681},[306,853,691],{"class":675},[306,855,856,859,861,864],{"class":308,"line":407},[306,857,858],{"class":681},"        \"joined_at\"",[306,860,685],{"class":675},[306,862,863],{"class":701},"\"2017-03-13T19:19:14.040000+00:00\"",[306,865,691],{"class":675},[306,867,868,871,873,875],{"class":308,"line":413},[306,869,870],{"class":681},"        \"is_pending\"",[306,872,685],{"class":675},[306,874,829],{"class":681},[306,876,691],{"class":675},[306,878,879,882,884],{"class":308,"line":419},[306,880,881],{"class":681},"        \"deaf\"",[306,883,685],{"class":675},[306,885,886],{"class":681},"false\n",[306,888,889],{"class":308,"line":425},[306,890,891],{"class":675},"    },\n",[306,893,894,897,899,902],{"class":308,"line":431},[306,895,896],{"class":681},"    \"id\"",[306,898,685],{"class":675},[306,900,901],{"class":701},"\"786008729715212338\"",[306,903,691],{"class":675},[306,905,906,909,911,914],{"class":308,"line":437},[306,907,908],{"class":681},"    \"guild_id\"",[306,910,685],{"class":675},[306,912,913],{"class":701},"\"290926798626357999\"",[306,915,691],{"class":675},[306,917,918,921],{"class":308,"line":443},[306,919,920],{"class":681},"    \"data\"",[306,922,712],{"class":675},[306,924,925,928],{"class":308,"line":449},[306,926,927],{"class":681},"        \"options\"",[306,929,930],{"class":675},": [{\n",[306,932,933,936,938,941],{"class":308,"line":455},[306,934,935],{"class":681},"            \"name\"",[306,937,685],{"class":675},[306,939,940],{"class":701},"\"cardname\"",[306,942,691],{"class":675},[306,944,945,948,950],{"class":308,"line":461},[306,946,947],{"class":681},"            \"value\"",[306,949,685],{"class":675},[306,951,952],{"class":701},"\"The Gitrog Monster\"\n",[306,954,955],{"class":308,"line":467},[306,956,957],{"class":675},"        }],\n",[306,959,960,963,965,968],{"class":308,"line":473},[306,961,962],{"class":681},"        \"name\"",[306,964,685],{"class":675},[306,966,967],{"class":701},"\"cardsearch\"",[306,969,691],{"class":675},[306,971,972,975,977],{"class":308,"line":478},[306,973,974],{"class":681},"        \"id\"",[306,976,685],{"class":675},[306,978,979],{"class":701},"\"771825006014889984\"\n",[306,981,982],{"class":308,"line":484},[306,983,891],{"class":675},[306,985,986,989,991],{"class":308,"line":490},[306,987,988],{"class":681},"    \"channel_id\"",[306,990,685],{"class":675},[306,992,993],{"class":701},"\"645027906669510667\"\n",[306,995,996],{"class":308,"line":495},[306,997,539],{"class":675},[13,999,1000,1001,1003,1004,1007],{},"This ",[36,1002,104],{}," request also includes some special headers used for security that we will need to do validation with our handling function. This part can be handled with a decorator provided by the ",[36,1005,1006],{},"discord-interactions"," package on PyPI, but we will need to add some additional configuration to our API Gateway endpoint since these headers will not be passed through the lambda by default.",[32,1009,1011],{"id":1010},"setting-up-aws-infrastructure-with-cdk","Setting up AWS infrastructure with CDK",[13,1013,1014,1015,1018],{},"Let's start a CDK project in a blank repository that will define our infrastructure, Lambda functions and CI/CD pipeline with GitLab CI. Make sure that you have the ",[36,1016,1017],{},"aws-cdk"," CLI installed globally:",[199,1020,1023],{"className":1021,"code":1022,"language":204},[202],"npm i -g aws-cdk\n",[36,1024,1022],{"__ignoreMap":207},[13,1026,1027,1028,1031],{},"Then start a CDK project in a subdirectory called ",[36,1029,1030],{},"cdk"," with:",[199,1033,1036],{"className":1034,"code":1035,"language":204},[202],"mkdir cdk && cd cdk && cdk init app --language=python\n",[36,1037,1035],{"__ignoreMap":207},[232,1039,1041],{"id":1040},"add-cdk-project-dependencies","Add CDK project dependencies",[13,1043,1044,1045,1048],{},"The next step is to add all of the dependencies to our CDK project that we will use in this project. In ",[36,1046,1047],{},"setup.py"," add the following:",[199,1050,1052],{"className":300,"code":1051,"language":302,"meta":207,"style":207},"    install_requires=[\n        \"aws-cdk.core==1.92.0\",\n        \"aws-cdk.aws_applicationautoscaling==1.92.0\",\n        \"aws-cdk.aws_datasync==1.92.0\",\n        \"aws-cdk.aws_lambda==1.92.0\",\n        \"aws-cdk.aws_s3==1.92.0\",\n        \"aws-cdk.aws_apigateway==1.92.0\",\n        \"cdk-valheim==0.0.16\",\n    ],\n",[36,1053,1054,1059,1064,1069,1074,1079,1084,1089,1094],{"__ignoreMap":207},[306,1055,1056],{"class":308,"line":309},[306,1057,1058],{},"    install_requires=[\n",[306,1060,1061],{"class":308,"line":315},[306,1062,1063],{},"        \"aws-cdk.core==1.92.0\",\n",[306,1065,1066],{"class":308,"line":321},[306,1067,1068],{},"        \"aws-cdk.aws_applicationautoscaling==1.92.0\",\n",[306,1070,1071],{"class":308,"line":326},[306,1072,1073],{},"        \"aws-cdk.aws_datasync==1.92.0\",\n",[306,1075,1076],{"class":308,"line":333},[306,1077,1078],{},"        \"aws-cdk.aws_lambda==1.92.0\",\n",[306,1080,1081],{"class":308,"line":339},[306,1082,1083],{},"        \"aws-cdk.aws_s3==1.92.0\",\n",[306,1085,1086],{"class":308,"line":344},[306,1087,1088],{},"        \"aws-cdk.aws_apigateway==1.92.0\",\n",[306,1090,1091],{"class":308,"line":350},[306,1092,1093],{},"        \"cdk-valheim==0.0.16\",\n",[306,1095,1096],{"class":308,"line":355},[306,1097,1098],{},"    ],\n",[13,1100,1101,1102,1105,1106,1109,1110,52],{},"Next we can add the CDK construct for ",[36,1103,1104],{},"ValheimWorld"," in the ",[36,1107,1108],{},"cdk_stack.py"," file that was generated in our project as well as the imports for the packages we included in ",[36,1111,1047],{},[199,1113,1115],{"className":300,"code":1114,"language":302,"meta":207,"style":207},"from aws_cdk import core as cdk\n\nfrom aws_cdk import (\n    core,\n    aws_datasync as datasync,\n    aws_iam as iam,\n    aws_lambda as _lambda,\n    aws_apigateway as apigw,\n    aws_applicationautoscaling as appScaling,\n    aws_s3 as s3,\n)\nfrom cdk_valheim import ValheimWorld, ValheimWorldScalingSchedule\n\n\nclass CdkStack(cdk.Stack):\n\n    def __init__(self, scope: cdk.Construct, construct_id: str, **kwargs) -> None:\n        super().__init__(scope, construct_id, **kwargs)\n        # The code that defines your stack goes here\n        self.valheim_world = ValheimWorld(\n            self,\n            'ValheimWorld',\n            cpu=2048,\n            memory_limit_mib=4096,\n            schedules=[ValheimWorldScalingSchedule(\n                start=appScaling.CronOptions(hour='12', week_day='1-5'),\n                stop=appScaling.CronOptions(hour='1', week_day='1-5'),\n            )],\n            environment={\n                \"SERVER_NAME\": os.environ.get(\"SERVER_NAME\", \"CDK Valheim\"),\n                \"WORLD_NAME\": os.environ.get(\"WORLD_NAME\", \"Amazon\"),\n                \"SERVER_PASS\": os.environ.get(\"SERVER_PASS\", \"fargate\"),\n                \"BACKUPS\": 'false',\n            })\n",[36,1116,1117,1122,1126,1131,1136,1141,1146,1151,1156,1161,1166,1171,1176,1180,1184,1189,1193,1198,1203,1208,1213,1218,1223,1228,1233,1238,1243,1248,1253,1258,1263,1268,1273,1278],{"__ignoreMap":207},[306,1118,1119],{"class":308,"line":309},[306,1120,1121],{},"from aws_cdk import core as cdk\n",[306,1123,1124],{"class":308,"line":315},[306,1125,330],{"emptyLinePlaceholder":329},[306,1127,1128],{"class":308,"line":321},[306,1129,1130],{},"from aws_cdk import (\n",[306,1132,1133],{"class":308,"line":326},[306,1134,1135],{},"    core,\n",[306,1137,1138],{"class":308,"line":333},[306,1139,1140],{},"    aws_datasync as datasync,\n",[306,1142,1143],{"class":308,"line":339},[306,1144,1145],{},"    aws_iam as iam,\n",[306,1147,1148],{"class":308,"line":344},[306,1149,1150],{},"    aws_lambda as _lambda,\n",[306,1152,1153],{"class":308,"line":350},[306,1154,1155],{},"    aws_apigateway as apigw,\n",[306,1157,1158],{"class":308,"line":355},[306,1159,1160],{},"    aws_applicationautoscaling as appScaling,\n",[306,1162,1163],{"class":308,"line":361},[306,1164,1165],{},"    aws_s3 as s3,\n",[306,1167,1168],{"class":308,"line":367},[306,1169,1170],{},")\n",[306,1172,1173],{"class":308,"line":373},[306,1174,1175],{},"from cdk_valheim import ValheimWorld, ValheimWorldScalingSchedule\n",[306,1177,1178],{"class":308,"line":378},[306,1179,330],{"emptyLinePlaceholder":329},[306,1181,1182],{"class":308,"line":384},[306,1183,330],{"emptyLinePlaceholder":329},[306,1185,1186],{"class":308,"line":389},[306,1187,1188],{},"class CdkStack(cdk.Stack):\n",[306,1190,1191],{"class":308,"line":395},[306,1192,330],{"emptyLinePlaceholder":329},[306,1194,1195],{"class":308,"line":401},[306,1196,1197],{},"    def __init__(self, scope: cdk.Construct, construct_id: str, **kwargs) -> None:\n",[306,1199,1200],{"class":308,"line":407},[306,1201,1202],{},"        super().__init__(scope, construct_id, **kwargs)\n",[306,1204,1205],{"class":308,"line":413},[306,1206,1207],{},"        # The code that defines your stack goes here\n",[306,1209,1210],{"class":308,"line":419},[306,1211,1212],{},"        self.valheim_world = ValheimWorld(\n",[306,1214,1215],{"class":308,"line":425},[306,1216,1217],{},"            self,\n",[306,1219,1220],{"class":308,"line":431},[306,1221,1222],{},"            'ValheimWorld',\n",[306,1224,1225],{"class":308,"line":437},[306,1226,1227],{},"            cpu=2048,\n",[306,1229,1230],{"class":308,"line":443},[306,1231,1232],{},"            memory_limit_mib=4096,\n",[306,1234,1235],{"class":308,"line":449},[306,1236,1237],{},"            schedules=[ValheimWorldScalingSchedule(\n",[306,1239,1240],{"class":308,"line":455},[306,1241,1242],{},"                start=appScaling.CronOptions(hour='12', week_day='1-5'),\n",[306,1244,1245],{"class":308,"line":461},[306,1246,1247],{},"                stop=appScaling.CronOptions(hour='1', week_day='1-5'),\n",[306,1249,1250],{"class":308,"line":467},[306,1251,1252],{},"            )],\n",[306,1254,1255],{"class":308,"line":473},[306,1256,1257],{},"            environment={\n",[306,1259,1260],{"class":308,"line":478},[306,1261,1262],{},"                \"SERVER_NAME\": os.environ.get(\"SERVER_NAME\", \"CDK Valheim\"),\n",[306,1264,1265],{"class":308,"line":484},[306,1266,1267],{},"                \"WORLD_NAME\": os.environ.get(\"WORLD_NAME\", \"Amazon\"),\n",[306,1269,1270],{"class":308,"line":490},[306,1271,1272],{},"                \"SERVER_PASS\": os.environ.get(\"SERVER_PASS\", \"fargate\"),\n",[306,1274,1275],{"class":308,"line":495},[306,1276,1277],{},"                \"BACKUPS\": 'false',\n",[306,1279,1280],{"class":308,"line":500},[306,1281,1282],{},"            })\n",[13,1284,1285,1286,1288],{},"We are almost ready to deploy a basic version of our Valheim server using the ",[36,1287,38],{}," construct. If we were to run the following command:",[199,1290,1293],{"className":1291,"code":1292,"language":204},[202],"cdk deploy --app cdk/app.py --require-approval never\n",[36,1294,1292],{"__ignoreMap":207},[13,1296,1297,1298,1301],{},"from the root of our project, it should work. This assumes that we have default credentials configured in ",[36,1299,1300],{},"~/.aws/credentials"," and that we have also bootstrapped our AWS account with the resources it needs for CDK to work:",[199,1303,1306],{"className":1304,"code":1305,"language":204},[202],"cdk bootstrap --app cdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n",[36,1307,1305],{"__ignoreMap":207},[232,1309,1311],{"id":1310},"setup-gitlab-ci-job-for-automated-deployments","Setup GitLab CI job for automated deployments",[13,1313,1314,1315,1318],{},"Instead of deploying from the command line, it would be better to run the deployment from a CI/CD pipeline. Add a ",[36,1316,1317],{},".gitlab-ci.yml"," file to the root of your project and populate it with the following YAML:",[199,1320,1324],{"className":1321,"code":1322,"language":1323,"meta":207,"style":207},"language-yaml shiki shiki-themes github-light github-dark","stages:\n  - deploy\n\nimage: python:3.8\n\ncdk_deploy:\n  stage: deploy\n  rules:\n    - if: \"$CI_COMMIT_TAG\"\n      when: always\n  before_script:\n    - apt-get -qq update && apt-get -y install nodejs npm\n    - npm i -g aws-cdk\n    - pip3 install -e cdk\n  script:\n    - cdk bootstrap --app cdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION\n    - cdk deploy --app cdk/app.py --require-approval never\n","yaml",[36,1325,1326,1335,1343,1347,1357,1361,1368,1377,1384,1397,1407,1414,1421,1427,1434,1441,1447],{"__ignoreMap":207},[306,1327,1328,1332],{"class":308,"line":309},[306,1329,1331],{"class":1330},"s9eBZ","stages",[306,1333,1334],{"class":675},":\n",[306,1336,1337,1340],{"class":308,"line":315},[306,1338,1339],{"class":675},"  - ",[306,1341,1342],{"class":701},"deploy\n",[306,1344,1345],{"class":308,"line":321},[306,1346,330],{"emptyLinePlaceholder":329},[306,1348,1349,1352,1354],{"class":308,"line":326},[306,1350,1351],{"class":1330},"image",[306,1353,685],{"class":675},[306,1355,1356],{"class":701},"python:3.8\n",[306,1358,1359],{"class":308,"line":333},[306,1360,330],{"emptyLinePlaceholder":329},[306,1362,1363,1366],{"class":308,"line":339},[306,1364,1365],{"class":1330},"cdk_deploy",[306,1367,1334],{"class":675},[306,1369,1370,1373,1375],{"class":308,"line":344},[306,1371,1372],{"class":1330},"  stage",[306,1374,685],{"class":675},[306,1376,1342],{"class":701},[306,1378,1379,1382],{"class":308,"line":350},[306,1380,1381],{"class":1330},"  rules",[306,1383,1334],{"class":675},[306,1385,1386,1389,1392,1394],{"class":308,"line":355},[306,1387,1388],{"class":675},"    - ",[306,1390,1391],{"class":1330},"if",[306,1393,685],{"class":675},[306,1395,1396],{"class":701},"\"$CI_COMMIT_TAG\"\n",[306,1398,1399,1402,1404],{"class":308,"line":361},[306,1400,1401],{"class":1330},"      when",[306,1403,685],{"class":675},[306,1405,1406],{"class":701},"always\n",[306,1408,1409,1412],{"class":308,"line":367},[306,1410,1411],{"class":1330},"  before_script",[306,1413,1334],{"class":675},[306,1415,1416,1418],{"class":308,"line":373},[306,1417,1388],{"class":675},[306,1419,1420],{"class":701},"apt-get -qq update && apt-get -y install nodejs npm\n",[306,1422,1423,1425],{"class":308,"line":378},[306,1424,1388],{"class":675},[306,1426,1022],{"class":701},[306,1428,1429,1431],{"class":308,"line":384},[306,1430,1388],{"class":675},[306,1432,1433],{"class":701},"pip3 install -e cdk\n",[306,1435,1436,1439],{"class":308,"line":389},[306,1437,1438],{"class":1330},"  script",[306,1440,1334],{"class":675},[306,1442,1443,1445],{"class":308,"line":395},[306,1444,1388],{"class":675},[306,1446,1305],{"class":701},[306,1448,1449,1451],{"class":308,"line":401},[306,1450,1388],{"class":675},[306,1452,1292],{"class":701},[13,1454,1455,1456,1459,1460,1463,1464,98],{},"Before we initialize a git repository in the root directory of our project, remove the ",[36,1457,1458],{},".git"," repo that CDK created when we initialized the project with ",[36,1461,1462],{},"rf -rf cdk/.git",". Now initialized a project in the root directory with ",[36,1465,1466],{},"git init",[13,1468,1469],{},"Next, create a GitLab repository and add the remote to this project with:",[199,1471,1474],{"className":1472,"code":1473,"language":204},[202],"git remote add origin git@gitlab.com:gitlab-username/project-name.git\n",[36,1475,1473],{"__ignoreMap":207},[13,1477,1478,1479,1482],{},"In the GitLab project's ",[36,1480,1481],{},"Settings > CI/CD > Variables"," section, add the following environment variables as protected variables:",[68,1484,1485,1490,1495,1500,1505,1510,1515,1520],{},[71,1486,1487],{},[36,1488,1489],{},"AWS_ACCESS_KEY_ID",[71,1491,1492],{},[36,1493,1494],{},"AWS_SECRET_ACCESS_KEY",[71,1496,1497],{},[36,1498,1499],{},"AWS_DEFAULT_REGION",[71,1501,1502],{},[36,1503,1504],{},"AWS_ACCOUNT_ID",[71,1506,1507],{},[36,1508,1509],{},"APPLICATION_PUBLIC_KEY",[71,1511,1512],{},[36,1513,1514],{},"SERVER_PASS",[71,1516,1517],{},[36,1518,1519],{},"SERVER_NAME",[71,1521,1522],{},[36,1523,1524],{},"WORLD_NAME",[13,1526,1527,1528,1531,1532,1535],{},"Now under ",[36,1529,1530],{},"Settings > Repository > Protected Tags",", add a wildcard (",[36,1533,1534],{},"*",") so that all tags are protected and only maintainers can push tags. This allows us to use the protected environment variables only when a trusted maintainer pushes a tag to the repository.",[232,1537,1539],{"id":1538},"edit-the-name-of-the-stack-and-add-region-and-account-info","Edit the name of the stack and add region and account info",[13,1541,1542,1543,52],{},"We are almost ready to create a tag and push to GitLab, but before we do that let's change the name of the CloudFormation stack that CDK will create in ",[36,1544,1545],{},"cdk/app.py",[199,1547,1549],{"className":300,"code":1548,"language":302,"meta":207,"style":207},"#!/usr/bin/env python3\n\nimport os\n\nfrom aws_cdk import core as cdk\n\n# For consistency with TypeScript code, `cdk` is the preferred import name for\n# the CDK's core module.  The following line also imports it as `core` for use\n# with examples from the CDK Developer's Guide, which are in the process of\n# being updated to use `cdk`.  You may delete this import if you don't need it.\nfrom aws_cdk import core\n\nfrom cdk.cdk_stack import CdkStack\n\naws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\naws_account = os.environ.get(\"AWS_ACCOUNT_ID\", \"\")\n\n\napp = cdk.App()\nCdkStack(\n    app,\n    \"valheim-server-stack\",\n    env={\"region\": aws_region, \"account\": aws_account}\n)\n\napp.synth()\n",[36,1550,1551,1556,1560,1564,1568,1572,1576,1581,1586,1591,1596,1601,1605,1610,1614,1619,1624,1628,1632,1637,1642,1647,1652,1657,1661,1665],{"__ignoreMap":207},[306,1552,1553],{"class":308,"line":309},[306,1554,1555],{},"#!/usr/bin/env python3\n",[306,1557,1558],{"class":308,"line":315},[306,1559,330],{"emptyLinePlaceholder":329},[306,1561,1562],{"class":308,"line":321},[306,1563,336],{},[306,1565,1566],{"class":308,"line":326},[306,1567,330],{"emptyLinePlaceholder":329},[306,1569,1570],{"class":308,"line":333},[306,1571,1121],{},[306,1573,1574],{"class":308,"line":339},[306,1575,330],{"emptyLinePlaceholder":329},[306,1577,1578],{"class":308,"line":344},[306,1579,1580],{},"# For consistency with TypeScript code, `cdk` is the preferred import name for\n",[306,1582,1583],{"class":308,"line":350},[306,1584,1585],{},"# the CDK's core module.  The following line also imports it as `core` for use\n",[306,1587,1588],{"class":308,"line":355},[306,1589,1590],{},"# with examples from the CDK Developer's Guide, which are in the process of\n",[306,1592,1593],{"class":308,"line":361},[306,1594,1595],{},"# being updated to use `cdk`.  You may delete this import if you don't need it.\n",[306,1597,1598],{"class":308,"line":367},[306,1599,1600],{},"from aws_cdk import core\n",[306,1602,1603],{"class":308,"line":373},[306,1604,330],{"emptyLinePlaceholder":329},[306,1606,1607],{"class":308,"line":378},[306,1608,1609],{},"from cdk.cdk_stack import CdkStack\n",[306,1611,1612],{"class":308,"line":384},[306,1613,330],{"emptyLinePlaceholder":329},[306,1615,1616],{"class":308,"line":389},[306,1617,1618],{},"aws_region = os.environ.get(\"AWS_DEFAULT_REGION\", \"us-east-1\")\n",[306,1620,1621],{"class":308,"line":395},[306,1622,1623],{},"aws_account = os.environ.get(\"AWS_ACCOUNT_ID\", \"\")\n",[306,1625,1626],{"class":308,"line":401},[306,1627,330],{"emptyLinePlaceholder":329},[306,1629,1630],{"class":308,"line":407},[306,1631,330],{"emptyLinePlaceholder":329},[306,1633,1634],{"class":308,"line":413},[306,1635,1636],{},"app = cdk.App()\n",[306,1638,1639],{"class":308,"line":419},[306,1640,1641],{},"CdkStack(\n",[306,1643,1644],{"class":308,"line":425},[306,1645,1646],{},"    app,\n",[306,1648,1649],{"class":308,"line":431},[306,1650,1651],{},"    \"valheim-server-stack\",\n",[306,1653,1654],{"class":308,"line":437},[306,1655,1656],{},"    env={\"region\": aws_region, \"account\": aws_account}\n",[306,1658,1659],{"class":308,"line":443},[306,1660,1170],{},[306,1662,1663],{"class":308,"line":449},[306,1664,330],{"emptyLinePlaceholder":329},[306,1666,1667],{"class":308,"line":455},[306,1668,1669],{},"app.synth()\n",[13,1671,1672],{},"Now commit changes, create a tag and push it to GitLab:",[199,1674,1677],{"className":1675,"code":1676,"language":204},[202],"git add .\ngit commit -m \"initial commit\"\ngit tag v0.0.1\ngit push origin v0.0.1\n",[36,1678,1676],{"__ignoreMap":207},[13,1680,1681],{},"Check the logs of the GitLab CI pipeline that this creates in your GitLab project's CI/CD settings.",[13,1683,1684],{},"If everything runs successfully, you should be able to see your Valheim server listed in the list of community servers once it comes online, and you should be able to connect to it with the password you set in GitLab project variables.",[32,1686,1688],{"id":1687},"add-the-lambda-function-handler-code","Add the Lambda function handler code",[13,1690,1691,1692,1694,1695,1698,1699,1702,1703,1698,1706,1709],{},"We will have a simple Flask application respond the the Discord ",[36,1693,104],{}," requests that send Interaction events. Let's add ",[36,1696,1697],{},"lambda-handler.py"," in ",[36,1700,1701],{},"lambda/functions/interactions/lambda-handler.py",", and ",[36,1704,1705],{},"requirements.txt",[36,1707,1708],{},"lambda/functions/interactions/requirements.txt",". Our project structure should look like this:",[199,1711,1714],{"className":1712,"code":1713,"language":204},[202],"$ tree -L 4\n.\n├── cdk\n│   ├── app.py\n│   ├── cdk\n│   │   ├── cdk_stack.py\n│   │   └── __init__.py\n│   ├── cdk.json\n│   ├── README.md\n│   ├── requirements.txt\n│   ├── setup.py\n│   └── source.bat\n├── lambda\n│   └── functions\n│       └── interactions\n│           ├── lambda-handler.py    \u003C-- here\n│           └── requirements.txt     \u003C-- and here\n├── README.md\n└── register_bot.py\n",[36,1715,1713],{"__ignoreMap":207},[13,1717,1718,1719,1721],{},"The ",[36,1720,1705],{}," defines the pip dependencies for our Lambda function. It should include the following:",[199,1723,1726],{"className":1724,"code":1725,"language":204},[202],"aws-wsgi==0.2.7\ndiscord-interactions==0.2.0\nFlask==1.1.2\n",[36,1727,1725],{"__ignoreMap":207},[68,1729,1730,1736,1741],{},[71,1731,1732,1735],{},[36,1733,1734],{},"aws-wsgi"," will transform API Gateway requests into WSGI application requests that Flask can handle",[71,1737,1738,1740],{},[36,1739,1006],{}," will help us with some security-related requirements",[71,1742,1743,1746],{},[36,1744,1745],{},"Flask"," will be our web application framework",[13,1748,1749,1750,52],{},"Here's the code for ",[36,1751,1697],{},[199,1753,1755],{"className":300,"code":1754,"language":302,"meta":207,"style":207},"import os\nimport logging\n\nimport awsgi\nimport boto3\nfrom discord_interactions import verify_key_decorator\nfrom flask import (\n    Flask,\n    jsonify,\n    request\n)\n\n\nclient = boto3.client('ecs')\n\n# Your public key can be found on your application in the Developer Portal\nPUBLIC_KEY = os.environ.get('APPLICATION_PUBLIC_KEY')\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\napp = Flask(__name__)\n\n\n@app.route('/discord', methods=['POST'])\n@verify_key_decorator(PUBLIC_KEY)\ndef index():\n    if request.json[\"type\"] == 1:\n        return jsonify({\"type\": 1})\n    else:\n        logger.info(request.json)\n        try:\n            interaction_option = request.json[\"data\"][\"options\"][0][\"value\"]\n        except KeyError:\n            logger.info(\"Could not parse the interaction option\")\n            interaction_option = \"status\"\n\n        logger.info(\"Interaction:\")\n        logger.info(interaction_option)\n\n        content = \"\"\n\n        if interaction_option == \"status\":\n            try:\n\n                resp = client.describe_services(\n                    cluster=os.environ.get(\"ECS_CLUSTER_ARN\", \"\"),\n                    services=[\n                        os.environ.get(\"ECS_SERVICE_NAME\", \"\"),\n                    ]\n                )\n                desired_count = resp[\"services\"][0][\"desiredCount\"]\n                running_count = resp[\"services\"][0][\"runningCount\"]\n                pending_count = resp[\"services\"][0][\"pendingCount\"]\n\n                content = f\"Desired: {desired_count} | Running: {running_count} | Pending: {pending_count}\"\n\n            except Error as e:\n                content = \"Could not get server status\"\n                logger.info(\"Could not get the server status\")\n                logger.info(e)\n\n        elif interaction_option == \"start\":\n            content = \"Starting the server\"\n\n            resp = client.update_service(\n                cluster=os.environ.get(\"ECS_CLUSTER_ARN\", \"\"),\n                service=os.environ.get(\"ECS_SERVICE_NAME\", \"\"),\n                desiredCount=1\n            )\n\n        elif interaction_option == \"stop\":\n            content = \"Stopping the server\"\n\n            resp = client.update_service(\n                cluster=os.environ.get(\"ECS_CLUSTER_ARN\", \"\"),\n                service=os.environ.get(\"ECS_SERVICE_NAME\", \"\"),\n                desiredCount=0\n            )\n\n        else:\n            content = \"Unknown command\"\n\n        logger.info(resp)\n\n        return jsonify({\n            \"type\": 4,\n            \"data\": {\n                \"tts\": False,\n                \"content\": content,\n                \"embeds\": [],\n                \"allowed_mentions\": { \"parse\": [] }\n            }\n        })\n\ndef handler(event, context):\n    return awsgi.response(\n        app,\n        event,\n        context,\n        base64_content_types={\"image/png\"}\n    )\n",[36,1756,1757,1761,1766,1770,1775,1780,1785,1790,1795,1800,1805,1809,1813,1817,1822,1826,1831,1836,1840,1845,1850,1854,1859,1863,1867,1872,1877,1882,1887,1892,1897,1902,1907,1912,1917,1922,1927,1931,1936,1941,1945,1950,1954,1959,1964,1968,1973,1978,1983,1989,1995,2001,2007,2013,2019,2024,2030,2035,2041,2047,2053,2059,2064,2070,2076,2081,2087,2093,2099,2105,2111,2116,2122,2128,2133,2138,2143,2148,2154,2159,2164,2170,2176,2181,2187,2192,2198,2204,2210,2216,2222,2228,2234,2240,2246,2251,2257,2263,2269,2275,2281,2287],{"__ignoreMap":207},[306,1758,1759],{"class":308,"line":309},[306,1760,336],{},[306,1762,1763],{"class":308,"line":315},[306,1764,1765],{},"import logging\n",[306,1767,1768],{"class":308,"line":321},[306,1769,330],{"emptyLinePlaceholder":329},[306,1771,1772],{"class":308,"line":326},[306,1773,1774],{},"import awsgi\n",[306,1776,1777],{"class":308,"line":333},[306,1778,1779],{},"import boto3\n",[306,1781,1782],{"class":308,"line":339},[306,1783,1784],{},"from discord_interactions import verify_key_decorator\n",[306,1786,1787],{"class":308,"line":344},[306,1788,1789],{},"from flask import (\n",[306,1791,1792],{"class":308,"line":350},[306,1793,1794],{},"    Flask,\n",[306,1796,1797],{"class":308,"line":355},[306,1798,1799],{},"    jsonify,\n",[306,1801,1802],{"class":308,"line":361},[306,1803,1804],{},"    request\n",[306,1806,1807],{"class":308,"line":367},[306,1808,1170],{},[306,1810,1811],{"class":308,"line":373},[306,1812,330],{"emptyLinePlaceholder":329},[306,1814,1815],{"class":308,"line":378},[306,1816,330],{"emptyLinePlaceholder":329},[306,1818,1819],{"class":308,"line":384},[306,1820,1821],{},"client = boto3.client('ecs')\n",[306,1823,1824],{"class":308,"line":389},[306,1825,330],{"emptyLinePlaceholder":329},[306,1827,1828],{"class":308,"line":395},[306,1829,1830],{},"# Your public key can be found on your application in the Developer Portal\n",[306,1832,1833],{"class":308,"line":401},[306,1834,1835],{},"PUBLIC_KEY = os.environ.get('APPLICATION_PUBLIC_KEY')\n",[306,1837,1838],{"class":308,"line":407},[306,1839,330],{"emptyLinePlaceholder":329},[306,1841,1842],{"class":308,"line":413},[306,1843,1844],{},"logger = logging.getLogger()\n",[306,1846,1847],{"class":308,"line":419},[306,1848,1849],{},"logger.setLevel(logging.INFO)\n",[306,1851,1852],{"class":308,"line":425},[306,1853,330],{"emptyLinePlaceholder":329},[306,1855,1856],{"class":308,"line":431},[306,1857,1858],{},"app = Flask(__name__)\n",[306,1860,1861],{"class":308,"line":437},[306,1862,330],{"emptyLinePlaceholder":329},[306,1864,1865],{"class":308,"line":443},[306,1866,330],{"emptyLinePlaceholder":329},[306,1868,1869],{"class":308,"line":449},[306,1870,1871],{},"@app.route('/discord', methods=['POST'])\n",[306,1873,1874],{"class":308,"line":455},[306,1875,1876],{},"@verify_key_decorator(PUBLIC_KEY)\n",[306,1878,1879],{"class":308,"line":461},[306,1880,1881],{},"def index():\n",[306,1883,1884],{"class":308,"line":467},[306,1885,1886],{},"    if request.json[\"type\"] == 1:\n",[306,1888,1889],{"class":308,"line":473},[306,1890,1891],{},"        return jsonify({\"type\": 1})\n",[306,1893,1894],{"class":308,"line":478},[306,1895,1896],{},"    else:\n",[306,1898,1899],{"class":308,"line":484},[306,1900,1901],{},"        logger.info(request.json)\n",[306,1903,1904],{"class":308,"line":490},[306,1905,1906],{},"        try:\n",[306,1908,1909],{"class":308,"line":495},[306,1910,1911],{},"            interaction_option = request.json[\"data\"][\"options\"][0][\"value\"]\n",[306,1913,1914],{"class":308,"line":500},[306,1915,1916],{},"        except KeyError:\n",[306,1918,1919],{"class":308,"line":506},[306,1920,1921],{},"            logger.info(\"Could not parse the interaction option\")\n",[306,1923,1924],{"class":308,"line":512},[306,1925,1926],{},"            interaction_option = \"status\"\n",[306,1928,1929],{"class":308,"line":518},[306,1930,330],{"emptyLinePlaceholder":329},[306,1932,1933],{"class":308,"line":524},[306,1934,1935],{},"        logger.info(\"Interaction:\")\n",[306,1937,1938],{"class":308,"line":530},[306,1939,1940],{},"        logger.info(interaction_option)\n",[306,1942,1943],{"class":308,"line":536},[306,1944,330],{"emptyLinePlaceholder":329},[306,1946,1947],{"class":308,"line":542},[306,1948,1949],{},"        content = \"\"\n",[306,1951,1952],{"class":308,"line":547},[306,1953,330],{"emptyLinePlaceholder":329},[306,1955,1956],{"class":308,"line":553},[306,1957,1958],{},"        if interaction_option == \"status\":\n",[306,1960,1961],{"class":308,"line":559},[306,1962,1963],{},"            try:\n",[306,1965,1966],{"class":308,"line":564},[306,1967,330],{"emptyLinePlaceholder":329},[306,1969,1970],{"class":308,"line":569},[306,1971,1972],{},"                resp = client.describe_services(\n",[306,1974,1975],{"class":308,"line":575},[306,1976,1977],{},"                    cluster=os.environ.get(\"ECS_CLUSTER_ARN\", \"\"),\n",[306,1979,1980],{"class":308,"line":581},[306,1981,1982],{},"                    services=[\n",[306,1984,1986],{"class":308,"line":1985},49,[306,1987,1988],{},"                        os.environ.get(\"ECS_SERVICE_NAME\", \"\"),\n",[306,1990,1992],{"class":308,"line":1991},50,[306,1993,1994],{},"                    ]\n",[306,1996,1998],{"class":308,"line":1997},51,[306,1999,2000],{},"                )\n",[306,2002,2004],{"class":308,"line":2003},52,[306,2005,2006],{},"                desired_count = resp[\"services\"][0][\"desiredCount\"]\n",[306,2008,2010],{"class":308,"line":2009},53,[306,2011,2012],{},"                running_count = resp[\"services\"][0][\"runningCount\"]\n",[306,2014,2016],{"class":308,"line":2015},54,[306,2017,2018],{},"                pending_count = resp[\"services\"][0][\"pendingCount\"]\n",[306,2020,2022],{"class":308,"line":2021},55,[306,2023,330],{"emptyLinePlaceholder":329},[306,2025,2027],{"class":308,"line":2026},56,[306,2028,2029],{},"                content = f\"Desired: {desired_count} | Running: {running_count} | Pending: {pending_count}\"\n",[306,2031,2033],{"class":308,"line":2032},57,[306,2034,330],{"emptyLinePlaceholder":329},[306,2036,2038],{"class":308,"line":2037},58,[306,2039,2040],{},"            except Error as e:\n",[306,2042,2044],{"class":308,"line":2043},59,[306,2045,2046],{},"                content = \"Could not get server status\"\n",[306,2048,2050],{"class":308,"line":2049},60,[306,2051,2052],{},"                logger.info(\"Could not get the server status\")\n",[306,2054,2056],{"class":308,"line":2055},61,[306,2057,2058],{},"                logger.info(e)\n",[306,2060,2062],{"class":308,"line":2061},62,[306,2063,330],{"emptyLinePlaceholder":329},[306,2065,2067],{"class":308,"line":2066},63,[306,2068,2069],{},"        elif interaction_option == \"start\":\n",[306,2071,2073],{"class":308,"line":2072},64,[306,2074,2075],{},"            content = \"Starting the server\"\n",[306,2077,2079],{"class":308,"line":2078},65,[306,2080,330],{"emptyLinePlaceholder":329},[306,2082,2084],{"class":308,"line":2083},66,[306,2085,2086],{},"            resp = client.update_service(\n",[306,2088,2090],{"class":308,"line":2089},67,[306,2091,2092],{},"                cluster=os.environ.get(\"ECS_CLUSTER_ARN\", \"\"),\n",[306,2094,2096],{"class":308,"line":2095},68,[306,2097,2098],{},"                service=os.environ.get(\"ECS_SERVICE_NAME\", \"\"),\n",[306,2100,2102],{"class":308,"line":2101},69,[306,2103,2104],{},"                desiredCount=1\n",[306,2106,2108],{"class":308,"line":2107},70,[306,2109,2110],{},"            )\n",[306,2112,2114],{"class":308,"line":2113},71,[306,2115,330],{"emptyLinePlaceholder":329},[306,2117,2119],{"class":308,"line":2118},72,[306,2120,2121],{},"        elif interaction_option == \"stop\":\n",[306,2123,2125],{"class":308,"line":2124},73,[306,2126,2127],{},"            content = \"Stopping the server\"\n",[306,2129,2131],{"class":308,"line":2130},74,[306,2132,330],{"emptyLinePlaceholder":329},[306,2134,2136],{"class":308,"line":2135},75,[306,2137,2086],{},[306,2139,2141],{"class":308,"line":2140},76,[306,2142,2092],{},[306,2144,2146],{"class":308,"line":2145},77,[306,2147,2098],{},[306,2149,2151],{"class":308,"line":2150},78,[306,2152,2153],{},"                desiredCount=0\n",[306,2155,2157],{"class":308,"line":2156},79,[306,2158,2110],{},[306,2160,2162],{"class":308,"line":2161},80,[306,2163,330],{"emptyLinePlaceholder":329},[306,2165,2167],{"class":308,"line":2166},81,[306,2168,2169],{},"        else:\n",[306,2171,2173],{"class":308,"line":2172},82,[306,2174,2175],{},"            content = \"Unknown command\"\n",[306,2177,2179],{"class":308,"line":2178},83,[306,2180,330],{"emptyLinePlaceholder":329},[306,2182,2184],{"class":308,"line":2183},84,[306,2185,2186],{},"        logger.info(resp)\n",[306,2188,2190],{"class":308,"line":2189},85,[306,2191,330],{"emptyLinePlaceholder":329},[306,2193,2195],{"class":308,"line":2194},86,[306,2196,2197],{},"        return jsonify({\n",[306,2199,2201],{"class":308,"line":2200},87,[306,2202,2203],{},"            \"type\": 4,\n",[306,2205,2207],{"class":308,"line":2206},88,[306,2208,2209],{},"            \"data\": {\n",[306,2211,2213],{"class":308,"line":2212},89,[306,2214,2215],{},"                \"tts\": False,\n",[306,2217,2219],{"class":308,"line":2218},90,[306,2220,2221],{},"                \"content\": content,\n",[306,2223,2225],{"class":308,"line":2224},91,[306,2226,2227],{},"                \"embeds\": [],\n",[306,2229,2231],{"class":308,"line":2230},92,[306,2232,2233],{},"                \"allowed_mentions\": { \"parse\": [] }\n",[306,2235,2237],{"class":308,"line":2236},93,[306,2238,2239],{},"            }\n",[306,2241,2243],{"class":308,"line":2242},94,[306,2244,2245],{},"        })\n",[306,2247,2249],{"class":308,"line":2248},95,[306,2250,330],{"emptyLinePlaceholder":329},[306,2252,2254],{"class":308,"line":2253},96,[306,2255,2256],{},"def handler(event, context):\n",[306,2258,2260],{"class":308,"line":2259},97,[306,2261,2262],{},"    return awsgi.response(\n",[306,2264,2266],{"class":308,"line":2265},98,[306,2267,2268],{},"        app,\n",[306,2270,2272],{"class":308,"line":2271},99,[306,2273,2274],{},"        event,\n",[306,2276,2278],{"class":308,"line":2277},100,[306,2279,2280],{},"        context,\n",[306,2282,2284],{"class":308,"line":2283},101,[306,2285,2286],{},"        base64_content_types={\"image/png\"}\n",[306,2288,2290],{"class":308,"line":2289},102,[306,2291,2292],{},"    )\n",[13,2294,2295,2296,2299,2300,2303,2304,2306,2307,2310],{},"Notice how we pass the Flask ",[36,2297,2298],{},"app"," to ",[36,2301,2302],{},"awsgi.response",". ",[36,2305,1734],{}," (or ",[36,2308,2309],{},"awsgi"," as it is imported) is the go-between for API Gateway and WSGI.",[32,2312,2314],{"id":2313},"add-the-cdk-code-for-api-gateway-and-lambda-that-will-serve-our-discord-interaction-endpoint-url","Add the CDK code for API Gateway and Lambda that will serve our Discord Interaction Endpoint URL",[13,2316,2317,2318,2320,2321,2323,2324,52],{},"Now we can add the following code to ",[36,2319,1108],{}," to configure the API Gateway and Lambda function. Add the following to ",[36,2322,1108],{}," after our definition of ",[36,2325,2326],{},"self.valheim_world",[199,2328,2330],{"className":300,"code":2329,"language":302,"meta":207,"style":207},"        self.env_vars = {\n            \"APPLICATION_PUBLIC_KEY\": os.environ.get(\"APPLICATION_PUBLIC_KEY\"),\n            \"ECS_SERVICE_NAME\": self.valheim_world.service.service_name,\n            \"ECS_CLUSTER_ARN\": self.valheim_world.service.cluster.cluster_arn\n        }\n\n        self.flask_lambda_layer = _lambda.LayerVersion(\n            self,\n            \"FlaskAppLambdaLayer\",\n            code=_lambda.AssetCode(\"./layers/flask\"),\n            compatible_runtimes=[_lambda.Runtime.PYTHON_3_8,],\n        )\n\n        self.flask_app_lambda = _lambda.Function(\n            self,\n            \"FlaskAppLambda\",\n            runtime=_lambda.Runtime.PYTHON_3_8,\n            code=_lambda.AssetCode('./lambda/functions/interactions'),\n            function_name=\"flask-app-handler\",\n            handler=\"lambda-handler.handler\",\n            layers=[self.flask_lambda_layer],\n            timeout=core.Duration.seconds(60),\n            environment={**self.env_vars},\n        )\n\n        self.flask_app_lambda.role.add_managed_policy(\n            iam.ManagedPolicy.from_managed_policy_arn(\n                self,\n                'ECS_FullAccessPolicy',\n                managed_policy_arn='arn:aws:iam::aws:policy/AmazonECS_FullAccess'\n            )\n        )\n\n        # https://slmkitani.medium.com/passing-custom-headers-through-amazon-api-gateway-to-an-aws-lambda-function-f3a1cfdc0e29\n        self.request_templates = {\n            \"application/json\": '''{\n                \"method\": \"$context.httpMethod\",\n                \"body\" : $input.json(\"$\"),\n                \"headers\": {\n                    #foreach($param in $input.params().header.keySet())\n                    \"$param\": \"$util.escapeJavaScript($input.params().header.get($param))\"\n                    #if($foreach.hasNext),#end\n                    #end\n                }\n            }\n            '''\n        }\n\n        self.apigateway = apigw.RestApi(\n            self,\n            'FlaskAppEndpoint',\n        )\n\n        self.apigateway.root.add_method(\"ANY\")\n\n        self.discord_interaction_webhook = self.apigateway.root.add_resource(\"discord\")\n\n        self.discord_interaction_webhook_integration = apigw.LambdaIntegration(\n            self.flask_app_lambda,\n            request_templates=self.request_templates\n        )\n\n        self.discord_interaction_webhook.add_method(\n            'POST',\n            self.discord_interaction_webhook_integration\n        )\n",[36,2331,2332,2337,2342,2347,2352,2357,2361,2366,2370,2375,2380,2385,2390,2394,2399,2403,2408,2413,2418,2423,2428,2433,2438,2443,2447,2451,2456,2461,2466,2471,2476,2480,2484,2488,2493,2498,2503,2508,2513,2518,2523,2528,2533,2538,2542,2546,2551,2555,2559,2564,2568,2573,2577,2581,2586,2590,2595,2599,2604,2609,2614,2618,2622,2627,2632,2637],{"__ignoreMap":207},[306,2333,2334],{"class":308,"line":309},[306,2335,2336],{},"        self.env_vars = {\n",[306,2338,2339],{"class":308,"line":315},[306,2340,2341],{},"            \"APPLICATION_PUBLIC_KEY\": os.environ.get(\"APPLICATION_PUBLIC_KEY\"),\n",[306,2343,2344],{"class":308,"line":321},[306,2345,2346],{},"            \"ECS_SERVICE_NAME\": self.valheim_world.service.service_name,\n",[306,2348,2349],{"class":308,"line":326},[306,2350,2351],{},"            \"ECS_CLUSTER_ARN\": self.valheim_world.service.cluster.cluster_arn\n",[306,2353,2354],{"class":308,"line":333},[306,2355,2356],{},"        }\n",[306,2358,2359],{"class":308,"line":339},[306,2360,330],{"emptyLinePlaceholder":329},[306,2362,2363],{"class":308,"line":344},[306,2364,2365],{},"        self.flask_lambda_layer = _lambda.LayerVersion(\n",[306,2367,2368],{"class":308,"line":350},[306,2369,1217],{},[306,2371,2372],{"class":308,"line":355},[306,2373,2374],{},"            \"FlaskAppLambdaLayer\",\n",[306,2376,2377],{"class":308,"line":361},[306,2378,2379],{},"            code=_lambda.AssetCode(\"./layers/flask\"),\n",[306,2381,2382],{"class":308,"line":367},[306,2383,2384],{},"            compatible_runtimes=[_lambda.Runtime.PYTHON_3_8,],\n",[306,2386,2387],{"class":308,"line":373},[306,2388,2389],{},"        )\n",[306,2391,2392],{"class":308,"line":378},[306,2393,330],{"emptyLinePlaceholder":329},[306,2395,2396],{"class":308,"line":384},[306,2397,2398],{},"        self.flask_app_lambda = _lambda.Function(\n",[306,2400,2401],{"class":308,"line":389},[306,2402,1217],{},[306,2404,2405],{"class":308,"line":395},[306,2406,2407],{},"            \"FlaskAppLambda\",\n",[306,2409,2410],{"class":308,"line":401},[306,2411,2412],{},"            runtime=_lambda.Runtime.PYTHON_3_8,\n",[306,2414,2415],{"class":308,"line":407},[306,2416,2417],{},"            code=_lambda.AssetCode('./lambda/functions/interactions'),\n",[306,2419,2420],{"class":308,"line":413},[306,2421,2422],{},"            function_name=\"flask-app-handler\",\n",[306,2424,2425],{"class":308,"line":419},[306,2426,2427],{},"            handler=\"lambda-handler.handler\",\n",[306,2429,2430],{"class":308,"line":425},[306,2431,2432],{},"            layers=[self.flask_lambda_layer],\n",[306,2434,2435],{"class":308,"line":431},[306,2436,2437],{},"            timeout=core.Duration.seconds(60),\n",[306,2439,2440],{"class":308,"line":437},[306,2441,2442],{},"            environment={**self.env_vars},\n",[306,2444,2445],{"class":308,"line":443},[306,2446,2389],{},[306,2448,2449],{"class":308,"line":449},[306,2450,330],{"emptyLinePlaceholder":329},[306,2452,2453],{"class":308,"line":455},[306,2454,2455],{},"        self.flask_app_lambda.role.add_managed_policy(\n",[306,2457,2458],{"class":308,"line":461},[306,2459,2460],{},"            iam.ManagedPolicy.from_managed_policy_arn(\n",[306,2462,2463],{"class":308,"line":467},[306,2464,2465],{},"                self,\n",[306,2467,2468],{"class":308,"line":473},[306,2469,2470],{},"                'ECS_FullAccessPolicy',\n",[306,2472,2473],{"class":308,"line":478},[306,2474,2475],{},"                managed_policy_arn='arn:aws:iam::aws:policy/AmazonECS_FullAccess'\n",[306,2477,2478],{"class":308,"line":484},[306,2479,2110],{},[306,2481,2482],{"class":308,"line":490},[306,2483,2389],{},[306,2485,2486],{"class":308,"line":495},[306,2487,330],{"emptyLinePlaceholder":329},[306,2489,2490],{"class":308,"line":500},[306,2491,2492],{},"        # https://slmkitani.medium.com/passing-custom-headers-through-amazon-api-gateway-to-an-aws-lambda-function-f3a1cfdc0e29\n",[306,2494,2495],{"class":308,"line":506},[306,2496,2497],{},"        self.request_templates = {\n",[306,2499,2500],{"class":308,"line":512},[306,2501,2502],{},"            \"application/json\": '''{\n",[306,2504,2505],{"class":308,"line":518},[306,2506,2507],{},"                \"method\": \"$context.httpMethod\",\n",[306,2509,2510],{"class":308,"line":524},[306,2511,2512],{},"                \"body\" : $input.json(\"$\"),\n",[306,2514,2515],{"class":308,"line":530},[306,2516,2517],{},"                \"headers\": {\n",[306,2519,2520],{"class":308,"line":536},[306,2521,2522],{},"                    #foreach($param in $input.params().header.keySet())\n",[306,2524,2525],{"class":308,"line":542},[306,2526,2527],{},"                    \"$param\": \"$util.escapeJavaScript($input.params().header.get($param))\"\n",[306,2529,2530],{"class":308,"line":547},[306,2531,2532],{},"                    #if($foreach.hasNext),#end\n",[306,2534,2535],{"class":308,"line":553},[306,2536,2537],{},"                    #end\n",[306,2539,2540],{"class":308,"line":559},[306,2541,515],{},[306,2543,2544],{"class":308,"line":564},[306,2545,2239],{},[306,2547,2548],{"class":308,"line":569},[306,2549,2550],{},"            '''\n",[306,2552,2553],{"class":308,"line":575},[306,2554,2356],{},[306,2556,2557],{"class":308,"line":581},[306,2558,330],{"emptyLinePlaceholder":329},[306,2560,2561],{"class":308,"line":1985},[306,2562,2563],{},"        self.apigateway = apigw.RestApi(\n",[306,2565,2566],{"class":308,"line":1991},[306,2567,1217],{},[306,2569,2570],{"class":308,"line":1997},[306,2571,2572],{},"            'FlaskAppEndpoint',\n",[306,2574,2575],{"class":308,"line":2003},[306,2576,2389],{},[306,2578,2579],{"class":308,"line":2009},[306,2580,330],{"emptyLinePlaceholder":329},[306,2582,2583],{"class":308,"line":2015},[306,2584,2585],{},"        self.apigateway.root.add_method(\"ANY\")\n",[306,2587,2588],{"class":308,"line":2021},[306,2589,330],{"emptyLinePlaceholder":329},[306,2591,2592],{"class":308,"line":2026},[306,2593,2594],{},"        self.discord_interaction_webhook = self.apigateway.root.add_resource(\"discord\")\n",[306,2596,2597],{"class":308,"line":2032},[306,2598,330],{"emptyLinePlaceholder":329},[306,2600,2601],{"class":308,"line":2037},[306,2602,2603],{},"        self.discord_interaction_webhook_integration = apigw.LambdaIntegration(\n",[306,2605,2606],{"class":308,"line":2043},[306,2607,2608],{},"            self.flask_app_lambda,\n",[306,2610,2611],{"class":308,"line":2049},[306,2612,2613],{},"            request_templates=self.request_templates\n",[306,2615,2616],{"class":308,"line":2055},[306,2617,2389],{},[306,2619,2620],{"class":308,"line":2061},[306,2621,330],{"emptyLinePlaceholder":329},[306,2623,2624],{"class":308,"line":2066},[306,2625,2626],{},"        self.discord_interaction_webhook.add_method(\n",[306,2628,2629],{"class":308,"line":2072},[306,2630,2631],{},"            'POST',\n",[306,2633,2634],{"class":308,"line":2078},[306,2635,2636],{},"            self.discord_interaction_webhook_integration\n",[306,2638,2639],{"class":308,"line":2083},[306,2640,2389],{},[13,2642,2643,2644,2647],{},"First we add some environment variables that will be made available to the Lambda function's execution environment. The ECS cluster and service name as well as our Discord application's ",[36,2645,2646],{},"PUBLIC_KEY"," are needed in the Lambda function for everything to work.",[13,2649,2650],{},"We have to give the lambda function permissions to make changes to ECS since it will be interacting with ECS via boto3.",[13,2652,2653,2656,2657,2659],{},[36,2654,2655],{},"self.request_templates"," is needed in order to pass the special security headers from the Discord ",[36,2658,104],{}," request that are needed for security. I couldn't find a lot of resources on how to make this work, but I learned that this uses Apache Velocity Template Language.",[232,2661,2663],{"id":2662},"add-a-gitlab-ci-job-for-installing-dependencies-into-lambda-layer","Add a GitLab CI job for installing dependencies into Lambda Layer",[13,2665,2666],{},"There's one more step before we can push our code. We need to add another GitLab CI job that will install the Lambda dependencies so that they can be sent to the Lambda layer that we defined in our Lambda function. A Lambda Layer is where you install dependencies for this type of Lambda setup. Let's add the following stage:",[199,2668,2672],{"className":2669,"code":2670,"language":2671,"meta":207,"style":207},"language-yml shiki shiki-themes github-light github-dark","stages:\n  - build\n  - deploy\n\nimage: python:3.8\n\npip_install:\n  stage: build\n  rules:\n    - if: \"$CI_COMMIT_TAG\"\n      when: always\n  artifacts:\n    paths:\n      - layers/flask/python\n  script:\n    - pip install -r lambda/functions/interactions/requirements.txt -t layers/flask/python\n","yml",[36,2673,2674,2680,2687,2693,2697,2705,2709,2716,2724,2730,2740,2748,2755,2762,2770,2776],{"__ignoreMap":207},[306,2675,2676,2678],{"class":308,"line":309},[306,2677,1331],{"class":1330},[306,2679,1334],{"class":675},[306,2681,2682,2684],{"class":308,"line":315},[306,2683,1339],{"class":675},[306,2685,2686],{"class":701},"build\n",[306,2688,2689,2691],{"class":308,"line":321},[306,2690,1339],{"class":675},[306,2692,1342],{"class":701},[306,2694,2695],{"class":308,"line":326},[306,2696,330],{"emptyLinePlaceholder":329},[306,2698,2699,2701,2703],{"class":308,"line":333},[306,2700,1351],{"class":1330},[306,2702,685],{"class":675},[306,2704,1356],{"class":701},[306,2706,2707],{"class":308,"line":339},[306,2708,330],{"emptyLinePlaceholder":329},[306,2710,2711,2714],{"class":308,"line":344},[306,2712,2713],{"class":1330},"pip_install",[306,2715,1334],{"class":675},[306,2717,2718,2720,2722],{"class":308,"line":350},[306,2719,1372],{"class":1330},[306,2721,685],{"class":675},[306,2723,2686],{"class":701},[306,2725,2726,2728],{"class":308,"line":355},[306,2727,1381],{"class":1330},[306,2729,1334],{"class":675},[306,2731,2732,2734,2736,2738],{"class":308,"line":361},[306,2733,1388],{"class":675},[306,2735,1391],{"class":1330},[306,2737,685],{"class":675},[306,2739,1396],{"class":701},[306,2741,2742,2744,2746],{"class":308,"line":367},[306,2743,1401],{"class":1330},[306,2745,685],{"class":675},[306,2747,1406],{"class":701},[306,2749,2750,2753],{"class":308,"line":373},[306,2751,2752],{"class":1330},"  artifacts",[306,2754,1334],{"class":675},[306,2756,2757,2760],{"class":308,"line":378},[306,2758,2759],{"class":1330},"    paths",[306,2761,1334],{"class":675},[306,2763,2764,2767],{"class":308,"line":384},[306,2765,2766],{"class":675},"      - ",[306,2768,2769],{"class":701},"layers/flask/python\n",[306,2771,2772,2774],{"class":308,"line":389},[306,2773,1438],{"class":1330},[306,2775,1334],{"class":675},[306,2777,2778,2780],{"class":308,"line":395},[306,2779,1388],{"class":675},[306,2781,2782],{"class":701},"pip install -r lambda/functions/interactions/requirements.txt -t layers/flask/python\n",[13,2784,2785,2786,2789,2790,2792,2793,1105,2796,2799,2800,1105,2803,2805],{},"Now we are installing dependencies into a target location (with the ",[36,2787,2788],{},"-t"," flag) that our Lambda Layer will be able to use in the ",[36,2791,1365],{}," GitLab CI job. This is because we have indicated the path to ",[36,2794,2795],{},"layers/flask/python",[36,2797,2798],{},"paths"," array of ",[36,2801,2802],{},"artifacts",[36,2804,2713],{}," job. There are other ways to add the pip dependencies to the Lambda Layers. We don't absolutely need this to be done in a separate CI job.",[13,2807,2808],{},"Now tag and push the code to GitLab and check to see that the pipeline runs successfully.",[232,2810,2812],{"id":2811},"add-the-api-gateway-url-to-discord-application-settings","Add the API Gateway URL to Discord Application settings",[13,2814,2815],{},"If everything runs smoothly, we should see a URL in the very last lines of the pipeline. This is the URL for our API Gateway endpoint:",[199,2817,2820],{"className":2818,"code":2819,"language":204},[202],"https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/\n",[36,2821,2819],{"__ignoreMap":207},[13,2823,2824,2825,2828,2829,1105,2831,2833],{},"We need to add ",[36,2826,2827],{},"discord"," to the end of this URL and then add that to our the ",[36,2830,639],{},[36,2832,189],{}," section of our Discord application's admin page:",[199,2835,2838],{"className":2836,"code":2837,"language":204},[202],"https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/discord\n",[36,2839,2837],{"__ignoreMap":207},[13,2841,2842,2843,2848],{},"When we add this URL in the application settings, Discord will make sure that our endpoint is properly verifying the request based on its headers. Check out ",[17,2844,2847],{"href":2845,"rel":2846},"https://github.com/discord/discord-interactions-python/blob/main/discord_interactions/__init__.py#L31",[21],"this function"," to see how it works:",[199,2850,2852],{"className":300,"code":2851,"language":302,"meta":207,"style":207},"def verify_key_decorator(client_public_key):\n    from flask import request, jsonify\n\n    # https://stackoverflow.com/questions/51691730/flask-middleware-for-specific-route\n    def _decorator(f):\n        @wraps(f)\n        def __decorator(*args, **kwargs):\n            # Verify request\n            signature = request.headers.get('X-Signature-Ed25519')\n            timestamp = request.headers.get('X-Signature-Timestamp')\n            if signature is None or timestamp is None or not verify_key(request.data, signature, timestamp, client_public_key):\n                return 'Bad request signature', 401\n\n            # Automatically respond to pings\n            if request.json and request.json.get('type') == InteractionType.PING:\n                return jsonify({\n                    'type': InteractionResponseType.PONG\n                })\n\n            # Pass through\n            return f(*args, **kwargs)\n        return __decorator\n    return _decorator\n",[36,2853,2854,2859,2864,2868,2873,2878,2883,2888,2893,2898,2903,2908,2913,2917,2922,2927,2932,2937,2942,2946,2951,2956,2961],{"__ignoreMap":207},[306,2855,2856],{"class":308,"line":309},[306,2857,2858],{},"def verify_key_decorator(client_public_key):\n",[306,2860,2861],{"class":308,"line":315},[306,2862,2863],{},"    from flask import request, jsonify\n",[306,2865,2866],{"class":308,"line":321},[306,2867,330],{"emptyLinePlaceholder":329},[306,2869,2870],{"class":308,"line":326},[306,2871,2872],{},"    # https://stackoverflow.com/questions/51691730/flask-middleware-for-specific-route\n",[306,2874,2875],{"class":308,"line":333},[306,2876,2877],{},"    def _decorator(f):\n",[306,2879,2880],{"class":308,"line":339},[306,2881,2882],{},"        @wraps(f)\n",[306,2884,2885],{"class":308,"line":344},[306,2886,2887],{},"        def __decorator(*args, **kwargs):\n",[306,2889,2890],{"class":308,"line":350},[306,2891,2892],{},"            # Verify request\n",[306,2894,2895],{"class":308,"line":355},[306,2896,2897],{},"            signature = request.headers.get('X-Signature-Ed25519')\n",[306,2899,2900],{"class":308,"line":361},[306,2901,2902],{},"            timestamp = request.headers.get('X-Signature-Timestamp')\n",[306,2904,2905],{"class":308,"line":367},[306,2906,2907],{},"            if signature is None or timestamp is None or not verify_key(request.data, signature, timestamp, client_public_key):\n",[306,2909,2910],{"class":308,"line":373},[306,2911,2912],{},"                return 'Bad request signature', 401\n",[306,2914,2915],{"class":308,"line":378},[306,2916,330],{"emptyLinePlaceholder":329},[306,2918,2919],{"class":308,"line":384},[306,2920,2921],{},"            # Automatically respond to pings\n",[306,2923,2924],{"class":308,"line":389},[306,2925,2926],{},"            if request.json and request.json.get('type') == InteractionType.PING:\n",[306,2928,2929],{"class":308,"line":395},[306,2930,2931],{},"                return jsonify({\n",[306,2933,2934],{"class":308,"line":401},[306,2935,2936],{},"                    'type': InteractionResponseType.PONG\n",[306,2938,2939],{"class":308,"line":407},[306,2940,2941],{},"                })\n",[306,2943,2944],{"class":308,"line":413},[306,2945,330],{"emptyLinePlaceholder":329},[306,2947,2948],{"class":308,"line":419},[306,2949,2950],{},"            # Pass through\n",[306,2952,2953],{"class":308,"line":425},[306,2954,2955],{},"            return f(*args, **kwargs)\n",[306,2957,2958],{"class":308,"line":431},[306,2959,2960],{},"        return __decorator\n",[306,2962,2963],{"class":308,"line":437},[306,2964,2965],{},"    return _decorator\n",[13,2967,2968],{},"If it fails verification, we will not be able to add the URL and it will not work. You might want to add some additional logging to the Lambda function if you are not able to add the URL successfully.",[13,2970,2971,2972,98],{},"This is all covered in ",[17,2973,2976],{"href":2974,"rel":2975},"https://discord.com/developers/docs/interactions/slash-commands",[21],"the documentation for Discord Interactions",[13,2978,2979,2980,134,2983,98],{},"Now you should be able to run the Discord slash commands. You can get the status of your ECS cluster and scale it to either 1 or 0 for ",[36,2981,2982],{},"ON",[36,2984,2985],{},"OFF",[32,2987,2989],{"id":2988},"overview","Overview",[13,2991,2992],{},"Here's an overview of what we covered:",[13,2994,2995],{},[161,2996],{"alt":163,"src":164},[2998,2999,3001,3004,3007,3010,3013,3016,3024,3027,3033,3036,3045,3048,3051,3054,3057,3063,3069,3075,3084],"ol",{"start":3000},0,[71,3002,3003],{},"This is my computer. For development of this project (and most other projects) I used Windows with WSL2.",[71,3005,3006],{},"GitLab CI - This is used to run our automated pipelines whenever we push a tag.",[71,3008,3009],{},"The CDK CLI is used to create, update and delete the infrastructure in our AWS account.",[71,3011,3012],{},"Valheim - The client for the game server that we set up",[71,3014,3015],{},"The public IP address of the ECS Task that can be used to connect to our server on port 2456.",[71,3017,3018,3019,98],{},"The ECS Cluster that runs the actual docker container for the Valheim server. By default, the image used is ",[17,3020,3023],{"href":3021,"rel":3022},"https://hub.docker.com/r/lloesche/valheim-server",[21],"lloesche/valheim-server",[71,3025,3026],{},"EFS - This is the file system that is mounted onto the container of the ECS task where our game's world data is stored.",[71,3028,3029,3030,3032],{},"AWS Backup (Optional) - This is an optional feature of the ",[36,3031,38],{}," construct that can make regular backups of our EFS file system.",[71,3034,3035],{},"Events (Optional) - AWS Events can be used to scale the number of ECS tasks between 0 and 1.",[71,3037,3038,3039,3044],{},"This is the ",[17,3040,3042],{"href":45,"rel":3041},[21],[36,3043,38],{}," construct that I use in this project.",[71,3046,3047],{},"S3 bucket for syncing data to and from EFS with DataSync (WIP)",[71,3049,3050],{},"DataSync for moving game data between EFS and S3.",[71,3052,3053],{},"The Slash Commands that we set up",[71,3055,3056],{},"Discord",[71,3058,3059,3060,3062],{},"Discord Interactions sends and a ",[36,3061,104],{}," request",[71,3064,3065,3066,3068],{},"The API Gateway endpoint that we configured to handle Discord Interaction ",[36,3067,104],{}," requests.",[71,3070,3071,3072,3074],{},"The Lambda function running a simple Flask app that responds to the Interaction ",[36,3073,104],{}," request.",[71,3076,3077,3078,134,3080,3083],{},"boto3 - This is the AWS SDK Python library included in the Python execution environment that allows us to interact with the resources in our AWS account. In particular, the interactions we use from boto3 are the ",[36,3079,108],{},[36,3081,3082],{},"describe_servics"," methods from the ECS module. This allows us to turn our server on and off and also get the status.",[71,3085,3086,3087,3090],{},"This represents the ",[36,3088,3089],{},"valheim-server-stack"," we defined in our CDK application.",[32,3092,3094],{"id":3093},"todo","TODO",[13,3096,3097],{},"There are still some things that I'm working on finalizing.",[68,3099,3100,3103,3106,3109,3112],{},[71,3101,3102],{},"DataSync for easily moving data between S3 and EFS",[71,3104,3105],{},"Report billing data with an additional slash command sub-command",[71,3107,3108],{},"Add tagging to the resources in our stack to make the billing command easier to implement.",[71,3110,3111],{},"Get feedback from the Discord, CDK and Valheim communities about what I can improve here",[71,3113,3114,3115],{},"Contribute to ",[17,3116,3118],{"href":45,"rel":3117},[21],[36,3119,3120],{},"gotodeploy/cdk-valheim",[13,3122,3123],{},"Thanks for reading!",[3125,3126,3127],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html pre.shiki code .s9eBZ, html code.shiki .s9eBZ{--shiki-default:#22863A;--shiki-dark:#85E89D}",{"title":207,"searchDepth":315,"depth":315,"links":3129},[3130,3132,3133,3137,3138,3143,3144,3148,3149],{"id":34,"depth":315,"text":3131},"cdk-valheim construct on GitHub",{"id":82,"depth":315,"text":83},{"id":170,"depth":315,"text":171,"children":3134},[3135,3136],{"id":234,"depth":321,"text":235},{"id":290,"depth":321,"text":291},{"id":651,"depth":315,"text":652},{"id":1010,"depth":315,"text":1011,"children":3139},[3140,3141,3142],{"id":1040,"depth":321,"text":1041},{"id":1310,"depth":321,"text":1311},{"id":1538,"depth":321,"text":1539},{"id":1687,"depth":315,"text":1688},{"id":2313,"depth":315,"text":2314,"children":3145},[3146,3147],{"id":2662,"depth":321,"text":2663},{"id":2811,"depth":321,"text":2812},{"id":2988,"depth":315,"text":2989},{"id":3093,"depth":315,"text":3094},false,"2021-03-18","This is a detailed guide showing how to setup a dedicated Valheim server using serverless technologies on AWS","md",null,"/static/valheim/hall.png",{},"/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions",{"title":5,"description":3152},"2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions",[3161,3162,3163,3164,3165,2827],"valheim","gaming","python","flask","serverless","j-Hl7SFibtOek-ic9mIv5wPft5eglYM_iIWCjTyFQv8",1753130137984]