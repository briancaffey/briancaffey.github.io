<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>On-demand, serverless Valheim server setup with AWS CDK, Discord Interactions and GitLab CI</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Brian Caffey's personal website"><meta data-n-head="ssr" name="robots" content="all"><meta data-n-head="ssr" property="og:title" content="On-demand, serverless Valheim server setup with AWS CDK, Discord Interactions and GitLab CI"><meta data-n-head="ssr" property="og:description" content="This is a detailed guide showing how to setup a dedicated Valheim server using serverless technologies on AWS"><meta data-n-head="ssr" property="og:image" content="https://briancaffey.github.io/static/valheim/hall.png"><meta data-n-head="ssr" property="twitter:card" content="https://briancaffey.github.io/static/valheim/hall.png"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><script data-n-head="ssr" data-hid="adsbygoogle-script" defer crossorigin="anonymous" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4924597640144289"></script><script data-n-head="ssr" data-hid="adsbygoogle">window.__abg_called||((adsbygoogle=window.adsbygoogle||[]).pauseAdRequests=0,(window.adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4924597640144289",enable_page_level_ads:!1,overlays:{bottom:!1}}),window.__abg_called=!0)</script><link rel="preload" href="/_nuxt/2ac5113.js" as="script"><link rel="preload" href="/_nuxt/72e9485.js" as="script"><link rel="preload" href="/_nuxt/57968fc.js" as="script"><link rel="preload" href="/_nuxt/d33dfc9.js" as="script"><link rel="preload" href="/_nuxt/cddfb8a.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 f52d43e0:0 9592d830:0 517a8dd7:0 072b2f8a:0 fa7ff0ca:0 56b15182:0 5a4b6265:0 14b1eaf9:0 a0fa61ae:0 7f6c3ed0:0 64516d8e:0 5586ddaf:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-black{--bg-opacity:1;background-color:#000;background-color:rgba(0,0,0,var(--bg-opacity))}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-red-300{--bg-opacity:1;background-color:#feb2b2;background-color:rgba(254,178,178,var(--bg-opacity))}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.float-right{float:right}.font-bold{font-weight:700}.h-3{height:.75rem}.h-4{height:1rem}.h-12{height:3rem}.h-32{height:8rem}.h-64{height:16rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.leading-8{line-height:2rem}.leading-9{line-height:2.25rem}.m-2{margin:.5rem}.m-4{margin:1rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.-ml-1{margin-left:-.25rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.object-cover{-o-object-fit:cover;object-fit:cover}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.py-32{padding-top:8rem;padding-bottom:8rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pr-4{padding-right:1rem}.pb-4{padding-bottom:1rem}.pt-8{padding-top:2rem}.pb-8{padding-bottom:2rem}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.resize{resize:both}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}.text-gray-500{--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-red-400{--text-opacity:1;color:#fc8181;color:rgba(252,129,129,var(--text-opacity))}.text-red-600{--text-opacity:1;color:#e53e3e;color:rgba(229,62,62,var(--text-opacity))}.uppercase{text-transform:uppercase}.visible{visibility:visible}.w-3{width:.75rem}.w-4{width:1rem}.w-12{width:3rem}.w-32{width:8rem}.w-full{width:100%}.z-10{z-index:10}.gap-4{grid-gap:1rem;gap:1rem}.gap-6{grid-gap:1.5rem;gap:1.5rem}.gap-8{grid-gap:2rem;gap:2rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.transform{--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y))}.transition-all{transition-property:all}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}.duration-150{transition-duration:.15s}.delay-150{transition-delay:.15s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:inline{display:inline}.sm\:hidden{display:none}.sm\:p-16{padding:4rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:w-2\/3{width:66.666667%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:px-1{padding-left:.25rem;padding-right:.25rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:px-32{padding-left:8rem;padding-right:8rem}.lg\:pl-64{padding-left:16rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1280px){.xl\:pb-16{padding-bottom:4rem}}:root{--color:#243746;--color-primary:#158876;--color-secondary:#0e2233;--bg:#f3f5f4;--bg-secondary:#fff;--bg-code:#ddd;--border-color:#ddd}.dark-mode{--color:#ebf4f1;--color-primary:#41b38a;--color-secondary:#fdf9f3;--bg:#091a28;--bg-secondary:#071521;--bg-code:#ddd;--border-color:#0d2538}.sepia-mode{--color:#433422;--color-primary:#504231;--color-secondary:#504231;--bg:#f1e7d0;--bg-code:#ddd;--bg-secondary:#eae0c9;--border-color:#ded0bf}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background-color:#f3f5f4;background-color:var(--bg);color:#243746;color:var(--color);transition:background-color .7s}a{color:#158876;color:var(--color-primary)}.py-05{padding-top:.125rem;padding-bottom:.125rem}.markdown{--text-opacity:1;color:#1a202c;color:rgba(26,32,44,var(--text-opacity));line-height:1.5;color:#0e2233;color:var(--color-secondary)}.markdown .token.operator{background:0 0}.markdown>*+*{margin-top:0;margin-bottom:1rem}.markdown li+li{margin-top:.25rem}.markdown li>p+p{margin-top:1.5rem;color:#158876;color:var(--color-primary)}.markdown img{margin:auto}.markdown a,.markdown strong{font-weight:600}.markdown strong a{font-weight:700}.markdown h1{font-size:2.25rem}.markdown h1,.markdown h2{border-color:#158876;border-color:var(--color-primary);line-height:1.25;border-bottom-width:1px;font-weight:600;margin-bottom:1rem;margin-top:1.5rem;padding-bottom:.5rem}.markdown h2{font-size:1.5rem}.markdown h3{line-height:1.375;font-size:1.125rem}.markdown h3,.markdown h4{border-color:#158876;border-color:var(--color-primary);font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown h4{line-height:1;font-size:1rem}.markdown h5{border-color:#158876;border-color:var(--color-primary)}.markdown h5,.markdown h6{line-height:1.25;font-size:.875rem;font-weight:600;margin-bottom:1rem;margin-top:1.5rem}.markdown blockquote,.markdown h6{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.markdown blockquote{font-size:1rem;border-left-width:4px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1rem;padding-right:1rem;border-color:#158876;border-color:var(--color-primary)}.markdown code{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.875rem;display:inline;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity));padding:.125rem .25rem;background-color:#ddd;background-color:var(--bg-code);color:#000}.markdown code,.markdown pre{--bg-opacity:1;border-radius:.25rem}.markdown pre{background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:1rem}.markdown pre code{display:block;background-color:transparent;padding:0;overflow:visible;border-radius:0;color:#000}.markdown p{margin-bottom:10px}code[class*=language-],pre[class*=language-]{background:#ddd!important;background:var(--bg-code)!important;text-shadow:none!important}.markdown ul{list-style-type:disc}.markdown ol,.markdown ul{font-size:1rem;padding-left:2rem}.markdown ol{list-style-type:decimal}.markdown kbd{font-size:.75rem;display:inline-block;border-radius:.25rem;border-width:1px;padding:.125rem .25rem;vertical-align:middle;font-weight:400;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.markdown table,td,th{font-size:1rem;border:1px solid #243746;border-color:var(--color)}.markdown table{overflow-x:scroll}.markdown td,.markdown th{border-width:1px;padding:.25rem .75rem}.markdown .highlight pre{--bg-opacity:1!important;background-color:#f7fafc!important;background-color:rgba(247,250,252,var(--bg-opacity))!important}.article-card{box-shadow:0 5px 10px 0 #0e2233;box-shadow:0 5px 10px 0 var(--color-secondary);transition:box-shadow .2s,transform .2s;height:100%}.article-card:hover{box-shadow:0 10px 40px 0 #0e2233;box-shadow:0 10px 40px 0 var(--color-secondary);transform:scale(1.025)}.blog-card-description,.blog-date{color:#0e2233;color:var(--color-secondary)}.blog-date{font-style:italic}hr{background-color:#243746;background-color:var(--color);border:none;height:1px}.menu-icon{background-color:#ddd;background-color:var(--border-color)}.menu-icon,.mobile-menu{color:#243746;color:var(--color)}.mobile-menu{background-color:#fff;background-color:var(--bg-secondary)}.btn{border-radius:1;border-color:#158876;border-color:var(--color-primary)}.btn:hover{background-color:#fff;background-color:var(--bg-secondary)}.hero{border-color:#158876;border-color:var(--color-primary)}.markdown{word-wrap:break-word}.markdown h2:before,.markdown h3:before{display:block;content:" ";margin-top:-85px;height:85px;visibility:hidden;pointer-events:none}.markdown h2>a,.markdown h3>a{margin-left:1.25rem}.markdown h2>a:before,.markdown h3>a:before{content:"#";font-weight:400;font-size:1.25rem;line-height:2rem;margin-left:-1.25rem;padding-right:.5rem;position:absolute;opacity:1}@media (min-width:1024px){.markdown h2>a,.markdown h3>a{margin-left:0}.markdown h2>a:before,.markdown h3>a:before{opacity:0}}.markdown h2:hover>a:before,.markdown h3:hover>a:before{opacity:1}& pre[class*=language-]{--bg-opacity:1;background-color:#2d3748;background-color:rgba(45,55,72,var(--bg-opacity));position:static}.mc{background-color:#f3f5f4;background-color:var(--bg);border-color:#158876;border-color:var(--color-primary);border-width:1px;color:#158876;color:var(--color-primary);justify-content:center;padding:5px 10px;border-radius:5px;width:100%}.mc-btn{color:#fff;color:var(--bg-secondary);background-color:#0e2233;background-color:var(--color-secondary);cursor:pointer}.page-enter-active,.page-leave-active{transition:filter 2s linear;transition:margin-top .15s,opacity .15s}.page-enter,.page-leave-to{opacity:0;margin-top:5px}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.emoji-mart,.emoji-mart *{-webkit-box-sizing:border-box;box-sizing:border-box;line-height:1.15}.emoji-mart{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:16px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;height:420px;color:#222427;border:1px solid #d9d9d9;border-radius:5px;background:#fff}.emoji-mart-emoji{padding:6px;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-emoji span{display:inline-block}.emoji-mart-preview-emoji .emoji-mart-emoji span{width:38px;height:38px;font-size:32px}.emoji-type-native{font-family:"Segoe UI Emoji","Segoe UI Symbol","Segoe UI","Apple Color Emoji","Twemoji Mozilla","Noto Color Emoji","EmojiOne Color","Android Emoji";word-break:keep-all}.emoji-type-image{background-size:5700%}.emoji-type-image.emoji-set-apple{background-image:url(https://unpkg.com/emoji-datasource-apple@6.0.1/img/apple/sheets-256/64.png)}.emoji-type-image.emoji-set-facebook{background-image:url(https://unpkg.com/emoji-datasource-facebook@6.0.1/img/facebook/sheets-256/64.png)}.emoji-type-image.emoji-set-google{background-image:url(https://unpkg.com/emoji-datasource-google@6.0.1/img/google/sheets-256/64.png)}.emoji-type-image.emoji-set-twitter{background-image:url(https://unpkg.com/emoji-datasource-twitter@6.0.1/img/twitter/sheets-256/64.png)}.emoji-mart-bar{border:0 solid #d9d9d9}.emoji-mart-bar:first-child{border-bottom-width:1px;border-top-left-radius:5px;border-top-right-radius:5px}.emoji-mart-bar:last-child{border-top-width:1px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.emoji-mart-scroll{position:relative;overflow-y:scroll;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-anchors{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:0 6px;color:#858585;line-height:0}.emoji-mart-anchor{position:relative;display:block;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;text-align:center;padding:12px 4px;overflow:hidden;-webkit-transition:color .1s ease-out;-o-transition:color .1s ease-out;transition:color .1s ease-out;border:none;background:0 0;-webkit-box-shadow:none;box-shadow:none}.emoji-mart-anchor-selected,.emoji-mart-anchor:hover{color:#464646}.emoji-mart-anchor-selected .emoji-mart-anchor-bar{bottom:0}.emoji-mart-anchor-bar{position:absolute;bottom:-3px;left:0;width:100%;height:3px;background-color:#464646}.emoji-mart-anchors i{display:inline-block;width:100%;max-width:22px}.emoji-mart-anchors svg{fill:currentColor;max-height:18px}.emoji-mart .scroller{height:250px;position:relative;-webkit-box-flex:1;-ms-flex:1;flex:1;padding:0 6px 6px;z-index:0;will-change:transform;-webkit-overflow-scrolling:touch}.emoji-mart-search{margin-top:6px;padding:0 6px}.emoji-mart-search input{font-size:16px;display:block;width:100%;padding:.2em .6em;border-radius:25px;border:1px solid #d9d9d9;outline:0}.emoji-mart-search-results{height:250px;overflow-y:scroll}.emoji-mart-category{position:relative}.emoji-mart-category .emoji-mart-emoji span{z-index:1;position:relative;text-align:center;cursor:default}.emoji-mart-category .emoji-mart-emoji:hover:before,.emoji-mart-emoji-selected:before{z-index:0;content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#f4f4f4;border-radius:100%;opacity:0;opacity:1}.emoji-mart-category-label{position:-webkit-sticky;position:sticky;top:0}.emoji-mart-static .emoji-mart-category-label{z-index:2;position:relative}.emoji-mart-category-label h3{display:block;font-size:16px;width:100%;font-weight:500;padding:5px 6px;background-color:#fff;background-color:hsla(0,0%,100%,.95)}.emoji-mart-emoji{position:relative;display:inline-block;font-size:0}.emoji-mart-no-results{font-size:14px;text-align:center;padding-top:70px;color:#858585}.emoji-mart-no-results .emoji-mart-category-label{display:none}.emoji-mart-no-results .emoji-mart-no-results-label{margin-top:.2em}.emoji-mart-no-results .emoji-mart-emoji:hover:before{content:none}.emoji-mart-preview{position:relative;height:70px}.emoji-mart-preview-data,.emoji-mart-preview-emoji,.emoji-mart-preview-skins{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.emoji-mart-preview-emoji{left:12px}.emoji-mart-preview-data{left:68px;right:12px;word-break:break-all}.emoji-mart-preview-skins{right:30px;text-align:right}.emoji-mart-preview-name{font-size:14px}.emoji-mart-preview-shortname{font-size:12px;color:#888}.emoji-mart-preview-emoticon+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-emoticon,.emoji-mart-preview-shortname+.emoji-mart-preview-shortname{margin-left:.5em}.emoji-mart-preview-emoticon{font-size:11px;color:#bbb}.emoji-mart-title span{display:inline-block;vertical-align:middle}.emoji-mart-title .emoji-mart-emoji{padding:0}.emoji-mart-title-label{color:#999a9c;font-size:21px;font-weight:300}.emoji-mart-skin-swatches{font-size:0;padding:2px 0;border:1px solid #d9d9d9;border-radius:12px;background-color:#fff}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch{width:16px;padding:0 2px}.emoji-mart-skin-swatches-opened .emoji-mart-skin-swatch-selected:after{opacity:.75}.emoji-mart-skin-swatch{display:inline-block;width:0;vertical-align:middle;-webkit-transition-property:width,padding;-o-transition-property:width,padding;transition-property:width,padding;-webkit-transition-duration:.125s;-o-transition-duration:.125s;transition-duration:.125s;-webkit-transition-timing-function:ease-out;-o-transition-timing-function:ease-out;transition-timing-function:ease-out}.emoji-mart-skin-swatch:first-child{-webkit-transition-delay:0s;-o-transition-delay:0s;transition-delay:0s}.emoji-mart-skin-swatch:nth-child(2){-webkit-transition-delay:.03s;-o-transition-delay:.03s;transition-delay:.03s}.emoji-mart-skin-swatch:nth-child(3){-webkit-transition-delay:.06s;-o-transition-delay:.06s;transition-delay:.06s}.emoji-mart-skin-swatch:nth-child(4){-webkit-transition-delay:.09s;-o-transition-delay:.09s;transition-delay:.09s}.emoji-mart-skin-swatch:nth-child(5){-webkit-transition-delay:.12s;-o-transition-delay:.12s;transition-delay:.12s}.emoji-mart-skin-swatch:nth-child(6){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}.emoji-mart-skin-swatch-selected{position:relative;width:16px;padding:0 2px}.emoji-mart-skin-swatch-selected:after{content:"";position:absolute;top:50%;left:50%;width:4px;height:4px;margin:-2px 0 0 -2px;background-color:#fff;border-radius:100%;pointer-events:none;opacity:0;-webkit-transition:opacity .2s ease-out;-o-transition:opacity .2s ease-out;transition:opacity .2s ease-out}.emoji-mart-skin{display:inline-block;width:100%;padding-top:100%;max-width:12px;border-radius:100%}.emoji-mart-skin-tone-1{background-color:#ffc93a}.emoji-mart-skin-tone-2{background-color:#fadcbc}.emoji-mart-skin-tone-3{background-color:#e0bb95}.emoji-mart-skin-tone-4{background-color:#bf8f68}.emoji-mart-skin-tone-5{background-color:#9b643d}.emoji-mart-skin-tone-6{background-color:#594539}.emoji-mart .vue-recycle-scroller{position:relative}.emoji-mart .vue-recycle-scroller.direction-vertical:not(.page-mode){overflow-y:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal:not(.page-mode){overflow-x:auto}.emoji-mart .vue-recycle-scroller.direction-horizontal{display:-webkit-box;display:-ms-flexbox;display:flex}.emoji-mart .vue-recycle-scroller__slot{-webkit-box-flex:1;-ms-flex:auto 0 0px;flex:auto 0 0}.emoji-mart .vue-recycle-scroller__item-wrapper{-webkit-box-flex:1;-ms-flex:1;flex:1;-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;position:relative}.emoji-mart .vue-recycle-scroller.ready .vue-recycle-scroller__item-view{position:absolute;top:0;left:0;will-change:transform}.emoji-mart .vue-recycle-scroller.direction-vertical .vue-recycle-scroller__item-wrapper{width:100%}.emoji-mart .vue-recycle-scroller.direction-horizontal .vue-recycle-scroller__item-wrapper{height:100%}.emoji-mart .vue-recycle-scroller.ready.direction-vertical .vue-recycle-scroller__item-view{width:100%}.emoji-mart .vue-recycle-scroller.ready.direction-horizontal .vue-recycle-scroller__item-view{height:100%}.emoji-mart .resize-observer[data-v-b329ee4c]{border:none;background-color:transparent;opacity:0}.emoji-mart .resize-observer[data-v-b329ee4c],.emoji-mart .resize-observer[data-v-b329ee4c] object{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;pointer-events:none;display:block;overflow:hidden}.emoji-mart-search .hidden{display:none;visibility:hidden}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}html{font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;box-sizing:border-box}*,:after,:before{box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}span.emoji-mart-emoji[data-v-3f691362]{padding:0}.selected[data-v-3f691362]{text-shadow:.25px 0 0 #000}.picker[data-v-3f691362]{position:absolute;top:10px;margin-left:auto;margin-right:auto;transform:translate(50%,50%)}.top[data-v-3f691362]{width:100%;background-color:var(--color-primary);height:3px}.selected[data-v-107ae01e]{text-shadow:.9px 0 0}span.emoji-mart-emoji[data-v-288717a6]{padding:0;transition:transform .2s}span.emoji-mart-emoji[data-v-288717a6]:hover{transform:scale(1.3)}.centered[data-v-288717a6]{position:absolute;left:50vw;right:50vw;margin-left:auto;margin-right:auto}span.emoji-mart-emoji[data-v-4f7c5820]{padding:0}.modal[data-v-4f7c5820]{z-index:100000000;top:0;-webkit-backdrop-filter:blur(.4px);backdrop-filter:blur(.4px);background-color:rgba(0,0,0,.2)}.modal[data-v-4f7c5820],.picker[data-v-4f7c5820]{position:absolute;left:0}.picker[data-v-4f7c5820]{z-index:10000000000;right:0;margin-left:auto;margin-right:auto}.cover-image[data-v-4b9599ea]{transition:transform .2s}.cover-image[data-v-4b9599ea]:hover{transform:scale(1.025)}.tag[data-v-3fbcd028]{background-color:var(--color-primary);transition:transform .2s}.tag[data-v-3fbcd028]:hover{transform:scale(1.05)}</style><link rel="preload" href="/_nuxt/static/1635735110/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions/state.js" as="script"><link rel="preload" href="/_nuxt/static/1635735110/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1635735110/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,r=document,s=r.documentElement,n=["dark","light"],e=function(){for(var e="nuxt-color-mode=",t=r.cookie.split(";"),s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}()||"system",a="system"===e?l():e;function c(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function o(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function l(){if(t.matchMedia&&"not all"!==o("").media)for(var e of n)if(o(":"+e).matches)return e;return"light"}c(a),t.__NUXT_COLOR_MODE__={preference:e,value:a,getColorScheme:l,addClass:c,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div data-v-3f691362><div class="top" data-v-3f691362></div> <div class="mx-auto flex py-2 px-2 sm:px-4 items-center max-w-6xl justify-center" data-v-3f691362><div class="justify-left flex-grow flex-cols-4" data-v-3f691362><a href="/" class="text-xl nuxt-link-active" data-v-3f691362><span class="hidden sm:inline text-2xl" data-v-3f691362>Brian Caffey</span><span class="inline sm:hidden" data-v-3f691362>JBC</span></a></div> <div class="flex-grow relative" data-v-3f691362><nav z-index="10000" data-v-107ae01e data-v-3f691362><div data-v-107ae01e><ul class="items-right float-right hidden md:flex" data-v-107ae01e><li class="px-4 text-lg" data-v-107ae01e><a href="/blog/1" data-v-107ae01e>
          Blog
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/projects" data-v-107ae01e>
          Projects
        </a></li> <li class="px-4 text-lg" data-v-107ae01e><a href="/contact" data-v-107ae01e>
          Contact
        </a></li></ul> <div class="flex justify-end md:hidden z-1000" data-v-107ae01e><button class="flex items-center px-3 py-2 border rounded menu-icon" data-v-107ae01e><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="fill-current h-3 w-3" data-v-107ae01e><title data-v-107ae01e>Menu</title> <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" data-v-107ae01e></path></svg></button></div> <!----></div></nav></div></div> <div class="picker" data-v-3f691362><div class="centered" data-v-288717a6 data-v-3f691362><div class="grid items-center justify-center" data-v-288717a6><ul class="flex px-4" data-v-288717a6><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üñ•Ô∏è, desktop_computer" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:52.63% 12.28%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåû, sun_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 77.19%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="üåö, new_moon_with_face" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:8.77% 70.18%;width:32px;height:32px"></span></span></li><li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><span aria-label="‚òï, coffee" class="emoji-mart-emoji" data-v-288717a6><span class="emoji-set-apple emoji-type-image" style="background-position:94.74% 8.77%;width:32px;height:32px"></span></span></li> <li class="md:px-1 px-1 cursor-pointer" data-v-288717a6><div data-v-4f7c5820 data-v-288717a6><!----> <ul data-v-4f7c5820><li class="md:px-1 px-1 cursor-pointer" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:32px;height:32px"></span></span></li></ul> <div class="rounded-md z-10 picker" data-v-4f7c5820><div class="bg-white shadow-md rounded px-4 py-2 w-32 text" style="display:none" data-v-4f7c5820><a href="/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-4f7c5820><span aria-label="üá∫üá∏, us, flag-us" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:7.02% 68.42%;width:16px;height:16px"></span></span> English <br data-v-4f7c5820></a><a href="/fr/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" data-v-4f7c5820><span aria-label="üá´üá∑, fr, flag-fr" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 91.23%;width:16px;height:16px"></span></span> Fran√ßais <br data-v-4f7c5820></a><a href="/zh/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" data-v-4f7c5820><span aria-label="üá®üá≥, cn, flag-cn" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:1.75% 36.84%;width:16px;height:16px"></span></span> ÁÆÄ‰Ωì‰∏≠Êñá <br data-v-4f7c5820></a><a href="/ru/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" data-v-4f7c5820><span aria-label="üá∑üá∫, ru, flag-ru" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:5.26% 92.98%;width:16px;height:16px"></span></span> –†—É—Å—Å–∫–∏–π <br data-v-4f7c5820></a><a href="/jp/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" data-v-4f7c5820><span aria-label="üáØüáµ, jp, flag-jp" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 59.65%;width:16px;height:16px"></span></span> Êó•Êú¨Ë™û <br data-v-4f7c5820></a><a href="/in/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions" data-v-4f7c5820><span aria-label="üáÆüá≥, flag-in" class="emoji-mart-emoji" data-v-4f7c5820><span class="emoji-set-apple emoji-type-image" style="background-position:3.51% 43.86%;width:16px;height:16px"></span></span> ‡§π‡§ø‡§Ç‡§¶‡•Ä <br data-v-4f7c5820></a></div></div></div></li></ul></div></div></div></div> <article data-v-4b9599ea><img src="/static/valheim/hall.png" class="pt-2 h-64 w-full object-cover cover-image" data-v-4b9599ea> <div class="mx-auto max-w-5xl px-2 sm:px-4 md:px-4 lg:px-16 mt-2" data-v-4b9599ea><h1 class="prose text-3xl leading-9" data-v-4b9599ea>
      On-demand, serverless Valheim server setup with AWS CDK, Discord Interactions and GitLab CI
    </h1> <div class="flex flex-wrap -ml-1 py-2" data-v-21780fb6 data-v-4b9599ea><a href="/blog/tags/valheim" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    valheim üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/gaming" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    gaming üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/python" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    python üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/flask" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    flask üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/serverless" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    serverless üè∑Ô∏è
    <!----></div></a><a href="/blog/tags/discord" data-v-3fbcd028 data-v-21780fb6><div class="px-2 text-lg text-white shadow rounded-lg bg-black mx-1 mt-1 uppercase cursor-pointer tag" data-v-3fbcd028>
    discord üè∑Ô∏è
    <!----></div></a></div> <!----> <p class="blog-date text-gray-500 mb-4" data-v-4b9599ea>
      Last Updated on
      March 18, 2021
    </p> <!----> <div class="markdown nuxt-content" data-v-4b9599ea data-v-4b9599ea><blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Here's a link to the GitLab repo I'll be referencing in this article: <a href="https://gitlab.com/briancaffey/valheim-cdk-discord-interactions" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://gitlab.com/briancaffey/valheim-cdk-discord-interactions</a></p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>This is an in-depth technical article about running an on-demand, dedicated server for Valheim using Amazon Web Services controlled with Discord Slash Commands, a new part their Interactions API that is currently in beta. Valheim is an open-world online multiplayer survival game loosely based on Norse mythology that has blown up recently.</p>
<p data-v-4b9599ea data-v-4b9599ea>My main goal with this project was to find an inexpensive way of running a server given how my friends and I play the game, which is typically a few times a week in the evenings. Some combination of 4 of us will start playing, and we drop in and out between walking dogs, cooking, etc. When playing, we all jump on a dedicated voice channel on our group's Discord.</p>
<p data-v-4b9599ea data-v-4b9599ea>Before setting up a dedicated server, our game's world state was stored on files that lived on one of our computers, and that computer needed to be running the game server in order for anyone to connect. Sending files around would be possible, but would quickly become tedious. There are lots of services that offer dedicated servers for Valheim, as well as many technical guides and channels on the official Valheim Discord server to support the use of dedicated servers. I wanted to see if I could set up a server myself on AWS using CDK, or Cloud Development Kit. CDK is an Infrastructure as Code (IaC) tool that allows you to define, deploy and update AWS infrastructure with popular programming languages such as Python, Typescript, Java, etc.</p>
<h2 id="cdk-valheim-construct-on-github" data-v-4b9599ea data-v-4b9599ea><a href="#cdk-valheim-construct-on-github" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a><code data-v-4b9599ea data-v-4b9599ea>cdk-valheim</code> construct on GitHub</h2>
<p data-v-4b9599ea data-v-4b9599ea>The best part of CDK is that it enables the creation high-level, reusable constructs that can be published to software registries like npm and PyPI. Developers can import and use these constructs in their own CDK code. A quick google search for "cdk valheim" turned up a few results. <a href="https://github.com/gotodeploy/cdk-valheim" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>cdk-valheim</a> seems like the best option for what I was looking for. This project uses ECS, a container orchestration tool from AWS that I have experience using with web applications and EFS for persistent file storage. Although it is written in Typescript, I can still use the construct in my preferred programming language (Python) without any extra effort or configuration. This is thanks to the jsii. From <a href="https://github.com/aws/jsii" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://github.com/aws/jsii</a>:</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>jsii</code> allows code in any language to naturally interact with JavaScript classes. It is the technology that enables the AWS Cloud Development Kit to deliver polyglot libraries from a single codebase!</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>Here's an overview of the <code data-v-4b9599ea data-v-4b9599ea>cdk-valheim</code> construct:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>Scheduled scaling of an ECS service using AWS Fargate (a serverless compute engine for containers)</li>
<li data-v-4b9599ea data-v-4b9599ea>Elastic File System (EFS) file system mounted into the Fargate Task container of our ECS service</li>
<li data-v-4b9599ea data-v-4b9599ea>Optional automated backups of the EFS file system using AWS Backup</li>
</ul>
<h2 id="discord-interactions-and-slash-commands" data-v-4b9599ea data-v-4b9599ea><a href="#discord-interactions-and-slash-commands" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Discord Interactions and Slash Commands</h2>
<p data-v-4b9599ea data-v-4b9599ea>Scheduled ECS scaling is nice, but we don't always know when we will be able to play together, so it is not the best way to minimize infrastructure costs. My plan was to set the ECS service to an initial task count of zero and then let any of us set the number of tasks to either zero or one through a Discord Slash Command. A Slash Command allows you to interact with a discord bot by typing <code data-v-4b9599ea data-v-4b9599ea>/</code> and then tabbing through to the option we want, such as <code data-v-4b9599ea data-v-4b9599ea>/valheim server start</code> or <code data-v-4b9599ea data-v-4b9599ea>/valheim server status</code>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Invoking a Slash Command from Discord sends a <code data-v-4b9599ea data-v-4b9599ea>POST</code> request from Discord to a webhook URL that we have to provide. To handle the webhook, one simple and inexpensive approach is to use API Gateway and a Lambda function that serves a Flask app. The Flask app can then use boto3 (which is included in the Lambda execution environment) to call <code data-v-4b9599ea data-v-4b9599ea>update_service</code> or <code data-v-4b9599ea data-v-4b9599ea>describe_services</code> to scaled the ECS task's <code data-v-4b9599ea data-v-4b9599ea>desiredCount</code> based on the slash command options and sub options.</p>
<p data-v-4b9599ea data-v-4b9599ea>The function that handles the webhook <code data-v-4b9599ea data-v-4b9599ea>POST</code> request when the sub-command is <code data-v-4b9599ea data-v-4b9599ea>status</code> queries AWS for the number of ECS tasks in our service that are <code data-v-4b9599ea data-v-4b9599ea>desired</code>, <code data-v-4b9599ea data-v-4b9599ea>running</code> and <code data-v-4b9599ea data-v-4b9599ea>pending</code> and then sends back a message that will be displayed to the user who sent the command. When the sub-command is <code data-v-4b9599ea data-v-4b9599ea>start</code> or <code data-v-4b9599ea data-v-4b9599ea>stop</code>, the <code data-v-4b9599ea data-v-4b9599ea>desiredCount</code> is either set to <code data-v-4b9599ea data-v-4b9599ea>1</code> or <code data-v-4b9599ea data-v-4b9599ea>0</code>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Here's an overview of the server setup and how Discord Slash Commands can be used to control the server:</p>
<p data-v-4b9599ea data-v-4b9599ea><img alt="png" src="/static/valheim/diagram.png" data-v-4b9599ea data-v-4b9599ea></p>
<p data-v-4b9599ea data-v-4b9599ea>I'll cover each of the steps labelled in this diagram at the end of the article. The rest of the article will provide detailed instructions for how to set everything up. I won't be going over AWS account setup or Discord server setup.</p>
<h2 id="how-to-set-up-the-discord-developer-application-and-interaction" data-v-4b9599ea data-v-4b9599ea><a href="#how-to-set-up-the-discord-developer-application-and-interaction" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>How to set up the Discord developer application and Interaction</h2>
<p data-v-4b9599ea data-v-4b9599ea>First, you need to be the admin of a Discord server. Once you create the server, go to <code data-v-4b9599ea data-v-4b9599ea>Server Settings > Widget</code> and take note of the Server ID. This is also known as the Guild ID.</p>
<p data-v-4b9599ea data-v-4b9599ea>Then go to <a href="https://discord.com/developers/applications" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://discord.com/developers/applications</a> and create an application. Under <code data-v-4b9599ea data-v-4b9599ea>General Information</code>, make note of the public key (the application ID). Put these values in a file that will be <code data-v-4b9599ea data-v-4b9599ea>.gitignored</code> called <code data-v-4b9599ea data-v-4b9599ea>.env</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>export GUILD_ID=123456789
export APPLICATION_ID=abc123
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We will use this file later when registering the Interaction.</p>
<p data-v-4b9599ea data-v-4b9599ea>Next go to the <code data-v-4b9599ea data-v-4b9599ea>OAuth2</code> tab and select the <code data-v-4b9599ea data-v-4b9599ea>bot</code> and <code data-v-4b9599ea data-v-4b9599ea>applications.commands</code> permissions. This will generated an OAuth2 authorization link. Copy the link and open it in a browser. We will see an error:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>OAuth2 application does not have a bot
</code></pre></div>
<h3 id="configure-a-bot-for-our-discord-application" data-v-4b9599ea data-v-4b9599ea><a href="#configure-a-bot-for-our-discord-application" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Configure a bot for our Discord application</h3>
<p data-v-4b9599ea data-v-4b9599ea>Next, got to the <code data-v-4b9599ea data-v-4b9599ea>Bot</code> tab and click the <code data-v-4b9599ea data-v-4b9599ea>Add Bot</code> button.</p>
<blockquote data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Adding a bot user gives your app visible life in Discord. However, this action is irrevocable! Choose wisely.</p>
</blockquote>
<p data-v-4b9599ea data-v-4b9599ea>Turn off the <code data-v-4b9599ea data-v-4b9599ea>Public Bot</code> option and save changes.</p>
<p data-v-4b9599ea data-v-4b9599ea>Get the bot token by clicking on <code data-v-4b9599ea data-v-4b9599ea>Click to Reveal Token</code>, and add this to <code data-v-4b9599ea data-v-4b9599ea>.env</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>export BOT_TOKEN=abc.xyz.123
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Now go back to the <code data-v-4b9599ea data-v-4b9599ea>OAuth2</code> tab and select the <code data-v-4b9599ea data-v-4b9599ea>bot</code> and <code data-v-4b9599ea data-v-4b9599ea>applications.commands</code> permissions again, copy the link and open it. Select the server that you want to add this application to. You should see a captcha, and then a message that says <code data-v-4b9599ea data-v-4b9599ea>Authorized</code>. You should also see a message from your discord server that the bot has joined the server.</p>
<h3 id="create-the-interaction" data-v-4b9599ea data-v-4b9599ea><a href="#create-the-interaction" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Create the Interaction</h3>
<p data-v-4b9599ea data-v-4b9599ea>Now we will set up the Interaction. Currently the only way to set up the interaction is through an HTTP <code data-v-4b9599ea data-v-4b9599ea>POST</code> request. This Python script sets up our Interaction:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token triple-quoted-string string" data-v-4b9599ea data-v-4b9599ea>"""
https://discord.com/developers/docs/interactions/slash-commands#registering-a-command
"""</span>

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> os

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> requests

APPLICATION_ID <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"APPLICATION_ID"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
GUILD_ID <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"GUILD_ID"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
BOT_TOKEN <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"BOT_TOKEN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

url <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string-interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token string" data-v-4b9599ea data-v-4b9599ea>f"https://discord.com/api/v8/applications/</span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>APPLICATION_ID<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea>/guilds/</span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>GUILD_ID<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea>/commands"</span></span>

json <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"vh"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"description"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Start, stop or get the status of the Valheim server"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"options"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"valheim_server_controls"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"description"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"What do you want to do?"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"type"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>3</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"required"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>True</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"choices"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"status"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"value"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"status"</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"start"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"value"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"start"</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"stop"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"value"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"stop"</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>

headers <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Authorization"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string-interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token string" data-v-4b9599ea data-v-4b9599ea>f"Bot </span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>BOT_TOKEN<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"</span></span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>if</span> __name__ <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"__main__"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    r <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> requests<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>post<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>url<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> headers<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>headers<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> json<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>json<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>print</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>r<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>content<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Before running this command, source the <code data-v-4b9599ea data-v-4b9599ea>.env</code> file:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>source .env
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Then run the script:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>python3 register_bot.py
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>You should see this response:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>b'{"id": "XXXXXXXXXXXXXX", "application_id": "XXXXXXXXXXXXXX", "name": "vh", "description": "Start, stop or get the status of the Valheim server", "version": "XXXXXXXXXXXXXX", "default_permission": true, "guild_id": "XXXXXXXXXXXXXX", "options": [{"type": 3, "name": "valheim_server_controls", "description": "What do you want to do?", "required": true, "choices": [{"name": "status", "value": "status"}, {"name": "start", "value": "start"}, {"name": "stop", "value": "stop"}]}]}'
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Now, when you type <code data-v-4b9599ea data-v-4b9599ea>/</code> in any channel on the Discord server that you authenticated the bot, you should see the <code data-v-4b9599ea data-v-4b9599ea>vh</code> command at the top of the list of autocomplete options.</p>
<p data-v-4b9599ea data-v-4b9599ea>If we run any of these commands, we should see a response saying:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>This interaction failed
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This is because we have not configured an <code data-v-4b9599ea data-v-4b9599ea>Interactions Endpoint URL</code> under the <code data-v-4b9599ea data-v-4b9599ea>General Information</code> section of our Discord Application's admin page (<a href="https://discord.com/developers/applications/" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>https://discord.com/developers/applications/</a>).</p>
<h2 id="setting-up-the-interactions-endpoint-url-for-our-slash-command" data-v-4b9599ea data-v-4b9599ea><a href="#setting-up-the-interactions-endpoint-url-for-our-slash-command" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Setting up the Interactions Endpoint URL for our Slash Command</h2>
<p data-v-4b9599ea data-v-4b9599ea>In order for our Slash Command to do anything, we need to set up URL that Discord will <code data-v-4b9599ea data-v-4b9599ea>POST</code> the Interaction event data to, including information such as who sent the Interaction, what channel it was sent on, what options were used, etc. You can see an example of the event payload <a href="https://discord.com/developers/docs/interactions/slash-commands#receiving-an-interaction" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>here on the Discord developer documentation</a>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-json" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"type"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>2</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"token"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"A_UNIQUE_TOKEN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"member"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"user"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"id"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>53908232506183680</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"username"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Mason"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"avatar"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"a_d5efa99b3eeaa7dd43acca82f5692432"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"discriminator"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"1337"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"public_flags"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>131141</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"roles"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"539082325061836999"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"premium_since"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token null keyword" data-v-4b9599ea data-v-4b9599ea>null</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"permissions"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"2147483647"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"pending"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>false</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"nick"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token null keyword" data-v-4b9599ea data-v-4b9599ea>null</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"mute"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>false</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"joined_at"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"2017-03-13T19:19:14.040000+00:00"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"is_pending"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>false</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"deaf"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>false</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"id"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"786008729715212338"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"guild_id"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"290926798626357999"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"data"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"options"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"cardname"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token property" data-v-4b9599ea data-v-4b9599ea>"value"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"The Gitrog Monster"</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"name"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"cardsearch"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token property" data-v-4b9599ea data-v-4b9599ea>"id"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"771825006014889984"</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token property" data-v-4b9599ea data-v-4b9599ea>"channel_id"</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"645027906669510667"</span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>This <code data-v-4b9599ea data-v-4b9599ea>POST</code> request also includes some special headers used for security that we will need to do validation with our handling function. This part can be handled with a decorator provided by the <code data-v-4b9599ea data-v-4b9599ea>discord-interactions</code> package on PyPI, but we will need to add some additional configuration to our API Gateway endpoint since these headers will not be passed through the lambda by default.</p>
<h2 id="setting-up-aws-infrastructure-with-cdk" data-v-4b9599ea data-v-4b9599ea><a href="#setting-up-aws-infrastructure-with-cdk" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Setting up AWS infrastructure with CDK</h2>
<p data-v-4b9599ea data-v-4b9599ea>Let's start a CDK project in a blank repository that will define our infrastructure, Lambda functions and CI/CD pipeline with GitLab CI. Make sure that you have the <code data-v-4b9599ea data-v-4b9599ea>aws-cdk</code> CLI installed globally:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>npm i -g aws-cdk
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Then start a CDK project in a subdirectory called <code data-v-4b9599ea data-v-4b9599ea>cdk</code> with:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>mkdir cdk && cd cdk && cdk init app --language=python
</code></pre></div>
<h3 id="add-cdk-project-dependencies" data-v-4b9599ea data-v-4b9599ea><a href="#add-cdk-project-dependencies" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add CDK project dependencies</h3>
<p data-v-4b9599ea data-v-4b9599ea>The next step is to add all of the dependencies to our CDK project that we will use in this project. In <code data-v-4b9599ea data-v-4b9599ea>setup.py</code> add the following:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>    install_requires<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.core==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.aws_applicationautoscaling==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.aws_datasync==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.aws_lambda==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.aws_s3==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"aws-cdk.aws_apigateway==1.92.0"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token string" data-v-4b9599ea data-v-4b9599ea>"cdk-valheim==0.0.16"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Next we can add the CDK construct for <code data-v-4b9599ea data-v-4b9599ea>ValheimWorld</code> in the <code data-v-4b9599ea data-v-4b9599ea>cdk_stack.py</code> file that was generated in our project as well as the imports for the packages we included in <code data-v-4b9599ea data-v-4b9599ea>setup.py</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> aws_cdk <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> core <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> cdk

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> aws_cdk <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
    core<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_datasync <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> datasync<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_iam <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> iam<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_lambda <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> _lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_apigateway <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> apigw<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_applicationautoscaling <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> appScaling<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    aws_s3 <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> s3<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> cdk_valheim <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> ValheimWorld<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> ValheimWorldScalingSchedule


<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>class</span> <span class="token class-name" data-v-4b9599ea data-v-4b9599ea>CdkStack</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>cdk<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Stack<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>

    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>__init__</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> scope<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> cdk<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Construct<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> construct_id<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token builtin" data-v-4b9599ea data-v-4b9599ea>str</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>**</span>kwargs<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>-</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>></span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>None</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        <span class="token builtin" data-v-4b9599ea data-v-4b9599ea>super</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>__init__<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>scope<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> construct_id<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>**</span>kwargs<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        <span class="token comment" data-v-4b9599ea data-v-4b9599ea># The code that defines your stack goes here</span>
        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>valheim_world <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> ValheimWorld<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>'ValheimWorld'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            cpu<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>2048</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            memory_limit_mib<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>4096</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            schedules<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>ValheimWorldScalingSchedule<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
                start<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>appScaling<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>CronOptions<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>hour<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'12'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> week_day<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'1-5'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                stop<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>appScaling<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>CronOptions<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>hour<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'1'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> week_day<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'1-5'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            environment<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"SERVER_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"SERVER_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"CDK Valheim"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"WORLD_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"WORLD_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Amazon"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"SERVER_PASS"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"SERVER_PASS"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"fargate"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"BACKUPS"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'false'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We are almost ready to deploy a basic version of our Valheim server using the <code data-v-4b9599ea data-v-4b9599ea>cdk-valheim</code> construct. If we were to run the following command:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>cdk deploy --app cdk/app.py --require-approval never
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>from the root of our project, it should work. This assumes that we have default credentials configured in <code data-v-4b9599ea data-v-4b9599ea>~/.aws/credentials</code> and that we have also bootstrapped our AWS account with the resources it needs for CDK to work:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>cdk bootstrap --app cdk/app.py aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION
</code></pre></div>
<h3 id="setup-gitlab-ci-job-for-automated-deployments" data-v-4b9599ea data-v-4b9599ea><a href="#setup-gitlab-ci-job-for-automated-deployments" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Setup GitLab CI job for automated deployments</h3>
<p data-v-4b9599ea data-v-4b9599ea>Instead of deploying from the command line, it would be better to run the deployment from a CI/CD pipeline. Add a <code data-v-4b9599ea data-v-4b9599ea>.gitlab-ci.yml</code> file to the root of your project and populate it with the following YAML:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yaml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stages</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> deploy

<span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> python<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>3.8</span>

<span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>cdk_deploy</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stage</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> deploy
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>rules</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>if</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"$CI_COMMIT_TAG"</span>
      <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>when</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> always
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>before_script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> apt<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>get <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>qq update <span class="token important" data-v-4b9599ea data-v-4b9599ea>&&</span> apt<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>get <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>y install nodejs npm
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> npm i <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>g aws<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>cdk
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> pip3 install <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>e cdk
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> cdk bootstrap <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>app cdk/app.py aws<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>//$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> cdk deploy <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>app cdk/app.py <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>require<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>approval never
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Before we initialize a git repository in the root directory of our project, remove the <code data-v-4b9599ea data-v-4b9599ea>.git</code> repo that CDK created when we initialized the project with <code data-v-4b9599ea data-v-4b9599ea>rf -rf cdk/.git</code>. Now initialized a project in the root directory with <code data-v-4b9599ea data-v-4b9599ea>git init</code>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Next, create a GitLab repository and add the remote to this project with:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>git remote add origin git@gitlab.com:gitlab-username/project-name.git
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>In the GitLab project's <code data-v-4b9599ea data-v-4b9599ea>Settings > CI/CD > Variables</code> section, add the following environment variables as protected variables:</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_ACCESS_KEY_ID</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_SECRET_ACCESS_KEY</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_DEFAULT_REGION</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>AWS_ACCOUNT_ID</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>APPLICATION_PUBLIC_KEY</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>SERVER_PASS</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>SERVER_NAME</code></li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>WORLD_NAME</code></li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Now under <code data-v-4b9599ea data-v-4b9599ea>Settings > Repository > Protected Tags</code>, add a wildcard (<code data-v-4b9599ea data-v-4b9599ea>*</code>) so that all tags are protected and only maintainers can push tags. This allows us to use the protected environment variables only when a trusted maintainer pushes a tag to the repository.</p>
<h3 id="edit-the-name-of-the-stack-and-add-region-and-account-info" data-v-4b9599ea data-v-4b9599ea><a href="#edit-the-name-of-the-stack-and-add-region-and-account-info" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Edit the name of the stack and add region and account info</h3>
<p data-v-4b9599ea data-v-4b9599ea>We are almost ready to create a tag and push to GitLab, but before we do that let's change the name of the CloudFormation stack that CDK will create in <code data-v-4b9599ea data-v-4b9599ea>cdk/app.py</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token comment" data-v-4b9599ea data-v-4b9599ea>#!/usr/bin/env python3</span>

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> os

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> aws_cdk <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> core <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> cdk

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># For consistency with TypeScript code, `cdk` is the preferred import name for</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># the CDK's core module.  The following line also imports it as `core` for use</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># with examples from the CDK Developer's Guide, which are in the process of</span>
<span class="token comment" data-v-4b9599ea data-v-4b9599ea># being updated to use `cdk`.  You may delete this import if you don't need it.</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> aws_cdk <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> core

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> cdk<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>cdk_stack <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> CdkStack

aws_region <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"AWS_DEFAULT_REGION"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"us-east-1"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
aws_account <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"AWS_ACCOUNT_ID"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>


app <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> cdk<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>App<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
CdkStack<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
    app<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    <span class="token string" data-v-4b9599ea data-v-4b9599ea>"valheim-server-stack"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    env<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"region"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> aws_region<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"account"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> aws_account<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

app<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>synth<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Now commit changes, create a tag and push it to GitLab:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>git add .
git commit -m "initial commit"
git tag v0.0.1
git push origin v0.0.1
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Check the logs of the GitLab CI pipeline that this creates in your GitLab project's CI/CD settings.</p>
<p data-v-4b9599ea data-v-4b9599ea>If everything runs successfully, you should be able to see your Valheim server listed in the list of community servers once it comes online, and you should be able to connect to it with the password you set in GitLab project variables.</p>
<h2 id="add-the-lambda-function-handler-code" data-v-4b9599ea data-v-4b9599ea><a href="#add-the-lambda-function-handler-code" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add the Lambda function handler code</h2>
<p data-v-4b9599ea data-v-4b9599ea>We will have a simple Flask application respond the the Discord <code data-v-4b9599ea data-v-4b9599ea>POST</code> requests that send Interaction events. Let's add <code data-v-4b9599ea data-v-4b9599ea>lambda-handler.py</code> in <code data-v-4b9599ea data-v-4b9599ea>lambda/functions/interactions/lambda-handler.py</code>, and <code data-v-4b9599ea data-v-4b9599ea>requirements.txt</code> in <code data-v-4b9599ea data-v-4b9599ea>lambda/functions/interactions/requirements.txt</code>. Our project structure should look like this:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>$ tree -L 4
.
‚îú‚îÄ‚îÄ cdk
‚îÇ   ‚îú‚îÄ‚îÄ app.py
‚îÇ   ‚îú‚îÄ‚îÄ cdk
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cdk_stack.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ cdk.json
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ setup.py
‚îÇ   ‚îî‚îÄ‚îÄ source.bat
‚îú‚îÄ‚îÄ lambda
‚îÇ   ‚îî‚îÄ‚îÄ functions
‚îÇ       ‚îî‚îÄ‚îÄ interactions
‚îÇ           ‚îú‚îÄ‚îÄ lambda-handler.py    &lt;-- here
‚îÇ           ‚îî‚îÄ‚îÄ requirements.txt     &lt;-- and here
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ register_bot.py
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>The <code data-v-4b9599ea data-v-4b9599ea>requirements.txt</code> defines the pip dependencies for our Lambda function. It should include the following:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>aws-wsgi==0.2.7
discord-interactions==0.2.0
Flask==1.1.2
</code></pre></div>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>aws-wsgi</code> will transform API Gateway requests into WSGI application requests that Flask can handle</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>discord-interactions</code> will help us with some security-related requirements</li>
<li data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>Flask</code> will be our web application framework</li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Here's the code for <code data-v-4b9599ea data-v-4b9599ea>lambda-handler.py</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> os
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> logging

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> awsgi
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> boto3
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> discord_interactions <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> verify_key_decorator
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> flask <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
    Flask<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    jsonify<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
    request
<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>


client <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> boto3<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>client<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'ecs'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

<span class="token comment" data-v-4b9599ea data-v-4b9599ea># Your public key can be found on your application in the Developer Portal</span>
PUBLIC_KEY <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'APPLICATION_PUBLIC_KEY'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

logger <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> logging<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>getLogger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>setLevel<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>logging<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>INFO<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

app <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> Flask<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>__name__<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>


<span class="token decorator annotation punctuation" data-v-4b9599ea data-v-4b9599ea>@app<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>route</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'/discord'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> methods<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'POST'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
<span class="token decorator annotation punctuation" data-v-4b9599ea data-v-4b9599ea>@verify_key_decorator</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>PUBLIC_KEY<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>index</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>if</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>json<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"type"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>1</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> jsonify<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"type"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>1</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>else</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>json<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>try</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            interaction_option <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>json<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"data"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"options"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>0</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"value"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>except</span> KeyError<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"Could not parse the interaction option"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
            interaction_option <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"status"</span>

        logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"Interaction:"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>interaction_option<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span>

        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>if</span> interaction_option <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"status"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>try</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>

                resp <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> client<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>describe_services<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
                    cluster<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_CLUSTER_ARN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                    services<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>
                        os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_SERVICE_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
                desired_count <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> resp<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"services"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>0</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"desiredCount"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
                running_count <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> resp<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"services"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>0</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"runningCount"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>
                pending_count <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> resp<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"services"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>0</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"pendingCount"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span>

                content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string-interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token string" data-v-4b9599ea data-v-4b9599ea>f"Desired: </span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>desired_count<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea> | Running: </span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>running_count<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea> | Pending: </span><span class="token interpolation" data-v-4b9599ea data-v-4b9599ea><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>pending_count<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span></span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"</span></span>

            <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>except</span> Error <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>as</span> e<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
                content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Could not get server status"</span>
                logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"Could not get the server status"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
                logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>e<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>elif</span> interaction_option <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"start"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Starting the server"</span>

            resp <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> client<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>update_service<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
                cluster<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_CLUSTER_ARN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                service<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_SERVICE_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                desiredCount<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>1</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>elif</span> interaction_option <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"stop"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Stopping the server"</span>

            resp <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> client<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>update_service<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
                cluster<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_CLUSTER_ARN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                service<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_SERVICE_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>""</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                desiredCount<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>0</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>else</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            content <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"Unknown command"</span>

        logger<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>info<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>resp<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> jsonify<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"type"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>4</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"data"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"tts"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>False</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"content"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> content<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"embeds"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>"allowed_mentions"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"parse"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

<span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>handler</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>event<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> context<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> awsgi<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>response<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
        app<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        event<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        context<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        base64_content_types<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"image/png"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Notice how we pass the Flask <code data-v-4b9599ea data-v-4b9599ea>app</code> to <code data-v-4b9599ea data-v-4b9599ea>awsgi.response</code>. <code data-v-4b9599ea data-v-4b9599ea>aws-wsgi</code> (or <code data-v-4b9599ea data-v-4b9599ea>awsgi</code> as it is imported) is the go-between for API Gateway and WSGI.</p>
<h2 id="add-the-cdk-code-for-api-gateway-and-lambda-that-will-serve-our-discord-interaction-endpoint-url" data-v-4b9599ea data-v-4b9599ea><a href="#add-the-cdk-code-for-api-gateway-and-lambda-that-will-serve-our-discord-interaction-endpoint-url" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add the CDK code for API Gateway and Lambda that will serve our Discord Interaction Endpoint URL</h2>
<p data-v-4b9599ea data-v-4b9599ea>Now we can add the following code to <code data-v-4b9599ea data-v-4b9599ea>cdk_stack.py</code> to configure the API Gateway and Lambda function. Add the following to <code data-v-4b9599ea data-v-4b9599ea>cdk_stack.py</code> after our definition of <code data-v-4b9599ea data-v-4b9599ea>self.valheim_world</code>:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>env_vars <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"APPLICATION_PUBLIC_KEY"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> os<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>environ<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"APPLICATION_PUBLIC_KEY"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_SERVICE_NAME"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>valheim_world<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>service<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>service_name<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"ECS_CLUSTER_ARN"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>valheim_world<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>service<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>cluster<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>cluster_arn
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>flask_lambda_layer <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> _lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>LayerVersion<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"FlaskAppLambdaLayer"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            code<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>AssetCode<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"./layers/flask"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            compatible_runtimes<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Runtime<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>PYTHON_3_8<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>flask_app_lambda <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> _lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Function<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"FlaskAppLambda"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            runtime<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Runtime<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>PYTHON_3_8<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            code<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>AssetCode<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'./lambda/functions/interactions'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            function_name<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"flask-app-handler"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            handler<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"lambda-handler.handler"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            layers<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>[</span>self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>flask_lambda_layer<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>]</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            timeout<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>core<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>Duration<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>seconds<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>60</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            environment<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>**</span>self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>env_vars<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>flask_app_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>role<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>add_managed_policy<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            iam<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>ManagedPolicy<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>from_managed_policy_arn<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
                self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                <span class="token string" data-v-4b9599ea data-v-4b9599ea>'ECS_FullAccessPolicy'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
                managed_policy_arn<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'arn:aws:iam::aws:policy/AmazonECS_FullAccess'</span>
            <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        <span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://slmkitani.medium.com/passing-custom-headers-through-amazon-api-gateway-to-an-aws-lambda-function-f3a1cfdc0e29</span>
        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>request_templates <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>"application/json"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token triple-quoted-string string" data-v-4b9599ea data-v-4b9599ea>'''{
                "method": "$context.httpMethod",
                "body" : $input.json("$"),
                "headers": {
                    #foreach($param in $input.params().header.keySet())
                    "$param": "$util.escapeJavaScript($input.params().header.get($param))"
                    #if($foreach.hasNext),#end
                    #end
                }
            }
            '''</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>apigateway <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> apigw<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>RestApi<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>'FlaskAppEndpoint'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>apigateway<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>root<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>add_method<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"ANY"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>discord_interaction_webhook <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>apigateway<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>root<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>add_resource<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>"discord"</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>discord_interaction_webhook_integration <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> apigw<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>LambdaIntegration<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>flask_app_lambda<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            request_templates<span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span>self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>request_templates
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

        self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>discord_interaction_webhook<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>add_method<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>
            <span class="token string" data-v-4b9599ea data-v-4b9599ea>'POST'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span>
            self<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>discord_interaction_webhook_integration
        <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>First we add some environment variables that will be made available to the Lambda function's execution environment. The ECS cluster and service name as well as our Discord application's <code data-v-4b9599ea data-v-4b9599ea>PUBLIC_KEY</code> are needed in the Lambda function for everything to work.</p>
<p data-v-4b9599ea data-v-4b9599ea>We have to give the lambda function permissions to make changes to ECS since it will be interacting with ECS via boto3.</p>
<p data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>self.request_templates</code> is needed in order to pass the special security headers from the Discord <code data-v-4b9599ea data-v-4b9599ea>POST</code> request that are needed for security. I couldn't find a lot of resources on how to make this work, but I learned that this uses Apache Velocity Template Language.</p>
<h3 id="add-a-gitlab-ci-job-for-installing-dependencies-into-lambda-layer" data-v-4b9599ea data-v-4b9599ea><a href="#add-a-gitlab-ci-job-for-installing-dependencies-into-lambda-layer" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add a GitLab CI job for installing dependencies into Lambda Layer</h3>
<p data-v-4b9599ea data-v-4b9599ea>There's one more step before we can push our code. We need to add another GitLab CI job that will install the Lambda dependencies so that they can be sent to the Lambda layer that we defined in our Lambda function. A Lambda Layer is where you install dependencies for this type of Lambda setup. Let's add the following stage:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-yml" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stages</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> build
  <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> deploy

<span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>image</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> python<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span><span class="token number" data-v-4b9599ea data-v-4b9599ea>3.8</span>

<span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>pip_install</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>stage</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> build
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>rules</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>if</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>"$CI_COMMIT_TAG"</span>
      <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>when</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> always
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>artifacts</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>paths</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
      <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> layers/flask/python
  <span class="token key atrule" data-v-4b9599ea data-v-4b9599ea>script</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span> pip install <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>r lambda/functions/interactions/requirements.txt <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>-</span>t layers/flask/python
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>Now we are installing dependencies into a target location (with the <code data-v-4b9599ea data-v-4b9599ea>-t</code> flag) that our Lambda Layer will be able to use in the <code data-v-4b9599ea data-v-4b9599ea>cdk_deploy</code> GitLab CI job. This is because we have indicated the path to <code data-v-4b9599ea data-v-4b9599ea>layers/flask/python</code> in the <code data-v-4b9599ea data-v-4b9599ea>paths</code> array of <code data-v-4b9599ea data-v-4b9599ea>artifacts</code> in the <code data-v-4b9599ea data-v-4b9599ea>pip_install</code> job. There are other ways to add the pip dependencies to the Lambda Layers. We don't absolutely need this to be done in a separate CI job.</p>
<p data-v-4b9599ea data-v-4b9599ea>Now tag and push the code to GitLab and check to see that the pipeline runs successfully.</p>
<h3 id="add-the-api-gateway-url-to-discord-application-settings" data-v-4b9599ea data-v-4b9599ea><a href="#add-the-api-gateway-url-to-discord-application-settings" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Add the API Gateway URL to Discord Application settings</h3>
<p data-v-4b9599ea data-v-4b9599ea>If everything runs smoothly, we should see a URL in the very last lines of the pipeline. This is the URL for our API Gateway endpoint:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>We need to add <code data-v-4b9599ea data-v-4b9599ea>discord</code> to the end of this URL and then add that to our the <code data-v-4b9599ea data-v-4b9599ea>Interactions Endpoint URL</code> in the <code data-v-4b9599ea data-v-4b9599ea>General Information</code> section of our Discord application's admin page:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-text" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>https://abc123xyz.execute-api.us-east-1.amazonaws.com/prod/discord
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>When we add this URL in the application settings, Discord will make sure that our endpoint is properly verifying the request based on its headers. Check out <a href="https://github.com/discord/discord-interactions-python/blob/main/discord_interactions/__init__.py#L31" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>this function</a> to see how it works:</p>
<div class="nuxt-content-highlight" data-v-4b9599ea data-v-4b9599ea><pre class="line-numbers language-py" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea><span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>verify_key_decorator</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>client_public_key<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>from</span> flask <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>import</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> jsonify

    <span class="token comment" data-v-4b9599ea data-v-4b9599ea># https://stackoverflow.com/questions/51691730/flask-middleware-for-specific-route</span>
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>_decorator</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>f<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
        <span class="token decorator annotation punctuation" data-v-4b9599ea data-v-4b9599ea>@wraps</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>f<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>def</span> <span class="token function" data-v-4b9599ea data-v-4b9599ea>__decorator</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>*</span>args<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>**</span>kwargs<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
            <span class="token comment" data-v-4b9599ea data-v-4b9599ea># Verify request</span>
            signature <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>headers<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'X-Signature-Ed25519'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
            timestamp <span class="token operator" data-v-4b9599ea data-v-4b9599ea>=</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>headers<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'X-Signature-Timestamp'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
            <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>if</span> signature <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>is</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>None</span> <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>or</span> timestamp <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>is</span> <span class="token boolean" data-v-4b9599ea data-v-4b9599ea>None</span> <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>or</span> <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>not</span> verify_key<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span>request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>data<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> signature<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> timestamp<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> client_public_key<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
                <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> <span class="token string" data-v-4b9599ea data-v-4b9599ea>'Bad request signature'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token number" data-v-4b9599ea data-v-4b9599ea>401</span>

            <span class="token comment" data-v-4b9599ea data-v-4b9599ea># Automatically respond to pings</span>
            <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>if</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>json <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>and</span> request<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>json<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>get<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token string" data-v-4b9599ea data-v-4b9599ea>'type'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>==</span> InteractionType<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>PING<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span>
                <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> jsonify<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>{</span>
                    <span class="token string" data-v-4b9599ea data-v-4b9599ea>'type'</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>:</span> InteractionResponseType<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>.</span>PONG
                <span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>}</span><span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>

            <span class="token comment" data-v-4b9599ea data-v-4b9599ea># Pass through</span>
            <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> f<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>(</span><span class="token operator" data-v-4b9599ea data-v-4b9599ea>*</span>args<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>,</span> <span class="token operator" data-v-4b9599ea data-v-4b9599ea>**</span>kwargs<span class="token punctuation" data-v-4b9599ea data-v-4b9599ea>)</span>
        <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> __decorator
    <span class="token keyword" data-v-4b9599ea data-v-4b9599ea>return</span> _decorator
</code></pre></div>
<p data-v-4b9599ea data-v-4b9599ea>If it fails verification, we will not be able to add the URL and it will not work. You might want to add some additional logging to the Lambda function if you are not able to add the URL successfully.</p>
<p data-v-4b9599ea data-v-4b9599ea>This is all covered in <a href="https://discord.com/developers/docs/interactions/slash-commands" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>the documentation for Discord Interactions</a>.</p>
<p data-v-4b9599ea data-v-4b9599ea>Now you should be able to run the Discord slash commands. You can get the status of your ECS cluster and scale it to either 1 or 0 for <code data-v-4b9599ea data-v-4b9599ea>ON</code> and <code data-v-4b9599ea data-v-4b9599ea>OFF</code>.</p>
<h2 id="overview" data-v-4b9599ea data-v-4b9599ea><a href="#overview" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>Overview</h2>
<p data-v-4b9599ea data-v-4b9599ea>Here's an overview of what we covered:</p>
<p data-v-4b9599ea data-v-4b9599ea><img alt="png" src="/static/valheim/diagram.png" data-v-4b9599ea data-v-4b9599ea></p>
<ol start="0" data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>This is my computer. For development of this project (and most other projects) I used Windows with WSL2.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>GitLab CI - This is used to run our automated pipelines whenever we push a tag.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The CDK CLI is used to create, update and delete the infrastructure in our AWS account.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Valheim - The client for the game server that we set up</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The public IP address of the ECS Task that can be used to connect to our server on port 2456.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The ECS Cluster that runs the actual docker container for the Valheim server. By default, the image used is <a href="https://hub.docker.com/r/lloesche/valheim-server" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea>lloesche/valheim-server</a>.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>EFS - This is the file system that is mounted onto the container of the ECS task where our game's world data is stored.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>AWS Backup (Optional) - This is an optional feature of the <code data-v-4b9599ea data-v-4b9599ea>cdk-valheim</code> construct that can make regular backups of our EFS file system.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Events (Optional) - AWS Events can be used to scale the number of ECS tasks between 0 and 1.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>This is the <a href="https://github.com/gotodeploy/cdk-valheim" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>cdk-valheim</code></a> construct that I use in this project.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>S3 bucket for syncing data to and from EFS with DataSync (WIP)</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>DataSync for moving game data between EFS and S3.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The Slash Commands that we set up</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Discord</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>Discord Interactions sends and a <code data-v-4b9599ea data-v-4b9599ea>POST</code> request</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The API Gateway endpoint that we configured to handle Discord Interaction <code data-v-4b9599ea data-v-4b9599ea>POST</code> requests.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>The Lambda function running a simple Flask app that responds to the Interaction <code data-v-4b9599ea data-v-4b9599ea>POST</code> request.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>boto3 - This is the AWS SDK Python library included in the Python execution environment that allows us to interact with the resources in our AWS account. In particular, the interactions we use from boto3 are the <code data-v-4b9599ea data-v-4b9599ea>update_service</code> and <code data-v-4b9599ea data-v-4b9599ea>describe_servics</code> methods from the ECS module. This allows us to turn our server on and off and also get the status.</p>
</li>
<li data-v-4b9599ea data-v-4b9599ea>
<p data-v-4b9599ea data-v-4b9599ea>This represents the <code data-v-4b9599ea data-v-4b9599ea>valheim-server-stack</code> we defined in our CDK application.</p>
</li>
</ol>
<h2 id="todo" data-v-4b9599ea data-v-4b9599ea><a href="#todo" aria-hidden="true" tabindex="-1" data-v-4b9599ea data-v-4b9599ea><span class="icon icon-link" data-v-4b9599ea data-v-4b9599ea></span></a>TODO</h2>
<p data-v-4b9599ea data-v-4b9599ea>There are still some things that I'm working on finalizing.</p>
<ul data-v-4b9599ea data-v-4b9599ea>
<li data-v-4b9599ea data-v-4b9599ea>DataSync for easily moving data between S3 and EFS</li>
<li data-v-4b9599ea data-v-4b9599ea>Report billing data with an additional slash command sub-command</li>
<li data-v-4b9599ea data-v-4b9599ea>Add tagging to the resources in our stack to make the billing command easier to implement.</li>
<li data-v-4b9599ea data-v-4b9599ea>Get feedback from the Discord, CDK and Valheim communities about what I can improve here</li>
<li data-v-4b9599ea data-v-4b9599ea>Contribute to <a href="https://github.com/gotodeploy/cdk-valheim" rel="nofollow noopener noreferrer" target="_blank" data-v-4b9599ea data-v-4b9599ea><code data-v-4b9599ea data-v-4b9599ea>gotodeploy/cdk-valheim</code></a></li>
</ul>
<p data-v-4b9599ea data-v-4b9599ea>Thanks for reading!</p></div> <div class="text-center pb-4 pt-8" data-v-4b9599ea><button class="mc-btn rounded py-1 px-2" data-v-4b9599ea>
        Show Disqus Comments üí¨
      </button></div> <!----> <h1 data-v-4b9599ea></h1></div></article> <div data-v-7edaacc0></div> <div class="mx-auto max-w-6xl p-4 lg:px-16 text-center" data-v-27f2d9d4><hr class="mt-4" data-v-27f2d9d4> <div class="mx-auto py-4" data-v-27f2d9d4><div class="pb-4" data-v-27f2d9d4>
      Join my mailing list to get updated whenever I publish a new article.
    </div> <div class="mx-auto" data-v-89248ae4 data-v-27f2d9d4><div id="mc_embed_signup" class="mx-auto w-full md:w-1/2" data-v-89248ae4><form id="mc-embedded-subscribe-form" action="https://github.us2.list-manage.com/subscribe/post?u=43a795784ca963e25903a0da6&id=9937fe4fc5" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate" data-v-89248ae4><div id="mc_embed_signup_scroll" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center" data-v-89248ae4><input id="mce-EMAIL" type="email" name="EMAIL" placeholder="Enter your email address" class="rounded mc text-center" data-v-89248ae4> <div aria-hidden="true" style="position:absolute;left:-5000px" data-v-89248ae4><input name="b_43a795784ca963e25903a0da6_9937fe4fc5" tabindex="-1" data-v-89248ae4></div> <div data-v-89248ae4><input id="mc-embedded-subscribe" type="submit" name="subscribe" value="Subscribe" class="mc-btn rounded px-2 py-1 w-full" data-v-89248ae4></div></div></form></div></div></div> <hr data-v-27f2d9d4> <div class="py-4" data-v-27f2d9d4>
    Thanks for checking out my site!
  </div> <div class="pb-4" data-v-27f2d9d4>
    ¬© 2021 Brian Caffey
  </div></div></div></div></div><script defer src="/_nuxt/static/1635735110/2021/03/18/on-demand-dedicated-serverless-valheim-server-with-cdk-discrod-interactions/state.js"></script><script src="/_nuxt/2ac5113.js" defer></script><script src="/_nuxt/cddfb8a.js" defer></script><script src="/_nuxt/72e9485.js" defer></script><script src="/_nuxt/57968fc.js" defer></script><script src="/_nuxt/d33dfc9.js" defer></script>
  </body>
</html>
